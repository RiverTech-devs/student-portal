<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Subject Skill Tree Constellation</title>
    <style>
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle, #0a0a2e 0%, #000000 100%);
            font-family: 'Georgia', serif;
            color: #d4af37;
            overflow-x: auto;
            min-height: 100vh;
        }
        
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .container {
            background: rgba(26, 26, 58, 0.9);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            min-width: 400px;
        }
        
        .title {
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .subtitle {
            font-size: 16px;
            color: #d4af37;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        
        .constellation-container {
            position: absolute;               
            width: 2400px;
            height: 2000px;
            margin: 0;                        
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><radialGradient id="star" cx="50%" cy="50%" r="50%"><stop offset="0%" style="stop-color:white;stop-opacity:0.8"/><stop offset="100%" style="stop-color:white;stop-opacity:0"/></radialGradient></defs><circle cx="10" cy="20" r="0.5" fill="url(%23star)"/><circle cx="80" cy="15" r="0.3" fill="url(%23star)"/><circle cx="30" cy="60" r="0.4" fill="url(%23star)"/><circle cx="70" cy="80" r="0.2" fill="url(%23star)"/><circle cx="50" cy="30" r="0.3" fill="url(%23star)"/><circle cx="20" cy="85" r="0.4" fill="url(%23star)"/><circle cx="90" cy="50" r="0.2" fill="url(%23star)"/></svg>') repeat;
            background-size: 200px 200px;
            transform-origin: 0 0;            
            will-change: transform;           
        }

        .viewport-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 10px 16px;
            text-align: center;
            font-weight: 700;
            letter-spacing: .5px;
            background: linear-gradient(180deg, rgba(0,0,0,.85), rgba(0,0,0,0));
            z-index: 1500;
            pointer-events: none;
            user-select: none;
        }

        .viewport {
            position: fixed;
            inset: 0;                
            overflow: hidden;
            z-index: 0;              
        }

        .zoom-controls {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(0,0,0,0.65);
            border: 1px solid #d4af37;
            border-radius: 10px;
            padding: 8px;
            z-index: 1500;           
        }

        .zoom-btn {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            border: 1px solid #d4af37;
            background: rgba(212,175,55,0.20);
            color: #d4af37;
            font: inherit;
            cursor: pointer;
        }
        .zoom-btn:hover {
            background: rgba(212,175,55,0.35);
        }
        
        .skill-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 8px;
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 10;
            user-select: none;
        }
        
        .skill-node.locked {
            background: radial-gradient(circle, #2a2a2a 0%, #1a1a1a 100%);
            border-color: #666;
            color: #666;
            box-shadow: 0 0 5px rgba(100, 100, 100, 0.2);
            cursor: not-allowed;
        }
        
        .skill-node.available {
            background: radial-gradient(circle, #2a2a5a 0%, #1a1a4a 100%);
            border-color: #87ceeb;
            color: #87ceeb;
            box-shadow: 0 0 20px rgba(135, 206, 235, 0.6);
        }
        
        .skill-node.activated {
            background: radial-gradient(circle, #d4af37 0%, #b8860b 100%);
            border-color: #ffd700;
            color: #000;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.8);
        }

        /* In Progress - actively being worked on */
        .skill-node.in_progress {
            background: radial-gradient(circle, #3a5a8a 0%, #2a4a6a 100%);
            border-color: #4a9eff;
            color: #4a9eff;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.7);
            animation: pulse-progress 2s ease-in-out infinite;
        }

        @keyframes pulse-progress {
            0%, 100% { box-shadow: 0 0 20px rgba(74, 158, 255, 0.7); }
            50% { box-shadow: 0 0 30px rgba(74, 158, 255, 0.9); }
        }

        /* Mastered - fully achieved */
        .skill-node.mastered {
            background: radial-gradient(circle, #ffd700 0%, #d4af37 100%);
            border-color: #fff;
            color: #000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.9);
        }

        /* Needs Review - mastered but decayed */
        .skill-node.needs_review {
            background: radial-gradient(circle, #8b7355 0%, #6b5344 100%);
            border-color: #a08060;
            color: #d4c4a4;
            box-shadow: 0 0 15px rgba(160, 128, 96, 0.5);
            animation: pulse-review 3s ease-in-out infinite;
        }

        @keyframes pulse-review {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Highlighting animation for cross-tab navigation */
        @keyframes highlight-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px 15px rgba(255, 215, 0, 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .skill-node.highlighting {
            animation: highlight-pulse 0.5s ease-in-out 4;
            z-index: 1000 !important;
        }

        /* Toast notification animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .skill-node.needs_review::before {
            content: '!';
            position: absolute;
            top: -8px;
            right: -8px;
            width: 18px;
            height: 18px;
            background: #ff6b35;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        /* Mastery progress ring */
        .skill-node .mastery-ring {
            position: absolute;
            top: -4px;
            left: -4px;
            width: calc(100% + 8px);
            height: calc(100% + 8px);
            border-radius: 50%;
            pointer-events: none;
        }

        .skill-node .mastery-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .skill-node .mastery-ring circle {
            fill: none;
            stroke-width: 3;
        }

        .skill-node .mastery-ring .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .skill-node .mastery-ring .progress {
            stroke: #4ade80;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        /* Freshness indicator - shows how recently practiced */
        .skill-node .freshness-indicator {
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            pointer-events: none;
        }

        .skill-node.fresh::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            border: 1px solid #fff;
        }

        .skill-node.stale::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            background: #fbbf24;
            border-radius: 50%;
            border: 1px solid #fff;
        }

        .skill-node.root {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ffd700 0%, #daa520 100%);
            border: 4px solid #fff;
            font-size: 10px;
            box-shadow: 0 0 35px rgba(255, 215, 0, 0.9);
            color: #000;
        }
        
        .skill-node.root.programming {
            background: radial-gradient(circle, #00ff00 0%, #00aa00 100%);
            box-shadow: 0 0 35px rgba(0, 255, 0, 0.9);
        }
        
        .skill-node:hover:not(.locked) {
            transform: scale(1.2);
            z-index: 100;
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.2) 0%, rgba(212, 175, 55, 0.1) 50%, rgba(212, 175, 55, 0.2) 100%);
            transform-origin: left center;
            box-shadow: 0 0 3px rgba(212, 175, 55, 0.2);
            pointer-events: none;
            z-index: 1;
        }
        
        .connection-line.cross {
            height: 1px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 50%, rgba(255, 255, 255, 0.15) 100%);
        }
        
        .connection-line.active {
            height: 4px;
            background: linear-gradient(90deg, #ffd700 0%, #d4af37 50%, #ffd700 100%);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.9);
            z-index: 3;
        }
        
        .connection-line.cross.active {
            height: 3px;
            background: linear-gradient(90deg, #87ceeb 0%, #4169e1 50%, #87ceeb 100%);
            box-shadow: 0 0 8px rgba(135, 206, 235, 0.7);
        }

        .connection-line,
        .connection-line.highlighted,
        .connection-line.cross,
        .connection-line.cross.highlighted {
            pointer-events: none;
        }
        
        .constellation-label {
            position: absolute;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.7);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.4);
            z-index: 15;
            pointer-events: none;
            user-select: none;
        }
        
        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #d4af37;
            font-size: 14px;
        }

        .connection-line.highlighted {
            height: 4px;
            background: linear-gradient(90deg, #fff7b3 0%, #ffd700 50%, #fff7b3 100%);
            box-shadow: 0 0 18px rgba(255,215,0,0.95), 0 0 32px rgba(255,215,0,0.45);
            z-index: 4;
        }

        .connection-line.cross.highlighted {
            height: 3px;
            background: linear-gradient(90deg, #e0f1ff 0%, #7db5ff 50%, #e0f1ff 100%);
            box-shadow: 0 0 14px rgba(135,206,235,0.95), 0 0 28px rgba(135,206,235,0.45);
            z-index: 4;
        }

        .dim-lines .connection-line { opacity: 0.18; }
        .dim-lines .connection-line.highlighted { opacity: 1; }
        
        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            border: 1px solid #d4af37;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid;
        }
        
        .legend-circle.activated {
            background: radial-gradient(circle, #d4af37 0%, #b8860b 100%);
            border-color: #ffd700;
        }
        
        .legend-circle.available {
            background: radial-gradient(circle, #2a2a5a 0%, #1a1a4a 100%);
            border-color: #87ceeb;
        }
        
        .legend-circle.locked {
            background: radial-gradient(circle, #2a2a2a 0%, #1a1a1a 100%);
            border-color: #666;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: #d4af37;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #d4af37;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        /* Skill Detail Modal */
        .skill-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .skill-modal-overlay.active {
            display: flex;
        }

        .skill-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 2px solid #d4af37;
            border-radius: 16px;
            padding: 24px;
            max-width: 340px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 60px rgba(212, 175, 55, 0.15);
            animation: modalSlideIn 0.25s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .skill-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .skill-modal-title {
            color: #d4af37;
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            flex: 1;
        }

        .skill-modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            margin-left: 12px;
        }

        .skill-modal-close:hover {
            color: #d4af37;
        }

        .skill-modal-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .skill-modal-status.locked { background: #333; color: #888; }
        .skill-modal-status.available { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .skill-modal-status.in_progress { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .skill-modal-status.activated, .skill-modal-status.mastered { background: rgba(212, 175, 55, 0.2); color: #d4af37; }
        .skill-modal-status.needs_review { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .skill-modal-section {
            margin-bottom: 16px;
        }

        .skill-modal-section-title {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .skill-modal-section-content {
            color: #e0e0e0;
            font-size: 13px;
            line-height: 1.5;
        }

        .skill-modal-prereq {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 4px 0;
        }

        .skill-modal-prereq-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .skill-modal-prereq-dot.met { background: #22c55e; }
        .skill-modal-prereq-dot.unmet { background: #ef4444; }

        .skill-modal-mastery {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .skill-modal-mastery-bar {
            flex: 1;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .skill-modal-mastery-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #f0d78c);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .skill-modal-mastery-value {
            color: #d4af37;
            font-weight: 600;
            min-width: 40px;
            text-align: right;
        }

        .skill-modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .skill-modal-btn {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .skill-modal-btn:active {
            transform: scale(0.98);
        }

        .skill-modal-btn-primary {
            background: linear-gradient(135deg, #d4af37, #f0d78c);
            color: #0f0f1a;
        }

        .skill-modal-btn-primary:hover {
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
        }

        .skill-modal-btn-secondary {
            background: rgba(212, 175, 55, 0.15);
            color: #d4af37;
            border: 1px solid #d4af37;
        }

        .skill-modal-btn-secondary:hover {
            background: rgba(212, 175, 55, 0.25);
        }

        .skill-modal-btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .skill-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden { display: none !important; }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #0a0a2e 0%, #000000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }

        .loading-content {
            text-align: center;
            color: #d4af37;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(212, 175, 55, 0.2);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Override Code Modal */
        .override-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 30000;
        }

        .override-modal.active {
            display: flex;
        }

        .override-modal-content {
            background: rgba(26, 26, 58, 0.95);
            border: 2px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            min-width: 300px;
            max-width: 90%;
            pointer-events: auto;
        }

        .override-modal h3 {
            color: #ffd700;
            margin: 0 0 10px 0;
            font-size: 20px;
        }

        .override-modal p {
            color: #d4af37;
            margin: 0 0 20px 0;
            font-size: 14px;
        }

        .override-modal input {
            width: 100%;
            padding: 12px;
            font-size: 24px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #666;
            border-radius: 8px;
            color: #ffd700;
            letter-spacing: 4px;
            margin-bottom: 15px;
        }

        .override-modal input:focus {
            outline: none;
            border-color: #d4af37;
        }

        .override-modal .error-msg {
            color: #ff6b6b;
            font-size: 12px;
            margin-bottom: 15px;
            min-height: 18px;
        }

        .override-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .override-modal button {
            padding: 10px 25px;
            border-radius: 8px;
            border: 1px solid #d4af37;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }

        .override-modal .cancel-btn {
            background: transparent;
            color: #d4af37;
        }

        .override-modal .cancel-btn:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .override-modal .submit-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%);
            color: #000;
            border: none;
        }

        .override-modal .submit-btn:hover {
            background: linear-gradient(135deg, #ffd700 0%, #d4af37 100%);
        }

        .skill-node.system-locked {
            position: relative;
        }

        .skill-node.system-locked::after {
            content: 'üîí';
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 12px;
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .zoom-controls {
                right: 10px;
                bottom: 10px;
                padding: 6px;
                gap: 6px;
            }

            .zoom-btn {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .viewport-header {
                font-size: 16px;
                padding: 8px 15px;
            }

            .skill-node {
                width: 44px;
                height: 44px;
                font-size: 7px;
            }

            .controls {
                flex-wrap: wrap;
                gap: 5px;
            }

            .controls button {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .zoom-controls {
                right: 8px;
                bottom: 8px;
            }

            .zoom-btn {
                width: 52px;
                height: 52px;
                font-size: 22px;
            }

            .skill-node {
                width: 40px;
                height: 40px;
                font-size: 6px;
            }

            .viewport-header {
                font-size: 14px;
                padding: 6px 12px;
            }
        }

        /* Improve touch feedback */
        @media (hover: none) and (pointer: coarse) {
            .zoom-btn:active {
                background: rgba(212,175,55,0.5);
                transform: scale(0.95);
            }

            .skill-node:active {
                transform: scale(1.1);
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Loading Skill Tree...</h2>
            <p>Preparing your learning constellation</p>
        </div>
    </div>

    <div class="controls hidden" id="controls">
        ‚Ä¢ Click available nodes to unlock<br>
        ‚Ä¢ Scroll to explore constellations<br>
    </div>
    
    <div class="legend hidden" id="legend">
        <div class="legend-item">
            <div class="legend-circle activated"></div>
            <span>Unlocked</span>
        </div>
        <div class="legend-item">
            <div class="legend-circle available"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="legend-circle locked"></div>
            <span>Locked</span>
        </div>
    </div>

    <div class="viewport-header" id="viewportHeader">üåü Skill Tree</div>
    
    <div class="viewport hidden" id="viewport">
        <div class="constellation-container" id="constellation">
            <div id="stars"></div>
        </div>
    </div>
    
    <div class="zoom-controls hidden" id="zoomControls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">‚àí</button>
        <button class="zoom-btn" id="centerView">‚åÇ</button>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <!-- Skill Detail Modal -->
    <div class="skill-modal-overlay" id="skillModalOverlay">
        <div class="skill-modal" id="skillModal">
            <div class="skill-modal-header">
                <h3 class="skill-modal-title" id="skillModalTitle">Skill Name</h3>
                <button class="skill-modal-close" id="skillModalClose">&times;</button>
            </div>
            <div id="skillModalContent"></div>
        </div>
    </div>

    <!-- Override Code Modal -->
    <div class="override-modal" id="overrideModal">
        <div class="override-modal-content">
            <h3>Skill Locked</h3>
            <p>Enter override code to unlock this skill</p>
            <input type="text" id="overrideCodeInput" maxlength="10" placeholder="Enter code">
            <div class="error-msg" id="overrideError"></div>
            <div class="override-modal-buttons">
                <button class="cancel-btn" id="overrideCancelBtn" onclick="skillTreeManager.hideOverrideModal()">Cancel</button>
                <button class="submit-btn" id="overrideSubmitBtn" onclick="skillTreeManager.validateAndUnlock()">Unlock</button>
            </div>
        </div>
    </div>

    <script>
        class MultiSubjectSkillTreeManager {
            constructor() {
                // Configuration
                this.CHARS = 'ABCDEFGHIJKLMNPQRSTUVWXYZ23456789';
                this.currentSubject = 'Art';
                this.isReadOnly = false;
                
                // State
                this.skillProgress = {};
                this.SKILL_TREE = {};
                this.CONNECTIONS = [];
                this.CONSTELLATION_COLORS = {};
                this.CONSTELLATION_POSITIONS = {};
                this.connectionElements = [];
                this.container = null;
                this.viewport = null;
                
                // Touch and drag state
                this.isDragging = false;
                this.lastTouchTime = 0;
                this.longPressTimer = null;
                this.currentScale = 1;
                this.currentX = 0;
                this.currentY = 0;
                this.startX = 0;
                this.startY = 0;
                this.dragStartX = 0;
                this.dragStartY = 0;

                // Pinch-to-zoom state
                this.isPinching = false;
                this.initialPinchDistance = 0;
                this.initialPinchScale = 1;
                this.pinchCenterX = 0;
                this.pinchCenterY = 0;

                // Modal state
                this.currentModalSkill = null;
                
                // Mobile detection
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                                ('ontouchstart' in window);
                
                this.LONG_PRESS_DURATION = 500;

                // System lock state
                this.systemLocked = true;
                this.pendingUnlockSkill = null;

                this.init();
            }

            // === INITIALIZATION ===
            init() {
                // Get subject from URL parameter
                const params = new URLSearchParams(window.location.search);
                this.currentSubject = params.get('subject') || 'Art';

                // Update header
                const header = document.getElementById('viewportHeader');
                if (header) {
                    const emoji = this.getSubjectEmoji(this.currentSubject);
                    header.textContent = `${emoji} ${this.currentSubject} Skill Tree`;
                }

                // Set up message listeners
                window.addEventListener('message', (event) => this.handleMessage(event));

                // Set up localStorage listeners for cross-tab communication with Dojo
                window.addEventListener('storage', (event) => this.handleStorageEvent(event));

                // Request initial data from parent
                this.requestSkillData();

                // Set up UI after short delay
                setTimeout(() => {
                    this.setupUI();
                    this.setupOverrideModal();
                }, 100);
            }

            // === CROSS-TAB COMMUNICATION (localStorage) ===
            handleStorageEvent(event) {
                // Handle Dojo session complete
                if (event.key === 'dojo_session_complete' && event.newValue) {
                    try {
                        const data = JSON.parse(event.newValue);
                        this.handleDojoSessionFromStorage(data);
                    } catch (e) {
                        console.warn('Failed to parse dojo session data:', e);
                    }
                }

                // Handle Dojo lesson complete
                if (event.key === 'dojo_lesson_complete' && event.newValue) {
                    try {
                        const data = JSON.parse(event.newValue);
                        this.handleDojoLessonFromStorage(data);
                    } catch (e) {
                        console.warn('Failed to parse dojo lesson data:', e);
                    }
                }

                // Handle Belt Test complete - bulk skill tree update
                if (event.key === 'belt_test_complete' && event.newValue) {
                    try {
                        const data = JSON.parse(event.newValue);
                        this.handleBeltTestFromStorage(data);
                    } catch (e) {
                        console.warn('Failed to parse belt test data:', e);
                    }
                }

                // Handle Dojo highlight request
                if (event.key === 'dojo_highlight_request' && event.newValue) {
                    try {
                        const data = JSON.parse(event.newValue);
                        if (data.subject === this.currentSubject) {
                            this.highlightSkill(data.skill);
                        }
                    } catch (e) {
                        console.warn('Failed to parse highlight request:', e);
                    }
                }
            }

            // Handle belt test results - bulk update many skills at once
            handleBeltTestFromStorage(data) {
                if (this.currentSubject !== 'Math') return;

                console.log('Received Belt Test results from storage:', data.results);
                const { results } = data;

                // Apply mastered skills
                for (const skill of results.mastered || []) {
                    if (this.SKILL_TREE[skill.skill]) {
                        this.SKILL_TREE[skill.skill].state = 'mastered';
                        this.SKILL_TREE[skill.skill].mastery_score = 100;
                        this.SKILL_TREE[skill.skill].last_practiced = new Date().toISOString();
                        this.SKILL_TREE[skill.skill].mastered_at = new Date().toISOString();
                    }
                }

                // Apply activated skills
                for (const skill of results.activated || []) {
                    if (this.SKILL_TREE[skill.skill]) {
                        const current = this.SKILL_TREE[skill.skill];
                        if (current.state !== 'mastered') {
                            current.state = 'activated';
                            current.mastery_score = Math.max(current.mastery_score || 0, skill.accuracy);
                            current.last_practiced = new Date().toISOString();
                        }
                    }
                }

                // Apply in-progress skills
                for (const skill of results.inProgress || []) {
                    if (this.SKILL_TREE[skill.skill]) {
                        const current = this.SKILL_TREE[skill.skill];
                        if (current.state === 'locked' || current.state === 'available') {
                            current.state = 'in_progress';
                            current.mastery_score = Math.max(current.mastery_score || 0, skill.accuracy);
                            current.last_practiced = new Date().toISOString();
                        }
                    }
                }

                // Apply inferred prerequisites
                for (const skill of results.inferred || []) {
                    if (this.SKILL_TREE[skill.skill]) {
                        const current = this.SKILL_TREE[skill.skill];
                        if (skill.newState === 'mastered' && current.state !== 'mastered') {
                            current.state = 'mastered';
                            current.mastery_score = 100;
                            current.last_practiced = new Date().toISOString();
                            current.mastered_at = new Date().toISOString();
                        } else if (skill.newState === 'activated' && current.state !== 'mastered' && current.state !== 'activated') {
                            current.state = 'activated';
                            current.mastery_score = Math.max(current.mastery_score || 0, 70);
                            current.last_practiced = new Date().toISOString();
                        }
                    }
                }

                // Update available skills based on new masteries
                this.updateAvailableSkills();

                // Redraw tree
                this.draw();
                this.saveProgressToStorage();

                // Show notification
                const totalMastered = (results.mastered?.length || 0) + (results.inferred?.filter(s => s.newState === 'mastered')?.length || 0);
                if (totalMastered > 0) {
                    this.showNotification(`Belt Test: ${totalMastered} skills mastered!`);
                }
            }

            // Handle session results from Dojo via localStorage
            handleDojoSessionFromStorage(data) {
                if (this.currentSubject !== 'Math') return;

                console.log('Received Dojo session from storage:', data.skillResults?.length, 'skills');

                // Process each skill result with centralized mastery calculation
                data.skillResults?.forEach(result => {
                    const newMastery = this.calculateMasteryFromSession(result);
                    this.updateSkillFromSession(result.skill, newMastery, result);
                });

                this.draw();
                this.saveProgressToStorage();
            }

            // Handle lesson completion from Dojo via localStorage
            handleDojoLessonFromStorage(data) {
                if (this.currentSubject !== 'Math') return;

                console.log('Received Dojo lesson complete from storage:', data.skill);

                if (this.SKILL_TREE[data.skill]) {
                    this.SKILL_TREE[data.skill].state = 'mastered';
                    this.SKILL_TREE[data.skill].mastery_score = 100;
                    this.SKILL_TREE[data.skill].last_practiced = new Date().toISOString();
                    this.SKILL_TREE[data.skill].mastered_at = new Date().toISOString();
                    this.triggerSkillUnlock(data.skill);
                    this.draw();
                    this.saveProgressToStorage();
                }
            }

            // Highlight a skill (visual feedback for cross-tab navigation)
            highlightSkill(skillName) {
                const node = document.querySelector(`[data-skill="${skillName}"]`);
                if (node) {
                    // Scroll to skill
                    this.centerOnSkill(skillName);

                    // Add highlight animation
                    node.classList.add('highlighting');
                    setTimeout(() => node.classList.remove('highlighting'), 2000);
                }
            }

            // Center viewport on a skill
            centerOnSkill(skillName) {
                const skill = this.SKILL_TREE[skillName];
                if (!skill || !this.viewport) return;

                const viewportRect = this.viewport.getBoundingClientRect();
                const centerX = viewportRect.width / 2;
                const centerY = viewportRect.height / 2;

                this.currentX = centerX - (skill.x * this.currentScale);
                this.currentY = centerY - (skill.y * this.currentScale);

                this.updateTransform();
            }

            // === CENTRALIZED MASTERY CALCULATION ===
            calculateMasteryFromSession(result) {
                const { correct, total, avgTime, accuracy } = result;
                const skill = this.SKILL_TREE[result.skill];
                const currentMastery = skill?.mastery_score || 0;

                // Base mastery from accuracy
                let sessionMastery = accuracy;

                // Bonus for speed (if avgTime < 10 seconds, add up to 10 points)
                if (avgTime && avgTime < 10000) {
                    sessionMastery += Math.round((10000 - avgTime) / 1000);
                }

                // Bonus for volume (more questions = more reliable score)
                if (total >= 5) {
                    sessionMastery += 5;
                }

                // Cap at 100
                sessionMastery = Math.min(100, sessionMastery);

                // Blend with existing mastery (weighted average)
                // New sessions have more weight if they're better
                if (sessionMastery > currentMastery) {
                    return Math.round((currentMastery * 0.3) + (sessionMastery * 0.7));
                } else {
                    // If worse, still update but with less impact
                    return Math.round((currentMastery * 0.7) + (sessionMastery * 0.3));
                }
            }

            // Update skill data from session
            updateSkillFromSession(skillName, newMastery, result) {
                if (!this.SKILL_TREE[skillName]) return;

                const skill = this.SKILL_TREE[skillName];
                const oldState = skill.state;

                skill.mastery_score = newMastery;
                skill.last_practiced = new Date().toISOString();
                skill.practice_count = (skill.practice_count || 0) + 1;

                // Update state based on new mastery
                if (newMastery >= 80 && result.total >= 3) {
                    if (skill.state !== 'mastered') {
                        skill.state = 'mastered';
                        skill.mastered_at = new Date().toISOString();
                        this.triggerSkillUnlock(skillName);
                    }
                } else if (newMastery >= 60) {
                    if (skill.state === 'locked' || skill.state === 'available') {
                        skill.state = 'activated';
                    }
                } else if (skill.state === 'locked' || skill.state === 'available') {
                    skill.state = 'in_progress';
                }

                this.updateNodeVisuals(skillName);
            }

            // Save progress to localStorage for Dojo to read
            saveProgressToStorage() {
                try {
                    const progress = {};
                    Object.keys(this.SKILL_TREE).forEach(skillName => {
                        const skill = this.SKILL_TREE[skillName];
                        progress[skillName] = {
                            state: skill.state,
                            mastery_score: skill.mastery_score || 0,
                            last_practiced: skill.last_practiced,
                            practice_count: skill.practice_count || 0,
                            decay_rate: skill.decay_rate || 14
                        };
                    });

                    localStorage.setItem('math_skill_states', JSON.stringify({
                        skills: progress,
                        lastSync: Date.now()
                    }));
                } catch (e) {
                    console.warn('Failed to save progress to storage:', e);
                }
            }

            // Send practice request to Dojo (for "Practice in Dojo" button)
            requestPracticeInDojo(skillName) {
                // Save the request to localStorage so Dojo can pick it up
                localStorage.setItem('tree_practice_request', JSON.stringify({
                    skill: skillName,
                    subject: this.currentSubject,
                    timestamp: Date.now()
                }));

                // Show feedback
                this.showNotification(`Opening "${skillName}" in Math Dojo...`);

                // Tell parent app to open Math Dojo game
                setTimeout(() => {
                    if (window.parent && window.parent !== window) {
                        // We're in an iframe - send message to parent
                        window.parent.postMessage({
                            type: 'OPEN_GAME',
                            gameId: 'math-dojo'
                        }, '*');
                    } else {
                        // Direct navigation fallback
                        window.location.href = '/games/math-dojo.html';
                    }
                }, 300);
            }

            // Show notification toast
            showNotification(message) {
                let container = document.getElementById('tree-notification-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'tree-notification-container';
                    container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
                    document.body.appendChild(container);
                }

                const toast = document.createElement('div');
                toast.style.cssText = `
                    background: rgba(30, 41, 59, 0.95);
                    border: 1px solid #ffd700;
                    color: #f1f5f9;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    margin-bottom: 10px;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            getSubjectEmoji(subject) {
                const emojis = {
                    'Art': 'üé®',
                    'Math': 'üìê',
                    'Science': 'üî¨',
                    'Reading': 'üìö',
                    'Programming': 'üíª',
                    'Robotics': 'ü§ñ',
                    'History': 'üèõÔ∏è',
                    'Music': 'üéµ',
                    'Physical Education': '‚öΩ',
                    'Computer Science': 'üíª'
                };
                return emojis[subject] || 'üåü';
            }

            // === MESSAGE HANDLING ===
            handleMessage(event) {
                console.log('Skill tree received message:', event.data.type);

                switch (event.data.type) {
                    case 'LOAD_SKILL_TREE':
                        this.loadSkillTreeData(event.data);
                        break;
                    case 'SKILL_DATA_RESPONSE':
                        this.loadSkillTreeData(event.data);
                        break;
                    case 'PROGRESS_UPDATED':
                        this.updateProgress(event.data.progress);
                        break;
                    // Math Dojo integration messages
                    case 'DOGO_SKILL_PROGRESS':
                        this.handleDogoSkillProgress(event.data);
                        break;
                    case 'DOGO_SESSION_COMPLETE':
                        this.handleDogoSessionComplete(event.data);
                        break;
                    case 'DOGO_LESSON_COMPLETE':
                        this.handleDogoLessonComplete(event.data);
                        break;
                    case 'DOGO_REQUEST_SKILL_DATA':
                        this.sendSkillDataToDojo();
                        break;
                }
            }

            // Handle real-time skill progress from Math Dojo
            handleDogoSkillProgress(data) {
                const { skill, domain, tier, correct, total, masteryScore, skillState, averageTime } = data;
                console.log(`Dojo progress: ${skill} - ${correct}/${total} (${masteryScore}%)`);

                // Find and update the skill in SKILL_TREE
                if (this.SKILL_TREE[skill]) {
                    const skillData = this.SKILL_TREE[skill];

                    // Update skill state based on mastery
                    if (skillState === 'mastered' && skillData.state !== 'mastered') {
                        this.SKILL_TREE[skill].state = 'mastered';
                        this.triggerSkillUnlock(skill);
                    } else if (skillState === 'activated' && skillData.state === 'available') {
                        this.SKILL_TREE[skill].state = 'activated';
                    } else if (skillData.state === 'locked' || skillData.state === 'available') {
                        this.SKILL_TREE[skill].state = 'in_progress';
                    }

                    // Store progress data
                    if (!this.skillProgress) this.skillProgress = {};
                    this.skillProgress[skill] = {
                        correct,
                        total,
                        masteryScore,
                        averageTime,
                        lastUpdated: Date.now()
                    };

                    // Redraw to show updated state
                    this.draw();
                }

                // Forward to parent for persistence
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'SKILL_TREE_UPDATE',
                        skill: skill,
                        progress: { correct, total, masteryScore, skillState },
                        source: 'math_dojo'
                    }, '*');
                }
            }

            // Handle end of Dojo session with full results
            handleDogoSessionComplete(data) {
                const { mode, skillProgress, gapLog, history } = data;
                console.log(`Dojo session complete (${mode}):`, skillProgress.length, 'skills practiced');

                // Update all skills from session
                skillProgress.forEach(sp => {
                    if (this.SKILL_TREE[sp.skill]) {
                        if (sp.skillState === 'mastered') {
                            this.SKILL_TREE[sp.skill].state = 'mastered';
                        } else if (sp.skillState === 'activated' && this.SKILL_TREE[sp.skill].state !== 'mastered') {
                            this.SKILL_TREE[sp.skill].state = 'activated';
                        }
                    }
                });

                this.draw();

                // Forward full session to parent for persistence
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'DOGO_SESSION_TO_PERSIST',
                        mode,
                        skillProgress,
                        gapLog,
                        historyCount: history.length,
                        timestamp: Date.now()
                    }, '*');
                }
            }

            // Handle lesson completion from Learning Center
            handleDogoLessonComplete(data) {
                const { skill, domain, tier } = data;
                console.log(`Dojo lesson complete: ${skill}`);

                // Mark skill as mastered (completing a lesson = full mastery)
                if (this.SKILL_TREE[skill]) {
                    this.SKILL_TREE[skill].state = 'mastered';
                    this.triggerSkillUnlock(skill);
                    this.draw();
                }

                // Forward to parent for persistence
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'SKILL_TREE_UPDATE',
                        skill: skill,
                        progress: { correct: 3, total: 3, masteryScore: 100, skillState: 'mastered' },
                        source: 'math_dojo_lesson'
                    }, '*');
                }
            }

            // Send current skill data to Math Dojo
            sendSkillDataToDojo() {
                // Compile skill states for Dojo
                const skillStates = {};
                Object.keys(this.SKILL_TREE).forEach(skill => {
                    skillStates[skill] = this.SKILL_TREE[skill].state;
                });

                // Send to all frames (Dojo iframe)
                const frames = document.querySelectorAll('iframe');
                frames.forEach(frame => {
                    frame.contentWindow.postMessage({
                        type: 'SKILL_DATA_FOR_DOGO',
                        skillStates,
                        progress: this.skillProgress || {}
                    }, '*');
                });
            }

            // Trigger skill unlock animations and unlock dependent skills
            triggerSkillUnlock(skillName) {
                console.log(`Skill unlocked: ${skillName}`);

                // Find skills that have this as a prerequisite
                this.CONNECTIONS.forEach(conn => {
                    if (conn.from === skillName && this.SKILL_TREE[conn.to]) {
                        const dependentSkill = this.SKILL_TREE[conn.to];
                        // Check if all prerequisites are now mastered
                        const prereqs = this.CONNECTIONS
                            .filter(c => c.to === conn.to)
                            .map(c => c.from);
                        const allMastered = prereqs.every(p =>
                            this.SKILL_TREE[p] && this.SKILL_TREE[p].state === 'mastered'
                        );
                        if (allMastered && dependentSkill.state === 'locked') {
                            this.SKILL_TREE[conn.to].state = 'available';
                            console.log(`Unlocked: ${conn.to}`);
                        }
                    }
                });

                // Notify parent of unlock
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'SKILL_UNLOCKED',
                        skill: skillName
                    }, '*');
                }
            }

            requestSkillData() {
                // Request skill tree data from parent
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'REQUEST_SKILL_DATA',
                        subject: this.currentSubject
                    }, '*');
                } else {
                    // Fallback for standalone testing
                    setTimeout(() => {
                        this.loadSubjectData(this.currentSubject);
                        this.initializeProgress();
                        this.enterApplication();
                    }, 500);
                }
            }

            loadSkillTreeData(data) {
                console.log('Loading skill tree data:', data);
                
                if (data.skillTreeData && data.skillTreeData.skills) {
                    // Load from database format
                    this.SKILL_TREE = data.skillTreeData.skills;
                    this.CONNECTIONS = data.skillTreeData.connections || [];
                    this.CONSTELLATION_COLORS = {};
                    this.CONSTELLATION_POSITIONS = {};
                    
                    // Process constellation data
                    if (data.skillTreeData.constellations) {
                        Object.entries(data.skillTreeData.constellations).forEach(([name, info]) => {
                            this.CONSTELLATION_COLORS[name] = info.color;
                            this.CONSTELLATION_POSITIONS[name] = { x: info.x, y: info.y };
                        });
                    }
                } else {
                    // Fallback to hardcoded data
                    this.loadSubjectData(this.currentSubject);
                }
                
                // Apply progress
                if (data.progress) {
                    this.applyProgress(data.progress);
                } else {
                    this.initializeProgress();
                }

                // Save to localStorage so Dojo can read it
                if (this.currentSubject === 'Math') {
                    this.saveProgressToStorage();
                }

                // Initialize the tree
                this.enterApplication();
            }

            loadSubjectData(subject) {
                const dataLoaders = {
                    'Art': () => this.loadArtData(),
                    'Math': () => this.loadMathData(),
                    'Science': () => this.loadScienceData(),
                    'Reading': () => this.loadReadingData(),
                    'Programming': () => this.loadProgrammingData(),
                    'Robotics': () => this.loadRoboticsData()
                };
                
                const loader = dataLoaders[subject] || dataLoaders['Art'];
                loader();
            }

            loadArtData() {
                // Complete Art skill tree with all nodes
                this.SKILL_TREE = {
                    "Foundational Drawing": { x: 1200, y: 900, type: "root", constellation: "Core", state: "locked" },
                    "Line": { x: 1162, y: 463, constellation: "Art Fundamentals", state: "locked" },
                    "Color Theory": { x: 887, y: 939, constellation: "Traditional Media", state: "locked" },
                    "Digital Drawing Tools": { x: 1566, y: 684, constellation: "Digital Art", state: "locked" },
                    "2D Graphic Design": { x: 1260, y: 628, constellation: "Design", state: "locked" },
                    "Animation Basics": { x: 1306, y: 1044, constellation: "Animation", state: "locked" },
                    "AI-Assisted Art": { x: 1070, y: 1007, constellation: "Creative Technology", state: "locked" },
                    "Portfolio Development": { x: 1652, y: 503, constellation: "Professional", state: "locked" },
                    "Scientific Illustration": { x: 862, y: 616, constellation: "Specialized", state: "locked" },
                    "Shape": { x: 1114, y: 374, constellation: "Art Fundamentals", state: "locked" },
                    "Form": { x: 1141, y: 284, constellation: "Art Fundamentals", state: "locked" },
                    "Anatomy": { x: 901, y: 397, constellation: "Art Fundamentals", state: "locked" },
                    "Value & Perspective": { x: 1220, y: 317, constellation: "Art Fundamentals", state: "locked" },
                    "Composition": { x: 1241, y: 412, constellation: "Art Fundamentals", state: "locked" },
                    "Figure Drawing": { x: 1104, y: 637, constellation: "Art Fundamentals", state: "locked" },
                    "Gesture Drawing": { x: 1077, y: 519, constellation: "Art Fundamentals", state: "locked" },
                    "Storytelling": { x: 1329, y: 287, constellation: "Art Fundamentals", state: "locked" },
                    "Color Mixing": { x: 978, y: 852, constellation: "Traditional Media", state: "locked" },
                    "Basic Painting": { x: 967, y: 758, constellation: "Traditional Media", state: "locked" },
                    "Pastels": { x: 721, y: 1101, constellation: "Traditional Media", state: "locked" },
                    "Oil Techniques": { x: 671, y: 821, constellation: "Traditional Media", state: "locked" },
                    "Watercolor": { x: 594, y: 915, constellation: "Traditional Media", state: "locked" },
                    "Acrylic": { x: 768, y: 917, constellation: "Traditional Media", state: "locked" },
                    "Charcoal": { x: 669, y: 693, constellation: "Traditional Media", state: "locked" },
                    "Still Life": { x: 565, y: 748, constellation: "Traditional Media", state: "locked" },
                    "Landscapes": { x: 424, y: 832, constellation: "Traditional Media", state: "locked" },
                    "Portraiture": { x: 490, y: 1041, constellation: "Traditional Media", state: "locked" },
                    "Digital Sketching": { x: 1692, y: 651, constellation: "Digital Art", state: "locked" },
                    "Digital Painting": { x: 1518, y: 779, constellation: "Digital Art", state: "locked" },
                    "Photo Manipulation": { x: 1789, y: 555, constellation: "Digital Art", state: "locked" },
                    "Character Design": { x: 1540, y: 877, constellation: "Digital Art", state: "locked" },
                    "Environment Art": { x: 1659, y: 818, constellation: "Digital Art", state: "locked" },
                    "Speed Painting": { x: 1895, y: 703, constellation: "Digital Art", state: "locked" },
                    "Concept Art": { x: 1592, y: 973, constellation: "Digital Art", state: "locked" },
                    "Digital Illustration": { x: 1715, y: 1062, constellation: "Digital Art", state: "locked" },
                    "Matte Painting": { x: 1769, y: 959, constellation: "Digital Art", state: "locked" },
                    "Texture Painting": { x: 1828, y: 824, constellation: "Digital Art", state: "locked" },
                    "Logo Design": { x: 1337, y: 523, constellation: "Design", state: "locked" },
                    "Typography": { x: 1469, y: 553, constellation: "Design", state: "locked" },
                    "Print Design": { x: 1323, y: 387, constellation: "Design", state: "locked" },
                    "Layout Design": { x: 1409, y: 439, constellation: "Design", state: "locked" },
                    "Branding": { x: 1450, y: 350, constellation: "Design", state: "locked" },
                    "Package Design": { x: 1557, y: 385, constellation: "Design", state: "locked" },
                    "UI/UX Design": { x: 1424, y: 162, constellation: "Design", state: "locked" },
                    "Web Design": { x: 1574, y: 264, constellation: "Design", state: "locked" },
                    "2D Animation": { x: 1448, y: 1007, constellation: "Animation", state: "locked" },
                    "3D Basics": { x: 1211, y: 1115, constellation: "Animation", state: "locked" },
                    "Stop Motion": { x: 1401, y: 1131, constellation: "Animation", state: "locked" },
                    "Motion Graphics": { x: 1358, y: 866, constellation: "Animation", state: "locked" },
                    "Character Animation": { x: 1514, y: 1090, constellation: "Animation", state: "locked" },
                    "Rigging": { x: 1374, y: 1290, constellation: "Animation", state: "locked" },
                    "VFX": { x: 1405, y: 919, constellation: "Animation", state: "locked" },
                    "Compositing": { x: 1541, y: 1214, constellation: "Animation", state: "locked" },
                    "Style Transfer": { x: 992, y: 1160, constellation: "Creative Technology", state: "locked" },
                    "Prompt Crafting": { x: 854, y: 1125, constellation: "Creative Technology", state: "locked" },
                    "Art Ethics": { x: 917, y: 1027, constellation: "Creative Technology", state: "locked" },
                    "Creative Coding": { x: 1091, y: 1122, constellation: "Creative Technology", state: "locked" },
                    "Generative Art": { x: 816, y: 1270, constellation: "Creative Technology", state: "locked" },
                    "Machine Learning": { x: 1074, y: 1250, constellation: "Creative Technology", state: "locked" },
                    "Neural Networks": { x: 950, y: 1328, constellation: "Creative Technology", state: "locked" },
                    "Art Business": { x: 1714, y: 438, constellation: "Professional", state: "locked" },
                    "Teaching Art": { x: 1709, y: 321, constellation: "Professional", state: "locked" },
                    "Freelancing": { x: 1854, y: 467, constellation: "Professional", state: "locked" },
                    "Client Work": { x: 1918, y: 345, constellation: "Professional", state: "locked" },
                    "Art Direction": { x: 2005, y: 275, constellation: "Professional", state: "locked" },
                    "Marketing": { x: 1805, y: 280, constellation: "Professional", state: "locked" },
                    "Art Critique": { x: 1724, y: 188, constellation: "Professional", state: "locked" },
                    "Networking": { x: 2088, y: 482, constellation: "Professional", state: "locked" },
                    "Medical Art": { x: 888, y: 500, constellation: "Specialized", state: "locked" },
                    "Botanical Art": { x: 713, y: 590, constellation: "Specialized", state: "locked" },
                    "Technical Drawing": { x: 766, y: 352, constellation: "Specialized", state: "locked" },
                    "Architectural Rendering": { x: 603, y: 245, constellation: "Specialized", state: "locked" },
                    "Fashion Illustration": { x: 977, y: 644, constellation: "Specialized", state: "locked" }
                };
                
                this.CONNECTIONS = [
                    ["Foundational Drawing", "Line"], ["Foundational Drawing", "Color Theory"],
                    ["Foundational Drawing", "Digital Drawing Tools"], ["Foundational Drawing", "2D Graphic Design"],
                    ["Foundational Drawing", "Animation Basics"], ["Foundational Drawing", "AI-Assisted Art"],
                    ["Foundational Drawing", "Portfolio Development"], ["Foundational Drawing", "Scientific Illustration"],
                    ["Line", "Shape"], ["Line", "Anatomy"], ["Shape", "Form"], ["Anatomy", "Figure Drawing"],
                    ["Figure Drawing", "Gesture Drawing"], ["Shape", "Composition"], ["Form", "Value & Perspective"],
                    ["Value & Perspective", "Storytelling"], ["Composition", "Storytelling"],
                    ["Color Theory", "Color Mixing"], ["Color Mixing", "Basic Painting"],
                    ["Basic Painting", "Oil Techniques"], ["Basic Painting", "Watercolor"], ["Basic Painting", "Acrylic"],
                    ["Oil Techniques", "Still Life"], ["Watercolor", "Landscapes"], ["Acrylic", "Portraiture"],
                    ["Color Theory", "Pastels"], ["Basic Painting", "Charcoal"],
                    ["Digital Drawing Tools", "Digital Sketching"], ["Digital Drawing Tools", "Digital Painting"],
                    ["Digital Painting", "Character Design"], ["Digital Painting", "Environment Art"],
                    ["Character Design", "Concept Art"], ["Digital Sketching", "Photo Manipulation"],
                    ["Concept Art", "Digital Illustration"], ["Environment Art", "Matte Painting"],
                    ["Digital Painting", "Speed Painting"], ["Environment Art", "Texture Painting"],
                    ["2D Graphic Design", "Logo Design"], ["2D Graphic Design", "Typography"],
                    ["Logo Design", "Layout Design"], ["Typography", "Layout Design"],
                    ["Layout Design", "Branding"], ["Layout Design", "Print Design"],
                    ["Branding", "UI/UX Design"], ["UI/UX Design", "Web Design"], ["Branding", "Package Design"],
                    ["Animation Basics", "2D Animation"], ["Animation Basics", "3D Basics"], ["Animation Basics", "Stop Motion"],
                    ["2D Animation", "Character Animation"], ["3D Basics", "Rigging"], ["Animation Basics", "Motion Graphics"],
                    ["Motion Graphics", "VFX"], ["Character Animation", "Compositing"],
                    ["AI-Assisted Art", "Style Transfer"], ["AI-Assisted Art", "Prompt Crafting"], ["AI-Assisted Art", "Art Ethics"],
                    ["Style Transfer", "Generative Art"], ["Prompt Crafting", "Generative Art"], ["AI-Assisted Art", "Creative Coding"],
                    ["Creative Coding", "Machine Learning"], ["Machine Learning", "Neural Networks"],
                    ["Portfolio Development", "Art Business"], ["Art Business", "Freelancing"], ["Art Business", "Teaching Art"],
                    ["Freelancing", "Client Work"], ["Client Work", "Art Direction"], ["Teaching Art", "Art Critique"],
                    ["Art Business", "Marketing"], ["Client Work", "Networking"],
                    ["Scientific Illustration", "Medical Art"], ["Scientific Illustration", "Botanical Art"],
                    ["Scientific Illustration", "Technical Drawing"], ["Technical Drawing", "Architectural Rendering"],
                    ["Figure Drawing", "Fashion Illustration"], ["Figure Drawing", "Character Design"],
                    ["Color Theory", "Digital Painting"], ["Composition", "2D Graphic Design"],
                    ["Digital Painting", "2D Animation"], ["Anatomy", "Medical Art"], ["Technical Drawing", "UI/UX Design"],
                    ["Portfolio Development", "Web Design"], ["Basic Painting", "Digital Painting"],
                    ["Typography", "Motion Graphics"], ["Character Design", "Character Animation"]
                ];
                
                this.CONSTELLATION_COLORS = {
                    "Core": "#ffd700", "Art Fundamentals": "#87ceeb", "Traditional Media": "#dda0dd",
                    "Digital Art": "#98fb98", "Design": "#ffa07a", "Animation": "#20b2aa",
                    "Creative Technology": "#ff6347", "Professional": "#daa520", "Specialized": "#f0e68c"
                };
                
                this.CONSTELLATION_POSITIONS = {
                    "Art Fundamentals": { x: 977, y: 455 }, "Traditional Media": { x: 765, y: 738 },
                    "Digital Art": { x: 1688, y: 752 }, "Design": { x: 1486, y: 458 },
                    "Animation": { x: 1385, y: 1079 }, "Creative Technology": { x: 982, y: 1087 },
                    "Professional": { x: 1762, y: 383 }, "Specialized": { x: 726, y: 484 }
                };
            }

            loadMathData() {
                // Adapted from the math skill tree data
                // Enhanced with K-12 comprehensive skills for game integration
                this.SKILL_TREE = {
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // BASIC ARITHMETIC - "The Foundation Star" (Sprawling base pattern)
                    // Central hub with rays extending outward like a starburst
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Counting and Number Recognition": { x: 1000, y: 2800, type: "root", constellation: "Basic Arithmetic", state: "locked" },
                    // Left ray - Number concepts
                    "Number Lines": { x: 850, y: 2720, constellation: "Basic Arithmetic", state: "locked" },
                    "Even and Odd": { x: 720, y: 2650, constellation: "Basic Arithmetic", state: "locked" },
                    "Skip Counting": { x: 780, y: 2780, constellation: "Basic Arithmetic", state: "locked" },
                    "Picture Graphs": { x: 650, y: 2720, constellation: "Basic Arithmetic", state: "locked" },
                    // Upper ray - Place value branch
                    "Teen Numbers": { x: 920, y: 2680, constellation: "Basic Arithmetic", state: "locked" },
                    "Place Value Understanding": { x: 1000, y: 2600, constellation: "Basic Arithmetic", state: "locked" },
                    "Number Bonds": { x: 880, y: 2520, constellation: "Basic Arithmetic", state: "locked" },
                    // Right ray - Comparison & ordering
                    "Comparing Numbers": { x: 1150, y: 2720, constellation: "Basic Arithmetic", state: "locked" },
                    "Ordering Numbers": { x: 1280, y: 2650, constellation: "Basic Arithmetic", state: "locked" },
                    "Comparing Lengths": { x: 1350, y: 2720, constellation: "Basic Arithmetic", state: "locked" },
                    "Positional Words": { x: 1450, y: 2650, constellation: "Basic Arithmetic", state: "locked" },
                    "Classifying Objects": { x: 1520, y: 2580, constellation: "Basic Arithmetic", state: "locked" },
                    // Upper right ray - Time & money
                    "Time Telling": { x: 1200, y: 2580, constellation: "Basic Arithmetic", state: "locked" },
                    "Money and Coins": { x: 1300, y: 2500, constellation: "Basic Arithmetic", state: "locked" },
                    "Patterns and Sequences": { x: 1380, y: 2420, constellation: "Basic Arithmetic", state: "locked" },
                    // Operations branch (flows upward)
                    "Basic Addition": { x: 1100, y: 2480, constellation: "Basic Arithmetic", state: "locked" },
                    "Basic Subtraction": { x: 900, y: 2480, constellation: "Basic Arithmetic", state: "locked" },
                    // Shapes branch (far right)
                    "3D Shapes": { x: 1550, y: 2700, constellation: "Basic Arithmetic", state: "locked" },
                    "Partitioning Shapes": { x: 1620, y: 2620, constellation: "Basic Arithmetic", state: "locked" },
                    "Composing Shapes": { x: 1680, y: 2540, constellation: "Basic Arithmetic", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // INTERMEDIATE ARITHMETIC - "The Bridge" (Hourglass shape)
                    // Converges from addition/subtraction, expands to operations
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Multi-Digit Addition": { x: 1050, y: 2350, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Multi-Digit Subtraction": { x: 950, y: 2350, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Multiplication Properties": { x: 880, y: 2280, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Multiplication": { x: 1000, y: 2220, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Arrays and Area Models": { x: 1120, y: 2280, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Division": { x: 1000, y: 2120, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Long Division": { x: 1100, y: 2050, constellation: "Intermediate Arithmetic", state: "locked" },
                    // Left branch - Fractions cluster
                    "Basic Fractions": { x: 800, y: 2100, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Equivalent Fractions": { x: 700, y: 2030, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Simplifying Fractions": { x: 620, y: 1960, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Mixed Numbers": { x: 780, y: 1980, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Fraction Operations": { x: 700, y: 1900, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Fraction Word Problems": { x: 620, y: 1840, constellation: "Intermediate Arithmetic", state: "locked" },
                    // Center - Estimation
                    "Rounding and Estimation": { x: 900, y: 2180, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Estimation": { x: 880, y: 2100, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Word Problems": { x: 1100, y: 2180, constellation: "Intermediate Arithmetic", state: "locked" },
                    // Right branch - Measurement & geometry prep
                    "Basic Measurement": { x: 1200, y: 2100, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Unit Conversion": { x: 1280, y: 2030, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Mass and Capacity": { x: 1350, y: 2100, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Elapsed Time": { x: 1300, y: 2180, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Perimeter": { x: 1380, y: 1960, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Area": { x: 1450, y: 1890, constellation: "Intermediate Arithmetic", state: "locked" },
                    // Far right - Number properties
                    "Factors and Multiples": { x: 1180, y: 1980, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Prime and Composite": { x: 1260, y: 1910, constellation: "Intermediate Arithmetic", state: "locked" },
                    // Data branch (left side)
                    "Bar Graphs": { x: 520, y: 2000, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Line Plots": { x: 450, y: 1930, constellation: "Intermediate Arithmetic", state: "locked" },
                    // Geometry prep (far right)
                    "Line Symmetry": { x: 1520, y: 1960, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Types of Angles": { x: 1580, y: 1890, constellation: "Intermediate Arithmetic", state: "locked" },
                    "Types of Lines": { x: 1640, y: 1820, constellation: "Intermediate Arithmetic", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // ADVANCED ARITHMETIC - "The Spiral" (Curved arrangement)
                    // Flows in a gentle spiral pattern, left-center placement
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Advanced Fractions": { x: 650, y: 1760, constellation: "Advanced Arithmetic", state: "locked" },
                    "GCF and LCM": { x: 580, y: 1700, constellation: "Advanced Arithmetic", state: "locked" },
                    "Decimals": { x: 750, y: 1680, constellation: "Advanced Arithmetic", state: "locked" },
                    "Powers of 10": { x: 680, y: 1620, constellation: "Advanced Arithmetic", state: "locked" },
                    "Scientific Notation": { x: 600, y: 1560, constellation: "Advanced Arithmetic", state: "locked" },
                    "Percentages": { x: 850, y: 1600, constellation: "Advanced Arithmetic", state: "locked" },
                    "Proportions": { x: 950, y: 1540, constellation: "Advanced Arithmetic", state: "locked" },
                    // Negative numbers branch
                    "Negatives": { x: 500, y: 1780, constellation: "Advanced Arithmetic", state: "locked" },
                    "Absolute Value": { x: 420, y: 1720, constellation: "Advanced Arithmetic", state: "locked" },
                    "Square Roots": { x: 480, y: 1640, constellation: "Advanced Arithmetic", state: "locked" },
                    // Data & Statistics branch
                    "Data Collection": { x: 350, y: 1700, constellation: "Advanced Arithmetic", state: "locked" },
                    "Mean Median Mode": { x: 280, y: 1620, constellation: "Advanced Arithmetic", state: "locked" },
                    "Simple Probability": { x: 220, y: 1540, constellation: "Advanced Arithmetic", state: "locked" },
                    "Comparing Distributions": { x: 160, y: 1460, constellation: "Advanced Arithmetic", state: "locked" },
                    // Geometry concepts (bridge to geometry)
                    "Nets of 3D Shapes": { x: 1620, y: 1680, constellation: "Advanced Arithmetic", state: "locked" },
                    // Algebra prep
                    "Expressions with Variables": { x: 780, y: 1520, constellation: "Advanced Arithmetic", state: "locked" },
                    "One-Step Equations": { x: 700, y: 1460, constellation: "Advanced Arithmetic", state: "locked" },
                    "Coordinate Plane": { x: 380, y: 1540, constellation: "Advanced Arithmetic", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // PRE-ALGEBRA - "The Gateway" (Arc shape bridging arithmetic to algebra)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Order of Operations": { x: 600, y: 1380, constellation: "Pre-Algebra", state: "locked" },
                    "Exponents": { x: 520, y: 1320, constellation: "Pre-Algebra", state: "locked" },
                    "Basic Algebraic Expressions": { x: 700, y: 1320, constellation: "Pre-Algebra", state: "locked" },
                    "Solving Simple Equations": { x: 800, y: 1260, constellation: "Pre-Algebra", state: "locked" },
                    "Ratio and Proportion": { x: 950, y: 1400, constellation: "Pre-Algebra", state: "locked" },
                    // Roots branch
                    "Irrational Numbers": { x: 440, y: 1260, constellation: "Pre-Algebra", state: "locked" },
                    "Cube Roots": { x: 360, y: 1200, constellation: "Pre-Algebra", state: "locked" },
                    // Data/Graphing branch (left)
                    "Basic Graphing": { x: 300, y: 1380, constellation: "Pre-Algebra", state: "locked" },
                    "Two-Way Tables": { x: 220, y: 1320, constellation: "Pre-Algebra", state: "locked" },
                    "Scatter Plots": { x: 280, y: 1260, constellation: "Pre-Algebra", state: "locked" },
                    "Box Plots": { x: 200, y: 1200, constellation: "Pre-Algebra", state: "locked" },
                    "Probability Basics": { x: 140, y: 1280, constellation: "Pre-Algebra", state: "locked" },
                    "Compound Probability": { x: 80, y: 1220, constellation: "Pre-Algebra", state: "locked" },
                    "Sampling Methods": { x: 60, y: 1160, constellation: "Pre-Algebra", state: "locked" },
                    // Geometry bridge (right side)
                    "Surface Area": { x: 1350, y: 1300, constellation: "Pre-Algebra", state: "locked" },
                    "Volume of Cylinders Cones Spheres": { x: 1420, y: 1230, constellation: "Pre-Algebra", state: "locked" },
                    "Similar Figures": { x: 1480, y: 1160, constellation: "Pre-Algebra", state: "locked" },
                    "Parallel Lines and Transversals": { x: 1550, y: 1090, constellation: "Pre-Algebra", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // GEOMETRY - "The Pentagon" (Pentagon-like arrangement on right)
                    // Forms a distinct geometric shape fitting the subject
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Basic Geometry Concepts": { x: 1650, y: 1150, constellation: "Geometry", state: "locked" },
                    "Angles and Lines": { x: 1720, y: 1080, constellation: "Geometry", state: "locked" },
                    "Transformations": { x: 1580, y: 1020, constellation: "Geometry", state: "locked" },
                    "Dilations": { x: 1500, y: 960, constellation: "Geometry", state: "locked" },
                    // Triangle cluster (upper right)
                    "Triangles and Pythagorean Theorem": { x: 1800, y: 950, constellation: "Geometry", state: "locked" },
                    "Triangle Inequality": { x: 1880, y: 880, constellation: "Geometry", state: "locked" },
                    "Triangle Centers": { x: 1950, y: 820, constellation: "Geometry", state: "locked" },
                    "Midsegments": { x: 1870, y: 760, constellation: "Geometry", state: "locked" },
                    // Angle tools cluster
                    "Angle Bisectors": { x: 1780, y: 1010, constellation: "Geometry", state: "locked" },
                    "Perpendicular Bisectors": { x: 1850, y: 1020, constellation: "Geometry", state: "locked" },
                    // Area/Perimeter branch
                    "Area and Perimeter": { x: 1650, y: 960, constellation: "Geometry", state: "locked" },
                    "Volume": { x: 1580, y: 890, constellation: "Geometry", state: "locked" },
                    // Similarity/Congruence chain
                    "Similarity": { x: 1700, y: 880, constellation: "Geometry", state: "locked" },
                    "Congruence": { x: 1760, y: 820, constellation: "Geometry", state: "locked" },
                    "Proofs": { x: 1700, y: 760, constellation: "Geometry", state: "locked" },
                    // Circle cluster (top right)
                    "Circles": { x: 1920, y: 720, constellation: "Geometry", state: "locked" },
                    "Inscribed Angles": { x: 1980, y: 660, constellation: "Geometry", state: "locked" },
                    "Arc Length": { x: 2040, y: 600, constellation: "Geometry", state: "locked" },
                    "Sector Area": { x: 2000, y: 540, constellation: "Geometry", state: "locked" },
                    "Tangent Lines": { x: 1940, y: 580, constellation: "Geometry", state: "locked" },
                    // Trig prep
                    "Law of Sines": { x: 1860, y: 650, constellation: "Geometry", state: "locked" },
                    "Law of Cosines": { x: 1800, y: 700, constellation: "Geometry", state: "locked" },
                    "Coordinate Geometry": { x: 1640, y: 700, constellation: "Geometry", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // ALGEBRA 1 - "The River" (Flowing S-curve in center)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Polynomials": { x: 600, y: 1180, constellation: "Algebra 1", state: "locked" },
                    "Factoring": { x: 520, y: 1120, constellation: "Algebra 1", state: "locked" },
                    "Radicals": { x: 440, y: 1060, constellation: "Algebra 1", state: "locked" },
                    "Quadratic Equations": { x: 520, y: 1000, constellation: "Algebra 1", state: "locked" },
                    // Linear equations branch
                    "Linear Equations": { x: 750, y: 1180, constellation: "Algebra 1", state: "locked" },
                    "Multi-Step Equations": { x: 680, y: 1120, constellation: "Algebra 1", state: "locked" },
                    "Literal Equations": { x: 760, y: 1060, constellation: "Algebra 1", state: "locked" },
                    "Absolute Value Equations": { x: 600, y: 940, constellation: "Algebra 1", state: "locked" },
                    // Inequalities branch
                    "Inequalities": { x: 850, y: 1100, constellation: "Algebra 1", state: "locked" },
                    "Graphing Linear Inequalities": { x: 920, y: 1040, constellation: "Algebra 1", state: "locked" },
                    // Systems cluster
                    "Systems by Graphing": { x: 850, y: 980, constellation: "Algebra 1", state: "locked" },
                    "Systems by Substitution": { x: 780, y: 920, constellation: "Algebra 1", state: "locked" },
                    "Systems by Elimination": { x: 850, y: 860, constellation: "Algebra 1", state: "locked" },
                    // Functions branch (right side)
                    "Basic Functions": { x: 1000, y: 1120, constellation: "Algebra 1", state: "locked" },
                    "Domain and Range": { x: 1080, y: 1060, constellation: "Algebra 1", state: "locked" },
                    "Exponential Functions": { x: 1150, y: 1000, constellation: "Algebra 1", state: "locked" },
                    "Compound Interest": { x: 1220, y: 940, constellation: "Algebra 1", state: "locked" },
                    // Sequences
                    "Arithmetic Sequences": { x: 1100, y: 920, constellation: "Algebra 1", state: "locked" },
                    "Geometric Sequences": { x: 1180, y: 860, constellation: "Algebra 1", state: "locked" },
                    // Data connection
                    "Correlation and Trend Lines": { x: 350, y: 1100, constellation: "Algebra 1", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // ALGEBRA 2 - "The Crown" (Arc above Algebra 1)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Complex Numbers": { x: 480, y: 880, constellation: "Algebra 2", state: "locked" },
                    "Completing the Square": { x: 400, y: 820, constellation: "Algebra 2", state: "locked" },
                    "Advanced Polynomials": { x: 560, y: 760, constellation: "Algebra 2", state: "locked" },
                    "Synthetic Division": { x: 480, y: 700, constellation: "Algebra 2", state: "locked" },
                    // Functions cluster (center)
                    "Exponential and Logarithmic Functions": { x: 700, y: 800, constellation: "Algebra 2", state: "locked" },
                    "Piecewise Functions": { x: 780, y: 740, constellation: "Algebra 2", state: "locked" },
                    "Rational Functions": { x: 860, y: 800, constellation: "Algebra 2", state: "locked" },
                    "Asymptotes": { x: 940, y: 740, constellation: "Algebra 2", state: "locked" },
                    // Series/Sequences (right)
                    "Sequence and Series": { x: 1020, y: 800, constellation: "Algebra 2", state: "locked" },
                    "Binomial Theorem": { x: 1100, y: 740, constellation: "Algebra 2", state: "locked" },
                    // Probability cluster (left)
                    "Permutations": { x: 320, y: 760, constellation: "Algebra 2", state: "locked" },
                    "Combinations": { x: 260, y: 700, constellation: "Algebra 2", state: "locked" },
                    "Expected Value": { x: 200, y: 640, constellation: "Algebra 2", state: "locked" },
                    // Matrix intro
                    "Matrices Intro": { x: 640, y: 680, constellation: "Algebra 2", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // PRE-CALCULUS - "The Wings" (Spread pattern, trigonometry focus)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Conic Sections": { x: 1000, y: 680, constellation: "Pre-Calculus", state: "locked" },
                    "Advanced Functions": { x: 1080, y: 620, constellation: "Pre-Calculus", state: "locked" },
                    "Parametric Equations": { x: 1160, y: 560, constellation: "Pre-Calculus", state: "locked" },
                    "Series Convergence": { x: 1180, y: 640, constellation: "Pre-Calculus", state: "locked" },
                    // Matrices branch (left)
                    "Matrices": { x: 720, y: 620, constellation: "Pre-Calculus", state: "locked" },
                    // Trig cluster (right wing)
                    "Trigonometry": { x: 1400, y: 600, constellation: "Pre-Calculus", state: "locked" },
                    "Radian Measure": { x: 1480, y: 540, constellation: "Pre-Calculus", state: "locked" },
                    "Unit Circle": { x: 1560, y: 480, constellation: "Pre-Calculus", state: "locked" },
                    "Trig Identities": { x: 1480, y: 420, constellation: "Pre-Calculus", state: "locked" },
                    "Graphing Trig Functions": { x: 1560, y: 360, constellation: "Pre-Calculus", state: "locked" },
                    "Inverse Trig": { x: 1400, y: 480, constellation: "Pre-Calculus", state: "locked" },
                    // Vectors branch
                    "Vectors": { x: 1300, y: 500, constellation: "Pre-Calculus", state: "locked" },
                    "Polar Coordinates": { x: 1360, y: 420, constellation: "Pre-Calculus", state: "locked" },
                    // Stats
                    "Normal Distribution": { x: 280, y: 580, constellation: "Pre-Calculus", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // CALCULUS - "The Apex" (Diamond converging to peak)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Limits": { x: 1000, y: 480, constellation: "Calculus", state: "locked" },
                    "Derivatives": { x: 1000, y: 380, constellation: "Calculus", state: "locked" },
                    // Derivative rules (spread)
                    "Chain Rule": { x: 1100, y: 340, constellation: "Calculus", state: "locked" },
                    "Product Rule": { x: 1160, y: 280, constellation: "Calculus", state: "locked" },
                    "Quotient Rule": { x: 1100, y: 220, constellation: "Calculus", state: "locked" },
                    "Implicit Differentiation": { x: 900, y: 340, constellation: "Calculus", state: "locked" },
                    "Related Rates": { x: 840, y: 280, constellation: "Calculus", state: "locked" },
                    "Applications": { x: 920, y: 220, constellation: "Calculus", state: "locked" },
                    // Integration branch
                    "Integrals": { x: 1000, y: 280, constellation: "Calculus", state: "locked" },
                    "U-Substitution": { x: 1060, y: 160, constellation: "Calculus", state: "locked" },
                    "Integration by Parts": { x: 940, y: 160, constellation: "Calculus", state: "locked" },
                    "Integration Techniques": { x: 1000, y: 100, constellation: "Calculus", state: "locked" },
                    // Advanced calc
                    "Differential Equations": { x: 860, y: 120, constellation: "Calculus", state: "locked" },
                    "Multivariable Calculus": { x: 1000, y: 20, constellation: "Calculus", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // ADVANCED MATHEMATICS - "The Nebula" (Clustered cloud, left side)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Partial Derivatives": { x: 900, y: -40, constellation: "Advanced Mathematics", state: "locked" },
                    "Double Integrals": { x: 1100, y: -40, constellation: "Advanced Mathematics", state: "locked" },
                    "Triple Integrals": { x: 1100, y: -120, constellation: "Advanced Mathematics", state: "locked" },
                    "Vector Calculus": { x: 1000, y: -100, constellation: "Advanced Mathematics", state: "locked" },
                    // Analysis cluster
                    "Real Analysis": { x: 700, y: 100, constellation: "Advanced Mathematics", state: "locked" },
                    "Complex Analysis": { x: 620, y: 40, constellation: "Advanced Mathematics", state: "locked" },
                    // Linear algebra cluster
                    "Linear Algebra": { x: 540, y: 180, constellation: "Advanced Mathematics", state: "locked" },
                    "Eigenvalues": { x: 460, y: 120, constellation: "Advanced Mathematics", state: "locked" },
                    "Series": { x: 780, y: 40, constellation: "Advanced Mathematics", state: "locked" },
                    // Stats connection
                    "Probability and Statistics": { x: 380, y: 280, constellation: "Advanced Mathematics", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // SPECIALIZED TOPICS - "The Distant Stars" (Far left cluster)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Abstract Algebra": { x: 300, y: 120, constellation: "Specialized Topics", state: "locked" },
                    "Number Theory": { x: 180, y: 180, constellation: "Specialized Topics", state: "locked" },
                    "Advanced Number Theory": { x: 100, y: 120, constellation: "Specialized Topics", state: "locked" },
                    "Discrete Mathematics": { x: 220, y: 60, constellation: "Specialized Topics", state: "locked" },
                    "Mathematical Logic": { x: 140, y: 0, constellation: "Specialized Topics", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // MASTERY AND RESEARCH - "The Summit" (Peak formation)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Applied Mathematics": { x: 760, y: -60, constellation: "Mastery and Research", state: "locked" },
                    "Theoretical Mathematics": { x: 540, y: -20, constellation: "Mastery and Research", state: "locked" },
                    "Mathematical Research Techniques": { x: 650, y: -120, constellation: "Mastery and Research", state: "locked" },
                    "Advanced Computational Methods": { x: 380, y: -60, constellation: "Mastery and Research", state: "locked" },

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // FINAL SPECIALIZATIONS - "The Crown Jewels" (Top of tree)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    "Differential Geometry": { x: 800, y: -180, constellation: "Final Specializations", state: "locked" },
                    "Topology": { x: 650, y: -200, constellation: "Final Specializations", state: "locked" },
                    "Advanced Statistics": { x: 500, y: -140, constellation: "Final Specializations", state: "locked" }
                };
        
                this.CONNECTIONS = [
                    // Basic Arithmetic connections
                    ["Counting and Number Recognition", "Place Value Understanding"],
                    ["Counting and Number Recognition", "Comparing Numbers"],
                    ["Counting and Number Recognition", "Skip Counting"],
                    ["Counting and Number Recognition", "Number Lines"],
                    ["Counting and Number Recognition", "Even and Odd"],
                    ["Comparing Numbers", "Ordering Numbers"],
                    ["Comparing Numbers", "Time Telling"],
                    ["Place Value Understanding", "Time Telling"],
                    ["Time Telling", "Money and Coins"],
                    ["Money and Coins", "Patterns and Sequences"],
                    ["Place Value Understanding", "Basic Addition"],
                    ["Place Value Understanding", "Basic Subtraction"],
                    // Additional Tier 1 connections
                    ["Counting and Number Recognition", "Teen Numbers"],
                    ["Counting and Number Recognition", "Number Bonds"],
                    ["Teen Numbers", "Place Value Understanding"],
                    ["Number Bonds", "Basic Addition"],
                    ["Number Bonds", "Basic Subtraction"],
                    ["Skip Counting", "Picture Graphs"],
                    ["Basic Geometry Concepts", "3D Shapes"],
                    ["Basic Geometry Concepts", "Partitioning Shapes"],
                    ["Partitioning Shapes", "Composing Shapes"],
                    ["Comparing Numbers", "Comparing Lengths"],
                    ["Comparing Lengths", "Positional Words"],
                    ["Positional Words", "Classifying Objects"],

                    // Intermediate Arithmetic connections
                    ["Basic Addition", "Multi-Digit Addition"],
                    ["Basic Subtraction", "Multi-Digit Subtraction"],
                    ["Multi-Digit Addition", "Multiplication"],
                    ["Multi-Digit Subtraction", "Multiplication"],
                    ["Basic Addition", "Multiplication"],
                    ["Basic Subtraction", "Multiplication"],
                    ["Multiplication", "Division"],
                    ["Multiplication", "Arrays and Area Models"],
                    ["Division", "Long Division"],
                    ["Multiplication", "Basic Fractions"],
                    ["Multiplication", "Rounding and Estimation"],
                    ["Rounding and Estimation", "Estimation"],
                    ["Division", "Basic Fractions"],
                    ["Basic Fractions", "Equivalent Fractions"],
                    ["Equivalent Fractions", "Mixed Numbers"],
                    ["Basic Geometry Concepts", "Basic Measurement"],
                    ["Basic Measurement", "Unit Conversion"],
                    ["Basic Measurement", "Perimeter"],
                    // Additional Tier 2 connections
                    ["Basic Fractions", "Fraction Operations"],
                    ["Equivalent Fractions", "Simplifying Fractions"],
                    ["Fraction Operations", "Fraction Word Problems"],
                    ["Division", "Word Problems"],
                    ["Multiplication", "Factors and Multiples"],
                    ["Factors and Multiples", "Prime and Composite"],
                    ["Data Collection", "Bar Graphs"],
                    ["Bar Graphs", "Line Plots"],
                    ["Basic Geometry Concepts", "Line Symmetry"],
                    ["Angles and Lines", "Types of Angles"],
                    ["Types of Angles", "Types of Lines"],
                    ["Basic Measurement", "Mass and Capacity"],
                    ["Time Telling", "Elapsed Time"],
                    ["Multiplication", "Multiplication Properties"],
                    ["Perimeter", "Area"],

                    // Advanced Arithmetic connections
                    ["Basic Subtraction", "Negatives"],
                    ["Negatives", "Absolute Value"],
                    ["Basic Fractions", "Advanced Fractions"],
                    ["Basic Fractions", "Basic Geometry Concepts"],
                    ["Advanced Fractions", "Decimals"],
                    ["Decimals", "Percentages"],
                    ["Decimals", "Scientific Notation"],
                    ["Percentages", "Proportions"],
                    ["Advanced Fractions", "Square Roots"],
                    ["Basic Graphing", "Data Collection"],
                    ["Data Collection", "Mean Median Mode"],
                    ["Mean Median Mode", "Probability and Statistics"],
                    // Additional Tier 3 connections
                    ["Factors and Multiples", "GCF and LCM"],
                    ["Place Value Understanding", "Powers of 10"],
                    ["Basic Graphing", "Coordinate Plane"],
                    ["Basic Algebraic Expressions", "Expressions with Variables"],
                    ["Solving Simple Equations", "One-Step Equations"],
                    ["Probability Basics", "Simple Probability"],
                    ["Mean Median Mode", "Comparing Distributions"],
                    ["3D Shapes", "Nets of 3D Shapes"],
                    // Additional forward connections for leaf nodes
                    ["Long Division", "Basic Fractions"],
                    ["Unit Conversion", "Proportions"],
                    ["Proportions", "Ratio and Proportion"],
                    ["Coordinate Plane", "Coordinate Geometry"],
                    ["Ratio and Proportion", "Proportions"],
                    ["GCF and LCM", "Simplifying Fractions"],
                    ["Powers of 10", "Scientific Notation"],
                    ["One-Step Equations", "Multi-Step Equations"],
                    ["Expressions with Variables", "Basic Algebraic Expressions"],
                    ["Simple Probability", "Compound Probability"],
                    ["Mixed Numbers", "Fraction Operations"],
                    ["Line Plots", "Mean Median Mode"],
                    ["Types of Lines", "Parallel Lines and Transversals"],
                    ["Area", "Area and Perimeter"],
                    ["Prime and Composite", "GCF and LCM"],
                    ["Fraction Word Problems", "Word Problems"],
                    ["Simplifying Fractions", "Fraction Operations"],

                    // Pre-Algebra connections
                    ["Percentages", "Basic Algebraic Expressions"],
                    ["Percentages", "Ratio and Proportion"],
                    ["Percentages", "Basic Graphing"],
                    ["Square Roots", "Order of Operations"],
                    ["Basic Algebraic Expressions", "Order of Operations"],
                    ["Basic Algebraic Expressions", "Solving Simple Equations"],
                    ["Basic Graphing", "Two-Way Tables"],
                    ["Basic Graphing", "Scatter Plots"],
                    ["Scatter Plots", "Box Plots"],
                    ["Data Collection", "Probability Basics"],
                    ["Volume", "Surface Area"],
                    // Additional Tier 4 connections
                    ["Order of Operations", "Exponents"],
                    ["Square Roots", "Irrational Numbers"],
                    ["Square Roots", "Cube Roots"],
                    ["Probability Basics", "Compound Probability"],
                    ["Data Collection", "Sampling Methods"],
                    ["Similarity", "Similar Figures"],
                    ["Angles and Lines", "Parallel Lines and Transversals"],
                    ["Volume", "Volume of Cylinders Cones Spheres"],
                    // Additional forward connections
                    ["Exponents", "Exponential Functions"],
                    ["Irrational Numbers", "Radicals"],
                    ["Cube Roots", "Radicals"],
                    ["Sampling Methods", "Probability and Statistics"],
                    ["Similar Figures", "Dilations"],
                    ["Parallel Lines and Transversals", "Proofs"],
                    ["Volume of Cylinders Cones Spheres", "Surface Area"],
                    ["Surface Area", "Volume"],
                    ["Compound Probability", "Permutations"],

                    // Geometry connections
                    ["Basic Geometry Concepts", "Angles and Lines"],
                    ["Basic Geometry Concepts", "Transformations"],
                    ["Angles and Lines", "Triangles and Pythagorean Theorem"],
                    ["Triangles and Pythagorean Theorem", "Circles"],
                    ["Angles and Lines", "Area and Perimeter"],
                    ["Area and Perimeter", "Volume"],
                    ["Triangles and Pythagorean Theorem", "Similarity"],
                    ["Similarity", "Congruence"],
                    ["Congruence", "Proofs"],
                    ["Triangles and Pythagorean Theorem", "Law of Sines"],
                    ["Triangles and Pythagorean Theorem", "Law of Cosines"],
                    ["Angles and Lines", "Coordinate Geometry"],
                    // Additional Tier 6 Geometry connections
                    ["Angles and Lines", "Angle Bisectors"],
                    ["Angles and Lines", "Perpendicular Bisectors"],
                    ["Triangles and Pythagorean Theorem", "Triangle Inequality"],
                    ["Triangles and Pythagorean Theorem", "Triangle Centers"],
                    ["Triangles and Pythagorean Theorem", "Midsegments"],
                    ["Circles", "Inscribed Angles"],
                    ["Circles", "Arc Length"],
                    ["Circles", "Sector Area"],
                    ["Circles", "Tangent Lines"],
                    ["Transformations", "Dilations"],
                    // Additional Geometry forward connections
                    ["Angle Bisectors", "Triangle Centers"],
                    ["Perpendicular Bisectors", "Triangle Centers"],
                    ["Triangle Inequality", "Proofs"],
                    ["Midsegments", "Similarity"],
                    ["Inscribed Angles", "Arc Length"],
                    ["Arc Length", "Sector Area"],
                    ["Tangent Lines", "Conic Sections"],
                    ["Coordinate Geometry", "Conic Sections"],
                    ["Law of Sines", "Trigonometry"],
                    ["Law of Cosines", "Trigonometry"],
                    ["Proofs", "Mathematical Logic"],

                    // Algebra 1 connections
                    ["Solving Simple Equations", "Polynomials"],
                    ["Solving Simple Equations", "Linear Equations"],
                    ["Square Roots", "Radicals"],
                    ["Linear Equations", "Inequalities"],
                    ["Linear Equations", "Basic Functions"],
                    ["Polynomials", "Factoring"],
                    ["Factoring", "Quadratic Equations"],
                    ["Basic Functions", "Domain and Range"],
                    ["Basic Functions", "Exponential Functions"],
                    ["Basic Functions", "Arithmetic Sequences"],
                    ["Arithmetic Sequences", "Geometric Sequences"],
                    ["Exponential Functions", "Compound Interest"],
                    // Additional Tier 5 Algebra 1 connections
                    ["Linear Equations", "Multi-Step Equations"],
                    ["Solving Simple Equations", "Literal Equations"],
                    ["Absolute Value", "Absolute Value Equations"],
                    ["Inequalities", "Graphing Linear Inequalities"],
                    ["Linear Equations", "Systems by Graphing"],
                    ["Linear Equations", "Systems by Substitution"],
                    ["Linear Equations", "Systems by Elimination"],
                    ["Scatter Plots", "Correlation and Trend Lines"],
                    // Additional Algebra 1 forward connections
                    ["Multi-Step Equations", "Literal Equations"],
                    ["Literal Equations", "Systems by Substitution"],
                    ["Absolute Value Equations", "Piecewise Functions"],
                    ["Graphing Linear Inequalities", "Systems by Graphing"],
                    ["Systems by Graphing", "Conic Sections"],
                    ["Systems by Substitution", "Systems by Elimination"],
                    ["Systems by Elimination", "Matrices"],
                    ["Correlation and Trend Lines", "Probability and Statistics"],
                    ["Geometric Sequences", "Sequence and Series"],
                    ["Domain and Range", "Rational Functions"],
                    ["Compound Interest", "Exponential and Logarithmic Functions"],
                    ["Radicals", "Complex Numbers"],

                    // Algebra 2 connections
                    ["Quadratic Equations", "Complex Numbers"],
                    ["Quadratic Equations", "Completing the Square"],
                    ["Factoring", "Advanced Polynomials"],
                    ["Basic Functions", "Exponential and Logarithmic Functions"],
                    ["Basic Functions", "Rational Functions"],
                    ["Basic Functions", "Piecewise Functions"],
                    ["Rational Functions", "Asymptotes"],
                    ["Basic Functions", "Sequence and Series"],
                    ["Probability Basics", "Permutations"],
                    ["Permutations", "Combinations"],
                    ["Probability and Statistics", "Expected Value"],
                    // Additional Tier 7 Algebra 2 connections
                    ["Advanced Polynomials", "Synthetic Division"],
                    ["Sequence and Series", "Binomial Theorem"],
                    ["Matrices", "Matrices Intro"],
                    // Additional Algebra 2 forward connections
                    ["Completing the Square", "Conic Sections"],
                    ["Piecewise Functions", "Advanced Functions"],
                    ["Asymptotes", "Limits"],
                    ["Combinations", "Binomial Theorem"],
                    ["Expected Value", "Normal Distribution"],
                    ["Synthetic Division", "Rational Functions"],
                    ["Binomial Theorem", "Series"],
                    ["Matrices Intro", "Matrices"],

                    // Pre-Calculus connections
                    ["Exponential and Logarithmic Functions", "Conic Sections"],
                    ["Triangles and Pythagorean Theorem", "Trigonometry"],
                    ["Trigonometry", "Radian Measure"],
                    ["Trigonometry", "Inverse Trig"],
                    ["Complex Numbers", "Matrices"],
                    ["Advanced Polynomials", "Advanced Functions"],
                    ["Advanced Functions", "Parametric Equations"],
                    ["Trigonometry", "Vectors"],
                    ["Vectors", "Polar Coordinates"],
                    ["Probability and Statistics", "Normal Distribution"],
                    // Additional Tier 8 Pre-Calculus connections
                    ["Trigonometry", "Unit Circle"],
                    ["Trigonometry", "Trig Identities"],
                    ["Trigonometry", "Graphing Trig Functions"],
                    ["Sequence and Series", "Series Convergence"],
                    // Additional Pre-Calculus forward connections
                    ["Unit Circle", "Trig Identities"],
                    ["Trig Identities", "Inverse Trig"],
                    ["Graphing Trig Functions", "Limits"],
                    ["Series Convergence", "Series"],
                    ["Radian Measure", "Unit Circle"],
                    ["Inverse Trig", "Derivatives"],
                    ["Parametric Equations", "Vector Calculus"],
                    ["Polar Coordinates", "Double Integrals"],
                    ["Normal Distribution", "Advanced Statistics"],
                    ["Conic Sections", "Multivariable Calculus"],

                    // Calculus connections
                    ["Advanced Functions", "Limits"],
                    ["Matrices", "Limits"],
                    ["Vectors", "Limits"],
                    ["Limits", "Derivatives"],
                    ["Derivatives", "Chain Rule"],
                    ["Derivatives", "Product Rule"],
                    ["Derivatives", "Integrals"],
                    ["Integrals", "Integration Techniques"],
                    ["Integrals", "Multivariable Calculus"],
                    ["Integrals", "Differential Equations"],
                    // Additional Tier 9 Calculus connections
                    ["Derivatives", "Quotient Rule"],
                    ["Derivatives", "Implicit Differentiation"],
                    ["Derivatives", "Related Rates"],
                    ["Derivatives", "Applications"],
                    ["Integrals", "U-Substitution"],
                    ["Integrals", "Integration by Parts"],
                    // Additional Calculus forward connections
                    ["Chain Rule", "Implicit Differentiation"],
                    ["Product Rule", "Integration by Parts"],
                    ["Quotient Rule", "Rational Functions"],
                    ["Implicit Differentiation", "Related Rates"],
                    ["Related Rates", "Applications"],
                    ["Applications", "Applied Mathematics"],
                    ["U-Substitution", "Integration Techniques"],
                    ["Integration by Parts", "Integration Techniques"],
                    ["Integration Techniques", "Differential Equations"],

                    // Advanced Mathematics connections
                    ["Basic Graphing", "Probability and Statistics"],
                    ["Matrices", "Linear Algebra"],
                    ["Integrals", "Real Analysis"],
                    ["Real Analysis", "Complex Analysis"],
                    // Additional Tier 10 connections
                    ["Multivariable Calculus", "Partial Derivatives"],
                    ["Sequence and Series", "Series"],
                    ["Linear Algebra", "Eigenvalues"],
                    ["Multivariable Calculus", "Double Integrals"],
                    ["Double Integrals", "Triple Integrals"],
                    ["Multivariable Calculus", "Vector Calculus"],

                    // Specialized Topics connections
                    ["Advanced Polynomials", "Abstract Algebra"],
                    ["Advanced Fractions", "Number Theory"],
                    ["Basic Graphing", "Discrete Mathematics"],
                    ["Number Theory", "Advanced Number Theory"],
                    ["Discrete Mathematics", "Mathematical Logic"],

                    // Mastery connections
                    ["Differential Equations", "Applied Mathematics"],
                    ["Abstract Algebra", "Theoretical Mathematics"],
                    ["Real Analysis", "Theoretical Mathematics"],
                    ["Complex Analysis", "Theoretical Mathematics"],
                    ["Discrete Mathematics", "Advanced Computational Methods"],
                    ["Probability and Statistics", "Advanced Computational Methods"],
                    ["Applied Mathematics", "Mathematical Research Techniques"],
                    ["Theoretical Mathematics", "Mathematical Research Techniques"],
                    ["Advanced Computational Methods", "Mathematical Research Techniques"],
                    ["Mathematical Research Techniques", "Differential Geometry"],
                    ["Theoretical Mathematics", "Topology"],
                    ["Advanced Computational Methods", "Advanced Statistics"]
                ];
        
                this.CONSTELLATION_COLORS = {
                    "Basic Arithmetic": "#ffd700",
                    "Intermediate Arithmetic": "#87ceeb", 
                    "Advanced Arithmetic": "#dda0dd",
                    "Pre-Algebra": "#98fb98",
                    "Geometry": "#ffa07a",
                    "Algebra 1": "#20b2aa",
                    "Algebra 2": "#ff6347",
                    "Pre-Calculus": "#daa520",
                    "Calculus": "#f0e68c",
                    "Advanced Mathematics": "#9370db",
                    "Specialized Topics": "#32cd32",
                    "Mastery and Research": "#ff69b4",
                    "Final Specializations": "#00ced1"
                };
        
                this.CONSTELLATION_POSITIONS = {
                    "Basic Arithmetic": { x: 1100, y: 2640 },
                    "Intermediate Arithmetic": { x: 1000, y: 2060 },
                    "Advanced Arithmetic": { x: 600, y: 1620 },
                    "Pre-Algebra": { x: 580, y: 1260 },
                    "Geometry": { x: 1800, y: 840 },
                    "Algebra 1": { x: 760, y: 1020 },
                    "Algebra 2": { x: 560, y: 760 },
                    "Pre-Calculus": { x: 1200, y: 540 },
                    "Calculus": { x: 1000, y: 240 },
                    "Advanced Mathematics": { x: 760, y: 50 },
                    "Specialized Topics": { x: 190, y: 100 },
                    "Mastery and Research": { x: 580, y: -60 },
                    "Final Specializations": { x: 650, y: -170 }
                };
            }
        
            loadScienceData() {
                this.SKILL_TREE = {
                    "Scientific Method": { x: 1200, y: 900, type: "root", constellation: "Core Science", state: "locked" },
                    "Observation Skills": { x: 1162, y: 763, constellation: "Scientific Thinking", state: "locked" },
                    "Hypothesis Formation": { x: 1087, y: 639, constellation: "Scientific Thinking", state: "locked" },
                    "Data Collection": { x: 1266, y: 684, constellation: "Scientific Thinking", state: "locked" },
                    "Basic Chemistry": { x: 887, y: 939, constellation: "Physical Science", state: "locked" },
                    "States of Matter": { x: 778, y: 852, constellation: "Physical Science", state: "locked" },
                    "Chemical Reactions": { x: 967, y: 758, constellation: "Physical Science", state: "locked" },
                    "Atoms and Molecules": { x: 721, y: 701, constellation: "Physical Science", state: "locked" },
                    "Forces and Motion": { x: 1566, y: 684, constellation: "Physics", state: "locked" },
                    "Energy Types": { x: 1692, y: 651, constellation: "Physics", state: "locked" },
                    "Simple Machines": { x: 1518, y: 779, constellation: "Physics", state: "locked" },
                    "Magnetism": { x: 1659, y: 818, constellation: "Physics", state: "locked" },
                    "Plant Biology": { x: 1260, y: 1128, constellation: "Life Science", state: "locked" },
                    "Animal Biology": { x: 1306, y: 1244, constellation: "Life Science", state: "locked" },
                    "Ecosystems": { x: 1448, y: 1307, constellation: "Life Science", state: "locked" },
                    "Human Body": { x: 1211, y: 1415, constellation: "Life Science", state: "locked" },
                    "Weather Patterns": { x: 862, y: 616, constellation: "Earth Science", state: "locked" },
                    "Rock Cycle": { x: 713, y: 590, constellation: "Earth Science", state: "locked" },
                    "Solar System": { x: 766, y: 452, constellation: "Earth Science", state: "locked" },
                    "Climate Change": { x: 603, y: 545, constellation: "Earth Science", state: "locked" }
                };

                this.CONNECTIONS = [
                    ["Scientific Method", "Observation Skills"],
                    ["Scientific Method", "Basic Chemistry"],
                    ["Scientific Method", "Forces and Motion"],
                    ["Scientific Method", "Plant Biology"],
                    ["Scientific Method", "Weather Patterns"],
                    ["Observation Skills", "Hypothesis Formation"],
                    ["Observation Skills", "Data Collection"],
                    ["Basic Chemistry", "States of Matter"],
                    ["States of Matter", "Chemical Reactions"],
                    ["Chemical Reactions", "Atoms and Molecules"],
                    ["Forces and Motion", "Energy Types"],
                    ["Energy Types", "Simple Machines"],
                    ["Simple Machines", "Magnetism"],
                    ["Plant Biology", "Animal Biology"],
                    ["Animal Biology", "Ecosystems"],
                    ["Ecosystems", "Human Body"],
                    ["Weather Patterns", "Rock Cycle"],
                    ["Rock Cycle", "Solar System"],
                    ["Solar System", "Climate Change"]
                ];

                this.CONSTELLATION_COLORS = {
                    "Core Science": "#ffd700",
                    "Scientific Thinking": "#87ceeb",
                    "Physical Science": "#dda0dd",
                    "Physics": "#98fb98",
                    "Life Science": "#ffa07a",
                    "Earth Science": "#20b2aa"
                };

                this.CONSTELLATION_POSITIONS = {
                    "Scientific Thinking": { x: 1177, y: 655 },
                    "Physical Science": { x: 865, y: 838 },
                    "Physics": { x: 1588, y: 752 },
                    "Life Science": { x: 1285, y: 1279 },
                    "Earth Science": { x: 726, y: 484 }
                };
            }

            loadReadingData() {
                this.SKILL_TREE = {
                    "Letter Recognition": { x: 1200, y: 1500, type: "root", constellation: "Reading Foundations", state: "locked" },
                    "Phonics": { x: 1162, y: 1363, constellation: "Reading Foundations", state: "locked" },
                    "Sight Words": { x: 1087, y: 1239, constellation: "Reading Foundations", state: "locked" },
                    "Decoding": { x: 1266, y: 1284, constellation: "Reading Foundations", state: "locked" },
                    "Fluency": { x: 1200, y: 1100, constellation: "Reading Skills", state: "locked" },
                    "Vocabulary": { x: 1087, y: 939, constellation: "Reading Skills", state: "locked" },
                    "Reading Comprehension": { x: 1300, y: 800, constellation: "Reading Skills", state: "locked" },
                    "Main Ideas": { x: 1162, y: 663, constellation: "Comprehension", state: "locked" },
                    "Supporting Details": { x: 1087, y: 539, constellation: "Comprehension", state: "locked" },
                    "Inferences": { x: 1366, y: 584, constellation: "Comprehension", state: "locked" },
                    "Cause and Effect": { x: 1266, y: 484, constellation: "Comprehension", state: "locked" },
                    "Fiction Elements": { x: 887, y: 739, constellation: "Literary Analysis", state: "locked" },
                    "Character Analysis": { x: 778, y: 652, constellation: "Literary Analysis", state: "locked" },
                    "Plot Structure": { x: 967, y: 558, constellation: "Literary Analysis", state: "locked" },
                    "Theme": { x: 821, y: 501, constellation: "Literary Analysis", state: "locked" },
                    "Poetry Analysis": { x: 1566, y: 284, constellation: "Advanced Reading", state: "locked" },
                    "Text Features": { x: 1692, y: 351, constellation: "Advanced Reading", state: "locked" },
                    "Research Skills": { x: 1518, y: 179, constellation: "Advanced Reading", state: "locked" },
                    "Critical Thinking": { x: 1659, y: 118, constellation: "Advanced Reading", state: "locked" }
                };

                this.CONNECTIONS = [
                    ["Letter Recognition", "Phonics"],
                    ["Letter Recognition", "Sight Words"],
                    ["Phonics", "Decoding"],
                    ["Sight Words", "Decoding"],
                    ["Decoding", "Fluency"],
                    ["Fluency", "Vocabulary"],
                    ["Vocabulary", "Reading Comprehension"],
                    ["Reading Comprehension", "Main Ideas"],
                    ["Main Ideas", "Supporting Details"],
                    ["Main Ideas", "Inferences"],
                    ["Supporting Details", "Cause and Effect"],
                    ["Inferences", "Cause and Effect"],
                    ["Reading Comprehension", "Fiction Elements"],
                    ["Fiction Elements", "Character Analysis"],
                    ["Character Analysis", "Plot Structure"],
                    ["Plot Structure", "Theme"],
                    ["Cause and Effect", "Poetry Analysis"],
                    ["Inferences", "Text Features"],
                    ["Poetry Analysis", "Research Skills"],
                    ["Text Features", "Critical Thinking"]
                ];

                this.CONSTELLATION_COLORS = {
                    "Reading Foundations": "#ffd700",
                    "Reading Skills": "#87ceeb",
                    "Comprehension": "#dda0dd",
                    "Literary Analysis": "#98fb98",
                    "Advanced Reading": "#ffa07a"
                };

                this.CONSTELLATION_POSITIONS = {
                    "Reading Foundations": { x: 1177, y: 1355 },
                    "Reading Skills": { x: 1200, y: 950 },
                    "Comprehension": { x: 1266, y: 555 },
                    "Literary Analysis": { x: 865, y: 638 },
                    "Advanced Reading": { x: 1588, y: 252 }
                };
            }

            loadProgrammingData() {
                // Comprehensive Programming skill tree
                this.SKILL_TREE = {
                    "Introduction to Operating Systems": { x: 1033, y: 3290, type: "root", constellation: "Core Foundations", state: "locked" },
                    "Basic Computer Operations": { x: 1307, y: 3444, type: "root", constellation: "Core Foundations", state: "locked" },
                    "Basic Arithmetic": { x: 1547, y: 3387, type: "root", constellation: "Core Foundations", state: "locked" },
                    "Basic Software Tools": { x: 797, y: 2899, constellation: "Basic Programming", state: "locked" },
                    "Programming/Basic Theory": { x: 1426, y: 2948, constellation: "Basic Programming", state: "locked" },
                    "Text Manipulation": { x: 1545, y: 2888, constellation: "Basic Programming", state: "locked" },
                    "Basic Database Concepts": { x: 1046, y: 2577, constellation: "Intermediate Programming", state: "locked" },
                    "Markup Languages": { x: 1136, y: 2510, constellation: "Intermediate Programming", state: "locked" },
                    "Object Oriented Programming": { x: 1489, y: 2721, constellation: "Intermediate Programming", state: "locked" },
                    "Computer Science Algebra": { x: 1650, y: 2600, constellation: "Intermediate Programming", state: "locked" },
                    "Introduction to Hardware": { x: 779, y: 2362, constellation: "Intermediate Development", state: "locked" },
                    "Intro Computer Science": { x: 1115, y: 2169, constellation: "Intermediate Development", state: "locked" },
                    "Basic Concepts": { x: 1445, y: 2340, constellation: "Intermediate Development", state: "locked" },
                    "Console UI Fundamentals": { x: 1591, y: 2378, constellation: "Intermediate Development", state: "locked" },
                    "Advanced Debugging Techniques": { x: 740, y: 1936, constellation: "Advanced Development", state: "locked" },
                    "Assembly Language Programming": { x: 900, y: 2000, constellation: "Advanced Development", state: "locked" },
                    "SQL": { x: 1412, y: 1856, constellation: "Advanced Development", state: "locked" },
                    "Web to Desktop Design": { x: 1219, y: 1965, constellation: "Advanced Development", state: "locked" },
                    "HTML CSS": { x: 1976, y: 1838, constellation: "Advanced Development", state: "locked" },
                    "JavaScript/jQuery": { x: 2273, y: 2024, constellation: "Advanced Development", state: "locked" },
                    "Event Driven Programming": { x: 1626, y: 2068, constellation: "Advanced Development", state: "locked" },
                    "HTML CSS Concepts": { x: 2485, y: 1656, constellation: "Web Development", state: "locked" },
                    "Basic HTML Design": { x: 2689, y: 1408, constellation: "Web Development", state: "locked" },
                    "HTML to Web Fundamentals": { x: 2487, y: 1184, constellation: "Web Development", state: "locked" },
                    "Building Responsive Websites": { x: 2140, y: 1200, constellation: "Web Development", state: "locked" },
                    "Building Interactive Websites": { x: 2244, y: 1411, constellation: "Web Development", state: "locked" },
                    "Systems and Application Programming": { x: 580, y: 1415, constellation: "Systems Programming", state: "locked" },
                    "Operating System Fundamentals": { x: 468, y: 1344, constellation: "Systems Programming", state: "locked" },
                    "Cybersecurity Pathways": { x: 430, y: 1202, constellation: "Systems Programming", state: "locked" },
                    "Advanced Systems Programming": { x: 642, y: 1195, constellation: "Systems Programming", state: "locked" },
                    "Systems and Application Automation": { x: 316, y: 1040, constellation: "Systems Programming", state: "locked" },
                    "Industrial Automation": { x: 479, y: 945, constellation: "Systems Programming", state: "locked" },
                    "Software Engineering": { x: 875, y: 1531, constellation: "Software Engineering", state: "locked" },
                    "Advanced Software Development": { x: 1036, y: 1419, constellation: "Software Engineering", state: "locked" },
                    "Building Scalable Applications": { x: 760, y: 1245, constellation: "Software Engineering", state: "locked" },
                    "Software Architecture": { x: 1050, y: 1168, constellation: "Software Engineering", state: "locked" },
                    "Application Security": { x: 890, y: 946, constellation: "Software Engineering", state: "locked" },
                    "Modern Software Practices": { x: 872, y: 1116, constellation: "Software Engineering", state: "locked" },
                    "Front-End Development": { x: 1245, y: 1559, constellation: "Full Stack Development", state: "locked" },
                    "Back-End Development": { x: 1418, y: 1372, constellation: "Full Stack Development", state: "locked" },
                    "Full-Stack Development": { x: 1179, y: 1192, constellation: "Full Stack Development", state: "locked" },
                    "Web Development Pathways": { x: 1188, y: 958, constellation: "Full Stack Development", state: "locked" },
                    "Cloud Computing and DevOps": { x: 1292, y: 872, constellation: "Full Stack Development", state: "locked" },
                    "Advanced Cloud Development": { x: 1404, y: 913, constellation: "Full Stack Development", state: "locked" },
                    "Intro to Game Programming": { x: 1811, y: 1663, constellation: "Game Development", state: "locked" },
                    "Service Oriented Architecture": { x: 2049, y: 1619, constellation: "Game Development", state: "locked" },
                    "Advanced Game Programming": { x: 1802, y: 1358, constellation: "Game Development", state: "locked" },
                    "Game Engine Development": { x: 2105, y: 1084, constellation: "Game Development", state: "locked" },
                    "Mobile App Development": { x: 1893, y: 937, constellation: "Game Development", state: "locked" },
                    "Game Design Principles": { x: 1632, y: 778, constellation: "Game Development", state: "locked" },
                    "Data Science and Machine Learning": { x: 1597, y: 1739, constellation: "Data Science", state: "locked" },
                    "Statistical Analysis": { x: 1505, y: 1572, constellation: "Data Science", state: "locked" },
                    "Machine Learning Algorithms": { x: 1712, y: 1697, constellation: "Data Science", state: "locked" },
                    "Deep Learning": { x: 1589, y: 1264, constellation: "Data Science", state: "locked" },
                    "AI Development": { x: 1722, y: 1112, constellation: "Data Science", state: "locked" },
                    "Advanced Machine Learning": { x: 1812, y: 639, constellation: "Data Science", state: "locked" }
                };

                this.CONNECTIONS = [
                    // From Core Foundations to Basic Programming
                    ["Introduction to Operating Systems", "Basic Software Tools"],
                    ["Basic Computer Operations", "Programming/Basic Theory"],
                    ["Basic Arithmetic", "Programming/Basic Theory"],
                    ["Basic Arithmetic", "Text Manipulation"],
                    
                    // From Basic Programming to Intermediate Programming
                    ["Basic Software Tools", "Basic Database Concepts"],
                    ["Programming/Basic Theory", "Markup Languages"],
                    ["Programming/Basic Theory", "Object Oriented Programming"],
                    ["Text Manipulation", "Computer Science Algebra"],
                    
                    // From Intermediate Programming to Intermediate Development
                    ["Basic Database Concepts", "Introduction to Hardware"],
                    ["Markup Languages", "Intro Computer Science"],
                    ["Object Oriented Programming", "Basic Concepts"],
                    ["Computer Science Algebra", "Console UI Fundamentals"],
                    
                    // From Intermediate Development to Advanced Development
                    ["Introduction to Hardware", "Advanced Debugging Techniques"],
                    ["Intro Computer Science", "Assembly Language Programming"],
                    ["Basic Concepts", "SQL"],
                    ["Basic Concepts", "Web to Desktop Design"],
                    ["Console UI Fundamentals", "HTML CSS"],
                    ["Console UI Fundamentals", "JavaScript/jQuery"],
                    ["Console UI Fundamentals", "Event Driven Programming"],
                    
                    // Web Development specialization track
                    ["HTML CSS", "HTML CSS Concepts"],
                    ["JavaScript/jQuery", "HTML CSS Concepts"],
                    ["HTML CSS Concepts", "Basic HTML Design"],
                    ["Basic HTML Design", "HTML to Web Fundamentals"],
                    ["HTML to Web Fundamentals", "Building Responsive Websites"],
                    ["Building Responsive Websites", "Building Interactive Websites"],
                    
                    // Systems Programming specialization track
                    ["Advanced Debugging Techniques", "Systems and Application Programming"],
                    ["Systems and Application Programming", "Operating System Fundamentals"],
                    ["Operating System Fundamentals", "Cybersecurity Pathways"],
                    ["Cybersecurity Pathways", "Advanced Systems Programming"],
                    ["Advanced Systems Programming", "Systems and Application Automation"],
                    ["Systems and Application Automation", "Industrial Automation"],
                    
                    // Software Engineering specialization track
                    ["Assembly Language Programming", "Software Engineering"],
                    ["Software Engineering", "Advanced Software Development"],
                    ["Advanced Software Development", "Building Scalable Applications"],
                    ["Building Scalable Applications", "Software Architecture"],
                    ["Software Architecture", "Application Security"],
                    ["Application Security", "Modern Software Practices"],
                    
                    // Full Stack Development specialization track
                    ["Web to Desktop Design", "Front-End Development"],
                    ["SQL", "Back-End Development"],
                    ["Front-End Development", "Full-Stack Development"],
                    ["Back-End Development", "Full-Stack Development"],
                    ["Full-Stack Development", "Web Development Pathways"],
                    ["Web Development Pathways", "Cloud Computing and DevOps"],
                    ["Cloud Computing and DevOps", "Advanced Cloud Development"],
                    
                    // Game Development specialization track
                    ["Event Driven Programming", "Intro to Game Programming"],
                    ["Intro to Game Programming", "Service Oriented Architecture"],
                    ["Service Oriented Architecture", "Advanced Game Programming"],
                    ["Advanced Game Programming", "Game Engine Development"],
                    ["Game Engine Development", "Mobile App Development"],
                    ["Mobile App Development", "Game Design Principles"],
                    
                    // Data Science specialization track
                    ["SQL", "Data Science and Machine Learning"],
                    ["Data Science and Machine Learning", "Statistical Analysis"],
                    ["Statistical Analysis", "Machine Learning Algorithms"],
                    ["Machine Learning Algorithms", "Deep Learning"],
                    ["Deep Learning", "AI Development"],
                    ["AI Development", "Advanced Machine Learning"]
                ];

                this.CONSTELLATION_COLORS = {
                    "Core Foundations": "#00ff00",
                    "Basic Programming": "#87ceeb",
                    "Intermediate Programming": "#dda0dd",
                    "Intermediate Development": "#98fb98",
                    "Advanced Development": "#ffa07a",
                    "Web Development": "#ff6347",
                    "Systems Programming": "#20b2aa",
                    "Software Engineering": "#daa520",
                    "Full Stack Development": "#f0e68c",
                    "Game Development": "#9370db",
                    "Data Science": "#32cd32"
                };

                this.CONSTELLATION_POSITIONS = {
                    "Core Foundations": { x: 1391, y: 3256 },
                    "Basic Programming": { x: 1229, y: 2880 },
                    "Intermediate Programming": { x: 1237, y: 2582 },
                    "Intermediate Development": { x: 1156, y: 2290 },
                    "Advanced Development": { x: 1593, y: 1918 },
                    "Web Development": { x: 2372, y: 1397 },
                    "Systems Programming": { x: 483, y: 1286 },
                    "Software Engineering": { x: 858, y: 1301 },
                    "Full Stack Development": { x: 1200, y: 1300 },
                    "Game Development": { x: 1898, y: 1147 },
                    "Data Science": { x: 1552, y: 1382 }
                };
            }

            loadRoboticsData() {
                // Comprehensive Robotics skill tree - 96 skills across 5 interdisciplinary constellations
                this.SKILL_TREE = {
                    "Mechanics Basics": { x: 612, y: 4071, type: "root", constellation: "Mechanical Maker", state: "locked" },
                    "Circuits Basics": { x: 994, y: 3932, type: "root", constellation: "Electric Explorer", state: "locked" },
                    "Coding Basics": { x: 1353, y: 4066, type: "root", constellation: "Code Commander", state: "locked" },
                    "Design Basics": { x: 1188, y: 4404, type: "root", constellation: "Tech Designer", state: "locked" },
                    "Innovation Basics": { x: 719, y: 4384, type: "root", constellation: "Innovator & Problem Solver", state: "locked" },
                    "Frame Build": { x: 184, y: 4123, constellation: "Mechanical Maker", state: "locked" },
                    "Axles & Wheels": { x: 447, y: 4053, constellation: "Mechanical Maker", state: "locked" },
                    "Motion Device": { x: 616, y: 3925, constellation: "Mechanical Maker", state: "locked" },
                    "Build Stability": { x: -33, y: 3820, constellation: "Mechanical Maker", state: "locked" },
                    "Gears & Torque": { x: 290, y: 3726, constellation: "Mechanical Maker", state: "locked" },
                    "Axle Compare": { x: 335, y: 3939, constellation: "Mechanical Maker", state: "locked" },
                    "Cranks & Pulleys": { x: 529, y: 3594, constellation: "Mechanical Maker", state: "locked" },
                    "2-Joint Arm": { x: 243, y: 3627, constellation: "Mechanical Maker", state: "locked" },
                    "Gear Integration": { x: 50, y: 3569, constellation: "Mechanical Maker", state: "locked" },
                    "Walker/Biped": { x: 37, y: 3386, constellation: "Mechanical Maker", state: "locked" },
                    "Balance & Springs": { x: -537, y: 3487, constellation: "Mechanical Maker", state: "locked" },
                    "Materials Choice": { x: 345, y: 3065, constellation: "Mechanical Maker", state: "locked" },
                    "Real-World Chassis": { x: 259, y: 2813, constellation: "Mechanical Maker", state: "locked" },
                    "Mech-Control Integr.": { x: 2220, y: 2646, constellation: "Mechanical Maker", state: "locked" },
                    "Test Iteration": { x: -204, y: 2835, constellation: "Mechanical Maker", state: "locked" },
                    "Labeled Mechanism": { x: -469, y: 3097, constellation: "Mechanical Maker", state: "locked" },
                    "Components ID": { x: 689, y: 3801, constellation: "Electric Explorer", state: "locked" },
                    "Electricity Flow": { x: 972, y: 3824, constellation: "Electric Explorer", state: "locked" },
                    "LED Switch": { x: 1141, y: 3812, constellation: "Electric Explorer", state: "locked" },
                    "Breadboard Use": { x: 800, y: 3684, constellation: "Electric Explorer", state: "locked" },
                    "Sensor Read": { x: 1229, y: 3619, constellation: "Electric Explorer", state: "locked" },
                    "Multimeter Use": { x: 963, y: 3614, constellation: "Electric Explorer", state: "locked" },
                    "Servo Drive": { x: 741, y: 3067, constellation: "Electric Explorer", state: "locked" },
                    "Sensor Logic": { x: 1121, y: 3313, constellation: "Electric Explorer", state: "locked" },
                    "Light/Sound React": { x: 1092, y: 3516, constellation: "Electric Explorer", state: "locked" },
                    "Sensor Toggle": { x: 1457, y: 3558, constellation: "Code Commander", state: "locked" },
                    "Motor+Sensor Circuit": { x: 1176, y: 3203, constellation: "Electric Explorer", state: "locked" },
                    "Power Budget": { x: 932, y: 3492, constellation: "Electric Explorer", state: "locked" },
                    "Sensor Control": { x: 1309, y: 3124, constellation: "Electric Explorer", state: "locked" },
                    "Regulators & Polarity": { x: 928, y: 3251, constellation: "Electric Explorer", state: "locked" },
                    "Alarm Device": { x: 1062, y: 3383, constellation: "Electric Explorer", state: "locked" },
                    "Transistors/Relays": { x: 563, y: 3366, constellation: "Electric Explorer", state: "locked" },
                    "Multi-Load Power": { x: 642, y: 2962, constellation: "Electric Explorer", state: "locked" },
                    "Soldering": { x: 868, y: 2851, constellation: "Electric Explorer", state: "locked" },
                    "Autonomous Power": { x: 982, y: 3018, constellation: "Electric Explorer", state: "locked" },
                    "Enclosure Build": { x: 1117, y: 2922, constellation: "Electric Explorer", state: "locked" },
                    "Circuit Diagram": { x: 1410, y: 2805, constellation: "Electric Explorer", state: "locked" },
                    "Starter Code": { x: 1597, y: 4061, constellation: "Code Commander", state: "locked" },
                    "Inputs ID": { x: 1522, y: 3897, constellation: "Code Commander", state: "locked" },
                    "Parameter Tuning": { x: 1318, y: 3897, constellation: "Code Commander", state: "locked" },
                    "If/Else & Loops": { x: 1539, y: 3378, constellation: "Code Commander", state: "locked" },
                    "Debug Syntax": { x: 1867, y: 3758, constellation: "Code Commander", state: "locked" },
                    "Blink LED": { x: 1947, y: 4040, constellation: "Code Commander", state: "locked" },
                    "Input ‚Üí Output": { x: 1404, y: 3748, constellation: "Code Commander", state: "locked" },
                    "Functions": { x: 1754, y: 3639, constellation: "Code Commander", state: "locked" },
                    "Serial Monitor": { x: 2058, y: 3753, constellation: "Code Commander", state: "locked" },
                    "Libraries": { x: 2041, y: 3527, constellation: "Code Commander", state: "locked" },
                    "Menu/UI": { x: 1789, y: 3439, constellation: "Code Commander", state: "locked" },
                    "Timers/Millis": { x: 2250, y: 3838, constellation: "Code Commander", state: "locked" },
                    "Interrupts/States": { x: 1918, y: 3329, constellation: "Code Commander", state: "locked" },
                    "Concurrent Code": { x: 2163, y: 3311, constellation: "Code Commander", state: "locked" },
                    "Optimize Code": { x: 1987, y: 3147, constellation: "Code Commander", state: "locked" },
                    "RF/Bluetooth": { x: 2441, y: 3596, constellation: "Code Commander", state: "locked" },
                    "Auto Behavior": { x: 2172, y: 3001, constellation: "Code Commander", state: "locked" },
                    "Code Docs": { x: 2347, y: 3236, constellation: "Code Commander", state: "locked" },
                    "Labeled Sketch": { x: 1562, y: 4962, constellation: "Tech Designer", state: "locked" },
                    "Part Explain": { x: 1696, y: 4492, constellation: "Tech Designer", state: "locked" },
                    "Design Weakness": { x: 1605, y: 4681, constellation: "Tech Designer", state: "locked" },
                    "Plan Template": { x: 1910, y: 4928, constellation: "Tech Designer", state: "locked" },
                    "Record Measures": { x: 1923, y: 5283, constellation: "Tech Designer", state: "locked" },
                    "Present Concept": { x: 1909, y: 4690, constellation: "Tech Designer", state: "locked" },
                    "BOM": { x: 1582, y: 5269, constellation: "Tech Designer", state: "locked" },
                    "Tinkercad Model": { x: 2224, y: 5075, constellation: "Tech Designer", state: "locked" },
                    "Label Schematics": { x: 2509, y: 5117, constellation: "Tech Designer", state: "locked" },
                    "Goals Fit": { x: 2382, y: 4534, constellation: "Tech Designer", state: "locked" },
                    "Scaled Drawings": { x: 2252, y: 5273, constellation: "Tech Designer", state: "locked" },
                    "Simulate System": { x: 3076, y: 4586, constellation: "Tech Designer", state: "locked" },
                    "Design Log": { x: 3230, y: 4924, constellation: "Tech Designer", state: "locked" },
                    "Material Eval": { x: 2966, y: 5207, constellation: "Tech Designer", state: "locked" },
                    "Fusion 360": { x: 2500, y: 5467, constellation: "Tech Designer", state: "locked" },
                    "CAD Assemblies": { x: 2662, y: 5564, constellation: "Tech Designer", state: "locked" },
                    "Tech Prints": { x: 2550, y: 5257, constellation: "Tech Designer", state: "locked" },
                    "Client Design": { x: 2799, y: 5510, constellation: "Tech Designer", state: "locked" },
                    "Pro Presentation": { x: 3122, y: 5517, constellation: "Tech Designer", state: "locked" },
                    "Design Portfolio": { x: 3239, y: 5775, constellation: "Tech Designer", state: "locked" },
                    "Budget Limits": { x: 1642, y: 5453, constellation: "Tech Designer", state: "locked" },
                    "Idea Brainstorm": { x: 404, y: 4466, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Problem Describe": { x: 477, y: 4715, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Success Criteria": { x: 1029, y: 4839, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Invention Sketch": { x: 249, y: 4639, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Test Plan": { x: 1030, y: 5136, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Low-Fi Proto": { x: -183, y: 4575, constellation: "Innovator & Problem Solver", state: "locked" },
                    "User Interview": { x: 4, y: 4918, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Usability Test": { x: 1374, y: 5430, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Multi Prototypes": { x: -759, y: 5031, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Feedback Iterate": { x: 190, y: 5351, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Constraint Track": { x: 791, y: 5733, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Version Compare": { x: -186, y: 5567, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Team Lead": { x: 957, y: 5943, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Research Docs": { x: 773, y: 6148, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Final Prototype": { x: 198, y: 5814, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Reliability Test": { x: -264, y: 5794, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Impact Project": { x: 256, y: 6207, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Public Present": { x: 762, y: 6322, constellation: "Innovator & Problem Solver", state: "locked" },
                    "Scale Plan": { x: -503, y: 6266, constellation: "Innovator & Problem Solver", state: "locked" }
                };

                this.CONNECTIONS = [
                    // From root nodes (direct connections only)
                    ["Mechanics Basics", "Frame Build"],
                    ["Mechanics Basics", "Axles & Wheels"],
                    ["Mechanics Basics", "Motion Device"],
                    ["Circuits Basics", "Components ID"],
                    ["Circuits Basics", "Electricity Flow"],
                    ["Circuits Basics", "LED Switch"],
                    ["Coding Basics", "Starter Code"],
                    ["Coding Basics", "Inputs ID"],
                    ["Coding Basics", "Parameter Tuning"],
                    ["Design Basics", "Labeled Sketch"],
                    ["Design Basics", "Part Explain"],
                    ["Design Basics", "Design Weakness"],
                    ["Innovation Basics", "Idea Brainstorm"],
                    ["Innovation Basics", "Problem Describe"],
                    ["Innovation Basics", "Success Criteria"],
                    
                    // Mechanical Maker - simplified paths
                    ["Frame Build", "Build Stability"],
                    ["Frame Build", "Gears & Torque"],
                    ["Axles & Wheels", "Axle Compare"],
                    ["Motion Device", "Gears & Torque"],
                    ["Motion Device", "Cranks & Pulleys"],
                    ["Axle Compare", "Gears & Torque"],
                    ["Gears & Torque", "Cranks & Pulleys"],
                    ["Cranks & Pulleys", "2-Joint Arm"],
                    ["Build Stability", "2-Joint Arm"],
                    ["2-Joint Arm", "Gear Integration"],
                    ["Gear Integration", "Walker/Biped"],
                    ["Walker/Biped", "Balance & Springs"],
                    ["Walker/Biped", "Materials Choice"],
                    ["Balance & Springs", "Real-World Chassis"],
                    ["Materials Choice", "Real-World Chassis"],
                    ["Real-World Chassis", "Mech-Control Integr."],
                    ["Real-World Chassis", "Test Iteration"],
                    ["Real-World Chassis", "Labeled Mechanism"],
                    ["Test Iteration", "Labeled Mechanism"],
                    
                    // Electric Explorer - simplified paths
                    ["Components ID", "Breadboard Use"],
                    ["Electricity Flow", "Breadboard Use"],
                    ["LED Switch", "Breadboard Use"],
                    ["Breadboard Use", "Sensor Read"],
                    ["Breadboard Use", "Multimeter Use"],
                    ["Breadboard Use", "Servo Drive"],
                    ["Sensor Read", "Sensor Logic"],
                    ["Sensor Read", "Light/Sound React"],
                    ["Sensor Read", "Sensor Toggle"],
                    ["Multimeter Use", "Power Budget"],
                    ["Servo Drive", "Motor+Sensor Circuit"],
                    ["Servo Drive", "Power Budget"],
                    ["Servo Drive", "Sensor Control"],
                    ["Sensor Logic", "Motor+Sensor Circuit"],
                    ["Light/Sound React", "Alarm Device"],
                    ["Motor+Sensor Circuit", "Regulators & Polarity"],
                    ["Motor+Sensor Circuit", "Sensor Control"],
                    ["Regulators & Polarity", "Alarm Device"],
                    ["Regulators & Polarity", "Power Budget"],
                    ["Power Budget", "Transistors/Relays"],
                    ["Transistors/Relays", "Multi-Load Power"],
                    ["Multi-Load Power", "Soldering"],
                    ["Multi-Load Power", "Autonomous Power"],
                    ["Soldering", "Enclosure Build"],
                    ["Soldering", "Circuit Diagram"],
                    ["Autonomous Power", "Enclosure Build"],
                    ["Circuit Diagram", "Mech-Control Integr."],
                    
                    // Code Commander - simplified paths
                    ["Starter Code", "If/Else & Loops"],
                    ["Starter Code", "Debug Syntax"],
                    ["Starter Code", "Blink LED"],
                    ["Inputs ID", "Input ‚Üí Output"],
                    ["Parameter Tuning", "Input ‚Üí Output"],
                    ["If/Else & Loops", "Functions"],
                    ["If/Else & Loops", "Sensor Toggle"],
                    ["Debug Syntax", "Serial Monitor"],
                    ["Blink LED", "Timers/Millis"],
                    ["Input ‚Üí Output", "Sensor Toggle"],
                    ["Functions", "Libraries"],
                    ["Functions", "Menu/UI"],
                    ["Serial Monitor", "Libraries"],
                    ["Libraries", "Menu/UI"],
                    ["Libraries", "Timers/Millis"],
                    ["Menu/UI", "Interrupts/States"],
                    ["Timers/Millis", "Interrupts/States"],
                    ["Timers/Millis", "Concurrent Code"],
                    ["Interrupts/States", "Concurrent Code"],
                    ["Interrupts/States", "Optimize Code"],
                    ["Concurrent Code", "Auto Behavior"],
                    ["Concurrent Code", "RF/Bluetooth"],
                    ["Optimize Code", "Auto Behavior"],
                    ["RF/Bluetooth", "Code Docs"],
                    ["Auto Behavior", "Code Docs"],
                    ["Sensor Toggle", "Sensor Control"],
                    ["Sensor Control", "Auto Behavior"],
                    
                    // Cross-constellation critical connections
                    ["Mech-Control Integr.", "Auto Behavior"],
                    ["Autonomous Power", "Auto Behavior"],
                    
                    // Tech Designer - simplified paths
                    ["Labeled Sketch", "Plan Template"],
                    ["Labeled Sketch", "Record Measures"],
                    ["Labeled Sketch", "Present Concept"],
                    ["Labeled Sketch", "BOM"],
                    ["Part Explain", "Present Concept"],
                    ["Design Weakness", "Plan Template"],
                    ["Plan Template", "Tinkercad Model"],
                    ["Record Measures", "Scaled Drawings"],
                    ["Present Concept", "Goals Fit"],
                    ["BOM", "Budget Limits"],
                    ["Tinkercad Model", "Label Schematics"],
                    ["Tinkercad Model", "Simulate System"],
                    ["Label Schematics", "Tech Prints"],
                    ["Goals Fit", "Simulate System"],
                    ["Scaled Drawings", "Fusion 360"],
                    ["Simulate System", "Design Log"],
                    ["Simulate System", "Material Eval"],
                    ["Simulate System", "Mech-Control Integr."],
                    ["Design Log", "Design Portfolio"],
                    ["Material Eval", "Fusion 360"],
                    ["Fusion 360", "CAD Assemblies"],
                    ["Fusion 360", "Tech Prints"],
                    ["CAD Assemblies", "Client Design"],
                    ["Tech Prints", "Client Design"],
                    ["Client Design", "Pro Presentation"],
                    ["Pro Presentation", "Design Portfolio"],
                    ["Pro Presentation", "Public Present"],
                    
                    // Innovator & Problem Solver - simplified paths
                    ["Idea Brainstorm", "Invention Sketch"],
                    ["Problem Describe", "Invention Sketch"],
                    ["Success Criteria", "Test Plan"],
                    ["Invention Sketch", "Low-Fi Proto"],
                    ["Low-Fi Proto", "User Interview"],
                    ["Low-Fi Proto", "Test Plan"],
                    ["User Interview", "Multi Prototypes"],
                    ["User Interview", "Feedback Iterate"],
                    ["Test Plan", "Usability Test"],
                    ["Multi Prototypes", "Version Compare"],
                    ["Usability Test", "Feedback Iterate"],
                    ["Usability Test", "Constraint Track"],
                    ["Budget Limits", "Constraint Track"],
                    ["Feedback Iterate", "Final Prototype"],
                    ["Version Compare", "Final Prototype"],
                    ["Constraint Track", "Team Lead"],
                    ["Constraint Track", "Final Prototype"],
                    ["Team Lead", "Research Docs"],
                    ["Research Docs", "Final Prototype"],
                    ["Final Prototype", "Reliability Test"],
                    ["Final Prototype", "Impact Project"],
                    ["Final Prototype", "Public Present"],
                    ["Reliability Test", "Scale Plan"],
                    ["Impact Project", "Public Present"],
                    ["Public Present", "Scale Plan"]
                ];

                this.CONSTELLATION_COLORS = {
                    "Mechanical Maker": "#ff4500",
                    "Electric Explorer": "#00bfff",
                    "Code Commander": "#32cd32",
                    "Tech Designer": "#9370db",
                    "Innovator & Problem Solver": "#ffd700"
                };

                this.CONSTELLATION_POSITIONS = {
                    "Mechanical Maker": { x: 988, y: 4063 },
                    "Electric Explorer": { x: 596, y: 4190 },
                    "Code Commander": { x: 1253, y: 4177 },
                    "Tech Designer": { x: 1160, y: 4558 },
                    "Innovator & Problem Solver": { x: 460, y: 4590 }
                };
            }

            // === PROGRESS MANAGEMENT ===
            initializeProgress() {
                this.skillProgress = {};
                Object.keys(this.SKILL_TREE).forEach(skill => {
                    this.skillProgress[skill] = this.SKILL_TREE[skill].type === 'root' ? 'available' : 'locked';
                });
            }

            applyProgress(progressObj) {
              if (!progressObj || typeof progressObj !== 'object') return false;

              const validStates = ['locked', 'available', 'in_progress', 'activated', 'mastered', 'needs_review'];

              // First, reset ALL skills to default state (root = available, others = locked)
              // This ensures hardcoded states don't persist when progress is empty
              Object.keys(this.SKILL_TREE).forEach(name => {
                const isRoot = this.SKILL_TREE[name].type === 'root';
                this.SKILL_TREE[name].state = isRoot ? 'available' : 'locked';
                this.SKILL_TREE[name].mastery_score = 0;
                this.SKILL_TREE[name].last_practiced = null;
                this.SKILL_TREE[name].practice_count = 0;
                this.SKILL_TREE[name].mastered_at = null;
              });

              // Then apply progress from database on top
              Object.keys(this.SKILL_TREE).forEach(name => {
                if (Object.prototype.hasOwnProperty.call(progressObj, name)) {
                  const progressData = progressObj[name];
                  const fallback = this.SKILL_TREE[name].type === 'root' ? 'available' : 'locked';

                  // Handle both old format (string) and new format (object)
                  if (typeof progressData === 'string') {
                    this.SKILL_TREE[name].state = validStates.includes(progressData) ? progressData : fallback;
                  } else if (typeof progressData === 'object') {
                    // New format with full skill data
                    const state = progressData.state;
                    this.SKILL_TREE[name].state = validStates.includes(state) ? state : fallback;
                    this.SKILL_TREE[name].mastery_score = progressData.mastery_score || 0;
                    this.SKILL_TREE[name].last_practiced = progressData.last_practiced;
                    this.SKILL_TREE[name].practice_count = progressData.practice_count || 0;
                    this.SKILL_TREE[name].decay_rate = progressData.decay_rate || 14;
                    this.SKILL_TREE[name].mastered_at = progressData.mastered_at;
                  }
                }
              });

              // Update available skills based on prerequisites
              this.updateAvailableSkills();

              this.skillProgress = {};
              Object.keys(this.SKILL_TREE).forEach(name => {
                this.skillProgress[name] = this.SKILL_TREE[name].state;
              });

              return true;
            }

            updateProgress(newProgress) {
                this.applyProgress(newProgress);
                this.updateAvailableSkills();
                this.refreshAllVisuals();
            }

            // === SKILL LOGIC ===
            getPrerequisites(skillName) {
                return this.CONNECTIONS.filter(([from, to]) => to === skillName).map(([from]) => from);
            }

            getImmediatePrerequisites(skillName) {
                const directPrereqs = this.getPrerequisites(skillName);
                
                const filtered = directPrereqs.filter(prereq => {
                    return !directPrereqs.some(otherPrereq => {
                        if (otherPrereq === prereq) return false;
                        return this.isPrerequisiteOf(prereq, otherPrereq);
                    });
                });
                
                return [...new Set(filtered)];
            }

            isPrerequisiteOf(skillA, skillB, visited = new Set()) {
                if (visited.has(skillB)) return false;
                visited.add(skillB);
                
                const directPrereqs = this.getPrerequisites(skillB);
                
                if (directPrereqs.includes(skillA)) return true;
                
                return directPrereqs.some(prereq => this.isPrerequisiteOf(skillA, prereq, visited));
            }

            getPrerequisiteChain(skillName, visited = new Set()) {
                if (visited.has(skillName)) return [];
                visited.add(skillName);
                
                const directPrereqs = this.getPrerequisites(skillName);
                let chain = [];
                
                directPrereqs.forEach(prereq => {
                    chain = chain.concat(this.getPrerequisiteChain(prereq, visited));
                    if (!chain.includes(prereq)) chain.push(prereq);
                });
                
                return chain;
            }

            canUnlock(skillName) {
                const masteredStates = ['activated', 'mastered', 'needs_review'];
                return this.getPrerequisites(skillName).every(prereq =>
                    masteredStates.includes(this.SKILL_TREE[prereq].state)
                );
            }

            activateSkill(skillName) {
                const skill = this.SKILL_TREE[skillName];
                if (skill.state !== 'available') return;

                // Send unlock request to parent
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'SKILL_UNLOCKED',
                        subject: this.currentSubject,
                        skillName: skillName,
                        state: 'activated'
                    }, '*');
                }

                // Optimistically update UI
                skill.state = 'activated';
                this.skillProgress[skillName] = 'activated';
                this.updateNodeVisuals(skillName);
                this.updateAvailableSkills();
                this.updateConnections();

                // Save to localStorage so Dojo can see the updates
                this.saveProgressToStorage();
            }

            updateAvailableSkills() {
                Object.keys(this.SKILL_TREE).forEach(skillName => {
                    const skill = this.SKILL_TREE[skillName];
                    if (skill.state === 'locked' && this.canUnlock(skillName)) {
                        skill.state = 'available';
                        this.skillProgress[skillName] = 'available';
                        this.updateNodeVisuals(skillName);
                    }
                });
            }

            // === OVERRIDE CODE SYSTEM ===
            generateOverrideCode() {
                const now = new Date();
                const day = now.getDate();
                const month = now.getMonth() + 1;
                const hour = now.getHours();
                // Code format: day + month + hour concatenated (e.g., 12/8 at 11am = "81211")
                return `${day}${month}${hour}`;
            }

            resetSkillTree() {
                console.log('Resetting skill tree to initial state');

                // Find all skills that have prerequisites (are targets of connections)
                const skillsWithPrereqs = new Set();
                this.CONNECTIONS.forEach(conn => {
                    skillsWithPrereqs.add(conn.to);
                });

                // Reset all skills
                Object.keys(this.SKILL_TREE).forEach(skillName => {
                    const skill = this.SKILL_TREE[skillName];

                    // Root skills (no prerequisites) become available, others locked
                    if (!skillsWithPrereqs.has(skillName)) {
                        skill.state = 'available';
                    } else {
                        skill.state = 'locked';
                    }

                    // Clear progress data
                    skill.mastery_score = 0;
                    skill.practice_count = 0;
                    skill.last_practiced = null;
                    skill.mastered_at = null;

                    this.skillProgress[skillName] = skill.state;
                });

                // Clear localStorage data for this subject
                const storageKey = `${this.currentSubject.toLowerCase()}_skill_states`;
                localStorage.removeItem(storageKey);
                localStorage.removeItem(`skillTreeProgress_${this.currentSubject}`);

                // Save fresh state
                this.saveProgressToStorage();

                // Tell parent app to clear database data for this subject
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({
                        type: 'RESET_SKILL_PROGRESS',
                        subject: this.currentSubject
                    }, '*');
                }

                // Refresh all visuals
                this.refreshAllVisuals();

                console.log('Skill tree reset complete');
            }

            unlockAllSkills() {
                console.log('Unlocking all skills');

                // Set all skills to activated
                Object.keys(this.SKILL_TREE).forEach(skillName => {
                    const skill = this.SKILL_TREE[skillName];
                    skill.state = 'activated';
                    skill.mastery_score = 100;
                    this.skillProgress[skillName] = 'activated';
                });

                // Save to localStorage
                this.saveProgressToStorage();

                // Refresh all visuals
                this.refreshAllVisuals();

                console.log('All skills unlocked');
            }

            showOverrideModal(skillName) {
                console.log('showOverrideModal called with:', skillName);
                this.pendingUnlockSkill = skillName;
                const modal = document.getElementById('overrideModal');
                const input = document.getElementById('overrideCodeInput');
                const error = document.getElementById('overrideError');

                console.log('Override modal elements:', { modal: !!modal, input: !!input });

                if (modal && input) {
                    modal.classList.add('active');
                    input.value = '';
                    if (error) error.textContent = '';
                    input.focus();
                }
            }

            hideOverrideModal() {
                const modal = document.getElementById('overrideModal');
                const input = document.getElementById('overrideCodeInput');
                const error = document.getElementById('overrideError');

                if (modal) modal.classList.remove('active');
                if (input) input.value = '';
                if (error) error.textContent = '';
                this.pendingUnlockSkill = null;
            }

            validateAndUnlock() {
                const input = document.getElementById('overrideCodeInput');
                const error = document.getElementById('overrideError');

                console.log('validateAndUnlock called:', { input: !!input, pendingSkill: this.pendingUnlockSkill });

                if (!input || !this.pendingUnlockSkill) {
                    console.log('Early return - missing input or pendingUnlockSkill');
                    return;
                }

                const enteredCode = input.value.trim().toUpperCase();
                const correctCode = this.generateOverrideCode();

                console.log('Override validation:', { entered: enteredCode, expected: correctCode });

                // Special RESET code - reset tree to initial state
                if (enteredCode === 'RESET') {
                    this.resetSkillTree();
                    this.hideOverrideModal();
                    this.showNotification('Skill tree reset to initial state');
                    return;
                }

                // Special UNLOCKALL code - unlock all skills
                if (enteredCode === 'UNLOCKALL') {
                    this.unlockAllSkills();
                    this.hideOverrideModal();
                    this.showNotification('All skills unlocked!');
                    return;
                }

                if (enteredCode === correctCode) {
                    // Correct code - activate the skill
                    const skillName = this.pendingUnlockSkill;
                    const skill = this.SKILL_TREE[skillName];

                    if (skill && skill.state === 'available') {
                        this.activateSkill(skillName);
                    }

                    this.hideOverrideModal();
                } else {
                    // Incorrect code
                    if (error) error.textContent = 'Incorrect code. Try again.';
                    input.value = '';
                    input.focus();
                }
            }

            setupOverrideModal() {
                const cancelBtn = document.getElementById('overrideCancelBtn');
                const submitBtn = document.getElementById('overrideSubmitBtn');
                const input = document.getElementById('overrideCodeInput');
                const modal = document.getElementById('overrideModal');

                console.log('Setting up override modal:', { cancelBtn: !!cancelBtn, submitBtn: !!submitBtn, input: !!input, modal: !!modal });

                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        console.log('Cancel clicked');
                        this.hideOverrideModal();
                    });
                }

                if (submitBtn) {
                    submitBtn.addEventListener('click', () => {
                        console.log('Submit clicked');
                        this.validateAndUnlock();
                    });
                }

                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.validateAndUnlock();
                    });
                }

                // Close on backdrop click
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) this.hideOverrideModal();
                    });
                }
            }

            // === UI SETUP ===
            setupUI() {
                const elements = ['controls', 'legend', 'viewport', 'zoomControls'];
                elements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.remove('hidden');
                });
                
                this.viewport = document.getElementById('viewport');
                this.container = document.getElementById('constellation');
                
                // Adjust container size based on subject
                if (this.container) {
                    if (this.currentSubject === 'Robotics') {
                        this.container.style.width = '4000px';
                        this.container.style.height = '4000px';
                    } else if (this.currentSubject === 'Programming') {
                        this.container.style.width = '3000px';
                        this.container.style.height = '3500px';
                    } else if (this.currentSubject === 'Math'){
                        this.container.style.width = '2400px';
                        this.container.style.height = '3000px';
                    } else {
                        this.container.style.width = '2400px';
                        this.container.style.height = '2000px';
                    }
                }
                
                this.currentX = 0;
                this.currentY = 0;
                this.currentScale = 1;
                
                this.setupTouchControls();
                this.setupZoomControls();
            }

            enterApplication() {
                // Hide loading screen
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }

                this.showElement('controls');
                this.showElement('legend');
                this.showElement('viewport');
                this.showElement('zoomControls');

                this.initializeSkillTree();

                // Save progress to localStorage for Dojo to read
                if (this.currentSubject === 'Math') {
                    this.saveProgressToStorage();
                }

                setTimeout(() => {
                    this.centerViewport();
                }, 50);
            }

            // === TOUCH AND ZOOM CONTROLS ===
            setupTouchControls() {
                if (!this.viewport || !this.container) return;
                
                this.viewport.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
                this.viewport.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
                this.viewport.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: false });
                
                this.viewport.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.viewport.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.viewport.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.viewport.addEventListener('mouseleave', (e) => this.handleMouseUp(e));
                
                this.viewport.addEventListener('contextmenu', e => e.preventDefault());

                // Mouse wheel zoom
                this.viewport.addEventListener('wheel', (e) => this.handleWheel(e), { passive: false });
            }

            handleWheel(e) {
                e.preventDefault();
                if (!this.viewport || !this.container) return;

                const STEP = 1.08;
                const factor = e.deltaY < 0 ? STEP : 1 / STEP;

                // Get mouse position relative to viewport
                const rect = this.viewport.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // Get world coordinates under mouse
                const worldX = (mouseX - this.currentX) / this.currentScale;
                const worldY = (mouseY - this.currentY) / this.currentScale;

                const newScale = Math.max(0.1, Math.min(2, this.currentScale * factor));
                if (newScale === this.currentScale) return;

                this.currentScale = newScale;

                // Adjust position to keep mouse point stationary
                this.currentX = mouseX - worldX * this.currentScale;
                this.currentY = mouseY - worldY * this.currentScale;

                this.updateTransform();
            }

            setupZoomControls() {
                const btnIn = document.getElementById('zoomIn');
                const btnOut = document.getElementById('zoomOut');
                const btnCenter = document.getElementById('centerView');

                btnIn && btnIn.addEventListener('click', () => this.zoom(+1));
                btnOut && btnOut.addEventListener('click', () => this.zoom(-1));
                btnCenter && btnCenter.addEventListener('click', () => this.centerViewport());
            }

            handleTouchStart(e) {
                e.preventDefault();
                if (e.touches.length === 2) {
                    // Start pinch-to-zoom
                    this.endDrag();
                    this.isPinching = true;
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    this.initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
                    this.initialPinchScale = this.currentScale;
                    // Store pinch center in viewport coordinates
                    this.pinchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    this.pinchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                } else if (e.touches.length === 1 && !this.isPinching) {
                    this.startDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            }

            handleTouchMove(e) {
                e.preventDefault();
                if (e.touches.length === 2 && this.isPinching) {
                    // Handle pinch-to-zoom
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (this.initialPinchDistance > 0) {
                        const scale = distance / this.initialPinchDistance;
                        const newScale = Math.max(0.1, Math.min(2, this.initialPinchScale * scale));

                        if (newScale !== this.currentScale) {
                            // Get the pinch center in world coordinates before scaling
                            const worldX = (this.pinchCenterX - this.currentX) / this.currentScale;
                            const worldY = (this.pinchCenterY - this.currentY) / this.currentScale;

                            this.currentScale = newScale;

                            // Adjust position to keep pinch center stationary
                            this.currentX = this.pinchCenterX - worldX * this.currentScale;
                            this.currentY = this.pinchCenterY - worldY * this.currentScale;

                            this.updateTransform();
                        }
                    }
                } else if (e.touches.length === 1 && this.isDragging && !this.isPinching) {
                    this.drag(e.touches[0].clientX, e.touches[0].clientY);
                }
            }

            handleTouchEnd(e) {
                e.preventDefault();
                if (e.touches.length < 2) {
                    this.isPinching = false;
                    this.initialPinchDistance = 0;
                }
                if (e.touches.length === 0) {
                    this.endDrag();
                }
            }
            
            handleMouseDown(e) {
                this.startDrag(e.clientX, e.clientY);
            }
            
            handleMouseMove(e) {
                if (this.isDragging) {
                    this.drag(e.clientX, e.clientY);
                }
            }
            
            handleMouseUp(e) {
                this.endDrag();
            }
            
            startDrag(x, y) {
                this.isDragging = true;
                this.startX = x;
                this.startY = y;
                this.dragStartX = this.currentX;
                this.dragStartY = this.currentY;
                this.viewport.classList.add('dragging');
            }
            
            drag(x, y) {
                if (!this.isDragging) return;
                
                const deltaX = x - this.startX;
                const deltaY = y - this.startY;
                
                this.currentX = this.dragStartX + deltaX;
                this.currentY = this.dragStartY + deltaY;
                
                this.updateTransform();
            }
            
            endDrag() {
                this.isDragging = false;
                this.viewport.classList.remove('dragging');
            }

            zoom(direction) {
                if (!this.viewport || !this.container) return;

                const STEP = 1.15;
                const factor = direction > 0 ? STEP : 1 / STEP;

                const vpW = this.viewport.offsetWidth;
                const vpH = this.viewport.offsetHeight;
                const centerX = vpW / 2;
                const centerY = vpH / 2;

                const worldX = (centerX - this.currentX) / this.currentScale;
                const worldY = (centerY - this.currentY) / this.currentScale;

                const newScale = Math.max(0.1, Math.min(2, this.currentScale * factor));
                if (newScale === this.currentScale) return;

                this.currentScale = newScale;

                this.currentX = centerX - worldX * this.currentScale;
                this.currentY = centerY - worldY * this.currentScale;

                this.updateTransform();
            }

            centerViewport() {
                // Fit-all: zoom to show entire tree
                this.fitAll();
            }

            fitAll() {
                if (!this.viewport || !this.container) return;

                const vpW = this.viewport.offsetWidth;
                const vpH = this.viewport.offsetHeight;

                // Calculate the bounding box of all skills
                let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
                Object.values(this.SKILL_TREE).forEach(s => {
                    minX = Math.min(minX, s.x);
                    maxX = Math.max(maxX, s.x);
                    minY = Math.min(minY, s.y);
                    maxY = Math.max(maxY, s.y);
                });
                if (!isFinite(minX) || !isFinite(minY)) return;

                // Add padding around the tree (account for node size ~40px)
                const padding = 80;
                minX -= padding;
                maxX += padding;
                minY -= padding;
                maxY += padding;

                const treeWidth = maxX - minX;
                const treeHeight = maxY - minY;

                // Calculate scale to fit tree in viewport
                const scaleX = vpW / treeWidth;
                const scaleY = vpH / treeHeight;
                const fitScale = Math.min(scaleX, scaleY);

                // Clamp to min/max scale
                this.currentScale = Math.max(0.1, Math.min(2, fitScale));

                // Center the tree
                const cx = (minX + maxX) / 2;
                const cy = (minY + maxY) / 2;

                const vpCenterX = vpW / 2;
                const vpCenterY = vpH / 2;
                this.currentX = vpCenterX - (cx * this.currentScale);
                this.currentY = vpCenterY - (cy * this.currentScale);

                this.updateTransform();
            }

            updateTransform() {
                if (!this.container || !this.viewport) return;

                const vpW = this.viewport.offsetWidth;
                const vpH = this.viewport.offsetHeight;
                
                // Use different world sizes based on subject for pan limits
                let worldW, worldH;
                if (this.currentSubject === 'Robotics') {
                    worldW = 4000;
                    worldH = 4000;
                } else if (this.currentSubject === 'Programming') {
                    worldW = 3000;
                    worldH = 3500;
                } else if (this.currentSubject === 'Math') {
                    // Math tree spans x: 60-2040, y: -200 to 2800
                    worldW = 2200;
                    worldH = 3200;
                } else {
                    worldW = 2400;
                    worldH = 2000;
                }

                const scaledW = worldW * this.currentScale;
                const scaledH = worldH * this.currentScale;

                const overpanX = Math.max(scaledW, vpW) * 0.10;
                const overpanY = Math.max(scaledH, vpH) * 0.10;

                let minX, maxX, minY, maxY;

                if (scaledW >= vpW) {
                    minX = vpW - scaledW - overpanX;
                    maxX = overpanX;
                } else {
                    const centerX = (vpW - scaledW) / 2;
                    minX = centerX - overpanX;
                    maxX = centerX + overpanX;
                }

                if (scaledH >= vpH) {
                    minY = vpH - scaledH - overpanY;
                    maxY = overpanY;
                } else {
                    const centerY = (vpH - scaledH) / 2;
                    minY = centerY - overpanY;
                    maxY = centerY + overpanY;
                }

                this.currentX = Math.max(minX, Math.min(maxX, this.currentX));
                this.currentY = Math.max(minY, Math.min(maxY, this.currentY));

                this.container.style.transform = `translate(${this.currentX}px, ${this.currentY}px) scale(${this.currentScale})`;
            }

            // === SKILL NODE INTERACTION ===
            setupNodeTouchHandling(node, skillName) {
                let touchStartTime = 0;
                let touchMoved = false;
                let touchStartX = 0;
                let touchStartY = 0;

                const handleTouchStart = (e) => {
                    e.stopPropagation();
                    touchStartTime = Date.now();
                    touchMoved = false;
                    if (e.touches.length === 1) {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                    }
                    // Highlight paths immediately on touch
                    this.startPathHighlight(skillName);
                    node.classList.add('highlighted');
                };

                const handleTouchMove = (e) => {
                    if (e.touches.length === 1) {
                        const dx = Math.abs(e.touches[0].clientX - touchStartX);
                        const dy = Math.abs(e.touches[0].clientY - touchStartY);
                        if (dx > 10 || dy > 10) {
                            touchMoved = true;
                        }
                    }
                };

                const handleTouchEnd = (e) => {
                    e.stopPropagation();
                    node.classList.remove('highlighted');
                    this.clearPathHighlight();

                    // If didn't move and was a tap, show modal
                    if (!touchMoved && !this.isDragging) {
                        this.showSkillModal(skillName);
                    }
                    touchMoved = false;
                };

                if (this.isMobile) {
                    node.addEventListener('touchstart', handleTouchStart, { passive: false });
                    node.addEventListener('touchmove', handleTouchMove, { passive: false });
                    node.addEventListener('touchend', handleTouchEnd, { passive: false });
                } else {
                    // Desktop: hover for path highlight + name tooltip, click for modal
                    node.addEventListener('mouseenter', () => {
                        this.showTooltipForNode(node, skillName);
                        this.startPathHighlight(skillName);
                        node.classList.add('highlighted');
                    });
                    node.addEventListener('mouseleave', () => {
                        this.hideTooltip();
                        node.classList.remove('highlighted');
                        this.clearPathHighlight();
                    });
                    node.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (this.isDragging) return;
                        this.hideTooltip();
                        this.showSkillModal(skillName);
                    });
                }
            }

            // === PATH HIGHLIGHTING ===
            startPathHighlight(targetName) {
                if (!this.container || !this.connectionElements) return;

                const chain = new Set(this.getPrerequisiteChain(targetName));
                chain.add(targetName);

                this.container.classList.add('dim-lines');
                this.connectionElements.forEach(line => {
                    const to = line.dataset.to;
                    if (chain.has(to)) {
                        line.classList.add('highlighted');
                    } else {
                        line.classList.remove('highlighted');
                    }
                });
            }

            clearPathHighlight() {
                if (!this.container || !this.connectionElements) return;
                this.container.classList.remove('dim-lines');
                this.connectionElements.forEach(line => line.classList.remove('highlighted'));
            }

            // === TOOLTIP HANDLING ===
            // Simple tooltip - just shows skill name on hover
            showTooltipForNode(node, skillName) {
                const tooltip = document.getElementById('tooltip');
                if (!tooltip) return;

                tooltip.textContent = skillName;

                const rect = node.getBoundingClientRect();
                tooltip.style.display = 'block';
                const tooltipRect = tooltip.getBoundingClientRect();

                // Position above the node
                let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                let top = rect.top - tooltipRect.height - 8;

                // Keep on screen
                if (left < 10) left = 10;
                if (left + tooltipRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - tooltipRect.width - 10;
                }
                if (top < 10) {
                    top = rect.bottom + 8;
                }

                tooltip.style.left = `${left}px`;
                tooltip.style.top = `${top}px`;
            }

            hideTooltip() {
                const tooltip = document.getElementById('tooltip');
                if (tooltip) tooltip.style.display = 'none';
            }

            // === SKILL DETAIL MODAL ===
            showSkillModal(skillName) {
                const overlay = document.getElementById('skillModalOverlay');
                const title = document.getElementById('skillModalTitle');
                const content = document.getElementById('skillModalContent');
                if (!overlay || !title || !content) return;

                const skill = this.SKILL_TREE[skillName];
                if (!skill) return;

                // Store current skill for actions
                this.currentModalSkill = skillName;

                // Set title
                title.textContent = skillName;

                // Build content
                let html = '';

                // Status badge
                const stateLabel = this.getStateLabel(skill.state);
                html += `<span class="skill-modal-status ${skill.state}">${stateLabel}</span>`;

                // Mastery section (for non-locked skills)
                if (skill.state !== 'locked') {
                    const masteryScore = skill.mastery_score || 0;
                    html += `
                        <div class="skill-modal-section">
                            <div class="skill-modal-section-title">Mastery</div>
                            <div class="skill-modal-mastery">
                                <div class="skill-modal-mastery-bar">
                                    <div class="skill-modal-mastery-fill" style="width: ${masteryScore}%"></div>
                                </div>
                                <span class="skill-modal-mastery-value">${masteryScore}%</span>
                            </div>
                        </div>
                    `;

                    // Practice info
                    if (skill.last_practiced || skill.practice_count) {
                        html += `<div class="skill-modal-section"><div class="skill-modal-section-title">Practice Info</div><div class="skill-modal-section-content">`;
                        if (skill.practice_count) {
                            html += `Times practiced: ${skill.practice_count}<br>`;
                        }
                        if (skill.last_practiced) {
                            const daysSince = this.getDaysSincePractice(skill.last_practiced);
                            if (daysSince === 0) {
                                html += `Last practiced: Today`;
                            } else if (daysSince === 1) {
                                html += `Last practiced: Yesterday`;
                            } else {
                                html += `Last practiced: ${daysSince} days ago`;
                            }
                            // Decay warning
                            const decayRate = skill.decay_rate || 14;
                            if (daysSince > decayRate && (skill.state === 'mastered' || skill.state === 'activated')) {
                                html += `<br><span style="color: #ef4444;">‚ö† Needs review!</span>`;
                            }
                        }
                        html += `</div></div>`;
                    }
                }

                // Prerequisites section
                const prereqs = this.getImmediatePrerequisites(skillName);
                html += `<div class="skill-modal-section"><div class="skill-modal-section-title">Prerequisites</div><div class="skill-modal-section-content">`;
                if (prereqs.length === 0) {
                    html += `<span style="color: #22c55e;">None required - root skill</span>`;
                } else {
                    prereqs.forEach(prereq => {
                        const prereqSkill = this.SKILL_TREE[prereq];
                        const isMet = prereqSkill && ['activated', 'mastered', 'needs_review'].includes(prereqSkill.state);
                        html += `<div class="skill-modal-prereq">
                            <span class="skill-modal-prereq-dot ${isMet ? 'met' : 'unmet'}"></span>
                            <span>${prereq}</span>
                        </div>`;
                    });
                }
                html += `</div></div>`;

                // Action buttons
                html += `<div class="skill-modal-actions">`;

                if (skill.state === 'locked') {
                    // Check if prerequisites are met for unlocking
                    const prereqsMet = prereqs.length === 0 || prereqs.every(prereq => {
                        const prereqSkill = this.SKILL_TREE[prereq];
                        return prereqSkill && ['activated', 'mastered', 'needs_review'].includes(prereqSkill.state);
                    });

                    if (prereqsMet) {
                        html += `<button class="skill-modal-btn skill-modal-btn-primary" onclick="skillTreeManager.unlockSkillFromModal()">Unlock Skill</button>`;
                    } else {
                        html += `<button class="skill-modal-btn skill-modal-btn-secondary" disabled>Complete prerequisites to unlock</button>`;
                    }
                } else if (skill.state === 'available') {
                    html += `<button class="skill-modal-btn skill-modal-btn-primary" onclick="skillTreeManager.activateSkillFromModal()">Activate Skill</button>`;
                    if (this.currentSubject === 'Math') {
                        html += `<button class="skill-modal-btn skill-modal-btn-secondary" onclick="skillTreeManager.practiceFromModal()">Practice in Math Dojo</button>`;
                    }
                } else {
                    // Activated, mastered, or needs_review
                    if (this.currentSubject === 'Math') {
                        html += `<button class="skill-modal-btn skill-modal-btn-primary" onclick="skillTreeManager.practiceFromModal()">Practice in Math Dojo</button>`;
                    }
                }

                html += `</div>`;

                content.innerHTML = html;

                // Show modal
                overlay.classList.add('active');

                // Setup close handlers
                this.setupModalCloseHandlers();
            }

            hideSkillModal() {
                const overlay = document.getElementById('skillModalOverlay');
                if (overlay) overlay.classList.remove('active');
                this.currentModalSkill = null;
            }

            setupModalCloseHandlers() {
                const overlay = document.getElementById('skillModalOverlay');
                const closeBtn = document.getElementById('skillModalClose');
                const modal = document.getElementById('skillModal');

                // Close on X button
                if (closeBtn) {
                    closeBtn.onclick = () => this.hideSkillModal();
                }

                // Close on overlay click (but not modal click)
                if (overlay) {
                    overlay.onclick = (e) => {
                        if (e.target === overlay) {
                            this.hideSkillModal();
                        }
                    };
                }

                // Close on Escape key
                document.onkeydown = (e) => {
                    if (e.key === 'Escape' && overlay.classList.contains('active')) {
                        this.hideSkillModal();
                    }
                };
            }

            // Modal action handlers
            unlockSkillFromModal() {
                if (!this.currentModalSkill) return;
                const skill = this.SKILL_TREE[this.currentModalSkill];
                if (skill) {
                    skill.state = 'available';
                    this.refreshAllVisuals();
                    this.saveProgressToStorage();
                    this.hideSkillModal();
                    this.showNotification(`${this.currentModalSkill} unlocked!`);
                }
            }

            activateSkillFromModal() {
                if (!this.currentModalSkill) return;
                const skillName = this.currentModalSkill; // Save before hiding clears it
                if (this.systemLocked) {
                    this.hideSkillModal();
                    this.showOverrideModal(skillName);
                } else {
                    this.activateSkill(skillName);
                    this.hideSkillModal();
                }
            }

            practiceFromModal() {
                if (!this.currentModalSkill) return;
                const skillName = this.currentModalSkill; // Save before hiding clears it
                this.hideSkillModal();
                this.requestPracticeInDojo(skillName);
            }

            getStateLabel(state) {
                const labels = {
                    'locked': 'Locked',
                    'available': 'Available',
                    'in_progress': 'In Progress',
                    'activated': 'Mastered',
                    'mastered': 'Mastered',
                    'needs_review': 'Needs Review'
                };
                return labels[state] || state;
            }

            // === RENDERING ===
            createConnectionLine(from, to) {
                const fromSkill = this.SKILL_TREE[from];
                const toSkill = this.SKILL_TREE[to];
                if (!fromSkill || !toSkill) return null;
                
                const line = document.createElement('div');
                const isCross = fromSkill.constellation !== toSkill.constellation;
                line.className = `connection-line ${isCross ? 'cross' : ''}`;
                line.dataset.from = from;
                line.dataset.to = to;
                
                const dx = toSkill.x - fromSkill.x;
                const dy = toSkill.y - fromSkill.y;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                // Use different node offset based on subject
                let nodeOffset;
                if (this.currentSubject === 'Programming' || this.currentSubject === 'Robotics') {
                    nodeOffset = 30;
                } else {
                    nodeOffset = 25;
                }
                
                line.style.cssText += `
                    left: ${fromSkill.x + nodeOffset}px;
                    top: ${fromSkill.y + nodeOffset}px;
                    width: ${length}px;
                    transform: rotate(${angle}deg);
                `;
                
                return line;
            }

            createSkillNode(name, skill) {
                const node = document.createElement('div');
                let className = `skill-node ${skill.type || ''} ${skill.state}`;
                
                // Add special class for root nodes in Programming and Robotics
                if (skill.type === 'root' && (this.currentSubject === 'Programming' || this.currentSubject === 'Robotics')) {
                    className += ' programming';
                }
                
                node.className = className;
                node.dataset.skillName = name;
                
                let displayText = name;
                let maxLength, truncateLength;
                
                // Different text handling based on subject
                if (this.currentSubject === 'Robotics') {
                    maxLength = 12;
                    truncateLength = 10;
                } else if (this.currentSubject === 'Programming') {
                    maxLength = 15;
                    truncateLength = 12;
                } else {
                    maxLength = 12;
                    truncateLength = 10;
                }
                
                if (this.isMobile && name.length > 10) {
                    displayText = name.substring(0, 8) + '...';
                } else if (name.length > maxLength) {
                    displayText = name.substring(0, truncateLength) + '...';
                }
                node.textContent = displayText;
                
                // Adjust node size and font based on subject
                let nodeSize, rootSize, fontSize;
                
                if (this.currentSubject === 'Robotics') {
                    nodeSize = '60px';
                    rootSize = '80px';
                    fontSize = '7px';
                } else if (this.currentSubject === 'Programming') {
                    nodeSize = '60px';
                    rootSize = '90px';
                    fontSize = '8px';
                } else {
                    nodeSize = '50px';
                    rootSize = '80px';
                    fontSize = '8px';
                }
                
                let nodeStyles = `
                    left: ${skill.x}px;
                    top: ${skill.y}px;
                    border-color: ${this.CONSTELLATION_COLORS[skill.constellation] || '#d4af37'};
                    width: ${nodeSize};
                    height: ${nodeSize};
                    font-size: ${fontSize};
                `;
                
                if (skill.type === 'root') {
                    nodeStyles += `
                        width: ${rootSize};
                        height: ${rootSize};
                        font-size: ${this.currentSubject === 'Robotics' ? '9px' : '10px'};
                    `;
                }
                
                node.style.cssText = nodeStyles;

                // Add mastery progress ring for non-locked skills
                if (skill.state !== 'locked' && skill.mastery_score !== undefined) {
                    const masteryRing = this.createMasteryRing(skill.mastery_score);
                    node.appendChild(masteryRing);
                }

                // Add freshness class based on last_practiced
                if (skill.last_practiced) {
                    const daysSince = this.getDaysSincePractice(skill.last_practiced);
                    if (daysSince <= 3) {
                        node.classList.add('fresh');
                    } else if (daysSince > 7 && daysSince <= 14) {
                        node.classList.add('stale');
                    }
                }

                this.setupNodeTouchHandling(node, name);

                return node;
            }

            createMasteryRing(masteryScore) {
                const ring = document.createElement('div');
                ring.className = 'mastery-ring';

                const circumference = 2 * Math.PI * 23; // radius ~23 for 50px node
                const offset = circumference - (masteryScore / 100) * circumference;

                ring.innerHTML = `
                    <svg viewBox="0 0 58 58">
                        <circle class="bg" cx="29" cy="29" r="23" />
                        <circle class="progress" cx="29" cy="29" r="23"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}" />
                    </svg>
                `;

                return ring;
            }

            getDaysSincePractice(lastPracticed) {
                const last = new Date(lastPracticed);
                const now = new Date();
                const diffTime = Math.abs(now - last);
                return Math.floor(diffTime / (1000 * 60 * 60 * 24));
            }

            createConstellationLabel(name, pos) {
                const label = document.createElement('div');
                label.className = 'constellation-label';
                label.textContent = name;
                label.style.cssText = `
                    left: ${pos.x}px;
                    top: ${pos.y}px;
                    color: ${this.CONSTELLATION_COLORS[name]};
                `;
                return label;
            }

            createStars() {
                const starsContainer = document.getElementById('stars');
                if (!starsContainer) return;
                
                starsContainer.innerHTML = '';
                const starCount = this.isMobile ? 150 : 300;
                
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.style.cssText = `
                        position: absolute;
                        width: 2px;
                        height: 2px;
                        background: white;
                        border-radius: 50%;
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        opacity: ${0.3 + Math.random() * 0.4};
                        animation: twinkle ${2 + Math.random() * 2}s infinite;
                    `;
                    starsContainer.appendChild(star);
                }
            }

            updateNodeVisuals(skillName) {
                const node = document.querySelector(`[data-skill-name="${skillName}"]`);
                if (node) {
                    const skill = this.SKILL_TREE[skillName];

                    // Determine effective state based on decay
                    let effectiveState = skill.state;
                    if ((skill.state === 'mastered' || skill.state === 'activated') && skill.last_practiced) {
                        const daysSince = this.getDaysSincePractice(skill.last_practiced);
                        const decayRate = skill.decay_rate || 14;
                        if (daysSince > decayRate) {
                            // Calculate decayed mastery
                            const decayAmount = (daysSince - decayRate) * 5;
                            const effectiveMastery = Math.max(0, (skill.mastery_score || 100) - decayAmount);
                            if (effectiveMastery < 70) {
                                effectiveState = 'needs_review';
                            }
                        }
                    }

                    let className = `skill-node ${skill.type || ''} ${effectiveState}`;

                    // Add programming class for root nodes in Programming and Robotics subjects
                    if (skill.type === 'root' && (this.currentSubject === 'Programming' || this.currentSubject === 'Robotics')) {
                        className += ' programming';
                    }

                    // Add freshness indicators
                    if (skill.last_practiced) {
                        const daysSince = this.getDaysSincePractice(skill.last_practiced);
                        node.classList.remove('fresh', 'stale');
                        if (daysSince <= 3) {
                            className += ' fresh';
                        } else if (daysSince > 7 && daysSince <= 14) {
                            className += ' stale';
                        }
                    }

                    node.className = className;

                    // Update mastery ring if present
                    const existingRing = node.querySelector('.mastery-ring');
                    if (skill.mastery_score !== undefined && skill.state !== 'locked') {
                        if (existingRing) {
                            // Update existing ring
                            const circumference = 2 * Math.PI * 23;
                            const offset = circumference - (skill.mastery_score / 100) * circumference;
                            const progressCircle = existingRing.querySelector('.progress');
                            if (progressCircle) {
                                progressCircle.setAttribute('stroke-dashoffset', offset);
                            }
                        } else {
                            // Add new ring
                            const masteryRing = this.createMasteryRing(skill.mastery_score);
                            node.appendChild(masteryRing);
                        }
                    } else if (existingRing && skill.state === 'locked') {
                        existingRing.remove();
                    }
                }
            }

            updateConnections() {
                const masteredStates = ['activated', 'mastered', 'needs_review'];
                this.connectionElements.forEach(line => {
                    const fromSkill = line.dataset.from;
                    const toSkill = line.dataset.to;
                    const fromMastered = masteredStates.includes(this.SKILL_TREE[fromSkill].state);
                    const toMastered = masteredStates.includes(this.SKILL_TREE[toSkill].state);

                    if (fromMastered && toMastered) {
                        line.classList.add('active');
                    } else {
                        line.classList.remove('active');
                    }
                });
            }

            refreshAllVisuals() {
                Object.keys(this.SKILL_TREE).forEach(skillName => {
                    this.updateNodeVisuals(skillName);
                });
                this.updateConnections();
            }

            initializeSkillTree() {
                if (!this.container) return;
                
                this.container.innerHTML = '<div id="stars"></div>';
                this.connectionElements = [];
                
                // Create connections
                this.CONNECTIONS.forEach(([from, to]) => {
                    const line = this.createConnectionLine(from, to);
                    if (line) {
                        this.container.appendChild(line);
                        this.connectionElements.push(line);
                    }
                });
                
                // Create constellation labels
                Object.entries(this.CONSTELLATION_POSITIONS).forEach(([name, pos]) => {
                    this.container.appendChild(this.createConstellationLabel(name, pos));
                });
                
                // Create skill nodes
                Object.entries(this.SKILL_TREE).forEach(([name, skill]) => {
                    this.container.appendChild(this.createSkillNode(name, skill));
                });
                
                this.createStars();
                this.updateAvailableSkills();
                this.updateConnections();
            }

            // === UTILITY FUNCTIONS ===
            showElement(id) {
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            }

            hideElement(id) {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            }
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            window.skillTreeManager = new MultiSubjectSkillTreeManager();
        });
    </script>
</body>
</html>


