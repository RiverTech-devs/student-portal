<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Math Placement Assessment</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --slate-900: #0f172a; --slate-800: #1e293b; --slate-700: #334155;
            --slate-600: #475569; --slate-400: #94a3b8; --slate-300: #cbd5e1;
            --slate-200: #e2e8f0; --slate-100: #f1f5f9;
            --amber-500: #f59e0b; --amber-400: #fbbf24; --amber-300: #fcd34d;
            --emerald-500: #10b981; --emerald-400: #34d399;
            --rose-500: #f43f5e; --rose-400: #fb7185;
            --indigo-600: #4f46e5; --cyan-500: #06b6d4; --cyan-400: #22d3ee;
            --violet-500: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: linear-gradient(135deg, var(--slate-900), var(--slate-800)); min-height: 100vh; color: var(--slate-100); line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        h1, h2, h3 { font-family: 'Fraunces', serif; font-weight: 600; }
        .header { text-align: center; padding: 3rem 0; border-bottom: 1px solid var(--slate-700); margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--amber-400), var(--amber-300)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header.testing-center h1 { background: linear-gradient(135deg, var(--cyan-400), var(--cyan-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: var(--slate-400); font-size: 1.1rem; }
        .header-badge { display: inline-block; padding: 0.35rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
        .badge-placement { background: var(--amber-500); color: var(--slate-900); }
        .badge-testing { background: var(--cyan-500); color: var(--slate-900); }
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 3rem 0; }
        .mode-card { background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 20px; padding: 2rem; cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
        .mode-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .mode-card.placement::before { background: var(--amber-500); }
        .mode-card.learning::before { background: var(--emerald-500); }
        .mode-card.testing::before { background: var(--cyan-500); }
        .mode-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .mode-card.placement:hover { border-color: var(--amber-500); }
        .mode-card.learning:hover { border-color: var(--emerald-500); }
        .mode-card.testing:hover { border-color: var(--cyan-500); }
        .mode-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .mode-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .mode-card .mode-subtitle { font-weight: 600; margin-bottom: 0.75rem; }
        .mode-card.placement .mode-subtitle { color: var(--amber-400); }
        .mode-card.learning .mode-subtitle { color: var(--emerald-400); }
        .mode-card.testing .mode-subtitle { color: var(--cyan-400); }
        .mode-card .mode-description { color: var(--slate-400); font-size: 0.9rem; }
        .mode-features { margin-top: 1.25rem; text-align: left; }
        .mode-feature { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; color: var(--slate-300); font-size: 0.85rem; }
        .mode-feature .check { color: var(--emerald-400); }
        .level-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 3rem 0; }
        .level-card { background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 16px; padding: 2rem 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .level-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--slate-600); }
        .level-card:hover { border-color: var(--amber-500); transform: translateY(-4px); }
        .level-card:hover::before { background: var(--amber-500); }
        .level-card.selected { border-color: var(--amber-400); background: var(--slate-700); }
        .level-card.selected::before { background: var(--amber-400); }
        .level-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .level-card .grades { color: var(--amber-400); font-weight: 600; margin-bottom: 1rem; }
        .level-card .tiers { color: var(--slate-400); font-size: 0.9rem; }
        .level-card .tier-list { margin-top: 0.75rem; font-size: 0.85rem; color: var(--slate-500); line-height: 1.8; }
        .tier-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 2rem 0; }
        .tier-option { display: flex; align-items: center; padding: 1rem 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
        .tier-option:hover { border-color: var(--slate-500); background: var(--slate-700); }
        .tier-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .tier-option .tier-checkbox { width: 24px; height: 24px; border: 2px solid var(--slate-500); border-radius: 6px; margin-right: 1rem; display: flex; align-items: center; justify-content: center; }
        .tier-option.selected .tier-checkbox { background: var(--cyan-500); border-color: var(--cyan-500); }
        .tier-option.selected .tier-checkbox::after { content: '‚úì'; color: var(--slate-900); font-weight: bold; }
        .tier-option .tier-name { font-weight: 600; color: var(--slate-200); }
        .tier-option .tier-grades { font-size: 0.85rem; color: var(--slate-400); }
        .selection-actions { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .selection-btn { padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--slate-700); border: 1px solid var(--slate-600); border-radius: 6px; color: var(--slate-300); cursor: pointer; }
        .selection-btn:hover { background: var(--slate-600); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 1rem 2.5rem; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--amber-500), var(--amber-400)); color: var(--slate-900); box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-cyan { background: linear-gradient(135deg, var(--cyan-500), var(--cyan-400)); color: var(--slate-900); }
        .btn-cyan:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--slate-700); color: var(--slate-200); border: 1px solid var(--slate-600); }
        .btn-ghost { background: transparent; color: var(--slate-400); padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn-ghost:hover { color: var(--slate-200); }
        .btn-idk { background: var(--slate-600); color: var(--slate-200); border: 2px dashed var(--slate-500); }
        .btn-idk:hover { background: var(--slate-500); border-color: var(--slate-400); }
        .test-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--slate-700); flex-wrap: wrap; gap: 1rem; }
        .test-header.testing-center-header { border-left: 4px solid var(--cyan-500); }
        .progress-info { display: flex; gap: 2rem; }
        .progress-item { text-align: center; }
        .progress-item .label { font-size: 0.8rem; color: var(--slate-400); text-transform: uppercase; }
        .progress-item .value { font-size: 1.5rem; font-weight: 700; color: var(--amber-400); font-family: 'Fraunces', serif; }
        .testing-center-header .progress-item .value { color: var(--cyan-400); }
        .tier-badge { background: var(--slate-700); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
        .tier-badge .tier-name { color: var(--amber-400); font-weight: 600; }
        .testing-center-header .tier-badge .tier-name { color: var(--cyan-400); }
        .question-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; }
        .question-meta { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .question-tag { font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 20px; font-weight: 500; text-transform: uppercase; }
        .tag-tier { background: var(--indigo-600); color: white; }
        .tag-domain { background: var(--slate-700); color: var(--slate-300); }
        .tag-type { background: var(--violet-500); color: white; }
        .tag-probe { background: var(--cyan-500); color: var(--slate-900); }
        .tag-practice { background: var(--emerald-500); color: white; }
        .question-text { font-size: 1.4rem; margin-bottom: 2rem; line-height: 1.5; }
        .answer-options { display: grid; gap: 1rem; }
        .answer-option { display: flex; align-items: center; padding: 1.25rem 1.5rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 1.1rem; }
        .answer-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .answer-option.selected { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .testing-center-mode .answer-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .answer-option .option-letter { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--slate-600); border-radius: 8px; margin-right: 1rem; font-weight: 700; color: var(--slate-300); flex-shrink: 0; }
        .answer-option.selected .option-letter { background: var(--amber-500); color: var(--slate-900); }
        .testing-center-mode .answer-option.selected .option-letter { background: var(--cyan-500); }
        .answer-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .answer-option.correct .option-letter { background: var(--emerald-500); color: white; }
        .answer-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); }
        .answer-option.incorrect .option-letter { background: var(--rose-500); color: white; }
        .timer-bar { height: 4px; background: var(--slate-700); border-radius: 2px; margin-top: 2rem; overflow: hidden; }
        .timer-fill { height: 100%; background: linear-gradient(90deg, var(--emerald-500), var(--amber-400)); border-radius: 2px; transition: width 0.1s linear; }
        .timer-fill.slow { background: linear-gradient(90deg, var(--amber-400), var(--rose-400)); }
        .timer-display { text-align: center; margin-top: 0.5rem; color: var(--slate-400); font-size: 0.9rem; }
        .explanation-box { margin-top: 1.5rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; border-left: 4px solid var(--cyan-500); display: none; }
        .explanation-box.show { display: block; }
        .explanation-box h4 { color: var(--cyan-400); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; }
        .explanation-box p { color: var(--slate-300); }
        .submit-area { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; flex-wrap: wrap; gap: 1rem; }
        .feedback { padding: 1rem 1.5rem; border-radius: 12px; font-weight: 500; display: none; }
        .feedback.show { display: block; }
        .feedback.correct { background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); border: 1px solid var(--emerald-500); }
        .feedback.incorrect { background: rgba(244, 63, 94, 0.15); color: var(--rose-400); border: 1px solid var(--rose-500); }
        .button-group { display: flex; gap: 0.75rem; }
        .tc-stats-bar { display: flex; gap: 1.5rem; padding: 1rem 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--slate-700); flex-wrap: wrap; }
        .tc-stat { display: flex; align-items: center; gap: 0.5rem; }
        .tc-stat .stat-label { color: var(--slate-400); font-size: 0.85rem; }
        .tc-stat .stat-value { color: var(--slate-200); font-weight: 600; }
        .tc-stat .stat-value.good { color: var(--emerald-400); }
        .tc-stat .stat-value.medium { color: var(--amber-400); }
        .tc-stat .stat-value.poor { color: var(--rose-400); }
        .results-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; }
        .results-card h2 { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .placement-result { text-align: center; padding: 3rem; background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border-radius: 16px; margin-bottom: 2rem; border: 2px solid var(--amber-500); }
        .testing-center-results .placement-result { border-color: var(--cyan-500); }
        .placement-result .tier-number { font-size: 5rem; font-weight: 700; font-family: 'Fraunces', serif; background: linear-gradient(135deg, var(--amber-400), var(--amber-300)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .testing-center-results .placement-result .tier-number { background: linear-gradient(135deg, var(--cyan-400), var(--cyan-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .placement-result .tier-title { font-size: 1.8rem; font-family: 'Fraunces', serif; margin-top: 0.5rem; }
        .placement-result .tier-grades { color: var(--slate-400); margin-top: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--slate-700); border-radius: 12px; padding: 1.5rem; text-align: center; }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Fraunces', serif; color: var(--amber-400); }
        .testing-center-results .stat-card .stat-value { color: var(--cyan-400); }
        .stat-card .stat-label { font-size: 0.8rem; color: var(--slate-400); text-transform: uppercase; margin-top: 0.25rem; }
        .fluency-badge { display: inline-block; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 600; margin-top: 1rem; }
        .fluency-automatic { background: var(--emerald-500); color: white; }
        .fluency-normal { background: var(--amber-500); color: var(--slate-900); }
        .fluency-slow { background: var(--rose-500); color: white; }
        .tier-row { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--slate-700); }
        .tier-row:last-child { border-bottom: none; }
        .tier-row .tier-label { width: 180px; font-weight: 500; color: var(--slate-300); }
        .tier-row .tier-bar { flex: 1; height: 24px; background: var(--slate-700); border-radius: 4px; overflow: hidden; margin: 0 1rem; }
        .tier-row .tier-fill { height: 100%; border-radius: 4px; }
        .tier-row .tier-fill.good { background: var(--emerald-500); }
        .tier-row .tier-fill.medium { background: var(--amber-500); }
        .tier-row .tier-fill.poor { background: var(--rose-500); }
        .tier-row .tier-score { width: 60px; text-align: right; font-weight: 600; color: var(--slate-300); }
        .gap-item { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid var(--rose-500); }
        .gap-item.idk { border-left-color: var(--slate-400); }
        .gap-item .gap-tier { background: var(--slate-600); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 1rem; }
        .gap-item .gap-skill { color: var(--slate-300); }
        .no-gaps { color: var(--emerald-400); padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center; }
        .rec-item { display: flex; align-items: flex-start; padding: 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; }
        .rec-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--amber-500); border-radius: 10px; margin-right: 1rem; font-size: 1.2rem; flex-shrink: 0; }
        .testing-center-results .rec-icon { background: var(--cyan-500); }
        .rec-content h4 { font-size: 1rem; margin-bottom: 0.25rem; }
        .rec-content p { color: var(--slate-400); font-size: 0.9rem; }
        .question-history { max-height: 400px; overflow-y: auto; margin-top: 1rem; }
        .history-item { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .history-item .q-number { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 700; margin-right: 1rem; flex-shrink: 0; }
        .history-item.correct .q-number { background: var(--emerald-500); color: white; }
        .history-item.incorrect .q-number { background: var(--rose-500); color: white; }
        .history-item.idk .q-number { background: var(--slate-500); color: white; }
        
        /* Learning Center Styles */
        .header.learning-center h1 { background: linear-gradient(135deg, var(--emerald-400), var(--emerald-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge-learning { background: var(--emerald-500); color: var(--slate-900); }
        .btn-emerald { background: linear-gradient(135deg, var(--emerald-500), var(--emerald-400)); color: var(--slate-900); }
        .btn-emerald:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .tier-select-row { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem; }
        .tier-select-btn { padding: 0.6rem 1rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; color: var(--slate-300); cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .tier-select-btn:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .tier-select-btn.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); }
        
        .skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .skill-card { padding: 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .skill-card:hover { border-color: var(--slate-500); transform: translateY(-2px); }
        .skill-card.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .skill-card .skill-name { font-weight: 600; color: var(--slate-200); margin-bottom: 0.25rem; }
        .skill-card .skill-desc { font-size: 0.8rem; color: var(--slate-400); }
        
        .learning-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--emerald-500); flex-wrap: wrap; gap: 1rem; }
        .learning-progress { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .phase-indicator { display: flex; align-items: center; gap: 0; }
        .phase-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--slate-700); border: 2px solid var(--slate-600); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: var(--slate-400); }
        .phase-dot.active { background: var(--emerald-500); border-color: var(--emerald-500); color: var(--slate-900); }
        .phase-dot.completed { background: var(--emerald-600); border-color: var(--emerald-500); color: white; }
        .phase-line { width: 40px; height: 3px; background: var(--slate-700); }
        .phase-line.completed { background: var(--emerald-500); }
        .phase-labels { display: flex; gap: 2rem; }
        .phase-label { font-size: 0.8rem; color: var(--slate-500); text-transform: uppercase; }
        .phase-label.active { color: var(--emerald-400); font-weight: 600; }
        
        .learning-skill-badge { display: flex; gap: 0.75rem; align-items: center; }
        .learning-skill-badge span:first-child { background: var(--indigo-600); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .learning-skill-badge span:last-child { color: var(--emerald-400); font-weight: 600; font-size: 1.1rem; }
        
        .learning-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; min-height: 400px; }
        .phase-content { display: none; animation: fadeIn 0.4s ease; }
        .phase-content.active { display: block; }
        .phase-content h2 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--emerald-400); }
        .phase-intro { color: var(--slate-400); margin-bottom: 1.5rem; }
        
        .concept-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--slate-700); }
        .concept-text { color: var(--slate-300); font-size: 1.1rem; line-height: 1.7; }
        .concept-text strong { color: var(--emerald-400); }

        /* Step-by-step concept teaching styles */
        .concept-steps { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .concept-step { padding: 1.25rem; background: var(--slate-700); border-radius: 12px; border-left: 4px solid var(--slate-600); opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .concept-step.visible { opacity: 1; transform: translateY(0); border-left-color: var(--emerald-500); }
        .concept-step .step-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .concept-step .step-number { background: var(--emerald-500); color: var(--slate-900); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; }
        .concept-step .step-title { color: var(--emerald-400); font-weight: 600; font-size: 1.05rem; flex: 1; }
        .concept-step .step-read-btn { margin-left: auto; }
        .concept-step .step-explanation { color: var(--slate-300); line-height: 1.6; }
        .concept-step .step-visual { margin-top: 0.75rem; padding: 1rem; background: var(--slate-800); border-radius: 8px; font-family: monospace; color: var(--amber-400); font-size: 1.1rem; text-align: center; }

        .concept-reveal-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: var(--slate-700); border: 2px solid var(--emerald-500); border-radius: 8px; color: var(--emerald-400); cursor: pointer; font-size: 1rem; transition: all 0.2s; margin: 1rem auto; }
        .concept-reveal-btn:hover { background: rgba(16, 185, 129, 0.15); }
        .concept-reveal-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--slate-600); color: var(--slate-500); }
        .concept-reveal-btn .btn-icon { font-size: 1.2rem; }

        .starting-problem { background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border: 2px solid var(--indigo-500); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .starting-problem .problem-label { color: var(--indigo-400); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .starting-problem .problem-text { font-size: 1.4rem; color: var(--slate-100); font-family: monospace; }

        .final-answer { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 2px solid var(--emerald-500); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; opacity: 0; transform: scale(0.95); transition: all 0.4s ease; }
        .final-answer.visible { opacity: 1; transform: scale(1); }
        .final-answer .answer-label { color: var(--emerald-400); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .final-answer .answer-text { font-size: 1.6rem; color: var(--emerald-300); font-family: monospace; font-weight: 700; }
        .final-answer .answer-explanation { color: var(--slate-400); margin-top: 0.5rem; font-size: 0.95rem; }
        
        .example-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--slate-700); }
        .example-section h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .example-problem { font-size: 1.3rem; padding: 1rem 1.5rem; background: var(--slate-700); border-radius: 10px; margin-bottom: 1rem; font-family: 'Source Sans 3', monospace; }
        .example-steps { display: flex; flex-direction: column; gap: 0.75rem; }
        .example-step { display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem 1rem; background: #283548; border-radius: 8px; border-left: 3px solid var(--emerald-500); }
        .example-step .step-num { background: var(--emerald-500); color: var(--slate-900); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
        .example-step .step-content { color: var(--slate-300); }
        .example-step .step-math { font-family: monospace; color: var(--amber-400); margin-top: 0.25rem; }
        
        .key-points { margin-bottom: 2rem; }
        .key-points h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .key-points ul { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .key-points li { padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; color: var(--slate-300); border-left: 3px solid var(--emerald-500); }
        
        .common-mistakes h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .mistake-item { padding: 1rem; background: rgba(244, 63, 94, 0.1); border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--rose-500); }
        .mistake-item .mistake-wrong { color: var(--rose-400); font-weight: 600; margin-bottom: 0.25rem; }
        .mistake-item .mistake-why { color: var(--slate-400); font-size: 0.9rem; }
        
        .practice-problem { font-size: 1.4rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; margin-bottom: 1.5rem; text-align: center; }

        /* New Interactive Guided Phase Styles */
        .guided-problem-card { background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border: 2px solid var(--indigo-500); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .guided-problem-label { color: var(--indigo-400); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .guided-problem { font-size: 1.3rem; color: var(--slate-100); text-align: center; }

        .guided-progress { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--slate-800); border-radius: 8px; }
        .guided-progress .progress-text { color: var(--slate-400); font-size: 0.9rem; }
        .guided-progress .progress-dots { display: flex; gap: 0.5rem; }
        .guided-progress .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--slate-600); transition: all 0.3s; }
        .guided-progress .dot.completed { background: var(--emerald-500); }
        .guided-progress .dot.current { background: var(--amber-400); transform: scale(1.2); }

        .guided-steps-container { min-height: 200px; }
        .guided-completed-steps { margin-bottom: 1rem; }
        .guided-completed-step { padding: 1rem 1.25rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--emerald-500); border-radius: 0 8px 8px 0; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem; }
        .guided-completed-step .step-num { width: 28px; height: 28px; background: var(--emerald-500); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }
        .guided-completed-step .step-content { flex: 1; }
        .guided-completed-step .step-question { color: var(--slate-400); font-size: 0.9rem; }
        .guided-completed-step .step-answer { color: var(--emerald-400); font-weight: 600; font-family: monospace; }

        .guided-current-step-area { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05)); border: 2px solid var(--amber-500); border-radius: 12px; padding: 1.5rem; }
        .step-prompt { font-size: 1.2rem; color: var(--slate-100); margin-bottom: 0.75rem; text-align: center; }
        .step-hint { color: var(--slate-400); font-size: 0.95rem; margin-bottom: 1.25rem; text-align: center; font-style: italic; }

        .guided-input-area { display: flex; gap: 1rem; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem; }
        .guided-input { padding: 0.75rem 1.25rem; font-size: 1.3rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; color: var(--slate-100); width: 180px; text-align: center; font-family: monospace; }
        .guided-input:focus { outline: none; border-color: var(--amber-400); box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2); }
        .guided-submit { padding: 0.75rem 1.5rem; }

        .guided-feedback { padding: 1rem 1.5rem; border-radius: 10px; margin-top: 1rem; display: none; }
        .guided-feedback.show { display: block; animation: slideIn 0.3s ease; }
        .guided-feedback.correct { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--emerald-500); color: var(--emerald-400); }
        .guided-feedback.incorrect { background: rgba(244, 63, 94, 0.15); border: 1px solid var(--rose-500); color: var(--rose-400); }
        .guided-feedback.hint { background: rgba(251, 191, 36, 0.15); border: 1px solid var(--amber-500); color: var(--amber-400); }
        .guided-feedback .mistake-tip { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(244, 63, 94, 0.3); font-size: 0.95rem; }

        .guided-completion { text-align: center; padding: 2rem; }
        .guided-completion .completion-icon { font-size: 3rem; margin-bottom: 1rem; }
        .guided-completion .completion-message { font-size: 1.3rem; color: var(--emerald-400); margin-bottom: 1rem; }
        .final-answer-display { background: rgba(16, 185, 129, 0.15); border: 2px solid var(--emerald-500); border-radius: 12px; padding: 1.25rem; font-size: 1.4rem; color: var(--slate-100); font-family: monospace; }

        .guided-inline-actions { display: flex; justify-content: center; margin-top: 1.5rem; }

        /* Read Aloud Button Styles */
        .read-aloud-btn { background: var(--slate-600); border: 1px solid var(--slate-500); color: var(--slate-300); padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; transition: all 0.2s; }
        .read-aloud-btn:hover { background: var(--slate-500); color: var(--slate-100); }
        .read-aloud-btn.speaking { background: var(--emerald-600); border-color: var(--emerald-500); color: white; animation: pulse 1.5s infinite; }
        .read-aloud-btn .speaker-icon { font-size: 1rem; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .step-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .step-prompt-text { flex: 1; font-size: 1.2rem; color: var(--slate-100); text-align: center; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .practice-feedback { padding: 1rem 1.5rem; border-radius: 10px; margin-top: 1rem; display: none; }
        .practice-feedback.show { display: block; }
        .practice-feedback.correct { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--emerald-500); color: var(--emerald-400); }
        .practice-feedback.incorrect { background: rgba(244, 63, 94, 0.15); border: 1px solid var(--rose-500); color: var(--rose-400); }
        
        .practice-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .practice-option { padding: 1.25rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 12px; cursor: pointer; text-align: center; font-size: 1.2rem; transition: all 0.2s; }
        .practice-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .practice-option.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .practice-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); }
        .practice-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.15); }
        .practice-option.correct-answer { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.2); }
        
        .mistake-analysis { margin-top: 1.5rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; display: none; }
        .mistake-analysis.show { display: block; }
        .mistake-analysis h4 { color: var(--amber-400); margin-bottom: 0.75rem; }
        .mistake-analysis p { color: var(--slate-300); }
        
        .learning-actions { display: flex; justify-content: space-between; margin-top: 2rem; }
        .history-item .q-text { flex: 1; color: var(--slate-300); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item .q-time { margin-left: 1rem; color: var(--slate-500); font-size: 0.85rem; }
        .history-item .q-tier { margin-left: 0.75rem; font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--slate-600); border-radius: 4px; color: var(--slate-400); }
        @media (max-width: 900px) {
            .mode-selector { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .level-selector, .tier-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .test-header { flex-direction: column; }
            .practice-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mode-screen" class="screen active">
            <header class="header"><h1>Math Assessment System</h1><p>K-12 Adaptive Math Evaluation</p></header>
            <h2 style="text-align:center;margin-bottom:1rem;color:var(--slate-200)">Choose Your Mode</h2>
            <p style="text-align:center;color:var(--slate-400);margin-bottom:2rem">Select how you'd like to use the assessment system</p>
            <div class="mode-selector">
                <div class="mode-card placement" onclick="selectMode('placement')">
                    <div class="mode-icon">üìã</div><h3>Placement Test</h3>
                    <div class="mode-subtitle">Formal Assessment</div>
                    <div class="mode-description">Take a structured adaptive test to determine your math level.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">‚úì</span> Adaptive difficulty</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Official placement tier</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Gap analysis report</div>
                        <div class="mode-feature"><span class="check">‚úì</span> ~25 questions</div>
                    </div>
                </div>
                <div class="mode-card learning" onclick="selectMode('learning')">
                    <div class="mode-icon">üìö</div><h3>Learning Center</h3>
                    <div class="mode-subtitle">Guided Instruction</div>
                    <div class="mode-description">Learn new skills step-by-step with guided examples.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">‚úì</span> Concept explanations</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Worked examples</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Guided practice</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Mistake analysis</div>
                    </div>
                </div>
                <div class="mode-card testing" onclick="selectMode('testing')">
                    <div class="mode-icon">üéØ</div><h3>Testing Center</h3>
                    <div class="mode-subtitle">Practice & Explore</div>
                    <div class="mode-description">Practice specific tiers at your own pace with explanations.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">‚úì</span> Choose your tiers</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Unlimited practice</div>
                        <div class="mode-feature"><span class="check">‚úì</span> Detailed explanations</div>
                        <div class="mode-feature"><span class="check">‚úì</span> End anytime</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="placement-setup-screen" class="screen">
            <header class="header"><div class="header-badge badge-placement">Placement Test</div><h1>Math Placement Assessment</h1><p>Adaptive K-12 Evaluation</p></header>
            <h2 style="text-align:center;margin-bottom:1rem;color:var(--slate-200)">Select Starting Level</h2>
            <p style="text-align:center;color:var(--slate-400);margin-bottom:2rem">Choose the level closest to your current ability.</p>
            <div class="level-selector">
                <div class="level-card" onclick="selectLevel(this, 2)"><h3>Elementary</h3><div class="grades">Grades K-4</div><div class="tiers">Starts at Tier 2</div><div class="tier-list">Counting ‚Ä¢ Addition/Subtraction<br>Multiplication ‚Ä¢ Division</div></div>
                <div class="level-card" onclick="selectLevel(this, 5)"><h3>Middle School</h3><div class="grades">Grades 5-8</div><div class="tiers">Starts at Tier 5</div><div class="tier-list">Algebra I ‚Ä¢ Pre-Algebra<br>Equations ‚Ä¢ Functions</div></div>
                <div class="level-card" onclick="selectLevel(this, 7)"><h3>High School</h3><div class="grades">Grades 9-12</div><div class="tiers">Starts at Tier 7</div><div class="tier-list">Algebra II ‚Ä¢ Geometry<br>Pre-Calculus ‚Ä¢ Trigonometry</div></div>
            </div>
            <div style="display:flex;gap:1rem;justify-content:center"><button class="btn btn-ghost" onclick="goToModeSelect()">‚Üê Back</button><button id="start-placement-btn" class="btn btn-primary" onclick="startPlacementTest()" disabled>Begin Placement Test</button></div>
        </div>

        <div id="testing-setup-screen" class="screen">
            <header class="header testing-center"><div class="header-badge badge-testing">Testing Center</div><h1>Practice Mode</h1><p>Select tiers to practice</p></header>
            <div class="testing-mode">
                <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select Tiers to Practice</h2>
                <div class="selection-actions">
                    <button class="selection-btn" onclick="selectAllTiers()">Select All</button>
                    <button class="selection-btn" onclick="clearTierSelection()">Clear All</button>
                    <button class="selection-btn" onclick="selectTierRange(1,2)">Elementary</button>
                    <button class="selection-btn" onclick="selectTierRange(3,5)">Middle</button>
                    <button class="selection-btn" onclick="selectTierRange(6,10)">High</button>
                </div>
                <div class="tier-grid" id="tier-selection-grid"></div>
                <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem"><button class="btn btn-ghost" onclick="goToModeSelect()">‚Üê Back</button><button id="start-testing-btn" class="btn btn-cyan" onclick="startTestingCenter()" disabled>Start Practice</button></div>
            </div>
        </div>

        <div id="learning-setup-screen" class="screen">
            <header class="header learning-center"><div class="header-badge badge-learning">Learning Center</div><h1>Learn a Skill</h1><p>Choose a topic to master</p></header>
            <div class="learning-setup">
                <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select a Tier</h2>
                <div class="tier-select-row" id="learning-tier-select"></div>
                <h2 style="margin:2rem 0 1rem;color:var(--slate-200)">Select a Skill</h2>
                <div class="skill-grid" id="skill-grid"></div>
                <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem"><button class="btn btn-ghost" onclick="goToModeSelect()">‚Üê Back</button><button id="start-learning-btn" class="btn btn-emerald" onclick="startLearning()" disabled>Start Learning</button></div>
            </div>
        </div>

        <div id="learning-screen" class="screen">
            <div class="learning-header">
                <div class="learning-progress">
                    <div class="phase-indicator">
                        <div class="phase-dot active" data-phase="learn">1</div>
                        <div class="phase-line"></div>
                        <div class="phase-dot" data-phase="guided">2</div>
                        <div class="phase-line"></div>
                        <div class="phase-dot" data-phase="practice">3</div>
                    </div>
                    <div class="phase-labels">
                        <span class="phase-label active" data-phase="learn">Learn</span>
                        <span class="phase-label" data-phase="guided">Guided</span>
                        <span class="phase-label" data-phase="practice">Practice</span>
                    </div>
                </div>
                <div class="learning-skill-badge">
                    <span id="learning-tier-badge">Tier 2</span>
                    <span id="learning-skill-name">Addition</span>
                </div>
            </div>

            <div class="learning-card" id="learning-card">
                <!-- Phase 1: Learn (I Do) -->
                <div class="learn-phase phase-content active" id="phase-learn">
                    <div class="concept-section">
                        <h2>üìñ Let's Learn Step by Step</h2>
                        <div class="starting-problem" id="starting-problem">
                            <div class="problem-label">üéØ Our Goal</div>
                            <div class="problem-text" id="goal-problem-text"></div>
                        </div>
                        <div class="concept-steps" id="concept-steps"></div>
                        <div id="reveal-btn-container">
                            <button class="concept-reveal-btn" id="reveal-next-btn" onclick="revealNextConceptStep()">
                                <span class="btn-icon">üëâ</span>
                                <span>Show Next Step</span>
                            </button>
                        </div>
                        <div class="final-answer" id="final-answer">
                            <div class="answer-label">‚úÖ The Answer</div>
                            <div class="answer-text" id="answer-text"></div>
                            <div class="answer-explanation" id="answer-explanation"></div>
                        </div>
                    </div>
                    <div class="key-points" id="key-points-section" style="display:none;">
                        <h3>üí° Key Points to Remember</h3>
                        <ul id="key-points-list"></ul>
                    </div>
                    <div class="common-mistakes" id="mistakes-section" style="display:none;">
                        <h3>‚ö†Ô∏è Common Mistakes to Avoid</h3>
                        <div id="common-mistakes-list"></div>
                    </div>
                </div>

                <!-- Phase 2: Guided Practice (We Do) -->
                <div class="guided-phase phase-content" id="phase-guided">
                    <h2>ü§ù Let's Solve Together</h2>
                    <p class="phase-intro">I'll guide you through each step - you provide the answers!</p>
                    <div class="guided-problem-card" id="guided-problem-card">
                        <div class="guided-problem-label">üìù Your Problem:</div>
                        <div class="guided-problem" id="guided-problem"></div>
                    </div>
                    <div class="guided-progress" id="guided-progress">
                        <span class="progress-text">Step <span id="guided-current-step">1</span> of <span id="guided-total-steps">3</span></span>
                        <div class="progress-dots" id="guided-progress-dots"></div>
                    </div>
                    <div class="guided-steps-container" id="guided-steps-container">
                        <div class="guided-completed-steps" id="guided-completed-steps"></div>
                        <div class="guided-current-step-area" id="guided-current-step-area">
                            <div class="step-prompt" id="guided-step-prompt"></div>
                            <div class="step-hint" id="guided-step-hint"></div>
                            <div class="guided-input-area" id="guided-input-area">
                                <input type="text" class="guided-input" id="guided-answer-input" placeholder="Your answer">
                                <button class="btn btn-emerald guided-submit" onclick="checkGuidedStepAnswer()">Check</button>
                            </div>
                            <div class="guided-feedback" id="guided-feedback"></div>
                        </div>
                    </div>
                    <div class="guided-completion" id="guided-completion" style="display:none;">
                        <div class="completion-icon">üéâ</div>
                        <div class="completion-message">Great job! You completed the guided practice!</div>
                        <div class="final-answer-display" id="guided-final-answer"></div>
                        <div class="guided-inline-actions" id="guided-inline-actions">
                            <button class="btn btn-emerald" onclick="nextLearningPhase()">Continue to Practice ‚Üí</button>
                        </div>
                    </div>
                </div>

                <!-- Phase 3: Independent Practice (You Do) -->
                <div class="practice-phase phase-content" id="phase-practice">
                    <h2>üéØ Now You Try!</h2>
                    <p class="phase-intro">Solve this one on your own.</p>
                    <div class="practice-problem" id="practice-problem"></div>
                    <div class="practice-options" id="practice-options"></div>
                    <div class="practice-feedback" id="practice-feedback"></div>
                    <div class="mistake-analysis" id="mistake-analysis"></div>
                </div>
            </div>

            <div class="learning-actions">
                <button class="btn btn-ghost" onclick="endLearning()">‚Üê Exit</button>
                <button class="btn btn-emerald" id="learning-continue-btn" onclick="nextLearningPhase()">Continue ‚Üí</button>
            </div>
        </div>

        <div id="test-screen" class="screen">
            <div class="test-header" id="test-header">
                <div class="progress-info">
                    <div class="progress-item"><div class="label">Question</div><div class="value" id="question-number">1</div></div>
                    <div class="progress-item"><div class="label">Correct</div><div class="value" id="correct-count">0</div></div>
                </div>
                <div class="tier-badge">Current: <span class="tier-name" id="current-tier-display">Tier 5</span></div>
            </div>
            <div class="tc-stats-bar" id="tc-stats-bar" style="display:none">
                <div class="tc-stat"><span>üìä</span><span class="stat-label">Accuracy:</span><span class="stat-value" id="tc-accuracy">--%</span></div>
                <div class="tc-stat"><span>‚è±Ô∏è</span><span class="stat-label">Avg:</span><span class="stat-value" id="tc-avg-time">--s</span></div>
                <div class="tc-stat"><span>üî•</span><span class="stat-label">Streak:</span><span class="stat-value" id="tc-streak">0</span></div>
            </div>
            <div class="question-card">
                <div class="question-meta" id="question-meta"><span class="question-tag tag-tier" id="tag-tier">Tier 5</span><span class="question-tag tag-domain" id="tag-domain">Algebra</span><span class="question-tag tag-type" id="tag-type">Procedural</span></div>
                <div class="question-text" id="question-text">Loading...</div>
                <div class="answer-options" id="answer-options"></div>
                <div class="explanation-box" id="explanation-box"><h4>üí° Explanation</h4><p id="explanation-text"></p></div>
                <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
                <div class="timer-display" id="timer-display">0.0s</div>
            </div>
            <div class="submit-area">
                <div class="feedback" id="feedback"></div>
                <div class="button-group">
                    <button id="end-session-btn" class="btn btn-secondary" onclick="endTest()" style="display:none">End Session</button>
                    <button id="idk-btn" class="btn btn-idk" onclick="submitIDK()" style="display:none">I Don't Know</button>
                    <button id="submit-btn" class="btn btn-primary" onclick="submitAnswer()" disabled>Submit Answer</button>
                    <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()" style="display:none">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="screen">
            <div class="results-card">
                <h2 id="results-title">Results</h2>
                <div class="placement-result">
                    <div class="tier-number" id="result-tier-number">5</div>
                    <div class="tier-title" id="result-tier-title">Algebra I</div>
                    <div class="tier-grades" id="result-tier-grades">Grades 9-10</div>
                    <div class="fluency-badge fluency-normal" id="fluency-badge">Normal Fluency</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Questions</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-correct">0</div><div class="stat-label">Correct</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-idk">0</div><div class="stat-label">Unknown</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-accuracy">0%</div><div class="stat-label">Accuracy</div></div>
                </div>
            </div>
            <div class="results-card"><h2>Performance by Tier</h2><div class="tier-breakdown" id="tier-breakdown"></div></div>
            <div class="results-card"><h2>Gap Analysis</h2><div id="gap-log"></div></div>
            <div class="results-card"><h2>Recommendations</h2><div class="recommendations" id="recommendations"></div></div>
            <div class="results-card"><h2>Question History</h2><div class="question-history" id="question-history"></div></div>
            <div style="text-align:center;margin-top:2rem"><button class="btn btn-secondary" onclick="goToModeSelect()">‚Üê Back to Menu</button><button class="btn btn-primary" onclick="window.print()" style="margin-left:1rem">Print Results</button></div>
        </div>
    </div>

    <script>
// ========================================
// TIER & DOMAIN DEFINITIONS
// ========================================
const TIERS = {
    1: { name: "Foundations", grades: "K-1", domains: [
        "Counting", "Comparison", "Addition", "Subtraction", "Shapes", "Place Value",
        "Patterns", "Skip Counting", "Number Lines", "Even and Odd", "Ordering Numbers"
    ]},
    2: { name: "Core Operations", grades: "2-4", domains: [
        "Multi-Digit Addition", "Multi-Digit Subtraction", "Multiplication", "Division",
        "Long Division", "Fractions", "Equivalent Fractions", "Mixed Numbers",
        "Word Problems", "Time", "Money", "Rounding", "Estimation", "Measurement",
        "Perimeter", "Arrays and Area Models"
    ]},
    3: { name: "Rational Numbers", grades: "5-7", domains: [
        "Fractions", "Decimals", "Integers", "Percents", "Ratios", "Proportions",
        "Statistics", "Data Collection", "Mean Median Mode", "Unit Conversion",
        "Basic Graphing", "Absolute Value", "Scientific Notation", "Square Roots"
    ]},
    4: { name: "Pre-Algebra", grades: "7-8", domains: [
        "Order of Operations", "Equations", "Exponents", "Slope", "Pythagorean", "Angles and Lines",
        "Algebraic Expressions", "Surface Area", "Two-Way Tables", "Scatter Plots",
        "Box Plots", "Probability Basics"
    ]},
    5: { name: "Algebra I", grades: "8-9", domains: [
        "Linear Equations", "Systems", "Factoring", "Functions", "Inequalities",
        "Radicals", "Exponential Functions", "Arithmetic Sequences", "Geometric Sequences",
        "Compound Interest", "Domain and Range"
    ]},
    6: { name: "Geometry", grades: "9-10", domains: [
        "Area", "Volume", "Triangles", "Circles", "Trigonometry", "Transformations",
        "Similarity", "Congruence", "Proofs", "Law of Sines", "Law of Cosines",
        "Coordinate Geometry"
    ]},
    7: { name: "Algebra II", grades: "10-11", domains: [
        "Quadratics", "Completing the Square", "Logarithms", "Polynomials",
        "Sequences", "Probability", "Conic Sections", "Rational Functions",
        "Piecewise Functions", "Asymptotes", "Permutations", "Combinations",
        "Expected Value"
    ]},
    8: { name: "Pre-Calculus", grades: "11-12", domains: [
        "Trig Functions", "Radian Measure", "Inverse Trig", "Limits",
        "Complex Numbers", "Vectors", "Advanced Functions", "Parametric Equations",
        "Polar Coordinates", "Normal Distribution"
    ]},
    9: { name: "Calculus", grades: "12+", domains: [
        "Derivatives", "Integrals", "Limits", "Applications", "Differential Equations",
        "Chain Rule", "Product Rule", "Integration Techniques"
    ]},
    10: { name: "Advanced", grades: "College", domains: [
        "Partial Derivatives", "Matrices", "Series", "Discrete Math",
        "Multivariable Calculus", "Linear Algebra"
    ]}
};

const QUESTION_TYPES = ["procedural", "conceptual", "reasoning"];

// ========================================
// SKILL TREE COMMUNICATION
// ========================================
// Maps Dogo domain names to Skill Tree skill names
// Most names match exactly; only include those that differ
const SKILL_TREE_MAPPING = {
    // Tier 1 - Foundations
    "Comparison": "Number Comparison",
    "Place Value": "Place Value",
    "Number Lines": "Number Lines",
    "Even and Odd": "Even and Odd",
    "Ordering Numbers": "Ordering Numbers",
    // Tier 2 - Core Operations
    "Multi-Digit Addition": "Multi-Digit Addition",
    "Multi-Digit Subtraction": "Multi-Digit Subtraction",
    "Long Division": "Long Division",
    "Equivalent Fractions": "Equivalent Fractions",
    "Mixed Numbers": "Mixed Numbers",
    "Word Problems": "Word Problems",
    "Arrays and Area Models": "Arrays and Area Models",
    // Tier 3 - Rational Numbers
    "Mean Median Mode": "Mean Median Mode",
    "Data Collection": "Data Collection",
    "Basic Graphing": "Basic Graphing",
    "Unit Conversion": "Unit Conversion",
    "Absolute Value": "Absolute Value",
    "Scientific Notation": "Scientific Notation",
    "Square Roots": "Square Roots",
    // Tier 4 - Pre-Algebra
    "Order of Operations": "Order of Operations",
    "Algebraic Expressions": "Algebraic Expressions",
    "Angles and Lines": "Angles and Lines",
    "Surface Area": "Surface Area",
    "Two-Way Tables": "Two-Way Tables",
    "Scatter Plots": "Scatter Plots",
    "Box Plots": "Box Plots",
    "Probability Basics": "Probability Basics",
    // Tier 5 - Algebra I
    "Linear Equations": "Linear Equations",
    "Exponential Functions": "Exponential Functions",
    "Arithmetic Sequences": "Arithmetic Sequences",
    "Geometric Sequences": "Geometric Sequences",
    "Compound Interest": "Compound Interest",
    "Domain and Range": "Domain and Range",
    // Tier 6 - Geometry
    "Law of Sines": "Law of Sines",
    "Law of Cosines": "Law of Cosines",
    "Coordinate Geometry": "Coordinate Geometry",
    // Tier 7 - Algebra II
    "Completing the Square": "Completing the Square",
    "Conic Sections": "Conic Sections",
    "Rational Functions": "Rational Functions",
    "Piecewise Functions": "Piecewise Functions",
    "Expected Value": "Expected Value",
    // Tier 8 - Pre-Calculus
    "Trig Functions": "Trig Functions",
    "Radian Measure": "Radian Measure",
    "Inverse Trig": "Inverse Trig",
    "Advanced Functions": "Advanced Functions",
    "Parametric Equations": "Parametric Equations",
    "Polar Coordinates": "Polar Coordinates",
    "Normal Distribution": "Normal Distribution",
    // Tier 9 - Calculus
    "Differential Equations": "Differential Equations",
    "Chain Rule": "Chain Rule",
    "Product Rule": "Product Rule",
    "Integration Techniques": "Integration Techniques",
    // Tier 10 - Advanced
    "Partial Derivatives": "Partial Derivatives",
    "Multivariable Calculus": "Multivariable Calculus",
    "Linear Algebra": "Linear Algebra",
    "Discrete Math": "Discrete Math"
};

// Get the Skill Tree skill name for a Dogo domain
function getSkillTreeName(domain) {
    return SKILL_TREE_MAPPING[domain] || domain;
}

// Send progress update to parent window (portal)
function sendSkillProgress(domain, tier, correct, total, time) {
    if (!window.parent || window.parent === window) return;

    const skillName = getSkillTreeName(domain);
    const masteryScore = total > 0 ? Math.round((correct / total) * 100) : 0;

    // Determine skill state based on mastery
    let skillState = 'in_progress';
    if (masteryScore >= 80 && total >= 3) {
        skillState = 'mastered';
    } else if (masteryScore >= 60 && total >= 2) {
        skillState = 'activated';
    }

    window.parent.postMessage({
        type: 'DOGO_SKILL_PROGRESS',
        skill: skillName,
        domain: domain,
        tier: tier,
        correct: correct,
        total: total,
        masteryScore: masteryScore,
        averageTime: time,
        skillState: skillState,
        timestamp: Date.now()
    }, '*');
}

// Send session results when test/learning ends
function sendSessionResults() {
    if (!window.parent || window.parent === window) return;

    const skillProgress = [];

    // Compile all domain scores into skill progress
    for (let t = 1; t <= 10; t++) {
        const domains = state.domainScores[t];
        if (!domains) continue;

        for (const [domain, scores] of Object.entries(domains)) {
            if (scores.total > 0) {
                const skillName = getSkillTreeName(domain);
                const masteryScore = Math.round((scores.correct / scores.total) * 100);

                let skillState = 'in_progress';
                if (masteryScore >= 80 && scores.total >= 3) {
                    skillState = 'mastered';
                } else if (masteryScore >= 60 && scores.total >= 2) {
                    skillState = 'activated';
                }

                skillProgress.push({
                    skill: skillName,
                    domain: domain,
                    tier: t,
                    correct: scores.correct,
                    total: scores.total,
                    masteryScore: masteryScore,
                    skillState: skillState
                });
            }
        }
    }

    window.parent.postMessage({
        type: 'DOGO_SESSION_COMPLETE',
        mode: state.mode,
        skillProgress: skillProgress,
        gapLog: state.gapLog.map(g => ({
            ...g,
            skill: getSkillTreeName(g.domain)
        })),
        history: state.history,
        timestamp: Date.now()
    }, '*');
}

// Request initial skill data from parent (for showing unlocked skills)
function requestSkillData() {
    if (!window.parent || window.parent === window) return;

    window.parent.postMessage({
        type: 'DOGO_REQUEST_SKILL_DATA'
    }, '*');
}

// Listen for skill data from parent
window.addEventListener('message', (event) => {
    if (event.data.type === 'SKILL_DATA_FOR_DOGO') {
        // Could use this to show which skills are already mastered
        // or to unlock certain tiers based on skill tree progress
        console.log('Received skill data from parent:', event.data);
    }
});

// ========================================
// UTILITY FUNCTIONS
// ========================================
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const pick = arr => arr[rand(0, arr.length - 1)];
const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
const simplifyFrac = (n, d) => { const g = gcd(Math.abs(n), Math.abs(d)); return [n/g, d/g]; };

function generateDistractors(correct, count = 3, variance = null) {
    const distractors = new Set();
    const v = variance || Math.max(Math.abs(correct) * 0.5, 2);
    while (distractors.size < count) {
        let d;
        const strategy = rand(0, 3);
        if (strategy === 0) d = correct + rand(1, Math.ceil(v));
        else if (strategy === 1) d = correct - rand(1, Math.ceil(v));
        else if (strategy === 2) d = correct * 2;
        else d = Math.abs(correct - rand(1, Math.ceil(v)));
        if (d !== correct && !distractors.has(d)) distractors.add(d);
    }
    return Array.from(distractors);
}

function formatNumber(n) {
    if (Number.isInteger(n)) return n.toString();
    return parseFloat(n.toFixed(3)).toString();
}

// ========================================
// QUESTION GENERATORS BY TIER
// ========================================
const generators = {
    // TIER 1: Foundations (K-1)
    1: {
        Counting: () => {
            const type = pick(["after", "before", "count"]);
            if (type === "after") {
                const n = rand(1, 18);
                return { question: `What number comes after ${n}?`, answer: n + 1, type: "procedural",
                    explanation: `When counting up, the next number after ${n} is ${n + 1}.` };
            } else if (type === "before") {
                const n = rand(2, 19);
                return { question: `What number comes before ${n}?`, answer: n - 1, type: "procedural",
                    explanation: `When counting, the number before ${n} is ${n - 1}.` };
            } else {
                const n = rand(3, 8);
                const stars = "‚òÖ ".repeat(n).trim();
                return { question: `Count the stars: ${stars}`, answer: n, type: "procedural",
                    explanation: `Counting each star: there are ${n} stars.` };
            }
        },
        Comparison: () => {
            const a = rand(1, 20), b = rand(1, 20);
            while (a === b) b = rand(1, 20);
            const answer = a > b ? a : b;
            return { question: `Which is larger: ${a} or ${b}?`, answer, type: "conceptual",
                options: [a, b], explanation: `${answer} is larger because it comes later when counting.` };
        },
        Addition: () => {
            const a = rand(1, 9), b = rand(1, 9);
            return { question: `What is ${a} + ${b}?`, answer: a + b, type: "procedural",
                explanation: `${a} + ${b} = ${a + b}. You can count up ${b} from ${a}.` };
        },
        Subtraction: () => {
            const a = rand(5, 15), b = rand(1, a - 1);
            return { question: `What is ${a} - ${b}?`, answer: a - b, type: "procedural",
                explanation: `${a} - ${b} = ${a - b}. You can count back ${b} from ${a}.` };
        },
        Shapes: () => {
            const shapes = [
                { name: "triangle", sides: 3 }, { name: "square", sides: 4 },
                { name: "pentagon", sides: 5 }, { name: "hexagon", sides: 6 }
            ];
            const shape = pick(shapes);
            return { question: `How many sides does a ${shape.name} have?`, answer: shape.sides, type: "conceptual",
                explanation: `A ${shape.name} has ${shape.sides} sides.` };
        },
        "Place Value": () => {
            const type = pick(["tens", "ones", "identify"]);
            if (type === "tens") {
                const tens = rand(1, 9);
                const ones = rand(0, 9);
                const num = tens * 10 + ones;
                return { question: `In the number ${num}, what digit is in the tens place?`, answer: tens, type: "conceptual",
                    explanation: `In ${num}, the ${tens} is in the tens place (worth ${tens * 10}).` };
            } else if (type === "ones") {
                const tens = rand(1, 9);
                const ones = rand(0, 9);
                const num = tens * 10 + ones;
                return { question: `In the number ${num}, what digit is in the ones place?`, answer: ones, type: "conceptual",
                    explanation: `In ${num}, the ${ones} is in the ones place.` };
            } else {
                const tens = rand(2, 5);
                const ones = rand(1, 5);
                return { question: `What number has ${tens} tens and ${ones} ones?`, answer: tens * 10 + ones, type: "procedural",
                    explanation: `${tens} tens = ${tens * 10}, plus ${ones} ones = ${tens * 10 + ones}.` };
            }
        },
        Patterns: () => {
            const type = pick(["number", "shape"]);
            if (type === "number") {
                const start = rand(1, 5);
                const step = pick([1, 2, 3]);
                const seq = [start, start + step, start + 2 * step, start + 3 * step];
                const answer = start + 4 * step;
                return { question: `What comes next? ${seq.join(", ")}, ?`, answer, type: "reasoning",
                    explanation: `The pattern adds ${step} each time. ${seq[3]} + ${step} = ${answer}` };
            } else {
                const patterns = [
                    { seq: "‚óã ‚óè ‚óã ‚óè ‚óã ?", answer: "‚óè", exp: "The pattern alternates: circle, filled circle" },
                    { seq: "‚ñ° ‚ñ° ‚ñ≥ ‚ñ° ‚ñ° ‚ñ≥ ‚ñ° ‚ñ° ?", answer: "‚ñ≥", exp: "The pattern is: square, square, triangle (repeating)" },
                    { seq: "‚òÖ ‚óã ‚óã ‚òÖ ‚óã ‚óã ‚òÖ ?", answer: "‚óã", exp: "The pattern is: star, circle, circle (repeating)" }
                ];
                const p = pick(patterns);
                return { question: `What comes next? ${p.seq}`, answer: p.answer, type: "reasoning",
                    options: ["‚óã", "‚óè", "‚ñ°", "‚ñ≥", "‚òÖ"].slice(0, 4), explanation: p.exp };
            }
        },
        "Skip Counting": () => {
            const by = pick([2, 5, 10]);
            const start = by * rand(1, 3);
            const seq = [start, start + by, start + 2 * by, start + 3 * by];
            const answer = start + 4 * by;
            return { question: `Count by ${by}s: ${seq.join(", ")}, ?`, answer, type: "procedural",
                explanation: `Counting by ${by}s: add ${by} each time. ${seq[3]} + ${by} = ${answer}` };
        },
        "Number Lines": () => {
            const type = pick(["locate", "jump", "between"]);
            if (type === "locate") {
                const n = rand(0, 20);
                return { question: `On a number line from 0 to 20, where would ${n} be?`, answer: n, type: "conceptual",
                    explanation: `${n} is located ${n} units from 0 on the number line.` };
            } else if (type === "jump") {
                const start = rand(2, 10);
                const jump = rand(2, 5);
                return { question: `Start at ${start} on the number line. Jump forward ${jump}. Where are you?`, answer: start + jump, type: "procedural",
                    explanation: `${start} + ${jump} = ${start + jump}. Moving right on a number line means adding.` };
            } else {
                const a = rand(1, 8), b = a + 2;
                return { question: `What number is between ${a} and ${b} on the number line?`, answer: a + 1, type: "conceptual",
                    explanation: `${a + 1} comes right after ${a} and right before ${b}.` };
            }
        },
        "Even and Odd": () => {
            const type = pick(["identify", "next"]);
            if (type === "identify") {
                const n = rand(1, 20);
                const isEven = n % 2 === 0;
                return { question: `Is ${n} even or odd?`, answer: isEven ? "even" : "odd", type: "conceptual",
                    options: ["even", "odd"],
                    explanation: `${n} is ${isEven ? "even" : "odd"} because it ${isEven ? "can" : "cannot"} be divided into 2 equal groups.` };
            } else {
                const n = rand(2, 18);
                const isEven = n % 2 === 0;
                const nextSame = isEven ? n + 2 : n + 2;
                return { question: `What is the next ${isEven ? "even" : "odd"} number after ${n}?`, answer: nextSame, type: "procedural",
                    explanation: `${isEven ? "Even" : "Odd"} numbers are 2 apart. ${n} + 2 = ${nextSame}` };
            }
        },
        "Ordering Numbers": () => {
            const nums = [rand(1, 20), rand(1, 20), rand(1, 20)];
            while (nums[1] === nums[0]) nums[1] = rand(1, 20);
            while (nums[2] === nums[0] || nums[2] === nums[1]) nums[2] = rand(1, 20);
            const sorted = [...nums].sort((a, b) => a - b);
            const type = pick(["smallest", "largest", "middle"]);
            if (type === "smallest") {
                return { question: `Which is smallest: ${nums.join(", ")}?`, answer: sorted[0], type: "conceptual",
                    options: nums, explanation: `${sorted[0]} is the smallest because it comes first when counting.` };
            } else if (type === "largest") {
                return { question: `Which is largest: ${nums.join(", ")}?`, answer: sorted[2], type: "conceptual",
                    options: nums, explanation: `${sorted[2]} is the largest because it comes last when counting.` };
            } else {
                return { question: `Put in order from least to greatest: ${nums.join(", ")}`, answer: sorted.join(", "), type: "procedural",
                    explanation: `Ordered: ${sorted.join(" < ")}` };
            }
        }
    },

    // TIER 2: Core Operations (2-4)
    2: {
        "Multi-Digit Addition": () => {
            const a = rand(100, 999), b = rand(100, 999);
            return { question: `What is ${a} + ${b}?`, answer: a + b, type: "procedural",
                explanation: `Add ones, then tens, then hundreds. Carry when needed. ${a} + ${b} = ${a + b}` };
        },
        "Multi-Digit Subtraction": () => {
            const a = rand(200, 999), b = rand(100, a - 50);
            return { question: `What is ${a} - ${b}?`, answer: a - b, type: "procedural",
                explanation: `Subtract ones, tens, hundreds. Borrow when needed. ${a} - ${b} = ${a - b}` };
        },
        Multiplication: () => {
            const a = rand(2, 12), b = rand(2, 12);
            return { question: `What is ${a} √ó ${b}?`, answer: a * b, type: "procedural",
                explanation: `${a} √ó ${b} = ${a * b}. This means ${a} groups of ${b}.` };
        },
        Division: () => {
            const b = rand(2, 12), answer = rand(2, 12);
            const a = b * answer;
            return { question: `What is ${a} √∑ ${b}?`, answer, type: "procedural",
                explanation: `${a} √∑ ${b} = ${answer} because ${b} √ó ${answer} = ${a}.` };
        },
        "Long Division": () => {
            const divisor = rand(2, 9);
            const quotient = rand(10, 30);
            const remainder = rand(0, divisor - 1);
            const dividend = divisor * quotient + remainder;
            if (remainder === 0) {
                return { question: `What is ${dividend} √∑ ${divisor}?`, answer: quotient, type: "procedural",
                    explanation: `${dividend} √∑ ${divisor} = ${quotient} with no remainder.` };
            } else {
                return { question: `${dividend} √∑ ${divisor} = ? R ?`, answer: `${quotient} R ${remainder}`, type: "procedural",
                    options: [`${quotient} R ${remainder}`, `${quotient + 1} R ${remainder}`, `${quotient} R ${remainder + 1}`, `${quotient - 1} R ${divisor}`],
                    explanation: `${dividend} = ${divisor} √ó ${quotient} + ${remainder}, so ${dividend} √∑ ${divisor} = ${quotient} R ${remainder}` };
            }
        },
        Fractions: () => {
            const d = pick([2, 3, 4, 5, 6, 8]);
            const n = rand(1, d - 1);
            const compare = rand(0, 1);
            if (compare) {
                const d2 = d, n2 = rand(1, d - 1);
                while (n2 === n) n2 = rand(1, d - 1);
                const larger = n > n2 ? `${n}/${d}` : `${n2}/${d2}`;
                return { question: `Which is larger: ${n}/${d} or ${n2}/${d2}?`, answer: larger, type: "conceptual",
                    options: [`${n}/${d}`, `${n2}/${d2}`],
                    explanation: `With same denominator, the larger numerator means larger fraction. ${larger} is larger.` };
            }
            return { question: `What fraction equals ${n} out of ${d} parts?`, answer: `${n}/${d}`, type: "conceptual",
                options: [`${n}/${d}`, `${d}/${n}`, `${n}/${d+1}`, `${n-1}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                explanation: `${n} out of ${d} parts = ${n}/${d}` };
        },
        "Equivalent Fractions": () => {
            const n = rand(1, 4), d = rand(n + 1, 6);
            const mult = rand(2, 4);
            return { question: `What fraction is equivalent to ${n}/${d}? (multiply by ${mult})`, answer: `${n * mult}/${d * mult}`, type: "procedural",
                options: [`${n * mult}/${d * mult}`, `${n + mult}/${d + mult}`, `${n * mult}/${d}`, `${n}/${d * mult}`],
                explanation: `Multiply both numerator and denominator by ${mult}: ${n}√ó${mult}/${d}√ó${mult} = ${n * mult}/${d * mult}` };
        },
        "Mixed Numbers": () => {
            const whole = rand(1, 5), n = rand(1, 3), d = rand(n + 1, 5);
            const improper = whole * d + n;
            const type = pick(["toImproper", "toMixed"]);
            if (type === "toImproper") {
                return { question: `Convert ${whole} ${n}/${d} to an improper fraction.`, answer: `${improper}/${d}`, type: "procedural",
                    options: [`${improper}/${d}`, `${whole + n}/${d}`, `${whole * n}/${d}`, `${n}/${whole * d}`],
                    explanation: `${whole} √ó ${d} + ${n} = ${improper}, so ${whole} ${n}/${d} = ${improper}/${d}` };
            } else {
                return { question: `Convert ${improper}/${d} to a mixed number.`, answer: `${whole} ${n}/${d}`, type: "procedural",
                    options: [`${whole} ${n}/${d}`, `${whole + 1} ${n}/${d}`, `${whole} ${n + 1}/${d}`, `${improper - d} ${n}/${d}`],
                    explanation: `${improper} √∑ ${d} = ${whole} R ${n}, so ${improper}/${d} = ${whole} ${n}/${d}` };
            }
        },
        "Word Problems": () => {
            const templates = [
                () => { const a = rand(10, 30), b = rand(5, 15); return { q: `Sam has ${a} apples and buys ${b} more. How many total?`, ans: a + b, exp: `${a} + ${b} = ${a + b} apples` }; },
                () => { const a = rand(20, 50), b = rand(5, 15); return { q: `Maria has ${a} stickers and gives ${b} away. How many left?`, ans: a - b, exp: `${a} - ${b} = ${a - b} stickers` }; },
                () => { const a = rand(3, 8), b = rand(4, 10); return { q: `${a} bags with ${b} marbles each. How many total?`, ans: a * b, exp: `${a} √ó ${b} = ${a * b} marbles` }; }
            ];
            const t = pick(templates)();
            return { question: t.q, answer: t.ans, type: "reasoning", explanation: t.exp };
        },
        Time: () => {
            const type = pick(["read", "elapsed", "convert"]);
            if (type === "read") {
                const hour = rand(1, 12);
                const min = pick([0, 15, 30, 45]);
                return { question: `What time is it when the hour hand points to ${hour} and minute hand points to ${min === 0 ? 12 : min / 5}?`,
                    answer: `${hour}:${min.toString().padStart(2, '0')}`, type: "procedural",
                    options: [`${hour}:${min.toString().padStart(2, '0')}`, `${hour}:${((min + 15) % 60).toString().padStart(2, '0')}`, `${(hour % 12) + 1}:${min.toString().padStart(2, '0')}`, `${hour}:${((min + 30) % 60).toString().padStart(2, '0')}`],
                    explanation: `Hour hand at ${hour}, minute hand at ${min === 0 ? 12 : min / 5} means ${hour}:${min.toString().padStart(2, '0')}` };
            } else if (type === "elapsed") {
                const start = rand(1, 10);
                const elapsed = pick([1, 2, 3]);
                const end = start + elapsed;
                return { question: `It's ${start}:00. What time will it be in ${elapsed} hour${elapsed > 1 ? 's' : ''}?`, answer: `${end}:00`, type: "procedural",
                    options: [`${end}:00`, `${start + elapsed - 1}:00`, `${start}:${elapsed}0`, `${end + 1}:00`],
                    explanation: `${start}:00 + ${elapsed} hours = ${end}:00` };
            } else {
                const hours = rand(1, 3);
                const minutes = hours * 60;
                return { question: `How many minutes are in ${hours} hour${hours > 1 ? 's' : ''}?`, answer: minutes, type: "procedural",
                    explanation: `1 hour = 60 minutes. ${hours} hours = ${hours} √ó 60 = ${minutes} minutes` };
            }
        },
        Money: () => {
            const type = pick(["count", "add", "change"]);
            if (type === "count") {
                const quarters = rand(0, 4);
                const dimes = rand(0, 5);
                const nickels = rand(0, 4);
                const total = quarters * 25 + dimes * 10 + nickels * 5;
                return { question: `${quarters} quarter${quarters !== 1 ? 's' : ''}, ${dimes} dime${dimes !== 1 ? 's' : ''}, ${nickels} nickel${nickels !== 1 ? 's' : ''}. How many cents?`,
                    answer: total, type: "procedural",
                    explanation: `${quarters}√ó25¬¢ + ${dimes}√ó10¬¢ + ${nickels}√ó5¬¢ = ${quarters*25} + ${dimes*10} + ${nickels*5} = ${total}¬¢` };
            } else if (type === "add") {
                const a = rand(10, 50);
                const b = rand(10, 40);
                return { question: `$0.${a.toString().padStart(2, '0')} + $0.${b.toString().padStart(2, '0')} = ?`, answer: `$${((a + b) / 100).toFixed(2)}`, type: "procedural",
                    options: [`$${((a + b) / 100).toFixed(2)}`, `$${((a + b + 10) / 100).toFixed(2)}`, `$${((a + b - 10) / 100).toFixed(2)}`, `$${(a + b)}`],
                    explanation: `${a}¬¢ + ${b}¬¢ = ${a + b}¬¢ = $${((a + b) / 100).toFixed(2)}` };
            } else {
                const price = rand(1, 5) * 10;
                const paid = 100;
                const change = paid - price;
                return { question: `Item costs ${price}¬¢. You pay $1.00. How much change?`, answer: `${change}¬¢`, type: "procedural",
                    options: [`${change}¬¢`, `${change + 10}¬¢`, `${change - 10}¬¢`, `${price}¬¢`],
                    explanation: `100¬¢ - ${price}¬¢ = ${change}¬¢` };
            }
        },
        Rounding: () => {
            const type = pick(["tens", "hundreds"]);
            if (type === "tens") {
                const num = rand(11, 99);
                const rounded = Math.round(num / 10) * 10;
                return { question: `Round ${num} to the nearest ten.`, answer: rounded, type: "procedural",
                    explanation: `${num} is closer to ${rounded} than ${rounded < num ? rounded - 10 : rounded + 10}. Rounded: ${rounded}` };
            } else {
                const num = rand(101, 999);
                const rounded = Math.round(num / 100) * 100;
                return { question: `Round ${num} to the nearest hundred.`, answer: rounded, type: "procedural",
                    explanation: `${num} rounds to ${rounded} (look at the tens digit: ${Math.floor((num % 100) / 10)})` };
            }
        },
        Measurement: () => {
            const type = pick(["length", "compare", "estimate"]);
            if (type === "length") {
                const inches = rand(12, 36);
                const feet = Math.floor(inches / 12);
                const remainInches = inches % 12;
                return { question: `${inches} inches = ? feet and ? inches`, answer: `${feet} ft ${remainInches} in`, type: "procedural",
                    options: [`${feet} ft ${remainInches} in`, `${feet + 1} ft ${remainInches} in`, `${feet} ft ${remainInches + 1} in`, `${remainInches} ft ${feet} in`],
                    explanation: `${inches} √∑ 12 = ${feet} remainder ${remainInches}. So ${feet} feet and ${remainInches} inches.` };
            } else if (type === "compare") {
                const items = [
                    { name: "pencil", length: "about 7 inches" },
                    { name: "your foot", length: "about 1 foot" },
                    { name: "door", length: "about 7 feet" },
                    { name: "car", length: "about 15 feet" }
                ];
                const item = pick(items);
                return { question: `About how long is a ${item.name}?`, answer: item.length, type: "conceptual",
                    options: ["about 7 inches", "about 1 foot", "about 7 feet", "about 15 feet"],
                    explanation: `A ${item.name} is ${item.length} long.` };
            } else {
                const cm = rand(2, 10) * 10;
                const inches = Math.round(cm / 2.54);
                return { question: `About how many inches is ${cm} centimeters? (1 inch ‚âà 2.5 cm)`, answer: inches, type: "procedural",
                    explanation: `${cm} √∑ 2.5 ‚âà ${inches} inches` };
            }
        },
        Estimation: () => {
            const type = pick(["round_add", "round_mult", "estimate_count"]);
            if (type === "round_add") {
                const a = rand(18, 89), b = rand(18, 89);
                const roundA = Math.round(a / 10) * 10, roundB = Math.round(b / 10) * 10;
                const estimate = roundA + roundB;
                return { question: `Estimate ${a} + ${b} by rounding to the nearest ten.`, answer: estimate, type: "procedural",
                    options: [estimate, estimate + 10, estimate - 10, a + b],
                    explanation: `${a} ‚âà ${roundA}, ${b} ‚âà ${roundB}. Estimate: ${roundA} + ${roundB} = ${estimate}` };
            } else if (type === "round_mult") {
                const a = rand(3, 9), b = rand(18, 52);
                const roundB = Math.round(b / 10) * 10;
                const estimate = a * roundB;
                return { question: `Estimate ${a} √ó ${b} by rounding ${b} to the nearest ten.`, answer: estimate, type: "procedural",
                    options: [estimate, a * b, estimate + 10, estimate - 10],
                    explanation: `${b} ‚âà ${roundB}. Estimate: ${a} √ó ${roundB} = ${estimate}` };
            } else {
                const items = pick(["jelly beans in a jar", "students in a school", "pages in a book", "apples in a basket"]);
                const actual = pick([47, 123, 256, 89, 312]);
                const estimates = [Math.round(actual / 10) * 10, Math.round(actual / 50) * 50, Math.round(actual / 100) * 100, actual * 2];
                const closest = estimates.reduce((a, b) => Math.abs(a - actual) < Math.abs(b - actual) ? a : b);
                return { question: `There are about ${closest} ${items}. Which is the best estimate?`, answer: closest, type: "reasoning",
                    options: estimates.sort(() => Math.random() - 0.5),
                    explanation: `${closest} is a reasonable estimate for the ${items}.` };
            }
        },
        Perimeter: () => {
            const type = pick(["rectangle", "square", "triangle"]);
            if (type === "rectangle") {
                const length = rand(5, 15), width = rand(3, 10);
                const perimeter = 2 * (length + width);
                return { question: `Find the perimeter of a rectangle with length ${length} and width ${width}.`, answer: perimeter, type: "procedural",
                    explanation: `Perimeter = 2 √ó (length + width) = 2 √ó (${length} + ${width}) = 2 √ó ${length + width} = ${perimeter}` };
            } else if (type === "square") {
                const side = rand(4, 12);
                const perimeter = 4 * side;
                return { question: `Find the perimeter of a square with side length ${side}.`, answer: perimeter, type: "procedural",
                    explanation: `Perimeter = 4 √ó side = 4 √ó ${side} = ${perimeter}` };
            } else {
                const a = rand(3, 8), b = rand(4, 10), c = rand(5, 12);
                const perimeter = a + b + c;
                return { question: `Find the perimeter of a triangle with sides ${a}, ${b}, and ${c}.`, answer: perimeter, type: "procedural",
                    explanation: `Perimeter = ${a} + ${b} + ${c} = ${perimeter}` };
            }
        },
        "Arrays and Area Models": () => {
            const type = pick(["array", "area_model"]);
            if (type === "array") {
                const rows = rand(2, 6), cols = rand(3, 8);
                const total = rows * cols;
                return { question: `An array has ${rows} rows and ${cols} columns. How many total?`, answer: total, type: "conceptual",
                    explanation: `Arrays show multiplication: ${rows} rows √ó ${cols} columns = ${total}` };
            } else {
                const tens = rand(1, 3) * 10, ones = rand(2, 8);
                const mult = rand(2, 5);
                const total = (tens + ones) * mult;
                return { question: `Use area model: ${tens + ones} √ó ${mult} = (${tens} √ó ${mult}) + (${ones} √ó ${mult}) = ?`, answer: total, type: "procedural",
                    explanation: `Break apart: ${tens} √ó ${mult} = ${tens * mult}, ${ones} √ó ${mult} = ${ones * mult}. Total: ${tens * mult} + ${ones * mult} = ${total}` };
            }
        }
    },

    // TIER 3: Rational Numbers (5-7)
    3: {
        Fractions: () => {
            const ops = ["+", "-", "√ó", "√∑"];
            const op = pick(ops);
            const d = pick([2, 3, 4, 5, 6]);
            const n1 = rand(1, d * 2), n2 = rand(1, d);
            let answer, explanation;
            if (op === "+") { answer = `${n1 + n2}/${d}`; explanation = `${n1}/${d} + ${n2}/${d} = ${n1 + n2}/${d}`; }
            else if (op === "-") { const big = Math.max(n1, n2), sm = Math.min(n1, n2); answer = `${big - sm}/${d}`; explanation = `${big}/${d} - ${sm}/${d} = ${big - sm}/${d}`; return { question: `What is ${big}/${d} - ${sm}/${d}?`, answer, type: "procedural", explanation }; }
            else if (op === "√ó") { const [sn, sd] = simplifyFrac(n1 * n2, d * d); answer = sd === 1 ? `${sn}` : `${sn}/${sd}`; explanation = `Multiply tops and bottoms: ${n1}√ó${n2}/${d}√ó${d} = ${n1*n2}/${d*d} = ${answer}`; }
            else { answer = formatNumber(n1 / n2); explanation = `${n1}/${d} √∑ ${n2}/${d} = ${n1}/${d} √ó ${d}/${n2} = ${n1}/${n2} = ${answer}`; }
            return { question: `What is ${n1}/${d} ${op} ${n2}/${d}?`, answer, type: "procedural", explanation };
        },
        Decimals: () => {
            const a = (rand(10, 99) / 10).toFixed(1), b = (rand(10, 99) / 10).toFixed(1);
            const op = pick(["+", "-", "√ó"]);
            let answer;
            if (op === "+") answer = (parseFloat(a) + parseFloat(b)).toFixed(2);
            else if (op === "-") { const big = Math.max(a, b), sm = Math.min(a, b); answer = (big - sm).toFixed(2); return { question: `What is ${big} - ${sm}?`, answer: parseFloat(answer), type: "procedural", explanation: `${big} - ${sm} = ${answer}` }; }
            else answer = (parseFloat(a) * parseFloat(b)).toFixed(2);
            return { question: `What is ${a} ${op} ${b}?`, answer: parseFloat(answer), type: "procedural",
                explanation: `${a} ${op} ${b} = ${answer}` };
        },
        Integers: () => {
            const a = rand(-15, 15), b = rand(-15, 15);
            const op = pick(["+", "-", "√ó"]);
            let answer;
            if (op === "+") answer = a + b;
            else if (op === "-") answer = a - b;
            else answer = a * b;
            const aStr = a < 0 ? `(${a})` : a;
            const bStr = b < 0 ? `(${b})` : b;
            return { question: `What is ${aStr} ${op} ${bStr}?`, answer, type: "procedural",
                explanation: `${aStr} ${op} ${bStr} = ${answer}` };
        },
        Percents: () => {
            const pct = pick([10, 20, 25, 50, 75]);
            const base = pick([20, 40, 50, 80, 100, 200]);
            const answer = (pct / 100) * base;
            return { question: `What is ${pct}% of ${base}?`, answer, type: "procedural",
                explanation: `${pct}% = ${pct}/100 = ${pct/100}. Multiply: ${pct/100} √ó ${base} = ${answer}` };
        },
        Ratios: () => {
            const a = rand(2, 5), b = rand(2, 5);
            const mult = rand(2, 6);
            const total = a * mult;
            return { question: `Ratio of cats to dogs is ${a}:${b}. If there are ${total} cats, how many dogs?`, answer: b * mult, type: "reasoning",
                explanation: `${a} parts = ${total}, so 1 part = ${mult}. Dogs = ${b} √ó ${mult} = ${b * mult}` };
        },
        Statistics: () => {
            const n = rand(4, 6);
            const nums = Array.from({length: n}, () => rand(2, 15));
            const sum = nums.reduce((a, b) => a + b, 0);
            const mean = sum / n;
            return { question: `What is the mean of: ${nums.join(", ")}?`, answer: parseFloat(mean.toFixed(2)), type: "procedural",
                explanation: `Sum = ${sum}, count = ${n}. Mean = ${sum}/${n} = ${mean.toFixed(2)}` };
        },
        "Data Collection": () => {
            const type = pick(["tally", "read", "organize"]);
            if (type === "tally") {
                const count = rand(3, 12);
                const tallyStr = "||||".repeat(Math.floor(count / 5)) + "|".repeat(count % 5);
                return { question: `How many does this tally show? ${tallyStr.replace(/\|\|\|\|\|/g, '||||Ã∏ ')}`, answer: count, type: "procedural",
                    explanation: `Each group of 5 is ||||Ã∏. Count: ${Math.floor(count/5)} groups of 5 + ${count % 5} = ${count}` };
            } else if (type === "read") {
                const categories = ["Red", "Blue", "Green"];
                const values = [rand(2, 8), rand(2, 8), rand(2, 8)];
                const maxIdx = values.indexOf(Math.max(...values));
                return { question: `Bar graph shows: Red=${values[0]}, Blue=${values[1]}, Green=${values[2]}. Which has the most?`,
                    answer: categories[maxIdx], type: "conceptual",
                    options: categories.concat(["They're equal"]),
                    explanation: `${categories[maxIdx]} has ${values[maxIdx]}, which is the highest.` };
            } else {
                const data = [rand(5, 10), rand(3, 8), rand(7, 12), rand(4, 9)];
                const total = data.reduce((a, b) => a + b, 0);
                return { question: `Survey results: Mon=${data[0]}, Tue=${data[1]}, Wed=${data[2]}, Thu=${data[3]}. Total responses?`,
                    answer: total, type: "procedural",
                    explanation: `${data.join(" + ")} = ${total}` };
            }
        },
        "Mean Median Mode": () => {
            const type = pick(["median", "mode", "range"]);
            if (type === "median") {
                const n = 5;
                const nums = Array.from({length: n}, () => rand(2, 20)).sort((a, b) => a - b);
                const median = nums[Math.floor(n / 2)];
                return { question: `Find the median: ${nums.join(", ")}`, answer: median, type: "procedural",
                    explanation: `Ordered: ${nums.join(", ")}. Middle value = ${median}` };
            } else if (type === "mode") {
                const base = rand(2, 10);
                const nums = [base, base, base, rand(1, 15), rand(1, 15)].sort((a, b) => a - b);
                return { question: `Find the mode: ${nums.join(", ")}`, answer: base, type: "conceptual",
                    explanation: `${base} appears most often (3 times). Mode = ${base}` };
            } else {
                const nums = Array.from({length: 5}, () => rand(5, 25)).sort((a, b) => a - b);
                const range = nums[4] - nums[0];
                return { question: `Find the range: ${nums.join(", ")}`, answer: range, type: "procedural",
                    explanation: `Range = max - min = ${nums[4]} - ${nums[0]} = ${range}` };
            }
        },
        "Unit Conversion": () => {
            const type = pick(["length", "weight", "volume"]);
            if (type === "length") {
                const feet = rand(2, 10);
                const inches = feet * 12;
                return { question: `Convert ${feet} feet to inches.`, answer: inches, type: "procedural",
                    explanation: `1 foot = 12 inches. ${feet} √ó 12 = ${inches} inches` };
            } else if (type === "weight") {
                const pounds = rand(2, 10);
                const ounces = pounds * 16;
                return { question: `Convert ${pounds} pounds to ounces.`, answer: ounces, type: "procedural",
                    explanation: `1 pound = 16 ounces. ${pounds} √ó 16 = ${ounces} ounces` };
            } else {
                const gallons = rand(1, 5);
                const quarts = gallons * 4;
                return { question: `Convert ${gallons} gallon${gallons > 1 ? 's' : ''} to quarts.`, answer: quarts, type: "procedural",
                    explanation: `1 gallon = 4 quarts. ${gallons} √ó 4 = ${quarts} quarts` };
            }
        },
        "Basic Graphing": () => {
            const type = pick(["plot", "quadrant", "distance"]);
            if (type === "plot") {
                const x = rand(-5, 5);
                const y = rand(-5, 5);
                const quadrant = x > 0 && y > 0 ? "I" : x < 0 && y > 0 ? "II" : x < 0 && y < 0 ? "III" : x > 0 && y < 0 ? "IV" : "axis";
                return { question: `Point (${x}, ${y}) is in which quadrant?`, answer: quadrant === "axis" ? "on an axis" : `Quadrant ${quadrant}`, type: "conceptual",
                    options: ["Quadrant I", "Quadrant II", "Quadrant III", "Quadrant IV"],
                    explanation: `(${x}, ${y}): x is ${x > 0 ? "positive" : x < 0 ? "negative" : "zero"}, y is ${y > 0 ? "positive" : y < 0 ? "negative" : "zero"}. That's ${quadrant === "axis" ? "on an axis" : "Quadrant " + quadrant}.` };
            } else if (type === "quadrant") {
                const quadrants = [
                    { q: "I", desc: "x positive, y positive", ex: "(3, 2)" },
                    { q: "II", desc: "x negative, y positive", ex: "(-3, 2)" },
                    { q: "III", desc: "x negative, y negative", ex: "(-3, -2)" },
                    { q: "IV", desc: "x positive, y negative", ex: "(3, -2)" }
                ];
                const quad = pick(quadrants);
                return { question: `In Quadrant ${quad.q}, x is ___ and y is ___.`, answer: quad.desc, type: "conceptual",
                    options: quadrants.map(q => q.desc),
                    explanation: `Quadrant ${quad.q} has ${quad.desc}. Example: ${quad.ex}` };
            } else {
                const x1 = 0, y1 = 0;
                const x2 = rand(3, 5), y2 = 0;
                return { question: `Distance from (${x1}, ${y1}) to (${x2}, ${y2})?`, answer: x2, type: "procedural",
                    explanation: `Points on same horizontal line: distance = |${x2} - ${x1}| = ${x2}` };
            }
        },
        Proportions: () => {
            const type = pick(["solve", "setup", "word"]);
            if (type === "solve") {
                const a = rand(2, 8), b = rand(2, 6), c = rand(3, 12);
                const d = (b * c) / a;
                if (d === Math.floor(d)) {
                    return { question: `Solve: ${a}/${b} = ${c}/x`, answer: d, type: "procedural",
                        explanation: `Cross multiply: ${a} √ó x = ${b} √ó ${c} ‚Üí ${a}x = ${b*c} ‚Üí x = ${d}` };
                } else {
                    const newA = rand(2, 5), newB = rand(2, 4), newC = newA * rand(2, 4);
                    const newD = (newB * newC) / newA;
                    return { question: `Solve: ${newA}/${newB} = ${newC}/x`, answer: newD, type: "procedural",
                        explanation: `Cross multiply: ${newA} √ó x = ${newB} √ó ${newC} ‚Üí ${newA}x = ${newB*newC} ‚Üí x = ${newD}` };
                }
            } else if (type === "setup") {
                const rate = rand(2, 5), unit = rand(3, 10);
                const total = rate * unit;
                return { question: `If ${rate} apples cost $${unit}, write a proportion to find the cost of ${total/rate * 2} apples.`,
                    answer: `${rate}/${unit} = ${total/rate * 2}/x`, type: "conceptual",
                    options: [`${rate}/${unit} = ${total/rate * 2}/x`, `${unit}/${rate} = x/${total/rate * 2}`, `${rate}/x = ${unit}/${total/rate * 2}`, `${total/rate * 2}/${rate} = x/${unit}`],
                    explanation: `Set up: apples/cost = apples/cost ‚Üí ${rate}/${unit} = ${total/rate * 2}/x` };
            } else {
                const miles = rand(50, 150), hours = rand(2, 4);
                const rate = miles / hours;
                const newHours = hours + rand(1, 3);
                const newMiles = rate * newHours;
                return { question: `You drive ${miles} miles in ${hours} hours. At this rate, how far in ${newHours} hours?`, answer: newMiles, type: "reasoning",
                    explanation: `Rate = ${miles}/${hours} = ${rate} mph. Distance = ${rate} √ó ${newHours} = ${newMiles} miles` };
            }
        },
        "Absolute Value": () => {
            const type = pick(["evaluate", "compare", "solve"]);
            if (type === "evaluate") {
                const n = rand(-15, 15);
                return { question: `What is |${n}|?`, answer: Math.abs(n), type: "procedural",
                    explanation: `|${n}| = ${Math.abs(n)}. Absolute value is the distance from 0, always positive.` };
            } else if (type === "compare") {
                const a = rand(-10, -1), b = rand(1, 10);
                const absA = Math.abs(a), absB = Math.abs(b);
                const larger = absA > absB ? `|${a}|` : absA < absB ? `|${b}|` : "equal";
                return { question: `Which is greater: |${a}| or |${b}|?`, answer: larger, type: "conceptual",
                    options: [`|${a}|`, `|${b}|`, "equal"],
                    explanation: `|${a}| = ${absA}, |${b}| = ${absB}. ${larger === "equal" ? "They are equal." : larger + " is greater."}` };
            } else {
                const ans = rand(2, 10);
                return { question: `Solve: |x| = ${ans}`, answer: `${ans} or -${ans}`, type: "procedural",
                    options: [`${ans} or -${ans}`, `${ans}`, `-${ans}`, `${ans * 2}`],
                    explanation: `|x| = ${ans} means x = ${ans} or x = -${ans} (both are ${ans} away from 0)` };
            }
        },
        "Scientific Notation": () => {
            const type = pick(["convert_to", "convert_from", "multiply"]);
            if (type === "convert_to") {
                const sig = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(3, 7);
                const standard = sig * Math.pow(10, exp);
                return { question: `Write ${standard.toLocaleString()} in scientific notation.`, answer: `${sig} √ó 10^${exp}`, type: "procedural",
                    options: [`${sig} √ó 10^${exp}`, `${sig} √ó 10^${exp-1}`, `${sig * 10} √ó 10^${exp-1}`, `${sig / 10} √ó 10^${exp+1}`],
                    explanation: `Move decimal ${exp} places left: ${standard.toLocaleString()} = ${sig} √ó 10^${exp}` };
            } else if (type === "convert_from") {
                const sig = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(2, 5);
                const answer = sig * Math.pow(10, exp);
                return { question: `Convert ${sig} √ó 10^${exp} to standard form.`, answer: answer, type: "procedural",
                    explanation: `Move decimal ${exp} places right: ${sig} √ó 10^${exp} = ${answer}` };
            } else {
                const a = rand(2, 5), b = rand(2, 4), expA = rand(3, 5), expB = rand(2, 4);
                const product = a * b;
                const expSum = expA + expB;
                return { question: `(${a} √ó 10^${expA}) √ó (${b} √ó 10^${expB}) = ?`, answer: `${product} √ó 10^${expSum}`, type: "procedural",
                    options: [`${product} √ó 10^${expSum}`, `${a + b} √ó 10^${expSum}`, `${product} √ó 10^${expA * expB}`, `${product} √ó 10^${expA}`],
                    explanation: `Multiply coefficients: ${a} √ó ${b} = ${product}. Add exponents: ${expA} + ${expB} = ${expSum}` };
            }
        },
        "Square Roots": () => {
            const type = pick(["perfect", "estimate", "simplify"]);
            if (type === "perfect") {
                const root = rand(2, 12);
                const square = root * root;
                return { question: `What is ‚àö${square}?`, answer: root, type: "procedural",
                    explanation: `‚àö${square} = ${root} because ${root} √ó ${root} = ${square}` };
            } else if (type === "estimate") {
                const root = rand(4, 9);
                const between = root * root + rand(1, root * 2 - 1);
                const low = root, high = root + 1;
                return { question: `Between which two integers is ‚àö${between}?`, answer: `${low} and ${high}`, type: "reasoning",
                    options: [`${low} and ${high}`, `${low - 1} and ${low}`, `${high} and ${high + 1}`, `${low - 1} and ${high + 1}`],
                    explanation: `${low}¬≤ = ${low*low}, ${high}¬≤ = ${high*high}. Since ${low*low} < ${between} < ${high*high}, ‚àö${between} is between ${low} and ${high}.` };
            } else {
                const outside = rand(2, 5), inside = rand(2, 5);
                const radicand = outside * outside * inside;
                return { question: `Simplify ‚àö${radicand}`, answer: `${outside}‚àö${inside}`, type: "procedural",
                    options: [`${outside}‚àö${inside}`, `${inside}‚àö${outside}`, `‚àö${radicand}`, `${outside * inside}`],
                    explanation: `‚àö${radicand} = ‚àö(${outside}¬≤ √ó ${inside}) = ${outside}‚àö${inside}` };
            }
        }
    },

    // TIER 4: Pre-Algebra (8-9)
    4: {
        "Order of Operations": () => {
            const templates = [
                () => { const a = rand(2, 8), b = rand(2, 6), c = rand(2, 5); return { q: `${a} + ${b} √ó ${c}`, ans: a + b * c, exp: `Multiply first: ${b} √ó ${c} = ${b*c}. Then add: ${a} + ${b*c} = ${a + b*c}` }; },
                () => { const a = rand(2, 5), b = rand(2, 5), c = rand(2, 4); return { q: `(${a} + ${b}) √ó ${c}`, ans: (a + b) * c, exp: `Parentheses first: ${a} + ${b} = ${a+b}. Then multiply: ${(a+b)} √ó ${c} = ${(a+b)*c}` }; },
                () => { const a = rand(2, 4), b = rand(2, 4), c = rand(1, 5); return { q: `${a}¬≤ + ${b} √ó ${c}`, ans: a*a + b*c, exp: `Exponent first: ${a}¬≤ = ${a*a}. Multiply: ${b} √ó ${c} = ${b*c}. Add: ${a*a} + ${b*c} = ${a*a + b*c}` }; }
            ];
            const t = pick(templates)();
            return { question: `What is ${t.q}?`, answer: t.ans, type: "procedural", explanation: t.exp };
        },
        Equations: () => {
            const type = pick(["add", "sub", "mult", "div"]);
            const x = rand(2, 15);
            let question, explanation;
            if (type === "add") { const b = rand(3, 12); question = `x + ${b} = ${x + b}`; explanation = `Subtract ${b}: x = ${x + b} - ${b} = ${x}`; }
            else if (type === "sub") { const b = rand(3, 12); question = `x - ${b} = ${x - b}`; explanation = `Add ${b}: x = ${x - b} + ${b} = ${x}`; }
            else if (type === "mult") { const b = rand(2, 8); question = `${b}x = ${b * x}`; explanation = `Divide by ${b}: x = ${b * x} √∑ ${b} = ${x}`; }
            else { const b = rand(2, 6); question = `x √∑ ${b} = ${x}`; explanation = `Multiply by ${b}: x = ${x} √ó ${b} = ${x * b}`; return { question: `Solve: ${question}`, answer: x * b, type: "procedural", explanation }; }
            return { question: `Solve: ${question}`, answer: x, type: "procedural", explanation };
        },
        Exponents: () => {
            const type = pick(["eval", "multiply", "power"]);
            if (type === "eval") {
                const base = rand(2, 5), exp = rand(2, 4);
                return { question: `What is ${base}${["‚Å∞","¬π","¬≤","¬≥","‚Å¥"][exp]}?`, answer: Math.pow(base, exp), type: "procedural",
                    explanation: `${base}^${exp} = ${"√ó".repeat(exp-1).split("").map(() => base).join(" √ó ")} = ${Math.pow(base, exp)}` };
            } else if (type === "multiply") {
                const base = rand(2, 4), e1 = rand(2, 4), e2 = rand(2, 3);
                return { question: `Simplify: ${base}${["","¬π","¬≤","¬≥","‚Å¥"][e1]} √ó ${base}${["","¬π","¬≤","¬≥"][e2]}`, answer: `${base}^${e1+e2}`, type: "procedural",
                    options: [`${base}^${e1+e2}`, `${base}^${e1*e2}`, `${base*2}^${e1}`, `${base}^${e1}`],
                    explanation: `Add exponents when multiplying same base: ${base}^${e1} √ó ${base}^${e2} = ${base}^${e1+e2}` };
            } else {
                const base = rand(2, 3), e1 = rand(2, 3), e2 = rand(2, 3);
                return { question: `Simplify: (${base}${["","¬π","¬≤","¬≥"][e1]})${["","¬π","¬≤","¬≥"][e2]}`, answer: `${base}^${e1*e2}`, type: "procedural",
                    options: [`${base}^${e1*e2}`, `${base}^${e1+e2}`, `${base*e2}^${e1}`, `${base}^${e1}`],
                    explanation: `Multiply exponents for power of power: (${base}^${e1})^${e2} = ${base}^${e1*e2}` };
            }
        },
        Slope: () => {
            const rise = rand(2, 8), run = rand(2, 6);
            const type = pick(["formula", "points"]);
            if (type === "formula") {
                return { question: `A line rises ${rise} units and runs ${run} units. What is its slope?`, answer: rise / run, type: "conceptual",
                    explanation: `Slope = rise/run = ${rise}/${run} = ${(rise/run).toFixed(2)}` };
            } else {
                const x1 = rand(0, 5), y1 = rand(0, 5);
                const x2 = x1 + run, y2 = y1 + rise;
                return { question: `Find slope through (${x1}, ${y1}) and (${x2}, ${y2})`, answer: rise / run, type: "procedural",
                    explanation: `Slope = (${y2}-${y1})/(${x2}-${x1}) = ${rise}/${run} = ${(rise/run).toFixed(2)}` };
            }
        },
        Pythagorean: () => {
            const triples = [[3,4,5], [5,12,13], [8,15,17], [6,8,10]];
            const [a, b, c] = pick(triples);
            const type = pick(["hyp", "leg"]);
            if (type === "hyp") {
                return { question: `Right triangle legs ${a} and ${b}. Find hypotenuse.`, answer: c, type: "procedural",
                    explanation: `a¬≤ + b¬≤ = c¬≤. ${a}¬≤ + ${b}¬≤ = ${a*a} + ${b*b} = ${c*c}. c = ${c}` };
            } else {
                return { question: `Right triangle: leg ${a}, hypotenuse ${c}. Find other leg.`, answer: b, type: "procedural",
                    explanation: `a¬≤ + b¬≤ = c¬≤. ${a}¬≤ + b¬≤ = ${c}¬≤. b¬≤ = ${c*c} - ${a*a} = ${b*b}. b = ${b}` };
            }
        },
        "Angles and Lines": () => {
            const type = pick(["complementary", "supplementary", "vertical", "parallel"]);
            if (type === "complementary") {
                const angle1 = rand(10, 80);
                const angle2 = 90 - angle1;
                return { question: `Two complementary angles: one is ${angle1}¬∞. Find the other.`, answer: angle2, type: "procedural",
                    explanation: `Complementary angles add to 90¬∞. 90¬∞ - ${angle1}¬∞ = ${angle2}¬∞` };
            } else if (type === "supplementary") {
                const angle1 = rand(30, 150);
                const angle2 = 180 - angle1;
                return { question: `Two supplementary angles: one is ${angle1}¬∞. Find the other.`, answer: angle2, type: "procedural",
                    explanation: `Supplementary angles add to 180¬∞. 180¬∞ - ${angle1}¬∞ = ${angle2}¬∞` };
            } else if (type === "vertical") {
                const angle = rand(20, 160);
                return { question: `Two lines intersect. One angle is ${angle}¬∞. What is the vertical angle?`, answer: angle, type: "conceptual",
                    explanation: `Vertical angles are equal. The vertical angle is also ${angle}¬∞.` };
            } else {
                const angle = rand(40, 140);
                const type2 = pick(["corresponding", "alternate"]);
                return { question: `Parallel lines cut by a transversal. One angle is ${angle}¬∞. Find the ${type2} angle.`, answer: angle, type: "conceptual",
                    explanation: `${type2.charAt(0).toUpperCase() + type2.slice(1)} angles with parallel lines are equal: ${angle}¬∞` };
            }
        },
        "Algebraic Expressions": () => {
            const type = pick(["evaluate", "simplify", "translate"]);
            if (type === "evaluate") {
                const a = rand(2, 5);
                const b = rand(1, 10);
                const x = rand(2, 6);
                const answer = a * x + b;
                return { question: `Evaluate ${a}x + ${b} when x = ${x}`, answer, type: "procedural",
                    explanation: `Substitute x = ${x}: ${a}(${x}) + ${b} = ${a * x} + ${b} = ${answer}` };
            } else if (type === "simplify") {
                const a = rand(2, 6);
                const b = rand(1, 5);
                const c = rand(1, 4);
                const d = rand(1, 5);
                return { question: `Simplify: ${a}x + ${b} + ${c}x + ${d}`, answer: `${a + c}x + ${b + d}`, type: "procedural",
                    options: [`${a + c}x + ${b + d}`, `${a * c}x + ${b + d}`, `${a + c}x + ${b * d}`, `${a + b}x + ${c + d}`],
                    explanation: `Combine like terms: (${a} + ${c})x + (${b} + ${d}) = ${a + c}x + ${b + d}` };
            } else {
                const templates = [
                    { phrase: "5 more than a number x", expr: "x + 5" },
                    { phrase: "3 times a number x", expr: "3x" },
                    { phrase: "a number x decreased by 7", expr: "x - 7" },
                    { phrase: "twice a number x plus 4", expr: "2x + 4" }
                ];
                const t = pick(templates);
                return { question: `Write as an expression: "${t.phrase}"`, answer: t.expr, type: "conceptual",
                    options: ["x + 5", "3x", "x - 7", "2x + 4"],
                    explanation: `"${t.phrase}" translates to ${t.expr}` };
            }
        },
        "Surface Area": () => {
            const type = pick(["cube", "rectangular_prism", "cylinder"]);
            if (type === "cube") {
                const s = rand(2, 6);
                const sa = 6 * s * s;
                return { question: `Find the surface area of a cube with side length ${s}.`, answer: sa, type: "procedural",
                    explanation: `SA = 6s¬≤ = 6 √ó ${s}¬≤ = 6 √ó ${s*s} = ${sa}` };
            } else if (type === "rectangular_prism") {
                const l = rand(3, 6), w = rand(2, 5), h = rand(2, 4);
                const sa = 2 * (l*w + l*h + w*h);
                return { question: `Surface area of a box: length=${l}, width=${w}, height=${h}?`, answer: sa, type: "procedural",
                    explanation: `SA = 2(lw + lh + wh) = 2(${l*w} + ${l*h} + ${w*h}) = 2(${l*w + l*h + w*h}) = ${sa}` };
            } else {
                const r = rand(2, 5), h = rand(3, 8);
                const sa = Math.round(2 * Math.PI * r * (r + h));
                return { question: `Surface area of cylinder: radius=${r}, height=${h}? (Round to nearest whole, use œÄ‚âà3.14)`, answer: sa, type: "procedural",
                    explanation: `SA = 2œÄr(r+h) = 2√ó3.14√ó${r}√ó${r+h} ‚âà ${sa}` };
            }
        },
        "Two-Way Tables": () => {
            const type = pick(["read", "total", "relative"]);
            const a = rand(10, 25), b = rand(15, 30), c = rand(12, 22), d = rand(8, 18);
            if (type === "read") {
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. How many boys like sports?`,
                    answer: a, type: "conceptual",
                    explanation: `Read directly from the table: Boys who like Sports = ${a}` };
            } else if (type === "total") {
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. Total boys?`,
                    answer: a + b, type: "procedural",
                    explanation: `Total boys = ${a} + ${b} = ${a + b}` };
            } else {
                const total = a + b + c + d;
                const pct = Math.round((a / total) * 100);
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. What percent are boys who like sports?`,
                    answer: pct, type: "procedural",
                    explanation: `Total = ${total}. Boys-Sports/Total = ${a}/${total} = ${pct}%` };
            }
        },
        "Scatter Plots": () => {
            const type = pick(["correlation", "trend", "outlier"]);
            if (type === "correlation") {
                const corr = pick(["positive", "negative", "none"]);
                const desc = corr === "positive" ? "points go up from left to right" :
                            corr === "negative" ? "points go down from left to right" :
                            "points are scattered randomly";
                return { question: `A scatter plot shows ${desc}. What type of correlation?`, answer: corr, type: "conceptual",
                    options: ["positive", "negative", "none"],
                    explanation: `When ${desc}, the correlation is ${corr}.` };
            } else if (type === "trend") {
                const scenarios = [
                    { desc: "hours studied vs. test score", trend: "positive" },
                    { desc: "temperature vs. hot chocolate sales", trend: "negative" },
                    { desc: "age vs. height (for children)", trend: "positive" },
                    { desc: "price vs. quantity demanded", trend: "negative" }
                ];
                const s = pick(scenarios);
                return { question: `What correlation would you expect: ${s.desc}?`, answer: s.trend, type: "reasoning",
                    options: ["positive", "negative", "none"],
                    explanation: `${s.desc} shows a ${s.trend} correlation.` };
            } else {
                const points = [[2, 3], [3, 5], [4, 6], [5, 8], [6, 9], [4, 20]];
                return { question: `Points: (2,3), (3,5), (4,6), (5,8), (6,9), (4,20). Which is the outlier?`, answer: "(4, 20)", type: "conceptual",
                    options: ["(2, 3)", "(4, 6)", "(4, 20)", "(6, 9)"],
                    explanation: `(4, 20) is far from the pattern of other points, making it an outlier.` };
            }
        },
        "Box Plots": () => {
            const type = pick(["identify", "IQR", "compare"]);
            const data = [12, 15, 18, 22, 25, 28, 30, 35, 40];
            const min = data[0], q1 = data[2], median = data[4], q3 = data[6], max = data[8];
            if (type === "identify") {
                const part = pick(["minimum", "Q1", "median", "Q3", "maximum"]);
                const values = { minimum: min, Q1: q1, median: median, Q3: q3, maximum: max };
                return { question: `Data: ${data.join(", ")}. What is the ${part}?`, answer: values[part], type: "procedural",
                    explanation: `${part} = ${values[part]}. Min=${min}, Q1=${q1}, Med=${median}, Q3=${q3}, Max=${max}` };
            } else if (type === "IQR") {
                const iqr = q3 - q1;
                return { question: `Data: ${data.join(", ")}. What is the IQR (Interquartile Range)?`, answer: iqr, type: "procedural",
                    explanation: `IQR = Q3 - Q1 = ${q3} - ${q1} = ${iqr}` };
            } else {
                const range = max - min;
                return { question: `Data: ${data.join(", ")}. What is the range?`, answer: range, type: "procedural",
                    explanation: `Range = Max - Min = ${max} - ${min} = ${range}` };
            }
        },
        "Probability Basics": () => {
            const type = pick(["simple", "complement", "word"]);
            if (type === "simple") {
                const favorable = rand(1, 5), total = favorable + rand(2, 6);
                return { question: `A bag has ${favorable} red and ${total - favorable} blue marbles. P(red)?`, answer: `${favorable}/${total}`, type: "procedural",
                    options: [`${favorable}/${total}`, `${total - favorable}/${total}`, `${favorable}/${total - favorable}`, `1/${total}`],
                    explanation: `P(red) = favorable/total = ${favorable}/${total}` };
            } else if (type === "complement") {
                const pct = rand(20, 80);
                const complement = 100 - pct;
                return { question: `If P(rain) = ${pct}%, what is P(no rain)?`, answer: `${complement}%`, type: "procedural",
                    options: [`${complement}%`, `${pct}%`, `${100 - complement}%`, `${pct / 2}%`],
                    explanation: `P(no rain) = 100% - P(rain) = 100% - ${pct}% = ${complement}%` };
            } else {
                const dice = rand(1, 6);
                return { question: `Roll a fair die. What is P(rolling a ${dice})?`, answer: "1/6", type: "conceptual",
                    options: ["1/6", "1/3", "1/2", "6/6"],
                    explanation: `Each number 1-6 has equal chance: P(${dice}) = 1/6` };
            }
        }
    },

    // TIER 5: Algebra I (9-10)
    5: {
        "Linear Equations": () => {
            const x = rand(2, 10);
            const a = rand(2, 5), b = rand(3, 15);
            const c = a * x + b;
            return { question: `Solve: ${a}x + ${b} = ${c}`, answer: x, type: "procedural",
                explanation: `Subtract ${b}: ${a}x = ${c - b}. Divide by ${a}: x = ${(c-b)/a}` };
        },
        Systems: () => {
            const x = rand(2, 8), y = rand(2, 8);
            const type = pick(["elimination", "substitution"]);
            if (type === "elimination") {
                return { question: `x + y = ${x + y} and x - y = ${x - y}. Find x.`, answer: x, type: "procedural",
                    explanation: `Add equations: 2x = ${2*x}, so x = ${x}` };
            } else {
                const a = rand(2, 4);
                return { question: `${a}x + y = ${a*x + y} and x = ${x}. Find y.`, answer: y, type: "procedural",
                    explanation: `Substitute x=${x}: ${a}(${x}) + y = ${a*x + y}. ${a*x} + y = ${a*x + y}. y = ${y}` };
            }
        },
        Factoring: () => {
            const type = pick(["trinomial", "difference"]);
            if (type === "trinomial") {
                const a = rand(1, 6), b = rand(1, 6);
                const sum = a + b, prod = a * b;
                return { question: `Factor: x¬≤ + ${sum}x + ${prod}`, answer: `(x+${a})(x+${b})`, type: "procedural",
                    options: [`(x+${a})(x+${b})`, `(x+${sum})(x+1)`, `(x-${a})(x-${b})`, `(x+${prod})(x+1)`],
                    explanation: `Find two numbers that multiply to ${prod} and add to ${sum}: ${a} and ${b}. Factor: (x+${a})(x+${b})` };
            } else {
                const a = rand(2, 8);
                return { question: `Factor: x¬≤ - ${a*a}`, answer: `(x+${a})(x-${a})`, type: "procedural",
                    options: [`(x+${a})(x-${a})`, `(x-${a})¬≤`, `(x+${a})¬≤`, `(x-${a*a})(x+1)`],
                    explanation: `Difference of squares: x¬≤ - ${a}¬≤ = (x+${a})(x-${a})` };
            }
        },
        Functions: () => {
            const a = rand(2, 5), b = rand(-5, 10);
            const x = rand(1, 6);
            const answer = a * x + b;
            return { question: `If f(x) = ${a}x ${b >= 0 ? '+' : ''} ${b}, what is f(${x})?`, answer, type: "procedural",
                explanation: `f(${x}) = ${a}(${x}) + ${b} = ${a*x} + ${b} = ${answer}` };
        },
        Inequalities: () => {
            const a = rand(2, 5), b = rand(5, 20);
            const boundary = b / a;
            const dir = pick(["<", ">", "‚â§", "‚â•"]);
            return { question: `Solve: ${a}x ${dir} ${b}`, answer: `x ${dir} ${boundary}`, type: "procedural",
                options: [`x ${dir} ${boundary}`, `x ${dir === '<' ? '>' : dir === '>' ? '<' : dir === '‚â§' ? '‚â•' : '‚â§'} ${boundary}`, `x ${dir} ${-boundary}`, `x ${dir} ${a}`],
                explanation: `Divide both sides by ${a}: x ${dir} ${boundary}` };
        },
        "Rational Functions": () => {
            const type = pick(["simplify", "domain", "asymptote"]);
            if (type === "simplify") {
                const a = rand(2, 6);
                return { question: `Simplify: ${a}x/(${a})`, answer: "x", type: "procedural",
                    options: ["x", `${a}x`, "1", `x/${a}`],
                    explanation: `${a}x/${a} = x (divide out common factor ${a})` };
            } else if (type === "domain") {
                const a = rand(2, 8);
                return { question: `For f(x) = 1/(x - ${a}), what value of x is NOT in the domain?`, answer: a, type: "conceptual",
                    explanation: `Cannot divide by zero. x - ${a} = 0 when x = ${a}. So x ‚â† ${a}.` };
            } else {
                const a = rand(1, 5);
                return { question: `For f(x) = 1/(x - ${a}), what is the vertical asymptote?`, answer: `x = ${a}`, type: "conceptual",
                    options: [`x = ${a}`, `x = ${-a}`, `y = ${a}`, `y = 0`],
                    explanation: `Vertical asymptote where denominator = 0: x - ${a} = 0, so x = ${a}` };
            }
        },
        Radicals: () => {
            const type = pick(["simplify", "add", "multiply"]);
            if (type === "simplify") {
                const outside = rand(2, 5), inside = rand(2, 7);
                const radicand = outside * outside * inside;
                return { question: `Simplify: ‚àö${radicand}`, answer: `${outside}‚àö${inside}`, type: "procedural",
                    options: [`${outside}‚àö${inside}`, `${inside}‚àö${outside}`, `${outside * inside}`, `‚àö${radicand}`],
                    explanation: `‚àö${radicand} = ‚àö(${outside}¬≤ √ó ${inside}) = ${outside}‚àö${inside}` };
            } else if (type === "add") {
                const coeff1 = rand(2, 5), coeff2 = rand(2, 5), inside = rand(2, 7);
                const sum = coeff1 + coeff2;
                return { question: `Simplify: ${coeff1}‚àö${inside} + ${coeff2}‚àö${inside}`, answer: `${sum}‚àö${inside}`, type: "procedural",
                    options: [`${sum}‚àö${inside}`, `${coeff1 * coeff2}‚àö${inside}`, `${sum}‚àö${inside * 2}`, `‚àö${inside * sum}`],
                    explanation: `Like terms: (${coeff1} + ${coeff2})‚àö${inside} = ${sum}‚àö${inside}` };
            } else {
                const a = rand(2, 5), b = rand(2, 6);
                const product = a * b;
                return { question: `Simplify: ‚àö${a} √ó ‚àö${b}`, answer: `‚àö${product}`, type: "procedural",
                    options: [`‚àö${product}`, `‚àö${a + b}`, `${a}‚àö${b}`, `${b}‚àö${a}`],
                    explanation: `‚àö${a} √ó ‚àö${b} = ‚àö(${a} √ó ${b}) = ‚àö${product}` };
            }
        },
        "Exponential Functions": () => {
            const type = pick(["evaluate", "growth_decay", "identify"]);
            if (type === "evaluate") {
                const base = rand(2, 4), exp = rand(2, 4);
                const result = Math.pow(base, exp);
                return { question: `If f(x) = ${base}^x, find f(${exp}).`, answer: result, type: "procedural",
                    explanation: `f(${exp}) = ${base}^${exp} = ${result}` };
            } else if (type === "growth_decay") {
                const init = rand(100, 500), rate = rand(5, 20);
                const isGrowth = pick([true, false]);
                const factor = isGrowth ? 1 + rate/100 : 1 - rate/100;
                const years = 2;
                const final = Math.round(init * Math.pow(factor, years));
                return { question: `Initial value ${init}, ${isGrowth ? "growth" : "decay"} ${rate}% per year. Value after ${years} years?`, answer: final, type: "procedural",
                    explanation: `${init} √ó ${factor.toFixed(2)}^${years} = ${init} √ó ${Math.pow(factor, years).toFixed(3)} ‚âà ${final}` };
            } else {
                const a = rand(2, 5);
                const isGrowth = pick([true, false]);
                const b = isGrowth ? 1 + rand(1, 5)/10 : rand(1, 9)/10;
                return { question: `y = ${a}(${b.toFixed(1)})^x represents growth or decay?`, answer: isGrowth ? "growth" : "decay", type: "conceptual",
                    options: ["growth", "decay"],
                    explanation: `Base ${b.toFixed(1)} is ${b > 1 ? "> 1, so growth" : "< 1, so decay"}` };
            }
        },
        "Arithmetic Sequences": () => {
            const type = pick(["find_term", "find_d", "formula"]);
            const a1 = rand(2, 10), d = rand(2, 6);
            if (type === "find_term") {
                const n = rand(5, 10);
                const an = a1 + (n - 1) * d;
                return { question: `Arithmetic sequence: first term ${a1}, common difference ${d}. Find the ${n}th term.`, answer: an, type: "procedural",
                    explanation: `a‚Çô = a‚ÇÅ + (n-1)d = ${a1} + (${n}-1)(${d}) = ${a1} + ${(n-1)*d} = ${an}` };
            } else if (type === "find_d") {
                const seq = [a1, a1 + d, a1 + 2*d, a1 + 3*d];
                return { question: `Find common difference: ${seq.join(", ")}, ...`, answer: d, type: "procedural",
                    explanation: `d = ${seq[1]} - ${seq[0]} = ${d}` };
            } else {
                const seq = [a1, a1 + d, a1 + 2*d];
                return { question: `Sequence: ${seq.join(", ")}, ... Write the formula for the nth term.`, answer: `${a1} + ${d}(n-1)`, type: "conceptual",
                    options: [`${a1} + ${d}(n-1)`, `${a1}n + ${d}`, `${d}n + ${a1}`, `${a1} √ó ${d}^(n-1)`],
                    explanation: `a‚Çô = a‚ÇÅ + (n-1)d = ${a1} + ${d}(n-1)` };
            }
        },
        "Geometric Sequences": () => {
            const type = pick(["find_term", "find_r", "formula"]);
            const a1 = rand(2, 5), r = rand(2, 4);
            if (type === "find_term") {
                const n = rand(4, 6);
                const an = a1 * Math.pow(r, n - 1);
                return { question: `Geometric sequence: first term ${a1}, common ratio ${r}. Find the ${n}th term.`, answer: an, type: "procedural",
                    explanation: `a‚Çô = a‚ÇÅ √ó r^(n-1) = ${a1} √ó ${r}^${n-1} = ${a1} √ó ${Math.pow(r, n-1)} = ${an}` };
            } else if (type === "find_r") {
                const seq = [a1, a1 * r, a1 * r * r];
                return { question: `Find common ratio: ${seq.join(", ")}, ...`, answer: r, type: "procedural",
                    explanation: `r = ${seq[1]}/${seq[0]} = ${r}` };
            } else {
                return { question: `Geometric sequence with a‚ÇÅ = ${a1} and r = ${r}. Which formula?`, answer: `${a1} √ó ${r}^(n-1)`, type: "conceptual",
                    options: [`${a1} √ó ${r}^(n-1)`, `${a1} + ${r}(n-1)`, `${a1}n √ó ${r}`, `${r} √ó ${a1}^(n-1)`],
                    explanation: `Geometric: a‚Çô = a‚ÇÅ √ó r^(n-1) = ${a1} √ó ${r}^(n-1)` };
            }
        },
        "Compound Interest": () => {
            const type = pick(["annual", "multiple", "formula"]);
            const P = pick([100, 200, 500, 1000]);
            const r = pick([5, 6, 8, 10]);
            if (type === "annual") {
                const t = rand(1, 3);
                const A = Math.round(P * Math.pow(1 + r/100, t));
                return { question: `$${P} at ${r}% annual interest compounded yearly for ${t} year${t > 1 ? 's' : ''}. Final amount?`, answer: A, type: "procedural",
                    explanation: `A = P(1 + r)^t = ${P}(1.${r.toString().padStart(2, '0')})^${t} ‚âà $${A}` };
            } else if (type === "multiple") {
                const n = pick([2, 4, 12]); // semiannual, quarterly, monthly
                const nName = n === 2 ? "semiannually" : n === 4 ? "quarterly" : "monthly";
                const t = 1;
                const A = Math.round(P * Math.pow(1 + r/(100*n), n*t));
                return { question: `$${P} at ${r}% compounded ${nName} for 1 year. Final amount?`, answer: A, type: "procedural",
                    explanation: `A = P(1 + r/n)^(nt) = ${P}(1 + ${r/100}/${n})^${n} ‚âà $${A}` };
            } else {
                return { question: `Which formula calculates compound interest?`, answer: "A = P(1 + r/n)^(nt)", type: "conceptual",
                    options: ["A = P(1 + r/n)^(nt)", "A = P + Prt", "A = P √ó r √ó t", "A = P(1 + rt)"],
                    explanation: `Compound interest: A = P(1 + r/n)^(nt). Simple interest is A = P(1 + rt).` };
            }
        },
        "Domain and Range": () => {
            const type = pick(["linear", "quadratic", "rational"]);
            if (type === "linear") {
                const m = rand(-5, 5), b = rand(-10, 10);
                return { question: `What is the domain of f(x) = ${m}x + ${b}?`, answer: "all real numbers", type: "conceptual",
                    options: ["all real numbers", "x ‚â• 0", "x ‚â§ 0", "x ‚â† 0"],
                    explanation: `Linear functions have domain of all real numbers (no restrictions).` };
            } else if (type === "quadratic") {
                const a = pick([-1, 1, 2, -2]);
                const vertex = rand(-5, 5);
                const range = a > 0 ? `y ‚â• ${vertex}` : `y ‚â§ ${vertex}`;
                return { question: `Parabola opens ${a > 0 ? "up" : "down"} with vertex at y = ${vertex}. What is the range?`, answer: range, type: "conceptual",
                    options: [`y ‚â• ${vertex}`, `y ‚â§ ${vertex}`, "all real numbers", `y ‚â† ${vertex}`],
                    explanation: `Opens ${a > 0 ? "up" : "down"} from vertex, so range is ${range}` };
            } else {
                const a = rand(1, 5);
                return { question: `What is the domain of f(x) = 1/(x - ${a})?`, answer: `x ‚â† ${a}`, type: "conceptual",
                    options: [`x ‚â† ${a}`, "all real numbers", `x ‚â• ${a}`, `x > ${a}`],
                    explanation: `Cannot divide by 0. x - ${a} = 0 when x = ${a}, so x ‚â† ${a}` };
            }
        }
    },

    // TIER 6: Geometry (10-11)
    6: {
        Area: () => {
            const shape = pick(["rectangle", "triangle", "parallelogram"]);
            const a = rand(3, 12), b = rand(3, 12);
            let answer, explanation, question;
            if (shape === "rectangle") {
                answer = a * b;
                question = `Rectangle with length ${a} and width ${b}. Find area.`;
                explanation = `Area = length √ó width = ${a} √ó ${b} = ${answer}`;
            } else if (shape === "triangle") {
                answer = (a * b) / 2;
                question = `Triangle with base ${a} and height ${b}. Find area.`;
                explanation = `Area = ¬Ω √ó base √ó height = ¬Ω √ó ${a} √ó ${b} = ${answer}`;
            } else {
                answer = a * b;
                question = `Parallelogram with base ${a} and height ${b}. Find area.`;
                explanation = `Area = base √ó height = ${a} √ó ${b} = ${answer}`;
            }
            return { question, answer, type: "procedural", explanation };
        },
        Volume: () => {
            const shape = pick(["cube", "rectangular", "cylinder"]);
            if (shape === "cube") {
                const s = rand(2, 7);
                return { question: `Cube with side ${s}. Find volume.`, answer: s * s * s, type: "procedural",
                    explanation: `V = s¬≥ = ${s}¬≥ = ${s*s*s}` };
            } else if (shape === "rectangular") {
                const l = rand(2, 8), w = rand(2, 6), h = rand(2, 5);
                return { question: `Box with dimensions ${l} √ó ${w} √ó ${h}. Find volume.`, answer: l * w * h, type: "procedural",
                    explanation: `V = l √ó w √ó h = ${l} √ó ${w} √ó ${h} = ${l*w*h}` };
            } else {
                const r = rand(2, 5), h = rand(3, 8);
                return { question: `Cylinder: radius ${r}, height ${h}. Volume in terms of œÄ?`, answer: `${r*r*h}œÄ`, type: "procedural",
                    options: [`${r*r*h}œÄ`, `${r*h}œÄ`, `${2*r*r*h}œÄ`, `${r*r}œÄ`],
                    explanation: `V = œÄr¬≤h = œÄ(${r})¬≤(${h}) = ${r*r*h}œÄ` };
            }
        },
        Circles: () => {
            const r = rand(2, 10);
            const type = pick(["area", "circumference"]);
            if (type === "area") {
                return { question: `Circle radius ${r}. Area in terms of œÄ?`, answer: `${r*r}œÄ`, type: "procedural",
                    options: [`${r*r}œÄ`, `${2*r}œÄ`, `${r}œÄ`, `${2*r*r}œÄ`],
                    explanation: `A = œÄr¬≤ = œÄ(${r})¬≤ = ${r*r}œÄ` };
            } else {
                return { question: `Circle radius ${r}. Circumference in terms of œÄ?`, answer: `${2*r}œÄ`, type: "procedural",
                    options: [`${2*r}œÄ`, `${r*r}œÄ`, `${r}œÄ`, `${4*r}œÄ`],
                    explanation: `C = 2œÄr = 2œÄ(${r}) = ${2*r}œÄ` };
            }
        },
        Triangles: () => {
            const type = pick(["congruence", "angles"]);
            if (type === "congruence") {
                const rules = ["SSS", "SAS", "ASA", "AAS"];
                const invalid = "AAA";
                const answer = invalid;
                return { question: `Which does NOT prove triangle congruence?`, answer, type: "conceptual",
                    options: shuffle([...rules.slice(0, 3), invalid]),
                    explanation: `AAA proves similarity, not congruence. The triangles could be different sizes.` };
            } else {
                const a = rand(30, 80), b = rand(30, 80);
                const c = 180 - a - b;
                return { question: `Triangle angles: ${a}¬∞ and ${b}¬∞. Find third angle.`, answer: c, type: "procedural",
                    explanation: `Angles sum to 180¬∞. Third = 180 - ${a} - ${b} = ${c}¬∞` };
            }
        },
        Trigonometry: () => {
            const triples = [[3,4,5], [5,12,13], [8,15,17]];
            const [opp, adj, hyp] = pick(triples);
            const func = pick(["sin", "cos", "tan"]);
            let answer, explanation;
            if (func === "sin") { answer = `${opp}/${hyp}`; explanation = `sin = opposite/hypotenuse = ${opp}/${hyp}`; }
            else if (func === "cos") { answer = `${adj}/${hyp}`; explanation = `cos = adjacent/hypotenuse = ${adj}/${hyp}`; }
            else { answer = `${opp}/${adj}`; explanation = `tan = opposite/adjacent = ${opp}/${adj}`; }
            return { question: `Right triangle: opposite=${opp}, adjacent=${adj}, hypotenuse=${hyp}. Find ${func}(Œ∏).`, answer, type: "procedural",
                options: [`${opp}/${hyp}`, `${adj}/${hyp}`, `${opp}/${adj}`, `${hyp}/${opp}`], explanation };
        },
        Transformations: () => {
            const type = pick(["translate", "reflect", "rotate", "dilate"]);
            if (type === "translate") {
                const x = rand(1, 5), y = rand(1, 5);
                const dx = rand(2, 6), dy = rand(2, 6);
                return { question: `Point (${x}, ${y}) translated right ${dx} and up ${dy}. New point?`, answer: `(${x + dx}, ${y + dy})`, type: "procedural",
                    options: [`(${x + dx}, ${y + dy})`, `(${x - dx}, ${y + dy})`, `(${x + dx}, ${y - dy})`, `(${x + dy}, ${y + dx})`],
                    explanation: `Right ${dx}: x + ${dx} = ${x + dx}. Up ${dy}: y + ${dy} = ${y + dy}. New point: (${x + dx}, ${y + dy})` };
            } else if (type === "reflect") {
                const x = rand(1, 8), y = rand(1, 8);
                const axis = pick(["x-axis", "y-axis"]);
                const newPoint = axis === "x-axis" ? `(${x}, ${-y})` : `(${-x}, ${y})`;
                return { question: `Point (${x}, ${y}) reflected over the ${axis}. New point?`, answer: newPoint, type: "procedural",
                    options: [`(${x}, ${-y})`, `(${-x}, ${y})`, `(${-x}, ${-y})`, `(${y}, ${x})`],
                    explanation: `Reflect over ${axis}: ${axis === "x-axis" ? "negate y" : "negate x"}. New point: ${newPoint}` };
            } else if (type === "rotate") {
                const x = rand(1, 5), y = rand(1, 5);
                return { question: `Point (${x}, ${y}) rotated 180¬∞ about origin. New point?`, answer: `(${-x}, ${-y})`, type: "procedural",
                    options: [`(${-x}, ${-y})`, `(${x}, ${-y})`, `(${-x}, ${y})`, `(${y}, ${x})`],
                    explanation: `180¬∞ rotation: negate both coordinates. (${x}, ${y}) ‚Üí (${-x}, ${-y})` };
            } else {
                const x = rand(1, 4), y = rand(1, 4);
                const scale = rand(2, 3);
                return { question: `Point (${x}, ${y}) dilated by factor ${scale} from origin. New point?`, answer: `(${x * scale}, ${y * scale})`, type: "procedural",
                    options: [`(${x * scale}, ${y * scale})`, `(${x + scale}, ${y + scale})`, `(${x * scale}, ${y})`, `(${x}, ${y * scale})`],
                    explanation: `Dilation by ${scale}: multiply both coordinates. (${x}, ${y}) ‚Üí (${x * scale}, ${y * scale})` };
            }
        },
        Similarity: () => {
            const type = pick(["ratio", "find_side", "identify"]);
            if (type === "ratio") {
                const small = rand(3, 8), large = small * rand(2, 4);
                return { question: `Similar triangles have sides ${small} and ${large}. Scale factor?`, answer: large / small, type: "procedural",
                    explanation: `Scale factor = ${large}/${small} = ${large / small}` };
            } else if (type === "find_side") {
                const s1 = rand(4, 8), s2 = rand(6, 12), scale = rand(2, 3);
                const x = s2 * scale;
                return { question: `Similar triangles: sides ${s1} and ${s2} match to ${s1 * scale} and x. Find x.`, answer: x, type: "procedural",
                    explanation: `Scale factor = ${s1 * scale}/${s1} = ${scale}. So x = ${s2} √ó ${scale} = ${x}` };
            } else {
                return { question: `Two triangles have angles 30¬∞, 60¬∞, 90¬∞ and 30¬∞, 60¬∞, 90¬∞. Are they similar?`, answer: "Yes", type: "conceptual",
                    options: ["Yes", "No", "Need more info"],
                    explanation: `AA Similarity: If two angles are equal, triangles are similar.` };
            }
        },
        Congruence: () => {
            const type = pick(["postulate", "identify", "corresponding"]);
            if (type === "postulate") {
                const postulates = ["SSS", "SAS", "ASA", "AAS", "HL"];
                const post = pick(postulates);
                const descriptions = {
                    "SSS": "all three sides equal",
                    "SAS": "two sides and included angle equal",
                    "ASA": "two angles and included side equal",
                    "AAS": "two angles and non-included side equal",
                    "HL": "hypotenuse and leg of right triangles equal"
                };
                return { question: `Which postulate: ${descriptions[post]}?`, answer: post, type: "conceptual",
                    options: postulates,
                    explanation: `${post}: ${descriptions[post]}` };
            } else if (type === "identify") {
                const given = pick(["3 sides", "2 sides and included angle", "2 angles and 1 side"]);
                const answers = { "3 sides": "SSS", "2 sides and included angle": "SAS", "2 angles and 1 side": "ASA or AAS" };
                return { question: `Given: ${given}. Which congruence can you prove?`, answer: answers[given], type: "reasoning",
                    options: ["SSS", "SAS", "ASA or AAS", "Cannot prove"],
                    explanation: `With ${given}, use ${answers[given]} to prove congruence.` };
            } else {
                return { question: `If ‚ñ≥ABC ‚âÖ ‚ñ≥DEF, which side corresponds to BC?`, answer: "EF", type: "conceptual",
                    options: ["DE", "EF", "DF", "FE"],
                    explanation: `Corresponding parts: A‚ÜîD, B‚ÜîE, C‚ÜîF. So BC‚ÜîEF.` };
            }
        },
        Proofs: () => {
            const type = pick(["reason", "statement", "property"]);
            if (type === "reason") {
                const reasons = [
                    { statement: "If a = b and b = c, then a = c", reason: "Transitive Property" },
                    { statement: "If a = b, then b = a", reason: "Symmetric Property" },
                    { statement: "a = a", reason: "Reflexive Property" },
                    { statement: "If a = b, then a + c = b + c", reason: "Addition Property of Equality" }
                ];
                const r = pick(reasons);
                return { question: `"${r.statement}" uses which property?`, answer: r.reason, type: "conceptual",
                    options: ["Transitive Property", "Symmetric Property", "Reflexive Property", "Addition Property of Equality"],
                    explanation: `${r.reason}: ${r.statement}` };
            } else if (type === "statement") {
                return { question: `If ‚à†A and ‚à†B are supplementary and m‚à†A = 70¬∞, what can you conclude?`, answer: "m‚à†B = 110¬∞", type: "reasoning",
                    options: ["m‚à†B = 110¬∞", "m‚à†B = 70¬∞", "m‚à†B = 90¬∞", "m‚à†B = 180¬∞"],
                    explanation: `Supplementary angles sum to 180¬∞. So m‚à†B = 180¬∞ - 70¬∞ = 110¬∞` };
            } else {
                return { question: `Vertical angles are always:`, answer: "congruent", type: "conceptual",
                    options: ["congruent", "supplementary", "complementary", "adjacent"],
                    explanation: `Vertical Angles Theorem: Vertical angles are congruent.` };
            }
        },
        "Law of Sines": () => {
            const type = pick(["find_side", "find_angle", "formula"]);
            if (type === "formula") {
                return { question: `The Law of Sines states:`, answer: "a/sin(A) = b/sin(B) = c/sin(C)", type: "conceptual",
                    options: ["a/sin(A) = b/sin(B) = c/sin(C)", "a¬≤ + b¬≤ = c¬≤", "a/b = c/d", "sin¬≤(A) + cos¬≤(A) = 1"],
                    explanation: `Law of Sines: a/sin(A) = b/sin(B) = c/sin(C)` };
            } else if (type === "find_side") {
                const A = 30, B = 60, a = 5;
                const b = Math.round(a * Math.sin(B * Math.PI/180) / Math.sin(A * Math.PI/180));
                return { question: `Triangle: A=30¬∞, B=60¬∞, a=5. Find b using Law of Sines.`, answer: b, type: "procedural",
                    explanation: `b/sin(60¬∞) = 5/sin(30¬∞) ‚Üí b = 5 √ó sin(60¬∞)/sin(30¬∞) ‚âà ${b}` };
            } else {
                return { question: `When do you use Law of Sines?`, answer: "When you know AAS, ASA, or SSA", type: "conceptual",
                    options: ["When you know AAS, ASA, or SSA", "When you know SAS", "When you know SSS", "Only for right triangles"],
                    explanation: `Law of Sines is used when you have angle-side pairs (AAS, ASA, SSA).` };
            }
        },
        "Law of Cosines": () => {
            const type = pick(["formula", "find_side", "when_to_use"]);
            if (type === "formula") {
                return { question: `Law of Cosines formula for side c:`, answer: "c¬≤ = a¬≤ + b¬≤ - 2ab¬∑cos(C)", type: "conceptual",
                    options: ["c¬≤ = a¬≤ + b¬≤ - 2ab¬∑cos(C)", "c¬≤ = a¬≤ + b¬≤", "c = a + b", "c¬≤ = a¬≤ + b¬≤ + 2ab¬∑cos(C)"],
                    explanation: `Law of Cosines: c¬≤ = a¬≤ + b¬≤ - 2ab¬∑cos(C)` };
            } else if (type === "find_side") {
                const a = 5, b = 7, C = 60;
                const c = Math.round(Math.sqrt(a*a + b*b - 2*a*b*Math.cos(C * Math.PI/180)));
                return { question: `Triangle: a=5, b=7, C=60¬∞. Find c using Law of Cosines.`, answer: c, type: "procedural",
                    explanation: `c¬≤ = 25 + 49 - 2(5)(7)cos(60¬∞) = 74 - 35 = 39. c ‚âà ${c}` };
            } else {
                return { question: `When do you use Law of Cosines?`, answer: "When you know SAS or SSS", type: "conceptual",
                    options: ["When you know SAS or SSS", "When you know AAS", "When you know ASA", "Only for right triangles"],
                    explanation: `Law of Cosines is used for SAS (find third side) or SSS (find an angle).` };
            }
        },
        "Coordinate Geometry": () => {
            const type = pick(["midpoint", "distance", "slope"]);
            if (type === "midpoint") {
                const x1 = rand(2, 10), y1 = rand(2, 10), x2 = rand(2, 10), y2 = rand(2, 10);
                const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
                return { question: `Midpoint of (${x1}, ${y1}) and (${x2}, ${y2})?`, answer: `(${mx}, ${my})`, type: "procedural",
                    options: [`(${mx}, ${my})`, `(${(x1+x2)}, ${(y1+y2)})`, `(${x2-x1}, ${y2-y1})`, `(${Math.abs(x1-x2)}, ${Math.abs(y1-y2)})`],
                    explanation: `Midpoint = ((${x1}+${x2})/2, (${y1}+${y2})/2) = (${mx}, ${my})` };
            } else if (type === "distance") {
                const x1 = rand(1, 5), y1 = rand(1, 5), x2 = x1 + rand(3, 6), y2 = y1 + rand(3, 6);
                const dx = x2 - x1, dy = y2 - y1;
                const dist = Math.sqrt(dx*dx + dy*dy).toFixed(2);
                return { question: `Distance from (${x1}, ${y1}) to (${x2}, ${y2})?`, answer: parseFloat(dist), type: "procedural",
                    explanation: `d = ‚àö[(${x2}-${x1})¬≤ + (${y2}-${y1})¬≤] = ‚àö[${dx}¬≤ + ${dy}¬≤] = ‚àö${dx*dx + dy*dy} ‚âà ${dist}` };
            } else {
                const x1 = rand(1, 5), y1 = rand(1, 5), x2 = x1 + rand(2, 5), y2 = y1 + rand(2, 8);
                const slope = (y2 - y1) / (x2 - x1);
                return { question: `Slope of line through (${x1}, ${y1}) and (${x2}, ${y2})?`, answer: parseFloat(slope.toFixed(2)), type: "procedural",
                    explanation: `m = (${y2}-${y1})/(${x2}-${x1}) = ${y2-y1}/${x2-x1} = ${slope.toFixed(2)}` };
            }
        }
    },

    // TIER 7: Algebra II (11-12)
    7: {
        Quadratics: () => {
            const type = pick(["solve", "vertex"]);
            if (type === "solve") {
                const r1 = rand(1, 6), r2 = rand(1, 6);
                const b = -(r1 + r2), c = r1 * r2;
                return { question: `Solve: x¬≤ ${b >= 0 ? '+' : ''}${b}x + ${c} = 0`, answer: `x = ${r1}, ${r2}`, type: "procedural",
                    options: [`x = ${r1}, ${r2}`, `x = ${-r1}, ${-r2}`, `x = ${r1 + r2}, 0`, `x = ${c}, ${-b}`],
                    explanation: `Factor: (x - ${r1})(x - ${r2}) = 0. Solutions: x = ${r1} or x = ${r2}` };
            } else {
                const h = rand(1, 6), k = rand(-5, 5);
                return { question: `Vertex of y = (x - ${h})¬≤ ${k >= 0 ? '+' : ''}${k}?`, answer: `(${h}, ${k})`, type: "conceptual",
                    options: [`(${h}, ${k})`, `(${-h}, ${k})`, `(${h}, ${-k})`, `(${-h}, ${-k})`],
                    explanation: `Vertex form y = (x-h)¬≤ + k has vertex at (h, k) = (${h}, ${k})` };
            }
        },
        Logarithms: () => {
            const bases = [[2, 8, 3], [2, 16, 4], [3, 9, 2], [3, 27, 3], [10, 100, 2], [10, 1000, 3]];
            const [base, val, ans] = pick(bases);
            const type = pick(["eval", "property"]);
            if (type === "eval") {
                return { question: `log${base === 10 ? '' : '‚Çä'.replace('‚Çä', base)}(${val}) = ?`, answer: ans, type: "procedural",
                    explanation: `${base}^? = ${val}. Since ${base}^${ans} = ${val}, answer is ${ans}` };
            } else {
                const a = rand(2, 5), b = rand(2, 5);
                return { question: `Simplify: log(${a * b}) using log(${a}) + log(${b})`, answer: `log(${a}) + log(${b})`, type: "conceptual",
                    options: [`log(${a}) + log(${b})`, `log(${a}) √ó log(${b})`, `log(${a + b})`, `${a} √ó log(${b})`],
                    explanation: `log(ab) = log(a) + log(b). So log(${a*b}) = log(${a}) + log(${b})` };
            }
        },
        Polynomials: () => {
            const type = pick(["degree", "add"]);
            if (type === "degree") {
                const deg = rand(2, 5);
                const terms = [`${rand(1,5)}x^${deg}`, `${rand(1,5)}x^${deg-1}`, `${rand(1,5)}`].join(" + ");
                return { question: `Degree of ${terms}?`, answer: deg, type: "conceptual",
                    explanation: `Highest exponent is ${deg}, so degree = ${deg}` };
            } else {
                const a1 = rand(1, 4), a2 = rand(1, 4), b1 = rand(1, 5), b2 = rand(1, 5);
                return { question: `(${a1}x¬≤ + ${b1}x) + (${a2}x¬≤ + ${b2}x) = ?`, answer: `${a1+a2}x¬≤ + ${b1+b2}x`, type: "procedural",
                    options: [`${a1+a2}x¬≤ + ${b1+b2}x`, `${a1*a2}x¬≤ + ${b1*b2}x`, `${a1+a2}x‚Å¥ + ${b1+b2}x¬≤`, `${a1+b1}x¬≤ + ${a2+b2}x`],
                    explanation: `Combine like terms: (${a1}+${a2})x¬≤ + (${b1}+${b2})x = ${a1+a2}x¬≤ + ${b1+b2}x` };
            }
        },
        Sequences: () => {
            const type = pick(["arithmetic", "geometric", "sum"]);
            if (type === "arithmetic") {
                const a1 = rand(2, 10), d = rand(2, 5), n = rand(8, 12);
                const an = a1 + (n - 1) * d;
                return { question: `Arithmetic: first term ${a1}, common difference ${d}. Find term ${n}.`, answer: an, type: "procedural",
                    explanation: `a‚Çô = a‚ÇÅ + (n-1)d = ${a1} + ${n-1}(${d}) = ${a1} + ${(n-1)*d} = ${an}` };
            } else if (type === "geometric") {
                const a1 = rand(2, 5), r = rand(2, 3), n = rand(4, 6);
                const an = a1 * Math.pow(r, n - 1);
                return { question: `Geometric: first term ${a1}, ratio ${r}. Find term ${n}.`, answer: an, type: "procedural",
                    explanation: `a‚Çô = a‚ÇÅ √ó r^(n-1) = ${a1} √ó ${r}^${n-1} = ${a1} √ó ${Math.pow(r, n-1)} = ${an}` };
            } else {
                const n = rand(10, 20);
                const sum = (n * (n + 1)) / 2;
                return { question: `Sum: 1 + 2 + 3 + ... + ${n} = ?`, answer: sum, type: "procedural",
                    explanation: `Sum = n(n+1)/2 = ${n}(${n+1})/2 = ${sum}` };
            }
        },
        Probability: () => {
            const type = pick(["permutation", "combination"]);
            if (type === "permutation") {
                const n = rand(3, 6);
                let factorial = 1;
                for (let i = 2; i <= n; i++) factorial *= i;
                return { question: `How many ways to arrange ${n} items?`, answer: factorial, type: "procedural",
                    explanation: `${n}! = ${Array.from({length: n}, (_, i) => n - i).join(" √ó ")} = ${factorial}` };
            } else {
                const n = rand(4, 7), r = rand(2, 3);
                const nFact = (x) => { let f = 1; for (let i = 2; i <= x; i++) f *= i; return f; };
                const comb = nFact(n) / (nFact(r) * nFact(n - r));
                return { question: `Choose ${r} from ${n}. How many ways?`, answer: comb, type: "procedural",
                    explanation: `C(${n},${r}) = ${n}!/(${r}!√ó${n-r}!) = ${comb}` };
            }
        },
        "Conic Sections": () => {
            const type = pick(["identify", "circle", "parabola", "ellipse"]);
            if (type === "identify") {
                const conics = [
                    { eq: "x¬≤ + y¬≤ = 25", name: "circle", exp: "Both x¬≤ and y¬≤ with same coefficient" },
                    { eq: "y = x¬≤", name: "parabola", exp: "Only one variable is squared" },
                    { eq: "x¬≤/9 + y¬≤/4 = 1", name: "ellipse", exp: "x¬≤ and y¬≤ with different denominators, sum = 1" },
                    { eq: "x¬≤/9 - y¬≤/4 = 1", name: "hyperbola", exp: "x¬≤ and y¬≤ with subtraction" }
                ];
                const c = pick(conics);
                return { question: `Identify the conic: ${c.eq}`, answer: c.name, type: "conceptual",
                    options: ["circle", "parabola", "ellipse", "hyperbola"],
                    explanation: `${c.eq} is a ${c.name}. ${c.exp}` };
            } else if (type === "circle") {
                const r = rand(2, 8);
                return { question: `Circle x¬≤ + y¬≤ = ${r * r}. What is the radius?`, answer: r, type: "procedural",
                    explanation: `x¬≤ + y¬≤ = r¬≤. Here r¬≤ = ${r * r}, so r = ${r}` };
            } else if (type === "parabola") {
                const a = pick([1, 2, -1, -2]);
                const dir = a > 0 ? "upward" : "downward";
                return { question: `Parabola y = ${a === 1 ? '' : a === -1 ? '-' : a}x¬≤. Opens which direction?`, answer: dir, type: "conceptual",
                    options: ["upward", "downward", "left", "right"],
                    explanation: `When coefficient of x¬≤ is ${a > 0 ? "positive" : "negative"}, parabola opens ${dir}` };
            } else {
                const a = rand(2, 5), b = rand(2, 5);
                while (a === b) b = rand(2, 5);
                const major = a > b ? "horizontal" : "vertical";
                return { question: `Ellipse x¬≤/${a*a} + y¬≤/${b*b} = 1. Major axis is...?`, answer: major, type: "conceptual",
                    options: ["horizontal", "vertical"],
                    explanation: `Larger denominator (${Math.max(a*a, b*b)}) is under ${a > b ? "x¬≤" : "y¬≤"}, so major axis is ${major}` };
            }
        },
        "Completing the Square": () => {
            const type = pick(["rewrite", "solve", "vertex"]);
            if (type === "rewrite") {
                const b = rand(2, 8) * 2; // even number
                const c = rand(1, 10);
                const halfB = b / 2;
                return { question: `Complete the square: x¬≤ + ${b}x + ${c} = (x + ?)¬≤ + ?`, answer: `(x + ${halfB})¬≤ + ${c - halfB*halfB}`, type: "procedural",
                    options: [`(x + ${halfB})¬≤ + ${c - halfB*halfB}`, `(x + ${b})¬≤ + ${c}`, `(x + ${halfB})¬≤ + ${c}`, `(x + ${halfB})¬≤ - ${halfB*halfB}`],
                    explanation: `Half of ${b} is ${halfB}. x¬≤ + ${b}x + ${halfB}¬≤ = (x + ${halfB})¬≤. Adjust: ${c} - ${halfB*halfB} = ${c - halfB*halfB}` };
            } else if (type === "solve") {
                const r = rand(1, 5);
                const c = r * r;
                return { question: `Solve by completing the square: x¬≤ - ${2*r}x + ${c} = 0`, answer: r, type: "procedural",
                    explanation: `(x - ${r})¬≤ = 0, so x = ${r}` };
            } else {
                const h = rand(1, 5), k = rand(-5, 5);
                return { question: `y = (x - ${h})¬≤ + ${k}. Vertex is?`, answer: `(${h}, ${k})`, type: "conceptual",
                    options: [`(${h}, ${k})`, `(${-h}, ${k})`, `(${h}, ${-k})`, `(${k}, ${h})`],
                    explanation: `Vertex form y = (x - h)¬≤ + k has vertex at (h, k) = (${h}, ${k})` };
            }
        },
        "Piecewise Functions": () => {
            const type = pick(["evaluate", "identify", "graph"]);
            if (type === "evaluate") {
                const x = rand(-3, 5);
                const boundary = rand(0, 2);
                const ans = x < boundary ? x + 5 : 2 * x;
                return { question: `f(x) = {x + 5 if x < ${boundary}, 2x if x ‚â• ${boundary}}. Find f(${x}).`, answer: ans, type: "procedural",
                    explanation: `Since ${x} ${x < boundary ? '<' : '‚â•'} ${boundary}, use ${x < boundary ? 'x + 5' : '2x'}. f(${x}) = ${ans}` };
            } else if (type === "identify") {
                return { question: `A piecewise function has different rules for different:`, answer: "intervals of x", type: "conceptual",
                    options: ["intervals of x", "values of y", "slopes", "intercepts"],
                    explanation: `Piecewise functions have different rules for different intervals of x.` };
            } else {
                return { question: `At x = 2, f(x) = {x¬≤ if x < 2, 2x if x ‚â• 2}. Is f continuous at x = 2?`, answer: "Yes", type: "reasoning",
                    options: ["Yes", "No", "Cannot determine"],
                    explanation: `Left: 2¬≤ = 4. Right: 2(2) = 4. Both equal, so continuous.` };
            }
        },
        Asymptotes: () => {
            const type = pick(["vertical", "horizontal", "both"]);
            if (type === "vertical") {
                const a = rand(1, 6);
                return { question: `f(x) = 1/(x - ${a}). Vertical asymptote at x = ?`, answer: a, type: "procedural",
                    explanation: `Vertical asymptote where denominator = 0: x - ${a} = 0, so x = ${a}` };
            } else if (type === "horizontal") {
                const num = rand(2, 5), denom = rand(2, 5);
                return { question: `f(x) = ${num}x/(${denom}x + 1). Horizontal asymptote at y = ?`, answer: num / denom, type: "procedural",
                    explanation: `Same degree: HA = leading coefficients ratio = ${num}/${denom}` };
            } else {
                const a = rand(1, 4), b = rand(1, 4);
                return { question: `f(x) = (x + ${a})/(x - ${b}). Find both asymptotes.`, answer: `x = ${b}, y = 1`, type: "procedural",
                    options: [`x = ${b}, y = 1`, `x = ${-b}, y = 1`, `x = ${b}, y = 0`, `x = ${a}, y = 1`],
                    explanation: `VA: x - ${b} = 0 ‚Üí x = ${b}. HA: same degree ‚Üí y = 1/1 = 1` };
            }
        },
        Permutations: () => {
            const type = pick(["formula", "calculate", "word"]);
            if (type === "formula") {
                return { question: `The permutation formula P(n,r) equals:`, answer: "n!/(n-r)!", type: "conceptual",
                    options: ["n!/(n-r)!", "n!/r!", "n!/(n-r)!r!", "(n-r)!/n!"],
                    explanation: `P(n,r) = n!/(n-r)! counts ordered arrangements.` };
            } else if (type === "calculate") {
                const n = rand(4, 7), r = rand(2, 3);
                let result = 1;
                for (let i = 0; i < r; i++) result *= (n - i);
                return { question: `Calculate P(${n}, ${r})`, answer: result, type: "procedural",
                    explanation: `P(${n},${r}) = ${n}!/${n-r}! = ${Array.from({length: r}, (_, i) => n - i).join(' √ó ')} = ${result}` };
            } else {
                const n = rand(4, 6);
                let factorial = 1;
                for (let i = 2; i <= n; i++) factorial *= i;
                return { question: `How many ways to arrange ${n} different books on a shelf?`, answer: factorial, type: "reasoning",
                    explanation: `All different, order matters: ${n}! = ${factorial}` };
            }
        },
        Combinations: () => {
            const type = pick(["formula", "calculate", "word"]);
            if (type === "formula") {
                return { question: `The combination formula C(n,r) equals:`, answer: "n!/(r!(n-r)!)", type: "conceptual",
                    options: ["n!/(r!(n-r)!)", "n!/(n-r)!", "n!/r!", "(n-r)!"],
                    explanation: `C(n,r) = n!/(r!(n-r)!) counts unordered selections.` };
            } else if (type === "calculate") {
                const n = rand(5, 8), r = rand(2, 3);
                let num = 1, denom = 1;
                for (let i = 0; i < r; i++) { num *= (n - i); denom *= (i + 1); }
                const result = num / denom;
                return { question: `Calculate C(${n}, ${r})`, answer: result, type: "procedural",
                    explanation: `C(${n},${r}) = ${n}!/(${r}!${n-r}!) = ${result}` };
            } else {
                const n = rand(8, 12), r = rand(3, 4);
                let num = 1, denom = 1;
                for (let i = 0; i < r; i++) { num *= (n - i); denom *= (i + 1); }
                const result = num / denom;
                return { question: `How many ways to choose ${r} students from ${n} for a committee?`, answer: result, type: "reasoning",
                    explanation: `Order doesn't matter: C(${n},${r}) = ${result}` };
            }
        },
        "Expected Value": () => {
            const type = pick(["dice", "coins", "custom"]);
            if (type === "dice") {
                return { question: `Roll a fair die. What is the expected value?`, answer: 3.5, type: "procedural",
                    explanation: `E(X) = (1+2+3+4+5+6)/6 = 21/6 = 3.5` };
            } else if (type === "coins") {
                const win = rand(5, 10), lose = rand(2, 4);
                const ev = (0.5 * win - 0.5 * lose).toFixed(2);
                return { question: `Flip coin: win $${win} for heads, lose $${lose} for tails. Expected value?`, answer: parseFloat(ev), type: "procedural",
                    explanation: `E(X) = 0.5(${win}) + 0.5(-${lose}) = ${win/2} - ${lose/2} = ${ev}` };
            } else {
                const p1 = 0.3, v1 = rand(10, 20), p2 = 0.7, v2 = rand(2, 8);
                const ev = (p1 * v1 + p2 * v2).toFixed(2);
                return { question: `30% chance to win $${v1}, 70% chance to win $${v2}. Expected value?`, answer: parseFloat(ev), type: "procedural",
                    explanation: `E(X) = 0.3(${v1}) + 0.7(${v2}) = ${(p1*v1).toFixed(1)} + ${(p2*v2).toFixed(1)} = ${ev}` };
            }
        }
    },

    // TIER 8: Pre-Calculus (11-12)
    8: {
        Transformations: () => {
            const h = rand(1, 5), k = rand(1, 5);
            const type = pick(["horizontal", "vertical", "combined"]);
            if (type === "horizontal") {
                const dir = pick(["left", "right"]);
                const sign = dir === "right" ? "-" : "+";
                return { question: `f(x ${sign} ${h}) shifts the graph...`, answer: `${dir} ${h}`, type: "conceptual",
                    options: [`${dir} ${h}`, `${dir === "left" ? "right" : "left"} ${h}`, `up ${h}`, `down ${h}`],
                    explanation: `f(x ${sign} ${h}) shifts ${dir} by ${h} units` };
            } else if (type === "vertical") {
                const dir = pick(["up", "down"]);
                const sign = dir === "up" ? "+" : "-";
                return { question: `f(x) ${sign} ${k} shifts the graph...`, answer: `${dir} ${k}`, type: "conceptual",
                    options: [`${dir} ${k}`, `${dir === "up" ? "down" : "up"} ${k}`, `left ${k}`, `right ${k}`],
                    explanation: `f(x) ${sign} ${k} shifts ${dir} by ${k} units` };
            } else {
                return { question: `-f(x) does what to the graph?`, answer: "reflects over x-axis", type: "conceptual",
                    options: ["reflects over x-axis", "reflects over y-axis", "shifts up", "shifts down"],
                    explanation: `Negating f(x) reflects the graph over the x-axis` };
            }
        },
        "Trig Functions": () => {
            const values = [
                { angle: "œÄ/6", sin: "1/2", cos: "‚àö3/2", tan: "1/‚àö3" },
                { angle: "œÄ/4", sin: "‚àö2/2", cos: "‚àö2/2", tan: "1" },
                { angle: "œÄ/3", sin: "‚àö3/2", cos: "1/2", tan: "‚àö3" },
                { angle: "œÄ/2", sin: "1", cos: "0", tan: "undefined" }
            ];
            const v = pick(values);
            const func = pick(["sin", "cos"]);
            return { question: `${func}(${v.angle}) = ?`, answer: v[func], type: "procedural",
                options: ["1/2", "‚àö2/2", "‚àö3/2", "1"],
                explanation: `${func}(${v.angle}) = ${v[func]} (standard angle)` };
        },
        Limits: () => {
            const type = pick(["direct", "factor", "infinity"]);
            if (type === "direct") {
                const a = rand(1, 5), b = rand(1, 5);
                const c = rand(1, 4);
                const answer = a * c + b;
                return { question: `lim(x‚Üí${c}) (${a}x + ${b}) = ?`, answer, type: "procedural",
                    explanation: `Direct substitution: ${a}(${c}) + ${b} = ${answer}` };
            } else if (type === "factor") {
                const a = rand(1, 4);
                return { question: `lim(x‚Üí${a}) (x¬≤ - ${a*a})/(x - ${a}) = ?`, answer: 2 * a, type: "procedural",
                    explanation: `Factor: (x+${a})(x-${a})/(x-${a}) = x+${a}. At x=${a}: ${2*a}` };
            } else {
                const a = rand(2, 5), b = rand(1, 4);
                return { question: `lim(x‚Üí‚àû) (${a}x¬≤ + 1)/(${b}x¬≤ + x) = ?`, answer: a / b, type: "procedural",
                    explanation: `Highest powers: ${a}x¬≤/${b}x¬≤ = ${a}/${b} = ${(a/b).toFixed(2)}` };
            }
        },
        "Complex Numbers": () => {
            const type = pick(["i_power", "multiply", "add"]);
            if (type === "i_power") {
                const powers = [{ n: 2, ans: "-1" }, { n: 3, ans: "-i" }, { n: 4, ans: "1" }];
                const p = pick(powers);
                return { question: `i${["‚Å∞","¬π","¬≤","¬≥","‚Å¥"][p.n]} = ?`, answer: p.ans, type: "procedural",
                    options: ["1", "-1", "i", "-i"],
                    explanation: `i¬≤ = -1, i¬≥ = -i, i‚Å¥ = 1. So i^${p.n} = ${p.ans}` };
            } else if (type === "add") {
                const a = rand(1, 5), b = rand(1, 5), c = rand(1, 5), d = rand(1, 5);
                return { question: `(${a} + ${b}i) + (${c} + ${d}i) = ?`, answer: `${a+c} + ${b+d}i`, type: "procedural",
                    options: [`${a+c} + ${b+d}i`, `${a*c} + ${b*d}i`, `${a+c} + ${b*d}i`, `${a+b} + ${c+d}i`],
                    explanation: `Add real and imaginary parts: (${a}+${c}) + (${b}+${d})i = ${a+c} + ${b+d}i` };
            } else {
                const a = rand(1, 4), b = rand(1, 3);
                const answer = a * a + b * b;
                return { question: `(${a} + ${b}i)(${a} - ${b}i) = ?`, answer, type: "procedural",
                    explanation: `Conjugate product: a¬≤ + b¬≤ = ${a}¬≤ + ${b}¬≤ = ${answer}` };
            }
        },
        Vectors: () => {
            const type = pick(["add", "magnitude", "scalar"]);
            if (type === "add") {
                const a1 = rand(1, 5), a2 = rand(1, 5);
                const b1 = rand(1, 5), b2 = rand(1, 5);
                return { question: `‚ü®${a1}, ${a2}‚ü© + ‚ü®${b1}, ${b2}‚ü© = ?`, answer: `‚ü®${a1+b1}, ${a2+b2}‚ü©`, type: "procedural",
                    options: [`‚ü®${a1+b1}, ${a2+b2}‚ü©`, `‚ü®${a1*b1}, ${a2*b2}‚ü©`, `‚ü®${a1+a2}, ${b1+b2}‚ü©`, `‚ü®${a1-b1}, ${a2-b2}‚ü©`],
                    explanation: `Add components: ‚ü®${a1}+${b1}, ${a2}+${b2}‚ü© = ‚ü®${a1+b1}, ${a2+b2}‚ü©` };
            } else if (type === "magnitude") {
                const pairs = [[3, 4, 5], [5, 12, 13], [6, 8, 10]];
                const [a, b, mag] = pick(pairs);
                return { question: `Magnitude of ‚ü®${a}, ${b}‚ü© = ?`, answer: mag, type: "procedural",
                    explanation: `|v| = ‚àö(${a}¬≤ + ${b}¬≤) = ‚àö(${a*a} + ${b*b}) = ‚àö${mag*mag} = ${mag}` };
            } else {
                const k = rand(2, 4);
                const a = rand(1, 5), b = rand(1, 5);
                return { question: `${k}‚ü®${a}, ${b}‚ü© = ?`, answer: `‚ü®${k*a}, ${k*b}‚ü©`, type: "procedural",
                    options: [`‚ü®${k*a}, ${k*b}‚ü©`, `‚ü®${k+a}, ${k+b}‚ü©`, `‚ü®${a}, ${b}‚ü©`, `‚ü®${k*a}, ${b}‚ü©`],
                    explanation: `Multiply each component by ${k}: ‚ü®${k}√ó${a}, ${k}√ó${b}‚ü© = ‚ü®${k*a}, ${k*b}‚ü©` };
            }
        },
        "Advanced Functions": () => {
            const type = pick(["composite", "inverse", "domain"]);
            if (type === "composite") {
                const a = rand(2, 4), b = rand(1, 5);
                const x = rand(1, 4);
                const gx = a * x;
                const fgx = gx + b;
                return { question: `f(x) = x + ${b}, g(x) = ${a}x. Find f(g(${x})).`, answer: fgx, type: "procedural",
                    explanation: `g(${x}) = ${a}(${x}) = ${gx}. Then f(${gx}) = ${gx} + ${b} = ${fgx}` };
            } else if (type === "inverse") {
                const a = rand(2, 5);
                return { question: `f(x) = ${a}x. Find f‚Åª¬π(x).`, answer: `x/${a}`, type: "procedural",
                    options: [`x/${a}`, `${a}x`, `${a}/x`, `x - ${a}`],
                    explanation: `If f(x) = ${a}x, then f‚Åª¬π(x) = x/${a} (divide by ${a} to undo multiplication)` };
            } else {
                const a = rand(1, 5);
                return { question: `f(x) = ‚àö(x - ${a}). Domain is x ‚â• ?`, answer: a, type: "conceptual",
                    explanation: `Can't take square root of negative. x - ${a} ‚â• 0 means x ‚â• ${a}` };
            }
        },
        "Radian Measure": () => {
            const type = pick(["convert_to_rad", "convert_to_deg", "arc_length"]);
            if (type === "convert_to_rad") {
                const degrees = pick([30, 45, 60, 90, 120, 180, 270, 360]);
                const radians = { 30: "œÄ/6", 45: "œÄ/4", 60: "œÄ/3", 90: "œÄ/2", 120: "2œÄ/3", 180: "œÄ", 270: "3œÄ/2", 360: "2œÄ" };
                return { question: `Convert ${degrees}¬∞ to radians.`, answer: radians[degrees], type: "procedural",
                    options: ["œÄ/6", "œÄ/4", "œÄ/3", "œÄ/2", "2œÄ/3", "œÄ", "3œÄ/2", "2œÄ"].slice(0, 4),
                    explanation: `${degrees}¬∞ √ó (œÄ/180¬∞) = ${radians[degrees]}` };
            } else if (type === "convert_to_deg") {
                const rads = pick(["œÄ/6", "œÄ/4", "œÄ/3", "œÄ/2"]);
                const degs = { "œÄ/6": 30, "œÄ/4": 45, "œÄ/3": 60, "œÄ/2": 90 };
                return { question: `Convert ${rads} radians to degrees.`, answer: degs[rads], type: "procedural",
                    options: [30, 45, 60, 90],
                    explanation: `${rads} √ó (180¬∞/œÄ) = ${degs[rads]}¬∞` };
            } else {
                const r = rand(3, 8), theta = pick([Math.PI/2, Math.PI/3, Math.PI/4]);
                const arc = (r * theta).toFixed(2);
                const thetaStr = theta === Math.PI/2 ? "œÄ/2" : theta === Math.PI/3 ? "œÄ/3" : "œÄ/4";
                return { question: `Arc length: radius ${r}, central angle ${thetaStr}. (Round to 2 decimal places)`, answer: parseFloat(arc), type: "procedural",
                    explanation: `s = rŒ∏ = ${r} √ó ${thetaStr} ‚âà ${arc}` };
            }
        },
        "Inverse Trig": () => {
            const type = pick(["evaluate", "domain", "range"]);
            if (type === "evaluate") {
                const values = [
                    { input: "0", func: "sin‚Åª¬π", output: "0" },
                    { input: "1", func: "sin‚Åª¬π", output: "œÄ/2" },
                    { input: "1", func: "cos‚Åª¬π", output: "0" },
                    { input: "0", func: "cos‚Åª¬π", output: "œÄ/2" },
                    { input: "1", func: "tan‚Åª¬π", output: "œÄ/4" },
                    { input: "0", func: "tan‚Åª¬π", output: "0" }
                ];
                const v = pick(values);
                return { question: `Evaluate ${v.func}(${v.input})`, answer: v.output, type: "procedural",
                    options: ["0", "œÄ/6", "œÄ/4", "œÄ/3", "œÄ/2"],
                    explanation: `${v.func}(${v.input}) = ${v.output}` };
            } else if (type === "domain") {
                const func = pick(["sin‚Åª¬π", "cos‚Åª¬π"]);
                return { question: `What is the domain of ${func}(x)?`, answer: "[-1, 1]", type: "conceptual",
                    options: ["[-1, 1]", "all real numbers", "[0, œÄ]", "[-œÄ/2, œÄ/2]"],
                    explanation: `${func} only accepts inputs from -1 to 1 (sine and cosine output range).` };
            } else {
                const func = pick(["sin‚Åª¬π", "tan‚Åª¬π"]);
                const range = func === "sin‚Åª¬π" ? "[-œÄ/2, œÄ/2]" : "(-œÄ/2, œÄ/2)";
                return { question: `What is the range of ${func}(x)?`, answer: range, type: "conceptual",
                    options: ["[-œÄ/2, œÄ/2]", "(-œÄ/2, œÄ/2)", "[0, œÄ]", "all real numbers"],
                    explanation: `Range of ${func} is ${range}` };
            }
        },
        "Parametric Equations": () => {
            const type = pick(["evaluate", "eliminate", "identify"]);
            if (type === "evaluate") {
                const t = rand(1, 4);
                const x = 2 * t, y = t * t;
                return { question: `x = 2t, y = t¬≤. Find (x, y) when t = ${t}.`, answer: `(${x}, ${y})`, type: "procedural",
                    options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${t}, ${t})`, `(${x + y}, ${x * y})`],
                    explanation: `x = 2(${t}) = ${x}, y = ${t}¬≤ = ${y}. Point: (${x}, ${y})` };
            } else if (type === "eliminate") {
                return { question: `x = t + 1, y = t - 2. Eliminate the parameter.`, answer: "y = x - 3", type: "procedural",
                    options: ["y = x - 3", "y = x + 3", "y = 2x - 1", "y = x - 1"],
                    explanation: `From x = t + 1: t = x - 1. Substitute: y = (x - 1) - 2 = x - 3` };
            } else {
                return { question: `x = cos(t), y = sin(t) traces what shape?`, answer: "circle", type: "conceptual",
                    options: ["circle", "line", "parabola", "ellipse"],
                    explanation: `x¬≤ + y¬≤ = cos¬≤(t) + sin¬≤(t) = 1, which is a unit circle.` };
            }
        },
        "Polar Coordinates": () => {
            const type = pick(["convert_to_rect", "convert_to_polar", "identify"]);
            if (type === "convert_to_rect") {
                const r = rand(2, 5), theta = pick([0, Math.PI/2, Math.PI, 3*Math.PI/2]);
                const thetaStr = theta === 0 ? "0" : theta === Math.PI/2 ? "œÄ/2" : theta === Math.PI ? "œÄ" : "3œÄ/2";
                const x = Math.round(r * Math.cos(theta)), y = Math.round(r * Math.sin(theta));
                return { question: `Convert polar (${r}, ${thetaStr}) to rectangular.`, answer: `(${x}, ${y})`, type: "procedural",
                    options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${r}, ${r})`, `(${-x}, ${-y})`],
                    explanation: `x = r¬∑cos(Œ∏) = ${r}¬∑cos(${thetaStr}) = ${x}. y = r¬∑sin(Œ∏) = ${y}` };
            } else if (type === "convert_to_polar") {
                const pairs = [[3, 4, 5, "0.93"], [0, 5, 5, "œÄ/2"], [5, 0, 5, "0"], [-3, 0, 3, "œÄ"]];
                const [x, y, r, theta] = pick(pairs);
                return { question: `Convert rectangular (${x}, ${y}) to polar (r, Œ∏).`, answer: `(${r}, ${theta})`, type: "procedural",
                    explanation: `r = ‚àö(${x}¬≤ + ${y}¬≤) = ${r}. Œ∏ = arctan(${y}/${x}) ‚âà ${theta}` };
            } else {
                return { question: `r = 5 in polar coordinates represents a:`, answer: "circle with radius 5", type: "conceptual",
                    options: ["circle with radius 5", "line", "point", "spiral"],
                    explanation: `r = constant is a circle centered at origin with that radius.` };
            }
        },
        "Normal Distribution": () => {
            const type = pick(["z_score", "empirical", "interpret"]);
            if (type === "z_score") {
                const mean = rand(50, 80), sd = rand(5, 15), x = mean + sd * rand(1, 2);
                const z = (x - mean) / sd;
                return { question: `Mean = ${mean}, SD = ${sd}. Find z-score for x = ${x}.`, answer: z.toFixed(1), type: "procedural",
                    explanation: `z = (x - Œº)/œÉ = (${x} - ${mean})/${sd} = ${z.toFixed(1)}` };
            } else if (type === "empirical") {
                const pct = pick([68, 95, 99.7]);
                const sds = pct === 68 ? 1 : pct === 95 ? 2 : 3;
                return { question: `In a normal distribution, ${pct}% of data falls within how many standard deviations?`, answer: sds, type: "conceptual",
                    options: [1, 2, 3, 4],
                    explanation: `Empirical Rule: ${pct}% within ${sds} SD${sds > 1 ? 's' : ''} of the mean.` };
            } else {
                const z = pick([1, 2, -1, -2]);
                const direction = z > 0 ? "above" : "below";
                return { question: `A z-score of ${z} means the value is:`, answer: `${Math.abs(z)} SD ${direction} the mean`, type: "conceptual",
                    options: [`${Math.abs(z)} SD above the mean`, `${Math.abs(z)} SD below the mean`, "equal to the mean", `${Math.abs(z)} times the mean`],
                    explanation: `z = ${z} means ${Math.abs(z)} standard deviation${Math.abs(z) > 1 ? 's' : ''} ${direction} the mean.` };
            }
        }
    },

    // TIER 9: Calculus (12+)
    9: {
        Derivatives: () => {
            const type = pick(["power", "trig", "chain"]);
            if (type === "power") {
                const n = rand(2, 6);
                return { question: `d/dx(x${["‚Å∞","¬π","¬≤","¬≥","‚Å¥","‚Åµ","‚Å∂"][n]}) = ?`, answer: `${n}x^${n-1}`, type: "procedural",
                    options: [`${n}x^${n-1}`, `x^${n+1}`, `${n}x^${n}`, `x^${n-1}`],
                    explanation: `Power rule: d/dx(x^n) = nx^(n-1). So d/dx(x^${n}) = ${n}x^${n-1}` };
            } else if (type === "trig") {
                const funcs = [
                    { f: "sin(x)", d: "cos(x)" }, { f: "cos(x)", d: "-sin(x)" },
                    { f: "tan(x)", d: "sec¬≤(x)" }
                ];
                const func = pick(funcs);
                return { question: `d/dx(${func.f}) = ?`, answer: func.d, type: "procedural",
                    options: ["cos(x)", "-sin(x)", "sin(x)", "sec¬≤(x)"],
                    explanation: `d/dx(${func.f}) = ${func.d}` };
            } else {
                const a = rand(2, 5);
                return { question: `d/dx(${a}x¬≥) = ?`, answer: `${3*a}x¬≤`, type: "procedural",
                    options: [`${3*a}x¬≤`, `${a}x¬≤`, `${3*a}x¬≥`, `${a}x‚Å¥`],
                    explanation: `Constant multiple + power rule: ${a} √ó 3x¬≤ = ${3*a}x¬≤` };
            }
        },
        Integrals: () => {
            const type = pick(["power", "trig", "definite"]);
            if (type === "power") {
                const n = rand(1, 4);
                return { question: `‚à´x${["‚Å∞","¬π","¬≤","¬≥","‚Å¥"][n]} dx = ?`, answer: `x^${n+1}/${n+1} + C`, type: "procedural",
                    options: [`x^${n+1}/${n+1} + C`, `${n}x^${n-1} + C`, `x^${n+1} + C`, `x^${n}/${n} + C`],
                    explanation: `Power rule: ‚à´x^n dx = x^(n+1)/(n+1) + C` };
            } else if (type === "trig") {
                const funcs = [
                    { f: "cos(x)", i: "sin(x) + C" }, { f: "sin(x)", i: "-cos(x) + C" }
                ];
                const func = pick(funcs);
                return { question: `‚à´${func.f} dx = ?`, answer: func.i, type: "procedural",
                    options: ["sin(x) + C", "-cos(x) + C", "cos(x) + C", "-sin(x) + C"],
                    explanation: `‚à´${func.f} dx = ${func.i}` };
            } else {
                const a = 0, b = rand(2, 4);
                const answer = (b * b) / 2;
                return { question: `‚à´‚ÇÄ${["‚Å∞","¬π","¬≤","¬≥","‚Å¥"][b]} x dx = ?`, answer, type: "procedural",
                    explanation: `[x¬≤/2]‚ÇÄ^${b} = ${b}¬≤/2 - 0 = ${answer}` };
            }
        },
        Limits: () => {
            const type = pick(["fundamental", "lhopital"]);
            if (type === "fundamental") {
                return { question: `lim(x‚Üí0) sin(x)/x = ?`, answer: 1, type: "procedural",
                    explanation: `This is a fundamental limit: lim(x‚Üí0) sin(x)/x = 1` };
            } else {
                const a = rand(2, 4);
                return { question: `lim(x‚Üí0) (e^(${a}x) - 1)/${a}x = ?`, answer: 1, type: "procedural",
                    explanation: `Using L'H√¥pital's or substitution: limit = 1` };
            }
        },
        Applications: () => {
            const type = pick(["critical", "maxmin"]);
            if (type === "critical") {
                const a = rand(1, 3);
                return { question: `f(x) = x¬≤ - ${2*a}x. Find critical point.`, answer: a, type: "procedural",
                    explanation: `f'(x) = 2x - ${2*a} = 0. x = ${a}` };
            } else {
                return { question: `If f'(c) = 0 and f''(c) > 0, then x = c is a...`, answer: "local minimum", type: "conceptual",
                    options: ["local minimum", "local maximum", "inflection point", "saddle point"],
                    explanation: `Second derivative test: f''(c) > 0 means concave up, so minimum` };
            }
        },
        "Differential Equations": () => {
            const type = pick(["identify", "verify", "separate"]);
            if (type === "identify") {
                const eqs = [
                    { eq: "dy/dx = 2x", order: 1, type: "first-order" },
                    { eq: "d¬≤y/dx¬≤ + y = 0", order: 2, type: "second-order" },
                    { eq: "dy/dx = y", order: 1, type: "first-order" }
                ];
                const e = pick(eqs);
                return { question: `What order is ${e.eq}?`, answer: e.type, type: "conceptual",
                    options: ["first-order", "second-order", "third-order"],
                    explanation: `Highest derivative is ${e.order === 1 ? "dy/dx" : "d¬≤y/dx¬≤"}, so it's ${e.type}` };
            } else if (type === "verify") {
                const a = rand(2, 4);
                return { question: `Is y = e^(${a}x) a solution to dy/dx = ${a}y?`, answer: "yes", type: "conceptual",
                    options: ["yes", "no"],
                    explanation: `dy/dx = ${a}e^(${a}x) = ${a}y ‚úì Yes, it satisfies the equation.` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve: dy/dx = ${a}. What is y?`, answer: `${a}x + C`, type: "procedural",
                    options: [`${a}x + C`, `${a}x`, `x/${a} + C`, `e^(${a}x)`],
                    explanation: `Integrate both sides: y = ‚à´${a} dx = ${a}x + C` };
            }
        },
        "Chain Rule": () => {
            const type = pick(["basic", "trig", "exponential"]);
            if (type === "basic") {
                const a = rand(2, 4), n = rand(2, 4);
                return { question: `d/dx(${a}x + 1)^${n} = ?`, answer: `${a * n}(${a}x + 1)^${n - 1}`, type: "procedural",
                    options: [`${a * n}(${a}x + 1)^${n - 1}`, `${n}(${a}x + 1)^${n - 1}`, `${a}(${a}x + 1)^${n}`, `${n}x^${n - 1}`],
                    explanation: `Chain rule: ${n}(${a}x + 1)^${n-1} √ó ${a} = ${a * n}(${a}x + 1)^${n - 1}` };
            } else if (type === "trig") {
                const a = rand(2, 5);
                return { question: `d/dx[sin(${a}x)] = ?`, answer: `${a}cos(${a}x)`, type: "procedural",
                    options: [`${a}cos(${a}x)`, `cos(${a}x)`, `-${a}cos(${a}x)`, `${a}sin(${a}x)`],
                    explanation: `Chain rule: cos(${a}x) √ó ${a} = ${a}cos(${a}x)` };
            } else {
                const a = rand(2, 4);
                return { question: `d/dx[e^(${a}x)] = ?`, answer: `${a}e^(${a}x)`, type: "procedural",
                    options: [`${a}e^(${a}x)`, `e^(${a}x)`, `${a}e^x`, `xe^(${a}x)`],
                    explanation: `Chain rule: e^(${a}x) √ó ${a} = ${a}e^(${a}x)` };
            }
        },
        "Product Rule": () => {
            const type = pick(["basic", "trig"]);
            if (type === "basic") {
                const a = rand(2, 4);
                return { question: `d/dx[x ¬∑ e^(${a}x)] = ?`, answer: `e^(${a}x) + ${a}xe^(${a}x)`, type: "procedural",
                    options: [`e^(${a}x) + ${a}xe^(${a}x)`, `${a}xe^(${a}x)`, `e^(${a}x)`, `${a}e^(${a}x)`],
                    explanation: `Product rule: (1)¬∑e^(${a}x) + x¬∑(${a}e^(${a}x)) = e^(${a}x) + ${a}xe^(${a}x)` };
            } else {
                return { question: `d/dx[x¬∑sin(x)] = ?`, answer: "sin(x) + x¬∑cos(x)", type: "procedural",
                    options: ["sin(x) + x¬∑cos(x)", "x¬∑cos(x)", "sin(x)", "cos(x)"],
                    explanation: `Product rule: (1)¬∑sin(x) + x¬∑cos(x) = sin(x) + x¬∑cos(x)` };
            }
        },
        "Integration Techniques": () => {
            const type = pick(["substitution", "parts", "trig"]);
            if (type === "substitution") {
                const a = rand(2, 4);
                return { question: `‚à´${a}x¬∑e^(x¬≤) dx. What substitution?`, answer: "u = x¬≤", type: "procedural",
                    options: ["u = x¬≤", "u = e^(x¬≤)", "u = x", "u = ${a}x"],
                    explanation: `Let u = x¬≤, du = 2x dx. Rewrite as (${a}/2)‚à´e^u du` };
            } else if (type === "parts") {
                return { question: `‚à´x¬∑e^x dx uses integration by parts. What is u?`, answer: "u = x", type: "procedural",
                    options: ["u = x", "u = e^x", "u = xe^x", "u = 1"],
                    explanation: `LIATE rule: Logarithms, Inverse trig, Algebraic (x), Trig, Exponential. Pick u = x.` };
            } else {
                return { question: `‚à´sin¬≤(x) dx uses which identity?`, answer: "sin¬≤(x) = (1 - cos(2x))/2", type: "conceptual",
                    options: ["sin¬≤(x) = (1 - cos(2x))/2", "sin¬≤(x) + cos¬≤(x) = 1", "sin(2x) = 2sin(x)cos(x)", "cos¬≤(x) = (1 + cos(2x))/2"],
                    explanation: `Power-reducing: sin¬≤(x) = (1 - cos(2x))/2 makes integration easier.` };
            }
        }
    },

    // TIER 10: Advanced (College)
    10: {
        "Partial Derivatives": () => {
            const a = rand(2, 5), b = rand(1, 4);
            const type = pick(["x", "y"]);
            if (type === "x") {
                return { question: `‚àÇ/‚àÇx(${a}x¬≤y + ${b}xy) = ?`, answer: `${2*a}xy + ${b}y`, type: "procedural",
                    options: [`${2*a}xy + ${b}y`, `${a}x¬≤  + ${b}x`, `${2*a}x + ${b}`, `${a}y + ${b}y`],
                    explanation: `Treat y as constant: ‚àÇ/‚àÇx(${a}x¬≤y) = ${2*a}xy, ‚àÇ/‚àÇx(${b}xy) = ${b}y` };
            } else {
                return { question: `‚àÇ/‚àÇy(${a}x¬≤y + ${b}y¬≤) = ?`, answer: `${a}x¬≤ + ${2*b}y`, type: "procedural",
                    options: [`${a}x¬≤ + ${2*b}y`, `${2*a}xy + ${b}y`, `${a}x¬≤ + ${b}y`, `${2*a}x + ${2*b}y`],
                    explanation: `Treat x as constant: ‚àÇ/‚àÇy(${a}x¬≤y) = ${a}x¬≤, ‚àÇ/‚àÇy(${b}y¬≤) = ${2*b}y` };
            }
        },
        Matrices: () => {
            const type = pick(["determinant", "multiply_size"]);
            if (type === "determinant") {
                const a = rand(1, 4), b = rand(1, 4), c = rand(1, 4), d = rand(1, 4);
                const det = a * d - b * c;
                return { question: `det([${a} ${b}; ${c} ${d}]) = ?`, answer: det, type: "procedural",
                    explanation: `det = ad - bc = ${a}√ó${d} - ${b}√ó${c} = ${det}` };
            } else {
                const m = rand(2, 4), n = rand(2, 4), p = rand(2, 4);
                return { question: `(${m}√ó${n}) √ó (${n}√ó${p}) matrix = ?`, answer: `${m}√ó${p}`, type: "procedural",
                    options: [`${m}√ó${p}`, `${n}√ó${n}`, `${m}√ó${n}`, `${n}√ó${p}`],
                    explanation: `(m√ón)(n√óp) = m√óp. Result: ${m}√ó${p}` };
            }
        },
        Series: () => {
            const type = pick(["geometric", "convergence"]);
            if (type === "geometric") {
                const a = rand(1, 3), r = pick([0.5, 0.25, 0.1]);
                const sum = a / (1 - r);
                return { question: `Sum of infinite geometric: a=${a}, r=${r}?`, answer: sum, type: "procedural",
                    explanation: `S = a/(1-r) = ${a}/(1-${r}) = ${a}/${1-r} = ${sum}` };
            } else {
                return { question: `Œ£(1/n¬≤) from n=1 to ‚àû converges or diverges?`, answer: "converges", type: "conceptual",
                    options: ["converges", "diverges"],
                    explanation: `p-series with p=2 > 1, so it converges` };
            }
        },
        "Discrete Math": () => {
            const type = pick(["subsets", "pigeonhole"]);
            if (type === "subsets") {
                const n = rand(3, 6);
                return { question: `How many subsets of a ${n}-element set?`, answer: Math.pow(2, n), type: "procedural",
                    explanation: `2^n = 2^${n} = ${Math.pow(2, n)} subsets` };
            } else {
                const n = rand(3, 5);
                return { question: `${n*2 + 1} items in ${n} boxes. Min items in one box?`, answer: 3, type: "reasoning",
                    explanation: `Pigeonhole: ‚åà${n*2+1}/${n}‚åâ = ‚åà${(n*2+1)/n}‚åâ = 3` };
            }
        },
        "Multivariable Calculus": () => {
            const type = pick(["gradient", "double", "chain"]);
            if (type === "gradient") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `f(x,y) = ${a}x + ${b}y. Find ‚àáf.`, answer: `‚ü®${a}, ${b}‚ü©`, type: "procedural",
                    options: [`‚ü®${a}, ${b}‚ü©`, `‚ü®${b}, ${a}‚ü©`, `${a} + ${b}`, `‚ü®${a*b}, 0‚ü©`],
                    explanation: `‚àáf = ‚ü®‚àÇf/‚àÇx, ‚àÇf/‚àÇy‚ü© = ‚ü®${a}, ${b}‚ü©` };
            } else if (type === "double") {
                const a = rand(2, 4);
                return { question: `‚à´‚à´ ${a} dA over unit square [0,1]√ó[0,1] = ?`, answer: a, type: "procedural",
                    explanation: `‚à´‚ÇÄ¬π‚à´‚ÇÄ¬π ${a} dx dy = ${a}(1)(1) = ${a}` };
            } else {
                return { question: `If z = f(x,y), x = g(t), y = h(t), then dz/dt uses...`, answer: "chain rule", type: "conceptual",
                    options: ["chain rule", "product rule", "quotient rule", "power rule"],
                    explanation: `dz/dt = (‚àÇz/‚àÇx)(dx/dt) + (‚àÇz/‚àÇy)(dy/dt) - the multivariable chain rule` };
            }
        },
        "Linear Algebra": () => {
            const type = pick(["eigenvalue", "span", "independence"]);
            if (type === "eigenvalue") {
                const a = rand(2, 5);
                return { question: `If Av = ${a}v, then ${a} is called a(n)...`, answer: "eigenvalue", type: "conceptual",
                    options: ["eigenvalue", "eigenvector", "determinant", "trace"],
                    explanation: `When Av = Œªv, Œª (here ${a}) is an eigenvalue and v is an eigenvector.` };
            } else if (type === "span") {
                return { question: `Vectors ‚ü®1,0‚ü© and ‚ü®0,1‚ü© span...`, answer: "‚Ñù¬≤", type: "conceptual",
                    options: ["‚Ñù¬≤", "‚Ñù", "‚Ñù¬≥", "a line"],
                    explanation: `These two vectors can create any point in the plane, so they span ‚Ñù¬≤` };
            } else {
                return { question: `‚ü®1,2‚ü© and ‚ü®2,4‚ü© are linearly...`, answer: "dependent", type: "conceptual",
                    options: ["dependent", "independent"],
                    explanation: `‚ü®2,4‚ü© = 2‚ü®1,2‚ü©, so one is a multiple of the other - linearly dependent` };
            }
        }
    }
};

// ========================================
// LESSON GENERATORS FOR LEARNING CENTER
// ========================================
const lessons = {
    1: {
        Counting: () => {
            return {
                goalProblem: `Count the stars: ‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ`,
                teachingSteps: [
                    {
                        title: "What is counting?",
                        explanation: "Counting means finding out <strong>how many</strong> things there are. We say numbers in order (1, 2, 3, 4...) while pointing to each item.",
                        visual: "1 ‚Üí 2 ‚Üí 3 ‚Üí 4 ‚Üí 5 ‚Üí ..."
                    },
                    {
                        title: "The Golden Rule: One touch, one number",
                        explanation: "Point to each item <strong>exactly once</strong>. Don't skip any items, and don't count any item twice!",
                        visual: "‚òÖ = 1 count (not 0, not 2)"
                    },
                    {
                        title: "Let's count our stars - Start at the left",
                        explanation: "We always start on the left side and move right. This keeps us organized. Touch the first star and say '1'.",
                        visual: "‚òÖ(1)  ‚òÖ  ‚òÖ  ‚òÖ  ‚òÖ  ‚òÖ"
                    },
                    {
                        title: "Keep going - touch and count each star",
                        explanation: "Move to the next star, say the next number. Keep going until you've touched every star.",
                        visual: "‚òÖ(1) ‚òÖ(2) ‚òÖ(3) ‚òÖ(4) ‚òÖ(5) ‚òÖ(6)"
                    },
                    {
                        title: "The answer is the LAST number you said",
                        explanation: "We stopped at 6. That means there are 6 stars! The last number always tells you the total.",
                        visual: "Last number said = <strong>6</strong>"
                    }
                ],
                finalAnswer: "6 stars",
                answerExplanation: "We counted each star once, from left to right: 1, 2, 3, 4, 5, 6. The last number (6) is our answer!",
                example: { problem: `Count the stars: ‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ ‚òÖ`, steps: [
                    { text: "Start at the left and point to each star", math: "‚òÖ(1) ‚òÖ(2) ‚òÖ(3) ‚òÖ(4) ‚òÖ(5) ‚òÖ(6)" },
                    { text: "Say each number as you touch each star", math: "One... two... three... four... five... six" },
                    { text: "The LAST number you said is your answer", math: "We stopped at 6, so there are <strong>6 stars</strong>" }
                ]},
                keyPoints: [
                    "Point to each item as you count - this keeps you organized",
                    "The LAST number you say tells you the total",
                    "Go slow! It's better to be careful than fast"
                ],
                mistakes: [
                    { wrong: "Counting too fast and skipping items", why: "Touch each item as you count. Say the number out loud." },
                    { wrong: "Counting the same item twice", why: "Move left to right in a line. Mark items if needed." },
                    { wrong: "Stopping before counting all items", why: "Make sure you've touched every single item." }
                ],
                guided: {
                    problem: `Count the dots: ‚óè ‚óè ‚óè ‚óè ‚óè`,
                    steps: [
                        { label: "Touch and count each dot", value: "‚óè(1) ‚óè(2) ‚óè(3) ‚óè(4) ‚óè(5)" },
                        { label: "What was the last number?", value: "?" }
                    ],
                    answer: "5",
                    answerLabel: "How many dots?",
                    interactiveSteps: [
                        {
                            prompt: "When counting, we touch each item and say a number. Start at the first dot - what number do you say?",
                            hint: "We always start counting at...",
                            answer: "1",
                            acceptableAnswers: ["1", "one"],
                            commonMistakes: {
                                "0": "We start counting at 1, not 0! Touch the first dot and say '1'.",
                                "2": "Start at the beginning! The first item is always 1."
                            }
                        },
                        {
                            prompt: "Now count each dot from left to right: ‚óè(1) ‚óè(2) ‚óè(3) ‚óè(4) ‚óè(?). What number goes on the last dot?",
                            hint: "After 4 comes...",
                            answer: "5",
                            acceptableAnswers: ["5", "five"],
                            commonMistakes: {
                                "4": "You stopped too early! After ‚óè(4), there's one more dot.",
                                "6": "Count again - there are only 5 dots, not 6."
                            }
                        },
                        {
                            prompt: "The LAST number you said tells you the total. How many dots are there?",
                            hint: "What was the last number you counted to?",
                            answer: "5",
                            acceptableAnswers: ["5", "five", "5 dots"],
                            commonMistakes: {
                                "1": "That's the first number. The LAST number (5) tells us the total!",
                                "15": "Don't add up the numbers! The last number you said IS the answer."
                            }
                        }
                    ]
                },
                practice: { problem: `Count: ‚ñ≤ ‚ñ≤ ‚ñ≤ ‚ñ≤ ‚ñ≤ ‚ñ≤ ‚ñ≤`, answer: "7", options: ["5", "6", "7", "8"],
                    mistakeAnalysis: {
                        "5": "You missed 2 triangles. Go slower - point to EACH one: ‚ñ≤(1) ‚ñ≤(2) ‚ñ≤(3) ‚ñ≤(4) ‚ñ≤(5) ‚ñ≤(6) ‚ñ≤(7)",
                        "6": "You missed 1 triangle. Count again carefully from left to right.",
                        "8": "You counted one triangle twice. Remember: each item gets counted only ONCE."
                    }}
            };
        },
        Addition: () => {
            const a = rand(3, 6), b = rand(2, 4);
            return {
                goalProblem: `What is 5 + 3?`,
                teachingSteps: [
                    {
                        title: "What does addition mean?",
                        explanation: "Addition means <strong>putting two groups together</strong> to find the total. The + sign means 'add' or 'plus'.",
                        visual: "‚óè‚óè‚óè + ‚óè‚óè = ?"
                    },
                    {
                        title: "The counting-up method",
                        explanation: "To add, we <strong>start at the first number</strong> and <strong>count up</strong> by the second number. Where we land is our answer!",
                        visual: "Start ‚Üí Count up ‚Üí Land on answer"
                    },
                    {
                        title: "Let's solve 5 + 3 - Start at 5",
                        explanation: "Put your finger on 5. This is where we <strong>start</strong>. Don't count 5 as 'one' - it's our starting point!",
                        visual: "Start at: 5"
                    },
                    {
                        title: "Now count up 3 times",
                        explanation: "Starting from 5, count up 3 numbers: <strong>6, 7, 8</strong>. Use your fingers to keep track - put up 3 fingers and lower one for each count.",
                        visual: "5 ‚Üí 6 (one) ‚Üí 7 (two) ‚Üí 8 (three)"
                    },
                    {
                        title: "Where did we land?",
                        explanation: "We landed on <strong>8</strong>! That's our answer. We can check: 5 dots + 3 dots = 8 dots.",
                        visual: "‚óè‚óè‚óè‚óè‚óè + ‚óè‚óè‚óè = ‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè"
                    }
                ],
                finalAnswer: "5 + 3 = 8",
                answerExplanation: "Starting at 5 and counting up 3 times (6, 7, 8), we land on 8!",
                example: { problem: `What is 5 + 3?`, steps: [
                    { text: "Start at the first number", math: "Put your finger on 5" },
                    { text: "Count UP by the second number (3 times)", math: "5... then 6, 7, 8 (that's 3 more)" },
                    { text: "You landed on 8!", math: "5 + 3 = <strong>8</strong>" }
                ]},
                keyPoints: [
                    "Start AT the first number (don't count it as 'one')",
                    "Count up as many times as the second number says",
                    "You can also add by combining: ‚óè‚óè‚óè‚óè‚óè + ‚óè‚óè‚óè = ‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè (8 dots)"
                ],
                mistakes: [
                    { wrong: "Counting the first number (5, 6, 7, 8 = wrong!)", why: "START at 5, then count 6, 7, 8. That's adding 3." },
                    { wrong: "Writing 5 + 3 = 53", why: "We're not putting digits next to each other - we're combining amounts!" },
                    { wrong: "Losing track of how many you counted up", why: "Use your fingers to keep track: hold up 3 fingers and put them down one by one." }
                ],
                guided: {
                    problem: `What is ${a} + ${b}?`,
                    steps: [
                        { label: "Start at", value: `${a}` },
                        { label: `Count up ${b} more`, value: `${a}... ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}` },
                        { label: "You landed on", value: "?" }
                    ],
                    answer: String(a + b),
                    answerLabel: `${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `To add ${a} + ${b}, we start at the first number. What number do we start at?`,
                            hint: "Look at the first number in the problem",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            commonMistakes: {
                                [String(b)]: `That's the second number. We START at the first number: ${a}`,
                                "1": `Don't start at 1! Start at the first number: ${a}`,
                                "0": `Start at ${a}, not at 0!`
                            }
                        },
                        {
                            prompt: `Now count UP ${b} times from ${a}. Say the numbers out loud: ${a}... then what comes next?`,
                            hint: `What's one more than ${a}?`,
                            answer: String(a + 1),
                            acceptableAnswers: [String(a + 1)],
                            commonMistakes: {
                                [String(a)]: `${a} is where we started. Now count UP one: ${a + 1}`,
                                [String(a + b)]: `That's the final answer! But let's count up one at a time. After ${a} comes ${a + 1}`
                            }
                        },
                        {
                            prompt: `Keep counting! ${a}, ${a + 1}... After counting up ${b} times total, where do you land?`,
                            hint: `Count: ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}`,
                            answer: String(a + b),
                            acceptableAnswers: [String(a + b)],
                            commonMistakes: {
                                [String(a + b - 1)]: `You stopped one short! Count ${b} full times: ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}`,
                                [String(a + b + 1)]: `You counted one too many! Only count up ${b} times.`,
                                [String(a)]: `You didn't count up! Starting at ${a}, count up ${b} more.`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1, pb = b; return { problem: `What is ${pa} + ${pb}?`, answer: String(pa + pb),
                    options: shuffle([String(pa + pb), String(pa + pb - 1), String(pa + pb + 1), String(pa + pb - 2)]),
                    mistakeAnalysis: {
                        [String(pa + pb - 1)]: `You undercounted by 1. Start at ${pa}, then count up ${pb}: ${Array.from({length: pb}, (_, i) => pa + i + 1).join(', ')}`,
                        [String(pa + pb + 1)]: "You counted one too many. Make sure you only count up " + pb + " times.",
                        [String(pa + pb - 2)]: `You undercounted by 2. Remember to count up exactly ${pb} times from ${pa}.`
                    }}; })()
            };
        },
        Subtraction: () => {
            const a = rand(8, 12), b = rand(3, 5);
            return {
                goalProblem: `What is 9 - 4?`,
                teachingSteps: [
                    {
                        title: "What does subtraction mean?",
                        explanation: "Subtraction means <strong>taking away</strong> from a group. The ‚àí sign (minus) means 'take away' or 'subtract'.",
                        visual: "‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè take away ‚óè‚óè‚óè‚óè = ?"
                    },
                    {
                        title: "The counting-back method",
                        explanation: "To subtract, we <strong>start at the first number</strong> and <strong>count backwards</strong> by the second number. Where we land is our answer!",
                        visual: "Start ‚Üí Count back ‚Üí Land on answer"
                    },
                    {
                        title: "Let's solve 9 - 4 - Start at 9",
                        explanation: "Put your finger on 9. This is where we <strong>start</strong>. Don't count 9 as 'one' - it's our starting point!",
                        visual: "Start at: 9"
                    },
                    {
                        title: "Now count BACK 4 times",
                        explanation: "Starting from 9, count backwards 4 numbers: <strong>8, 7, 6, 5</strong>. Use your fingers - put up 4 fingers and lower one for each count back.",
                        visual: "9 ‚Üí 8 (one) ‚Üí 7 (two) ‚Üí 6 (three) ‚Üí 5 (four)"
                    },
                    {
                        title: "Where did we land?",
                        explanation: "We landed on <strong>5</strong>! That's our answer. Think of it as: 'I had 9 things, I took away 4, now I have 5 left.'",
                        visual: "‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè ‚àí ‚óè‚óè‚óè‚óè = ‚óè‚óè‚óè‚óè‚óè"
                    }
                ],
                finalAnswer: "9 - 4 = 5",
                answerExplanation: "Starting at 9 and counting back 4 times (8, 7, 6, 5), we land on 5!",
                example: { problem: `What is 9 - 4?`, steps: [
                    { text: "Start at the first number", math: "Put your finger on 9" },
                    { text: "Count BACK by the second number (4 times)", math: "9... then 8, 7, 6, 5 (that's going back 4)" },
                    { text: "You landed on 5!", math: "9 - 4 = <strong>5</strong>" }
                ]},
                keyPoints: [
                    "Start AT the first number, then count backwards",
                    "Count back as many times as the second number says",
                    "Think: 'I have 9, I take away 4, I have 5 left'"
                ],
                mistakes: [
                    { wrong: "Counting the starting number (9, 8, 7, 6 = wrong!)", why: "START at 9, then go back: 8, 7, 6, 5. The answer is 5." },
                    { wrong: "Adding instead of subtracting", why: "The minus sign (‚àí) means go DOWN, not up!" },
                    { wrong: "Subtracting in the wrong order (4 - 9)", why: "Always start with the FIRST number. 9 - 4 is not the same as 4 - 9." }
                ],
                guided: {
                    problem: `What is ${a} - ${b}?`,
                    steps: [
                        { label: "Start at", value: `${a}` },
                        { label: `Count back ${b}`, value: `${a}... ${Array.from({length: b}, (_, i) => a - i - 1).join(', ')}` },
                        { label: "You landed on", value: "?" }
                    ],
                    answer: String(a - b),
                    answerLabel: `${a} - ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `For ${a} - ${b}, we start at the first number. What number do we start at?`,
                            hint: "Look at the first number in the problem",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            commonMistakes: {
                                [String(b)]: `That's the second number. We START at ${a}`,
                                [String(a - b)]: `That's the answer! But first we need to start at ${a}`
                            }
                        },
                        {
                            prompt: `Now count BACK (down) ${b} times. Starting at ${a}, what's the first number when we go back?`,
                            hint: `What's one less than ${a}?`,
                            answer: String(a - 1),
                            acceptableAnswers: [String(a - 1)],
                            commonMistakes: {
                                [String(a)]: `${a} is where we started. Now go BACK one: ${a - 1}`,
                                [String(a + 1)]: `That's going UP! We need to go DOWN (subtract). One less than ${a} is ${a - 1}`
                            }
                        },
                        {
                            prompt: `Keep counting back! ${a}, ${a - 1}... After counting back ${b} times, where do you land?`,
                            hint: `Count backwards: ${Array.from({length: b}, (_, i) => a - i - 1).join(', ')}`,
                            answer: String(a - b),
                            acceptableAnswers: [String(a - b)],
                            commonMistakes: {
                                [String(a - b + 1)]: `You didn't count back far enough! Go back ${b} full times.`,
                                [String(a - b - 1)]: `You counted back one too many! Only count back ${b} times.`,
                                [String(a + b)]: `You added instead of subtracted! Count BACKWARDS from ${a}.`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1; return { problem: `What is ${pa} - ${b}?`, answer: String(pa - b),
                    options: shuffle([String(pa - b), String(pa - b - 1), String(pa - b + 1), String(pa + b)]),
                    mistakeAnalysis: {
                        [String(pa - b - 1)]: "You went back one too many. Count carefully: start at " + pa + " and go back exactly " + b + " times.",
                        [String(pa - b + 1)]: "You didn't go back enough. Make sure you count back " + b + " full times.",
                        [String(pa + b)]: "Oops! You added instead of subtracted. The ‚àí sign means count BACKWARDS."
                    }}; })()
            };
        },
        Shapes: () => ({
            goalProblem: `How many sides does a triangle have?`,
            teachingSteps: [
                {
                    title: "What is a 'side'?",
                    explanation: "A <strong>side</strong> is a straight line on the outside edge of a shape. We count these lines to identify shapes!",
                    visual: "Side = one straight edge"
                },
                {
                    title: "Shape names come from number of sides",
                    explanation: "Each shape has a special name based on how many sides it has. The name gives us a clue!",
                    visual: "TRI = 3 | QUAD = 4 | PENTA = 5 | HEXA = 6"
                },
                {
                    title: "Let's look at a triangle",
                    explanation: "Here's a triangle: ‚ñ≥. We need to count how many straight lines make up its edges.",
                    visual: "‚ñ≥"
                },
                {
                    title: "Count each side",
                    explanation: "Go around the triangle and count each straight edge: one on the left, one on the right, one on the bottom.",
                    visual: "Side 1 (left) + Side 2 (right) + Side 3 (bottom)"
                },
                {
                    title: "The answer is in the name!",
                    explanation: "<strong>TRI</strong> means 3. A <strong>TRI</strong>angle has <strong>3 sides</strong>. The name tells us the answer!",
                    visual: "TRI-angle = 3 sides"
                }
            ],
            finalAnswer: "3 sides",
            answerExplanation: "A triangle has 3 sides. 'Tri' means 3, so TRI-angle = 3 angles and 3 sides!",
            example: { problem: `How many sides does a triangle have?`, steps: [
                { text: "Look at the triangle", math: "‚ñ≥" },
                { text: "Count each straight edge around the outside", math: "Side 1 (left) + Side 2 (right) + Side 3 (bottom) = 3" },
                { text: "A triangle has...", math: "<strong>3 sides</strong> (that's why it's called a TRI-angle!)" }
            ]},
            keyPoints: [
                "TRI means 3 ‚Üí Triangle has 3 sides",
                "QUAD means 4 ‚Üí Quadrilateral has 4 sides",
                "PENTA means 5 ‚Üí Pentagon has 5 sides",
                "HEXA means 6 ‚Üí Hexagon has 6 sides"
            ],
            mistakes: [
                { wrong: "Confusing sides with corners", why: "Sides are the LINES. Corners are where lines MEET." },
                { wrong: "Thinking a circle has 1 side", why: "A circle has 0 straight sides - it's curved all around!" }
            ],
            guided: {
                problem: `How many sides does a square have?`,
                steps: [
                    { label: "Picture the square", value: "‚ñ° (it has a top, bottom, left, and right)" },
                    { label: "Count the sides", value: "Top(1) + Right(2) + Bottom(3) + Left(4)" },
                    { label: "Total sides", value: "?" }
                ],
                answer: "4",
                answerLabel: "Number of sides:",
                interactiveSteps: [
                    {
                        prompt: "What is a 'side' of a shape?",
                        hint: "It's one of the straight lines on the edge...",
                        answer: "straight edge",
                        acceptableAnswers: ["straight edge", "straight line", "edge", "line", "a line", "a straight line"],
                        commonMistakes: {
                            "corner": "A corner is where two sides MEET. A side is the straight line itself!",
                            "angle": "An angle is formed where sides meet. A side is the straight edge."
                        }
                    },
                    {
                        prompt: "Look at a square: ‚ñ°. Start at the top and go around. How many straight lines do you count?",
                        hint: "Count: top, right side, bottom, left side...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        commonMistakes: {
                            "2": "You might have only counted top/bottom or left/right. Count ALL four sides!",
                            "8": "Each side is counted ONCE. Go around: top(1), right(2), bottom(3), left(4)."
                        }
                    },
                    {
                        prompt: "A square has 4 sides. What do we call a shape with 4 sides?",
                        hint: "QUAD means 4...",
                        answer: "quadrilateral",
                        acceptableAnswers: ["quadrilateral", "quad", "rectangle", "square"],
                        commonMistakes: {
                            "triangle": "TRI means 3. A shape with 4 sides is a QUADrilateral (QUAD = 4)",
                            "pentagon": "PENTA means 5. A shape with 4 sides is a QUADrilateral."
                        }
                    }
                ]
            },
            practice: { problem: `How many sides does a hexagon have?`, answer: "6", options: ["4", "5", "6", "8"],
                mistakeAnalysis: {
                    "4": "That's a quadrilateral/square. HEXA means 6!",
                    "5": "That's a pentagon. HEXA means 6!",
                    "8": "That's an octagon. HEXA means 6!"
                }}
        }),
        "Place Value": () => {
            const tens = rand(2, 8), ones = rand(1, 9);
            const num = tens * 10 + ones;
            return {
                goalProblem: `In the number 58, what digit is in the tens place?`,
                teachingSteps: [
                    {
                        title: "What is place value?",
                        explanation: "<strong>Place value</strong> tells us what each digit in a number is worth. The same digit can mean different amounts depending on where it sits!",
                        visual: "The 5 in '50' is worth more than the 5 in '5'"
                    },
                    {
                        title: "Two-digit numbers have two places",
                        explanation: "In a 2-digit number, there are two positions: the <strong>tens place</strong> (left) and the <strong>ones place</strong> (right).",
                        visual: "[TENS] [ONES]"
                    },
                    {
                        title: "Let's look at 58",
                        explanation: "The number 58 has two digits. Let's figure out which digit is in which place.",
                        visual: "58 ‚Üí [?] [?]"
                    },
                    {
                        title: "The LEFT digit is in the tens place",
                        explanation: "In 58, the digit <strong>5</strong> is on the left, so it's in the <strong>tens place</strong>. It's worth 5 √ó 10 = 50!",
                        visual: "58 ‚Üí [5=tens] [8]"
                    },
                    {
                        title: "The RIGHT digit is in the ones place",
                        explanation: "The digit <strong>8</strong> is on the right, so it's in the <strong>ones place</strong>. It's worth just 8.",
                        visual: "58 = 50 + 8 = 5 tens + 8 ones"
                    }
                ],
                finalAnswer: "5",
                answerExplanation: "The digit in the tens place is 5. It's on the LEFT side. Remember: LEFT = tens, RIGHT = ones!",
                example: { problem: `In the number 58, what digit is in the tens place?`, steps: [
                    { text: "Write the number and label each place", math: "58 ‚Üí [5][8]" },
                    { text: "Left digit = tens, Right digit = ones", math: "5 is in tens place, 8 is in ones place" },
                    { text: "The tens digit is...", math: "<strong>5</strong> (worth 50)" }
                ]},
                keyPoints: [
                    "In a 2-digit number: LEFT = tens, RIGHT = ones",
                    "The tens place is worth 10√ó more than the ones place",
                    "Example: 36 = 3 tens + 6 ones = 30 + 6"
                ],
                mistakes: [
                    { wrong: "Mixing up left and right", why: "Remember: Tens is on the LEFT (like how you read left-to-right, tens comes first)" },
                    { wrong: "Thinking 5 tens = 5", why: "5 tens = 5 √ó 10 = 50, not 5!" }
                ],
                guided: {
                    problem: `In the number ${num}, what digit is in the tens place?`,
                    steps: [
                        { label: "The number is", value: `${num}` },
                        { label: "Left digit is tens", value: `${tens} is on the left` },
                        { label: "Tens digit is", value: "?" }
                    ],
                    answer: String(tens),
                    answerLabel: "Tens digit:",
                    interactiveSteps: [
                        {
                            prompt: `In a 2-digit number like ${num}, which position is the TENS place - left or right?`,
                            hint: "We read left to right, and tens comes before ones...",
                            answer: "left",
                            acceptableAnswers: ["left", "the left", "on the left"],
                            commonMistakes: {
                                "right": "The RIGHT digit is the ones place. TENS is on the LEFT!"
                            }
                        },
                        {
                            prompt: `Look at ${num}. What digit is on the LEFT side?`,
                            hint: `The number is ${num}. The left digit is...`,
                            answer: String(tens),
                            acceptableAnswers: [String(tens)],
                            commonMistakes: {
                                [String(ones)]: `That's the ones digit (on the right). The LEFT digit is ${tens}`,
                                [String(num)]: `That's the whole number! We need just the LEFT digit: ${tens}`
                            }
                        },
                        {
                            prompt: `So the digit ${tens} is in the tens place. How much is ${tens} tens worth?`,
                            hint: `${tens} tens = ${tens} √ó 10 = ?`,
                            answer: String(tens * 10),
                            acceptableAnswers: [String(tens * 10)],
                            commonMistakes: {
                                [String(tens)]: `${tens} is the digit, but ${tens} TENS = ${tens} √ó 10 = ${tens * 10}`,
                                [String(tens + 10)]: `Don't add! Multiply: ${tens} √ó 10 = ${tens * 10}`
                            }
                        }
                    ]
                },
                practice: { problem: `What number has 7 tens and 2 ones?`, answer: "72", options: ["27", "72", "79", "702"],
                    mistakeAnalysis: {
                        "27": "You switched them! Tens come FIRST (on the left). 7 tens = 70, plus 2 ones = 72",
                        "79": "Close! 7 tens is correct, but we need 2 ones, not 9",
                        "702": "7 tens = 70, not 700. The answer is 72"
                    }}
            };
        },
        Patterns: () => {
            const start = rand(2, 5);
            const step = rand(2, 4);
            return {
                goalProblem: `What comes next? 2, 5, 8, 11, ?`,
                teachingSteps: [
                    {
                        title: "What is a pattern?",
                        explanation: "A <strong>pattern</strong> is a set of numbers that follow a rule. Once we find the rule, we can figure out what comes next!",
                        visual: "Pattern = numbers following a rule"
                    },
                    {
                        title: "Find the 'gap' between numbers",
                        explanation: "To find the rule, look at the <strong>difference</strong> between each pair of numbers. How much do we add to get from one number to the next?",
                        visual: "2 ‚Üí ? ‚Üí 5 ‚Üí ? ‚Üí 8 ‚Üí ? ‚Üí 11"
                    },
                    {
                        title: "Calculate each gap",
                        explanation: "Let's find the gap between each pair: 2 to 5 is +3, 5 to 8 is +3, 8 to 11 is +3. The gap is always the same!",
                        visual: "2 ‚Üí(+3)‚Üí 5 ‚Üí(+3)‚Üí 8 ‚Üí(+3)‚Üí 11"
                    },
                    {
                        title: "The rule is: Add 3 each time",
                        explanation: "Every time we move to the next number, we add 3. This is our rule! A pattern that adds the same number is called an 'arithmetic pattern'.",
                        visual: "Rule: +3"
                    },
                    {
                        title: "Apply the rule to find the answer",
                        explanation: "The last number is 11. Add 3 to get the next number: 11 + 3 = <strong>14</strong>",
                        visual: "11 ‚Üí(+3)‚Üí 14"
                    }
                ],
                finalAnswer: "14",
                answerExplanation: "The pattern adds 3 each time. Starting from 11, we add 3 to get 14!",
                example: { problem: `What comes next? 2, 5, 8, 11, ?`, steps: [
                    { text: "Find the difference between each pair", math: "2‚Üí5 is +3, 5‚Üí8 is +3, 8‚Üí11 is +3" },
                    { text: "The rule is: add 3 each time", math: "This pattern adds 3" },
                    { text: "Apply the rule to find the next number", math: "11 + 3 = <strong>14</strong>" }
                ]},
                keyPoints: [
                    "Look at the GAPS between numbers, not just the numbers",
                    "Check that your rule works for ALL the numbers in the pattern",
                    "Common patterns: +1, +2, +3, +5, +10, √ó2"
                ],
                mistakes: [
                    { wrong: "Just guessing the next number", why: "Find the rule first! What's being added each time?" },
                    { wrong: "Finding a rule that only works for some numbers", why: "Your rule must work for EVERY step in the pattern." }
                ],
                guided: {
                    problem: `What comes next? ${start}, ${start+step}, ${start+2*step}, ${start+3*step}, ?`,
                    steps: [
                        { label: "Find the gap between numbers", value: `${start}‚Üí${start+step} is +${step}, ${start+step}‚Üí${start+2*step} is +${step}` },
                        { label: "The rule is", value: `Add ${step} each time` },
                        { label: "Next number", value: "?" }
                    ],
                    answer: String(start + 4*step),
                    answerLabel: "What comes next?",
                    interactiveSteps: [
                        {
                            prompt: `Look at ${start}, ${start+step}, ${start+2*step}... What's the difference between ${start} and ${start+step}?`,
                            hint: `${start+step} - ${start} = ?`,
                            answer: String(step),
                            acceptableAnswers: [String(step), `+${step}`],
                            commonMistakes: {
                                [String(start)]: `That's the first number. The DIFFERENCE is ${start+step} - ${start} = ${step}`,
                                [String(start + step)]: `That's the second number. Subtract to find the gap: ${start+step} - ${start} = ${step}`
                            }
                        },
                        {
                            prompt: `The gap is ${step}. Check: is the gap the same between ${start+step} and ${start+2*step}?`,
                            hint: `${start+2*step} - ${start+step} = ?`,
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "yep", String(step), `+${step}`],
                            commonMistakes: {
                                "no": `Actually, ${start+2*step} - ${start+step} = ${step}, same as before! The rule is add ${step}.`
                            }
                        },
                        {
                            prompt: `The rule is: add ${step} each time. The last number is ${start+3*step}. What comes next?`,
                            hint: `${start+3*step} + ${step} = ?`,
                            answer: String(start + 4*step),
                            acceptableAnswers: [String(start + 4*step)],
                            commonMistakes: {
                                [String(start + 3*step)]: `That's the last number given. Add ${step} more: ${start+3*step} + ${step} = ${start+4*step}`,
                                [String(start + 3*step + 1)]: `You added 1 instead of ${step}. The rule is +${step}, so ${start+3*step} + ${step} = ${start+4*step}`,
                                [String(start + 5*step)]: `You added ${step} twice! Only add it once: ${start+3*step} + ${step} = ${start+4*step}`
                            }
                        }
                    ]
                },
                practice: { problem: `What comes next? 4, 8, 12, 16, ?`, answer: "20", options: ["17", "18", "20", "24"],
                    mistakeAnalysis: {
                        "17": "You added 1 instead of 4. The pattern is +4 each time: 16 + 4 = 20",
                        "18": "You added 2 instead of 4. Check the gaps: 4‚Üí8 is +4, 8‚Üí12 is +4",
                        "24": "You added 8 instead of 4. The gaps are +4, not +8."
                    }}
            };
        },
        "Skip Counting": () => ({
            goalProblem: `Count by 5s starting at 5. What comes after 20?`,
            teachingSteps: [
                {
                    title: "What is skip counting?",
                    explanation: "<strong>Skip counting</strong> means counting by a number other than 1. Instead of 1, 2, 3, 4... we skip some numbers!",
                    visual: "Regular: 1, 2, 3, 4, 5... | Skip by 2s: 2, 4, 6, 8, 10..."
                },
                {
                    title: "Why skip count?",
                    explanation: "Skip counting helps us count faster! It's also the foundation for <strong>multiplication</strong>. Counting by 5s is the same as the 5 times table!",
                    visual: "5, 10, 15, 20 = 5√ó1, 5√ó2, 5√ó3, 5√ó4"
                },
                {
                    title: "Let's count by 5s",
                    explanation: "When we count by 5s, we add 5 each time. Start at 5, then 10, then 15, then 20...",
                    visual: "5 ‚Üí(+5)‚Üí 10 ‚Üí(+5)‚Üí 15 ‚Üí(+5)‚Üí 20"
                },
                {
                    title: "What comes after 20?",
                    explanation: "We're at 20 and need to find the next number. Since we're counting by 5s, we add 5!",
                    visual: "20 + 5 = ?"
                },
                {
                    title: "The answer",
                    explanation: "20 + 5 = <strong>25</strong>. The next number when counting by 5s after 20 is 25!",
                    visual: "5, 10, 15, 20, <strong>25</strong>"
                }
            ],
            finalAnswer: "25",
            answerExplanation: "When counting by 5s, we add 5 each time. 20 + 5 = 25!",
            example: { problem: `Count by 5s starting at 5. What comes after 20?`, steps: [
                { text: "List what we know", math: "5, 10, 15, 20, ?" },
                { text: "Each number is 5 more than the last", math: "5+5=10, 10+5=15, 15+5=20, 20+5=?" },
                { text: "Add 5 to find the next number", math: "20 + 5 = <strong>25</strong>" }
            ]},
            keyPoints: [
                "Skip counting by 2s: all even numbers (ends in 0, 2, 4, 6, 8)",
                "Skip counting by 5s: ends in 0 or 5",
                "Skip counting by 10s: always ends in 0"
            ],
            mistakes: [
                { wrong: "Adding 1 instead of the skip number", why: "If counting by 5s, add 5 each time, not 1!" },
                { wrong: "Losing track of the skip amount", why: "Say it out loud: 'plus 5, plus 5, plus 5...'" }
            ],
            guided: {
                problem: `Count by 2s: 2, 4, 6, 8, ?`,
                steps: [
                    { label: "What are we counting by?", value: "2s (adding 2 each time)" },
                    { label: "The last number is", value: "8" },
                    { label: "Add 2 to get", value: "?" }
                ],
                answer: "10",
                answerLabel: "What comes next?",
                interactiveSteps: [
                    {
                        prompt: "We're 'skip counting by 2s'. What number do we add each time?",
                        hint: "Look at the sequence: 2, 4, 6, 8... What's the difference between each number?",
                        answer: "2",
                        acceptableAnswers: ["2", "two", "+2"],
                        commonMistakes: {
                            "1": "If we added 1 each time, we'd get 2, 3, 4, 5... But we're skipping to 2, 4, 6, 8 (adding 2)",
                            "4": "Check the gaps: 4-2=2, 6-4=2, 8-6=2. We add 2 each time!"
                        }
                    },
                    {
                        prompt: "The last number in our list is 8. What do we add to find the next number?",
                        hint: "We're counting by 2s, so we add...",
                        answer: "2",
                        acceptableAnswers: ["2", "two", "+2"],
                        commonMistakes: {
                            "8": "8 is the last number. We need to ADD 2 to it!",
                            "1": "We're skip counting by 2, not by 1. Add 2!"
                        }
                    },
                    {
                        prompt: "8 + 2 = ? What's the next number in our sequence?",
                        hint: "Add 2 to 8...",
                        answer: "10",
                        acceptableAnswers: ["10", "ten"],
                        commonMistakes: {
                            "9": "You added 1 instead of 2. 8 + 2 = 10",
                            "82": "We ADD, not combine digits! 8 + 2 = 10",
                            "6": "You subtracted! We ADD 2: 8 + 2 = 10"
                        }
                    }
                ]
            },
            practice: { problem: `Count by 10s: 30, 40, 50, 60, ?`, answer: "70", options: ["61", "65", "70", "100"],
                mistakeAnalysis: {
                    "61": "You added 1 instead of 10. When counting by 10s, add 10: 60 + 10 = 70",
                    "65": "You added 5 instead of 10. This is counting by 10s, not 5s.",
                    "100": "That's too big of a jump. We're adding 10, not 40."
                }}
        }),
        Comparison: () => ({
            goalProblem: `Which is greater: 7 or 4?`,
            teachingSteps: [
                {
                    title: "What does 'comparing' mean?",
                    explanation: "<strong>Comparing numbers</strong> means deciding which number is bigger (greater) or smaller (less than). We use special symbols to show this!",
                    visual: "Bigger? Smaller? Or Equal?"
                },
                {
                    title: "The comparison symbols",
                    explanation: "We use three symbols: <strong>></strong> (greater than), <strong><</strong> (less than), and <strong>=</strong> (equals). The open side always faces the BIGGER number!",
                    visual: "> means greater than | < means less than | = means equal"
                },
                {
                    title: "The 'hungry alligator' trick",
                    explanation: "Think of > and < as an alligator's mouth. The alligator is hungry and always wants to eat the BIGGER number! The open mouth faces the bigger one.",
                    visual: "7 > 4 (alligator wants the 7!)"
                },
                {
                    title: "Let's compare 7 and 4",
                    explanation: "Think about counting: 1, 2, 3, 4, 5, 6, 7... Numbers that come later when counting are bigger. 7 comes after 4!",
                    visual: "1, 2, 3, <u>4</u>, 5, 6, <u>7</u> ‚Üê 7 is farther along"
                },
                {
                    title: "7 is greater than 4",
                    explanation: "Since 7 is bigger, the open mouth (the 'greater than' symbol) faces 7. We write: <strong>7 > 4</strong>",
                    visual: "7 > 4"
                }
            ],
            finalAnswer: "7 > 4",
            answerExplanation: "7 is greater than 4 because 7 comes after 4 when counting. The > symbol opens toward the bigger number (7).",
            example: { problem: `Which is greater: 7 or 4?`, steps: [
                { text: "Think about counting", math: "When we count, we say: 1, 2, 3, 4, 5, 6, 7..." },
                { text: "Numbers that come later are bigger", math: "7 comes after 4, so 7 is greater" },
                { text: "The answer", math: "<strong>7 > 4</strong> (7 is greater than 4)" }
            ]},
            keyPoints: [
                "Think of a number line: numbers on the RIGHT are bigger",
                "The 'hungry alligator' eats the bigger number: 7 > 4",
                "For 2-digit numbers: compare tens first, then ones"
            ],
            mistakes: [
                { wrong: "Confusing > and <", why: "The symbol points TO the smaller number. The open mouth faces the bigger number." },
                { wrong: "Only looking at one digit in 2-digit numbers", why: "32 > 29 even though 9 > 2, because 3 tens > 2 tens" }
            ],
            guided: {
                problem: `Which is greater: 12 or 8?`,
                steps: [
                    { label: "Count up to find which is bigger", value: "...6, 7, 8, 9, 10, 11, 12" },
                    { label: "12 comes after 8, so", value: "12 is greater" },
                    { label: "Answer", value: "?" }
                ],
                answer: "12",
                answerLabel: "Which is greater?",
                interactiveSteps: [
                    {
                        prompt: "When we count up (1, 2, 3, 4...), which number comes LATER: 12 or 8?",
                        hint: "Numbers that come later when counting are bigger...",
                        answer: "12",
                        acceptableAnswers: ["12", "twelve"],
                        commonMistakes: {
                            "8": "When counting: ...7, 8, 9, 10, 11, 12. 12 comes LATER, so 12 is greater!"
                        }
                    },
                    {
                        prompt: "If 12 comes after 8, that means 12 is ______ than 8.",
                        hint: "Bigger numbers come later when counting...",
                        answer: "greater",
                        acceptableAnswers: ["greater", "bigger", "larger", "more"],
                        commonMistakes: {
                            "less": "Numbers that come LATER are GREATER. 12 comes after 8, so 12 is GREATER.",
                            "smaller": "12 is bigger! Later in counting = greater."
                        }
                    },
                    {
                        prompt: "What symbol shows '12 is greater than 8'? Is it 12 > 8 or 12 < 8?",
                        hint: "The open side of the symbol points to the bigger number...",
                        answer: "12 > 8",
                        acceptableAnswers: ["12 > 8", ">", "12>8"],
                        commonMistakes: {
                            "12 < 8": "< means 'less than'. Since 12 is GREATER, we use >: 12 > 8",
                            "<": "< means less than. We want GREATER than, which is >"
                        }
                    }
                ]
            },
            practice: { problem: `Compare: 15 ? 9 (use >, <, or =)`, answer: ">", options: ["<", ">", "="],
                mistakeAnalysis: {
                    "<": "15 is BIGGER than 9, so we need the 'greater than' symbol: 15 > 9",
                    "=": "15 and 9 are not equal. 15 is bigger, so 15 > 9"
                }}
        })
    },
    2: {
        Multiplication: () => {
            const a = rand(3, 5), b = rand(2, 4);
            return {
                goalProblem: `What is 4 √ó 3?`,
                teachingSteps: [
                    {
                        title: "What is multiplication?",
                        explanation: "<strong>Multiplication</strong> is a faster way to add the same number many times. Instead of writing 3+3+3+3, we can write 4√ó3!",
                        visual: "3 + 3 + 3 + 3 = 4 √ó 3"
                    },
                    {
                        title: "What does 4 √ó 3 mean?",
                        explanation: "4 √ó 3 means '<strong>4 groups of 3</strong>' or '3 added 4 times'. The √ó symbol means 'groups of'.",
                        visual: "4 √ó 3 = '4 groups of 3'"
                    },
                    {
                        title: "Let's picture it",
                        explanation: "Imagine 4 groups with 3 dots in each group. We need to count all the dots!",
                        visual: "‚óè‚óè‚óè  ‚óè‚óè‚óè  ‚óè‚óè‚óè  ‚óè‚óè‚óè"
                    },
                    {
                        title: "Add the groups together",
                        explanation: "We have 4 groups of 3. Let's add: 3 + 3 = 6, then 6 + 3 = 9, then 9 + 3 = 12.",
                        visual: "3 + 3 + 3 + 3 = 12"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>4 √ó 3 = 12</strong>. You can also skip count by 3s four times: 3, 6, 9, 12!",
                        visual: "4 √ó 3 = 12"
                    }
                ],
                finalAnswer: "4 √ó 3 = 12",
                answerExplanation: "4 groups of 3 equals 12. We added 3 four times: 3 + 3 + 3 + 3 = 12!",
                example: { problem: `What is 4 √ó 3?`, steps: [
                    { text: "Read it as: 4 groups of 3", math: "4 √ó 3 = 3 + 3 + 3 + 3" },
                    { text: "Add step by step", math: "3 + 3 = 6, then 6 + 3 = 9, then 9 + 3 = 12" },
                    { text: "Or visualize 4 groups", math: "‚óè‚óè‚óè ‚óè‚óè‚óè ‚óè‚óè‚óè ‚óè‚óè‚óè = <strong>12</strong>" }
                ]},
                keyPoints: [
                    "√ó means 'groups of': 5 √ó 2 = 5 groups of 2",
                    "You can flip them: 4 √ó 3 = 3 √ó 4 = 12",
                    "Skip counting helps: 3, 6, 9, 12 (that's counting by 3s, four times)"
                ],
                mistakes: [
                    { wrong: "4 √ó 3 = 7 (adding instead)", why: "√ó means multiply, not add. 4 + 3 = 7, but 4 √ó 3 = 12" },
                    { wrong: "4 √ó 3 = 43 (putting digits together)", why: "We're making groups, not combining digits!" }
                ],
                guided: {
                    problem: `What is ${a} √ó ${b}?`,
                    steps: [
                        { label: `Read as "${a} groups of ${b}"`, value: `${Array(a).fill(b).join(' + ')}` },
                        { label: "Add them up", value: `${Array(a).fill(b).reduce((sum, n, i) => i === 0 ? String(n) : sum + ' + ' + n + ' = ' + (parseInt(sum.split(' = ').pop() || sum) + n), '0').split(' = ').pop()}... wait, let's count!` },
                        { label: "Total", value: "?" }
                    ],
                    answer: String(a * b),
                    answerLabel: `${a} √ó ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `What does ${a} √ó ${b} mean in words?`,
                            hint: `It means ${a} groups of...`,
                            answer: `${a} groups of ${b}`,
                            acceptableAnswers: [`${a} groups of ${b}`, `${b} added ${a} times`, `${b}+${b}` + (a > 2 ? `+${b}` : '') + (a > 3 ? `+${b}` : '') + (a > 4 ? `+${b}` : '')],
                            commonMistakes: {
                                [`${a} + ${b}`]: `That's addition! ${a} √ó ${b} means ${a} GROUPS of ${b}.`,
                                [`${b} groups of ${a}`]: `Close! ${a} √ó ${b} means ${a} groups of ${b} (first number = how many groups).`
                            }
                        },
                        {
                            prompt: `Let's skip count by ${b}s, ${a} times. Start: ${b}... What comes next?`,
                            hint: `${b} + ${b} = ?`,
                            answer: String(b * 2),
                            acceptableAnswers: [String(b * 2)],
                            commonMistakes: {
                                [String(b + 1)]: `You added 1. Skip count by ${b}s: ${b}, ${b*2}, ${b*3}...`,
                                [String(b)]: `That's the first number. Next is ${b} + ${b} = ${b * 2}`
                            }
                        },
                        {
                            prompt: `Keep counting by ${b}s: ${Array.from({length: a-1}, (_, i) => b * (i + 1)).join(', ')}... What's the ${a}th number?`,
                            hint: `Count ${a} jumps of ${b}`,
                            answer: String(a * b),
                            acceptableAnswers: [String(a * b)],
                            commonMistakes: {
                                [String((a - 1) * b)]: `That's only ${a - 1} groups. Count one more: ${(a-1)*b} + ${b} = ${a * b}`,
                                [String((a + 1) * b)]: `That's ${a + 1} groups - one too many! We need exactly ${a} groups.`,
                                [String(a + b)]: `You added instead of multiplied! ${a} √ó ${b} = ${a * b}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1; return { problem: `What is ${pa} √ó ${b}?`, answer: String(pa * b),
                    options: shuffle([String(pa * b), String(a * b), String(pa + b), String((pa + 1) * b)]),
                    mistakeAnalysis: {
                        [String(a * b)]: `That's ${a} √ó ${b}. We need ${pa} groups of ${b}.`,
                        [String(pa + b)]: `You added instead of multiplied. ${pa} √ó ${b} means ${pa} groups of ${b}.`,
                        [String((pa + 1) * b)]: `That's one group too many. We need exactly ${pa} groups of ${b}.`
                    }}; })()
            };
        },
        Division: () => {
            const ans = rand(3, 6), b = rand(2, 4);
            const a = ans * b;
            return {
                goalProblem: `What is 12 √∑ 4?`,
                teachingSteps: [
                    {
                        title: "What is division?",
                        explanation: "<strong>Division</strong> means splitting things into <strong>equal groups</strong>. The √∑ symbol means 'divided by' or 'split into'.",
                        visual: "12 things √∑ 4 groups = ? in each"
                    },
                    {
                        title: "What does 12 √∑ 4 mean?",
                        explanation: "12 √∑ 4 asks: 'If we split 12 things into 4 equal groups, how many are in each group?'",
                        visual: "12 items ‚Üí split into 4 groups ‚Üí how many each?"
                    },
                    {
                        title: "Let's picture it",
                        explanation: "Imagine 12 dots. We want to put them into 4 equal groups. Let's deal them out one at a time to each group.",
                        visual: "‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè ‚Üí 4 groups"
                    },
                    {
                        title: "Deal them into 4 groups",
                        explanation: "Put one dot in each group, then repeat until all dots are used. Each group ends up with 3 dots!",
                        visual: "‚óè‚óè‚óè | ‚óè‚óè‚óè | ‚óè‚óè‚óè | ‚óè‚óè‚óè"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>12 √∑ 4 = 3</strong>. Each group has 3! You can check: 4 groups √ó 3 in each = 12 total.",
                        visual: "12 √∑ 4 = 3"
                    }
                ],
                finalAnswer: "12 √∑ 4 = 3",
                answerExplanation: "When we split 12 into 4 equal groups, each group has 3. Division is the opposite of multiplication!",
                example: { problem: `What is 12 √∑ 4?`, steps: [
                    { text: "Read it as: Split 12 into 4 equal groups", math: "12 items ‚Üí 4 groups ‚Üí how many each?" },
                    { text: "Draw it out", math: "‚óè‚óè‚óè | ‚óè‚óè‚óè | ‚óè‚óè‚óè | ‚óè‚óè‚óè" },
                    { text: "Count how many in each group", math: "Each group has <strong>3</strong>, so 12 √∑ 4 = <strong>3</strong>" }
                ]},
                keyPoints: [
                    "Division is splitting into EQUAL groups",
                    "Think multiplication backwards: ___ √ó 4 = 12? Answer: 3",
                    "The first number (12) gets split BY the second number (4)"
                ],
                mistakes: [
                    { wrong: "Dividing in the wrong order (4 √∑ 12)", why: "The big number gets divided BY the small number. 12 √∑ 4 ‚â† 4 √∑ 12" },
                    { wrong: "Subtracting instead of dividing", why: "12 - 4 = 8, but 12 √∑ 4 = 3. Division is about equal groups." }
                ],
                guided: {
                    problem: `What is ${a} √∑ ${b}?`,
                    steps: [
                        { label: `Split ${a} into ${b} equal groups`, value: `‚óè‚óè‚óè `.repeat(b).trim() + ` (${ans} in each)` },
                        { label: `Think: ${b} √ó ___ = ${a}`, value: `${b} √ó ${ans} = ${a}` },
                        { label: "How many in each group?", value: "?" }
                    ],
                    answer: String(ans),
                    answerLabel: `${a} √∑ ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `${a} √∑ ${b} means: "Split ${a} into ${b} equal groups." What are we trying to find?`,
                            hint: "We want to know how many are in EACH group...",
                            answer: "how many in each group",
                            acceptableAnswers: ["how many in each group", "items per group", "number in each group", "each group", String(ans)],
                            commonMistakes: {
                                [String(a)]: `${a} is the total we're splitting up. We want to find how many in EACH group.`,
                                [String(b)]: `${b} is the number of groups. We want how many are IN each group.`
                            }
                        },
                        {
                            prompt: `Division is the opposite of multiplication. Think: ${b} √ó ___ = ${a}. What number times ${b} equals ${a}?`,
                            hint: `Try counting by ${b}s until you reach ${a}...`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(b)]: `${b} √ó ${b} = ${b * b}. We need ${b} √ó ? = ${a}. The answer is ${ans}.`,
                                [String(a)]: `${b} √ó ${a} = ${b * a}, which is too big! We need ${b} √ó ${ans} = ${a}.`
                            }
                        },
                        {
                            prompt: `So if ${b} √ó ${ans} = ${a}, then ${a} √∑ ${b} = ?`,
                            hint: "Division and multiplication are opposites!",
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(b)]: `${b} is the divisor (what we divide BY). The answer is ${ans}.`,
                                [String(a - b)]: `You subtracted! ${a} √∑ ${b} = ${ans}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = (ans + 1) * b; return { problem: `What is ${pa} √∑ ${b}?`, answer: String(ans + 1),
                    options: shuffle([String(ans + 1), String(ans), String(ans + 2), String(b)]),
                    mistakeAnalysis: {
                        [String(ans)]: `That's ${a} √∑ ${b}. With ${pa} total, each group gets more.`,
                        [String(b)]: "You flipped the answer. Think: how many in EACH group?",
                        [String(ans + 2)]: `Too many per group. Check: ${b} √ó ${ans + 2} = ${b * (ans + 2)}, not ${pa}.`
                    }}; })()
            };
        },
        Time: () => ({
            goalProblem: `What time does the clock show when the short hand is on 3 and long hand is on 6?`,
            teachingSteps: [
                {
                    title: "A clock has two hands",
                    explanation: "Every clock has two hands: a <strong>short hand</strong> and a <strong>long hand</strong>. Each tells us something different!",
                    visual: "Short hand (small) + Long hand (big)"
                },
                {
                    title: "Short hand = HOURS",
                    explanation: "The <strong>short hand</strong> tells us the <strong>hour</strong>. It moves slowly - it only goes around twice a day!",
                    visual: "Short hand ‚Üí HOUR"
                },
                {
                    title: "Long hand = MINUTES",
                    explanation: "The <strong>long hand</strong> tells us the <strong>minutes</strong>. Each number on the clock = 5 minutes (1=5, 2=10, 3=15...).",
                    visual: "Long hand ‚Üí MINUTES (each number √ó 5)"
                },
                {
                    title: "Let's read our clock",
                    explanation: "Short hand is on <strong>3</strong> ‚Üí Hour is 3. Long hand is on <strong>6</strong> ‚Üí Minutes = 6 √ó 5 = 30.",
                    visual: "Hour: 3 | Minutes: 6 √ó 5 = 30"
                },
                {
                    title: "Put it together",
                    explanation: "Hour is 3, minutes is 30. We write this as <strong>3:30</strong> (said 'three thirty').",
                    visual: "3:30"
                }
            ],
            finalAnswer: "3:30",
            answerExplanation: "Short hand on 3 = hour is 3. Long hand on 6 = 30 minutes (6 √ó 5). The time is 3:30!",
            example: { problem: `What time does the clock show when the short hand is on 3 and long hand is on 6?`, steps: [
                { text: "Find the hour (short hand)", math: "Short hand points to 3 ‚Üí Hour is 3" },
                { text: "Find the minutes (long hand)", math: "Long hand points to 6 ‚Üí 6 √ó 5 = 30 minutes" },
                { text: "Put them together", math: "Time is <strong>3:30</strong> (three-thirty)" }
            ]},
            keyPoints: [
                "Short hand = hour, Long hand = minutes",
                "Multiply the minute hand's number by 5",
                "1 hour = 60 minutes, Half hour = 30 minutes"
            ],
            mistakes: [
                { wrong: "Mixing up the hands", why: "SHORT = hours (like 'short' word). LONG = minutes (longer word)." },
                { wrong: "Reading 6 as 6 minutes", why: "Multiply by 5! The 6 means 6 √ó 5 = 30 minutes." }
            ],
            guided: {
                problem: `It's 4:00 now. What time will it be in 2 hours?`,
                steps: [
                    { label: "Start time", value: "4:00" },
                    { label: "Add 2 hours to the hour", value: "4 + 2 = 6" },
                    { label: "New time", value: "?" }
                ],
                answer: "6:00",
                answerLabel: "What time?",
                interactiveSteps: [
                    {
                        prompt: "We start at 4:00. When we add hours, which number changes - the hour or the minutes?",
                        hint: "Hours are before the colon, minutes are after...",
                        answer: "hour",
                        acceptableAnswers: ["hour", "the hour", "hours"],
                        commonMistakes: {
                            "minutes": "When adding HOURS, the hour changes. The minutes (00) stay the same.",
                            "both": "Only the hour changes when we add hours. 4:00 + 2 hours keeps the :00"
                        }
                    },
                    {
                        prompt: "What is 4 + 2?",
                        hint: "Add 2 to the starting hour...",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        commonMistakes: {
                            "2": "4 + 2 = 6, not 2. Add the hours together!",
                            "42": "We ADD the hours, not combine digits. 4 + 2 = 6"
                        }
                    },
                    {
                        prompt: "The hour is now 6. The minutes stay at 00. What is the full time?",
                        hint: "Write it as hour:minutes",
                        answer: "6:00",
                        acceptableAnswers: ["6:00", "6 o'clock", "6 oclock"],
                        commonMistakes: {
                            "6": "Include the minutes! It's 6:00 (six o'clock)",
                            "600": "Use a colon: 6:00, not 600"
                        }
                    }
                ]
            },
            practice: { problem: `How many minutes are in 1 hour?`, answer: "60", options: ["30", "60", "100", "12"],
                mistakeAnalysis: {
                    "30": "30 is HALF an hour. A full hour has 60 minutes.",
                    "100": "We use 60 for time, not 100. There are 60 minutes in 1 hour.",
                    "12": "12 is the number of hours on a clock face. Each hour has 60 minutes."
                }}
        }),
        Money: () => ({
            goalProblem: `How much is 2 quarters and 1 dime?`,
            teachingSteps: [
                {
                    title: "Know your coins",
                    explanation: "There are 4 main coins. Each has a different value. <strong>Size doesn't equal value!</strong>",
                    visual: "Quarter=25¬¢ | Dime=10¬¢ | Nickel=5¬¢ | Penny=1¬¢"
                },
                {
                    title: "Quarters are worth 25 cents",
                    explanation: "A <strong>quarter</strong> is the biggest coin and worth <strong>25¬¢</strong>. It has ridged edges and shows a design on the back.",
                    visual: "Quarter = 25¬¢"
                },
                {
                    title: "Let's count our quarters first",
                    explanation: "We have 2 quarters. Each is worth 25¬¢. 2 quarters = 2 √ó 25¬¢ = 50¬¢",
                    visual: "2 √ó 25¬¢ = 50¬¢"
                },
                {
                    title: "Now count the dime",
                    explanation: "We have 1 dime. A <strong>dime</strong> is the smallest coin but worth <strong>10¬¢</strong>. 1 dime = 10¬¢",
                    visual: "1 √ó 10¬¢ = 10¬¢"
                },
                {
                    title: "Add them together",
                    explanation: "Quarters: 50¬¢ + Dime: 10¬¢ = <strong>60¬¢</strong>. Always add from biggest to smallest coin!",
                    visual: "50¬¢ + 10¬¢ = 60¬¢"
                }
            ],
            finalAnswer: "60 cents (60¬¢)",
            answerExplanation: "2 quarters (50¬¢) + 1 dime (10¬¢) = 60¬¢. Remember: Quarter=25¬¢, Dime=10¬¢!",
            example: { problem: `How much is 2 quarters and 1 dime?`, steps: [
                { text: "Find the value of quarters", math: "2 quarters = 2 √ó 25¬¢ = 50¬¢" },
                { text: "Find the value of the dime", math: "1 dime = 10¬¢" },
                { text: "Add them together", math: "50¬¢ + 10¬¢ = <strong>60¬¢</strong>" }
            ]},
            keyPoints: [
                "Start with the biggest coins (quarters first)",
                "Skip count: quarters by 25s, dimes by 10s, nickels by 5s",
                "4 quarters = 100¬¢ = $1.00"
            ],
            mistakes: [
                { wrong: "Thinking a dime is worth more than a nickel because it's smaller", why: "Size doesn't matter! Dime = 10¬¢, Nickel = 5¬¢" },
                { wrong: "Forgetting to count all the coins", why: "Count each type separately, then add them up." }
            ],
            guided: {
                problem: `What is 3 dimes + 2 nickels?`,
                steps: [
                    { label: "Value of 3 dimes", value: "3 √ó 10¬¢ = 30¬¢" },
                    { label: "Value of 2 nickels", value: "2 √ó 5¬¢ = 10¬¢" },
                    { label: "Total", value: "?" }
                ],
                answer: "40",
                answerLabel: "Total cents:",
                interactiveSteps: [
                    {
                        prompt: "How much is ONE dime worth?",
                        hint: "A dime is the small silver coin...",
                        answer: "10",
                        acceptableAnswers: ["10", "10¬¢", "10 cents", "ten"],
                        commonMistakes: {
                            "5": "That's a nickel! A dime = 10¬¢",
                            "25": "That's a quarter! A dime = 10¬¢",
                            "1": "That's a penny! A dime = 10¬¢"
                        }
                    },
                    {
                        prompt: "We have 3 dimes. How much is 3 √ó 10¬¢?",
                        hint: "Count by 10s: 10, 20, 30...",
                        answer: "30",
                        acceptableAnswers: ["30", "30¬¢", "30 cents"],
                        commonMistakes: {
                            "13": "You added 10 + 3. Multiply: 3 √ó 10 = 30",
                            "10": "That's just 1 dime. We have 3 dimes: 3 √ó 10 = 30"
                        }
                    },
                    {
                        prompt: "How much is ONE nickel worth?",
                        hint: "A nickel is the big silver coin with a face...",
                        answer: "5",
                        acceptableAnswers: ["5", "5¬¢", "5 cents", "five"],
                        commonMistakes: {
                            "10": "That's a dime! A nickel = 5¬¢",
                            "1": "That's a penny! A nickel = 5¬¢"
                        }
                    },
                    {
                        prompt: "We have 2 nickels. How much is 2 √ó 5¬¢?",
                        hint: "5 + 5 = ?",
                        answer: "10",
                        acceptableAnswers: ["10", "10¬¢", "10 cents"],
                        commonMistakes: {
                            "7": "You added 5 + 2. Multiply: 2 √ó 5 = 10",
                            "5": "That's just 1 nickel. We have 2: 2 √ó 5 = 10"
                        }
                    },
                    {
                        prompt: "Now add the totals: 30¬¢ + 10¬¢ = ?",
                        hint: "Add the dimes total and nickels total...",
                        answer: "40",
                        acceptableAnswers: ["40", "40¬¢", "40 cents"],
                        commonMistakes: {
                            "20": "You might have added 10 + 10. It's 30 + 10 = 40",
                            "310": "Don't combine digits! Add: 30 + 10 = 40"
                        }
                    }
                ]
            },
            practice: { problem: `1 quarter + 3 nickels = ? cents`, answer: "40", options: ["28", "35", "40", "45"],
                mistakeAnalysis: {
                    "28": "Check your coin values: Quarter = 25¬¢, Nickel = 5¬¢",
                    "35": "That's 1 quarter + 2 nickels. We have 3 nickels: 25 + 15 = 40",
                    "45": "That would be 4 nickels. We only have 3: 25 + 15 = 40"
                }}
        }),
        Rounding: () => {
            const num = rand(23, 87);
            const ones = num % 10;
            const rounded = ones >= 5 ? Math.ceil(num/10)*10 : Math.floor(num/10)*10;
            return {
                goalProblem: `Round 67 to the nearest ten`,
                teachingSteps: [
                    {
                        title: "What is rounding?",
                        explanation: "<strong>Rounding</strong> means finding the nearest 'friendly' number - a number that ends in 0, like 10, 20, 30, etc.",
                        visual: "67 ‚Üí nearest 10 ‚Üí 60 or 70?"
                    },
                    {
                        title: "Find the neighbors",
                        explanation: "67 sits between two tens: <strong>60</strong> and <strong>70</strong>. Which one is 67 closer to?",
                        visual: "60 ‚Üê 67 ‚Üí 70"
                    },
                    {
                        title: "Look at the ones digit",
                        explanation: "The <strong>ones digit</strong> (the last digit) tells us which way to round. In 67, the ones digit is <strong>7</strong>.",
                        visual: "6<u>7</u> ‚Üê ones digit is 7"
                    },
                    {
                        title: "The rounding rule",
                        explanation: "If the ones digit is <strong>5 or more ‚Üí round UP</strong>. If it's <strong>4 or less ‚Üí round DOWN</strong>. Since 7 ‚â• 5, we round UP!",
                        visual: "5, 6, 7, 8, 9 ‚Üí UP | 0, 1, 2, 3, 4 ‚Üí DOWN"
                    },
                    {
                        title: "67 rounds to 70",
                        explanation: "The ones digit is 7 (5 or more), so we round UP from 60 to 70. <strong>67 rounds to 70</strong>!",
                        visual: "67 ‚Üí 70"
                    }
                ],
                finalAnswer: "70",
                answerExplanation: "67 has a ones digit of 7. Since 7 ‚â• 5, we round UP to the next ten: 70.",
                example: { problem: `Round 67 to the nearest ten`, steps: [
                    { text: "Find the neighbors (tens around 67)", math: "67 is between 60 and 70" },
                    { text: "Look at the ones digit", math: "The ones digit is 7" },
                    { text: "Apply the rule: 7 ‚â• 5, so round UP", math: "67 rounds to <strong>70</strong>" }
                ]},
                keyPoints: [
                    "5, 6, 7, 8, 9 ‚Üí round UP",
                    "0, 1, 2, 3, 4 ‚Üí round DOWN (stay at the lower ten)",
                    "Think: which ten is it CLOSER to?"
                ],
                mistakes: [
                    { wrong: "Rounding 45 down to 40", why: "5 is the special number - it rounds UP! 45 ‚Üí 50" },
                    { wrong: "Changing the wrong digit", why: "When rounding to tens, only the tens digit changes. 67 ‚Üí 70 (not 77)" }
                ],
                guided: {
                    problem: `Round ${num} to the nearest ten`,
                    steps: [
                        { label: `${num} is between`, value: `${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}` },
                        { label: "The ones digit is", value: `${ones}` },
                        { label: `${ones} is ${ones >= 5 ? '5 or more, so round UP' : '4 or less, so round DOWN'}`, value: "?" }
                    ],
                    answer: String(rounded),
                    answerLabel: "Rounded to:",
                    interactiveSteps: [
                        {
                            prompt: `When rounding ${num} to the nearest ten, which two tens is ${num} between?`,
                            hint: "Find the ten below and the ten above...",
                            answer: `${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`,
                            acceptableAnswers: [`${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`, `${Math.floor(num/10)*10}, ${Math.ceil(num/10)*10}`, `${Math.floor(num/10)*10}-${Math.ceil(num/10)*10}`],
                            commonMistakes: {
                                [String(num)]: `${num} is the number we're rounding. It sits BETWEEN ${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`
                            }
                        },
                        {
                            prompt: `What is the ones digit (last digit) of ${num}?`,
                            hint: "The ones digit is the rightmost digit...",
                            answer: String(ones),
                            acceptableAnswers: [String(ones)],
                            commonMistakes: {
                                [String(Math.floor(num/10))]: `That's the tens digit. The ONES digit (last digit) of ${num} is ${ones}`
                            }
                        },
                        {
                            prompt: `Is ${ones} five or more (round UP) or four or less (round DOWN)?`,
                            hint: "5, 6, 7, 8, 9 round UP. 0, 1, 2, 3, 4 round DOWN.",
                            answer: ones >= 5 ? "round up" : "round down",
                            acceptableAnswers: ones >= 5 ? ["round up", "up", "rounds up"] : ["round down", "down", "rounds down"],
                            commonMistakes: ones >= 5 ? {
                                "round down": `${ones} is 5 or more, so we round UP!`
                            } : {
                                "round up": `${ones} is less than 5, so we round DOWN!`
                            }
                        },
                        {
                            prompt: `So ${num} rounded to the nearest ten is?`,
                            hint: ones >= 5 ? `Round UP to ${Math.ceil(num/10)*10}` : `Round DOWN to ${Math.floor(num/10)*10}`,
                            answer: String(rounded),
                            acceptableAnswers: [String(rounded)],
                            commonMistakes: {
                                [String(ones >= 5 ? Math.floor(num/10)*10 : Math.ceil(num/10)*10)]: `${ones} is ${ones >= 5 ? '5 or more, so round UP' : 'less than 5, so round DOWN'} to ${rounded}`
                            }
                        }
                    ]
                },
                practice: { problem: `Round 84 to the nearest ten`, answer: "80", options: ["80", "84", "85", "90"],
                    mistakeAnalysis: {
                        "84": "We need to round to a 'tens' number (ending in 0). 84's ones digit is 4, so round DOWN to 80.",
                        "85": "Close, but we round to the nearest TEN (80 or 90), not to 5.",
                        "90": "The ones digit is 4, which is less than 5, so we round DOWN to 80, not up to 90."
                    }}
            };
        },
        Measurement: () => ({
            goalProblem: `How many inches are in 2 feet?`,
            teachingSteps: [
                {
                    title: "Why do we convert measurements?",
                    explanation: "Sometimes we need to change from one unit to another. For example, your height might be in feet, but you need it in inches!",
                    visual: "Feet ‚Üî Inches"
                },
                {
                    title: "The key conversion: 1 foot = 12 inches",
                    explanation: "Memorize this! There are <strong>12 inches in 1 foot</strong>. A ruler is usually 12 inches long - that's 1 foot!",
                    visual: "1 foot = 12 inches"
                },
                {
                    title: "Going to smaller units? MULTIPLY!",
                    explanation: "Inches are smaller than feet. When converting to smaller units, you get MORE of them, so you <strong>multiply</strong>.",
                    visual: "Bigger ‚Üí Smaller = MULTIPLY"
                },
                {
                    title: "Let's convert 2 feet to inches",
                    explanation: "We have 2 feet. Each foot has 12 inches. So we multiply: 2 √ó 12.",
                    visual: "2 feet √ó 12 inches/foot"
                },
                {
                    title: "Calculate the answer",
                    explanation: "2 √ó 12 = <strong>24</strong>. There are 24 inches in 2 feet!",
                    visual: "2 feet = 24 inches"
                }
            ],
            finalAnswer: "24 inches",
            answerExplanation: "2 feet √ó 12 inches per foot = 24 inches. Always multiply when going to smaller units!",
            example: { problem: `How many inches are in 2 feet?`, steps: [
                { text: "Know the conversion", math: "1 foot = 12 inches" },
                { text: "We have 2 feet, so multiply", math: "2 feet √ó 12 inches/foot" },
                { text: "Calculate", math: "2 √ó 12 = <strong>24 inches</strong>" }
            ]},
            keyPoints: [
                "1 foot = 12 inches (memorize this!)",
                "Feet ‚Üí inches: MULTIPLY by 12",
                "Inches ‚Üí feet: DIVIDE by 12"
            ],
            mistakes: [
                { wrong: "Adding 12 instead of multiplying", why: "2 feet = 2 √ó 12 = 24 inches, not 2 + 12 = 14" },
                { wrong: "Confusing which way to convert", why: "Smaller units = bigger number. Inches are smaller than feet, so more of them." }
            ],
            guided: {
                problem: `How many inches are in 3 feet?`,
                steps: [
                    { label: "Conversion", value: "1 foot = 12 inches" },
                    { label: "Multiply", value: "3 √ó 12" },
                    { label: "Answer", value: "?" }
                ],
                answer: "36",
                answerLabel: "Inches:",
                interactiveSteps: [
                    {
                        prompt: "How many inches are in ONE foot?",
                        hint: "Think of a ruler - it's one foot long...",
                        answer: "12",
                        acceptableAnswers: ["12", "twelve", "12 inches"],
                        commonMistakes: {
                            "1": "1 foot = 12 inches, not 1 inch!",
                            "10": "Close, but 1 foot = 12 inches (not 10).",
                            "3": "We have 3 feet, but 1 foot = 12 inches."
                        }
                    },
                    {
                        prompt: "We have 3 feet. To find the total inches, do we add or multiply?",
                        hint: "3 feet means 3 groups of 12 inches...",
                        answer: "multiply",
                        acceptableAnswers: ["multiply", "multiplication", "√ó", "times"],
                        commonMistakes: {
                            "add": "Adding gives 3 + 12 = 15. But we need 3 GROUPS of 12, so multiply!",
                            "divide": "Division would give us fewer. We want more inches, so multiply."
                        }
                    },
                    {
                        prompt: "Calculate: 3 √ó 12 = ?",
                        hint: "3 groups of 12...",
                        answer: "36",
                        acceptableAnswers: ["36", "36 inches"],
                        commonMistakes: {
                            "15": "You added 3 + 12. Multiply: 3 √ó 12 = 36",
                            "24": "That's 2 √ó 12. We need 3 √ó 12 = 36",
                            "312": "Don't combine digits! 3 √ó 12 = 36"
                        }
                    }
                ]
            },
            practice: { problem: `24 inches = how many feet?`, answer: "2", options: ["1", "2", "12", "36"],
                mistakeAnalysis: {
                    "1": "24 √∑ 12 = 2, not 1. Check your division.",
                    "12": "You need to DIVIDE 24 by 12, not just use 12 as the answer.",
                    "36": "That's going the wrong way! To get feet from inches, divide: 24 √∑ 12 = 2"
                }}
        }),
        Fractions: () => ({
            goalProblem: `What fraction of the pizza is shaded? ‚óê‚óê‚óê‚óã (3 of 4 pieces)`,
            teachingSteps: [
                {
                    title: "What is a fraction?",
                    explanation: "A <strong>fraction</strong> represents <strong>part of a whole</strong>. When something is divided into equal pieces, a fraction tells us how many pieces we have.",
                    visual: "Part √∑ Whole = Fraction"
                },
                {
                    title: "The two parts of a fraction",
                    explanation: "A fraction has two numbers: the <strong>numerator</strong> (top) and <strong>denominator</strong> (bottom), separated by a line.",
                    visual: "numerator / denominator"
                },
                {
                    title: "Denominator = total equal parts",
                    explanation: "The <strong>bottom number</strong> (denominator) tells us how many <strong>equal parts</strong> the whole is divided into.",
                    visual: "‚óê‚óê‚óê‚óã = 4 total pieces ‚Üí denominator is 4"
                },
                {
                    title: "Numerator = parts we have",
                    explanation: "The <strong>top number</strong> (numerator) tells us how many parts we're talking about (the shaded ones).",
                    visual: "‚óê‚óê‚óê‚óã = 3 shaded ‚Üí numerator is 3"
                },
                {
                    title: "Write the fraction",
                    explanation: "Numerator on top (3), denominator on bottom (4). The fraction is <strong>3/4</strong>, read as 'three fourths' or '3 out of 4'.",
                    visual: "3/4 (three-fourths)"
                }
            ],
            finalAnswer: "3/4",
            answerExplanation: "3 out of 4 pieces are shaded. Numerator (what we have) = 3, Denominator (total pieces) = 4. The fraction is 3/4!",
            example: { problem: `What fraction of the pizza is shaded? ‚óê‚óê‚óê‚óã (3 of 4 pieces shaded)`, steps: [
                { text: "Count the TOTAL pieces", math: "There are 4 pieces total ‚Üí this is the denominator" },
                { text: "Count the SHADED pieces", math: "3 pieces are shaded ‚Üí this is the numerator" },
                { text: "Write the fraction", math: "<strong>3/4</strong> (three-fourths)" }
            ]},
            keyPoints: [
                "Denominator (bottom) = total equal parts",
                "Numerator (top) = parts you're counting",
                "The line means 'out of' ‚Üí 3/4 = '3 out of 4'"
            ],
            mistakes: [
                { wrong: "Writing the numbers upside down", why: "Parts you HAVE go on TOP. Total parts go on BOTTOM." },
                { wrong: "3/4 of a pizza is bigger than 2/4", why: "Correct! More shaded parts = bigger fraction (when denominators are the same)" }
            ],
            guided: {
                problem: `A cake is cut into 8 equal slices. You eat 3. What fraction did you eat?`,
                steps: [
                    { label: "Total slices (denominator)", value: "8" },
                    { label: "Slices you ate (numerator)", value: "3" },
                    { label: "Fraction eaten", value: "?" }
                ],
                answer: "3/8",
                answerLabel: "Fraction:",
                interactiveSteps: [
                    {
                        prompt: "In a fraction, the BOTTOM number (denominator) tells us the TOTAL parts. How many slices is the cake cut into?",
                        hint: "Read the problem - how many equal slices?",
                        answer: "8",
                        acceptableAnswers: ["8", "eight"],
                        commonMistakes: {
                            "3": "3 is how many you ATE. The total slices = 8",
                            "5": "The cake has 8 slices total, not 5"
                        }
                    },
                    {
                        prompt: "The TOP number (numerator) is the part we're talking about. How many slices did you EAT?",
                        hint: "The problem says 'You eat...'",
                        answer: "3",
                        acceptableAnswers: ["3", "three"],
                        commonMistakes: {
                            "8": "8 is the total. You only ATE 3 slices.",
                            "5": "You ate 3 slices, not 5"
                        }
                    },
                    {
                        prompt: "Write the fraction: numerator on top, denominator on bottom. What fraction did you eat?",
                        hint: "3 (what you ate) over 8 (total slices)",
                        answer: "3/8",
                        acceptableAnswers: ["3/8", "3 / 8", "three eighths"],
                        commonMistakes: {
                            "8/3": "The numerator (3) goes on TOP, denominator (8) goes on BOTTOM: 3/8",
                            "5/8": "You ate 3 slices, so 3 goes on top: 3/8"
                        }
                    }
                ]
            },
            practice: { problem: `Which is larger: 2/5 or 4/5?`, answer: "4/5", options: ["2/5", "4/5", "They're equal"],
                mistakeAnalysis: {
                    "2/5": "When denominators are the same, compare numerators. 4 > 2, so 4/5 > 2/5",
                    "They're equal": "2 parts is less than 4 parts (out of the same 5). 4/5 is larger."
                }}
        }),
        "Word Problems": () => ({
            goalProblem: `Sam has 12 apples. He gives 5 to his friend. How many are left?`,
            teachingSteps: [
                {
                    title: "What is a word problem?",
                    explanation: "A <strong>word problem</strong> is a math question written as a story. We need to figure out which operation to use (add, subtract, multiply, or divide).",
                    visual: "Story ‚Üí Find operation ‚Üí Solve"
                },
                {
                    title: "Look for clue words",
                    explanation: "Certain words tell us which operation to use. In our problem, the word '<strong>left</strong>' is a clue!",
                    visual: "left, remaining = SUBTRACT"
                },
                {
                    title: "Clue words cheat sheet",
                    explanation: "<strong>Add:</strong> total, altogether, combined, sum. <strong>Subtract:</strong> left, remaining, difference, fewer. <strong>Multiply:</strong> each, groups of, times. <strong>Divide:</strong> split, share equally.",
                    visual: "total=ADD | left=SUBTRACT | each=MULTIPLY | split=DIVIDE"
                },
                {
                    title: "Identify the numbers",
                    explanation: "Sam <strong>has 12</strong> apples. He <strong>gives away 5</strong>. These are our two numbers: 12 and 5.",
                    visual: "Started with: 12 | Gave away: 5"
                },
                {
                    title: "Solve it!",
                    explanation: "'Left' means subtract. We take away the 5 apples he gave away from the 12 he started with: 12 - 5 = <strong>7</strong>",
                    visual: "12 - 5 = 7 apples left"
                }
            ],
            finalAnswer: "7 apples",
            answerExplanation: "The word 'left' tells us to subtract. 12 - 5 = 7. Sam has 7 apples left!",
            example: { problem: `Sam has 12 apples. He gives 5 to his friend. How many are left?`, steps: [
                { text: "Find the key word", math: "'Left' means SUBTRACTION" },
                { text: "Identify the numbers", math: "Started with: 12, Gave away: 5" },
                { text: "Set up and solve", math: "12 - 5 = <strong>7 apples left</strong>" }
            ]},
            keyPoints: [
                "Read the whole problem first",
                "Look for clue words to find the operation",
                "Write the number sentence before solving"
            ],
            mistakes: [
                { wrong: "Using the wrong operation", why: "Look for clue words! 'Left' = subtract, 'Total' = add" },
                { wrong: "Not answering what was asked", why: "Re-read the question. What exactly are they asking for?" }
            ],
            guided: {
                problem: `There are 4 boxes with 6 crayons in each box. How many crayons total?`,
                steps: [
                    { label: "Clue words", value: "'each' and 'total' suggest multiplication" },
                    { label: "Set up", value: "4 groups of 6 = 4 √ó 6" },
                    { label: "Answer", value: "?" }
                ],
                answer: "24",
                answerLabel: "Total crayons:",
                interactiveSteps: [
                    {
                        prompt: "The problem says '4 boxes with 6 crayons in EACH box'. The word 'each' suggests which operation?",
                        hint: "Equal groups usually means...",
                        answer: "multiplication",
                        acceptableAnswers: ["multiplication", "multiply", "times", "√ó"],
                        commonMistakes: {
                            "addition": "'Each' means equal groups - that's multiplication, not addition!",
                            "subtraction": "We're finding a TOTAL of equal groups, so we multiply.",
                            "division": "Division splits things up. We're combining groups, so multiply."
                        }
                    },
                    {
                        prompt: "How many boxes are there?",
                        hint: "Read the first part of the problem...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        commonMistakes: {
                            "6": "6 is the crayons per box. The number of BOXES is 4."
                        }
                    },
                    {
                        prompt: "How many crayons are in EACH box?",
                        hint: "The problem says '6 crayons in each box'",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        commonMistakes: {
                            "4": "4 is the number of boxes. Each box has 6 crayons."
                        }
                    },
                    {
                        prompt: "Calculate: 4 boxes √ó 6 crayons = ?",
                        hint: "4 groups of 6...",
                        answer: "24",
                        acceptableAnswers: ["24", "24 crayons"],
                        commonMistakes: {
                            "10": "You added 4 + 6. Multiply: 4 √ó 6 = 24",
                            "46": "Don't combine digits! 4 √ó 6 = 24"
                        }
                    }
                ]
            },
            practice: { problem: `Emma has 15 stickers. She gets 8 more. How many does she have now?`, answer: "23", options: ["7", "23", "120", "87"],
                mistakeAnalysis: {
                    "7": "You subtracted! 'Gets more' means ADD: 15 + 8 = 23",
                    "120": "You multiplied! 'Gets more' means ADD: 15 + 8 = 23",
                    "87": "You put the digits together. Add them: 15 + 8 = 23"
                }}
        })
    },
    3: {
        Percents: () => {
            const pct = pick([10, 20, 25, 50]);
            const base = pick([20, 40, 50, 100]);
            const ans = (pct / 100) * base;
            return {
                goalProblem: `What is 25% of 80?`,
                teachingSteps: [
                    {
                        title: "What does percent mean?",
                        explanation: "<strong>Percent</strong> means 'per hundred' or 'out of 100'. The symbol % tells us we're working with parts of 100.",
                        visual: "25% = 25 out of 100"
                    },
                    {
                        title: "Common percents to memorize",
                        explanation: "50% = half, 25% = quarter, 10% = tenth, 100% = all of it. These shortcuts make calculations faster!",
                        visual: "100%=all | 50%=half | 25%=quarter | 10%=tenth"
                    },
                    {
                        title: "Step 1: Convert percent to decimal",
                        explanation: "To calculate with percents, divide by 100 (move decimal 2 places left). 25% = 25 √∑ 100 = <strong>0.25</strong>",
                        visual: "25% ‚Üí 25. ‚Üí 2.5 ‚Üí 0.25"
                    },
                    {
                        title: "Step 2: 'Of' means multiply",
                        explanation: "In math, 'of' means multiply. '25% of 80' becomes 0.25 √ó 80.",
                        visual: "25% OF 80 = 0.25 √ó 80"
                    },
                    {
                        title: "Step 3: Calculate the answer",
                        explanation: "0.25 √ó 80 = <strong>20</strong>. Quick check: 25% is a quarter, and 80 √∑ 4 = 20 ‚úì",
                        visual: "0.25 √ó 80 = 20"
                    }
                ],
                finalAnswer: "20",
                answerExplanation: "25% = 0.25, and 0.25 √ó 80 = 20. Since 25% is a quarter, we're finding a quarter of 80!",
                example: { problem: `What is 25% of 80?`, steps: [
                    { text: "Convert percent to decimal", math: "25% = 25 √∑ 100 = 0.25" },
                    { text: "Set up the multiplication", math: "25% of 80 means 0.25 √ó 80" },
                    { text: "Multiply step by step", math: "0.25 √ó 80 = 25 √ó 80 √∑ 100 = 2000 √∑ 100 = <strong>20</strong>" },
                    { text: "Check: Is 20 about 1/4 of 80?", math: "Yes! 80 √∑ 4 = 20 ‚úì" }
                ]},
                keyPoints: [
                    "Percent to decimal: move decimal point 2 places LEFT (25% ‚Üí 0.25)",
                    "50% = √ó0.5 = √∑2 (half), 25% = √ó0.25 = √∑4 (quarter), 10% = √ó0.1 = √∑10",
                    "To find 10% of any number, just move the decimal one place left: 10% of 80 = 8"
                ],
                mistakes: [
                    { wrong: "25% of 80 = 25 + 80 = 105", why: "'Of' in math means MULTIPLY, not add. 25% OF 80 = 0.25 √ó 80" },
                    { wrong: "25% = 2.5 or 0.025", why: "Move decimal 2 places LEFT: 25.0% ‚Üí 0.25 (not 1 or 3 places)" },
                    { wrong: "Thinking 25% of 80 should be bigger than 80", why: "A percent less than 100% gives you a SMALLER answer" }
                ],
                guided: {
                    problem: `What is ${pct}% of ${base}?`,
                    steps: [
                        { label: `Convert ${pct}% to decimal`, value: `${pct}% = ${pct} √∑ 100 = ${pct/100}` },
                        { label: `Multiply by ${base}`, value: `${pct/100} √ó ${base} = ?` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(ans),
                    answerLabel: `${pct}% of ${base} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "To use a percent in calculations, we first convert it to a decimal. How do we convert a percent to a decimal?",
                            hint: "Move the decimal point or divide by...",
                            answer: "divide by 100",
                            acceptableAnswers: ["divide by 100", "√∑ 100", "move decimal 2 places left", "move decimal left 2"],
                            commonMistakes: {
                                "divide by 10": "Divide by 100, not 10 (percent means 'per hundred')",
                                "multiply by 100": "That's decimal ‚Üí percent. For percent ‚Üí decimal, DIVIDE by 100."
                            }
                        },
                        {
                            prompt: `Convert ${pct}% to a decimal: ${pct} √∑ 100 = ?`,
                            hint: `Move the decimal point 2 places left: ${pct}.0 ‚Üí ?`,
                            answer: String(pct / 100),
                            acceptableAnswers: [String(pct / 100)],
                            commonMistakes: {
                                [String(pct)]: `Don't forget to divide! ${pct} √∑ 100 = ${pct / 100}`,
                                [String(pct * 100)]: `You multiplied instead of divided. ${pct} √∑ 100 = ${pct / 100}`
                            }
                        },
                        {
                            prompt: `Now multiply: ${pct / 100} √ó ${base} = ?`,
                            hint: `${pct}% of ${base} means ${pct / 100} √ó ${base}`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(pct + base)]: `You added instead of multiplied! ${pct / 100} √ó ${base} = ${ans}`,
                                [String(pct / 100 + base)]: `Add the decimal? No - MULTIPLY it: ${pct / 100} √ó ${base} = ${ans}`
                            }
                        }
                    ]
                },
                practice: (() => { const newBase = base * 2; const newAns = (pct / 100) * newBase; return {
                    problem: `What is ${pct}% of ${newBase}?`, answer: String(newAns),
                    options: shuffle([String(newAns), String(ans), String(pct + newBase), String(newAns * 2)]),
                    mistakeAnalysis: {
                        [String(ans)]: `You used ${base} instead of ${newBase}. With ${newBase}, the answer is ${pct/100} √ó ${newBase} = ${newAns}`,
                        [String(pct + newBase)]: `You added instead of multiplied. '${pct}% OF ${newBase}' means ${pct/100} √ó ${newBase}`,
                        [String(newAns * 2)]: `Check your calculation: ${pct}% = ${pct/100}, and ${pct/100} √ó ${newBase} = ${newAns}`
                    }}; })()
            };
        },
        Integers: () => {
            const a = rand(3, 10), b = rand(a + 2, 15);
            return {
                goalProblem: `What is -5 + 8?`,
                teachingSteps: [
                    {
                        title: "What are integers?",
                        explanation: "<strong>Integers</strong> are whole numbers including positive numbers, negative numbers, and zero. No fractions or decimals!",
                        visual: "...-3, -2, -1, 0, 1, 2, 3..."
                    },
                    {
                        title: "The number line",
                        explanation: "Imagine a number line: zero is in the middle, positive numbers go right, negative numbers go left.",
                        visual: "‚Üê -5 -4 -3 -2 -1 [0] 1 2 3 4 5 ‚Üí"
                    },
                    {
                        title: "Adding integers: the direction rule",
                        explanation: "Adding a <strong>positive</strong> = move <strong>right</strong>. Adding a <strong>negative</strong> = move <strong>left</strong>.",
                        visual: "Add positive ‚Üí go RIGHT | Add negative ‚Üí go LEFT"
                    },
                    {
                        title: "Let's solve -5 + 8",
                        explanation: "Start at -5 on the number line. We're adding +8 (positive), so move <strong>RIGHT</strong> 8 spaces.",
                        visual: "-5 ‚Üí -4 ‚Üí -3 ‚Üí -2 ‚Üí -1 ‚Üí 0 ‚Üí 1 ‚Üí 2 ‚Üí 3"
                    },
                    {
                        title: "We landed on 3!",
                        explanation: "<strong>-5 + 8 = 3</strong>. Shortcut: different signs means subtract (8-5=3), then keep the sign of the bigger number (8 is bigger and positive).",
                        visual: "-5 + 8 = 3"
                    }
                ],
                finalAnswer: "3",
                answerExplanation: "Starting at -5 and moving right 8 spaces lands us at 3. Or use the shortcut: 8-5=3, positive wins!",
                example: { problem: `What is -5 + 8?`, steps: [
                    { text: "Start at -5 on the number line", math: "Put your finger on -5" },
                    { text: "We're adding +8, so move RIGHT 8 spaces", math: "-5 ‚Üí -4 ‚Üí -3 ‚Üí -2 ‚Üí -1 ‚Üí 0 ‚Üí 1 ‚Üí 2 ‚Üí 3" },
                    { text: "We landed on 3!", math: "-5 + 8 = <strong>3</strong>" },
                    { text: "Check using the shortcut", math: "8 - 5 = 3, positive wins (8 > 5) ‚úì" }
                ]},
                keyPoints: [
                    "Number line: LEFT = smaller, RIGHT = bigger",
                    "Different signs: subtract the numbers, keep the sign of the larger absolute value",
                    "Same signs: add the numbers, keep the same sign (-3 + -5 = -8)"
                ],
                mistakes: [
                    { wrong: "-5 + 8 = -13 (adding both numbers)", why: "Different signs means SUBTRACT! 8 - 5 = 3, and +8 is stronger, so answer is +3" },
                    { wrong: "-5 + 8 = -3 (wrong sign)", why: "8 is bigger than 5, and 8 is positive, so the answer is positive 3" },
                    { wrong: "Moving left when adding a positive", why: "Adding POSITIVE always moves RIGHT. Adding NEGATIVE moves left." }
                ],
                guided: {
                    problem: `What is -${a} + ${b}?`,
                    steps: [
                        { label: "Start at", value: `-${a}` },
                        { label: `Move RIGHT ${b} spaces`, value: `-${a} ‚Üí ${b - a > 0 ? '... ‚Üí 0 ‚Üí ... ‚Üí' : '...'} ${b - a}` },
                        { label: `Or use the shortcut: ${b} - ${a} =`, value: `${b - a}, positive wins` },
                        { label: "Answer", value: "?" }
                    ],
                    answer: String(b - a),
                    answerLabel: `-${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `We have -${a} + ${b}. Do the numbers have the SAME sign or DIFFERENT signs?`,
                            hint: `-${a} is negative, ${b} is positive...`,
                            answer: "different",
                            acceptableAnswers: ["different", "different signs", "opposite"],
                            commonMistakes: {
                                "same": `-${a} is NEGATIVE and ${b} is POSITIVE - that's different signs!`
                            }
                        },
                        {
                            prompt: "When adding numbers with DIFFERENT signs, do we add or subtract their absolute values?",
                            hint: "Different signs means we find the difference...",
                            answer: "subtract",
                            acceptableAnswers: ["subtract", "subtraction"],
                            commonMistakes: {
                                "add": "Add for SAME signs. For DIFFERENT signs, we SUBTRACT!"
                            }
                        },
                        {
                            prompt: `Subtract the absolute values: ${b} - ${a} = ?`,
                            hint: `Ignore the signs and subtract: ${b} - ${a}`,
                            answer: String(b - a),
                            acceptableAnswers: [String(b - a)],
                            commonMistakes: {
                                [String(a + b)]: `You added! With different signs, SUBTRACT: ${b} - ${a} = ${b - a}`,
                                [String(a - b)]: `Subtract the smaller from the larger: ${b} - ${a} = ${b - a}`
                            }
                        },
                        {
                            prompt: `Which number has the larger absolute value: ${a} or ${b}? That determines the sign of our answer.`,
                            hint: `|${b}| = ${b}, |-${a}| = ${a}. Which is bigger?`,
                            answer: String(b),
                            acceptableAnswers: [String(b), "positive"],
                            commonMistakes: {
                                [String(a)]: `${b} > ${a}, so ${b} has the larger absolute value. Answer takes the positive sign!`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 2; return {
                    problem: `What is -${pa} + ${b}?`, answer: String(b - pa),
                    options: shuffle([String(b - pa), String(-(pa + b)), String(pa + b), String(-(b - pa))]),
                    mistakeAnalysis: {
                        [String(-(pa + b))]: `You added both numbers. With different signs, SUBTRACT: ${b} - ${pa} = ${b - pa}`,
                        [String(pa + b)]: `Same mistake - subtract don't add. Also, since ${b > pa ? 'positive is bigger' : 'negative is bigger'}, answer is ${b - pa}`,
                        [String(-(b - pa))]: `Right calculation, wrong sign! ${b} > ${pa}, so positive wins. Answer is +${b - pa}`
                    }}; })()
            };
        },
        "Mean Median Mode": () => {
            const data = [rand(2, 5), rand(3, 6), rand(4, 8), rand(5, 9), rand(3, 6)];
            const sorted = [...data].sort((a, b) => a - b);
            const median = sorted[2];
            const sum = data.reduce((a, b) => a + b, 0);
            const mean = sum / data.length;
            return {
                goalProblem: `Find the mean, median, and mode of: 3, 7, 5, 9, 1`,
                teachingSteps: [
                    {
                        title: "Three types of 'average'",
                        explanation: "Mean, median, and mode are all ways to describe the 'center' or typical value of a data set. They each tell us something different!",
                        visual: "Mean = math average | Median = middle | Mode = most common"
                    },
                    {
                        title: "MEAN: Add all, then divide",
                        explanation: "The <strong>mean</strong> is what most people call 'the average'. Add all numbers, then divide by how many there are.",
                        visual: "Mean = (sum of all) √∑ (count)"
                    },
                    {
                        title: "Let's find the mean",
                        explanation: "Add: 3 + 7 + 5 + 9 + 1 = 25. There are 5 numbers, so divide: 25 √∑ 5 = <strong>5</strong>. The mean is 5!",
                        visual: "25 √∑ 5 = 5 (Mean)"
                    },
                    {
                        title: "MEDIAN: Sort first, then find middle",
                        explanation: "The <strong>median</strong> is the middle number when sorted. ALWAYS sort first! 3,7,5,9,1 becomes 1,3,5,7,9",
                        visual: "1, 3, [5], 7, 9 ‚Üí Median = 5"
                    },
                    {
                        title: "MODE: Most frequent number",
                        explanation: "The <strong>mode</strong> is the number that appears most often. Here, each number appears once, so there's <strong>no mode</strong>.",
                        visual: "No repeats ‚Üí No mode"
                    }
                ],
                finalAnswer: "Mean = 5, Median = 5, No mode",
                answerExplanation: "Mean: 25√∑5=5. Median: middle of 1,3,5,7,9 is 5. Mode: no repeats, so no mode!",
                example: { problem: `Find the mean, median, and mode of: 3, 7, 5, 9, 1`, steps: [
                    { text: "MEAN: Add all numbers", math: "3 + 7 + 5 + 9 + 1 = 25" },
                    { text: "Divide by count (5 numbers)", math: "25 √∑ 5 = <strong>Mean = 5</strong>" },
                    { text: "MEDIAN: First, put in order", math: "1, 3, 5, 7, 9" },
                    { text: "Find the middle number", math: "1, 3, <strong>5</strong>, 7, 9 ‚Üí <strong>Median = 5</strong>" },
                    { text: "MODE: Which number appears most?", math: "Each number appears once ‚Üí <strong>No mode</strong>" }
                ]},
                keyPoints: [
                    "Mean = Sum √∑ Count (the 'average')",
                    "Median = SORT first, then find middle (with even count, average the two middle numbers)",
                    "Mode = Most frequent (can have no mode, one mode, or multiple modes)"
                ],
                mistakes: [
                    { wrong: "Finding median without sorting", why: "ALWAYS put in order first! 3, 7, 5, 9, 1 ‚Üí 1, 3, 5, 7, 9" },
                    { wrong: "Dividing by wrong number for mean", why: "Count ALL numbers. 5 numbers means divide by 5." },
                    { wrong: "Confusing mean and median", why: "Mean = math (add & divide). Median = just find middle." }
                ],
                guided: {
                    problem: `Find the median of: ${data.join(', ')}`,
                    steps: [
                        { label: "First, sort the numbers", value: `${sorted.join(', ')}` },
                        { label: "Count: 5 numbers, so middle is the 3rd", value: `${sorted[0]}, ${sorted[1]}, ?, ${sorted[3]}, ${sorted[4]}` },
                        { label: "Median", value: "?" }
                    ],
                    answer: String(median),
                    answerLabel: "Median = ?",
                    interactiveSteps: [
                        {
                            prompt: "To find the median, what must we do FIRST?",
                            hint: "The numbers might not be in order yet...",
                            answer: "sort",
                            acceptableAnswers: ["sort", "put in order", "order them", "arrange", "sort them"],
                            commonMistakes: {
                                "add": "Adding is for MEAN. For MEDIAN, we first SORT the numbers!",
                                "find middle": "Finding the middle comes AFTER sorting. First, put them in order."
                            }
                        },
                        {
                            prompt: `Sort these numbers from smallest to largest: ${data.join(', ')}`,
                            hint: "Start with the smallest number...",
                            answer: sorted.join(', '),
                            acceptableAnswers: [sorted.join(', '), sorted.join(','), sorted.join(' ')],
                            commonMistakes: {
                                [data.join(', ')]: "Those aren't sorted! Put them in order from smallest to largest."
                            }
                        },
                        {
                            prompt: `Sorted: ${sorted.join(', ')}. We have 5 numbers. Which position is the middle?`,
                            hint: "With 5 items, the middle is position 1, 2, 3, 4, or 5?",
                            answer: "3",
                            acceptableAnswers: ["3", "3rd", "third", "position 3"],
                            commonMistakes: {
                                "2": "With 5 numbers, there are 2 numbers on each side of the middle. Position 3 is the middle!",
                                "5": "5 is the last position. The MIDDLE of 5 items is position 3."
                            }
                        },
                        {
                            prompt: `The 3rd number in ${sorted.join(', ')} is the median. What is it?`,
                            hint: "Count: 1st, 2nd, 3rd...",
                            answer: String(median),
                            acceptableAnswers: [String(median)],
                            commonMistakes: {
                                [String(sorted[0])]: `That's the 1st number. The median is the 3rd: ${median}`,
                                [String(sorted[1])]: `That's the 2nd number. The median is the 3rd: ${median}`,
                                [String(sorted[3])]: `That's the 4th number. The median is the 3rd: ${median}`
                            }
                        }
                    ]
                },
                practice: (() => { const pdata = [4, 8, 2, 6, 10]; const psorted = [2, 4, 6, 8, 10]; return {
                    problem: `Find the median: ${pdata.join(', ')}`, answer: "6",
                    options: ["4", "6", "8", "10"],
                    mistakeAnalysis: {
                        "4": `Sort first: ${psorted.join(', ')}. The MIDDLE (3rd) number is 6, not the 2nd.`,
                        "8": `Close! But with 5 numbers, the middle is the 3rd. Sorted: ${psorted.join(', ')}. Middle = 6`,
                        "10": "That's the last number when sorted. Middle of 2, 4, 6, 8, 10 is 6."
                    }}; })()
            };
        },
        "Unit Conversion": () => {
            const feet = rand(2, 5);
            const inches = feet * 12;
            return {
                concept: `<strong>Unit Conversion</strong> means changing measurements from one unit to another.<br><br>
                <strong>Key conversions to memorize:</strong><br>
                ‚Ä¢ <strong>Length:</strong> 1 foot = 12 inches, 1 yard = 3 feet, 1 mile = 5,280 feet<br>
                ‚Ä¢ <strong>Weight:</strong> 1 pound = 16 ounces, 1 ton = 2,000 pounds<br>
                ‚Ä¢ <strong>Volume:</strong> 1 gallon = 4 quarts, 1 quart = 2 pints, 1 pint = 2 cups<br><br>
                <strong>The Rule:</strong><br>
                ‚Ä¢ Bigger ‚Üí Smaller units: <strong>MULTIPLY</strong> (more of the smaller unit)<br>
                ‚Ä¢ Smaller ‚Üí Bigger units: <strong>DIVIDE</strong> (fewer of the bigger unit)`,
                example: { problem: `Convert 3 feet to inches`, steps: [
                    { text: "Find the conversion", math: "1 foot = 12 inches" },
                    { text: "Are we going bigger ‚Üí smaller or smaller ‚Üí bigger?", math: "Feet ‚Üí inches = Bigger ‚Üí Smaller = MULTIPLY" },
                    { text: "Multiply: 3 feet √ó 12 inches/foot", math: "3 √ó 12 = 36" },
                    { text: "Add the unit", math: "3 feet = <strong>36 inches</strong>" }
                ]},
                keyPoints: [
                    "Bigger ‚Üí Smaller = MULTIPLY (feet to inches: more inches)",
                    "Smaller ‚Üí Bigger = DIVIDE (inches to feet: fewer feet)",
                    "Always check: Does your answer make sense? More inches than feet!"
                ],
                mistakes: [
                    { wrong: "3 feet = 3 + 12 = 15 inches", why: "You MULTIPLY, not add! 3 √ó 12 = 36" },
                    { wrong: "Dividing when going to smaller units", why: "Smaller units = MORE of them. 3 feet is MANY inches, so multiply." },
                    { wrong: "Forgetting the conversion factor", why: "Memorize key ones: 12 in/ft, 16 oz/lb, 4 qt/gal" }
                ],
                guided: {
                    problem: `Convert ${feet} feet to inches`,
                    steps: [
                        { label: "Conversion factor", value: "1 foot = 12 inches" },
                        { label: "Going bigger ‚Üí smaller, so", value: "MULTIPLY" },
                        { label: `${feet} feet √ó 12 =`, value: "?" }
                    ],
                    answer: String(inches),
                    answerLabel: "Inches:",
                    interactiveSteps: [
                        {
                            prompt: "How many inches are in 1 foot?",
                            hint: "Think of a ruler...",
                            answer: "12",
                            acceptableAnswers: ["12", "twelve", "12 inches"],
                            commonMistakes: {
                                "10": "It's 12 inches in a foot, not 10.",
                                "3": "That's feet in a yard. Inches in a foot = 12."
                            }
                        },
                        {
                            prompt: "We're converting from feet (bigger) to inches (smaller). Do we multiply or divide?",
                            hint: "Going to smaller units means we'll have MORE of them...",
                            answer: "multiply",
                            acceptableAnswers: ["multiply", "multiplication", "√ó", "times"],
                            commonMistakes: {
                                "divide": "Divide for bigger ‚Üí smaller? No! Smaller units = more of them, so MULTIPLY.",
                                "add": "We need to multiply by the conversion factor, not add."
                            }
                        },
                        {
                            prompt: `Calculate: ${feet} feet √ó 12 inches/foot = ?`,
                            hint: `${feet} √ó 12 = ?`,
                            answer: String(inches),
                            acceptableAnswers: [String(inches), `${inches} inches`],
                            commonMistakes: {
                                [String(feet + 12)]: `You added! Multiply: ${feet} √ó 12 = ${inches}`,
                                [String(feet)]: `Don't forget to convert! ${feet} √ó 12 = ${inches}`
                            }
                        }
                    ]
                },
                practice: (() => { const lbs = 3; const oz = lbs * 16; return {
                    problem: `How many ounces are in ${lbs} pounds?`, answer: String(oz),
                    options: [String(lbs + 16), String(lbs * 8), String(oz), String(oz + 16)],
                    mistakeAnalysis: {
                        [String(lbs + 16)]: `You added instead of multiplied! ${lbs} √ó 16 = ${oz}`,
                        [String(lbs * 8)]: `Wrong conversion: 1 pound = 16 ounces (not 8). ${lbs} √ó 16 = ${oz}`,
                        [String(oz + 16)]: `Close, but check your multiplication: ${lbs} √ó 16 = ${oz}`
                    }}; })()
            };
        },
        "Basic Graphing": () => {
            const x = rand(1, 5), y = rand(1, 5);
            return {
                concept: `<strong>Coordinate Graphing</strong> uses ordered pairs (x, y) to locate points on a grid.<br><br>
                <strong>The coordinate plane:</strong><br>
                ‚Ä¢ <strong>x-axis:</strong> horizontal line (left-right) ‚Üí<br>
                ‚Ä¢ <strong>y-axis:</strong> vertical line (up-down) ‚Üë<br>
                ‚Ä¢ <strong>Origin:</strong> (0, 0) - where the axes cross<br><br>
                <strong>Reading coordinates (x, y):</strong><br>
                ‚Ä¢ <strong>x comes first:</strong> how far LEFT or RIGHT<br>
                ‚Ä¢ <strong>y comes second:</strong> how far UP or DOWN<br><br>
                <strong>The Four Quadrants:</strong><br>
                ‚Ä¢ Quadrant I: (+, +) upper right<br>
                ‚Ä¢ Quadrant II: (-, +) upper left<br>
                ‚Ä¢ Quadrant III: (-, -) lower left<br>
                ‚Ä¢ Quadrant IV: (+, -) lower right`,
                example: { problem: `Plot the point (3, 2) and identify its quadrant`, steps: [
                    { text: "Start at the origin (0, 0)", math: "This is where the x and y axes cross" },
                    { text: "x = 3: Move RIGHT 3 units", math: "‚Üí ‚Üí ‚Üí (now at x = 3)" },
                    { text: "y = 2: Move UP 2 units", math: "‚Üë ‚Üë (now at y = 2)" },
                    { text: "Mark the point (3, 2)", math: "Both coordinates are positive ‚Üí <strong>Quadrant I</strong>" }
                ]},
                keyPoints: [
                    "Remember: (x, y) - 'x' comes before 'y' in the alphabet!",
                    "x = horizontal (like the horizon), y = vertical",
                    "Positive x = right, Negative x = left, Positive y = up, Negative y = down"
                ],
                mistakes: [
                    { wrong: "Plotting (3, 2) by going up 3, right 2", why: "x comes FIRST! Go right 3, THEN up 2." },
                    { wrong: "Confusing (2, 5) and (5, 2)", why: "These are different points! (2, 5) is right 2, up 5. (5, 2) is right 5, up 2." },
                    { wrong: "Saying (-3, 4) is in Quadrant IV", why: "x is negative (left), y is positive (up) = Quadrant II" }
                ],
                guided: {
                    problem: `What are the coordinates of a point that is ${x} units right and ${y} units up from the origin?`,
                    steps: [
                        { label: "Right means positive x", value: `x = ${x}` },
                        { label: "Up means positive y", value: `y = ${y}` },
                        { label: "Write as (x, y)", value: "?" }
                    ],
                    answer: `(${x}, ${y})`,
                    answerLabel: "Coordinates:",
                    interactiveSteps: [
                        {
                            prompt: "In coordinates (x, y), which direction does x represent?",
                            hint: "x is horizontal, like the horizon...",
                            answer: "horizontal",
                            acceptableAnswers: ["horizontal", "left-right", "left right", "right-left"],
                            commonMistakes: {
                                "vertical": "x is HORIZONTAL (left-right). y is vertical (up-down).",
                                "up-down": "That's y! x is horizontal (left-right)."
                            }
                        },
                        {
                            prompt: `Moving ${x} units RIGHT means x is positive or negative?`,
                            hint: "Right is the positive direction on a number line...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "+", "plus"],
                            commonMistakes: {
                                "negative": "RIGHT is positive. LEFT would be negative."
                            }
                        },
                        {
                            prompt: `Moving ${y} units UP means y is positive or negative?`,
                            hint: "Up is like going higher on a number line...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "+", "plus"],
                            commonMistakes: {
                                "negative": "UP is positive. DOWN would be negative."
                            }
                        },
                        {
                            prompt: `So x = ${x} and y = ${y}. Write the coordinates in (x, y) format:`,
                            hint: "Put x first, then y, in parentheses...",
                            answer: `(${x}, ${y})`,
                            acceptableAnswers: [`(${x}, ${y})`, `(${x},${y})`, `${x}, ${y}`],
                            commonMistakes: {
                                [`(${y}, ${x})`]: "x comes FIRST! It's (x, y), not (y, x)."
                            }
                        }
                    ]
                },
                practice: { problem: `The point (-4, 3) is in which quadrant?`, answer: "II",
                    options: ["I", "II", "III", "IV"],
                    mistakeAnalysis: {
                        "I": "x is negative (-4), so we're on the LEFT side, not right. Left + up = Quadrant II",
                        "III": "y is positive (3), so we're UP, not down. Left + up = Quadrant II",
                        "IV": "Both conditions wrong: x is negative (left) and y is positive (up) = Quadrant II"
                    }}
            };
        },
        "Data Collection": () => ({
            concept: `<strong>Data Collection</strong> means gathering and organizing information.<br><br>
            <strong>Ways to collect data:</strong><br>
            ‚Ä¢ <strong>Surveys:</strong> Ask people questions<br>
            ‚Ä¢ <strong>Observations:</strong> Watch and record what happens<br>
            ‚Ä¢ <strong>Experiments:</strong> Test something and record results<br><br>
            <strong>Ways to organize data:</strong><br>
            ‚Ä¢ <strong>Tally marks:</strong> |||| = 4, <s>||||</s> = 5 (cross every 5)<br>
            ‚Ä¢ <strong>Frequency tables:</strong> List items and count them<br>
            ‚Ä¢ <strong>Bar graphs:</strong> Show amounts with bars<br>
            ‚Ä¢ <strong>Pictographs:</strong> Use pictures to represent data`,
            example: { problem: `A tally chart shows: Pizza ||||  |||, Burgers ||||  ||, Tacos ||||. What's the total surveyed?`, steps: [
                { text: "Count Pizza", math: "|||| ||| = 5 + 3 = 8" },
                { text: "Count Burgers", math: "|||| || = 5 + 2 = 7" },
                { text: "Count Tacos", math: "|||| = 5" },
                { text: "Add all categories", math: "8 + 7 + 5 = <strong>20 people surveyed</strong>" }
            ]},
            keyPoints: [
                "Tally groups of 5: ||||  means the 5th mark crosses through the first 4",
                "Total = add up ALL categories",
                "Labels are important - what does each tally represent?"
            ],
            mistakes: [
                { wrong: "Counting |||| as 4 instead of 5", why: "When you see 4 marks with a line through, that's 5!" },
                { wrong: "Forgetting to add all categories", why: "Make sure to count EVERY category in the data set" },
                { wrong: "Miscounting the extra marks after 5s", why: "Count groups of 5 first, then add remaining marks: ||||  ||| = 5 + 3 = 8" }
            ],
            guided: {
                problem: `Tally: Red |||| ||||, Blue |||| |||, Green ||||. How many total?`,
                steps: [
                    { label: "Red: |||| |||| =", value: "5 + 5 = 10" },
                    { label: "Blue: |||| ||| =", value: "5 + 3 = 8" },
                    { label: "Green: |||| =", value: "5" },
                    { label: "Total", value: "?" }
                ],
                answer: "23",
                answerLabel: "Total:",
                interactiveSteps: [
                    {
                        prompt: "In tally marks, what does |||| (4 marks with a line through) represent?",
                        hint: "The fifth mark crosses through the first four...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "4": "When a line crosses through 4 marks, it makes 5! |||| = 5"
                        }
                    },
                    {
                        prompt: "Count Red: |||| |||| (two groups of crossed tallies). How many?",
                        hint: "Each |||| = 5, so two groups is...",
                        answer: "10",
                        acceptableAnswers: ["10", "ten"],
                        commonMistakes: {
                            "8": "Each |||| = 5, not 4. So |||| |||| = 5 + 5 = 10",
                            "5": "There are TWO groups of 5: 5 + 5 = 10"
                        }
                    },
                    {
                        prompt: "Count Blue: |||| ||| (one crossed group plus 3 marks). How many?",
                        hint: "|||| = 5, plus ||| = 3 more...",
                        answer: "8",
                        acceptableAnswers: ["8", "eight"],
                        commonMistakes: {
                            "7": "|||| = 5 (not 4), plus 3 = 8",
                            "53": "Add them: 5 + 3 = 8"
                        }
                    },
                    {
                        prompt: "Count Green: |||| (one crossed group). How many?",
                        hint: "One group of crossed tallies...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "4": "|||| (with cross) = 5, not 4!"
                        }
                    },
                    {
                        prompt: "Now add all colors: Red (10) + Blue (8) + Green (5) = ?",
                        hint: "10 + 8 + 5 = ?",
                        answer: "23",
                        acceptableAnswers: ["23", "twenty-three"],
                        commonMistakes: {
                            "18": "Don't forget all three! 10 + 8 + 5 = 23",
                            "13": "You missed one color. 10 + 8 + 5 = 23"
                        }
                    }
                ]
            },
            practice: { problem: `Survey: 5 like pizza, 8 like burgers, 3 like tacos, 4 like salad. Total surveyed?`, answer: "20",
                options: ["16", "18", "20", "22"],
                mistakeAnalysis: {
                    "16": "You missed one category! Add ALL: 5 + 8 + 3 + 4 = 20",
                    "18": "Check your addition: 5 + 8 = 13, 13 + 3 = 16, 16 + 4 = 20",
                    "22": "Double-check: 5 + 8 + 3 + 4 = 20, not 22"
                }}
        }),
        Fractions: () => {
            const num = rand(1, 5), denom = rand(num + 1, 8);
            return {
                concept: `<strong>Fractions</strong> represent parts of a whole or a division problem.<br><br>
                <strong>Parts of a fraction:</strong><br>
                ‚Ä¢ <strong>Numerator</strong> (top): How many parts you HAVE<br>
                ‚Ä¢ <strong>Denominator</strong> (bottom): How many EQUAL parts in the whole<br><br>
                <strong>Comparing fractions with same denominator:</strong><br>
                Bigger numerator = bigger fraction (3/5 > 2/5)<br><br>
                <strong>Comparing fractions with same numerator:</strong><br>
                Smaller denominator = bigger fraction (1/2 > 1/4)`,
                example: { problem: `Which is larger: 3/8 or 5/8?`, steps: [
                    { text: "Check if denominators are the same", math: "Both are eighths (8) ‚úì" },
                    { text: "With same denominators, compare numerators", math: "5 > 3" },
                    { text: "Larger numerator = larger fraction", math: "<strong>5/8 > 3/8</strong>" },
                    { text: "Think of it as pizza", math: "5 slices of pizza is more than 3 slices!" }
                ]},
                keyPoints: [
                    "Same denominator? Compare numerators - bigger numerator wins",
                    "Same numerator? Compare denominators - SMALLER denominator wins (1/2 > 1/4)",
                    "Visualize: more pieces of same-sized pizza = more pizza"
                ],
                mistakes: [
                    { wrong: "Thinking 1/4 > 1/2 because 4 > 2", why: "The denominator tells size of pieces. 4 pieces means smaller pieces than 2 pieces!" },
                    { wrong: "Adding numerators and denominators: 1/2 + 1/3 = 2/5", why: "You can only add fractions with the same denominator" },
                    { wrong: "Confusing numerator and denominator", why: "Top = how many you have. Bottom = size of pieces." }
                ],
                guided: {
                    problem: `Compare ${num}/${denom} and ${num + 1}/${denom}. Which is larger?`,
                    steps: [
                        { label: "Same denominator?", value: `Yes, both are ${denom}ths` },
                        { label: "Compare numerators", value: `${num + 1} > ${num}` },
                        { label: "Larger fraction is", value: "?" }
                    ],
                    answer: `${num + 1}/${denom}`,
                    answerLabel: "Larger fraction:",
                    interactiveSteps: [
                        {
                            prompt: `Look at ${num}/${denom} and ${num + 1}/${denom}. Are the denominators (bottom numbers) the same?`,
                            hint: "Compare the bottom numbers of both fractions...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "yep", "same"],
                            commonMistakes: {
                                "no": `Both denominators are ${denom}. They're the same!`
                            }
                        },
                        {
                            prompt: "When denominators are the same, how do we compare fractions?",
                            hint: "If pieces are the same size, just count how many pieces...",
                            answer: "compare numerators",
                            acceptableAnswers: ["compare numerators", "look at numerators", "bigger numerator", "numerators"],
                            commonMistakes: {
                                "compare denominators": "Denominators are already the same! Compare the numerators (top numbers)."
                            }
                        },
                        {
                            prompt: `Which numerator is larger: ${num} or ${num + 1}?`,
                            hint: `${num + 1} is one more than ${num}...`,
                            answer: String(num + 1),
                            acceptableAnswers: [String(num + 1)],
                            commonMistakes: {
                                [String(num)]: `${num + 1} > ${num}. ${num + 1} is larger!`
                            }
                        },
                        {
                            prompt: `So which fraction is larger: ${num}/${denom} or ${num + 1}/${denom}?`,
                            hint: "Bigger numerator = bigger fraction (when denominators match)",
                            answer: `${num + 1}/${denom}`,
                            acceptableAnswers: [`${num + 1}/${denom}`, `${num+1}/${denom}`],
                            commonMistakes: {
                                [`${num}/${denom}`]: `${num + 1} > ${num}, so ${num + 1}/${denom} is larger!`
                            }
                        }
                    ]
                },
                practice: { problem: `Which is larger: 2/5 or 2/3?`, answer: "2/3",
                    options: ["2/5", "2/3", "They're equal"],
                    mistakeAnalysis: {
                        "2/5": "Same numerator (2), so compare denominators. Smaller denominator = bigger pieces. 2/3 has bigger pieces!",
                        "They're equal": "With same numerator, the smaller denominator means bigger pieces. 2/3 > 2/5"
                    }}
            };
        },
        Decimals: () => {
            const whole = rand(1, 5);
            const tenths = rand(1, 9);
            const hundredths = rand(1, 9);
            return {
                concept: `<strong>Decimals</strong> are another way to write fractions with denominators of 10, 100, 1000, etc.<br><br>
                <strong>Place values after the decimal point:</strong><br>
                ‚Ä¢ <strong>Tenths</strong> (0.1) = 1/10 - first place after decimal<br>
                ‚Ä¢ <strong>Hundredths</strong> (0.01) = 1/100 - second place after decimal<br>
                ‚Ä¢ <strong>Thousandths</strong> (0.001) = 1/1000 - third place after decimal<br><br>
                <strong>Reading decimals:</strong><br>
                3.75 = "three and seventy-five hundredths"`,
                example: { problem: `Convert 3/4 to a decimal`, steps: [
                    { text: "Fractions are division problems", math: "3/4 means 3 √∑ 4" },
                    { text: "Divide 3 by 4", math: "3 √∑ 4 = 0.75" },
                    { text: "Check: 0.75 = 75/100 = 3/4 ‚úì", math: "<strong>3/4 = 0.75</strong>" }
                ]},
                keyPoints: [
                    "Decimal point separates whole numbers from parts",
                    "Each place to the right is 10√ó smaller (tenths, hundredths, thousandths)",
                    "Common decimals: 1/2 = 0.5, 1/4 = 0.25, 3/4 = 0.75, 1/5 = 0.2"
                ],
                mistakes: [
                    { wrong: "0.5 > 0.25 but thinking 0.5 < 0.25 because 5 < 25", why: "Compare place by place: 0.5 = 0.50, and 50 hundredths > 25 hundredths" },
                    { wrong: "Writing 'three tenths' as 0.03", why: "Tenths is the FIRST place: 0.3 (not 0.03, which is hundredths)" },
                    { wrong: "0.1 + 0.2 = 0.3 but writing 0.12", why: "Line up decimal points and add like regular numbers: 0.1 + 0.2 = 0.3" }
                ],
                guided: {
                    problem: `Write 0.${tenths}${hundredths} as a fraction`,
                    steps: [
                        { label: "Count decimal places", value: "2 places = hundredths" },
                        { label: "Write over 100", value: `${tenths}${hundredths}/100` },
                        { label: "Simplify if possible", value: "?" }
                    ],
                    answer: `${tenths}${hundredths}/100`,
                    answerLabel: "Fraction:",
                    interactiveSteps: [
                        {
                            prompt: `In 0.${tenths}${hundredths}, how many digits are after the decimal point?`,
                            hint: "Count the digits to the right of the decimal...",
                            answer: "2",
                            acceptableAnswers: ["2", "two"],
                            commonMistakes: {
                                "1": `There are 2 digits: ${tenths} and ${hundredths}`,
                                "3": "Only count digits AFTER the decimal, not the 0 before it."
                            }
                        },
                        {
                            prompt: "2 decimal places means the denominator is 10, 100, or 1000?",
                            hint: "1 place = tenths (10), 2 places = hundredths (?), 3 places = thousandths (1000)",
                            answer: "100",
                            acceptableAnswers: ["100", "hundredths"],
                            commonMistakes: {
                                "10": "That's for 1 decimal place. 2 places = 100",
                                "1000": "That's for 3 decimal places. 2 places = 100"
                            }
                        },
                        {
                            prompt: `The digits after the decimal are ${tenths}${hundredths}. What is the numerator of our fraction?`,
                            hint: "Just read the digits as a number...",
                            answer: `${tenths}${hundredths}`,
                            acceptableAnswers: [`${tenths}${hundredths}`, String(parseInt(`${tenths}${hundredths}`))],
                            commonMistakes: {
                                [String(tenths)]: `Include both digits: ${tenths}${hundredths}`,
                                [String(hundredths)]: `Include both digits: ${tenths}${hundredths}`
                            }
                        },
                        {
                            prompt: `So 0.${tenths}${hundredths} = ?/100`,
                            hint: `Numerator is ${tenths}${hundredths}, denominator is 100`,
                            answer: `${tenths}${hundredths}/100`,
                            acceptableAnswers: [`${tenths}${hundredths}/100`, `${tenths}${hundredths} / 100`],
                            commonMistakes: {
                                [`${tenths}${hundredths}/10`]: "2 decimal places means /100, not /10"
                            }
                        }
                    ]
                },
                practice: { problem: `Which is greater: 0.4 or 0.38?`, answer: "0.4",
                    options: ["0.4", "0.38", "They're equal"],
                    mistakeAnalysis: {
                        "0.38": "Compare place by place: 0.4 = 0.40. Tenths: 4 = 4 ‚úì. Hundredths: 0 < 8... wait, 40 > 38!",
                        "They're equal": "0.4 = 0.40. Compare to 0.38: 40 hundredths > 38 hundredths"
                    }}
            };
        },
        Ratios: () => {
            const a = rand(2, 5), b = rand(3, 6);
            return {
                concept: `<strong>Ratios</strong> compare two quantities. They can be written three ways:<br><br>
                ‚Ä¢ <strong>With a colon:</strong> 3:2<br>
                ‚Ä¢ <strong>As a fraction:</strong> 3/2<br>
                ‚Ä¢ <strong>With words:</strong> "3 to 2"<br><br>
                <strong>Equivalent ratios:</strong><br>
                Just like equivalent fractions! Multiply or divide both parts by the same number.<br>
                3:2 = 6:4 = 9:6 = 12:8 (all the same ratio!)`,
                example: { problem: `A recipe uses 2 cups flour for every 3 cups sugar. If you use 6 cups flour, how much sugar?`, steps: [
                    { text: "Write the ratio", math: "Flour : Sugar = 2 : 3" },
                    { text: "How did flour change? 2 ‚Üí 6", math: "2 √ó 3 = 6 (multiplied by 3)" },
                    { text: "Do the same to sugar", math: "3 √ó 3 = 9" },
                    { text: "New ratio", math: "6 : 9, so <strong>9 cups sugar</strong>" }
                ]},
                keyPoints: [
                    "Ratios compare two amounts (part to part OR part to whole)",
                    "Equivalent ratios: multiply/divide BOTH parts by the same number",
                    "Order matters! 2:3 is different from 3:2"
                ],
                mistakes: [
                    { wrong: "2:3 is the same as 3:2", why: "Order matters! 2:3 means 2 for every 3, not 3 for every 2" },
                    { wrong: "Only multiplying one part of the ratio", why: "Whatever you do to one part, do to BOTH parts" },
                    { wrong: "Adding instead of multiplying to find equivalent ratios", why: "2:3 ‚Üí 4:6 (multiply by 2), not 4:5 (add 2)" }
                ],
                guided: {
                    problem: `Write an equivalent ratio: ${a}:${b} = ?:${b * 2}`,
                    steps: [
                        { label: `${b} was multiplied by what to get ${b * 2}?`, value: `${b} √ó 2 = ${b * 2}` },
                        { label: `Do the same to ${a}`, value: `${a} √ó 2 = ?` }
                    ],
                    answer: String(a * 2),
                    answerLabel: `${a}:${b} = ?:${b * 2}`,
                    interactiveSteps: [
                        {
                            prompt: `In ${a}:${b} = ?:${b * 2}, the second number changed from ${b} to ${b * 2}. What did we multiply by?`,
                            hint: `${b} √ó ? = ${b * 2}`,
                            answer: "2",
                            acceptableAnswers: ["2", "two", "√ó 2", "√ó2"],
                            commonMistakes: {
                                [String(b)]: `${b} √ó ${b} = ${b * b}, not ${b * 2}. We multiplied by 2.`,
                                [String(b * 2)]: `That's the result. ${b} √ó 2 = ${b * 2}, so we multiplied by 2.`
                            }
                        },
                        {
                            prompt: "In equivalent ratios, what you do to one part, you must do to the other. What do we do to the first number?",
                            hint: "We multiplied the second by 2, so...",
                            answer: "multiply by 2",
                            acceptableAnswers: ["multiply by 2", "√ó 2", "times 2", "multiply it by 2"],
                            commonMistakes: {
                                "add 2": "We MULTIPLY, not add. Whatever we did to ${b}, do to ${a}."
                            }
                        },
                        {
                            prompt: `Calculate: ${a} √ó 2 = ?`,
                            hint: "Double ${a}...",
                            answer: String(a * 2),
                            acceptableAnswers: [String(a * 2)],
                            commonMistakes: {
                                [String(a + 2)]: `You added 2 instead of multiplying! ${a} √ó 2 = ${a * 2}`,
                                [String(a)]: `Don't forget to multiply! ${a} √ó 2 = ${a * 2}`
                            }
                        },
                        {
                            prompt: `So ${a}:${b} = ?:${b * 2}. What is the missing number?`,
                            hint: `We found ${a} √ó 2 = ${a * 2}`,
                            answer: String(a * 2),
                            acceptableAnswers: [String(a * 2)],
                            commonMistakes: {
                                [String(a)]: `That's the original. The equivalent ratio is ${a * 2}:${b * 2}`
                            }
                        }
                    ]
                },
                practice: { problem: `If the ratio of cats to dogs is 3:5, and there are 15 dogs, how many cats?`, answer: "9",
                    options: ["5", "9", "12", "15"],
                    mistakeAnalysis: {
                        "5": "5 is from the original ratio. We need to scale up: 5 √ó 3 = 15 dogs, so 3 √ó 3 = 9 cats",
                        "12": "Check your multiplication: 5 ‚Üí 15 is √ó3, so 3 √ó 3 = 9, not 12",
                        "15": "15 is the number of dogs. For cats: 5 √ó 3 = 15, so cats = 3 √ó 3 = 9"
                    }}
            };
        }
    },
    4: {
        Equations: () => {
            const x = rand(3, 12), b = rand(2, 10);
            return {
                goalProblem: `Solve: x + 5 = 12`,
                teachingSteps: [
                    {
                        title: "What does 'solving an equation' mean?",
                        explanation: "We need to find the value of <strong>x</strong> that makes the equation true. Think of x as a mystery number we're trying to discover!",
                        visual: "x + 5 = 12 ‚Üí What is x?"
                    },
                    {
                        title: "The balance scale rule",
                        explanation: "An equation is like a balance scale. Whatever you do to one side, you <strong>MUST</strong> do to the other side to keep it balanced!",
                        visual: "Left side = Right side (always!)"
                    },
                    {
                        title: "Identify what's being done to x",
                        explanation: "Look at the left side: x + 5. The number 5 is being <strong>added</strong> to x. To get x alone, we need to undo this.",
                        visual: "x + 5 ‚Üí 5 is ADDED to x"
                    },
                    {
                        title: "Do the opposite to both sides",
                        explanation: "Since 5 is added to x, we do the opposite (subtract 5) from <strong>both sides</strong>: x + 5 - 5 = 12 - 5",
                        visual: "x + 5 - 5 = 12 - 5"
                    },
                    {
                        title: "Simplify to get the answer",
                        explanation: "On the left: x + 5 - 5 = x. On the right: 12 - 5 = 7. So <strong>x = 7</strong>! Check: 7 + 5 = 12 ‚úì",
                        visual: "x = 7"
                    }
                ],
                finalAnswer: "x = 7",
                answerExplanation: "By subtracting 5 from both sides, we isolated x. Always check: 7 + 5 = 12 ‚úì",
                example: { problem: `Solve: x + 5 = 12`, steps: [
                    { text: "What's being done to x?", math: "5 is being ADDED to x" },
                    { text: "Do the opposite (subtract 5) from BOTH sides", math: "x + 5 - 5 = 12 - 5" },
                    { text: "Simplify both sides", math: "x = 7" },
                    { text: "Check: Does 7 + 5 = 12?", math: "7 + 5 = 12 ‚úì <strong>x = 7</strong>" }
                ]},
                keyPoints: [
                    "Opposite operations: + ‚Üî ‚àí, √ó ‚Üî √∑",
                    "Think of an equation like a balance scale - keep both sides equal",
                    "ALWAYS check your answer by plugging it back in"
                ],
                mistakes: [
                    { wrong: "Only operating on one side", why: "If you subtract 5 from the left, you MUST subtract 5 from the right too!" },
                    { wrong: "x + 5 = 12 ‚Üí x = 12 + 5 = 17", why: "You need to UNDO the addition, which means SUBTRACT. x = 12 - 5 = 7" },
                    { wrong: "Forgetting to check your answer", why: "Checking catches mistakes! If x = 7, then 7 + 5 should equal 12." }
                ],
                guided: { problem: `Solve: x + ${b} = ${x + b}`, steps: [
                    { label: "What operation is on x?", value: `Adding ${b}` },
                    { label: "Do the opposite to both sides", value: `Subtract ${b} from both sides` },
                    { label: `x + ${b} - ${b} = ${x + b} - ${b}`, value: `x = ?` }
                ], answer: String(x), answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In the equation x + ${b} = ${x + b}, what operation is being done to x?`,
                            hint: "Look at the left side. What's happening to x?",
                            answer: "addition",
                            acceptableAnswers: ["addition", "adding", "add", "plus", `adding ${b}`, "+ " + b],
                            commonMistakes: {
                                "subtraction": `Look again: x + ${b}. The + sign means addition!`,
                                "multiplication": "There's no √ó sign. x + ${b} uses addition."
                            }
                        },
                        {
                            prompt: "To get x alone, we do the OPPOSITE. What's the opposite of addition?",
                            hint: "If adding makes it bigger, what makes it smaller?",
                            answer: "subtraction",
                            acceptableAnswers: ["subtraction", "subtract", "minus", "-"],
                            commonMistakes: {
                                "division": "Division is the opposite of multiplication. The opposite of addition is subtraction.",
                                "addition": "We need to UNDO the addition, so we do the opposite."
                            }
                        },
                        {
                            prompt: `We'll subtract ${b} from BOTH sides. What is ${x + b} - ${b}?`,
                            hint: `Start with ${x + b} and subtract ${b}...`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String(x + b)]: `You need to subtract! ${x + b} - ${b} = ${x}`,
                                [String(x + b + b)]: `Subtract, not add! ${x + b} - ${b} = ${x}`
                            }
                        },
                        {
                            prompt: `So x + ${b} - ${b} = ${x}. This simplifies to x = ?`,
                            hint: `x + ${b} - ${b} = x + 0 = x. And we found that equals ${x}`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String(x + b)]: `Remember, we subtracted ${b} from both sides. x = ${x}`
                            }
                        }
                    ]
                },
                practice: (() => { const newB = b + 2; return {
                    problem: `Solve: x + ${newB} = ${x + newB}`, answer: String(x),
                    options: shuffle([String(x), String(x + newB), String(2 * newB), String(newB)]),
                    mistakeAnalysis: {
                        [String(x + newB)]: `You kept the right side unchanged. Subtract ${newB} from both sides: ${x + newB} - ${newB} = ${x}`,
                        [String(2 * newB)]: `That's not how equations work. Subtract ${newB} from ${x + newB} to isolate x.`,
                        [String(newB)]: `That's just the number being added. To find x, subtract ${newB} from ${x + newB}.`
                    }}; })()
            };
        },
        Exponents: () => {
            const base = rand(2, 4), exp = rand(2, 3);
            const ans = Math.pow(base, exp);
            return {
                goalProblem: `What is 2¬≥?`,
                teachingSteps: [
                    {
                        title: "What are exponents?",
                        explanation: "<strong>Exponents</strong> are shorthand for repeated multiplication. Instead of writing 2 √ó 2 √ó 2, we can write 2¬≥!",
                        visual: "2 √ó 2 √ó 2 = 2¬≥"
                    },
                    {
                        title: "The two parts: base and exponent",
                        explanation: "In 2¬≥, the <strong>2</strong> is the 'base' (the number being multiplied) and the <strong>3</strong> is the 'exponent' (how many times).",
                        visual: "2¬≥ ‚Üí base=2, exponent=3"
                    },
                    {
                        title: "Read it as: 'multiply base by itself exponent times'",
                        explanation: "2¬≥ means: multiply 2 by itself <strong>3 times</strong>. NOT 2 √ó 3! The exponent tells us how many 2s to multiply.",
                        visual: "2¬≥ = 2 √ó 2 √ó 2 (three 2s)"
                    },
                    {
                        title: "Calculate step by step",
                        explanation: "Start with the first two: 2 √ó 2 = 4. Then multiply by the next 2: 4 √ó 2 = 8.",
                        visual: "2 √ó 2 = 4 ‚Üí 4 √ó 2 = 8"
                    },
                    {
                        title: "The answer",
                        explanation: "<strong>2¬≥ = 8</strong>. Remember: the exponent is NOT a multiplier, it's a counter of how many times!",
                        visual: "2¬≥ = 8"
                    }
                ],
                finalAnswer: "8",
                answerExplanation: "2¬≥ means 2 √ó 2 √ó 2 = 8. The exponent (3) tells us to multiply the base (2) by itself 3 times!",
                example: { problem: `What is 2¬≥?`, steps: [
                    { text: "Identify: base = 2, exponent = 3", math: "Multiply 2 by itself 3 times" },
                    { text: "Write out the multiplication", math: "2¬≥ = 2 √ó 2 √ó 2" },
                    { text: "Calculate step by step", math: "2 √ó 2 = 4" },
                    { text: "Then multiply by the next 2", math: "4 √ó 2 = <strong>8</strong>" }
                ]},
                keyPoints: [
                    "The exponent tells you HOW MANY times to multiply the base",
                    "2¬≥ = 2 √ó 2 √ó 2 = 8 (NOT 2 √ó 3 = 6!)",
                    "The bigger the exponent, the faster the number grows: 2¬π = 2, 2¬≤ = 4, 2¬≥ = 8, 2‚Å¥ = 16"
                ],
                mistakes: [
                    { wrong: "2¬≥ = 2 √ó 3 = 6", why: "Don't multiply base times exponent! 2¬≥ means 2 √ó 2 √ó 2 = 8" },
                    { wrong: "3¬≤ = 6", why: "3¬≤ means 3 √ó 3 = 9, not 3 √ó 2" },
                    { wrong: "5‚Å∞ = 0", why: "Any number (except 0) to the power of 0 equals 1. 5‚Å∞ = 1" }
                ],
                guided: { problem: `What is ${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]}?`, steps: [
                    { label: "Identify base and exponent", value: `Base = ${base}, Exponent = ${exp}` },
                    { label: "Write as repeated multiplication", value: `${Array(exp).fill(base).join(' √ó ')}` },
                    { label: "Calculate", value: "?" }
                ], answer: String(ans), answerLabel: `${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `In ${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]}, what is the BASE (the number being multiplied)?`,
                            hint: "The base is the big number at the bottom...",
                            answer: String(base),
                            acceptableAnswers: [String(base)],
                            commonMistakes: {
                                [String(exp)]: `${exp} is the exponent (the small number). The base is ${base}.`
                            }
                        },
                        {
                            prompt: `In ${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]}, what is the EXPONENT (how many times to multiply)?`,
                            hint: "The exponent is the small raised number...",
                            answer: String(exp),
                            acceptableAnswers: [String(exp)],
                            commonMistakes: {
                                [String(base)]: `${base} is the base. The exponent is the small raised number: ${exp}`
                            }
                        },
                        {
                            prompt: `So ${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]} means: multiply ${base} by itself how many times?`,
                            hint: "The exponent tells us how many times...",
                            answer: String(exp),
                            acceptableAnswers: [String(exp), exp === 2 ? "twice" : "three times", exp === 2 ? "two" : "three"],
                            commonMistakes: {
                                [String(base * exp)]: `That's ${base} √ó ${exp}. The exponent tells us HOW MANY times to multiply, which is ${exp}.`
                            }
                        },
                        {
                            prompt: `Write it out: ${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]} = ${base} √ó ${base}${exp === 3 ? ` √ó ${base}` : ''}. What is ${base} √ó ${base}?`,
                            hint: `${base} times ${base}...`,
                            answer: String(base * base),
                            acceptableAnswers: [String(base * base)],
                            commonMistakes: {
                                [String(base + base)]: `You added! ${base} √ó ${base} = ${base * base}, not ${base} + ${base} = ${base + base}`,
                                [String(base)]: `${base} √ó ${base} = ${base * base}`
                            }
                        },
                        {
                            prompt: exp === 2 ? `So ${base}¬≤ = ?` : `Now: ${base * base} √ó ${base} = ?`,
                            hint: exp === 2 ? `${base} √ó ${base} = ?` : `${base * base} √ó ${base}...`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(base * exp)]: `Remember, we multiply ${base} by itself ${exp} times, not ${base} √ó ${exp}. The answer is ${ans}.`
                            }
                        }
                    ]
                },
                practice: (() => { const pe = exp === 3 ? 2 : 3; const pa = Math.pow(base, pe); return {
                    problem: `What is ${base}${['‚Å∞','¬π','¬≤','¬≥'][pe]}?`, answer: String(pa),
                    options: shuffle([String(pa), String(base * pe), String(Math.pow(base, exp)), String(base + pe)]),
                    mistakeAnalysis: {
                        [String(base * pe)]: `You multiplied ${base} √ó ${pe} = ${base * pe}. But ${base}${['‚Å∞','¬π','¬≤','¬≥'][pe]} means ${Array(pe).fill(base).join(' √ó ')} = ${pa}`,
                        [String(Math.pow(base, exp))]: `That's ${base}${['‚Å∞','¬π','¬≤','¬≥'][exp]}. For ${base}${['‚Å∞','¬π','¬≤','¬≥'][pe]}, multiply ${base} by itself ${pe} times.`,
                        [String(base + pe)]: `You added! Exponents mean repeated multiplication: ${Array(pe).fill(base).join(' √ó ')} = ${pa}`
                    }}; })()
            };
        },
        "Angles and Lines": () => {
            const angle1 = rand(30, 70);
            const complement = 90 - angle1;
            const supplement = 180 - angle1;
            return {
                concept: `<strong>Angles</strong> are formed when two lines or rays meet at a point.<br><br>
                <strong>Types of angles:</strong><br>
                ‚Ä¢ <strong>Acute:</strong> less than 90¬∞ (sharp angle)<br>
                ‚Ä¢ <strong>Right:</strong> exactly 90¬∞ (square corner)<br>
                ‚Ä¢ <strong>Obtuse:</strong> between 90¬∞ and 180¬∞ (wide angle)<br>
                ‚Ä¢ <strong>Straight:</strong> exactly 180¬∞ (a line)<br><br>
                <strong>Special angle pairs:</strong><br>
                ‚Ä¢ <strong>Complementary:</strong> Two angles that add to 90¬∞<br>
                ‚Ä¢ <strong>Supplementary:</strong> Two angles that add to 180¬∞<br>
                ‚Ä¢ <strong>Vertical:</strong> Opposite angles formed by intersecting lines (they're EQUAL!)`,
                example: { problem: `Two angles are supplementary. One is 120¬∞. Find the other.`, steps: [
                    { text: "Recall: supplementary means the angles add to 180¬∞", math: "angle‚ÇÅ + angle‚ÇÇ = 180¬∞" },
                    { text: "Substitute the known angle", math: "120¬∞ + angle‚ÇÇ = 180¬∞" },
                    { text: "Subtract 120¬∞ from both sides", math: "angle‚ÇÇ = 180¬∞ - 120¬∞" },
                    { text: "Calculate", math: "angle‚ÇÇ = <strong>60¬∞</strong>" },
                    { text: "Check: 120¬∞ + 60¬∞ = 180¬∞ ‚úì", math: "" }
                ]},
                keyPoints: [
                    "Complementary = 90¬∞ (think: C for Corner, which is 90¬∞)",
                    "Supplementary = 180¬∞ (think: S for Straight line, which is 180¬∞)",
                    "Vertical angles are always EQUAL to each other"
                ],
                mistakes: [
                    { wrong: "Confusing complementary (90¬∞) and supplementary (180¬∞)", why: "Remember: Complementary ‚Üí Corner (90¬∞), Supplementary ‚Üí Straight (180¬∞)" },
                    { wrong: "Subtracting from the wrong total", why: "Complementary: subtract from 90. Supplementary: subtract from 180." },
                    { wrong: "Thinking a 100¬∞ angle is complementary to something", why: "Complementary angles are each LESS than 90¬∞. 100¬∞ is already bigger than 90¬∞!" }
                ],
                guided: { problem: `Two complementary angles: one is ${angle1}¬∞. Find the other.`, steps: [
                    { label: "Complementary means they add to", value: "90¬∞" },
                    { label: `${angle1}¬∞ + ? = 90¬∞`, value: `? = 90¬∞ - ${angle1}¬∞` },
                    { label: "Calculate", value: "?" }
                ], answer: String(complement), answerLabel: "Other angle:",
                    interactiveSteps: [
                        {
                            prompt: "Complementary angles add up to what total?",
                            hint: "Think: C for Complementary = C for Corner (a right angle)...",
                            answer: "90",
                            acceptableAnswers: ["90", "90¬∞", "90 degrees", "ninety"],
                            commonMistakes: {
                                "180": "That's supplementary! Complementary = 90¬∞ (think: Corner)",
                                "360": "That's a full circle. Complementary angles add to 90¬∞"
                            }
                        },
                        {
                            prompt: `If the two angles add to 90¬∞, and one is ${angle1}¬∞, what equation can we write?`,
                            hint: `${angle1} + ? = 90`,
                            answer: `${angle1} + ? = 90`,
                            acceptableAnswers: [`${angle1} + ? = 90`, `${angle1}¬∞ + ? = 90¬∞`, "90 - " + angle1, `? = 90 - ${angle1}`],
                            commonMistakes: {
                                [`${angle1} + ? = 180`]: "Complementary angles add to 90¬∞, not 180¬∞!"
                            }
                        },
                        {
                            prompt: `To find the missing angle, calculate: 90 - ${angle1} = ?`,
                            hint: `90 minus ${angle1}...`,
                            answer: String(complement),
                            acceptableAnswers: [String(complement), complement + "¬∞"],
                            commonMistakes: {
                                [String(180 - angle1)]: `You subtracted from 180. For complementary, subtract from 90: 90 - ${angle1} = ${complement}`,
                                [String(angle1)]: `You need to subtract! 90 - ${angle1} = ${complement}`
                            }
                        },
                        {
                            prompt: `Check: Does ${angle1}¬∞ + ${complement}¬∞ = 90¬∞?`,
                            hint: "Add them together...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "90", "90¬∞", "correct", "true"],
                            commonMistakes: {
                                "no": `${angle1} + ${complement} = 90 ‚úì It does equal 90¬∞!`
                            }
                        }
                    ]
                },
                practice: { problem: `Find the supplement of ${angle1}¬∞`, answer: String(supplement),
                    options: [String(complement), String(supplement), String(180), String(angle1)],
                    mistakeAnalysis: {
                        [String(complement)]: `That's the COMPLEMENT (adds to 90¬∞). The SUPPLEMENT adds to 180¬∞: 180¬∞ - ${angle1}¬∞ = ${supplement}¬∞`,
                        [String(180)]: "180¬∞ is what supplementary angles add TO, not the missing angle.",
                        [String(angle1)]: `The supplement is 180¬∞ - ${angle1}¬∞ = ${supplement}¬∞, not the same angle.`
                    }}
            };
        },
        "Algebraic Expressions": () => {
            const coef1 = rand(2, 5), coef2 = rand(2, 4);
            const const1 = rand(1, 6), const2 = rand(1, 5);
            const xVal = rand(2, 6);
            return {
                concept: `<strong>Algebraic Expressions</strong> use letters (variables) to represent unknown numbers.<br><br>
                <strong>Key vocabulary:</strong><br>
                ‚Ä¢ <strong>Variable:</strong> A letter representing a number (like x, y, n)<br>
                ‚Ä¢ <strong>Coefficient:</strong> The number in front of a variable (in 3x, the 3 is the coefficient)<br>
                ‚Ä¢ <strong>Constant:</strong> A number without a variable (just a plain number like 5)<br>
                ‚Ä¢ <strong>Like terms:</strong> Terms with the same variable (3x and 5x are like terms)<br><br>
                <strong>Simplifying:</strong> Combine like terms by adding/subtracting their coefficients`,
                example: { problem: `Simplify: 4x + 3 + 2x + 5`, steps: [
                    { text: "Identify like terms", math: "Variable terms: 4x and 2x | Constants: 3 and 5" },
                    { text: "Combine the x terms", math: "4x + 2x = 6x (add coefficients: 4 + 2 = 6)" },
                    { text: "Combine the constants", math: "3 + 5 = 8" },
                    { text: "Write the simplified expression", math: "<strong>6x + 8</strong>" }
                ]},
                keyPoints: [
                    "Like terms have the SAME variable part: 3x + 5x = 8x, but 3x + 5y stays as 3x + 5y",
                    "When simplifying, only combine coefficients - the variable stays the same",
                    "To evaluate: replace the variable with a number and calculate"
                ],
                mistakes: [
                    { wrong: "3x + 5 = 8x", why: "3x and 5 are NOT like terms! 5 has no x. Answer stays: 3x + 5" },
                    { wrong: "3x means 3 + x", why: "3x means 3 TIMES x. If x = 4, then 3x = 3 √ó 4 = 12, not 3 + 4 = 7" },
                    { wrong: "3x + 2x = 5x¬≤", why: "Adding like terms doesn't change the exponent. 3x + 2x = 5x (not 5x¬≤)" }
                ],
                guided: { problem: `Simplify: ${coef1}x + ${const1} + ${coef2}x + ${const2}`, steps: [
                    { label: "Combine x terms", value: `${coef1}x + ${coef2}x = ${coef1 + coef2}x` },
                    { label: "Combine constants", value: `${const1} + ${const2} = ${const1 + const2}` },
                    { label: "Final expression", value: "?" }
                ], answer: `${coef1 + coef2}x + ${const1 + const2}`, answerLabel: "Simplified:",
                    interactiveSteps: [
                        {
                            prompt: `In ${coef1}x + ${const1} + ${coef2}x + ${const2}, which terms have the variable x?`,
                            hint: "Look for terms with 'x' in them...",
                            answer: `${coef1}x and ${coef2}x`,
                            acceptableAnswers: [`${coef1}x and ${coef2}x`, `${coef1}x, ${coef2}x`, `${coef1}x ${coef2}x`],
                            commonMistakes: {
                                [`${const1} and ${const2}`]: "Those are constants (plain numbers). The x terms are ${coef1}x and ${coef2}x."
                            }
                        },
                        {
                            prompt: `Combine the x terms: ${coef1}x + ${coef2}x = ?`,
                            hint: `Add the coefficients: ${coef1} + ${coef2} = ? Then keep the x`,
                            answer: `${coef1 + coef2}x`,
                            acceptableAnswers: [`${coef1 + coef2}x`, String(coef1 + coef2) + "x"],
                            commonMistakes: {
                                [String(coef1 + coef2)]: `Don't forget the x! ${coef1}x + ${coef2}x = ${coef1 + coef2}x`,
                                [`${coef1 + coef2}x¬≤`]: "When adding like terms, the exponent stays the same: ${coef1 + coef2}x, not x¬≤"
                            }
                        },
                        {
                            prompt: `Now combine the constants (numbers without x): ${const1} + ${const2} = ?`,
                            hint: "Just add the plain numbers...",
                            answer: String(const1 + const2),
                            acceptableAnswers: [String(const1 + const2)],
                            commonMistakes: {
                                [`${const1 + const2}x`]: "Constants don't have x! Just ${const1} + ${const2} = ${const1 + const2}"
                            }
                        },
                        {
                            prompt: `Write the simplified expression: ${coef1 + coef2}x + ?`,
                            hint: `We found the x terms combine to ${coef1 + coef2}x and constants to ${const1 + const2}`,
                            answer: `${coef1 + coef2}x + ${const1 + const2}`,
                            acceptableAnswers: [`${coef1 + coef2}x + ${const1 + const2}`, `${coef1 + coef2}x+${const1 + const2}`],
                            commonMistakes: {
                                [`${coef1 + coef2 + const1 + const2}x`]: "You can't combine x terms with constants! Keep them separate: ${coef1 + coef2}x + ${const1 + const2}"
                            }
                        }
                    ]
                },
                practice: (() => { const expr = coef1 + 1; return {
                    problem: `Evaluate ${expr}x + ${const1} when x = ${xVal}`, answer: String(expr * xVal + const1),
                    options: shuffle([String(expr * xVal + const1), String(expr + xVal + const1), String(expr * xVal), String(expr + const1)]),
                    mistakeAnalysis: {
                        [String(expr + xVal + const1)]: `${expr}x means ${expr} TIMES x. So ${expr} √ó ${xVal} + ${const1} = ${expr * xVal} + ${const1} = ${expr * xVal + const1}`,
                        [String(expr * xVal)]: `You forgot to add the constant! ${expr} √ó ${xVal} = ${expr * xVal}, then add ${const1} to get ${expr * xVal + const1}`,
                        [String(expr + const1)]: `You didn't substitute x = ${xVal}. Replace x with ${xVal}: ${expr} √ó ${xVal} + ${const1} = ${expr * xVal + const1}`
                    }}; })()
            };
        },
        "Order of Operations": () => {
            const a = rand(2, 5), b = rand(3, 6), c = rand(1, 4);
            return {
                concept: `<strong>Order of Operations</strong> tells us which operations to do first.<br><br>
                <strong>PEMDAS (Please Excuse My Dear Aunt Sally):</strong><br>
                1. <strong>P</strong>arentheses - Do what's inside first<br>
                2. <strong>E</strong>xponents - Powers next<br>
                3. <strong>M</strong>ultiplication & <strong>D</strong>ivision - Left to right<br>
                4. <strong>A</strong>ddition & <strong>S</strong>ubtraction - Left to right<br><br>
                <strong>Important:</strong> Multiplication/Division are done together (left to right), same for Addition/Subtraction`,
                example: { problem: `Evaluate: 3 + 4 √ó 2`, steps: [
                    { text: "Check for parentheses", math: "None" },
                    { text: "Check for exponents", math: "None" },
                    { text: "Do multiplication BEFORE addition", math: "4 √ó 2 = 8" },
                    { text: "Then add", math: "3 + 8 = <strong>11</strong>" },
                    { text: "NOT: 3 + 4 = 7, then 7 √ó 2 = 14", math: "(That's wrong!)" }
                ]},
                keyPoints: [
                    "Multiplication and division come BEFORE addition and subtraction",
                    "When you have √ó and √∑ together, go left to right",
                    "Parentheses first, always!"
                ],
                mistakes: [
                    { wrong: "3 + 4 √ó 2 = 14 (adding first)", why: "Multiplication comes before addition! Do 4 √ó 2 = 8 first, then 3 + 8 = 11" },
                    { wrong: "10 - 3 + 2 = 5 (doing subtraction first always)", why: "Addition and subtraction: go LEFT to RIGHT. 10 - 3 = 7, then 7 + 2 = 9" }
                ],
                guided: { problem: `Evaluate: ${a} + ${b} √ó ${c}`, steps: [
                    { label: "Which operation first?", value: "Multiplication (PEMDAS)" },
                    { label: `${b} √ó ${c} =`, value: `${b * c}` },
                    { label: `Then: ${a} + ${b * c} =`, value: "?" }
                ], answer: String(a + b * c), answerLabel: "Answer:",
                    interactiveSteps: [
                        {
                            prompt: `In ${a} + ${b} √ó ${c}, we have addition and multiplication. Which do we do FIRST according to PEMDAS?`,
                            hint: "PEMDAS: Parentheses, Exponents, Multiplication/Division, Addition/Subtraction",
                            answer: "multiplication",
                            acceptableAnswers: ["multiplication", "multiply", "√ó", "the multiplication", `${b} √ó ${c}`],
                            commonMistakes: {
                                "addition": "Multiplication comes BEFORE addition in PEMDAS! Do ${b} √ó ${c} first."
                            }
                        },
                        {
                            prompt: `Do the multiplication first: ${b} √ó ${c} = ?`,
                            hint: `${b} times ${c}...`,
                            answer: String(b * c),
                            acceptableAnswers: [String(b * c)],
                            commonMistakes: {
                                [String(b + c)]: `That's ${b} + ${c}. We need ${b} √ó ${c} = ${b * c}`,
                                [String(a + b)]: `Do ${b} √ó ${c} first, not add ${a}. ${b} √ó ${c} = ${b * c}`
                            }
                        },
                        {
                            prompt: `Now we have: ${a} + ${b * c}. Calculate this:`,
                            hint: `${a} + ${b * c} = ?`,
                            answer: String(a + b * c),
                            acceptableAnswers: [String(a + b * c)],
                            commonMistakes: {
                                [String((a + b) * c)]: `That's (${a}+${b})√ó${c}. We already did the multiplication: ${a} + ${b * c} = ${a + b * c}`
                            }
                        },
                        {
                            prompt: `So ${a} + ${b} √ó ${c} = ?`,
                            hint: `Multiplication first (${b * c}), then add ${a}`,
                            answer: String(a + b * c),
                            acceptableAnswers: [String(a + b * c)],
                            commonMistakes: {
                                [String((a + b) * c)]: `Remember PEMDAS: multiply first! ${b} √ó ${c} = ${b * c}, then ${a} + ${b * c} = ${a + b * c}`
                            }
                        }
                    ]
                },
                practice: { problem: `Evaluate: 8 √∑ 2 + 3 √ó 4`, answer: "16",
                    options: ["16", "20", "7", "28"],
                    mistakeAnalysis: {
                        "20": "Check order: 8√∑2=4, 3√ó4=12, then 4+12=16. Did you do 8√∑(2+3)√ó4?",
                        "7": "Do √ó and √∑ first (left to right), then add: 8√∑2=4, 3√ó4=12, 4+12=16",
                        "28": "Division and multiplication go left to right BEFORE adding: 4+12=16, not 8√∑2√ó14"
                    }}
            };
        },
        Slope: () => {
            const rise = rand(1, 4), run = rand(2, 5);
            return {
                concept: `<strong>Slope</strong> measures how steep a line is - how much it rises or falls as you move right.<br><br>
                <strong>The formula:</strong><br>
                slope = rise/run = (change in y)/(change in x) = (y‚ÇÇ - y‚ÇÅ)/(x‚ÇÇ - x‚ÇÅ)<br><br>
                <strong>Types of slope:</strong><br>
                ‚Ä¢ <strong>Positive slope:</strong> Line goes UP as you move right ‚Üó<br>
                ‚Ä¢ <strong>Negative slope:</strong> Line goes DOWN as you move right ‚Üò<br>
                ‚Ä¢ <strong>Zero slope:</strong> Horizontal line (flat) ‚Üí<br>
                ‚Ä¢ <strong>Undefined slope:</strong> Vertical line (straight up) ‚Üë`,
                example: { problem: `Find the slope of the line through (1, 2) and (4, 8)`, steps: [
                    { text: "Identify the points", math: "(x‚ÇÅ, y‚ÇÅ) = (1, 2) and (x‚ÇÇ, y‚ÇÇ) = (4, 8)" },
                    { text: "Find the rise (change in y)", math: "rise = y‚ÇÇ - y‚ÇÅ = 8 - 2 = 6" },
                    { text: "Find the run (change in x)", math: "run = x‚ÇÇ - x‚ÇÅ = 4 - 1 = 3" },
                    { text: "Calculate slope = rise/run", math: "slope = 6/3 = <strong>2</strong>" },
                    { text: "Interpret: For every 1 unit right, the line goes up 2 units", math: "" }
                ]},
                keyPoints: [
                    "Slope = rise/run = vertical change / horizontal change",
                    "Positive slope: line goes up; Negative slope: line goes down",
                    "Slope of 2 means 'for every 1 right, go up 2'"
                ],
                mistakes: [
                    { wrong: "Putting run over rise (run/rise)", why: "Remember: RISE over RUN. The y-change (vertical) goes on TOP." },
                    { wrong: "Subtracting in different orders: (y‚ÇÇ-y‚ÇÅ)/(x‚ÇÅ-x‚ÇÇ)", why: "Use the SAME order: (y‚ÇÇ-y‚ÇÅ)/(x‚ÇÇ-x‚ÇÅ) OR (y‚ÇÅ-y‚ÇÇ)/(x‚ÇÅ-x‚ÇÇ)" },
                    { wrong: "Confusing which is rise and which is run", why: "Rise = up/down (y-values). Run = left/right (x-values)." }
                ],
                guided: { problem: `Find the slope of the line through (2, 3) and (${2 + run}, ${3 + rise})`, steps: [
                    { label: "Rise (change in y)", value: `${3 + rise} - 3 = ${rise}` },
                    { label: "Run (change in x)", value: `${2 + run} - 2 = ${run}` },
                    { label: "Slope = rise/run", value: "?" }
                ], answer: `${rise}/${run}`, answerLabel: "Slope:",
                    interactiveSteps: [
                        {
                            prompt: "Slope is calculated as rise over run. Which values give us the RISE (change in y)?",
                            hint: "Rise = vertical change = y-values (the second number in each point)",
                            answer: "y values",
                            acceptableAnswers: ["y values", "y", "the y values", "y-values", "3 and " + (3 + rise), (3 + rise) + " and 3"],
                            commonMistakes: {
                                "x values": "X-values give us the RUN (horizontal). Y-values give us the RISE (vertical)."
                            }
                        },
                        {
                            prompt: `Find the rise: y‚ÇÇ - y‚ÇÅ = ${3 + rise} - 3 = ?`,
                            hint: `${3 + rise} minus 3...`,
                            answer: String(rise),
                            acceptableAnswers: [String(rise)],
                            commonMistakes: {
                                [String(3 + rise)]: `You need to subtract! ${3 + rise} - 3 = ${rise}`,
                                [String(3 - (3 + rise))]: `Subtract in the right order: y‚ÇÇ - y‚ÇÅ = ${3 + rise} - 3 = ${rise}`
                            }
                        },
                        {
                            prompt: `Now find the run: x‚ÇÇ - x‚ÇÅ = ${2 + run} - 2 = ?`,
                            hint: `${2 + run} minus 2...`,
                            answer: String(run),
                            acceptableAnswers: [String(run)],
                            commonMistakes: {
                                [String(2 + run)]: `You need to subtract! ${2 + run} - 2 = ${run}`
                            }
                        },
                        {
                            prompt: `Slope = rise/run. With rise = ${rise} and run = ${run}, what is the slope?`,
                            hint: `Put rise over run: ${rise}/${run}`,
                            answer: `${rise}/${run}`,
                            acceptableAnswers: [`${rise}/${run}`, `${rise} / ${run}`, Number.isInteger(rise/run) ? String(rise/run) : `${rise}/${run}`],
                            commonMistakes: {
                                [`${run}/${rise}`]: `You put run over rise! Remember: RISE over RUN. The slope is ${rise}/${run}`
                            }
                        }
                    ]
                },
                practice: { problem: `Find the slope through (0, 0) and (4, 12)`, answer: "3",
                    options: ["1/3", "3", "4", "12"],
                    mistakeAnalysis: {
                        "1/3": "You put run over rise. Slope = rise/run = 12/4 = 3",
                        "4": "That's the x-coordinate. Slope = rise/run = (12-0)/(4-0) = 12/4 = 3",
                        "12": "That's the rise. Divide by the run: 12/4 = 3"
                    }}
            };
        },
        Pythagorean: () => {
            const a = rand(3, 5), b = rand(4, 8);
            const c = Math.sqrt(a * a + b * b);
            const cRounded = Math.round(c * 10) / 10;
            return {
                concept: `<strong>The Pythagorean Theorem</strong> applies to RIGHT triangles (triangles with a 90¬∞ angle).<br><br>
                <strong>The formula:</strong> a¬≤ + b¬≤ = c¬≤<br><br>
                Where:<br>
                ‚Ä¢ <strong>a</strong> and <strong>b</strong> are the two shorter sides (legs)<br>
                ‚Ä¢ <strong>c</strong> is the longest side (hypotenuse) - ALWAYS opposite the right angle<br><br>
                <strong>Common Pythagorean triples (memorize these!):</strong><br>
                ‚Ä¢ 3, 4, 5<br>
                ‚Ä¢ 5, 12, 13<br>
                ‚Ä¢ 8, 15, 17`,
                example: { problem: `A right triangle has legs of 3 and 4. Find the hypotenuse.`, steps: [
                    { text: "Write the Pythagorean theorem", math: "a¬≤ + b¬≤ = c¬≤" },
                    { text: "Substitute the known values", math: "3¬≤ + 4¬≤ = c¬≤" },
                    { text: "Calculate the squares", math: "9 + 16 = c¬≤" },
                    { text: "Add", math: "25 = c¬≤" },
                    { text: "Take the square root", math: "c = ‚àö25 = <strong>5</strong>" }
                ]},
                keyPoints: [
                    "a¬≤ + b¬≤ = c¬≤ where c is the LONGEST side (hypotenuse)",
                    "Only works for RIGHT triangles (with a 90¬∞ angle)",
                    "Common triples: 3-4-5, 5-12-13, 8-15-17"
                ],
                mistakes: [
                    { wrong: "Adding sides instead of squaring: 3 + 4 = 7", why: "You must SQUARE each leg first: 3¬≤ + 4¬≤ = 9 + 16 = 25, then ‚àö25 = 5" },
                    { wrong: "Putting the hypotenuse on the left: c¬≤ + a¬≤ = b¬≤", why: "The hypotenuse (c) MUST be alone on one side: a¬≤ + b¬≤ = c¬≤" },
                    { wrong: "Forgetting to take the square root at the end", why: "c¬≤ = 25 means c = ‚àö25 = 5, not c = 25" }
                ],
                guided: { problem: `A right triangle has legs ${a} and ${b}. Find the hypotenuse.`, steps: [
                    { label: "a¬≤ + b¬≤ = c¬≤", value: `${a}¬≤ + ${b}¬≤ = c¬≤` },
                    { label: "Calculate squares", value: `${a*a} + ${b*b} = ${a*a + b*b}` },
                    { label: "c = ‚àö${a*a + b*b} =", value: "?" }
                ], answer: Number.isInteger(c) ? String(c) : String(cRounded), answerLabel: "Hypotenuse:",
                    interactiveSteps: [
                        {
                            prompt: "What is the Pythagorean theorem formula?",
                            hint: "The squares of the two legs equal the square of the hypotenuse...",
                            answer: "a¬≤ + b¬≤ = c¬≤",
                            acceptableAnswers: ["a¬≤ + b¬≤ = c¬≤", "a^2 + b^2 = c^2", "a2 + b2 = c2"],
                            commonMistakes: {
                                "a + b = c": "You need to SQUARE each side! a¬≤ + b¬≤ = c¬≤",
                                "a √ó b = c": "Multiply? No, it's the SUM of the SQUARES: a¬≤ + b¬≤ = c¬≤"
                            }
                        },
                        {
                            prompt: `Calculate ${a}¬≤ (${a} squared):`,
                            hint: `${a} √ó ${a} = ?`,
                            answer: String(a * a),
                            acceptableAnswers: [String(a * a)],
                            commonMistakes: {
                                [String(a * 2)]: `That's ${a} √ó 2. Squaring means ${a} √ó ${a} = ${a * a}`,
                                [String(a)]: `You need to square it! ${a}¬≤ = ${a} √ó ${a} = ${a * a}`
                            }
                        },
                        {
                            prompt: `Calculate ${b}¬≤ (${b} squared):`,
                            hint: `${b} √ó ${b} = ?`,
                            answer: String(b * b),
                            acceptableAnswers: [String(b * b)],
                            commonMistakes: {
                                [String(b * 2)]: `That's ${b} √ó 2. Squaring means ${b} √ó ${b} = ${b * b}`
                            }
                        },
                        {
                            prompt: `Add the squares: ${a * a} + ${b * b} = ?`,
                            hint: `This gives us c¬≤...`,
                            answer: String(a * a + b * b),
                            acceptableAnswers: [String(a * a + b * b)],
                            commonMistakes: {
                                [String(a * a * b * b)]: `Add, don't multiply! ${a * a} + ${b * b} = ${a * a + b * b}`
                            }
                        },
                        {
                            prompt: `c¬≤ = ${a * a + b * b}. To find c, take the square root: ‚àö${a * a + b * b} = ?`,
                            hint: `What number times itself equals ${a * a + b * b}?`,
                            answer: Number.isInteger(c) ? String(c) : String(cRounded),
                            acceptableAnswers: Number.isInteger(c) ? [String(c)] : [String(cRounded), String(Math.round(c)), c.toFixed(1), c.toFixed(2)],
                            commonMistakes: {
                                [String(a * a + b * b)]: `That's c¬≤. You need to take the square root to find c. ‚àö${a * a + b * b} ‚âà ${cRounded}`
                            }
                        }
                    ]
                },
                practice: { problem: `A right triangle has legs 6 and 8. Find the hypotenuse.`, answer: "10",
                    options: ["10", "14", "48", "100"],
                    mistakeAnalysis: {
                        "14": "You added 6 + 8 = 14. You must square first: 6¬≤ + 8¬≤ = 36 + 64 = 100, then ‚àö100 = 10",
                        "48": "That's 6 √ó 8. Use a¬≤ + b¬≤ = c¬≤: 36 + 64 = 100, c = ‚àö100 = 10",
                        "100": "That's c¬≤. Take the square root: ‚àö100 = 10"
                    }}
            };
        }
    },
    5: {
        "Linear Equations": () => {
            const x = rand(2, 8), a = rand(2, 5), b = rand(3, 12);
            const c = a * x + b;
            return {
                goalProblem: `Solve: 3x + 7 = 22`,
                teachingSteps: [
                    {
                        title: "This is a two-step equation",
                        explanation: "Two-step equations require <strong>two operations</strong> to isolate x. We need to undo what's being done to x, one step at a time.",
                        visual: "3x + 7 = 22 ‚Üí need 2 steps to find x"
                    },
                    {
                        title: "Identify operations on x",
                        explanation: "Look at the left side: x is being <strong>multiplied by 3</strong>, then <strong>7 is added</strong>. We'll undo these in reverse order.",
                        visual: "x ‚Üí √ó3 ‚Üí +7 ‚Üí result"
                    },
                    {
                        title: "Step 1: Undo the addition first",
                        explanation: "The outer operation is +7. Undo it by <strong>subtracting 7</strong> from both sides: 3x + 7 - 7 = 22 - 7",
                        visual: "3x + 7 - 7 = 22 - 7 ‚Üí 3x = 15"
                    },
                    {
                        title: "Step 2: Undo the multiplication",
                        explanation: "Now we have 3x = 15. Undo the √ó3 by <strong>dividing both sides by 3</strong>: 3x √∑ 3 = 15 √∑ 3",
                        visual: "3x √∑ 3 = 15 √∑ 3 ‚Üí x = 5"
                    },
                    {
                        title: "Check your answer!",
                        explanation: "Substitute x = 5 back into the original: 3(5) + 7 = 15 + 7 = 22 ‚úì It works!",
                        visual: "x = 5"
                    }
                ],
                finalAnswer: "x = 5",
                answerExplanation: "First subtract 7 from both sides (3x = 15), then divide by 3 (x = 5). Always check: 3(5) + 7 = 22 ‚úì",
                example: { problem: `Solve: 3x + 7 = 22`, steps: [
                    { text: "Identify operations on x", math: "x is multiplied by 3, then 7 is added" },
                    { text: "Step 1: Undo addition (subtract 7 from both sides)", math: "3x + 7 - 7 = 22 - 7" },
                    { text: "Simplify", math: "3x = 15" },
                    { text: "Step 2: Undo multiplication (divide both sides by 3)", math: "3x √∑ 3 = 15 √∑ 3" },
                    { text: "Simplify", math: "x = <strong>5</strong>" },
                    { text: "Check: 3(5) + 7 = 15 + 7 = 22 ‚úì", math: "" }
                ]},
                keyPoints: [
                    "Undo addition/subtraction FIRST, then multiplication/division",
                    "Whatever you do to one side, you MUST do to the other",
                    "Always check your answer by substituting it back into the original equation"
                ],
                mistakes: [
                    { wrong: "Dividing before subtracting: 3x + 7 = 22 ‚Üí x + 7 = 22/3", why: "You must undo the outer operation first. Subtract 7, THEN divide by 3." },
                    { wrong: "Only operating on part of a side: 3x + 7 = 22 ‚Üí 3x = 22 - 7 but forgetting to simplify", why: "Always simplify: 22 - 7 = 15, so 3x = 15" },
                    { wrong: "Dividing only one term: 3x + 7 = 22 ‚Üí x + 7 = 22/3", why: "When dividing, EVERY term on the left would need to be divided. That's why we subtract first!" }
                ],
                guided: { problem: `Solve: ${a}x + ${b} = ${c}`, steps: [
                    { label: `Step 1: Subtract ${b} from both sides`, value: `${a}x = ${c} - ${b} = ${c - b}` },
                    { label: `Step 2: Divide both sides by ${a}`, value: `x = ${c - b} √∑ ${a} = ?` },
                    { label: "Check your answer", value: `${a}(?) + ${b} should equal ${c}` }
                ], answer: String(x), answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}x + ${b} = ${c}, we need to isolate x. What should we undo FIRST - the multiplication or the addition?`,
                            hint: "Think about order of operations in reverse. Undo the OUTER operation first.",
                            answer: "addition",
                            acceptableAnswers: ["addition", "add", "the addition", "+ " + b, "adding"],
                            commonMistakes: {
                                "multiplication": "Undo operations in REVERSE order. Addition was done last, so undo it first by subtracting."
                            }
                        },
                        {
                            prompt: `Subtract ${b} from both sides. What is ${c} - ${b}?`,
                            hint: `${c} minus ${b}...`,
                            answer: String(c - b),
                            acceptableAnswers: [String(c - b)],
                            commonMistakes: {
                                [String(c + b)]: `Subtract, not add! ${c} - ${b} = ${c - b}`,
                                [String(c)]: `You need to subtract ${b}: ${c} - ${b} = ${c - b}`
                            }
                        },
                        {
                            prompt: `Now we have ${a}x = ${c - b}. To get x alone, we need to undo the multiplication. Divide both sides by what?`,
                            hint: `x is being multiplied by ${a}...`,
                            answer: String(a),
                            acceptableAnswers: [String(a), "by " + a],
                            commonMistakes: {
                                [String(c - b)]: `We divide by the coefficient of x, which is ${a}`,
                                [String(x)]: `We don't know x yet! Divide by ${a} to find it.`
                            }
                        },
                        {
                            prompt: `Calculate: ${c - b} √∑ ${a} = ?`,
                            hint: `${c - b} divided by ${a}...`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String((c - b) * a)]: `Divide, not multiply! ${c - b} √∑ ${a} = ${x}`,
                                [String(c - b)]: `You still need to divide: ${c - b} √∑ ${a} = ${x}`
                            }
                        },
                        {
                            prompt: `Check: Does ${a}(${x}) + ${b} = ${c}?`,
                            hint: `Calculate ${a} √ó ${x} + ${b}...`,
                            answer: "yes",
                            acceptableAnswers: ["yes", String(c), "correct", "true"],
                            commonMistakes: {
                                "no": `${a} √ó ${x} = ${a * x}, then ${a * x} + ${b} = ${c} ‚úì It works!`
                            }
                        }
                    ]
                },
                practice: (() => { const newB = b + 3; const newC = a * x + newB; return {
                    problem: `Solve: ${a}x + ${newB} = ${newC}`, answer: String(x),
                    options: shuffle([String(x), String(Math.floor(newC / a)), String(newC), String(newC - newB)]),
                    mistakeAnalysis: {
                        [String(Math.floor(newC / a))]: `You divided ${newC} by ${a} without subtracting ${newB} first. Do: ${newC} - ${newB} = ${newC - newB}, then ${newC - newB} √∑ ${a} = ${x}`,
                        [String(newC)]: `That's the right side of the equation, not x. First subtract ${newB}, then divide by ${a}.`,
                        [String(newC - newB)]: `That's ${a}x, not x. You need to divide by ${a}: ${newC - newB} √∑ ${a} = ${x}`
                    }}; })()
            };
        },
        Factoring: () => {
            const r1 = rand(1, 5), r2 = rand(1, 5);
            const sum = r1 + r2, prod = r1 * r2;
            return {
                goalProblem: `Factor: x¬≤ + 7x + 12`,
                teachingSteps: [
                    {
                        title: "What is factoring?",
                        explanation: "<strong>Factoring</strong> means writing an expression as a product of simpler expressions. We're going 'backwards' from multiplying.",
                        visual: "x¬≤ + 7x + 12 = (? + ?)(? + ?)"
                    },
                    {
                        title: "Identify the key numbers",
                        explanation: "In x¬≤ + 7x + 12: <strong>b = 7</strong> (coefficient of x) and <strong>c = 12</strong> (constant term). We need two numbers that work with these.",
                        visual: "b = 7, c = 12"
                    },
                    {
                        title: "The magic conditions",
                        explanation: "We need two numbers p and q where: p √ó q = c (multiply to 12) AND p + q = b (add to 7). Both conditions must be true!",
                        visual: "p √ó q = 12 AND p + q = 7"
                    },
                    {
                        title: "Find the factor pair",
                        explanation: "List pairs that multiply to 12: 1√ó12, 2√ó6, 3√ó4. Which adds to 7? 1+12=13‚úó, 2+6=8‚úó, <strong>3+4=7‚úì</strong>",
                        visual: "3 √ó 4 = 12 ‚úì AND 3 + 4 = 7 ‚úì"
                    },
                    {
                        title: "Write the answer and check",
                        explanation: "Use p=3 and q=4: <strong>(x + 3)(x + 4)</strong>. Check with FOIL: x¬≤ + 4x + 3x + 12 = x¬≤ + 7x + 12 ‚úì",
                        visual: "(x + 3)(x + 4)"
                    }
                ],
                finalAnswer: "(x + 3)(x + 4)",
                answerExplanation: "We found 3 and 4 because 3√ó4=12 and 3+4=7. Always verify by FOILing!",
                example: { problem: `Factor: x¬≤ + 7x + 12`, steps: [
                    { text: "Identify b and c", math: "b = 7 (coefficient of x), c = 12 (constant)" },
                    { text: "List factor pairs of 12", math: "1√ó12, 2√ó6, 3√ó4" },
                    { text: "Find the pair that adds to 7", math: "1+12=13‚úó, 2+6=8‚úó, 3+4=7‚úì" },
                    { text: "Write the factors", math: "<strong>(x + 3)(x + 4)</strong>" },
                    { text: "Check by FOIL", math: "x¬≤ + 4x + 3x + 12 = x¬≤ + 7x + 12 ‚úì" }
                ]},
                keyPoints: [
                    "Two numbers must MULTIPLY to c AND ADD to b",
                    "FOIL = First, Outer, Inner, Last (for checking)",
                    "If the signs in the trinomial are both positive, both factors are positive"
                ],
                mistakes: [
                    { wrong: "Only checking multiplication: using 1 and 12 because 1√ó12=12", why: "1+12=13, not 7. Both conditions must be satisfied!" },
                    { wrong: "Writing (x + 7)(x + 12)", why: "7+12=19 and 7√ó12=84, neither matches. We need numbers that add to 7 AND multiply to 12." },
                    { wrong: "Forgetting to check with FOIL", why: "Always FOIL your answer to verify: (x+3)(x+4) = x¬≤ + 4x + 3x + 12 = x¬≤ + 7x + 12 ‚úì" }
                ],
                guided: { problem: `Factor: x¬≤ + ${sum}x + ${prod}`, steps: [
                    { label: "Need two numbers that multiply to", value: `${prod}` },
                    { label: "And add to", value: `${sum}` },
                    { label: `Factor pairs of ${prod}:`, value: `Think: what √ó what = ${prod} AND + = ${sum}?` },
                    { label: `${r1} √ó ${r2} = ${prod} and ${r1} + ${r2} = ${sum} ‚úì`, value: "So the factors are..." }
                ], answer: `(x+${r1})(x+${r2})`, answerLabel: "Factored form:",
                    interactiveSteps: [
                        {
                            prompt: `In x¬≤ + ${sum}x + ${prod}, the constant term is ${prod}. We need two numbers that MULTIPLY to what?`,
                            hint: "The constant term is the number at the end...",
                            answer: String(prod),
                            acceptableAnswers: [String(prod)],
                            commonMistakes: {
                                [String(sum)]: `${sum} is the coefficient of x (what we ADD to). We multiply to ${prod}.`
                            }
                        },
                        {
                            prompt: `The coefficient of x is ${sum}. We need two numbers that ADD to what?`,
                            hint: "The number in front of x...",
                            answer: String(sum),
                            acceptableAnswers: [String(sum)],
                            commonMistakes: {
                                [String(prod)]: `${prod} is what we multiply to. We add to ${sum}.`
                            }
                        },
                        {
                            prompt: `Find two numbers: ___ √ó ___ = ${prod} AND ___ + ___ = ${sum}. What are the two numbers?`,
                            hint: `Think of factor pairs of ${prod}: what two numbers multiply to ${prod}?`,
                            answer: `${r1} and ${r2}`,
                            acceptableAnswers: [`${r1} and ${r2}`, `${r2} and ${r1}`, `${r1}, ${r2}`, `${r2}, ${r1}`, `${r1} ${r2}`],
                            commonMistakes: {
                                [`1 and ${prod}`]: `1 √ó ${prod} = ${prod} ‚úì, but 1 + ${prod} = ${1 + prod}, not ${sum}. Try ${r1} and ${r2}.`,
                                [String(sum)]: `That's one number. We need TWO numbers: ${r1} and ${r2} (multiply to ${prod}, add to ${sum})`
                            }
                        },
                        {
                            prompt: `Verify: ${r1} √ó ${r2} = ? and ${r1} + ${r2} = ?`,
                            hint: "Check both conditions...",
                            answer: `${prod} and ${sum}`,
                            acceptableAnswers: [`${prod} and ${sum}`, `${prod}, ${sum}`, "yes", "correct"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Write the factored form using ${r1} and ${r2}: (x + ___)(x + ___)`,
                            hint: "Put each number in a factor...",
                            answer: `(x+${r1})(x+${r2})`,
                            acceptableAnswers: [`(x+${r1})(x+${r2})`, `(x+${r2})(x+${r1})`, `(x + ${r1})(x + ${r2})`, `(x + ${r2})(x + ${r1})`],
                            commonMistakes: {
                                [`(x+${sum})(x+${prod})`]: `Use the two numbers we found (${r1} and ${r2}), not the sum and product!`
                            }
                        }
                    ]
                },
                practice: (() => { const nr1 = r1 + 1, nr2 = r2 + 1; const nsum = nr1 + nr2; const nprod = nr1 * nr2; return {
                    problem: `Factor: x¬≤ + ${nsum}x + ${nprod}`, answer: `(x+${nr1})(x+${nr2})`,
                    options: [`(x+${nr1})(x+${nr2})`, `(x+1)(x+${nprod})`, `(x+${nsum})(x+1)`, `(x+${nr1})(x+${nr1})`],
                    mistakeAnalysis: {
                        [`(x+1)(x+${nprod})`]: `1 √ó ${nprod} = ${nprod} ‚úì, but 1 + ${nprod} = ${1+nprod}, not ${nsum}. Need ${nr1} + ${nr2} = ${nsum}.`,
                        [`(x+${nsum})(x+1)`]: `These add to ${nsum+1}, not ${nsum}. Also ${nsum} √ó 1 = ${nsum}, not ${nprod}.`,
                        [`(x+${nr1})(x+${nr1})`]: `${nr1} √ó ${nr1} = ${nr1*nr1}, not ${nprod}. You need two DIFFERENT numbers: ${nr1} and ${nr2}.`
                    }}; })()
            };
        },
        Systems: () => {
            const x = rand(1, 5), y = rand(1, 5);
            const a1 = 1, b1 = 1, c1 = x + y;
            const a2 = 1, b2 = -1, c2 = x - y;
            return {
                goalProblem: `Solve: x + y = 7 and x - y = 3`,
                teachingSteps: [
                    {
                        title: "What is a system of equations?",
                        explanation: "A <strong>system</strong> is two or more equations that must both be true at the same time. We find values that work in ALL equations.",
                        visual: "x + y = 7 AND x - y = 3"
                    },
                    {
                        title: "Choose a method: Elimination",
                        explanation: "Notice one equation has +y and the other has -y. If we <strong>add</strong> the equations, the y terms will cancel out!",
                        visual: "+y + (-y) = 0 (they cancel!)"
                    },
                    {
                        title: "Add the equations together",
                        explanation: "Add left sides: (x + y) + (x - y) = 2x. Add right sides: 7 + 3 = 10. We get: 2x = 10",
                        visual: "(x + y) + (x - y) = 7 + 3 ‚Üí 2x = 10"
                    },
                    {
                        title: "Solve for x",
                        explanation: "From 2x = 10, divide both sides by 2: <strong>x = 5</strong>. We found x! Now we need y.",
                        visual: "x = 5"
                    },
                    {
                        title: "Find y and check both equations",
                        explanation: "Substitute x=5 into equation 1: 5 + y = 7, so y = 2. Check: 5+2=7‚úì and 5-2=3‚úì Both work!",
                        visual: "Solution: (5, 2)"
                    }
                ],
                finalAnswer: "x = 5, y = 2 or (5, 2)",
                answerExplanation: "By adding the equations, y cancelled. We found x=5, then substituted to find y=2. Always check in BOTH equations!",
                example: { problem: `Solve: x + y = 7 and x - y = 3`, steps: [
                    { text: "Use elimination: add the equations", math: "(x + y) + (x - y) = 7 + 3" },
                    { text: "The y terms cancel", math: "2x = 10" },
                    { text: "Solve for x", math: "x = 5" },
                    { text: "Substitute x = 5 into first equation", math: "5 + y = 7" },
                    { text: "Solve for y", math: "y = 2" },
                    { text: "Solution: (5, 2). Check in both equations:", math: "5+2=7‚úì, 5-2=3‚úì" }
                ]},
                keyPoints: [
                    "The solution must satisfy BOTH equations",
                    "Elimination works great when coefficients are opposites (+y and -y)",
                    "Always check your answer in both original equations"
                ],
                mistakes: [
                    { wrong: "Only checking the solution in one equation", why: "The solution must work in BOTH equations!" },
                    { wrong: "Adding when you should subtract (or vice versa)", why: "Look at the signs. +y and -y: ADD to eliminate. +y and +y: SUBTRACT to eliminate." },
                    { wrong: "Forgetting to find the second variable", why: "A system has TWO variables. Once you find x, substitute to find y." }
                ],
                guided: { problem: `Solve: x + y = ${c1} and x - y = ${c2}`, steps: [
                    { label: "Add the equations to eliminate y", value: `(x + y) + (x - y) = ${c1} + ${c2}` },
                    { label: "Simplify", value: `2x = ${c1 + c2}` },
                    { label: "Solve for x", value: `x = ${x}` },
                    { label: "Find y using x + y = " + c1, value: "y = ?" }
                ], answer: String(y), answerLabel: "y = ?",
                    interactiveSteps: [
                        {
                            prompt: "We have +y in the first equation and -y in the second. To eliminate y, should we ADD or SUBTRACT the equations?",
                            hint: "+y + (-y) = 0... what operation makes them cancel?",
                            answer: "add",
                            acceptableAnswers: ["add", "addition", "adding"],
                            commonMistakes: {
                                "subtract": "If we subtract, we'd get y - (-y) = 2y. Adding gives +y + (-y) = 0, which eliminates y!"
                            }
                        },
                        {
                            prompt: `Add the left sides: (x + y) + (x - y) = ?`,
                            hint: "The y terms cancel. What's left?",
                            answer: "2x",
                            acceptableAnswers: ["2x", "x + x"],
                            commonMistakes: {
                                "2x + 2y": "The +y and -y cancel! (x + y) + (x - y) = x + x = 2x",
                                "0": "x + x = 2x. Only the y terms cancel."
                            }
                        },
                        {
                            prompt: `Add the right sides: ${c1} + ${c2} = ?`,
                            hint: `${c1} plus ${c2}...`,
                            answer: String(c1 + c2),
                            acceptableAnswers: [String(c1 + c2)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `So we have 2x = ${c1 + c2}. Solve for x:`,
                            hint: `Divide both sides by 2...`,
                            answer: String(x),
                            acceptableAnswers: [String(x), "x = " + x],
                            commonMistakes: {
                                [String(c1 + c2)]: `That's 2x. Divide by 2: ${c1 + c2} √∑ 2 = ${x}`,
                                [String(2 * (c1 + c2))]: `Divide, not multiply! ${c1 + c2} √∑ 2 = ${x}`
                            }
                        },
                        {
                            prompt: `Now substitute x = ${x} into x + y = ${c1}. What is ${x} + y = ${c1}, solved for y?`,
                            hint: `${c1} - ${x} = ?`,
                            answer: String(y),
                            acceptableAnswers: [String(y), "y = " + y],
                            commonMistakes: {
                                [String(c1)]: `You need to solve for y: ${c1} - ${x} = ${y}`,
                                [String(x)]: `That's x. For y: ${c1} - ${x} = ${y}`
                            }
                        }
                    ]
                },
                practice: { problem: `Solve: x + y = 8 and x - y = 2. What is x?`, answer: "5",
                    options: ["3", "5", "6", "8"],
                    mistakeAnalysis: {
                        "3": "That's y! Adding: 2x = 10, so x = 5. Then 5 + y = 8, so y = 3.",
                        "6": "Check: Adding x+y=8 and x-y=2 gives 2x=10, so x=5.",
                        "8": "That's the sum x+y. Add the equations: 2x = 10, so x = 5."
                    }}
            };
        },
        Functions: () => {
            const a = rand(2, 4), b = rand(1, 5), xVal = rand(2, 5);
            const fx = a * xVal + b;
            return {
                goalProblem: `If f(x) = 3x + 2, find f(5)`,
                teachingSteps: [
                    {
                        title: "What is a function?",
                        explanation: "A <strong>function</strong> is a rule that takes an input and gives exactly one output. Think of it like a machine: put something in, get something out.",
                        visual: "Input ‚Üí [Function Machine] ‚Üí Output"
                    },
                    {
                        title: "Understanding function notation",
                        explanation: "f(x) = 3x + 2 means 'the function f takes input x and outputs 3x + 2'. The f(x) is read as 'f of x', NOT 'f times x'!",
                        visual: "f(x) = 3x + 2 ('f of x equals...')"
                    },
                    {
                        title: "What does f(5) mean?",
                        explanation: "f(5) means 'find the output when the input is 5'. We <strong>replace every x with 5</strong> in the function rule.",
                        visual: "f(5) ‚Üí plug in x = 5"
                    },
                    {
                        title: "Substitute x = 5",
                        explanation: "Take f(x) = 3x + 2 and replace x with 5: f(5) = 3(5) + 2",
                        visual: "f(5) = 3(5) + 2"
                    },
                    {
                        title: "Calculate the answer",
                        explanation: "3(5) = 15, then 15 + 2 = 17. So <strong>f(5) = 17</strong>. When we put in 5, we get out 17!",
                        visual: "f(5) = 17"
                    }
                ],
                finalAnswer: "f(5) = 17",
                answerExplanation: "f(5) means substitute 5 for x: f(5) = 3(5) + 2 = 15 + 2 = 17",
                example: { problem: `If f(x) = 3x + 2, find f(5)`, steps: [
                    { text: "Identify what we're finding", math: "f(5) means 'replace x with 5'" },
                    { text: "Write the function", math: "f(x) = 3x + 2" },
                    { text: "Substitute x = 5", math: "f(5) = 3(5) + 2" },
                    { text: "Calculate", math: "f(5) = 15 + 2 = <strong>17</strong>" }
                ]},
                keyPoints: [
                    "f(x) is 'f of x' - the output when input is x",
                    "f(3) means substitute 3 for every x in the function",
                    "A function gives exactly ONE output for each input"
                ],
                mistakes: [
                    { wrong: "f(x) = f √ó x (multiplying f and x)", why: "f(x) is function notation, not multiplication! f(5) means 'plug in 5 for x'" },
                    { wrong: "f(5) = 5 (just using the input as output)", why: "You must apply the function rule: f(5) = 3(5) + 2 = 17" },
                    { wrong: "Adding the input to the function: f(5) = 3x + 2 + 5", why: "Replace x WITH 5, don't add 5. f(5) = 3(5) + 2" }
                ],
                guided: { problem: `If f(x) = ${a}x + ${b}, find f(${xVal})`, steps: [
                    { label: "The function rule is", value: `f(x) = ${a}x + ${b}` },
                    { label: `Substitute x = ${xVal}`, value: `f(${xVal}) = ${a}(${xVal}) + ${b}` },
                    { label: "Calculate", value: `f(${xVal}) = ${a * xVal} + ${b} = ?` }
                ], answer: String(fx), answerLabel: `f(${xVal}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `f(${xVal}) means we plug in what value for x?`,
                            hint: "The number inside the parentheses is what we substitute...",
                            answer: String(xVal),
                            acceptableAnswers: [String(xVal), "x = " + xVal],
                            commonMistakes: {
                                [String(a)]: `${a} is the coefficient in the function. We're substituting x = ${xVal}.`,
                                [String(b)]: `${b} is the constant. The ${xVal} in f(${xVal}) is what we plug in for x.`
                            }
                        },
                        {
                            prompt: `Replace x with ${xVal} in f(x) = ${a}x + ${b}. What is ${a} √ó ${xVal}?`,
                            hint: `${a} times ${xVal}...`,
                            answer: String(a * xVal),
                            acceptableAnswers: [String(a * xVal)],
                            commonMistakes: {
                                [String(a + xVal)]: `Multiply, not add! ${a} √ó ${xVal} = ${a * xVal}`,
                                [String(xVal)]: `Don't forget to multiply by ${a}! ${a} √ó ${xVal} = ${a * xVal}`
                            }
                        },
                        {
                            prompt: `Now add the constant: ${a * xVal} + ${b} = ?`,
                            hint: `${a * xVal} plus ${b}...`,
                            answer: String(fx),
                            acceptableAnswers: [String(fx)],
                            commonMistakes: {
                                [String(a * xVal)]: `Don't forget to add ${b}! ${a * xVal} + ${b} = ${fx}`
                            }
                        },
                        {
                            prompt: `So f(${xVal}) = ?`,
                            hint: `We calculated ${a}(${xVal}) + ${b}...`,
                            answer: String(fx),
                            acceptableAnswers: [String(fx), "f(" + xVal + ") = " + fx],
                            commonMistakes: {
                                [String(xVal)]: `That's the input. The output is f(${xVal}) = ${fx}`
                            }
                        }
                    ]
                },
                practice: (() => { const newX = xVal + 1; const newFx = a * newX + b; return {
                    problem: `If f(x) = ${a}x + ${b}, find f(${newX})`, answer: String(newFx),
                    options: shuffle([String(newFx), String(a + newX + b), String(a * newX), String(newX)]),
                    mistakeAnalysis: {
                        [String(a + newX + b)]: `You added instead of multiplied. f(${newX}) = ${a} √ó ${newX} + ${b} = ${a * newX} + ${b} = ${newFx}`,
                        [String(a * newX)]: `You forgot to add ${b}. f(${newX}) = ${a}(${newX}) + ${b} = ${a * newX} + ${b} = ${newFx}`,
                        [String(newX)]: `${newX} is the INPUT. Apply the function: f(${newX}) = ${a}(${newX}) + ${b} = ${newFx}`
                    }}; })()
            };
        },
        Inequalities: () => {
            const a = rand(2, 4), b = rand(3, 8);
            const threshold = rand(10, 20);
            const solution = Math.ceil((threshold - b) / a);
            return {
                goalProblem: `Solve: 2x + 3 < 11`,
                teachingSteps: [
                    {
                        title: "What is an inequality?",
                        explanation: "An <strong>inequality</strong> compares two expressions using <, >, ‚â§, or ‚â• instead of =. The solution is a range of values, not just one number!",
                        visual: "< less than | > greater than | ‚â§ at most | ‚â• at least"
                    },
                    {
                        title: "Solving is like equations... mostly",
                        explanation: "We solve inequalities the same way as equations - isolate the variable. But there's ONE big difference we'll learn!",
                        visual: "2x + 3 < 11 ‚Üí isolate x"
                    },
                    {
                        title: "Step 1: Subtract 3 from both sides",
                        explanation: "Undo the +3 by subtracting 3 from both sides: 2x + 3 - 3 < 11 - 3, which gives us 2x < 8",
                        visual: "2x + 3 - 3 < 11 - 3 ‚Üí 2x < 8"
                    },
                    {
                        title: "Step 2: Divide both sides by 2",
                        explanation: "Divide both sides by 2 to get x alone: 2x √∑ 2 < 8 √∑ 2, which gives us <strong>x < 4</strong>",
                        visual: "2x √∑ 2 < 8 √∑ 2 ‚Üí x < 4"
                    },
                    {
                        title: "The critical rule!",
                        explanation: "When dividing/multiplying by a <strong>NEGATIVE</strong> number, FLIP the inequality sign! (Here we divided by +2, so no flip needed.)",
                        visual: "x < 4 means x can be 3, 2, 1, 0, -1, ..."
                    }
                ],
                finalAnswer: "x < 4",
                answerExplanation: "x < 4 means any number less than 4 works. Remember: flip the sign when multiplying/dividing by negatives!",
                example: { problem: `Solve: 2x + 3 < 11`, steps: [
                    { text: "Subtract 3 from both sides", math: "2x + 3 - 3 < 11 - 3" },
                    { text: "Simplify", math: "2x < 8" },
                    { text: "Divide both sides by 2", math: "2x √∑ 2 < 8 √∑ 2" },
                    { text: "Solution", math: "<strong>x < 4</strong>" },
                    { text: "This means x can be any number less than 4", math: "Like 3, 2, 1, 0, -1, ..." }
                ]},
                keyPoints: [
                    "Solve like an equation - isolate the variable",
                    "FLIP the sign when multiplying/dividing by a NEGATIVE",
                    "< or > means 'not including' (open circle), ‚â§ or ‚â• means 'including' (closed circle)"
                ],
                mistakes: [
                    { wrong: "Forgetting to flip the sign when dividing by a negative", why: "-2x > 6 becomes x < -3 (flip the >). Test: -2(-4) = 8 > 6 ‚úì" },
                    { wrong: "Writing the solution as a single number", why: "Inequalities have MANY solutions. x < 4 means ALL numbers less than 4." },
                    { wrong: "Confusing open and closed circles", why: "< or > = open (not including). ‚â§ or ‚â• = closed (including)." }
                ],
                guided: { problem: `Solve: ${a}x + ${b} ‚â• ${threshold}`, steps: [
                    { label: `Subtract ${b} from both sides`, value: `${a}x ‚â• ${threshold - b}` },
                    { label: `Divide both sides by ${a}`, value: `x ‚â• ${(threshold - b) / a}` },
                    { label: "What is x greater than or equal to?", value: "?" }
                ], answer: String(solution), answerLabel: "x ‚â• ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}x + ${b} ‚â• ${threshold}, what should we do first to isolate x?`,
                            hint: "Undo the outer operation first (the addition)...",
                            answer: `subtract ${b}`,
                            acceptableAnswers: [`subtract ${b}`, "subtract", `- ${b}`, "subtraction"],
                            commonMistakes: {
                                [`divide by ${a}`]: "Undo addition/subtraction first, then multiplication/division. Subtract ${b} first."
                            }
                        },
                        {
                            prompt: `Subtract ${b} from both sides: ${threshold} - ${b} = ?`,
                            hint: `${threshold} minus ${b}...`,
                            answer: String(threshold - b),
                            acceptableAnswers: [String(threshold - b)],
                            commonMistakes: {
                                [String(threshold + b)]: `Subtract, not add! ${threshold} - ${b} = ${threshold - b}`,
                                [String(threshold)]: `You need to subtract ${b}: ${threshold} - ${b} = ${threshold - b}`
                            }
                        },
                        {
                            prompt: `Now we have ${a}x ‚â• ${threshold - b}. We need to divide by ${a}. When we divide by a POSITIVE number, does the inequality sign flip?`,
                            hint: "The sign only flips when dividing by a negative...",
                            answer: "no",
                            acceptableAnswers: ["no", "it doesn't", "doesn't flip", "stays same"],
                            commonMistakes: {
                                "yes": "Only flip when dividing by a NEGATIVE. ${a} is positive, so the sign stays ‚â•."
                            }
                        },
                        {
                            prompt: `Calculate: ${threshold - b} √∑ ${a} = ?`,
                            hint: `${threshold - b} divided by ${a}...`,
                            answer: String((threshold - b) / a),
                            acceptableAnswers: [String((threshold - b) / a), String(solution)],
                            commonMistakes: {
                                [String((threshold - b) * a)]: `Divide, not multiply! ${threshold - b} √∑ ${a} = ${(threshold - b) / a}`
                            }
                        },
                        {
                            prompt: `So x ‚â• ?`,
                            hint: `We found ${threshold - b} √∑ ${a}...`,
                            answer: String(solution),
                            acceptableAnswers: [String(solution), "x ‚â• " + solution],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: 3x - 4 > 11. What values can x be?`, answer: "x > 5",
                    options: ["x > 5", "x < 5", "x > 7", "x = 5"],
                    mistakeAnalysis: {
                        "x < 5": "The inequality sign doesn't flip here (we divided by positive 3). 3x > 15, so x > 5.",
                        "x > 7": "Check your arithmetic: 3x > 11 + 4 = 15, so x > 15/3 = 5",
                        "x = 5": "This is an inequality (>) not an equation. x can be any number GREATER than 5."
                    }}
            };
        }
    },
    6: {
        Area: () => {
            const l = rand(4, 10), w = rand(3, 8);
            const area = l * w;
            return {
                goalProblem: `Find the area of a rectangle with length 8 ft and width 5 ft`,
                teachingSteps: [
                    {
                        title: "What is Area?",
                        explanation: "<strong>Area</strong> measures how much <strong>space is inside</strong> a flat (2D) shape.<br><br>Think of it like: <em>\"How many square tiles would fit inside this shape?\"</em>",
                        visual: "üìê Area = Inside space of a shape"
                    },
                    {
                        title: "Common Area Formulas",
                        explanation: "Different shapes have different formulas:<br><br>‚Ä¢ <strong>Rectangle:</strong> A = length √ó width<br>‚Ä¢ <strong>Square:</strong> A = side √ó side = s¬≤<br>‚Ä¢ <strong>Triangle:</strong> A = ¬Ω √ó base √ó height<br>‚Ä¢ <strong>Circle:</strong> A = œÄ √ó radius¬≤",
                        visual: "Rectangle: l √ó w | Square: s¬≤ | Triangle: ¬Ωbh | Circle: œÄr¬≤"
                    },
                    {
                        title: "Step 1: Identify the Shape and Formula",
                        explanation: "We have a <strong>rectangle</strong>, so we use:<br><br><strong>Area = length √ó width</strong>",
                        visual: "Rectangle ‚Üí A = l √ó w"
                    },
                    {
                        title: "Step 2: Plug in the Numbers",
                        explanation: "Our length is <strong>8 ft</strong> and width is <strong>5 ft</strong>:<br><br>A = 8 √ó 5",
                        visual: "A = 8 ft √ó 5 ft"
                    },
                    {
                        title: "Step 3: Calculate and Add Units",
                        explanation: "Multiply: 8 √ó 5 = <strong>40</strong><br><br>Area is always in <strong>SQUARE units</strong> (because we're measuring 2D space):<br><br><strong>A = 40 ft¬≤</strong>",
                        visual: "8 √ó 5 = 40 ‚Üí 40 ft¬≤ (square feet)"
                    }
                ],
                finalAnswer: "40 ft¬≤",
                answerExplanation: "We multiplied length √ó width (8 √ó 5 = 40) and used square units because area measures 2D space.",
                example: { problem: `Find the area of a rectangle with length 8 ft and width 5 ft`, steps: [
                    { text: "Identify the formula", math: "Area = length √ó width" },
                    { text: "Substitute the values", math: "A = 8 √ó 5" },
                    { text: "Calculate", math: "A = 40" },
                    { text: "Add square units", math: "<strong>A = 40 ft¬≤</strong>" }
                ]},
                keyPoints: [
                    "Area = space INSIDE a shape",
                    "Always use SQUARE units (ft¬≤, in¬≤, cm¬≤)",
                    "For triangles, don't forget the ¬Ω!"
                ],
                mistakes: [
                    { wrong: "Confusing area and perimeter", why: "Area = inside space (square units). Perimeter = distance around (regular units)." },
                    { wrong: "Forgetting ¬Ω for triangles", why: "Triangle area = ¬Ω √ó base √ó height. The ¬Ω is essential!" },
                    { wrong: "Using diameter instead of radius for circles", why: "A = œÄr¬≤, where r is RADIUS (half the diameter)." }
                ],
                guided: {
                    problem: `Find the area of a rectangle: length = ${l} cm, width = ${w} cm`,
                    steps: [
                        { label: "Formula", value: "A = l √ó w" },
                        { label: "Substitute", value: `A = ${l} √ó ${w}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(area),
                    answerLabel: "Area in cm¬≤:",
                    interactiveSteps: [
                        {
                            prompt: "What formula do we use for the area of a rectangle?",
                            hint: "Area equals what times what?",
                            answer: "l √ó w",
                            acceptableAnswers: ["l √ó w", "l*w", "lxw", "length √ó width", "length * width", "length x width", "l x w", "A = l √ó w", "A=l√ów"],
                            commonMistakes: {
                                "l + w": "That's for perimeter! Area uses multiplication (√ó), not addition (+).",
                                "2l + 2w": "That's the perimeter formula. For area, we multiply length √ó width.",
                                "l √ó w √ó h": "That's for volume (3D). Area only needs length √ó width (2D)."
                            }
                        },
                        {
                            prompt: `Now plug in the numbers: ${l} √ó ${w} = ?`,
                            hint: `Multiply ${l} times ${w}`,
                            answer: String(area),
                            acceptableAnswers: [String(area), `${area} cm¬≤`, `${area}cm¬≤`],
                            commonMistakes: {
                                [String(l + w)]: `You added instead of multiplied! ${l} √ó ${w} = ${area}, not ${l} + ${w} = ${l + w}`,
                                [String(l * w * 2)]: "You multiplied by 2 - that's not needed for area. Just multiply length √ó width.",
                                [String(2 * l + 2 * w)]: "That's the perimeter! For area, just multiply: length √ó width."
                            }
                        }
                    ]
                },
                practice: { problem: `A triangle has base 10 in and height 6 in. What is its area?`, answer: "30",
                    options: ["30", "60", "16", "32"],
                    mistakeAnalysis: {
                        "60": "You forgot the ¬Ω! Triangle area = ¬Ω √ó 10 √ó 6 = 30 in¬≤",
                        "16": "That's 10 + 6 (perimeter pieces). Area = ¬Ω √ó base √ó height = 30",
                        "32": "Check your calculation: ¬Ω √ó 10 √ó 6 = 5 √ó 6 = 30"
                    }}
            };
        },
        Volume: () => {
            const l = rand(3, 7), w = rand(2, 5), h = rand(2, 6);
            const vol = l * w * h;
            return {
                goalProblem: `Find the volume of a box: 4 cm √ó 3 cm √ó 5 cm`,
                teachingSteps: [
                    {
                        title: "What is Volume?",
                        explanation: "<strong>Volume</strong> measures how much <strong>space is inside</strong> a 3D (three-dimensional) shape.<br><br>Think of it like: <em>\"How many little cubes would fit inside this shape?\"</em>",
                        visual: "üì¶ Volume = Space inside a 3D shape"
                    },
                    {
                        title: "Area vs. Volume",
                        explanation: "<strong>Area</strong> is 2D (flat): length √ó width ‚Üí square units (cm¬≤)<br><br><strong>Volume</strong> is 3D (solid): length √ó width √ó height ‚Üí cubic units (cm¬≥)<br><br>Volume adds that third dimension!",
                        visual: "2D: ‚ñ° ‚Üí cm¬≤ | 3D: üì¶ ‚Üí cm¬≥"
                    },
                    {
                        title: "Common Volume Formulas",
                        explanation: "‚Ä¢ <strong>Box (rectangular prism):</strong> V = l √ó w √ó h<br>‚Ä¢ <strong>Cube:</strong> V = s¬≥ (side √ó side √ó side)<br>‚Ä¢ <strong>Cylinder:</strong> V = œÄr¬≤h<br>‚Ä¢ <strong>Sphere:</strong> V = (4/3)œÄr¬≥",
                        visual: "Box: lwh | Cube: s¬≥ | Cylinder: œÄr¬≤h | Sphere: (4/3)œÄr¬≥"
                    },
                    {
                        title: "Step 1: Identify the Formula",
                        explanation: "We have a <strong>box (rectangular prism)</strong>, so we use:<br><br><strong>Volume = length √ó width √ó height</strong>",
                        visual: "Box ‚Üí V = l √ó w √ó h"
                    },
                    {
                        title: "Step 2: Plug in the Numbers",
                        explanation: "Our dimensions are: length = <strong>4 cm</strong>, width = <strong>3 cm</strong>, height = <strong>5 cm</strong><br><br>V = 4 √ó 3 √ó 5",
                        visual: "V = 4 cm √ó 3 cm √ó 5 cm"
                    },
                    {
                        title: "Step 3: Calculate Step by Step",
                        explanation: "Work left to right:<br><br>First: 4 √ó 3 = <strong>12</strong><br>Then: 12 √ó 5 = <strong>60</strong><br><br>Volume = 60, and we use <strong>CUBIC units</strong>: <strong>60 cm¬≥</strong>",
                        visual: "4 √ó 3 = 12 ‚Üí 12 √ó 5 = 60 ‚Üí 60 cm¬≥"
                    }
                ],
                finalAnswer: "60 cm¬≥",
                answerExplanation: "We multiplied all three dimensions (4 √ó 3 √ó 5 = 60) and used cubic units because volume measures 3D space.",
                example: { problem: `Find the volume of a box: 4 cm √ó 3 cm √ó 5 cm`, steps: [
                    { text: "Identify the formula", math: "Volume = l √ó w √ó h" },
                    { text: "Substitute the values", math: "V = 4 √ó 3 √ó 5" },
                    { text: "Calculate step by step", math: "V = 12 √ó 5 = 60" },
                    { text: "Add cubic units", math: "<strong>V = 60 cm¬≥</strong>" }
                ]},
                keyPoints: [
                    "Volume = space INSIDE a 3D shape",
                    "Always use CUBIC units (ft¬≥, in¬≥, cm¬≥)",
                    "Think: how many unit cubes fit inside?"
                ],
                mistakes: [
                    { wrong: "Using square units instead of cubic", why: "Volume needs CUBIC units because it's 3D (length √ó width √ó height)" },
                    { wrong: "Finding area instead of volume", why: "Area is 2D (l √ó w). Volume is 3D (l √ó w √ó h)." },
                    { wrong: "Forgetting to cube the radius for spheres", why: "Sphere volume = (4/3)œÄr¬≥, not (4/3)œÄr" }
                ],
                guided: {
                    problem: `Find the volume of a box: ${l} √ó ${w} √ó ${h} inches`,
                    steps: [
                        { label: "Formula", value: "V = l √ó w √ó h" },
                        { label: "Substitute", value: `V = ${l} √ó ${w} √ó ${h}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(vol),
                    answerLabel: "Volume in in¬≥:",
                    interactiveSteps: [
                        {
                            prompt: "What formula do we use for the volume of a rectangular box?",
                            hint: "Volume equals length times width times... what?",
                            answer: "l √ó w √ó h",
                            acceptableAnswers: ["l √ó w √ó h", "l*w*h", "lwh", "l x w x h", "length √ó width √ó height", "V = l √ó w √ó h", "V=lwh"],
                            commonMistakes: {
                                "l √ó w": "That's the formula for AREA (2D). Volume needs all THREE dimensions: l √ó w √ó h",
                                "l + w + h": "That's adding the dimensions. Volume MULTIPLIES them: l √ó w √ó h",
                                "2(l + w + h)": "That's related to perimeter/surface area. Volume = l √ó w √ó h"
                            }
                        },
                        {
                            prompt: `First, multiply the first two dimensions: ${l} √ó ${w} = ?`,
                            hint: `What's ${l} times ${w}?`,
                            answer: String(l * w),
                            acceptableAnswers: [String(l * w)],
                            commonMistakes: {
                                [String(l + w)]: `You added instead of multiplied! ${l} √ó ${w} = ${l * w}`,
                                [String(l * w * h)]: `That's the final answer! We're just doing the first step: ${l} √ó ${w} = ${l * w}`
                            }
                        },
                        {
                            prompt: `Now multiply that result by the height: ${l * w} √ó ${h} = ?`,
                            hint: `What's ${l * w} times ${h}?`,
                            answer: String(vol),
                            acceptableAnswers: [String(vol), `${vol} in¬≥`, `${vol}in¬≥`, `${vol} cubic inches`],
                            commonMistakes: {
                                [String(l * w + h)]: `You added the height instead of multiplying! ${l * w} √ó ${h} = ${vol}`,
                                [String(l * w)]: `Don't forget to multiply by the height! ${l * w} √ó ${h} = ${vol}`
                            }
                        }
                    ]
                },
                practice: { problem: `A cube has sides of 4 cm. What is its volume?`, answer: "64",
                    options: ["12", "16", "64", "256"],
                    mistakeAnalysis: {
                        "12": "That's 4 + 4 + 4 (adding). Volume of cube = 4 √ó 4 √ó 4 = 64",
                        "16": "That's 4 √ó 4 (area of one face). Volume = 4 √ó 4 √ó 4 = 64",
                        "256": "That's 4‚Å¥, but cube volume is s¬≥ = 4¬≥ = 64"
                    }}
            };
        },
        Triangles: () => {
            const a = rand(30, 60), b = rand(40, 70);
            const c = 180 - a - b;
            return {
                goalProblem: `A triangle has angles 50¬∞ and 70¬∞. Find the third angle.`,
                teachingSteps: [
                    {
                        title: "The Most Important Triangle Rule",
                        explanation: "The <strong>most important fact</strong> about triangles:<br><br>üìê <strong>All three angles ALWAYS add up to 180¬∞</strong><br><br>This works for EVERY triangle, no matter what shape!",
                        visual: "Angle 1 + Angle 2 + Angle 3 = 180¬∞ (always!)"
                    },
                    {
                        title: "Types of Triangles by Angles",
                        explanation: "‚Ä¢ <strong>Acute:</strong> All angles less than 90¬∞<br>‚Ä¢ <strong>Right:</strong> One angle equals exactly 90¬∞<br>‚Ä¢ <strong>Obtuse:</strong> One angle greater than 90¬∞",
                        visual: "Acute: all < 90¬∞ | Right: one = 90¬∞ | Obtuse: one > 90¬∞"
                    },
                    {
                        title: "Types of Triangles by Sides",
                        explanation: "‚Ä¢ <strong>Equilateral:</strong> All 3 sides equal ‚Üí all angles are 60¬∞<br>‚Ä¢ <strong>Isosceles:</strong> 2 sides equal ‚Üí 2 angles equal<br>‚Ä¢ <strong>Scalene:</strong> No sides equal ‚Üí no angles equal",
                        visual: "Equilateral: 60¬∞-60¬∞-60¬∞ | Isosceles: 2 equal | Scalene: all different"
                    },
                    {
                        title: "Step 1: What Do We Know?",
                        explanation: "We're given two angles: <strong>50¬∞</strong> and <strong>70¬∞</strong><br><br>We need to find the third angle using our rule.",
                        visual: "Known: 50¬∞ and 70¬∞ | Unknown: third angle"
                    },
                    {
                        title: "Step 2: Add the Known Angles",
                        explanation: "First, add the two angles we know:<br><br><strong>50¬∞ + 70¬∞ = 120¬∞</strong><br><br>So the two known angles use up 120¬∞ of our 180¬∞ total.",
                        visual: "50¬∞ + 70¬∞ = 120¬∞"
                    },
                    {
                        title: "Step 3: Subtract from 180¬∞",
                        explanation: "The third angle is whatever's left to reach 180¬∞:<br><br><strong>180¬∞ - 120¬∞ = 60¬∞</strong><br><br>The third angle is <strong>60¬∞</strong>!",
                        visual: "180¬∞ - 120¬∞ = 60¬∞"
                    }
                ],
                finalAnswer: "60¬∞",
                answerExplanation: "We added the two known angles (50¬∞ + 70¬∞ = 120¬∞), then subtracted from 180¬∞ to find the third angle (180¬∞ - 120¬∞ = 60¬∞).",
                example: { problem: `Triangle has angles 50¬∞ and 70¬∞. Find the third angle.`, steps: [
                    { text: "Use the angle sum property", math: "All angles sum to 180¬∞" },
                    { text: "Add known angles", math: "50¬∞ + 70¬∞ = 120¬∞" },
                    { text: "Subtract from 180¬∞", math: "180¬∞ - 120¬∞ = 60¬∞" },
                    { text: "The third angle is", math: "<strong>60¬∞</strong>" }
                ]},
                keyPoints: [
                    "Triangle angle sum = 180¬∞ (always!)",
                    "Third angle = 180¬∞ - (first angle + second angle)",
                    "Equilateral triangles have all 60¬∞ angles"
                ],
                mistakes: [
                    { wrong: "Forgetting that angles sum to 180¬∞", why: "This is the fundamental triangle property: a + b + c = 180¬∞" },
                    { wrong: "Thinking angles sum to 360¬∞", why: "360¬∞ is for quadrilaterals. Triangles = 180¬∞." }
                ],
                guided: {
                    problem: `A triangle has angles ${a}¬∞ and ${b}¬∞. Find the third angle.`,
                    steps: [
                        { label: "Sum of first two angles", value: `${a}¬∞ + ${b}¬∞ = ${a + b}¬∞` },
                        { label: "Third angle = 180¬∞ - sum", value: `180¬∞ - ${a + b}¬∞ = ?` }
                    ],
                    answer: String(c),
                    answerLabel: "Third angle:",
                    interactiveSteps: [
                        {
                            prompt: "What do all angles in a triangle add up to?",
                            hint: "This is the fundamental triangle rule...",
                            answer: "180",
                            acceptableAnswers: ["180", "180¬∞", "180 degrees"],
                            commonMistakes: {
                                "360": "360¬∞ is for quadrilaterals (4 sides). Triangles only have 180¬∞!",
                                "90": "90¬∞ is a right angle. All THREE angles together = 180¬∞.",
                                "100": "Not quite. The sum of all angles in a triangle is always 180¬∞."
                            }
                        },
                        {
                            prompt: `Add the two known angles: ${a}¬∞ + ${b}¬∞ = ?`,
                            hint: `Add ${a} and ${b} together`,
                            answer: String(a + b),
                            acceptableAnswers: [String(a + b), `${a + b}¬∞`],
                            commonMistakes: {
                                [String(a * b)]: `You multiplied! We need to ADD: ${a} + ${b} = ${a + b}`,
                                [String(Math.abs(a - b))]: `You subtracted. We need to ADD the angles: ${a} + ${b} = ${a + b}`
                            }
                        },
                        {
                            prompt: `Now subtract from 180¬∞: 180¬∞ - ${a + b}¬∞ = ?`,
                            hint: `What's left when you subtract ${a + b} from 180?`,
                            answer: String(c),
                            acceptableAnswers: [String(c), `${c}¬∞`],
                            commonMistakes: {
                                [String(180 + (a + b))]: "You added instead of subtracted! 180 - sum, not 180 + sum.",
                                [String(a + b)]: `That's the sum of the two angles. We need 180 - ${a + b} = ${c}`
                            }
                        }
                    ]
                },
                practice: { problem: `One angle of an isosceles triangle is 40¬∞. If this is one of the equal angles, what are the other angles?`, answer: "40¬∞ and 100¬∞",
                    options: ["40¬∞ and 100¬∞", "70¬∞ and 70¬∞", "40¬∞ and 40¬∞", "60¬∞ and 80¬∞"],
                    mistakeAnalysis: {
                        "70¬∞ and 70¬∞": "If 40¬∞ is one of the equal angles, the other equal angle is also 40¬∞. Third = 180¬∞ - 80¬∞ = 100¬∞",
                        "40¬∞ and 40¬∞": "That would give 120¬∞ total. The third angle = 180¬∞ - 80¬∞ = 100¬∞",
                        "60¬∞ and 80¬∞": "In isosceles, two angles are equal. If one equal angle is 40¬∞, so is the other."
                    }}
            };
        },
        Circles: () => {
            const r = rand(3, 8);
            const circumference = 2 * Math.PI * r;
            return {
                goalProblem: `Find the circumference of a circle with radius 5 cm`,
                teachingSteps: [
                    {
                        title: "Circle Vocabulary",
                        explanation: "Key parts of a circle:<br><br>‚Ä¢ <strong>Radius (r):</strong> Distance from <em>center</em> to the <em>edge</em><br>‚Ä¢ <strong>Diameter (d):</strong> Distance <em>across</em> the circle through the center<br><br>Important: <strong>Diameter = 2 √ó Radius</strong>",
                        visual: "r = center to edge | d = across = 2r"
                    },
                    {
                        title: "What is œÄ (Pi)?",
                        explanation: "<strong>œÄ (pi)</strong> is a special number that shows up in ALL circle calculations.<br><br>œÄ ‚âà <strong>3.14159...</strong> (it goes on forever!)<br><br>For calculations, we often use œÄ ‚âà <strong>3.14</strong>",
                        visual: "œÄ ‚âà 3.14 (approximately)"
                    },
                    {
                        title: "Circle Formulas",
                        explanation: "‚Ä¢ <strong>Circumference</strong> (distance around): <strong>C = 2œÄr</strong> or C = œÄd<br><br>‚Ä¢ <strong>Area</strong> (space inside): <strong>A = œÄr¬≤</strong><br><br>Circumference is around, Area is inside!",
                        visual: "Circumference: C = 2œÄr | Area: A = œÄr¬≤"
                    },
                    {
                        title: "Step 1: Identify What We're Finding",
                        explanation: "We need the <strong>circumference</strong> (distance AROUND the circle).<br><br>Formula: <strong>C = 2œÄr</strong>",
                        visual: "Circumference = distance around ‚Üí C = 2œÄr"
                    },
                    {
                        title: "Step 2: Plug in the Values",
                        explanation: "Our radius is <strong>5 cm</strong>.<br><br>C = 2 √ó œÄ √ó 5<br>C = 2 √ó 3.14 √ó 5",
                        visual: "C = 2 √ó 3.14 √ó 5"
                    },
                    {
                        title: "Step 3: Calculate",
                        explanation: "Work through the multiplication:<br><br>2 √ó 3.14 = <strong>6.28</strong><br>6.28 √ó 5 = <strong>31.4</strong><br><br>The circumference is <strong>31.4 cm</strong> (or 10œÄ cm as an exact answer)",
                        visual: "2 √ó 3.14 = 6.28 ‚Üí 6.28 √ó 5 = 31.4 cm"
                    }
                ],
                finalAnswer: "31.4 cm (or 10œÄ cm)",
                answerExplanation: "Using C = 2œÄr with r = 5, we get C = 2 √ó 3.14 √ó 5 = 31.4 cm.",
                example: { problem: `Find the circumference of a circle with radius 5 cm`, steps: [
                    { text: "Identify the formula", math: "C = 2œÄr" },
                    { text: "Substitute r = 5", math: "C = 2 √ó œÄ √ó 5" },
                    { text: "Calculate", math: "C = 10œÄ ‚âà 31.4 cm" }
                ]},
                keyPoints: [
                    "Radius = half the diameter, Diameter = twice the radius",
                    "Circumference uses 2œÄr (or œÄd), Area uses œÄr¬≤",
                    "œÄ ‚âà 3.14 is often used for approximate answers"
                ],
                mistakes: [
                    { wrong: "Confusing circumference and area formulas", why: "Circumference = 2œÄr (around). Area = œÄr¬≤ (inside)." },
                    { wrong: "Using diameter when radius is needed", why: "Most formulas use RADIUS. If given diameter, divide by 2 first." }
                ],
                guided: {
                    problem: `Find the circumference of a circle with radius ${r} cm (use œÄ ‚âà 3.14)`,
                    steps: [
                        { label: "Formula", value: "C = 2œÄr" },
                        { label: "Substitute", value: `C = 2 √ó 3.14 √ó ${r}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(Math.round(circumference * 100) / 100),
                    answerLabel: "Circumference:",
                    interactiveSteps: (() => {
                        const step1 = 2 * 3.14;
                        const finalC = Math.round(step1 * r * 100) / 100;
                        return [
                            {
                                prompt: "What formula do we use for circumference of a circle?",
                                hint: "It involves 2, œÄ, and the radius...",
                                answer: "C = 2œÄr",
                                acceptableAnswers: ["C = 2œÄr", "2œÄr", "2*pi*r", "2pir", "C=2œÄr", "œÄd", "C = œÄd"],
                                commonMistakes: {
                                    "œÄr¬≤": "That's the AREA formula! Circumference = 2œÄr (around), Area = œÄr¬≤ (inside)",
                                    "œÄr": "Close! But circumference needs 2œÄr, not just œÄr",
                                    "2r": "You forgot œÄ! The formula is 2œÄr"
                                }
                            },
                            {
                                prompt: `Calculate: 2 √ó 3.14 = ?`,
                                hint: "Multiply 2 times 3.14",
                                answer: "6.28",
                                acceptableAnswers: ["6.28"],
                                commonMistakes: {
                                    "5.14": "That's 2 + 3.14 (addition). We need 2 √ó 3.14 = 6.28",
                                    "1.57": "That's 3.14 √∑ 2. We need 2 √ó 3.14 = 6.28",
                                    "3.14": "You need to multiply by 2: 2 √ó 3.14 = 6.28"
                                }
                            },
                            {
                                prompt: `Now multiply: 6.28 √ó ${r} = ?`,
                                hint: `What's 6.28 times ${r}?`,
                                answer: String(finalC),
                                acceptableAnswers: [String(finalC), `${finalC} cm`, `${finalC}cm`],
                                commonMistakes: {
                                    [String(6.28 + r)]: `You added instead of multiplied! 6.28 √ó ${r} = ${finalC}`,
                                    [String(3.14 * r)]: `You used œÄr instead of 2œÄr. The answer is 6.28 √ó ${r} = ${finalC}`
                                }
                            }
                        ];
                    })()
                },
                practice: { problem: `A circle has diameter 10 cm. What is its radius?`, answer: "5",
                    options: ["5", "10", "20", "31.4"],
                    mistakeAnalysis: {
                        "10": "That's the diameter. Radius = diameter √∑ 2 = 10 √∑ 2 = 5",
                        "20": "You doubled instead of halved. Radius = diameter √∑ 2",
                        "31.4": "That's the circumference (œÄd). Radius = d √∑ 2 = 5"
                    }}
            };
        },
        Trigonometry: () => ({
            goalProblem: `In a right triangle, angle Œ∏ has opposite = 3, hypotenuse = 5. Find sin(Œ∏).`,
            teachingSteps: [
                {
                    title: "What is Trigonometry?",
                    explanation: "<strong>Trigonometry</strong> connects <strong>angles</strong> to <strong>side lengths</strong> in right triangles.<br><br>It lets you find missing sides or angles using special ratios!",
                    visual: "Angles ‚Üî Side Lengths (in right triangles)"
                },
                {
                    title: "The Three Sides in a Right Triangle",
                    explanation: "For any angle (Œ∏) in a right triangle:<br><br>‚Ä¢ <strong>Opposite:</strong> The side ACROSS from the angle<br>‚Ä¢ <strong>Adjacent:</strong> The side NEXT TO the angle (not the hypotenuse)<br>‚Ä¢ <strong>Hypotenuse:</strong> The LONGEST side (opposite the 90¬∞ angle)",
                    visual: "Opposite = across | Adjacent = next to | Hypotenuse = longest"
                },
                {
                    title: "SOH CAH TOA - The Magic Memory Trick!",
                    explanation: "<strong>SOH:</strong> sin(Œ∏) = Opposite / Hypotenuse<br><strong>CAH:</strong> cos(Œ∏) = Adjacent / Hypotenuse<br><strong>TOA:</strong> tan(Œ∏) = Opposite / Adjacent<br><br>Say it: \"SOH CAH TOA\" (sounds like \"so-kah-toe-ah\")",
                    visual: "SOH: sin = O/H | CAH: cos = A/H | TOA: tan = O/A"
                },
                {
                    title: "Step 1: What Are We Finding?",
                    explanation: "We need <strong>sin(Œ∏)</strong>.<br><br>Using SOH: <strong>sin = Opposite / Hypotenuse</strong>",
                    visual: "sin(Œ∏) = O/H"
                },
                {
                    title: "Step 2: Identify the Sides",
                    explanation: "From our problem:<br><br>‚Ä¢ Opposite side = <strong>3</strong><br>‚Ä¢ Hypotenuse = <strong>5</strong>",
                    visual: "O = 3, H = 5"
                },
                {
                    title: "Step 3: Plug In and Calculate",
                    explanation: "sin(Œ∏) = Opposite / Hypotenuse<br>sin(Œ∏) = 3 / 5<br>sin(Œ∏) = <strong>0.6</strong>",
                    visual: "sin(Œ∏) = 3/5 = 0.6"
                }
            ],
            finalAnswer: "sin(Œ∏) = 0.6",
            answerExplanation: "Using SOH (sin = Opposite/Hypotenuse), we divided 3 by 5 to get 0.6.",
            example: { problem: `In a right triangle, angle Œ∏ has opposite = 3, hypotenuse = 5. Find sin(Œ∏).`, steps: [
                { text: "Recall SOH: sin = Opposite/Hypotenuse", math: "sin(Œ∏) = O/H" },
                { text: "Substitute values", math: "sin(Œ∏) = 3/5" },
                { text: "Calculate", math: "<strong>sin(Œ∏) = 0.6</strong>" }
            ]},
            keyPoints: [
                "SOH CAH TOA helps remember the ratios",
                "Always identify which side is opposite, adjacent, or hypotenuse relative to your angle",
                "The hypotenuse is ALWAYS the longest side"
            ],
            mistakes: [
                { wrong: "Mixing up opposite and adjacent", why: "Opposite is ACROSS from the angle. Adjacent is NEXT TO the angle." },
                { wrong: "Using wrong sides for the ratio", why: "Sin = O/H, Cos = A/H, Tan = O/A. Check SOH CAH TOA." }
            ],
            guided: {
                problem: `In a right triangle, the side opposite angle A is 4, and the adjacent side is 3. Find tan(A).`,
                steps: [
                    { label: "Recall TOA: tan = Opposite/Adjacent", value: "tan(A) = O/A" },
                    { label: "Substitute", value: "tan(A) = 4/3" },
                    { label: "As a decimal", value: "?" }
                ],
                answer: "1.33",
                answerLabel: "tan(A) ‚âà",
                interactiveSteps: [
                    {
                        prompt: "What memory trick helps us remember the trig ratios?",
                        hint: "It sounds like \"so-kah-toe-ah\"...",
                        answer: "SOH CAH TOA",
                        acceptableAnswers: ["SOH CAH TOA", "SOHCAHTOA", "soh cah toa", "sohcahtoa"],
                        commonMistakes: {
                            "sin cos tan": "Those are the functions, but the memory trick is SOH CAH TOA!",
                            "PEMDAS": "That's for order of operations. For trig ratios, use SOH CAH TOA!"
                        }
                    },
                    {
                        prompt: "For tan (TOA), what's the formula? tan = ___ / ___",
                        hint: "TOA: Tan = O... / A...",
                        answer: "O/A",
                        acceptableAnswers: ["O/A", "opposite/adjacent", "opposite / adjacent", "opp/adj"],
                        commonMistakes: {
                            "O/H": "That's SOH (sin = O/H). Tan uses TOA: tan = O/A",
                            "A/H": "That's CAH (cos = A/H). Tan uses TOA: tan = O/A",
                            "A/O": "You have it upside down! TOA means tan = Opposite/Adjacent, not Adjacent/Opposite"
                        }
                    },
                    {
                        prompt: "Plug in the values: 4/3 = ? (round to 2 decimal places)",
                        hint: "Divide 4 by 3 and round to two decimal places",
                        answer: "1.33",
                        acceptableAnswers: ["1.33", "1.3", "1.333"],
                        commonMistakes: {
                            "0.75": "You divided 3/4 instead of 4/3. The opposite (4) goes on TOP!",
                            "7": "You added 4 + 3. We need to DIVIDE: 4 √∑ 3 = 1.33",
                            "12": "You multiplied 4 √ó 3. We need to DIVIDE: 4 √∑ 3 = 1.33"
                        }
                    }
                ]
            },
            practice: { problem: `sin(Œ∏) = opposite/hypotenuse. If sin(Œ∏) = 0.5, and the hypotenuse is 10, what is the opposite side?`, answer: "5",
                options: ["5", "10", "20", "0.05"],
                mistakeAnalysis: {
                    "10": "sin(Œ∏) = O/H. If sin(Œ∏) = 0.5, then O = 0.5 √ó H = 0.5 √ó 10 = 5",
                    "20": "You multiplied 10 √ó 2 instead of 10 √ó 0.5",
                    "0.05": "You divided 0.5 by 10. You should multiply: O = sin(Œ∏) √ó H = 5"
                }}
        })
    },
    7: {
        Quadratics: () => {
            const a = 1, b = rand(-8, 8), c = rand(-10, 10);
            return {
                goalProblem: `Solve: x¬≤ + 5x + 6 = 0`,
                teachingSteps: [
                    {
                        title: "What is a Quadratic Equation?",
                        explanation: "A <strong>quadratic equation</strong> has the form:<br><br><strong>ax¬≤ + bx + c = 0</strong><br><br>The highest power of x is 2 (that's what makes it quadratic!).",
                        visual: "ax¬≤ + bx + c = 0 (x¬≤ is the key!)"
                    },
                    {
                        title: "Ways to Solve Quadratics",
                        explanation: "Three main methods:<br><br>1. <strong>Factoring</strong> - Break into (x + p)(x + q) = 0<br>2. <strong>Quadratic Formula</strong> - x = (-b ¬± ‚àö(b¬≤-4ac)) / 2a<br>3. <strong>Completing the Square</strong><br><br>We'll use factoring (the easiest when it works!).",
                        visual: "Factoring ‚Üí Formula ‚Üí Completing the Square"
                    },
                    {
                        title: "The Factoring Strategy",
                        explanation: "For x¬≤ + bx + c = 0, find two numbers that:<br><br>‚Ä¢ <strong>MULTIPLY</strong> to give c (the constant)<br>‚Ä¢ <strong>ADD</strong> to give b (the x coefficient)<br><br>Then write: (x + first#)(x + second#) = 0",
                        visual: "Find p and q where: p √ó q = c AND p + q = b"
                    },
                    {
                        title: "Step 1: Identify b and c",
                        explanation: "In <strong>x¬≤ + 5x + 6 = 0</strong>:<br><br>‚Ä¢ b = <strong>5</strong> (coefficient of x)<br>‚Ä¢ c = <strong>6</strong> (constant term)<br><br>We need numbers that multiply to 6 and add to 5.",
                        visual: "b = 5, c = 6 ‚Üí Find: ___ √ó ___ = 6 and ___ + ___ = 5"
                    },
                    {
                        title: "Step 2: Find the Two Numbers",
                        explanation: "What multiplies to 6 AND adds to 5?<br><br>Try: 1 √ó 6 = 6, but 1 + 6 = 7 ‚úó<br>Try: <strong>2 √ó 3 = 6</strong>, and <strong>2 + 3 = 5</strong> ‚úì<br><br>Our numbers are <strong>2 and 3</strong>!",
                        visual: "2 √ó 3 = 6 ‚úì | 2 + 3 = 5 ‚úì ‚Üí Numbers: 2 and 3"
                    },
                    {
                        title: "Step 3: Write in Factored Form",
                        explanation: "Using 2 and 3:<br><br>x¬≤ + 5x + 6 = <strong>(x + 2)(x + 3) = 0</strong>",
                        visual: "(x + 2)(x + 3) = 0"
                    },
                    {
                        title: "Step 4: Zero Product Property",
                        explanation: "If two things multiply to zero, one of them MUST be zero!<br><br>(x + 2)(x + 3) = 0 means:<br>‚Ä¢ x + 2 = 0 ‚Üí <strong>x = -2</strong><br>‚Ä¢ x + 3 = 0 ‚Üí <strong>x = -3</strong>",
                        visual: "x + 2 = 0 ‚Üí x = -2 | x + 3 = 0 ‚Üí x = -3"
                    }
                ],
                finalAnswer: "x = -2 or x = -3",
                answerExplanation: "We factored to (x + 2)(x + 3) = 0, then set each factor equal to zero: x = -2 and x = -3.",
                example: { problem: `Solve: x¬≤ + 5x + 6 = 0 by factoring`, steps: [
                    { text: "Find numbers that multiply to 6 and add to 5", math: "2 √ó 3 = 6, 2 + 3 = 5 ‚úì" },
                    { text: "Factor", math: "(x + 2)(x + 3) = 0" },
                    { text: "Set each factor to zero", math: "x + 2 = 0 or x + 3 = 0" },
                    { text: "Solve each", math: "<strong>x = -2 or x = -3</strong>" }
                ]},
                keyPoints: [
                    "Set each factor equal to zero (Zero Product Property)",
                    "Quadratics can have 0, 1, or 2 real solutions",
                    "The quadratic formula always works (when factoring is hard)"
                ],
                mistakes: [
                    { wrong: "Forgetting the ¬± in the quadratic formula", why: "There are TWO solutions: one with + and one with ‚àí" },
                    { wrong: "(x + 2)(x + 3) = 0 ‚Üí x = 2, x = 3", why: "Wrong signs! x + 2 = 0 means x = -2, not x = 2" }
                ],
                guided: {
                    problem: `Solve: x¬≤ + 5x + 6 = 0`,
                    steps: [
                        { label: "Factor: need numbers that multiply to 6, add to 5", value: "2 and 3" },
                        { label: "Factored form", value: "(x + 2)(x + 3) = 0" },
                        { label: "Solutions", value: "?" }
                    ],
                    answer: "x = -2, x = -3",
                    answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: "We need two numbers that MULTIPLY to 6 and ADD to 5. What are they?",
                            hint: "Think of factor pairs of 6: (1,6), (2,3)... which pair adds to 5?",
                            answer: "2 and 3",
                            acceptableAnswers: ["2 and 3", "2, 3", "2 3", "3 and 2", "3, 2"],
                            commonMistakes: {
                                "1 and 6": "1 √ó 6 = 6 ‚úì but 1 + 6 = 7 ‚úó. We need 2 and 3 (2 + 3 = 5)",
                                "2 and 5": "2 + 5 = 7, not 5. The numbers are 2 and 3",
                                "1 and 5": "1 √ó 5 = 5, not 6. We need numbers that MULTIPLY to 6 and ADD to 5"
                            }
                        },
                        {
                            prompt: "Now write it in factored form: (x + ?)(x + ?) = 0",
                            hint: "Use the numbers 2 and 3 in the factors",
                            answer: "(x + 2)(x + 3)",
                            acceptableAnswers: ["(x + 2)(x + 3)", "(x+2)(x+3)", "(x + 3)(x + 2)", "(x+3)(x+2)"],
                            commonMistakes: {
                                "(x - 2)(x - 3)": "Since we're adding positive numbers, use + not -: (x + 2)(x + 3)",
                                "(x + 5)(x + 6)": "5 and 6 are from the equation, but we need to use the factor pair: (x + 2)(x + 3)"
                            }
                        },
                        {
                            prompt: "If x + 2 = 0, what is x?",
                            hint: "Subtract 2 from both sides",
                            answer: "-2",
                            acceptableAnswers: ["-2", "x = -2", "x=-2"],
                            commonMistakes: {
                                "2": "If x + 2 = 0, then x = 0 - 2 = -2 (subtract, don't keep positive)",
                                "-3": "That's the other solution. From x + 2 = 0, we get x = -2"
                            }
                        },
                        {
                            prompt: "If x + 3 = 0, what is x?",
                            hint: "Subtract 3 from both sides",
                            answer: "-3",
                            acceptableAnswers: ["-3", "x = -3", "x=-3"],
                            commonMistakes: {
                                "3": "If x + 3 = 0, then x = 0 - 3 = -3 (subtract, don't keep positive)",
                                "-2": "That's the other solution. From x + 3 = 0, we get x = -3"
                            }
                        }
                    ]
                },
                practice: { problem: `What are the solutions to (x - 4)(x + 1) = 0?`, answer: "x = 4, x = -1",
                    options: ["x = 4, x = -1", "x = -4, x = 1", "x = 4, x = 1", "x = -4, x = -1"],
                    mistakeAnalysis: {
                        "x = -4, x = 1": "Signs are flipped. x - 4 = 0 ‚Üí x = 4; x + 1 = 0 ‚Üí x = -1",
                        "x = 4, x = 1": "x + 1 = 0 means x = -1, not x = 1",
                        "x = -4, x = -1": "x - 4 = 0 means x = 4, not x = -4"
                    }}
            };
        },
        Logarithms: () => {
            const base = pick([2, 10]);
            const exp = rand(2, 4);
            const result = Math.pow(base, exp);
            return {
                goalProblem: `Find log‚ÇÇ(32)`,
                teachingSteps: [
                    {
                        title: "What is a Logarithm?",
                        explanation: "A <strong>logarithm</strong> answers the question:<br><br><em>\"What EXPONENT do I need?\"</em><br><br>log‚ÇÇ(8) asks: \"2 to WHAT POWER gives me 8?\"",
                        visual: "log = \"What exponent?\""
                    },
                    {
                        title: "The Definition",
                        explanation: "<strong>log_b(x) = y</strong> means <strong>b^y = x</strong><br><br>In words: \"log base b of x equals y\"<br><br>The LOG and EXPONENT forms say the same thing!",
                        visual: "log_b(x) = y ‚Üî b^y = x"
                    },
                    {
                        title: "Example to Build Intuition",
                        explanation: "log‚ÇÇ(8) = ?<br><br>Ask: 2 to what power equals 8?<br>2¬π = 2<br>2¬≤ = 4<br>2¬≥ = <strong>8</strong> ‚úì<br><br>So log‚ÇÇ(8) = <strong>3</strong>",
                        visual: "2¬≥ = 8, so log‚ÇÇ(8) = 3"
                    },
                    {
                        title: "Step 1: Understand What We're Finding",
                        explanation: "log‚ÇÇ(32) asks: \"<strong>2 to what power equals 32?</strong>\"<br><br>We're looking for the exponent.",
                        visual: "2^? = 32"
                    },
                    {
                        title: "Step 2: List Powers of 2",
                        explanation: "Let's calculate powers of 2 until we reach 32:<br><br>2¬π = 2<br>2¬≤ = 4<br>2¬≥ = 8<br>2‚Å¥ = 16<br>2‚Åµ = <strong>32</strong> ‚úì",
                        visual: "2¬π=2, 2¬≤=4, 2¬≥=8, 2‚Å¥=16, 2‚Åµ=32"
                    },
                    {
                        title: "Step 3: Write the Answer",
                        explanation: "Since 2‚Åµ = 32, we know:<br><br><strong>log‚ÇÇ(32) = 5</strong><br><br>The exponent we needed was 5!",
                        visual: "2‚Åµ = 32 ‚Üí log‚ÇÇ(32) = 5"
                    }
                ],
                finalAnswer: "5",
                answerExplanation: "We asked \"2 to what power equals 32?\" and found that 2‚Åµ = 32, so the answer is 5.",
                example: { problem: `Find log‚ÇÇ(32)`, steps: [
                    { text: "Ask: 2 to what power equals 32?", math: "2^? = 32" },
                    { text: "Calculate powers of 2", math: "2¬π=2, 2¬≤=4, 2¬≥=8, 2‚Å¥=16, 2‚Åµ=32" },
                    { text: "2‚Åµ = 32", math: "<strong>log‚ÇÇ(32) = 5</strong>" }
                ]},
                keyPoints: [
                    "log_b(x) asks: 'b to what power equals x?'",
                    "log_b(b) = 1 always (b¬π = b)",
                    "log_b(1) = 0 always (b‚Å∞ = 1)"
                ],
                mistakes: [
                    { wrong: "Thinking log‚ÇÇ(8) = 8 √∑ 2 = 4", why: "Logs aren't division! Ask: 2 to what power = 8? Answer: 3" },
                    { wrong: "Confusing the base and the result", why: "In log‚ÇÇ(8) = 3, the base is 2, the input is 8, the answer is 3" }
                ],
                guided: {
                    problem: `Find log_${base}(${result})`,
                    steps: [
                        { label: `Ask: ${base} to what power = ${result}?`, value: `${base}^? = ${result}` },
                        { label: `${base}^${exp} = ${result}`, value: `So the answer is ${exp}` }
                    ],
                    answer: String(exp),
                    answerLabel: `log_${base}(${result}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `log_${base}(${result}) asks: "${base} to WHAT POWER equals ${result}?" What are we looking for?`,
                            hint: "A logarithm finds the missing exponent",
                            answer: "exponent",
                            acceptableAnswers: ["exponent", "the exponent", "power", "the power"],
                            commonMistakes: {
                                "base": "The base is ${base}. We're looking for the EXPONENT (power).",
                                [String(result)]: `${result} is the result. We need to find what POWER gives us ${result}.`,
                                [String(base)]: `${base} is the base. We need the EXPONENT.`
                            }
                        },
                        {
                            prompt: `What is ${base}¬π?`,
                            hint: "Any number to the power of 1 equals itself",
                            answer: String(base),
                            acceptableAnswers: [String(base)],
                            commonMistakes: {
                                "1": `${base}¬π = ${base}, not 1. Any number to the power of 1 equals itself.`,
                                "0": `${base}‚Å∞ = 1 (zero power). ${base}¬π = ${base}.`
                            }
                        },
                        {
                            prompt: `What is ${base}¬≤?`,
                            hint: `Multiply ${base} √ó ${base}`,
                            answer: String(base * base),
                            acceptableAnswers: [String(base * base)],
                            commonMistakes: {
                                [String(base * 2)]: `That's ${base} √ó 2. We need ${base}¬≤ = ${base} √ó ${base} = ${base * base}`,
                                [String(base + 2)]: `That's ${base} + 2. We need ${base}¬≤ = ${base} √ó ${base} = ${base * base}`
                            }
                        },
                        {
                            prompt: `So ${base}^${exp} = ${result}. What is log_${base}(${result})?`,
                            hint: `We found that ${base} to the power of __ equals ${result}`,
                            answer: String(exp),
                            acceptableAnswers: [String(exp)],
                            commonMistakes: {
                                [String(result)]: `${result} is what we get when we raise ${base} to a power. The answer is the EXPONENT: ${exp}`,
                                [String(base)]: `${base} is the base. The answer is the exponent: ${exp}`,
                                [String(result / base)]: `That's division. Logs find exponents: ${base}^${exp} = ${result}, so log_${base}(${result}) = ${exp}`
                            }
                        }
                    ]
                },
                practice: { problem: `What is log‚ÇÅ‚ÇÄ(1000)?`, answer: "3",
                    options: ["2", "3", "100", "1000"],
                    mistakeAnalysis: {
                        "2": "10¬≤ = 100, not 1000. Try 10¬≥ = 1000, so log‚ÇÅ‚ÇÄ(1000) = 3",
                        "100": "Logs give the exponent, not a division result. 10¬≥ = 1000, so answer is 3",
                        "1000": "That's the input, not the answer. Ask: 10 to what power = 1000?"
                    }}
            };
        },
        Polynomials: () => ({
            goalProblem: `Multiply: (x + 3)(x¬≤ - 2x + 1)`,
            teachingSteps: [
                {
                    title: "What is a Polynomial?",
                    explanation: "A <strong>polynomial</strong> is an expression with variables raised to whole-number powers (0, 1, 2, 3...).<br><br>Examples: 3x¬≤, x¬≥ + 2x - 5, 7",
                    visual: "Polynomial = terms with whole-number exponents"
                },
                {
                    title: "Polynomial Vocabulary",
                    explanation: "‚Ä¢ <strong>Term:</strong> A piece like 3x¬≤ or -5<br>‚Ä¢ <strong>Degree:</strong> Highest exponent (degree of 5x¬≥ + 2x is 3)<br>‚Ä¢ <strong>Leading coefficient:</strong> Number in front of highest term<br>‚Ä¢ <strong>Standard form:</strong> Terms ordered from highest to lowest degree",
                    visual: "5x¬≥ + 2x - 1 ‚Üí degree 3, leading coeff = 5"
                },
                {
                    title: "Multiplying Polynomials: The Distributive Method",
                    explanation: "To multiply polynomials, <strong>distribute</strong> each term in the first polynomial to <strong>every</strong> term in the second.<br><br>Every term times every term!",
                    visual: "(a + b)(c + d + e) = a(c+d+e) + b(c+d+e)"
                },
                {
                    title: "Step 1: Distribute the First Term (x)",
                    explanation: "Multiply <strong>x</strong> by each term in (x¬≤ - 2x + 1):<br><br>x √ó x¬≤ = x¬≥<br>x √ó (-2x) = -2x¬≤<br>x √ó 1 = x<br><br>Result: <strong>x¬≥ - 2x¬≤ + x</strong>",
                    visual: "x(x¬≤ - 2x + 1) = x¬≥ - 2x¬≤ + x"
                },
                {
                    title: "Step 2: Distribute the Second Term (3)",
                    explanation: "Multiply <strong>3</strong> by each term in (x¬≤ - 2x + 1):<br><br>3 √ó x¬≤ = 3x¬≤<br>3 √ó (-2x) = -6x<br>3 √ó 1 = 3<br><br>Result: <strong>3x¬≤ - 6x + 3</strong>",
                    visual: "3(x¬≤ - 2x + 1) = 3x¬≤ - 6x + 3"
                },
                {
                    title: "Step 3: Combine Like Terms",
                    explanation: "Add our results together:<br>x¬≥ - 2x¬≤ + x + 3x¬≤ - 6x + 3<br><br>Combine like terms:<br>x¬≥ + (-2x¬≤ + 3x¬≤) + (x - 6x) + 3<br>= <strong>x¬≥ + x¬≤ - 5x + 3</strong>",
                    visual: "-2x¬≤ + 3x¬≤ = x¬≤ | x - 6x = -5x"
                }
            ],
            finalAnswer: "x¬≥ + x¬≤ - 5x + 3",
            answerExplanation: "We distributed each term and combined like terms: x¬≥ + x¬≤ - 5x + 3.",
            example: { problem: `Multiply: (x + 3)(x¬≤ - 2x + 1)`, steps: [
                { text: "Distribute x", math: "x(x¬≤ - 2x + 1) = x¬≥ - 2x¬≤ + x" },
                { text: "Distribute 3", math: "3(x¬≤ - 2x + 1) = 3x¬≤ - 6x + 3" },
                { text: "Combine like terms", math: "x¬≥ - 2x¬≤ + 3x¬≤ + x - 6x + 3" },
                { text: "Simplify", math: "<strong>x¬≥ + x¬≤ - 5x + 3</strong>" }
            ]},
            keyPoints: [
                "Degree of polynomial = highest exponent",
                "When adding/subtracting, only combine LIKE terms",
                "When multiplying, distribute each term"
            ],
            mistakes: [
                { wrong: "Adding exponents when adding terms: x¬≤ + x¬≤ = x‚Å¥", why: "x¬≤ + x¬≤ = 2x¬≤. Only add COEFFICIENTS, not exponents." },
                { wrong: "Forgetting to distribute to all terms", why: "Every term in the first polynomial must multiply every term in the second." }
            ],
            guided: {
                problem: `Add: (3x¬≤ + 2x - 5) + (x¬≤ - 4x + 3)`,
                steps: [
                    { label: "Combine x¬≤ terms", value: "3x¬≤ + x¬≤ = 4x¬≤" },
                    { label: "Combine x terms", value: "2x + (-4x) = -2x" },
                    { label: "Combine constants", value: "-5 + 3 = -2" },
                    { label: "Final answer", value: "?" }
                ],
                answer: "4x¬≤ - 2x - 2",
                answerLabel: "Sum:",
                interactiveSteps: [
                    {
                        prompt: "When adding polynomials, we combine 'like terms'. What makes terms 'like'?",
                        hint: "They have the same variable raised to the same...",
                        answer: "same variable and exponent",
                        acceptableAnswers: ["same variable and exponent", "same exponent", "same power", "same variable and power"],
                        commonMistakes: {
                            "same coefficient": "Coefficients can be different. Like terms have the same VARIABLE and EXPONENT.",
                            "same sign": "Signs don't matter. Like terms = same variable and exponent (e.g., 3x¬≤ and -5x¬≤)"
                        }
                    },
                    {
                        prompt: "Combine the x¬≤ terms: 3x¬≤ + x¬≤ = ?",
                        hint: "3x¬≤ + 1x¬≤ = (3+1)x¬≤",
                        answer: "4x¬≤",
                        acceptableAnswers: ["4x¬≤", "4x^2"],
                        commonMistakes: {
                            "3x‚Å¥": "Don't add exponents! 3x¬≤ + x¬≤ = (3+1)x¬≤ = 4x¬≤",
                            "4x‚Å¥": "Add coefficients, not exponents: 3 + 1 = 4, so 4x¬≤",
                            "3x¬≤": "Don't forget the x¬≤ from the second polynomial! 3 + 1 = 4"
                        }
                    },
                    {
                        prompt: "Combine the x terms: 2x + (-4x) = ?",
                        hint: "2 + (-4) = 2 - 4 = ?",
                        answer: "-2x",
                        acceptableAnswers: ["-2x", "-2 x"],
                        commonMistakes: {
                            "6x": "2 + (-4) = -2, not 6. When adding a negative, you subtract!",
                            "-6x": "2 + (-4) = 2 - 4 = -2, so the answer is -2x",
                            "2x": "Don't forget the -4x! 2 + (-4) = -2x"
                        }
                    },
                    {
                        prompt: "Combine the constants: -5 + 3 = ?",
                        hint: "Start at -5 and add 3 (move right on number line)",
                        answer: "-2",
                        acceptableAnswers: ["-2"],
                        commonMistakes: {
                            "-8": "That's -5 + (-3). We have -5 + 3 = -2",
                            "8": "-5 + 3 = -2, not +8",
                            "2": "Watch the sign! -5 + 3 = -2 (negative)"
                        }
                    }
                ]
            },
            practice: { problem: `What is the degree of 5x¬≥ - 2x¬≤ + 7x - 1?`, answer: "3",
                options: ["1", "2", "3", "5"],
                mistakeAnalysis: {
                    "1": "The degree is the HIGHEST power, not the lowest. Highest here is x¬≥, so degree = 3",
                    "2": "x¬≤ is not the highest power. Look for x¬≥.",
                    "5": "That's the coefficient of x¬≥. The DEGREE is the exponent: 3"
                }}
        }),
        Probability: () => {
            const favorable = rand(2, 5);
            const total = rand(favorable + 2, 12);
            return {
                goalProblem: `A bag has 3 red and 5 blue marbles. What is P(red)?`,
                teachingSteps: [
                    {
                        title: "What is Probability?",
                        explanation: "<strong>Probability</strong> measures how <strong>likely</strong> something is to happen.<br><br>It answers: \"What are the chances?\"",
                        visual: "Probability = How likely is this event?"
                    },
                    {
                        title: "The Probability Scale",
                        explanation: "Probability is always between <strong>0 and 1</strong>:<br><br>‚Ä¢ <strong>0</strong> = Impossible (will never happen)<br>‚Ä¢ <strong>0.5</strong> = Equally likely (50/50)<br>‚Ä¢ <strong>1</strong> = Certain (will definitely happen)<br><br>You can also use percentages: 0% to 100%",
                        visual: "0 (impossible) ‚Üê‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Üí 1 (certain)"
                    },
                    {
                        title: "The Basic Probability Formula",
                        explanation: "The probability formula is:<br><br><strong>P(event) = Favorable outcomes / Total outcomes</strong><br><br>Favorable = outcomes you WANT<br>Total = ALL possible outcomes",
                        visual: "P = Favorable / Total"
                    },
                    {
                        title: "Step 1: Count Favorable Outcomes",
                        explanation: "We want to pick a <strong>red</strong> marble.<br><br>How many red marbles are there? <strong>3</strong><br><br>Favorable outcomes = 3",
                        visual: "Favorable (red marbles) = 3"
                    },
                    {
                        title: "Step 2: Count Total Outcomes",
                        explanation: "How many marbles are there in total?<br><br>Red + Blue = 3 + 5 = <strong>8</strong> marbles<br><br>Total outcomes = 8",
                        visual: "Total = 3 + 5 = 8 marbles"
                    },
                    {
                        title: "Step 3: Apply the Formula",
                        explanation: "P(red) = Favorable / Total<br><br>P(red) = 3/8<br><br>As a decimal: 3 √∑ 8 = <strong>0.375</strong><br>As a percent: <strong>37.5%</strong>",
                        visual: "P(red) = 3/8 = 0.375 = 37.5%"
                    }
                ],
                finalAnswer: "3/8 or 0.375 or 37.5%",
                answerExplanation: "3 favorable outcomes (red) divided by 8 total outcomes gives us 3/8 = 0.375 = 37.5%.",
                example: { problem: `A bag has 3 red and 5 blue marbles. What is P(red)?`, steps: [
                    { text: "Count favorable outcomes", math: "Red marbles = 3" },
                    { text: "Count total outcomes", math: "Total = 3 + 5 = 8" },
                    { text: "Apply formula", math: "P(red) = 3/8" },
                    { text: "As decimal or percent", math: "<strong>P(red) = 0.375 = 37.5%</strong>" }
                ]},
                keyPoints: [
                    "P(event) = favorable / total",
                    "All probabilities are between 0 and 1 (or 0% and 100%)",
                    "P(not A) = 1 - P(A)"
                ],
                mistakes: [
                    { wrong: "P > 1 or P < 0", why: "Probability is ALWAYS between 0 and 1 (inclusive)." },
                    { wrong: "Using wrong total: P(red) = 3/5", why: "Denominator is ALL outcomes (red + blue = 8), not just one color." }
                ],
                guided: {
                    problem: `A bag has ${favorable} green and ${total - favorable} yellow marbles. What is P(green)?`,
                    steps: [
                        { label: "Favorable outcomes (green)", value: `${favorable}` },
                        { label: "Total outcomes", value: `${favorable} + ${total - favorable} = ${total}` },
                        { label: "P(green) = favorable/total", value: "?" }
                    ],
                    answer: `${favorable}/${total}`,
                    answerLabel: "P(green) = ?",
                    interactiveSteps: [
                        {
                            prompt: "What is the basic probability formula?",
                            hint: "P(event) = something / something else",
                            answer: "favorable/total",
                            acceptableAnswers: ["favorable/total", "favorable / total", "favorable outcomes / total outcomes", "wanted/total"],
                            commonMistakes: {
                                "total/favorable": "It's the other way around! Favorable goes on TOP: favorable / total",
                                "favorable - total": "Probability is a RATIO (division), not subtraction",
                                "favorable + total": "Probability is a RATIO (division), not addition"
                            }
                        },
                        {
                            prompt: `How many favorable outcomes (green marbles) are there?`,
                            hint: "Look at the number of green marbles",
                            answer: String(favorable),
                            acceptableAnswers: [String(favorable)],
                            commonMistakes: {
                                [String(total - favorable)]: `That's the yellow marbles. Green marbles = ${favorable}`,
                                [String(total)]: `That's the total. Favorable (green) = ${favorable}`
                            }
                        },
                        {
                            prompt: `How many TOTAL marbles are in the bag?`,
                            hint: `Add green + yellow: ${favorable} + ${total - favorable} = ?`,
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            commonMistakes: {
                                [String(favorable)]: `That's just the green. Total = green + yellow = ${favorable} + ${total - favorable} = ${total}`,
                                [String(total - favorable)]: `That's just the yellow. Add both: ${favorable} + ${total - favorable} = ${total}`
                            }
                        },
                        {
                            prompt: `Now calculate P(green) = favorable/total = ?`,
                            hint: `${favorable} / ${total} as a fraction`,
                            answer: `${favorable}/${total}`,
                            acceptableAnswers: [`${favorable}/${total}`, `${favorable} / ${total}`],
                            commonMistakes: {
                                [`${total}/${favorable}`]: "Numerator should be favorable, not total. P(green) = favorable/total",
                                [`${total - favorable}/${total}`]: `That's P(yellow)! For green: ${favorable}/${total}`
                            }
                        }
                    ]
                },
                practice: { problem: `You flip a fair coin. What is P(heads)?`, answer: "1/2 or 0.5",
                    options: ["1/2 or 0.5", "1/4", "1", "2"],
                    mistakeAnalysis: {
                        "1/4": "A coin has 2 outcomes (heads, tails), not 4. P(heads) = 1/2",
                        "1": "P = 1 means certain. Heads isn't guaranteed; it's 1 of 2 outcomes.",
                        "2": "Probability is a fraction ‚â§ 1. P(heads) = 1 favorable / 2 total = 1/2"
                    }}
            };
        }
    },
    8: {
        "Trig Functions": () => ({
            goalProblem: `Find sin(180¬∞) and cos(180¬∞)`,
            teachingSteps: [
                {
                    title: "Trig Functions Beyond Triangles",
                    explanation: "In Pre-Calc, we extend trig functions beyond right triangles using the <strong>Unit Circle</strong>.<br><br>This lets us find sin/cos for ANY angle (even negative or greater than 90¬∞)!",
                    visual: "Unit Circle ‚Üí Trig for ALL angles"
                },
                {
                    title: "The Unit Circle",
                    explanation: "The <strong>Unit Circle</strong> is:<br><br>‚Ä¢ A circle with <strong>radius = 1</strong><br>‚Ä¢ Centered at the <strong>origin (0,0)</strong><br>‚Ä¢ Angles measured from the positive x-axis<br>‚Ä¢ Going counter-clockwise = positive angles",
                    visual: "Radius = 1, centered at (0,0)"
                },
                {
                    title: "The Key Insight: Coordinates = sin and cos",
                    explanation: "For any point on the unit circle at angle Œ∏:<br><br>‚Ä¢ <strong>x-coordinate = cos(Œ∏)</strong><br>‚Ä¢ <strong>y-coordinate = sin(Œ∏)</strong><br><br>The point is (cos Œ∏, sin Œ∏)!",
                    visual: "Point = (cos Œ∏, sin Œ∏) ‚Üí cos = x, sin = y"
                },
                {
                    title: "Key Angles to Memorize",
                    explanation: "‚Ä¢ 0¬∞: (1, 0) ‚Üí cos=1, sin=0<br>‚Ä¢ 90¬∞: (0, 1) ‚Üí cos=0, sin=1<br>‚Ä¢ 180¬∞: (-1, 0) ‚Üí cos=-1, sin=0<br>‚Ä¢ 270¬∞: (0, -1) ‚Üí cos=0, sin=-1<br>‚Ä¢ 360¬∞: (1, 0) ‚Üí same as 0¬∞",
                    visual: "0¬∞‚Üí(1,0) | 90¬∞‚Üí(0,1) | 180¬∞‚Üí(-1,0) | 270¬∞‚Üí(0,-1)"
                },
                {
                    title: "Step 1: Locate 180¬∞ on the Unit Circle",
                    explanation: "180¬∞ is halfway around the circle.<br><br>Starting from the positive x-axis and going counter-clockwise 180¬∞, we land on the <strong>negative x-axis</strong>.",
                    visual: "180¬∞ = negative x-axis"
                },
                {
                    title: "Step 2: Find the Point",
                    explanation: "At 180¬∞, the point on the unit circle is:<br><br><strong>(-1, 0)</strong><br><br>(one unit left of center, no units up/down)",
                    visual: "Point at 180¬∞ = (-1, 0)"
                },
                {
                    title: "Step 3: Read sin and cos",
                    explanation: "Point = (cos Œ∏, sin Œ∏) = (-1, 0)<br><br>‚Ä¢ <strong>cos(180¬∞) = -1</strong> (x-coordinate)<br>‚Ä¢ <strong>sin(180¬∞) = 0</strong> (y-coordinate)",
                    visual: "cos(180¬∞) = -1, sin(180¬∞) = 0"
                }
            ],
            finalAnswer: "sin(180¬∞) = 0, cos(180¬∞) = -1",
            answerExplanation: "At 180¬∞ on the unit circle, the point is (-1, 0), so cos = -1 (x-coord) and sin = 0 (y-coord).",
            example: { problem: `Find sin(180¬∞) and cos(180¬∞)`, steps: [
                { text: "Locate 180¬∞ on the unit circle", math: "180¬∞ is on the negative x-axis" },
                { text: "The point is (-1, 0)", math: "(cos 180¬∞, sin 180¬∞) = (-1, 0)" },
                { text: "Read off the values", math: "<strong>sin(180¬∞) = 0, cos(180¬∞) = -1</strong>" }
            ]},
            keyPoints: [
                "sin = y-coordinate, cos = x-coordinate on unit circle",
                "sin and cos repeat every 360¬∞ (they're periodic)",
                "tan Œ∏ = sin Œ∏ / cos Œ∏"
            ],
            mistakes: [
                { wrong: "Confusing sin and cos coordinates", why: "cos = x (horizontal), sin = y (vertical). Think: cos sounds like 'cross' (horizontal)" },
                { wrong: "Forgetting signs in different quadrants", why: "In quadrant II: sin positive, cos negative. Use 'All Students Take Calculus'" }
            ],
            guided: { problem: `What is cos(0¬∞)?`, steps: [
                { label: "0¬∞ is on the positive x-axis", value: "Point: (1, 0)" },
                { label: "cos = x-coordinate", value: "?" }
            ], answer: "1", answerLabel: "cos(0¬∞) = ?",
                interactiveSteps: [
                    {
                        prompt: "Where is 0¬∞ located on the unit circle?",
                        hint: "0¬∞ is the starting point, pointing right...",
                        answer: "positive x-axis",
                        acceptableAnswers: ["positive x-axis", "right", "x-axis", "(1, 0)", "1, 0"],
                        commonMistakes: {
                            "y-axis": "0¬∞ is on the positive x-axis (pointing right). 90¬∞ is on the y-axis.",
                            "origin": "The origin is the center. 0¬∞ is at point (1, 0) on the circle."
                        }
                    },
                    {
                        prompt: "At 0¬∞ on the unit circle, what is the coordinate point (x, y)?",
                        hint: "On the positive x-axis, on a circle with radius 1...",
                        answer: "(1, 0)",
                        acceptableAnswers: ["(1, 0)", "1, 0", "(1,0)"],
                        commonMistakes: {
                            "(0, 1)": "That's 90¬∞. At 0¬∞, we're on the positive x-axis: (1, 0)",
                            "(0, 0)": "That's the center. The point on the circle at 0¬∞ is (1, 0)."
                        }
                    },
                    {
                        prompt: "Cosine equals which coordinate: x or y?",
                        hint: "cos = horizontal, sin = vertical...",
                        answer: "x",
                        acceptableAnswers: ["x", "x-coordinate", "x coordinate"],
                        commonMistakes: {
                            "y": "y is for sine. Cosine = x-coordinate (horizontal)."
                        }
                    },
                    {
                        prompt: "At (1, 0), the x-coordinate is 1. So cos(0¬∞) = ?",
                        hint: "Read the x-coordinate...",
                        answer: "1",
                        acceptableAnswers: ["1"],
                        commonMistakes: {
                            "0": "0 is the y-coordinate (which is sin). cos(0¬∞) = x-coordinate = 1"
                        }
                    }
                ]
            },
            practice: { problem: `What is sin(90¬∞)?`, answer: "1",
                options: ["0", "1", "-1", "‚àö2/2"],
                mistakeAnalysis: {
                    "0": "sin(90¬∞) = 1. You might be thinking of cos(90¬∞) = 0",
                    "-1": "sin(90¬∞) = 1, not -1. sin is negative at 270¬∞.",
                    "‚àö2/2": "That's sin(45¬∞). At 90¬∞, sin = 1."
                }}
        }),
        Limits: () => ({
            goalProblem: `Find: lim (x‚Üí2) (x¬≤ - 4)/(x - 2)`,
            teachingSteps: [
                {
                    title: "What is a Limit?",
                    explanation: "A <strong>limit</strong> describes what value a function <strong>approaches</strong> as x gets closer and closer to some number.<br><br>It's like asking: \"What happens as we get REALLY close to x = 2?\"",
                    visual: "Limit = What value does f(x) approach?"
                },
                {
                    title: "Limit Notation",
                    explanation: "We write: <strong>lim (x‚Üía) f(x) = L</strong><br><br>This means: \"As x approaches a, f(x) approaches L\"<br><br>The arrow ‚Üí means \"approaches\"",
                    visual: "lim (x‚Üía) f(x) = L ‚Üí \"f(x) approaches L as x approaches a\""
                },
                {
                    title: "Method 1: Direct Substitution",
                    explanation: "The simplest approach: just <strong>plug in the value</strong>!<br><br>If you get a normal number, that's the limit!<br><br>If you get 0/0 or ‚àû/‚àû, more work is needed.",
                    visual: "Try plugging in ‚Üí If normal answer, done!"
                },
                {
                    title: "Step 1: Try Direct Substitution",
                    explanation: "Let's plug in x = 2:<br><br>(2¬≤ - 4)/(2 - 2) = (4 - 4)/(0) = <strong>0/0</strong><br><br>Uh oh! 0/0 is called \"indeterminate\" - we need a different approach.",
                    visual: "(4-4)/(2-2) = 0/0 ‚Üí Indeterminate!"
                },
                {
                    title: "What is 0/0?",
                    explanation: "<strong>0/0 is NOT zero or undefined!</strong><br><br>It's \"indeterminate\" - it means the limit might still exist, but we need to simplify first.<br><br>Common fix: <strong>Factor and cancel!</strong>",
                    visual: "0/0 = Indeterminate ‚Üí Try factoring"
                },
                {
                    title: "Step 2: Factor the Numerator",
                    explanation: "x¬≤ - 4 is a \"difference of squares\":<br><br>x¬≤ - 4 = (x + 2)(x - 2)<br><br>So our fraction becomes: <strong>(x+2)(x-2)/(x-2)</strong>",
                    visual: "x¬≤ - 4 = (x+2)(x-2)"
                },
                {
                    title: "Step 3: Cancel Common Factors",
                    explanation: "(x+2)(x-2)/(x-2) = <strong>x + 2</strong><br><br>The (x-2) terms cancel!<br><br>Now we have a simpler function: f(x) = x + 2",
                    visual: "(x+2)(x-2)/(x-2) = x + 2"
                },
                {
                    title: "Step 4: Substitute Again",
                    explanation: "Now we can plug in x = 2:<br><br>lim (x‚Üí2) (x + 2) = 2 + 2 = <strong>4</strong><br><br>The limit is 4!",
                    visual: "x + 2 ‚Üí 2 + 2 = 4"
                }
            ],
            finalAnswer: "4",
            answerExplanation: "After factoring x¬≤ - 4 = (x+2)(x-2) and canceling, we got x + 2. Substituting x = 2 gives us 4.",
            example: { problem: `Find: lim (x‚Üí2) (x¬≤ - 4)/(x - 2)`, steps: [
                { text: "Try direct substitution", math: "(2¬≤ - 4)/(2 - 2) = 0/0 ‚Üê indeterminate!" },
                { text: "Factor the numerator", math: "(x¬≤ - 4) = (x+2)(x-2)" },
                { text: "Cancel common factors", math: "(x+2)(x-2)/(x-2) = x + 2" },
                { text: "Now substitute", math: "lim = 2 + 2 = <strong>4</strong>" }
            ]},
            keyPoints: [
                "If direct substitution works, use it!",
                "0/0 is indeterminate - try factoring or L'H√¥pital's rule",
                "A limit may exist even if f(a) is undefined"
            ],
            mistakes: [
                { wrong: "Thinking 0/0 = 0 or undefined", why: "0/0 is INDETERMINATE - more work needed!" },
                { wrong: "Forgetting to check both sides", why: "For the limit to exist, left and right limits must be equal." }
            ],
            guided: { problem: `Find: lim (x‚Üí3) (x + 5)`, steps: [
                { label: "Try substitution", value: "3 + 5 = ?" },
                { label: "Since it works, the limit is", value: "?" }
            ], answer: "8", answerLabel: "Limit = ?",
                interactiveSteps: [
                    {
                        prompt: "In lim (x‚Üí3) (x + 5), what is x approaching?",
                        hint: "Look at the x‚Üí? notation...",
                        answer: "3",
                        acceptableAnswers: ["3", "x ‚Üí 3"],
                        commonMistakes: {
                            "5": "5 is part of the function. x is approaching 3.",
                            "8": "8 is the answer. x is approaching 3."
                        }
                    },
                    {
                        prompt: "What is the simplest method to try first for finding a limit?",
                        hint: "Just plug in the value...",
                        answer: "direct substitution",
                        acceptableAnswers: ["direct substitution", "substitution", "plug in", "substitute"],
                        commonMistakes: {
                            "factoring": "Try direct substitution first. Only factor if you get 0/0."
                        }
                    },
                    {
                        prompt: "Substitute x = 3 into (x + 5). What is 3 + 5?",
                        hint: "3 plus 5...",
                        answer: "8",
                        acceptableAnswers: ["8"],
                        commonMistakes: {
                            "35": "Add, don't concatenate! 3 + 5 = 8"
                        }
                    },
                    {
                        prompt: "Did we get a normal number (not 0/0 or ‚àû)? So the limit equals?",
                        hint: "Since substitution worked, that's our answer...",
                        answer: "8",
                        acceptableAnswers: ["8", "the limit is 8"],
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `lim (x‚Üí4) 2x = ?`, answer: "8",
                options: ["4", "8", "‚àû", "0"],
                mistakeAnalysis: {
                    "4": "Substitute x = 4 into 2x: 2(4) = 8",
                    "‚àû": "This function doesn't go to infinity at x = 4. Just substitute: 2(4) = 8",
                    "0": "2(4) = 8, not 0. Simple substitution works here."
                }}
        }),
        "Complex Numbers": () => {
            const a = rand(2, 5), b = rand(2, 5);
            return {
                goalProblem: `Simplify: (3 + 2i) + (1 + 4i)`,
                teachingSteps: [
                    {
                        title: "What is an Imaginary Number?",
                        explanation: "You learned that ‚àö(-1) doesn't exist... but mathematicians invented <strong>i</strong> to be the answer!<br><br><strong>i = ‚àö(-1)</strong><br><br>This means <strong>i¬≤ = -1</strong> (the most important fact!).",
                        visual: "i = ‚àö(-1), so i¬≤ = -1"
                    },
                    {
                        title: "What is a Complex Number?",
                        explanation: "A <strong>complex number</strong> has the form:<br><br><strong>a + bi</strong><br><br>‚Ä¢ <strong>a</strong> = the \"real part\"<br>‚Ä¢ <strong>b</strong> = the \"imaginary part\"<br><br>Example: 3 + 2i has real part 3, imaginary part 2",
                        visual: "a + bi ‚Üí a = real, b = imaginary"
                    },
                    {
                        title: "Powers of i",
                        explanation: "The powers of i follow a pattern:<br><br>‚Ä¢ i¬π = i<br>‚Ä¢ i¬≤ = <strong>-1</strong><br>‚Ä¢ i¬≥ = i¬≤ √ó i = -1 √ó i = <strong>-i</strong><br>‚Ä¢ i‚Å¥ = i¬≤ √ó i¬≤ = -1 √ó -1 = <strong>1</strong><br>‚Ä¢ i‚Åµ = i (pattern repeats!)",
                        visual: "i ‚Üí -1 ‚Üí -i ‚Üí 1 ‚Üí (repeats)"
                    },
                    {
                        title: "Adding Complex Numbers",
                        explanation: "To add complex numbers:<br><br>‚Ä¢ Add the <strong>real parts</strong> together<br>‚Ä¢ Add the <strong>imaginary parts</strong> together<br><br>Think of i like a variable - combine like terms!",
                        visual: "(a+bi) + (c+di) = (a+c) + (b+d)i"
                    },
                    {
                        title: "Step 1: Identify Real and Imaginary Parts",
                        explanation: "(3 + 2i) + (1 + 4i)<br><br>First number: real = <strong>3</strong>, imaginary = <strong>2</strong><br>Second number: real = <strong>1</strong>, imaginary = <strong>4</strong>",
                        visual: "3 + 2i: real=3, imag=2 | 1 + 4i: real=1, imag=4"
                    },
                    {
                        title: "Step 2: Add Real Parts",
                        explanation: "Real parts: 3 + 1 = <strong>4</strong>",
                        visual: "3 + 1 = 4"
                    },
                    {
                        title: "Step 3: Add Imaginary Parts",
                        explanation: "Imaginary parts: 2i + 4i = <strong>6i</strong>",
                        visual: "2i + 4i = 6i"
                    },
                    {
                        title: "Step 4: Combine",
                        explanation: "Put them together: <strong>4 + 6i</strong>",
                        visual: "4 + 6i (done!)"
                    }
                ],
                finalAnswer: "4 + 6i",
                answerExplanation: "We added real parts (3+1=4) and imaginary parts (2i+4i=6i) separately to get 4 + 6i.",
                example: { problem: `Simplify: (3 + 2i) + (1 + 4i)`, steps: [
                    { text: "Add real parts", math: "3 + 1 = 4" },
                    { text: "Add imaginary parts", math: "2i + 4i = 6i" },
                    { text: "Combine", math: "<strong>4 + 6i</strong>" }
                ]},
                keyPoints: [
                    "Add/subtract: combine real with real, imaginary with imaginary",
                    "Multiply using FOIL, then use i¬≤ = -1",
                    "The conjugate of a + bi is a - bi"
                ],
                mistakes: [
                    { wrong: "Forgetting i¬≤ = -1 when multiplying", why: "When you get i¬≤, replace it with -1" },
                    { wrong: "Adding real and imaginary: 3 + 2i = 5i", why: "3 and 2i are different types. Keep them separate: 3 + 2i" }
                ],
                guided: { problem: `Simplify: (${a} + ${b}i) - (1 + 2i)`, steps: [
                    { label: "Subtract real parts", value: `${a} - 1 = ${a - 1}` },
                    { label: "Subtract imaginary parts", value: `${b}i - 2i = ${b - 2}i` },
                    { label: "Result", value: "?" }
                ], answer: `${a - 1} + ${b - 2}i`, answerLabel: "Simplified:",
                    interactiveSteps: [
                        {
                            prompt: `In (${a} + ${b}i) - (1 + 2i), what is the real part of the first number?`,
                            hint: "The real part is the number without i...",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            commonMistakes: {
                                [String(b)]: `${b} is the imaginary part (coefficient of i). The real part is ${a}.`
                            }
                        },
                        {
                            prompt: `Subtract the real parts: ${a} - 1 = ?`,
                            hint: `${a} minus 1...`,
                            answer: String(a - 1),
                            acceptableAnswers: [String(a - 1)],
                            commonMistakes: {
                                [String(a + 1)]: `Subtract, not add! ${a} - 1 = ${a - 1}`
                            }
                        },
                        {
                            prompt: `Now subtract the imaginary parts: ${b}i - 2i = ?`,
                            hint: "Subtract the coefficients of i...",
                            answer: `${b - 2}i`,
                            acceptableAnswers: [`${b - 2}i`, String(b - 2) + "i"],
                            commonMistakes: {
                                [String(b - 2)]: `Don't forget the i! ${b}i - 2i = ${b - 2}i`,
                                [`${b + 2}i`]: `Subtract! ${b} - 2 = ${b - 2}, so it's ${b - 2}i`
                            }
                        },
                        {
                            prompt: `Combine the results. The simplified form is:`,
                            hint: `Real part: ${a - 1}, Imaginary part: ${b - 2}i`,
                            answer: `${a - 1} + ${b - 2}i`,
                            acceptableAnswers: [`${a - 1} + ${b - 2}i`, `${a-1}+${b-2}i`, `${a - 1} + ${b-2}i`],
                            commonMistakes: {
                                [String(a - 1 + b - 2)]: "Don't combine real and imaginary parts! Keep them separate: ${a - 1} + ${b - 2}i"
                            }
                        }
                    ]
                },
                practice: { problem: `What is i¬≤?`, answer: "-1",
                    options: ["-1", "1", "i", "-i"],
                    mistakeAnalysis: {
                        "1": "i¬≤ = -1, not 1. i‚Å¥ = 1.",
                        "i": "i¬≤ = -1. We're squaring i, which gives -1 by definition.",
                        "-i": "i¬≤ = -1, not -i. i¬≥ = -i."
                    }}
            };
        }
    },
    9: {
        Derivatives: () => ({
            goalProblem: `Find the derivative of f(x) = 3x¬≤`,
            teachingSteps: [
                {
                    title: "What is a Derivative?",
                    explanation: "A <strong>derivative</strong> measures the <strong>instantaneous rate of change</strong> of a function.<br><br>Think of it as: \"How fast is y changing at this exact moment?\"<br><br>In real life: velocity is the derivative of position!",
                    visual: "Derivative = Rate of change = Slope at a point"
                },
                {
                    title: "Derivative Notation",
                    explanation: "There are several ways to write derivatives:<br><br>‚Ä¢ <strong>f'(x)</strong> - \"f prime of x\"<br>‚Ä¢ <strong>dy/dx</strong> - \"dy over dx\"<br>‚Ä¢ <strong>d/dx[f(x)]</strong> - \"derivative with respect to x\"<br><br>They all mean the same thing!",
                    visual: "f'(x) = dy/dx = d/dx[f(x)]"
                },
                {
                    title: "The Power Rule",
                    explanation: "The most important derivative rule:<br><br><strong>d/dx[x‚Åø] = n ¬∑ x‚Åø‚Åª¬π</strong><br><br>Steps:<br>1. Bring down the exponent as a coefficient<br>2. Subtract 1 from the exponent",
                    visual: "Power Rule: d/dx[x‚Åø] = n¬∑x‚Åø‚Åª¬π"
                },
                {
                    title: "Common Derivatives to Know",
                    explanation: "‚Ä¢ d/dx[c] = <strong>0</strong> (constants become 0)<br>‚Ä¢ d/dx[x] = <strong>1</strong><br>‚Ä¢ d/dx[x¬≤] = <strong>2x</strong><br>‚Ä¢ d/dx[x¬≥] = <strong>3x¬≤</strong>",
                    visual: "Constant ‚Üí 0 | x ‚Üí 1 | x¬≤ ‚Üí 2x | x¬≥ ‚Üí 3x¬≤"
                },
                {
                    title: "Coefficients Multiply Through",
                    explanation: "If there's a coefficient in front, it stays:<br><br><strong>d/dx[c ¬∑ f(x)] = c ¬∑ f'(x)</strong><br><br>The constant just \"goes along for the ride.\"",
                    visual: "d/dx[3x¬≤] = 3 ¬∑ d/dx[x¬≤] = 3 ¬∑ (2x)"
                },
                {
                    title: "Step 1: Apply Power Rule to x¬≤",
                    explanation: "For x¬≤, using power rule:<br><br>‚Ä¢ Bring down exponent 2 as coefficient<br>‚Ä¢ Reduce exponent: 2 - 1 = 1<br><br>d/dx[x¬≤] = 2 ¬∑ x¬π = <strong>2x</strong>",
                    visual: "d/dx[x¬≤] = 2¬∑x¬π = 2x"
                },
                {
                    title: "Step 2: Include the Coefficient 3",
                    explanation: "We had <strong>3</strong>x¬≤, so multiply by 3:<br><br>d/dx[3x¬≤] = 3 ¬∑ 2x = <strong>6x</strong>",
                    visual: "3 ¬∑ 2x = 6x"
                }
            ],
            finalAnswer: "f'(x) = 6x",
            answerExplanation: "Using the power rule on x¬≤ gives 2x, then multiplying by the coefficient 3 gives us 6x.",
            example: { problem: `Find the derivative of f(x) = 3x¬≤`, steps: [
                { text: "Apply the power rule", math: "d/dx[x‚Åø] = n¬∑x‚Åø‚Åª¬π" },
                { text: "Bring down the exponent, reduce power by 1", math: "d/dx[x¬≤] = 2x¬π = 2x" },
                { text: "Don't forget the coefficient", math: "d/dx[3x¬≤] = 3 ¬∑ 2x = <strong>6x</strong>" }
            ]},
            keyPoints: [
                "Power rule: bring down the power, subtract 1 from the exponent",
                "Derivative of a constant is 0",
                "Constants multiply through: d/dx[cf(x)] = c ¬∑ f'(x)"
            ],
            mistakes: [
                { wrong: "d/dx[x¬≤] = x (forgetting to bring down the power)", why: "You must multiply by the old exponent: 2¬∑x¬π = 2x" },
                { wrong: "d/dx[5] = 5 (derivative of a constant)", why: "The derivative of any constant is 0!" }
            ],
            guided: {
                problem: `Find the derivative of f(x) = 4x¬≥`,
                steps: [
                    { label: "Apply power rule to x¬≥", value: "3x¬≤" },
                    { label: "Multiply by coefficient 4", value: "?" }
                ],
                answer: "12x¬≤",
                answerLabel: "f'(x) = ?",
                interactiveSteps: [
                    {
                        prompt: "What is the Power Rule formula?",
                        hint: "d/dx[x‚Åø] = ...",
                        answer: "n¬∑x‚Åø‚Åª¬π",
                        acceptableAnswers: ["n¬∑x‚Åø‚Åª¬π", "nx‚Åø‚Åª¬π", "n*x^(n-1)", "n times x to the n-1"],
                        commonMistakes: {
                            "x‚Åø‚Åª¬π": "You forgot to bring down the exponent as a coefficient! It's n¬∑x‚Åø‚Åª¬π",
                            "n¬∑x‚Åø": "Close! But you need to SUBTRACT 1 from the exponent: n¬∑x‚Åø‚Åª¬π",
                            "x‚Åø‚Å∫¬π/(n+1)": "That's the integral rule! Derivative uses n¬∑x‚Åø‚Åª¬π"
                        }
                    },
                    {
                        prompt: "Apply power rule to x¬≥: bring down the 3 and reduce the power. What do you get?",
                        hint: "3 √ó x^(3-1) = ?",
                        answer: "3x¬≤",
                        acceptableAnswers: ["3x¬≤", "3x^2", "3 x¬≤"],
                        commonMistakes: {
                            "x¬≤": "Don't forget to bring down the exponent! 3¬∑x¬≤ = 3x¬≤",
                            "3x¬≥": "You need to REDUCE the exponent by 1: x¬≥‚Åª¬π = x¬≤",
                            "x¬≥": "Apply the power rule: bring down 3, reduce power: 3x¬≤"
                        }
                    },
                    {
                        prompt: "Now multiply by the coefficient 4: 4 √ó 3x¬≤ = ?",
                        hint: "Multiply the coefficients: 4 √ó 3 = ?",
                        answer: "12x¬≤",
                        acceptableAnswers: ["12x¬≤", "12x^2"],
                        commonMistakes: {
                            "7x¬≤": "You added 4 + 3 instead of multiplying. 4 √ó 3 = 12, so 12x¬≤",
                            "3x¬≤": "Don't forget to multiply by the original coefficient 4! 4 √ó 3x¬≤ = 12x¬≤",
                            "4x¬≤": "You dropped the 3. Multiply: 4 √ó 3 = 12, so answer is 12x¬≤"
                        }
                    }
                ]
            },
            practice: { problem: `What is d/dx[x‚Åµ]?`, answer: "5x‚Å¥",
                options: ["x‚Å¥", "5x‚Å¥", "5x‚Åµ", "x‚Åµ"],
                mistakeAnalysis: {
                    "x‚Å¥": "Don't forget to multiply by the exponent! 5¬∑x‚Å¥",
                    "5x‚Åµ": "You need to REDUCE the exponent by 1: 5x‚Å¥",
                    "x‚Åµ": "Apply the power rule: bring down 5, reduce power to 4"
                }}
        }),
        Integrals: () => ({
            goalProblem: `Find ‚à´x¬≤ dx`,
            teachingSteps: [
                {
                    title: "What is an Integral?",
                    explanation: "An <strong>integral</strong> (or antiderivative) is the <strong>reverse of a derivative</strong>.<br><br>If the derivative answers \"what's the slope?\", the integral answers \"what function has this slope?\"",
                    visual: "Integral = Reverse of derivative = Antiderivative"
                },
                {
                    title: "Integral Notation",
                    explanation: "We write integrals as: <strong>‚à´ f(x) dx</strong><br><br>‚Ä¢ <strong>‚à´</strong> - the integral symbol (stretched S for \"sum\")<br>‚Ä¢ <strong>f(x)</strong> - the function we're integrating<br>‚Ä¢ <strong>dx</strong> - tells us the variable",
                    visual: "‚à´ f(x) dx"
                },
                {
                    title: "The Power Rule for Integration",
                    explanation: "The reverse of the derivative power rule:<br><br><strong>‚à´x‚Åø dx = x‚Åø‚Å∫¬π/(n+1) + C</strong><br><br>Steps:<br>1. Add 1 to the exponent<br>2. Divide by the new exponent<br>3. Add +C",
                    visual: "‚à´x‚Åø dx = x‚Åø‚Å∫¬π/(n+1) + C"
                },
                {
                    title: "What is +C?",
                    explanation: "The <strong>+C</strong> is the \"constant of integration\".<br><br>Why? Because the derivative of ANY constant is 0!<br><br>So x¬≤ + 5 and x¬≤ + 100 both have derivative 2x. The +C accounts for this.",
                    visual: "d/dx[x¬≤ + 5] = 2x | d/dx[x¬≤ + 100] = 2x ‚Üí +C"
                },
                {
                    title: "Step 1: Add 1 to the Exponent",
                    explanation: "We're integrating x¬≤.<br><br>Current exponent: 2<br>New exponent: 2 + 1 = <strong>3</strong>",
                    visual: "2 + 1 = 3"
                },
                {
                    title: "Step 2: Divide by the New Exponent",
                    explanation: "Take x to the new power, divided by that power:<br><br><strong>x¬≥/3</strong>",
                    visual: "x¬≥ / 3"
                },
                {
                    title: "Step 3: Add +C",
                    explanation: "Don't forget the constant of integration!<br><br>Final answer: <strong>x¬≥/3 + C</strong>",
                    visual: "x¬≥/3 + C"
                }
            ],
            finalAnswer: "x¬≥/3 + C",
            answerExplanation: "We added 1 to the exponent (2‚Üí3), divided by 3, and added +C for the constant of integration.",
            example: { problem: `Find ‚à´x¬≤ dx`, steps: [
                { text: "Add 1 to the exponent", math: "2 + 1 = 3" },
                { text: "Divide by new exponent", math: "x¬≥/3" },
                { text: "Add constant of integration", math: "<strong>x¬≥/3 + C</strong>" }
            ]},
            keyPoints: [
                "Integration is the reverse of differentiation",
                "Add 1 to exponent, divide by new exponent",
                "Always include +C for indefinite integrals"
            ],
            mistakes: [
                { wrong: "Forgetting +C", why: "Indefinite integrals always have +C because the derivative of any constant is 0" },
                { wrong: "Using the wrong formula: subtracting from exponent", why: "That's derivatives! For integrals, ADD to exponent." }
            ],
            guided: {
                problem: `Find ‚à´x¬≥ dx`,
                steps: [
                    { label: "Add 1 to exponent: 3 + 1", value: "4" },
                    { label: "Divide by new exponent", value: "x‚Å¥/4" },
                    { label: "Add constant", value: "?" }
                ],
                answer: "x‚Å¥/4 + C",
                answerLabel: "‚à´x¬≥ dx = ?",
                interactiveSteps: [
                    {
                        prompt: "For integrals, what do we do to the exponent first?",
                        hint: "It's the opposite of derivatives...",
                        answer: "add 1",
                        acceptableAnswers: ["add 1", "add one", "+1", "increase by 1"],
                        commonMistakes: {
                            "subtract 1": "That's for derivatives! Integrals ADD 1 to the exponent.",
                            "multiply": "No, we ADD 1 to the exponent (opposite of derivatives)",
                            "divide": "We divide AFTER increasing the exponent. First step is add 1."
                        }
                    },
                    {
                        prompt: "Add 1 to the exponent: 3 + 1 = ?",
                        hint: "Simple addition: 3 + 1",
                        answer: "4",
                        acceptableAnswers: ["4"],
                        commonMistakes: {
                            "2": "You subtracted! For integrals, ADD: 3 + 1 = 4",
                            "3": "You need to add 1: 3 + 1 = 4"
                        }
                    },
                    {
                        prompt: "Now divide by the new exponent: x‚Å¥/? What goes in the denominator?",
                        hint: "We divide by the NEW exponent (the one we just calculated)",
                        answer: "4",
                        acceptableAnswers: ["4"],
                        commonMistakes: {
                            "3": "Use the NEW exponent (4), not the old one (3)",
                            "5": "The new exponent is 4 (we added 1 to 3), so divide by 4"
                        }
                    },
                    {
                        prompt: "What must we always add at the end of an indefinite integral?",
                        hint: "It accounts for any constant that disappears during differentiation...",
                        answer: "+ C",
                        acceptableAnswers: ["+ C", "+C", "C", "plus C", "constant", "+c", "+ c"],
                        commonMistakes: {
                            "0": "We add +C, not 0. This is the constant of integration.",
                            "nothing": "Don't forget +C! It represents any constant."
                        }
                    }
                ]
            },
            practice: { problem: `What is ‚à´2x dx?`, answer: "x¬≤ + C",
                options: ["x¬≤ + C", "2x¬≤ + C", "x + C", "2 + C"],
                mistakeAnalysis: {
                    "2x¬≤ + C": "You forgot to divide by the new exponent! 2 ¬∑ (x¬≤/2) = x¬≤",
                    "x + C": "You took the derivative instead of integral. ‚à´2x dx = x¬≤ + C",
                    "2 + C": "That would be the integral of 0. ‚à´2x dx means antiderivative of 2x."
                }}
        }),
        Applications: () => ({
            goalProblem: `Find the critical points of f(x) = x¬≤ - 4x + 3`,
            teachingSteps: [
                {
                    title: "Why Are Derivatives Useful?",
                    explanation: "Derivatives help us find:<br><br>‚Ä¢ <strong>Maximum and minimum values</strong> of functions<br>‚Ä¢ <strong>Where things are increasing or decreasing</strong><br>‚Ä¢ <strong>Velocity and acceleration</strong> from position",
                    visual: "Derivatives ‚Üí Find max/min, motion, rates"
                },
                {
                    title: "What Are Critical Points?",
                    explanation: "<strong>Critical points</strong> are where a function might have a max or min.<br><br>They occur where:<br>‚Ä¢ <strong>f'(x) = 0</strong> (slope is flat)<br>‚Ä¢ <strong>f'(x) is undefined</strong>",
                    visual: "Critical points: where f'(x) = 0 or undefined"
                },
                {
                    title: "Finding Max/Min: The Process",
                    explanation: "Steps to find max/min:<br><br>1. Find the derivative f'(x)<br>2. Set f'(x) = 0 and solve<br>3. Use second derivative test to classify",
                    visual: "f'(x) ‚Üí set = 0 ‚Üí solve ‚Üí test"
                },
                {
                    title: "The Second Derivative Test",
                    explanation: "To determine if a critical point is a max or min:<br><br>‚Ä¢ <strong>f''(x) > 0</strong> ‚Üí Minimum (concave UP, like a cup)<br>‚Ä¢ <strong>f''(x) < 0</strong> ‚Üí Maximum (concave DOWN, like a frown)",
                    visual: "f'' > 0: minimum ‚à™ | f'' < 0: maximum ‚à©"
                },
                {
                    title: "Step 1: Find the Derivative",
                    explanation: "For f(x) = x¬≤ - 4x + 3:<br><br>f'(x) = 2x - 4<br><br>(Using power rule: derivative of x¬≤ is 2x, derivative of -4x is -4, derivative of 3 is 0)",
                    visual: "f'(x) = 2x - 4"
                },
                {
                    title: "Step 2: Set the Derivative Equal to 0",
                    explanation: "To find critical points, solve f'(x) = 0:<br><br>2x - 4 = 0",
                    visual: "2x - 4 = 0"
                },
                {
                    title: "Step 3: Solve for x",
                    explanation: "2x - 4 = 0<br>2x = 4<br>x = <strong>2</strong><br><br>The critical point is at x = 2!",
                    visual: "2x = 4 ‚Üí x = 2"
                },
                {
                    title: "Bonus: Is It a Max or Min?",
                    explanation: "f''(x) = 2 (derivative of 2x - 4)<br><br>Since f''(2) = 2 > 0, this is a <strong>minimum</strong>!<br><br>The point (2, f(2)) = (2, -1) is a minimum.",
                    visual: "f''(2) = 2 > 0 ‚Üí Minimum at x = 2"
                }
            ],
            finalAnswer: "x = 2",
            answerExplanation: "We found f'(x) = 2x - 4, set it to 0, and solved to get x = 2. This is a minimum since f''(x) > 0.",
            example: { problem: `Find the critical points of f(x) = x¬≤ - 4x + 3`, steps: [
                { text: "Find the derivative", math: "f'(x) = 2x - 4" },
                { text: "Set derivative equal to 0", math: "2x - 4 = 0" },
                { text: "Solve for x", math: "x = 2" },
                { text: "This is a critical point at x = 2", math: "" }
            ]},
            keyPoints: [
                "Critical points occur where f'(x) = 0 or undefined",
                "Second derivative test: f''(x) > 0 is min, f''(x) < 0 is max",
                "Velocity = dx/dt, Acceleration = dv/dt"
            ],
            mistakes: [
                { wrong: "Forgetting to set the derivative to 0", why: "Max/min occur at critical points where f'(x) = 0" },
                { wrong: "Confusing max and min in second derivative test", why: "Positive second derivative = concave up = minimum" }
            ],
            guided: { problem: `If position s(t) = t¬≥, what is velocity v(t)?`, steps: [
                { label: "Velocity is derivative of position", value: "v(t) = s'(t)" },
                { label: "Apply power rule to t¬≥", value: "?" }
            ], answer: "3t¬≤", answerLabel: "v(t) = ?",
                interactiveSteps: [
                    {
                        prompt: "Velocity is the _______ of position.",
                        hint: "Velocity measures how position changes over time...",
                        answer: "derivative",
                        acceptableAnswers: ["derivative", "rate of change", "slope"],
                        commonMistakes: {
                            "integral": "Integral goes the opposite direction! Velocity = derivative of position.",
                            "position": "Velocity is the DERIVATIVE of position."
                        }
                    },
                    {
                        prompt: "So we need to find s'(t) where s(t) = t¬≥. What rule do we use?",
                        hint: "For x‚Åø, we bring down the exponent...",
                        answer: "power rule",
                        acceptableAnswers: ["power rule", "the power rule"],
                        commonMistakes: {
                            "chain rule": "No composition here. Just use power rule: bring down the exponent.",
                            "product rule": "There's only one term. Use power rule: d/dx[x‚Åø] = nx‚Åø‚Åª¬π"
                        }
                    },
                    {
                        prompt: "Using the power rule on t¬≥: bring down the exponent. What is the coefficient?",
                        hint: "The exponent is 3, bring it in front...",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        commonMistakes: {
                            "2": "Bring down the original exponent (3), not one less."
                        }
                    },
                    {
                        prompt: "Now reduce the exponent by 1: t¬≥ becomes t^?",
                        hint: "3 - 1 = ?",
                        answer: "2",
                        acceptableAnswers: ["2", "t¬≤"],
                        commonMistakes: {
                            "3": "Reduce by 1: 3 - 1 = 2"
                        }
                    },
                    {
                        prompt: "So v(t) = s'(t) = ?",
                        hint: "Coefficient is 3, power is 2...",
                        answer: "3t¬≤",
                        acceptableAnswers: ["3t¬≤", "3t^2", "3t2"],
                        commonMistakes: {
                            "t¬≥": "That's the original. The derivative is 3t¬≤.",
                            "3t¬≥": "Remember to reduce the exponent by 1. It's 3t¬≤, not 3t¬≥."
                        }
                    }
                ]
            },
            practice: { problem: `Where does f(x) = x¬≤ have a minimum?`, answer: "x = 0",
                options: ["x = 0", "x = 1", "x = -1", "No minimum"],
                mistakeAnalysis: {
                    "x = 1": "Find f'(x) = 2x. Set 2x = 0, so x = 0",
                    "x = -1": "f'(x) = 2x = 0 when x = 0, not -1",
                    "No minimum": "The parabola x¬≤ opens upward, so it has a minimum at x = 0"
                }}
        })
    },
    10: {
        Matrices: () => ({
            goalProblem: `Add: [1 2] + [5 6]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[3 4] &nbsp;&nbsp; [7 8]`,
            teachingSteps: [
                {
                    title: "What is a Matrix?",
                    explanation: "A <strong>matrix</strong> is a rectangular grid of numbers arranged in <strong>rows</strong> (horizontal) and <strong>columns</strong> (vertical).<br><br>Think of it like a spreadsheet or table of numbers!",
                    visual: "Matrix = Grid of numbers in rows and columns"
                },
                {
                    title: "Matrix Dimensions",
                    explanation: "We describe matrix size as <strong>m √ó n</strong>:<br><br>‚Ä¢ <strong>m</strong> = number of rows<br>‚Ä¢ <strong>n</strong> = number of columns<br><br>A 2√ó3 matrix has 2 rows and 3 columns.",
                    visual: "m √ó n = rows √ó columns"
                },
                {
                    title: "Matrix Addition",
                    explanation: "To add matrices:<br><br>‚Ä¢ They <strong>MUST be the same size</strong><br>‚Ä¢ Add <strong>corresponding elements</strong> (same position)<br><br>Just add each cell to the cell in the same position!",
                    visual: "[a b] + [e f] = [a+e  b+f]"
                },
                {
                    title: "Our Problem",
                    explanation: "We're adding two 2√ó2 matrices:<br><br>[1 2] + [5 6]<br>[3 4] &nbsp;&nbsp; [7 8]<br><br>Both are 2√ó2, so we can add them!",
                    visual: "Both 2√ó2 ‚Üí Addition is possible"
                },
                {
                    title: "Step 1: Add First Row Elements",
                    explanation: "Top-left: 1 + 5 = <strong>6</strong><br>Top-right: 2 + 6 = <strong>8</strong><br><br>First row of result: [6  8]",
                    visual: "Row 1: [1+5, 2+6] = [6, 8]"
                },
                {
                    title: "Step 2: Add Second Row Elements",
                    explanation: "Bottom-left: 3 + 7 = <strong>10</strong><br>Bottom-right: 4 + 8 = <strong>12</strong><br><br>Second row of result: [10  12]",
                    visual: "Row 2: [3+7, 4+8] = [10, 12]"
                },
                {
                    title: "Final Result",
                    explanation: "Putting it together:<br><br>[6 &nbsp;&nbsp;8]<br>[10 12]",
                    visual: "Result: [6 8; 10 12]"
                }
            ],
            finalAnswer: "[6 8; 10 12]",
            answerExplanation: "We added corresponding elements: top row (1+5, 2+6) = (6, 8), bottom row (3+7, 4+8) = (10, 12).",
            example: { problem: `Add: [1 2] + [5 6]\n      [3 4]   [7 8]`, steps: [
                { text: "Add corresponding elements", math: "[1+5  2+6] = [6  8]" },
                { text: "Continue for second row", math: "[3+7  4+8] = [10 12]" },
                { text: "Result", math: "<strong>[6 8; 10 12]</strong>" }
            ]},
            keyPoints: [
                "Matrix addition requires SAME dimensions",
                "For multiplication AB: columns of A must equal rows of B",
                "Matrix multiplication is NOT commutative: AB ‚â† BA"
            ],
            mistakes: [
                { wrong: "Adding matrices of different sizes", why: "Matrices must be the same size to add them." },
                { wrong: "Thinking AB = BA", why: "Matrix multiplication is NOT commutative. Order matters!" }
            ],
            guided: { problem: `Multiply: 3 √ó [2 4]\n            [1 5]`, steps: [
                { label: "Multiply each element by 3", value: "[3¬∑2  3¬∑4] = [6 12]" },
                { label: "Second row", value: "[3¬∑1  3¬∑5] = ?" }
            ], answer: "[3 15]", answerLabel: "Second row:",
                interactiveSteps: [
                    {
                        prompt: "When multiplying a matrix by a scalar (single number), what do we do to each element?",
                        hint: "Scalar multiplication distributes to every element...",
                        answer: "multiply each element by the scalar",
                        acceptableAnswers: ["multiply each element by the scalar", "multiply each element", "multiply each by 3", "multiply all by 3"],
                        commonMistakes: {
                            "add 3": "Scalar MULTIPLICATION means multiply each element by the scalar."
                        }
                    },
                    {
                        prompt: "First row: 3 √ó 2 = ?",
                        hint: "3 times 2...",
                        answer: "6",
                        acceptableAnswers: ["6"],
                        commonMistakes: {
                            "5": "Add? No, multiply! 3 √ó 2 = 6"
                        }
                    },
                    {
                        prompt: "First row: 3 √ó 4 = ?",
                        hint: "3 times 4...",
                        answer: "12",
                        acceptableAnswers: ["12"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "Second row: 3 √ó 1 = ?",
                        hint: "3 times 1...",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "Second row: 3 √ó 5 = ?",
                        hint: "3 times 5...",
                        answer: "15",
                        acceptableAnswers: ["15"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "So the second row of the result is [? ?]",
                        hint: "We got 3 √ó 1 = 3 and 3 √ó 5 = 15...",
                        answer: "[3 15]",
                        acceptableAnswers: ["[3 15]", "[3, 15]", "3 15", "3, 15"],
                        commonMistakes: {
                            "[6 12]": "That's the first row! Second row is [3 15]"
                        }
                    }
                ]
            },
            practice: { problem: `What are the dimensions of a matrix with 3 rows and 2 columns?`, answer: "3 √ó 2",
                options: ["3 √ó 2", "2 √ó 3", "6", "5"],
                mistakeAnalysis: {
                    "2 √ó 3": "Rows come FIRST: 3 rows √ó 2 columns = 3 √ó 2",
                    "6": "That's the total number of elements. Dimensions are written as rows √ó columns.",
                    "5": "That's 3 + 2. Dimensions are 3 √ó 2 (rows √ó columns)."
                }}
        }),
        Series: () => ({
            goalProblem: `Find the sum: 1 + 2 + 3 + ... + 100`,
            teachingSteps: [
                {
                    title: "What is a Series?",
                    explanation: "A <strong>series</strong> is the <strong>sum</strong> of the terms in a sequence.<br><br>Sequence: 1, 2, 3, 4, 5<br>Series: 1 + 2 + 3 + 4 + 5 = 15",
                    visual: "Series = Sum of a sequence"
                },
                {
                    title: "Two Types of Series",
                    explanation: "<strong>Arithmetic Series:</strong> constant DIFFERENCE between terms<br>Example: 2, 5, 8, 11 (adding 3 each time)<br><br><strong>Geometric Series:</strong> constant RATIO between terms<br>Example: 2, 6, 18, 54 (multiplying by 3 each time)",
                    visual: "Arithmetic: +d each time | Geometric: √ór each time"
                },
                {
                    title: "Arithmetic Series Formula",
                    explanation: "For an arithmetic series:<br><br><strong>Sum = (n/2) √ó (first + last)</strong><br><br>Where n = number of terms<br><br>This formula is super fast for long series!",
                    visual: "Sum = (n/2)(first + last)"
                },
                {
                    title: "Our Problem: 1 + 2 + 3 + ... + 100",
                    explanation: "This is arithmetic (adding 1 each time).<br><br>‚Ä¢ First term: <strong>1</strong><br>‚Ä¢ Last term: <strong>100</strong><br>‚Ä¢ Number of terms (n): <strong>100</strong>",
                    visual: "First = 1, Last = 100, n = 100"
                },
                {
                    title: "Step 1: Set Up the Formula",
                    explanation: "Sum = (n/2) √ó (first + last)<br><br>Sum = (100/2) √ó (1 + 100)",
                    visual: "Sum = (100/2) √ó (1 + 100)"
                },
                {
                    title: "Step 2: Simplify",
                    explanation: "Sum = 50 √ó 101<br><br>(100 √∑ 2 = 50, and 1 + 100 = 101)",
                    visual: "50 √ó 101"
                },
                {
                    title: "Step 3: Calculate",
                    explanation: "50 √ó 101 = <strong>5050</strong><br><br>So the sum of all numbers from 1 to 100 is 5050!<br><br>(This is called a \"triangular number\")",
                    visual: "50 √ó 101 = 5050"
                }
            ],
            finalAnswer: "5050",
            answerExplanation: "Using the formula (n/2)(first + last) = (100/2)(1 + 100) = 50 √ó 101 = 5050.",
            example: { problem: `Find the sum: 1 + 2 + 3 + ... + 100`, steps: [
                { text: "This is an arithmetic series", math: "First = 1, Last = 100, n = 100 terms" },
                { text: "Use the formula", math: "Sum = n/2 √ó (first + last)" },
                { text: "Calculate", math: "Sum = 100/2 √ó (1 + 100) = 50 √ó 101" },
                { text: "Result", math: "<strong>5050</strong>" }
            ]},
            keyPoints: [
                "Arithmetic: constant difference between terms",
                "Geometric: constant RATIO between terms",
                "Infinite geometric series converge only if |r| < 1"
            ],
            mistakes: [
                { wrong: "Using geometric formula for arithmetic series", why: "Check the pattern: +d (arithmetic) or √ór (geometric)?" },
                { wrong: "Forgetting that infinite series need |r| < 1", why: "If |r| ‚â• 1, the series diverges (sum is infinite)." }
            ],
            guided: { problem: `Sum the arithmetic series: 2 + 4 + 6 + 8 + 10`, steps: [
                { label: "Number of terms", value: "5" },
                { label: "First = 2, Last = 10", value: "Sum = 5/2 √ó (2 + 10)" },
                { label: "Calculate", value: "?" }
            ], answer: "30", answerLabel: "Sum = ?",
                interactiveSteps: [
                    {
                        prompt: "What type of series is 2 + 4 + 6 + 8 + 10? (constant difference or constant ratio)",
                        hint: "Each term is +2 from the previous...",
                        answer: "arithmetic",
                        acceptableAnswers: ["arithmetic", "constant difference", "arithmetic series"],
                        commonMistakes: {
                            "geometric": "Geometric has constant ratio. This has constant difference (+2), so it's arithmetic."
                        }
                    },
                    {
                        prompt: "How many terms are in this series?",
                        hint: "Count them: 2, 4, 6, 8, 10...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "10": "10 is the last term, not the count. There are 5 terms."
                        }
                    },
                    {
                        prompt: "What is the first term?",
                        hint: "The series starts with...",
                        answer: "2",
                        acceptableAnswers: ["2"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "What is the last term?",
                        hint: "The series ends with...",
                        answer: "10",
                        acceptableAnswers: ["10"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "The arithmetic series formula is Sum = (n/2) √ó (first + last). Calculate: (5/2) √ó (2 + 10) = ?",
                        hint: "5/2 = 2.5, and 2 + 10 = 12. What is 2.5 √ó 12?",
                        answer: "30",
                        acceptableAnswers: ["30"],
                        commonMistakes: {
                            "12": "12 is first + last. You still need to multiply by n/2 = 2.5. 2.5 √ó 12 = 30",
                            "60": "You used n instead of n/2. Sum = (5/2) √ó 12 = 2.5 √ó 12 = 30"
                        }
                    }
                ]
            },
            practice: { problem: `For the geometric series 1 + 1/2 + 1/4 + 1/8 + ..., what does the infinite sum approach?`, answer: "2",
                options: ["1", "2", "‚àû", "1.5"],
                mistakeAnalysis: {
                    "1": "Sum = a‚ÇÅ/(1-r) = 1/(1-0.5) = 1/0.5 = 2",
                    "‚àû": "Since |r| = 0.5 < 1, this series CONVERGES to 2",
                    "1.5": "Sum = 1/(1-0.5) = 1/0.5 = 2"
                }}
        })
    }
};

// Generate lesson for any tier/skill (falls back to basic template)
function generateLesson(tier, skill) {
    if (lessons[tier] && lessons[tier][skill]) {
        return lessons[tier][skill]();
    }
    // No generic fallback - all lessons must be explicitly defined with proper steps
    console.warn(`Lesson not found: Tier ${tier}, Skill: ${skill}`);
    return null;
}

// ========================================
// GENERATE QUESTION
// ========================================
function generateQuestion(tier, domain = null) {
    const tierGens = generators[tier];
    if (!tierGens) return null;
    
    const domains = Object.keys(tierGens);
    const selectedDomain = domain && tierGens[domain] ? domain : pick(domains);
    const generator = tierGens[selectedDomain];
    
    const q = generator();
    q.tier = tier;
    q.domain = selectedDomain;
    q.type = q.type || "procedural";
    q.timeExpected = tier <= 2 ? 15 : tier <= 4 ? 20 : tier <= 6 ? 25 : tier <= 8 ? 30 : 35;
    
    // Generate options if not provided
    if (!q.options) {
        if (typeof q.answer === "number") {
            const distractors = generateDistractors(q.answer);
            q.options = shuffle([q.answer, ...distractors]);
            q.answerIndex = q.options.indexOf(q.answer);
        } else {
            q.options = [q.answer, ...generateDistractors(0, 3).map(d => `${d}`)];
            q.answerIndex = 0;
            q.options = shuffle(q.options);
            q.answerIndex = q.options.indexOf(q.answer);
        }
    } else {
        q.answerIndex = q.options.findIndex(o => o == q.answer || o === q.answer);
        if (q.answerIndex === -1) q.answerIndex = 0;
    }
    
    return q;
}

// ========================================
// STATE & UI MANAGEMENT
// ========================================
let state = { mode: null, currentTier: 5, selectedTiers: [], history: [], tierScores: {}, domainScores: {}, gapLog: [], currentQuestion: null, selectedAnswer: null, startTime: null, timerInterval: null, elapsedTime: 0, consecutiveCorrect: 0, consecutiveWrong: 0, currentStreak: 0, probeMode: false, 
    // Learning Center state
    learningTier: 1, learningSkill: null, learningPhase: 'learn', currentLesson: null, guidedStep: 0, practiceAttempts: 0
};

function initTierGrid() {
    const grid = document.getElementById('tier-selection-grid');
    grid.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const div = document.createElement('div');
        div.className = 'tier-option';
        div.setAttribute('data-tier', t);
        div.onclick = () => toggleTier(t);
        div.innerHTML = `<div class="tier-checkbox"></div><div><div class="tier-name">Tier ${t}: ${TIERS[t].name}</div><div class="tier-grades">Grades ${TIERS[t].grades}</div></div>`;
        grid.appendChild(div);
    }
}
initTierGrid();

function selectMode(mode) {
    state.mode = mode;
    document.getElementById('mode-screen').classList.remove('active');
    if (mode === 'placement') {
        document.getElementById('placement-setup-screen').classList.add('active');
    } else if (mode === 'testing') {
        document.getElementById('testing-setup-screen').classList.add('active');
    } else if (mode === 'learning') {
        initLearningSetup();
        document.getElementById('learning-setup-screen').classList.add('active');
    }
}

function goToModeSelect() {
    resetState();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('mode-screen').classList.add('active');
}

function resetState() {
    state = { mode: null, currentTier: 5, selectedTiers: [], history: [], tierScores: {}, domainScores: {}, gapLog: [], currentQuestion: null, selectedAnswer: null, startTime: null, timerInterval: null, elapsedTime: 0, consecutiveCorrect: 0, consecutiveWrong: 0, currentStreak: 0, probeMode: false,
        learningTier: 1, learningSkill: null, learningPhase: 'learn', currentLesson: null, guidedStep: 0, practiceAttempts: 0
    };
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.tier-option').forEach(o => o.classList.remove('selected'));
    document.getElementById('start-placement-btn').disabled = true;
    document.getElementById('start-testing-btn').disabled = true;
}

function selectLevel(el, tier) {
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    state.currentTier = tier;
    document.getElementById('start-placement-btn').disabled = false;
}

function toggleTier(tier) {
    const opt = document.querySelector(`.tier-option[data-tier="${tier}"]`);
    const idx = state.selectedTiers.indexOf(tier);
    if (idx > -1) { state.selectedTiers.splice(idx, 1); opt.classList.remove('selected'); }
    else { state.selectedTiers.push(tier); opt.classList.add('selected'); }
    document.getElementById('start-testing-btn').disabled = state.selectedTiers.length === 0;
}

function selectAllTiers() { for (let t = 1; t <= 10; t++) if (!state.selectedTiers.includes(t)) toggleTier(t); }
function clearTierSelection() { [...state.selectedTiers].forEach(t => toggleTier(t)); }
function selectTierRange(a, b) { clearTierSelection(); for (let t = a; t <= b; t++) toggleTier(t); }

function initScores() { 
    for (let i = 1; i <= 10; i++) {
        state.tierScores[i] = { correct: 0, total: 0, times: [] };
        state.domainScores[i] = {};
    }
}

function startPlacementTest() {
    initScores();
    setupTestUI(false);
    document.getElementById('placement-setup-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');
    loadQuestion();
}

function startTestingCenter() {
    initScores();
    state.currentTier = Math.min(...state.selectedTiers);
    setupTestUI(true);
    document.getElementById('testing-setup-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');
    loadQuestion();
}

function setupTestUI(isTC) {
    const header = document.getElementById('test-header');
    header.classList.toggle('testing-center-header', isTC);
    document.getElementById('tc-stats-bar').style.display = isTC ? 'flex' : 'none';
    document.getElementById('end-session-btn').style.display = isTC ? 'inline-flex' : 'none';
    document.getElementById('idk-btn').style.display = isTC ? 'none' : 'inline-flex';
    document.getElementById('test-screen').classList.toggle('testing-center-mode', isTC);
    const btnClass = isTC ? 'btn btn-cyan' : 'btn btn-primary';
    document.getElementById('submit-btn').className = btnClass;
    document.getElementById('next-btn').className = btnClass;
}

function loadQuestion() {
    if (state.mode === 'placement' && state.history.length >= 25) { endTest(); return; }
    
    let targetTier = state.currentTier;
    
    // Gap probe every 6 questions in placement mode
    if (state.mode === 'placement' && state.history.length > 0 && state.history.length % 6 === 0) {
        targetTier = Math.min(state.currentTier + 2, 10);
        state.probeMode = true;
    } else {
        state.probeMode = false;
    }
    
    // Cycle through selected tiers in testing center
    if (state.mode === 'testing' && state.selectedTiers.length > 1) {
        const sorted = [...state.selectedTiers].sort((a, b) => a - b);
        targetTier = sorted[state.history.length % sorted.length];
    }
    
    const q = generateQuestion(targetTier);
    if (!q) { endTest(); return; }
    
    state.currentQuestion = q;
    state.selectedAnswer = null;
    renderQuestion();
    startTimer();
    updateProgress();
}

function renderQuestion() {
    const q = state.currentQuestion;
    document.getElementById('tag-tier').textContent = `Tier ${q.tier}`;
    document.getElementById('tag-domain').textContent = q.domain;
    document.getElementById('tag-type').textContent = q.type;
    
    const meta = document.getElementById('question-meta');
    meta.querySelectorAll('.tag-probe, .tag-practice').forEach(e => e.remove());
    if (state.probeMode) { const t = document.createElement('span'); t.className = 'question-tag tag-probe'; t.textContent = 'GAP PROBE'; meta.appendChild(t); }
    if (state.mode === 'testing') { const t = document.createElement('span'); t.className = 'question-tag tag-practice'; t.textContent = 'PRACTICE'; meta.appendChild(t); }
    
    document.getElementById('question-text').textContent = q.question;
    
    const opts = document.getElementById('answer-options');
    opts.innerHTML = '';
    ['A','B','C','D'].forEach((l, i) => {
        if (i < q.options.length) {
            const div = document.createElement('div');
            div.className = 'answer-option';
            div.onclick = () => selectAnswer(i);
            div.innerHTML = `<span class="option-letter">${l}</span><span>${q.options[i]}</span>`;
            opts.appendChild(div);
        }
    });
    
    document.getElementById('explanation-box').classList.remove('show');
    document.getElementById('submit-btn').style.display = 'inline-flex';
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('feedback').classList.remove('show', 'correct', 'incorrect');
    
    // Show IDK button only in placement mode
    if (state.mode === 'placement') {
        document.getElementById('idk-btn').style.display = 'inline-flex';
    }
}

function selectAnswer(i) {
    if (document.getElementById('next-btn').style.display !== 'none') return;
    state.selectedAnswer = i;
    document.querySelectorAll('.answer-option').forEach((o, idx) => o.classList.toggle('selected', idx === i));
    document.getElementById('submit-btn').disabled = false;
}

function startTimer() {
    state.startTime = Date.now();
    state.elapsedTime = 0;
    const fill = document.getElementById('timer-fill');
    fill.style.width = '0%';
    fill.classList.remove('slow');
    if (state.timerInterval) clearInterval(state.timerInterval);
    state.timerInterval = setInterval(() => {
        state.elapsedTime = (Date.now() - state.startTime) / 1000;
        document.getElementById('timer-display').textContent = state.elapsedTime.toFixed(1) + 's';
        const pct = Math.min((state.elapsedTime / (state.currentQuestion.timeExpected * 2)) * 100, 100);
        fill.style.width = pct + '%';
        if (state.elapsedTime > state.currentQuestion.timeExpected) fill.classList.add('slow');
    }, 100);
}

function stopTimer() { if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; } return state.elapsedTime; }

function updateProgress() {
    document.getElementById('question-number').textContent = state.history.length + 1;
    document.getElementById('correct-count').textContent = state.history.filter(h => h.correct).length;
    document.getElementById('current-tier-display').textContent = `Tier ${state.currentQuestion.tier} ‚Äî ${TIERS[state.currentQuestion.tier].name}`;
    
    if (state.mode === 'testing' && state.history.length > 0) {
        const c = state.history.filter(h => h.correct).length;
        const acc = Math.round((c / state.history.length) * 100);
        const avg = (state.history.reduce((s, h) => s + h.time, 0) / state.history.length).toFixed(1);
        document.getElementById('tc-accuracy').textContent = acc + '%';
        document.getElementById('tc-accuracy').className = `stat-value ${acc >= 70 ? 'good' : acc >= 50 ? 'medium' : 'poor'}`;
        document.getElementById('tc-avg-time').textContent = avg + 's';
        document.getElementById('tc-streak').textContent = state.currentStreak;
    }
}

function submitAnswer() {
    const time = stopTimer();
    const q = state.currentQuestion;
    const correct = state.selectedAnswer === q.answerIndex;
    const fast = time <= q.timeExpected * 0.7;
    const slow = time > q.timeExpected * 1.5;
    
    state.history.push({ tier: q.tier, domain: q.domain, type: q.type, question: q.question, correct, time, fast, slow });
    
    const ts = state.tierScores[q.tier];
    ts.total++; 
    if (correct) ts.correct++; 
    ts.times.push(time);
    
    // Track domain scores
    if (!state.domainScores[q.tier][q.domain]) {
        state.domainScores[q.tier][q.domain] = { correct: 0, total: 0 };
    }
    state.domainScores[q.tier][q.domain].total++;
    if (correct) state.domainScores[q.tier][q.domain].correct++;

    // Send progress update to Skill Tree
    const ds = state.domainScores[q.tier][q.domain];
    sendSkillProgress(q.domain, q.tier, ds.correct, ds.total, time);

    state.currentStreak = correct ? state.currentStreak + 1 : 0;
    
    const fb = document.getElementById('feedback');
    fb.classList.add('show');
    if (correct) {
        fb.className = 'feedback show correct';
        fb.textContent = fast ? '‚úì Correct! (Fast)' : slow ? '‚úì Correct (Slow)' : '‚úì Correct!';
    } else {
        fb.className = 'feedback show incorrect';
        fb.textContent = `‚úó Incorrect. Answer: ${q.options[q.answerIndex]}`;
        if (!state.gapLog.find(g => g.tier === q.tier && g.domain === q.domain))
            state.gapLog.push({ tier: q.tier, domain: q.domain, type: q.type });
    }
    
    document.querySelectorAll('.answer-option').forEach((o, i) => {
        if (i === q.answerIndex) o.classList.add('correct');
        else if (i === state.selectedAnswer && !correct) o.classList.add('incorrect');
    });
    
    if (state.mode === 'testing' && q.explanation) {
        document.getElementById('explanation-text').textContent = q.explanation;
        document.getElementById('explanation-box').classList.add('show');
    }
    
    if (state.mode === 'placement') adaptTier(correct, fast, slow);
    
    document.getElementById('idk-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-flex';
    updateProgress();
}

function adaptTier(correct, fast, slow) {
    if (correct) {
        state.consecutiveCorrect++;
        state.consecutiveWrong = 0;
        if (fast && state.consecutiveCorrect >= 2) { state.currentTier = Math.min(state.currentTier + 1, 10); state.consecutiveCorrect = 0; }
        else if (!slow && state.consecutiveCorrect >= 3) { state.currentTier = Math.min(state.currentTier + 1, 10); state.consecutiveCorrect = 0; }
    } else {
        state.consecutiveWrong++;
        state.consecutiveCorrect = 0;
        if (state.consecutiveWrong >= 2) { state.currentTier = Math.max(state.currentTier - 1, 1); state.consecutiveWrong = 0; }
    }
}

function submitIDK() {
    const time = stopTimer();
    const q = state.currentQuestion;
    
    // Record as unknown (counts as incorrect for placement purposes)
    state.history.push({ 
        tier: q.tier, 
        domain: q.domain, 
        type: q.type, 
        question: q.question, 
        correct: false, 
        time: time, 
        fast: false, 
        slow: false,
        idk: true  // Mark as IDK
    });
    
    const ts = state.tierScores[q.tier];
    ts.total++; 
    // Don't increment correct - it's unknown
    ts.times.push(time);
    
    // Track domain scores
    if (!state.domainScores[q.tier][q.domain]) {
        state.domainScores[q.tier][q.domain] = { correct: 0, total: 0, idk: 0 };
    }
    state.domainScores[q.tier][q.domain].total++;
    state.domainScores[q.tier][q.domain].idk = (state.domainScores[q.tier][q.domain].idk || 0) + 1;

    // Send progress update to Skill Tree (IDK counts as incorrect)
    const ds = state.domainScores[q.tier][q.domain];
    sendSkillProgress(q.domain, q.tier, ds.correct, ds.total, time);

    // Log as gap immediately
    if (!state.gapLog.find(g => g.tier === q.tier && g.domain === q.domain))
        state.gapLog.push({ tier: q.tier, domain: q.domain, type: q.type, idk: true });
    
    // Show brief feedback
    const fb = document.getElementById('feedback');
    fb.className = 'feedback show incorrect';
    fb.textContent = `Skipped ‚Äî Answer was: ${q.options[q.answerIndex]}`;
    fb.classList.add('show');
    
    // Show correct answer
    document.querySelectorAll('.answer-option').forEach((o, i) => {
        if (i === q.answerIndex) o.classList.add('correct');
    });
    
    // IDK counts as wrong for tier adaptation (more aggressive drop)
    state.consecutiveWrong++;
    state.consecutiveCorrect = 0;
    state.currentStreak = 0;
    
    // Drop tier immediately on IDK (they clearly don't know this level)
    if (state.consecutiveWrong >= 1) { 
        state.currentTier = Math.max(state.currentTier - 1, 1); 
        state.consecutiveWrong = 0; 
    }
    
    // Hide IDK and submit, show next
    document.getElementById('idk-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-flex';
    
    updateProgress();
}

function nextQuestion() { loadQuestion(); }

function endTest() {
    stopTimer();
    const placement = calculatePlacement();
    document.getElementById('test-screen').classList.remove('active');
    document.getElementById('results-screen').classList.add('active');
    document.getElementById('results-screen').classList.toggle('testing-center-results', state.mode === 'testing');
    document.getElementById('results-title').textContent = state.mode === 'placement' ? 'Placement Results' : 'Practice Results';
    renderResults(placement);

    // Send full session results to Skill Tree
    sendSessionResults();
}

function calculatePlacement() {
    let best = 1;
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total >= 2 && s.correct / s.total >= 0.6) best = t;
    }
    const relevant = state.history.filter(h => h.tier <= best + 1);
    const fastCorrect = relevant.filter(h => h.fast && h.correct).length;
    let fluency = 'Normal';
    if (relevant.length > 0) {
        const ratio = fastCorrect / relevant.length;
        if (ratio >= 0.6) fluency = 'Automatic';
        else if (ratio <= 0.2) fluency = 'Slow';
    }
    const tc = state.history.filter(h => h.correct).length;
    const avg = state.history.length > 0 ? state.history.reduce((s, h) => s + h.time, 0) / state.history.length : 0;
    return { tier: best, fluency, total: state.history.length, correct: tc, accuracy: state.history.length > 0 ? Math.round(tc / state.history.length * 100) : 0, avgTime: avg.toFixed(1) };
}

function renderResults(p) {
    document.getElementById('result-tier-number').textContent = p.tier;
    document.getElementById('result-tier-title').textContent = TIERS[p.tier].name;
    document.getElementById('result-tier-grades').textContent = `Grades ${TIERS[p.tier].grades}`;
    const fb = document.getElementById('fluency-badge');
    fb.textContent = p.fluency + ' Fluency';
    fb.className = `fluency-badge fluency-${p.fluency.toLowerCase()}`;
    document.getElementById('stat-total').textContent = p.total;
    document.getElementById('stat-correct').textContent = p.correct;
    document.getElementById('stat-idk').textContent = state.history.filter(h => h.idk).length;
    document.getElementById('stat-accuracy').textContent = p.accuracy + '%';
    
    const bd = document.getElementById('tier-breakdown');
    bd.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total === 0) continue;
        const acc = Math.round(s.correct / s.total * 100);
        const cls = acc >= 70 ? 'good' : acc >= 50 ? 'medium' : 'poor';
        bd.innerHTML += `<div class="tier-row"><span class="tier-label">T${t}: ${TIERS[t].name}</span><div class="tier-bar"><div class="tier-fill ${cls}" style="width:${acc}%"></div></div><span class="tier-score">${s.correct}/${s.total}</span></div>`;
    }
    
    const gl = document.getElementById('gap-log');
    if (state.gapLog.length === 0) gl.innerHTML = '<div class="no-gaps">‚úì No gaps identified</div>';
    else gl.innerHTML = state.gapLog.map(g => `<div class="gap-item${g.idk ? ' idk' : ''}"><span class="gap-tier">T${g.tier}</span><span class="gap-skill">${g.domain} (${g.type})${g.idk ? ' ‚Äî Unknown' : ''}</span></div>`).join('');
    
    const recs = document.getElementById('recommendations');
    recs.innerHTML = `<div class="rec-item"><div class="rec-icon">üìç</div><div class="rec-content"><h4>Placement: Tier ${p.tier} ‚Äî ${TIERS[p.tier].name}</h4><p>Ready for Grades ${TIERS[p.tier].grades} content. Domains: ${TIERS[p.tier].domains.slice(0,3).join(', ')}</p></div></div>`;
    if (p.fluency === 'Slow') recs.innerHTML += `<div class="rec-item"><div class="rec-icon">‚è±Ô∏è</div><div class="rec-content"><h4>Focus on Fluency</h4><p>Practice timed drills to build automaticity.</p></div></div>`;
    else if (p.fluency === 'Automatic') recs.innerHTML += `<div class="rec-item"><div class="rec-icon">‚ö°</div><div class="rec-content"><h4>Strong Fluency</h4><p>Quick responses indicate solid automaticity. Consider advancing.</p></div></div>`;
    if (state.gapLog.length > 0) {
        const idkGaps = state.gapLog.filter(g => g.idk);
        const wrongGaps = state.gapLog.filter(g => !g.idk);
        if (idkGaps.length > 0) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">‚ùì</div><div class="rec-content"><h4>Topics to Learn</h4><p>New material needed: ${idkGaps.slice(0,3).map(g => `${g.domain} (Tier ${g.tier})`).join(', ')}</p></div></div>`;
        if (wrongGaps.length > 0) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">üîß</div><div class="rec-content"><h4>Topics to Review</h4><p>Review: ${wrongGaps.slice(0,3).map(g => `${g.domain} (Tier ${g.tier})`).join(', ')}</p></div></div>`;
    }
    if (p.tier < 10) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">üìà</div><div class="rec-content"><h4>Next Level</h4><p>To advance to Tier ${p.tier + 1} (${TIERS[p.tier + 1].name}), master: ${TIERS[p.tier + 1].domains.slice(0,3).join(', ')}</p></div></div>`;
    
    const hist = document.getElementById('question-history');
    hist.innerHTML = state.history.map((h, i) => `<div class="history-item ${h.correct ? 'correct' : h.idk ? 'idk' : 'incorrect'}"><span class="q-number">${i+1}</span><span class="q-text">${h.idk ? '‚ùì ' : ''}${h.question}</span><span class="q-time">${h.time.toFixed(1)}s</span><span class="q-tier">T${h.tier}${h.idk ? ' IDK' : ''}</span></div>`).join('');
}

// ========================================
// LEARNING CENTER FUNCTIONS
// ========================================

function initLearningSetup() {
    // Create tier selection buttons
    const tierSelect = document.getElementById('learning-tier-select');
    tierSelect.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const btn = document.createElement('button');
        btn.className = 'tier-select-btn' + (t === 1 ? ' selected' : '');
        btn.textContent = `T${t}`;
        btn.title = `Tier ${t}: ${TIERS[t].name}`;
        btn.onclick = () => selectLearningTier(t);
        tierSelect.appendChild(btn);
    }
    state.learningTier = 1;
    updateSkillGrid();
}

function selectLearningTier(tier) {
    state.learningTier = tier;
    state.learningSkill = null;
    document.querySelectorAll('.tier-select-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === tier);
    });
    updateSkillGrid();
    document.getElementById('start-learning-btn').disabled = true;
}

function updateSkillGrid() {
    const grid = document.getElementById('skill-grid');
    const domains = TIERS[state.learningTier].domains;
    grid.innerHTML = '';
    domains.forEach(skill => {
        const card = document.createElement('div');
        card.className = 'skill-card';
        card.onclick = () => selectSkill(skill);
        const hasLesson = lessons[state.learningTier] && lessons[state.learningTier][skill];
        card.innerHTML = `<div class="skill-name">${skill}</div><div class="skill-desc">${hasLesson ? '‚úì Full lesson' : 'Practice available'}</div>`;
        grid.appendChild(card);
    });
}

function selectSkill(skill) {
    state.learningSkill = skill;
    document.querySelectorAll('.skill-card').forEach(card => {
        card.classList.toggle('selected', card.querySelector('.skill-name').textContent === skill);
    });
    document.getElementById('start-learning-btn').disabled = false;
}

function startLearning() {
    state.learningPhase = 'learn';
    state.currentLesson = generateLesson(state.learningTier, state.learningSkill);
    state.guidedStep = 0;
    state.practiceAttempts = 0;
    
    if (!state.currentLesson) {
        alert('Lesson not available for this skill yet.');
        return;
    }
    
    document.getElementById('learning-setup-screen').classList.remove('active');
    document.getElementById('learning-screen').classList.add('active');
    
    // Update header
    document.getElementById('learning-tier-badge').textContent = `Tier ${state.learningTier}`;
    document.getElementById('learning-skill-name').textContent = state.learningSkill;
    
    renderLearningPhase();
}

function renderLearningPhase() {
    const lesson = state.currentLesson;
    
    // Update phase indicators
    document.querySelectorAll('.phase-dot').forEach(dot => {
        const phase = dot.dataset.phase;
        dot.classList.remove('active', 'completed');
        if (phase === state.learningPhase) dot.classList.add('active');
        else if ((phase === 'learn' && state.learningPhase !== 'learn') || 
                 (phase === 'guided' && state.learningPhase === 'practice')) {
            dot.classList.add('completed');
        }
    });
    document.querySelectorAll('.phase-label').forEach(label => {
        label.classList.toggle('active', label.dataset.phase === state.learningPhase);
    });
    document.querySelectorAll('.phase-line').forEach((line, i) => {
        line.classList.toggle('completed', 
            (i === 0 && state.learningPhase !== 'learn') ||
            (i === 1 && state.learningPhase === 'practice'));
    });
    
    // Hide all phases
    document.querySelectorAll('.phase-content').forEach(p => p.classList.remove('active'));
    
    if (state.learningPhase === 'learn') {
        renderLearnPhase(lesson);
        document.getElementById('phase-learn').classList.add('active');
        document.getElementById('learning-continue-btn').textContent = 'Continue to Guided Practice ‚Üí';
        document.getElementById('learning-continue-btn').style.display = 'inline-flex';
    } else if (state.learningPhase === 'guided') {
        renderGuidedPhase(lesson);
        document.getElementById('phase-guided').classList.add('active');
        document.getElementById('learning-continue-btn').style.display = 'none';
    } else if (state.learningPhase === 'practice') {
        renderPracticePhase(lesson);
        document.getElementById('phase-practice').classList.add('active');
        document.getElementById('learning-continue-btn').style.display = 'none';
    }
}

function renderLearnPhase(lesson) {
    // Reset step reveal state
    state.currentConceptStep = 0;
    state.totalConceptSteps = lesson.teachingSteps ? lesson.teachingSteps.length : 0;

    // Check if lesson has new step-by-step format
    if (lesson.teachingSteps && lesson.teachingSteps.length > 0) {
        // New step-by-step format
        document.getElementById('goal-problem-text').innerHTML = lesson.goalProblem || lesson.example.problem;

        // Build concept steps HTML (all hidden initially)
        document.getElementById('concept-steps').innerHTML = lesson.teachingSteps.map((step, i) =>
            `<div class="concept-step" id="concept-step-${i}">
                <div class="step-header">
                    <span class="step-number">${i + 1}</span>
                    <span class="step-title">${step.title}</span>
                    <button class="read-aloud-btn step-read-btn" onclick="readConceptStep(${i}, this)" title="Read aloud">
                        <span class="speaker-icon">üîä</span> Read
                    </button>
                </div>
                <div class="step-explanation">${step.explanation}</div>
                ${step.visual ? `<div class="step-visual">${step.visual}</div>` : ''}
            </div>`
        ).join('');

        // Set up final answer
        document.getElementById('answer-text').innerHTML = lesson.finalAnswer || lesson.example.steps[lesson.example.steps.length - 1]?.math || '';
        document.getElementById('answer-explanation').innerHTML = lesson.answerExplanation || '';

        // Reset visibility
        document.getElementById('final-answer').classList.remove('visible');
        const btn = document.getElementById('reveal-next-btn');
        const btnContainer = document.getElementById('reveal-btn-container');
        btn.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">üëâ</span><span>Show Next Step</span>';
        btn.onclick = revealNextConceptStep;

        // Move button container back to after concept-steps
        document.getElementById('concept-steps').insertAdjacentElement('afterend', btnContainer);

        document.getElementById('key-points-section').style.display = 'none';
        document.getElementById('mistakes-section').style.display = 'none';

        // Reveal first step automatically
        setTimeout(() => revealNextConceptStep(), 300);
    } else {
        // Fallback to old format - show everything at once
        document.getElementById('goal-problem-text').innerHTML = lesson.example.problem;

        // Convert old format to steps
        const steps = lesson.example.steps.map((step, i) => ({
            title: step.text,
            explanation: '',
            visual: step.math
        }));

        document.getElementById('concept-steps').innerHTML = steps.map((step, i) =>
            `<div class="concept-step visible" id="concept-step-${i}">
                <div class="step-header">
                    <span class="step-number">${i + 1}</span>
                    <span class="step-title">${step.title}</span>
                    <button class="read-aloud-btn step-read-btn" onclick="readConceptStepOld(${i}, this)" title="Read aloud">
                        <span class="speaker-icon">üîä</span> Read
                    </button>
                </div>
                ${step.visual ? `<div class="step-visual">${step.visual}</div>` : ''}
            </div>`
        ).join('');

        // Show answer immediately
        document.getElementById('answer-text').innerHTML = lesson.example.steps[lesson.example.steps.length - 1]?.math || '';
        document.getElementById('answer-explanation').innerHTML = '';
        document.getElementById('final-answer').classList.add('visible');
        document.getElementById('reveal-next-btn').style.display = 'none';

        // Show key points and mistakes
        document.getElementById('key-points-section').style.display = 'block';
        document.getElementById('mistakes-section').style.display = 'block';
    }

    // Key points
    document.getElementById('key-points-list').innerHTML = lesson.keyPoints.map(p => `<li>${p}</li>`).join('');

    // Common mistakes
    document.getElementById('common-mistakes-list').innerHTML = lesson.mistakes.map(m =>
        `<div class="mistake-item"><div class="mistake-wrong">‚úó ${m.wrong}</div><div class="mistake-why">‚Üí ${m.why}</div></div>`
    ).join('');
}

function revealNextConceptStep() {
    const lesson = state.currentLesson;
    const currentStep = state.currentConceptStep;
    const totalSteps = state.totalConceptSteps;
    const btnContainer = document.getElementById('reveal-btn-container');
    const btn = document.getElementById('reveal-next-btn');

    if (currentStep < totalSteps) {
        // Reveal the next step
        const stepEl = document.getElementById(`concept-step-${currentStep}`);
        if (stepEl) {
            stepEl.classList.add('visible');

            // Move button container right after this step
            stepEl.insertAdjacentElement('afterend', btnContainer);

            // Scroll the button into view smoothly
            setTimeout(() => {
                btnContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        state.currentConceptStep++;

        // Update button text
        if (state.currentConceptStep >= totalSteps) {
            btn.innerHTML = '<span class="btn-icon">üéØ</span><span>Show the Answer!</span>';
        } else {
            btn.innerHTML = `<span class="btn-icon">üëâ</span><span>Next Step (${state.currentConceptStep + 1}/${totalSteps})</span>`;
        }
    } else {
        // All steps revealed, show the answer
        const finalAnswer = document.getElementById('final-answer');
        finalAnswer.classList.add('visible');

        // Move button after final answer and update it
        finalAnswer.insertAdjacentElement('afterend', btnContainer);
        btn.innerHTML = '<span class="btn-icon">‚úÖ</span><span>Continue to Guided Practice ‚Üí</span>';
        btn.onclick = nextLearningPhase;

        // Scroll to final answer
        setTimeout(() => {
            finalAnswer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);

        // Show key points and mistakes after a short delay
        setTimeout(() => {
            document.getElementById('key-points-section').style.display = 'block';
            document.getElementById('mistakes-section').style.display = 'block';
        }, 500);
    }
}

function renderGuidedPhase(lesson) {
    const guided = lesson.guided;

    // Initialize guided state
    state.guidedCurrentStep = 0;
    state.guidedSteps = guided.interactiveSteps || generateInteractiveSteps(guided, lesson);
    state.guidedAttempts = 0;

    // Set problem text
    document.getElementById('guided-problem').innerHTML = guided.problem;

    // Set total steps
    const totalSteps = state.guidedSteps.length;
    document.getElementById('guided-total-steps').textContent = totalSteps;
    document.getElementById('guided-current-step').textContent = '1';

    // Create progress dots
    document.getElementById('guided-progress-dots').innerHTML = state.guidedSteps.map((_, i) =>
        `<div class="dot ${i === 0 ? 'current' : ''}"></div>`
    ).join('');

    // Clear completed steps
    document.getElementById('guided-completed-steps').innerHTML = '';

    // Show completion area as hidden
    document.getElementById('guided-completion').style.display = 'none';
    document.getElementById('guided-current-step-area').style.display = 'block';

    // Render first step
    renderGuidedStep();
}

// Generate interactive steps from the old format
function generateInteractiveSteps(guided, lesson) {
    const steps = [];
    const mistakes = lesson.mistakes || [];

    // Convert old guided.steps to interactive format
    guided.steps.forEach((step, i) => {
        const isLast = i === guided.steps.length - 1;
        if (isLast) {
            // Last step is always user input for final answer
            steps.push({
                prompt: guided.answerLabel || step.label,
                hint: `Look at the previous steps to find the answer`,
                answer: guided.answer,
                acceptableAnswers: [guided.answer],
                commonMistakes: buildMistakeMap(guided.answer, mistakes, lesson)
            });
        } else if (step.value && step.value !== '?') {
            // Create fill-in step for intermediate values
            const answerValue = extractAnswer(step.value);
            if (answerValue && i > 0) { // Skip first step (usually just setup)
                steps.push({
                    prompt: step.label,
                    hint: `Calculate: ${guided.steps[i-1]?.value || 'using what you know'}`,
                    answer: answerValue,
                    acceptableAnswers: [answerValue],
                    showWork: guided.steps.slice(0, i).map(s => `${s.label}: ${s.value}`),
                    commonMistakes: {}
                });
            }
        }
    });

    // If no steps were generated, create at least the final answer step
    if (steps.length === 0) {
        steps.push({
            prompt: guided.answerLabel || 'Final Answer',
            hint: 'Use the information given to solve the problem',
            answer: guided.answer,
            acceptableAnswers: [guided.answer],
            commonMistakes: buildMistakeMap(guided.answer, mistakes, lesson)
        });
    }

    return steps;
}

// Extract a numeric or simple answer from a step value
function extractAnswer(value) {
    if (!value || value === '?') return null;
    // Try to extract the last number or simple expression
    const match = value.match(/=\s*([^=]+)$/) || value.match(/(\d+(?:\.\d+)?(?:\/\d+)?)/);
    return match ? match[1].trim() : value.trim();
}

// Build mistake map from lesson mistakes
function buildMistakeMap(correctAnswer, mistakes, lesson) {
    const mistakeMap = {};

    // Add common arithmetic mistakes
    const numAnswer = parseFloat(correctAnswer);
    if (!isNaN(numAnswer)) {
        // Common off-by-one or arithmetic errors
        mistakeMap[String(numAnswer + 1)] = "Almost! Double-check your arithmetic.";
        mistakeMap[String(numAnswer - 1)] = "Almost! Double-check your arithmetic.";
        mistakeMap[String(numAnswer * 2)] = "You might have doubled when you shouldn't have.";
        mistakeMap[String(numAnswer / 2)] = "You might have halved when you shouldn't have.";
        mistakeMap[String(-numAnswer)] = "Check if the sign (positive/negative) is correct.";
    }

    // Add lesson-specific mistakes
    mistakes.forEach(m => {
        if (m.wrong && m.why) {
            // Extract any numbers from the wrong answer description
            const wrongNums = m.wrong.match(/\d+(?:\.\d+)?/g);
            if (wrongNums) {
                wrongNums.forEach(num => {
                    mistakeMap[num] = m.why;
                });
            }
        }
    });

    return mistakeMap;
}

function renderGuidedStep() {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const stepNum = state.guidedCurrentStep + 1;

    // Update step counter
    document.getElementById('guided-current-step').textContent = stepNum;

    // Update progress dots
    document.querySelectorAll('.guided-progress .dot').forEach((dot, i) => {
        dot.classList.remove('current', 'completed');
        if (i < state.guidedCurrentStep) dot.classList.add('completed');
        else if (i === state.guidedCurrentStep) dot.classList.add('current');
    });

    // Show previous work if available
    if (step.showWork && step.showWork.length > 0) {
        document.getElementById('guided-step-hint').innerHTML = `<strong>So far:</strong> ${step.showWork.join(' ‚Üí ')}`;
    } else {
        document.getElementById('guided-step-hint').textContent = step.hint || '';
    }

    // Set prompt with read aloud button
    document.getElementById('guided-step-prompt').innerHTML = `
        <div class="step-header-row">
            <div class="step-prompt-text"><strong>Step ${stepNum}:</strong> ${step.prompt}</div>
            <button class="read-aloud-btn" onclick="readAloud(this)" title="Read aloud">
                <span class="speaker-icon">üîä</span> Read
            </button>
        </div>
    `;

    // Reset input
    document.getElementById('guided-input-area').innerHTML = `
        <input type="text" class="guided-input" id="guided-answer-input" placeholder="Your answer" onkeypress="if(event.key==='Enter')checkGuidedStepAnswer()">
        <button class="btn btn-emerald guided-submit" onclick="checkGuidedStepAnswer()">Check</button>
    `;

    // Clear feedback
    document.getElementById('guided-feedback').classList.remove('show', 'correct', 'incorrect', 'hint');

    // Focus input
    setTimeout(() => document.getElementById('guided-answer-input')?.focus(), 100);
}

function checkGuidedStepAnswer() {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const input = document.getElementById('guided-answer-input').value.trim();
    const fb = document.getElementById('guided-feedback');

    state.guidedAttempts++;

    // Normalize answers for comparison
    const normalizeAnswer = (ans) => String(ans).toLowerCase().replace(/\s+/g, '').replace(/,/g, '');
    const userAnswer = normalizeAnswer(input);

    // Check if correct (allow multiple acceptable answers)
    const acceptableAnswers = step.acceptableAnswers || [step.answer];
    const isCorrect = acceptableAnswers.some(ans => normalizeAnswer(ans) === userAnswer);

    if (isCorrect) {
        fb.className = 'guided-feedback show correct';
        fb.innerHTML = `‚úì Correct! ${getEncouragement()}`;

        // Add to completed steps
        addCompletedStep(step, input);

        // Move to next step or complete
        setTimeout(() => {
            state.guidedCurrentStep++;
            state.guidedAttempts = 0;

            if (state.guidedCurrentStep >= state.guidedSteps.length) {
                // All steps complete
                showGuidedCompletion();
            } else {
                renderGuidedStep();
            }
        }, 1000);
    } else {
        // Check for common mistakes
        const mistakeFeedback = step.commonMistakes?.[input] || step.commonMistakes?.[userAnswer];

        if (mistakeFeedback) {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `‚úó Not quite.<div class="mistake-tip">üí° ${mistakeFeedback}</div>`;
        } else if (state.guidedAttempts >= 2) {
            // After 2 attempts, give a stronger hint
            fb.className = 'guided-feedback show hint';
            fb.innerHTML = `üí° Hint: The answer involves "${step.answer.toString().charAt(0)}..." - try again!`;
        } else {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `‚úó Not quite. Check your work and try again.`;
        }

        // After 3 attempts, show the answer
        if (state.guidedAttempts >= 3) {
            fb.innerHTML += `<br><br>The correct answer is: <strong>${step.answer}</strong>`;

            setTimeout(() => {
                addCompletedStep(step, step.answer);
                state.guidedCurrentStep++;
                state.guidedAttempts = 0;

                if (state.guidedCurrentStep >= state.guidedSteps.length) {
                    showGuidedCompletion();
                } else {
                    renderGuidedStep();
                }
            }, 2000);
        }

        // Select input for easy retry
        document.getElementById('guided-answer-input')?.select();
    }
}

function addCompletedStep(step, answer) {
    const stepNum = state.guidedCurrentStep + 1;
    const completedHTML = `
        <div class="guided-completed-step">
            <div class="step-num">‚úì</div>
            <div class="step-content">
                <div class="step-question">${step.prompt}</div>
                <div class="step-answer">${answer}</div>
            </div>
        </div>
    `;
    document.getElementById('guided-completed-steps').innerHTML += completedHTML;
}

function showGuidedCompletion() {
    const lesson = state.currentLesson;

    document.getElementById('guided-current-step-area').style.display = 'none';
    document.getElementById('guided-completion').style.display = 'block';
    document.getElementById('guided-final-answer').innerHTML = `Final Answer: <strong>${lesson.guided.answer}</strong>`;

    // Update progress dots
    document.querySelectorAll('.guided-progress .dot').forEach(dot => {
        dot.classList.remove('current');
        dot.classList.add('completed');
    });
}

function getEncouragement() {
    const phrases = ['Great job!', 'Excellent!', 'Perfect!', 'Well done!', 'Awesome!', 'Nice work!'];
    return phrases[Math.floor(Math.random() * phrases.length)];
}

// Legacy function kept for compatibility
function checkGuidedAnswer() {
    checkGuidedStepAnswer();
}

function renderPracticePhase(lesson) {
    const practice = lesson.practice;
    state.practiceAttempts = 0;
    
    document.getElementById('practice-problem').textContent = practice.problem;
    document.getElementById('practice-options').innerHTML = practice.options.map((opt, i) => 
        `<div class="practice-option" onclick="selectPracticeOption(${i})">${opt}</div>`
    ).join('');
    
    document.getElementById('practice-feedback').classList.remove('show', 'correct', 'incorrect');
    document.getElementById('mistake-analysis').classList.remove('show');
}

function selectPracticeOption(index) {
    const lesson = state.currentLesson;
    const practice = lesson.practice;
    const selectedAnswer = practice.options[index];
    const correct = String(selectedAnswer) === String(practice.answer);
    
    state.practiceAttempts++;
    
    // Show selection
    document.querySelectorAll('.practice-option').forEach((opt, i) => {
        opt.classList.remove('selected');
        if (i === index) opt.classList.add('selected');
    });
    
    const fb = document.getElementById('practice-feedback');
    fb.classList.add('show');
    
    if (correct) {
        fb.className = 'practice-feedback show correct';
        fb.innerHTML = `‚úì Excellent! You've mastered this concept!`;
        
        document.querySelectorAll('.practice-option').forEach((opt, i) => {
            if (String(practice.options[i]) === String(practice.answer)) {
                opt.classList.add('correct');
            }
        });
        
        // Show completion
        setTimeout(() => {
            document.getElementById('learning-continue-btn').textContent = 'Complete Lesson ‚úì';
            document.getElementById('learning-continue-btn').style.display = 'inline-flex';
            document.getElementById('learning-continue-btn').onclick = completeLearning;
        }, 500);
    } else {
        fb.className = 'practice-feedback show incorrect';
        fb.innerHTML = `Not quite. Let's see what might have gone wrong.`;
        
        document.querySelectorAll('.practice-option')[index].classList.add('incorrect');
        
        // Show mistake analysis if available
        const analysis = practice.mistakeAnalysis[String(selectedAnswer)];
        const mistakeDiv = document.getElementById('mistake-analysis');
        if (analysis) {
            mistakeDiv.innerHTML = `<h4>üîç Why This Might Have Happened</h4><p>${analysis}</p>`;
            mistakeDiv.classList.add('show');
        } else {
            mistakeDiv.innerHTML = `<h4>üí° Tip</h4><p>Review the worked example and try again. Pay attention to each step of the process.</p>`;
            mistakeDiv.classList.add('show');
        }
        
        // Allow retry after 2 attempts
        if (state.practiceAttempts >= 2) {
            fb.innerHTML += `<br><br>The correct answer is: <strong>${practice.answer}</strong>`;
            document.querySelectorAll('.practice-option').forEach((opt, i) => {
                if (String(practice.options[i]) === String(practice.answer)) {
                    opt.classList.add('correct-answer');
                }
            });
            setTimeout(() => {
                document.getElementById('learning-continue-btn').textContent = 'Continue ‚Üí';
                document.getElementById('learning-continue-btn').style.display = 'inline-flex';
                document.getElementById('learning-continue-btn').onclick = completeLearning;
            }, 1500);
        }
    }
}

function nextLearningPhase() {
    if (state.learningPhase === 'learn') {
        state.learningPhase = 'guided';
    } else if (state.learningPhase === 'guided') {
        state.learningPhase = 'practice';
    }
    renderLearningPhase();
}

function completeLearning() {
    // Send skill mastery to Skill Tree (completed lesson = high mastery)
    sendSkillProgress(state.learningSkill, state.learningTier, 3, 3, 0);

    // Also send a lesson complete message
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({
            type: 'DOGO_LESSON_COMPLETE',
            skill: getSkillTreeName(state.learningSkill),
            domain: state.learningSkill,
            tier: state.learningTier,
            timestamp: Date.now()
        }, '*');
    }

    alert(`Great work! You've completed the ${state.learningSkill} lesson.`);
    endLearning();
}

function endLearning() {
    document.getElementById('learning-screen').classList.remove('active');
    document.getElementById('learning-setup-screen').classList.add('active');

    // Stop any ongoing speech
    stopSpeaking();

    // Reset button
    document.getElementById('learning-continue-btn').onclick = nextLearningPhase;
    document.getElementById('learning-continue-btn').textContent = 'Continue ‚Üí';
}

// ========================================
// TEXT-TO-SPEECH (READ ALOUD) FUNCTIONS
// ========================================

// Track current speech state
let currentUtterance = null;
let currentSpeakingBtn = null;

// Clean text for speech (remove HTML, special chars, etc.)
function cleanTextForSpeech(text) {
    // Remove HTML tags
    let cleaned = text.replace(/<[^>]*>/g, ' ');
    // Replace common math symbols with spoken equivalents
    cleaned = cleaned
        .replace(/√ó/g, ' times ')
        .replace(/√∑/g, ' divided by ')
        .replace(/\+/g, ' plus ')
        .replace(/‚àí|‚Äì|-/g, ' minus ')
        .replace(/=/g, ' equals ')
        .replace(/‚â•/g, ' is greater than or equal to ')
        .replace(/‚â§/g, ' is less than or equal to ')
        .replace(/>/g, ' is greater than ')
        .replace(/</g, ' is less than ')
        .replace(/‚â†/g, ' is not equal to ')
        .replace(/¬≤/g, ' squared ')
        .replace(/¬≥/g, ' cubed ')
        .replace(/‚àö/g, ' square root of ')
        .replace(/œÄ/g, ' pi ')
        .replace(/¬∞/g, ' degrees ')
        .replace(/\$/g, ' dollars ')
        .replace(/%/g, ' percent ')
        .replace(/\^/g, ' to the power of ')
        .replace(/\*/g, ' times ')
        .replace(/\//g, ' divided by ')
        .replace(/\(x\)/g, ' of x ')
        .replace(/x¬≤/g, ' x squared ')
        .replace(/x¬≥/g, ' x cubed ')
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, ' and ')
        .replace(/\s+/g, ' ')
        .trim();
    return cleaned;
}

// Read guided step aloud (Guided Practice phase)
function readAloud(buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        alert('Sorry, your browser does not support text-to-speech.');
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the current step's text to read
    const step = state.guidedSteps[state.guidedCurrentStep];
    const stepNum = state.guidedCurrentStep + 1;

    // Build the text to read
    let textToRead = `Step ${stepNum}. ${step.prompt}`;

    // Also add the hint if available
    if (step.hint) {
        textToRead += `. Hint: ${step.hint}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Stop speaking
function stopSpeaking() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    resetSpeakingButton();
}

// Reset button state
function resetSpeakingButton() {
    if (currentSpeakingBtn) {
        currentSpeakingBtn.classList.remove('speaking');
        currentSpeakingBtn.innerHTML = '<span class="speaker-icon">üîä</span> Read';
        currentSpeakingBtn = null;
    }
    currentUtterance = null;
}

// Stop speaking when moving to next step
const originalRenderGuidedStep = renderGuidedStep;
renderGuidedStep = function() {
    stopSpeaking();
    originalRenderGuidedStep();
};

// Read a concept step aloud (Learn phase - new format with teachingSteps)
function readConceptStep(stepIndex, buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        alert('Sorry, your browser does not support text-to-speech.');
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the step from the lesson
    const lesson = state.currentLesson;
    if (!lesson || !lesson.teachingSteps || !lesson.teachingSteps[stepIndex]) return;

    const step = lesson.teachingSteps[stepIndex];

    // Build the text to read
    let textToRead = `Step ${stepIndex + 1}. ${step.title}. ${step.explanation}`;

    // Add visual if present
    if (step.visual) {
        textToRead += `. ${step.visual}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Read a concept step aloud (Learn phase - old format)
function readConceptStepOld(stepIndex, buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        alert('Sorry, your browser does not support text-to-speech.');
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the step from the lesson
    const lesson = state.currentLesson;
    if (!lesson || !lesson.example || !lesson.example.steps || !lesson.example.steps[stepIndex]) return;

    const step = lesson.example.steps[stepIndex];

    // Build the text to read
    let textToRead = `Step ${stepIndex + 1}. ${step.text}`;

    // Add math if present
    if (step.math) {
        textToRead += `. ${step.math}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Common function to handle speech
function speakText(text, buttonElement) {
    // Clean the text
    const textToRead = cleanTextForSpeech(text);

    // Create utterance
    currentUtterance = new SpeechSynthesisUtterance(textToRead);
    currentUtterance.rate = 0.9; // Slightly slower for clarity
    currentUtterance.pitch = 1;
    currentUtterance.volume = 1;

    // Try to use a good voice (prefer US English)
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(v =>
        v.lang.startsWith('en') && (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Samantha'))
    ) || voices.find(v => v.lang.startsWith('en-US')) || voices.find(v => v.lang.startsWith('en'));

    if (preferredVoice) {
        currentUtterance.voice = preferredVoice;
    }

    // Update button state
    currentSpeakingBtn = buttonElement;
    buttonElement.classList.add('speaking');
    buttonElement.innerHTML = '<span class="speaker-icon">üîä</span> Stop';

    // Handle speech end
    currentUtterance.onend = () => {
        resetSpeakingButton();
    };

    currentUtterance.onerror = () => {
        resetSpeakingButton();
    };

    // Start speaking
    speechSynthesis.speak(currentUtterance);
}

// Ensure voices are loaded (some browsers load them asynchronously)
if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}
    </script>
</body>
</html>
