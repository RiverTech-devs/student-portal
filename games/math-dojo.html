<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Math Dojo - Train Your Mind</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --slate-900: #0f172a; --slate-800: #1e293b; --slate-700: #334155;
            --slate-600: #475569; --slate-400: #94a3b8; --slate-300: #cbd5e1;
            --slate-200: #e2e8f0; --slate-100: #f1f5f9;
            --amber-500: #f59e0b; --amber-400: #fbbf24; --amber-300: #fcd34d;
            --emerald-500: #10b981; --emerald-400: #34d399;
            --rose-500: #f43f5e; --rose-400: #fb7185;
            --indigo-600: #4f46e5; --cyan-500: #06b6d4; --cyan-400: #22d3ee;
            --violet-500: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { font-family: 'Source Sans 3', sans-serif; background: linear-gradient(135deg, var(--slate-900), var(--slate-800)); min-height: 100vh; min-height: 100dvh; color: var(--slate-100); line-height: 1.6; overflow-x: hidden; }
        body.fullscreen-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; height: 100dvh; overflow-y: auto; padding-top: env(safe-area-inset-top, 0); padding-bottom: env(safe-area-inset-bottom, 0); }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        h1, h2, h3 { font-family: 'Fraunces', serif; font-weight: 600; }
        .header { text-align: center; padding: 3rem 0; border-bottom: 1px solid var(--slate-700); margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--amber-400), var(--amber-300)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header.testing-center h1 { background: linear-gradient(135deg, var(--cyan-400), var(--cyan-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: var(--slate-400); font-size: 1.1rem; }
        .header-badge { display: inline-block; padding: 0.35rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
        .badge-placement { background: var(--amber-500); color: var(--slate-900); }
        .badge-testing { background: var(--cyan-500); color: var(--slate-900); }
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 3rem 0; }
        .mode-card { background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 20px; padding: 2rem; cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
        .mode-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .mode-card.placement::before { background: var(--amber-500); }
        .mode-card.learning::before { background: var(--emerald-500); }
        .mode-card.testing::before { background: var(--cyan-500); }
        .mode-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .mode-card.placement:hover { border-color: var(--amber-500); }
        .mode-card.learning:hover { border-color: var(--emerald-500); }
        .mode-card.testing:hover { border-color: var(--cyan-500); }
        .mode-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .mode-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .mode-card .mode-subtitle { font-weight: 600; margin-bottom: 0.75rem; }
        .mode-card.placement .mode-subtitle { color: var(--amber-400); }
        .mode-card.learning .mode-subtitle { color: var(--emerald-400); }
        .mode-card.testing .mode-subtitle { color: var(--cyan-400); }
        .mode-card .mode-description { color: var(--slate-400); font-size: 0.9rem; }
        .mode-features { margin-top: 1.25rem; text-align: left; }
        .mode-feature { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; color: var(--slate-300); font-size: 0.85rem; }
        .mode-feature .check { color: var(--emerald-400); }
        .level-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 3rem 0; }
        .level-card { background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 16px; padding: 2rem 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .level-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--slate-600); }
        .level-card:hover { border-color: var(--amber-500); transform: translateY(-4px); }
        .level-card:hover::before { background: var(--amber-500); }
        .level-card.selected { border-color: var(--amber-400); background: var(--slate-700); }
        .level-card.selected::before { background: var(--amber-400); }
        .level-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .level-card .grades { color: var(--amber-400); font-weight: 600; margin-bottom: 1rem; }
        .level-card .tiers { color: var(--slate-400); font-size: 0.9rem; }
        .level-card .tier-list { margin-top: 0.75rem; font-size: 0.85rem; color: var(--slate-500); line-height: 1.8; }
        .tier-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 2rem 0; }
        .tier-option { display: flex; align-items: center; padding: 1rem 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
        .tier-option:hover { border-color: var(--slate-500); background: var(--slate-700); }
        .tier-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .tier-option .tier-checkbox { width: 24px; height: 24px; border: 2px solid var(--slate-500); border-radius: 6px; margin-right: 1rem; display: flex; align-items: center; justify-content: center; }
        .tier-option.selected .tier-checkbox { background: var(--cyan-500); border-color: var(--cyan-500); }
        .tier-option.selected .tier-checkbox::after { content: '✓'; color: var(--slate-900); font-weight: bold; }
        .tier-option .tier-name { font-weight: 600; color: var(--slate-200); }
        .tier-option .tier-grades { font-size: 0.85rem; color: var(--slate-400); }
        .selection-actions { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .selection-btn { padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--slate-700); border: 1px solid var(--slate-600); border-radius: 6px; color: var(--slate-300); cursor: pointer; transition: all 0.2s; }
        .selection-btn:hover { background: var(--slate-600); }
        .selection-btn.active { background: var(--cyan-600); border-color: var(--cyan-500); color: white; }
        .selection-btn.needs-practice-btn { border-color: var(--rose-500); color: var(--rose-400); }
        .selection-btn.needs-practice-btn:hover { background: rgba(244, 63, 94, 0.1); }
        .selection-btn.needs-practice-btn.active { background: var(--rose-600); border-color: var(--rose-500); color: white; }
        .needs-practice-skill { border-color: var(--rose-500) !important; background: rgba(244, 63, 94, 0.1) !important; }
        .needs-practice-skill .priority-badge { position: absolute; top: -6px; right: -6px; background: var(--rose-500); color: white; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 10px; font-weight: 600; }
        .mode-option { padding: 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .mode-option:hover { border-color: var(--slate-500); background: var(--slate-700); }
        .mode-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .time-btn, .count-btn { padding: 0.5rem 1rem; background: var(--slate-700); border: 1px solid var(--slate-600); border-radius: 6px; color: var(--slate-300); cursor: pointer; transition: all 0.2s; }
        .time-btn:hover, .count-btn:hover { background: var(--slate-600); }
        .time-btn.selected, .count-btn.selected { background: var(--cyan-600); border-color: var(--cyan-500); color: white; }
        .skill-option { padding: 0.75rem 1rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .skill-option:hover { border-color: var(--slate-500); }
        .skill-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.15); }
        .skill-option .skill-tier { font-size: 0.7rem; color: var(--slate-400); margin-top: 0.25rem; }
        .skill-option.locked { opacity: 0.5; cursor: not-allowed; background: var(--slate-900); }
        .skill-option.locked:hover { border-color: var(--slate-700); }
        .skill-option.mastered { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .skill-option.needs-review { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 1rem 2.5rem; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--amber-500), var(--amber-400)); color: var(--slate-900); box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-cyan { background: linear-gradient(135deg, var(--cyan-500), var(--cyan-400)); color: var(--slate-900); }
        .btn-cyan:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--slate-700); color: var(--slate-200); border: 1px solid var(--slate-600); }
        .btn-ghost { background: transparent; color: var(--slate-400); padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn-ghost:hover { color: var(--slate-200); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .phase-header-row { display: flex; justify-content: flex-start; margin-bottom: 0.5rem; }
        .back-to-learn-btn { opacity: 0.8; }
        .back-to-learn-btn:hover { opacity: 1; background: var(--slate-700); }
        .btn-idk { background: var(--slate-600); color: var(--slate-200); border: 2px dashed var(--slate-500); }
        .btn-idk:hover { background: var(--slate-500); border-color: var(--slate-400); }
        .test-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--slate-700); flex-wrap: wrap; gap: 1rem; }
        .test-header.testing-center-header { border-left: 4px solid var(--cyan-500); }
        .progress-info { display: flex; gap: 2rem; }
        .progress-item { text-align: center; }
        .progress-item .label { font-size: 0.8rem; color: var(--slate-400); text-transform: uppercase; }
        .progress-item .value { font-size: 1.5rem; font-weight: 700; color: var(--amber-400); font-family: 'Fraunces', serif; }
        .testing-center-header .progress-item .value { color: var(--cyan-400); }
        .tier-badge { background: var(--slate-700); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
        .tier-badge .tier-name { color: var(--amber-400); font-weight: 600; }
        .testing-center-header .tier-badge .tier-name { color: var(--cyan-400); }
        .question-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; }
        .question-meta { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .question-tag { font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 20px; font-weight: 500; text-transform: uppercase; }
        .tag-tier { background: var(--indigo-600); color: white; }
        .tag-domain { background: var(--slate-700); color: var(--slate-300); }
        .tag-type { background: var(--violet-500); color: white; }
        .tag-probe { background: var(--cyan-500); color: var(--slate-900); }
        .tag-practice { background: var(--emerald-500); color: white; }
        .question-text { font-size: 1.4rem; margin-bottom: 2rem; line-height: 1.5; }
        .answer-options { display: grid; gap: 1rem; }
        .answer-option { display: flex; align-items: center; padding: 1.25rem 1.5rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 1.1rem; }
        .answer-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .answer-option.selected { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .testing-center-mode .answer-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .answer-option .option-letter { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--slate-600); border-radius: 8px; margin-right: 1rem; font-weight: 700; color: var(--slate-300); flex-shrink: 0; }
        .answer-option.selected .option-letter { background: var(--amber-500); color: var(--slate-900); }
        .testing-center-mode .answer-option.selected .option-letter { background: var(--cyan-500); }
        .answer-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .answer-option.correct .option-letter { background: var(--emerald-500); color: white; }
        .answer-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); }
        .answer-option.incorrect .option-letter { background: var(--rose-500); color: white; }
        .timer-bar { height: 4px; background: var(--slate-700); border-radius: 2px; margin-top: 2rem; overflow: hidden; }
        .timer-fill { height: 100%; background: linear-gradient(90deg, var(--emerald-500), var(--amber-400)); border-radius: 2px; transition: width 0.1s linear; }
        .timer-fill.slow { background: linear-gradient(90deg, var(--amber-400), var(--rose-400)); }
        .timer-display { text-align: center; margin-top: 0.5rem; color: var(--slate-400); font-size: 0.9rem; }
        .explanation-box { margin-top: 1.5rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; border-left: 4px solid var(--cyan-500); display: none; }
        .explanation-box.show { display: block; }
        .explanation-box h4 { color: var(--cyan-400); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; }
        .explanation-box p { color: var(--slate-300); }
        .submit-area { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; flex-wrap: wrap; gap: 1rem; }
        .feedback { padding: 1rem 1.5rem; border-radius: 12px; font-weight: 500; display: none; }
        .feedback.show { display: block; }
        .feedback.correct { background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); border: 1px solid var(--emerald-500); }
        .feedback.incorrect { background: rgba(244, 63, 94, 0.15); color: var(--rose-400); border: 1px solid var(--rose-500); }
        .button-group { display: flex; gap: 0.75rem; }
        .tc-stats-bar { display: flex; gap: 1.5rem; padding: 1rem 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--slate-700); flex-wrap: wrap; }
        .tc-stat { display: flex; align-items: center; gap: 0.5rem; }
        .tc-stat .stat-label { color: var(--slate-400); font-size: 0.85rem; }
        .tc-stat .stat-value { color: var(--slate-200); font-weight: 600; }
        .tc-stat .stat-value.good { color: var(--emerald-400); }
        .tc-stat .stat-value.medium { color: var(--amber-400); }
        .tc-stat .stat-value.poor { color: var(--rose-400); }
        .results-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; }
        .results-card h2 { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .placement-result { text-align: center; padding: 3rem; background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border-radius: 16px; margin-bottom: 2rem; border: 2px solid var(--amber-500); }
        .testing-center-results .placement-result { border-color: var(--cyan-500); }
        .placement-result .tier-number { font-size: 5rem; font-weight: 700; font-family: 'Fraunces', serif; background: linear-gradient(135deg, var(--amber-400), var(--amber-300)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .testing-center-results .placement-result .tier-number { background: linear-gradient(135deg, var(--cyan-400), var(--cyan-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .placement-result .tier-title { font-size: 1.8rem; font-family: 'Fraunces', serif; margin-top: 0.5rem; }
        .placement-result .tier-grades { color: var(--slate-400); margin-top: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--slate-700); border-radius: 12px; padding: 1.5rem; text-align: center; }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Fraunces', serif; color: var(--amber-400); }
        .testing-center-results .stat-card .stat-value { color: var(--cyan-400); }
        .stat-card .stat-label { font-size: 0.8rem; color: var(--slate-400); text-transform: uppercase; margin-top: 0.25rem; }
        .fluency-badge { display: inline-block; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 600; margin-top: 1rem; }
        .fluency-automatic { background: var(--emerald-500); color: white; }
        .fluency-normal { background: var(--amber-500); color: var(--slate-900); }
        .fluency-slow { background: var(--rose-500); color: white; }
        .tier-row { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--slate-700); }
        .tier-row:last-child { border-bottom: none; }
        .tier-row .tier-label { width: 180px; font-weight: 500; color: var(--slate-300); }
        .tier-row .tier-bar { flex: 1; height: 24px; background: var(--slate-700); border-radius: 4px; overflow: hidden; margin: 0 1rem; }
        .tier-row .tier-fill { height: 100%; border-radius: 4px; }
        .tier-row .tier-fill.good { background: var(--emerald-500); }
        .tier-row .tier-fill.medium { background: var(--amber-500); }
        .tier-row .tier-fill.poor { background: var(--rose-500); }
        .tier-row .tier-score { width: 60px; text-align: right; font-weight: 600; color: var(--slate-300); }
        .gap-item { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid var(--rose-500); }
        .gap-item.idk { border-left-color: var(--slate-400); }
        .gap-item .gap-tier { background: var(--slate-600); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 1rem; }
        .gap-item .gap-skill { color: var(--slate-300); }
        .no-gaps { color: var(--emerald-400); padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center; }
        .rec-item { display: flex; align-items: flex-start; padding: 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; }
        .rec-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--amber-500); border-radius: 10px; margin-right: 1rem; font-size: 1.2rem; flex-shrink: 0; }
        .testing-center-results .rec-icon { background: var(--cyan-500); }
        .rec-content h4 { font-size: 1rem; margin-bottom: 0.25rem; }
        .rec-content p { color: var(--slate-400); font-size: 0.9rem; }
        .question-history { max-height: 400px; overflow-y: auto; margin-top: 1rem; }
        .history-item { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .history-item .q-number { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 700; margin-right: 1rem; flex-shrink: 0; }
        .history-item.correct .q-number { background: var(--emerald-500); color: white; }
        .history-item.incorrect .q-number { background: var(--rose-500); color: white; }
        .history-item.idk .q-number { background: var(--slate-500); color: white; }
        
        /* Learning Center Styles */
        .header.learning-center h1 { background: linear-gradient(135deg, var(--emerald-400), var(--emerald-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge-learning { background: var(--emerald-500); color: var(--slate-900); }
        .btn-emerald { background: linear-gradient(135deg, var(--emerald-500), var(--emerald-400)); color: var(--slate-900); }
        .btn-emerald:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .tier-select-row { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem; }
        .tier-select-btn { padding: 0.6rem 1rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; color: var(--slate-300); cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .tier-select-btn:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .tier-select-btn.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); }
        
        .skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .skill-card { padding: 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; position: relative; }
        .skill-card:hover { border-color: var(--slate-500); transform: translateY(-2px); }
        .skill-card.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .skill-card .skill-name { font-weight: 600; color: var(--slate-200); margin-bottom: 0.25rem; }
        .skill-card .skill-desc { font-size: 0.8rem; color: var(--slate-400); }

        /* Skill card states for tree integration */
        .skill-card.locked { opacity: 0.6; cursor: not-allowed; background: var(--slate-900); border-color: var(--slate-800); }
        .skill-card.locked:hover { transform: none; border-color: var(--slate-700); }
        .skill-card.locked .skill-name { color: var(--slate-500); }
        .skill-card.mastered { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .skill-card.mastered:hover { border-color: var(--amber-400); }
        .skill-card.in-progress { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .skill-card.needs-review { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); animation: pulseReview 2s ease-in-out infinite; }
        @keyframes pulseReview { 0%, 100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(244, 63, 94, 0); } }

        .skill-lock-icon { font-size: 1.5rem; margin: 0.5rem 0; }
        .skill-prereq-hint { font-size: 0.7rem; color: var(--slate-500); margin-top: 0.5rem; line-height: 1.3; }
        .skill-mastery-bar { height: 4px; background: var(--slate-700); border-radius: 2px; margin-top: 0.5rem; overflow: hidden; }

        /* Skill Legend */
        .skill-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 0.75rem 1rem;
            background: var(--slate-900);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }
        .skill-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--slate-400);
        }
        .skill-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }
        .skill-legend-dot.available { background: var(--slate-800); border-color: var(--slate-600); }
        .skill-legend-dot.in-progress { background: rgba(6, 182, 212, 0.2); border-color: var(--cyan-500); }
        .skill-legend-dot.mastered { background: rgba(245, 158, 11, 0.2); border-color: var(--amber-500); }
        .skill-legend-dot.needs-review { background: rgba(244, 63, 94, 0.2); border-color: var(--rose-500); }
        .skill-legend-dot.locked { background: var(--slate-900); border-color: var(--slate-700); opacity: 0.6; }
        .skill-mastery-fill { height: 100%; background: linear-gradient(90deg, var(--emerald-500), var(--amber-400)); border-radius: 2px; transition: width 0.3s ease; }
        .skill-badge { position: absolute; top: -8px; right: -8px; font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: 600; }
        .skill-badge.mastered { background: var(--amber-500); color: var(--slate-900); }
        .skill-badge.needs-review { background: var(--rose-500); color: white; }

        /* Notification toast animations */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* Belt Test → Tree Sync Results */
        .tree-sync-results { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; }
        .tree-sync-results h3 { font-family: 'Fraunces', serif; }
        .tree-sync-results .result-section { margin-bottom: 1rem; }
        .tree-sync-results h4 { font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 600; }
        .skill-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .skill-chip { display: inline-block; padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .skill-chip.mastered { background: rgba(245, 158, 11, 0.2); color: var(--amber-400); border: 1px solid var(--amber-500); }
        .skill-chip.activated { background: rgba(6, 182, 212, 0.2); color: var(--cyan-400); border: 1px solid var(--cyan-500); }
        .skill-chip.in-progress { background: rgba(148, 163, 184, 0.2); color: var(--slate-400); border: 1px solid var(--slate-600); }
        .skill-chip.inferred-mastered { background: rgba(139, 92, 246, 0.2); color: var(--violet-400); border: 1px solid var(--violet-500); }
        .skill-chip.inferred-activated { background: rgba(139, 92, 246, 0.15); color: var(--violet-300); border: 1px solid var(--violet-600); }
        .skill-chip.more { background: var(--slate-700); color: var(--slate-400); border: 1px solid var(--slate-600); }

        .learning-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--emerald-500); flex-wrap: wrap; gap: 1rem; }
        .learning-progress { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .phase-indicator { display: flex; align-items: center; gap: 0; }
        .phase-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--slate-700); border: 2px solid var(--slate-600); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: var(--slate-400); }
        .phase-dot.active { background: var(--emerald-500); border-color: var(--emerald-500); color: var(--slate-900); }
        .phase-dot.completed { background: var(--emerald-600); border-color: var(--emerald-500); color: white; }
        .phase-line { width: 40px; height: 3px; background: var(--slate-700); }
        .phase-line.completed { background: var(--emerald-500); }
        .phase-labels { display: flex; gap: 2rem; }
        .phase-label { font-size: 0.8rem; color: var(--slate-500); text-transform: uppercase; }
        .phase-label.active { color: var(--emerald-400); font-weight: 600; }
        
        .learning-skill-badge { display: flex; gap: 0.75rem; align-items: center; }
        .learning-skill-badge span:first-child { background: var(--indigo-600); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .learning-skill-badge span:last-child { color: var(--emerald-400); font-weight: 600; font-size: 1.1rem; }
        
        .learning-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; min-height: 400px; }
        .phase-content { display: none; animation: fadeIn 0.4s ease; }
        .phase-content.active { display: block; }
        .phase-content h2 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--emerald-400); }
        .phase-intro { color: var(--slate-400); margin-bottom: 1.5rem; }

        /* Sub-skill progress indicator */
        .subskill-progress { background: var(--slate-700); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
        .subskill-progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .subskill-parent { color: var(--slate-400); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .subskill-counter { color: var(--emerald-400); font-weight: 600; font-size: 0.9rem; }
        .subskill-progress-bar { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.75rem; }
        .subskill-pip { width: 32px; height: 32px; border-radius: 50%; background: var(--slate-600); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--slate-400); font-weight: 600; transition: all 0.3s ease; border: 2px solid transparent; }
        .subskill-pip.completed { background: var(--emerald-600); color: white; }
        .subskill-pip.current { border-color: var(--amber-500); background: var(--amber-500); color: var(--slate-900); transform: scale(1.15); box-shadow: 0 0 12px rgba(245, 158, 11, 0.5); }
        .subskill-pip:hover:not(.current) { background: var(--slate-500); }
        .subskill-current-name { text-align: center; color: var(--amber-400); font-weight: 600; font-size: 1rem; }

        .concept-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--slate-700); }
        .concept-text { color: var(--slate-300); font-size: 1.1rem; line-height: 1.7; }
        .concept-text strong { color: var(--emerald-400); }

        /* Step-by-step concept teaching styles */
        .concept-steps { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .concept-step { padding: 1.25rem; background: var(--slate-700); border-radius: 12px; border-left: 4px solid var(--slate-600); opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .concept-step.visible { opacity: 1; transform: translateY(0); border-left-color: var(--emerald-500); }
        .concept-step .step-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .concept-step .step-number { background: var(--emerald-500); color: var(--slate-900); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; }
        .concept-step .step-title { color: var(--emerald-400); font-weight: 600; font-size: 1.05rem; flex: 1; }
        .concept-step .step-read-btn { margin-left: auto; }
        .concept-step .step-explanation { color: var(--slate-300); line-height: 1.6; }
        .concept-step .step-visual { margin-top: 0.75rem; padding: 1rem; background: var(--slate-800); border-radius: 8px; font-family: monospace; color: var(--amber-400); font-size: 1.1rem; text-align: center; }

        .concept-reveal-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: var(--slate-700); border: 2px solid var(--emerald-500); border-radius: 8px; color: var(--emerald-400); cursor: pointer; font-size: 1rem; transition: all 0.2s; margin: 1rem auto; }
        .concept-reveal-btn:hover { background: rgba(16, 185, 129, 0.15); }
        .concept-reveal-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--slate-600); color: var(--slate-500); }
        .concept-reveal-btn .btn-icon { font-size: 1.2rem; }

        .starting-problem { background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border: 2px solid var(--indigo-500); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .starting-problem .problem-label { color: var(--indigo-400); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .starting-problem .problem-text { font-size: 1.4rem; color: var(--slate-100); font-family: monospace; }

        .final-answer { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 2px solid var(--emerald-500); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; opacity: 0; transform: scale(0.95); transition: all 0.4s ease; }
        .final-answer.visible { opacity: 1; transform: scale(1); }
        .final-answer .answer-label { color: var(--emerald-400); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .final-answer .answer-text { font-size: 1.6rem; color: var(--emerald-300); font-family: monospace; font-weight: 700; }
        .final-answer .answer-explanation { color: var(--slate-400); margin-top: 0.5rem; font-size: 0.95rem; }
        
        .example-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--slate-700); }
        .example-section h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .example-problem { font-size: 1.3rem; padding: 1rem 1.5rem; background: var(--slate-700); border-radius: 10px; margin-bottom: 1rem; font-family: 'Source Sans 3', monospace; }
        .example-steps { display: flex; flex-direction: column; gap: 0.75rem; }
        .example-step { display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem 1rem; background: #283548; border-radius: 8px; border-left: 3px solid var(--emerald-500); }
        .example-step .step-num { background: var(--emerald-500); color: var(--slate-900); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
        .example-step .step-content { color: var(--slate-300); }
        .example-step .step-math { font-family: monospace; color: var(--amber-400); margin-top: 0.25rem; }
        
        .key-points { margin-bottom: 2rem; }
        .key-points h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .key-points ul { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .key-points li { padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; color: var(--slate-300); border-left: 3px solid var(--emerald-500); }
        
        .common-mistakes h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .mistake-item { padding: 1rem; background: rgba(244, 63, 94, 0.1); border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--rose-500); }
        .mistake-item .mistake-wrong { color: var(--rose-400); font-weight: 600; margin-bottom: 0.25rem; }
        .mistake-item .mistake-why { color: var(--slate-400); font-size: 0.9rem; }
        
        .practice-problem { font-size: 1.4rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; margin-bottom: 1.5rem; text-align: center; }
        .practice-progress { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--slate-800); border-radius: 8px; }
        .practice-progress .progress-text { color: var(--slate-300); font-weight: 600; }
        .practice-progress .progress-dots { display: flex; gap: 0.5rem; }
        .practice-progress .progress-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--slate-600); transition: all 0.3s; }
        .practice-progress .progress-dot.completed { background: var(--emerald-500); }

        /* New Interactive Guided Phase Styles */
        .guided-problem-card { background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border: 2px solid var(--indigo-500); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .guided-problem-label { color: var(--indigo-400); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .guided-problem { font-size: 1.3rem; color: var(--slate-100); text-align: center; }

        .guided-progress { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--slate-800); border-radius: 8px; }
        .guided-progress .progress-text { color: var(--slate-400); font-size: 0.9rem; }
        .guided-progress .progress-dots { display: flex; gap: 0.5rem; }
        .guided-progress .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--slate-600); transition: all 0.3s; }
        .guided-progress .dot.completed { background: var(--emerald-500); }
        .guided-progress .dot.current { background: var(--amber-400); transform: scale(1.2); }

        .guided-steps-container { min-height: 200px; }
        .guided-completed-steps { margin-bottom: 1rem; }
        .guided-completed-step { padding: 1rem 1.25rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--emerald-500); border-radius: 0 8px 8px 0; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem; }
        .guided-completed-step .step-num { width: 28px; height: 28px; background: var(--emerald-500); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }
        .guided-completed-step .step-content { flex: 1; }
        .guided-completed-step .step-question { color: var(--slate-400); font-size: 0.9rem; }
        .guided-completed-step .step-answer { color: var(--emerald-400); font-weight: 600; font-family: monospace; }

        .guided-current-step-area { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05)); border: 2px solid var(--amber-500); border-radius: 12px; padding: 1.5rem; }
        .step-prompt { font-size: 1.2rem; color: var(--slate-100); margin-bottom: 0.75rem; text-align: center; }
        .step-hint { color: var(--slate-400); font-size: 0.95rem; margin-bottom: 1.25rem; text-align: center; font-style: italic; }

        .guided-input-area { display: flex; gap: 1rem; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem; }
        .guided-input { padding: 0.75rem 1.25rem; font-size: 1.3rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; color: var(--slate-100); width: 180px; text-align: center; font-family: monospace; }
        .guided-input:focus { outline: none; border-color: var(--amber-400); box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2); }
        .guided-submit { padding: 0.75rem 1.5rem; }

        .guided-feedback { padding: 1rem 1.5rem; border-radius: 10px; margin-top: 1rem; display: none; }
        .guided-feedback.show { display: block; animation: slideIn 0.3s ease; }
        .guided-feedback.correct { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--emerald-500); color: var(--emerald-400); }
        .guided-feedback.incorrect { background: rgba(244, 63, 94, 0.15); border: 1px solid var(--rose-500); color: var(--rose-400); }
        .guided-feedback.hint { background: rgba(251, 191, 36, 0.15); border: 1px solid var(--amber-500); color: var(--amber-400); }
        .guided-feedback .mistake-tip { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(244, 63, 94, 0.3); font-size: 0.95rem; }

        .guided-completion { text-align: center; padding: 2rem; }
        .guided-completion .completion-icon { font-size: 3rem; margin-bottom: 1rem; }
        .guided-completion .completion-message { font-size: 1.3rem; color: var(--emerald-400); margin-bottom: 1rem; }
        .final-answer-display { background: rgba(16, 185, 129, 0.15); border: 2px solid var(--emerald-500); border-radius: 12px; padding: 1.25rem; font-size: 1.4rem; color: var(--slate-100); font-family: monospace; }

        .guided-inline-actions { display: flex; justify-content: center; margin-top: 1.5rem; }

        /* Read Aloud Button Styles */
        .read-aloud-btn { background: var(--slate-600); border: 1px solid var(--slate-500); color: var(--slate-300); padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; transition: all 0.2s; }
        .read-aloud-btn:hover { background: var(--slate-500); color: var(--slate-100); }
        .read-aloud-btn.speaking { background: var(--emerald-600); border-color: var(--emerald-500); color: white; animation: pulse 1.5s infinite; }
        .read-aloud-btn .speaker-icon { font-size: 1rem; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .step-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .step-prompt-text { flex: 1; font-size: 1.2rem; color: var(--slate-100); text-align: center; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .practice-feedback { padding: 1rem 1.5rem; border-radius: 10px; margin-top: 1rem; display: none; }
        .practice-feedback.show { display: block; }
        .practice-feedback.correct { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--emerald-500); color: var(--emerald-400); }
        .practice-feedback.incorrect { background: rgba(244, 63, 94, 0.15); border: 1px solid var(--rose-500); color: var(--rose-400); }
        
        .practice-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .practice-option { padding: 1.25rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 12px; cursor: pointer; text-align: center; font-size: 1.2rem; transition: all 0.2s; }
        .practice-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .practice-option.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .practice-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); }
        .practice-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.15); }
        .practice-option.correct-answer { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.2); }
        
        .mistake-analysis { margin-top: 1.5rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; display: none; }
        .mistake-analysis.show { display: block; }
        .mistake-analysis h4 { color: var(--amber-400); margin-bottom: 0.75rem; }
        .mistake-analysis p { color: var(--slate-300); }
        .practice-ok-btn { margin-top: 1rem; width: 100%; }

        .guided-select-options { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
        .guided-select-option { padding: 0.75rem 1.5rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; cursor: pointer; font-size: 1rem; color: var(--slate-200); transition: all 0.2s; }
        .guided-select-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .guided-select-option.selected { border-color: var(--emerald-500); }
        .guided-select-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); }
        .guided-select-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.15); color: var(--rose-400); }
        
        .learning-actions { display: flex; justify-content: space-between; margin-top: 2rem; }
        .history-item .q-text { flex: 1; color: var(--slate-300); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item .q-time { margin-left: 1rem; color: var(--slate-500); font-size: 0.85rem; }
        .history-item .q-tier { margin-left: 0.75rem; font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--slate-600); border-radius: 4px; color: var(--slate-400); }
        @media (max-width: 900px) {
            .mode-selector { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .level-selector, .tier-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .test-header { flex-direction: column; }
            .practice-options { grid-template-columns: 1fr; }
        }

        /* Visual Container Styles */
        .visual-container {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60px;
        }
        .visual-container:empty { display: none; }

        /* Number Line Styles */
        .dojo-number-line {
            position: relative;
            width: 100%;
            max-width: 500px;
            padding: 2rem 1rem 1.5rem;
            user-select: none;
            touch-action: none;
        }
        .dojo-number-line-track {
            position: relative;
            height: 4px;
            background: var(--slate-600);
            border-radius: 2px;
        }
        .dojo-number-line-tick {
            position: absolute;
            width: 2px;
            height: 12px;
            background: var(--slate-500);
            transform: translateX(-50%);
            top: -4px;
        }
        .dojo-number-line-tick.major {
            height: 16px;
            background: var(--slate-400);
            top: -6px;
        }
        .dojo-number-line-label {
            position: absolute;
            transform: translateX(-50%);
            top: 16px;
            font-size: 0.8rem;
            color: var(--slate-400);
        }
        .dojo-number-line-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--amber-500);
            border-radius: 50%;
            top: -8px;
            transform: translateX(-50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 10;
        }
        .dojo-number-line-marker:hover { transform: translateX(-50%) scale(1.1); }
        .dojo-number-line-marker.dragging {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.2);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.6);
        }
        .dojo-number-line-value {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--slate-700);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--amber-400);
            font-weight: 600;
            white-space: nowrap;
        }
        .dojo-number-line-fixed-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--cyan-500);
            border-radius: 50%;
            top: -2px;
            transform: translateX(-50%);
        }

        /* Shape Styles */
        .dojo-shape-svg {
            max-width: 300px;
            max-height: 200px;
        }
        .dojo-shape-svg .shape-fill { fill: rgba(139, 92, 246, 0.2); stroke: var(--violet-500); stroke-width: 2; }
        .dojo-shape-svg .shape-fill.shaded { fill: rgba(139, 92, 246, 0.5); }
        .dojo-shape-svg .dimension-line { stroke: var(--slate-400); stroke-width: 1; stroke-dasharray: 4 2; }
        .dojo-shape-svg .dimension-line.highlight { stroke: var(--amber-500); stroke-width: 2; stroke-dasharray: none; }
        .dojo-shape-svg .dimension-text { fill: var(--slate-300); font-size: 12px; }
        .dojo-shape-svg .dimension-text.highlight { fill: var(--amber-400); font-weight: 600; font-size: 14px; }
        .dojo-shape-svg .angle-arc { fill: none; stroke: var(--amber-400); stroke-width: 1.5; }
        .dojo-shape-svg .angle-text { fill: var(--amber-400); font-size: 11px; }
        .dojo-shape-svg .highlight { stroke: var(--amber-500); stroke-width: 3; }

        /* Coordinate Plane Styles */
        .dojo-coordinate-svg {
            max-width: 350px;
            max-height: 350px;
            background: var(--slate-800);
            border-radius: 8px;
        }
        .dojo-coordinate-svg .grid-line { stroke: var(--slate-700); stroke-width: 1; }
        .dojo-coordinate-svg .axis-line { stroke: var(--slate-400); stroke-width: 2; }
        .dojo-coordinate-svg .axis-label { fill: var(--slate-400); font-size: 10px; }
        .dojo-coordinate-svg .plot-point { fill: var(--cyan-500); }
        .dojo-coordinate-svg .plot-point.interactive { cursor: pointer; fill: var(--amber-500); }
        .dojo-coordinate-svg .graph-line { fill: none; stroke: var(--emerald-500); stroke-width: 2; }
        .dojo-coordinate-svg .graph-line.secondary { stroke: var(--amber-500); }
        .dojo-coordinate-svg .point-label { fill: var(--slate-300); font-size: 11px; }

        /* Fraction Visual Styles */
        .dojo-fraction-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .dojo-fraction-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .dojo-fraction-bar {
            display: flex;
            border: 2px solid var(--slate-500);
            border-radius: 4px;
            overflow: hidden;
            height: 40px;
            min-width: 200px;
        }
        .dojo-fraction-bar-segment {
            flex: 1;
            border-right: 1px solid var(--slate-600);
            background: var(--slate-700);
        }
        .dojo-fraction-bar-segment:last-child { border-right: none; }
        .dojo-fraction-bar-segment.filled { background: var(--violet-500); }
        .dojo-fraction-label {
            font-size: 1.2rem;
            color: var(--slate-300);
            font-weight: 600;
        }
        .dojo-fraction-circle {
            width: 120px;
            height: 120px;
        }
        .dojo-fraction-circle .slice { fill: var(--slate-700); stroke: var(--slate-500); stroke-width: 2; }
        .dojo-fraction-circle .slice.filled { fill: var(--violet-500); }

        /* Clock Styles */
        .dojo-clock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .dojo-clock-canvas {
            background: var(--slate-700);
            border-radius: 50%;
            border: 3px solid var(--slate-500);
        }
        .dojo-clock-display {
            font-size: 1.2rem;
            color: var(--amber-400);
            font-weight: 600;
        }

        /* Chart Styles */
        .dojo-chart-container {
            width: 100%;
            max-width: 400px;
        }
        .dojo-bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 0.75rem;
            height: 150px;
            padding: 0.5rem;
            border-left: 2px solid var(--slate-500);
            border-bottom: 2px solid var(--slate-500);
        }
        .dojo-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
        }
        .dojo-bar-fill {
            width: 100%;
            background: linear-gradient(to top, var(--cyan-600), var(--cyan-400));
            border-radius: 4px 4px 0 0;
            transition: height 0.3s;
        }
        .dojo-bar-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--slate-400);
            text-align: center;
        }
        .dojo-bar-value {
            font-size: 0.8rem;
            color: var(--slate-200);
            margin-bottom: 0.25rem;
        }
        .dojo-line-chart {
            position: relative;
            height: 150px;
            padding: 0.5rem;
            border-left: 2px solid var(--slate-500);
            border-bottom: 2px solid var(--slate-500);
        }
        .dojo-line-chart svg { width: 100%; height: 100%; }
        .dojo-line-chart .chart-line { fill: none; stroke: var(--emerald-500); stroke-width: 2; }
        .dojo-line-chart .chart-point { fill: var(--emerald-400); }
        .dojo-picture-chart {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .dojo-picture-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .dojo-picture-row-label {
            min-width: 60px;
            font-size: 0.85rem;
            color: var(--slate-400);
        }
        .dojo-picture-icons {
            display: flex;
            gap: 0.25rem;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mode-screen" class="screen active">
            <header class="header"><h1>🥋 Math Dojo</h1><p>Train Your Mind, Master Your Skills</p></header>
            <h2 style="text-align:center;margin-bottom:1rem;color:var(--slate-200)">Choose Your Training</h2>
            <p style="text-align:center;color:var(--slate-400);margin-bottom:2rem">Select your path to mathematical mastery</p>
            <div class="mode-selector">
                <div class="mode-card placement" onclick="selectMode('placement')">
                    <div class="mode-icon">🎖️</div><h3>Belt Test</h3>
                    <div class="mode-subtitle">Prove Your Skill</div>
                    <div class="mode-description">Take an adaptive test to earn your math belt ranking.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">✓</span> Adaptive difficulty</div>
                        <div class="mode-feature"><span class="check">✓</span> Earn your belt rank</div>
                        <div class="mode-feature"><span class="check">✓</span> Weakness analysis</div>
                        <div class="mode-feature"><span class="check">✓</span> 20-40 adaptive challenges</div>
                    </div>
                </div>
                <div class="mode-card learning" onclick="selectMode('learning')">
                    <div class="mode-icon">🥋</div><h3>Training Grounds</h3>
                    <div class="mode-subtitle">Learn the Forms</div>
                    <div class="mode-description">Master new techniques step-by-step with a sensei's guidance.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">✓</span> Technique breakdowns</div>
                        <div class="mode-feature"><span class="check">✓</span> Worked examples</div>
                        <div class="mode-feature"><span class="check">✓</span> Guided practice</div>
                        <div class="mode-feature"><span class="check">✓</span> Error correction</div>
                    </div>
                </div>
                <div class="mode-card testing" onclick="selectMode('testing')">
                    <div class="mode-icon">⚔️</div><h3>Sparring Arena</h3>
                    <div class="mode-subtitle">Hone Your Skills</div>
                    <div class="mode-description">Practice specific techniques at your own pace.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">✓</span> Choose your challenges</div>
                        <div class="mode-feature"><span class="check">✓</span> Unlimited practice</div>
                        <div class="mode-feature"><span class="check">✓</span> Detailed feedback</div>
                        <div class="mode-feature"><span class="check">✓</span> End anytime</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="placement-setup-screen" class="screen">
            <header class="header"><div class="header-badge badge-placement">Belt Test</div><h1>🎖️ Belt Ranking Assessment</h1><p>Prove Your Mathematical Prowess</p></header>
            <h2 style="text-align:center;margin-bottom:1rem;color:var(--slate-200)">Select Your Starting Dojo</h2>
            <p style="text-align:center;color:var(--slate-400);margin-bottom:2rem">Choose the level closest to your current ability.</p>
            <div class="level-selector">
                <div class="level-card" onclick="selectLevel(this, 2)"><h3>Elementary</h3><div class="grades">Grades K-4</div><div class="tiers">Starts at Tier 2</div><div class="tier-list">Counting • Addition/Subtraction<br>Multiplication • Division</div></div>
                <div class="level-card" onclick="selectLevel(this, 5)"><h3>Middle School</h3><div class="grades">Grades 5-8</div><div class="tiers">Starts at Tier 5</div><div class="tier-list">Algebra I • Pre-Algebra<br>Equations • Functions</div></div>
                <div class="level-card" onclick="selectLevel(this, 7)"><h3>High School</h3><div class="grades">Grades 9-12</div><div class="tiers">Starts at Tier 7</div><div class="tier-list">Algebra II • Geometry<br>Pre-Calculus • Trigonometry</div></div>
            </div>
            <div style="display:flex;gap:1rem;justify-content:center"><button class="btn btn-ghost" onclick="goToModeSelect()">← Back</button><button id="start-placement-btn" class="btn btn-primary" onclick="startPlacementTest()" disabled>Begin Belt Test</button></div>
        </div>

        <div id="testing-setup-screen" class="screen">
            <header class="header testing-center"><div class="header-badge badge-testing">Sparring Arena</div><h1>⚔️ Sparring Arena</h1><p>Configure your training session</p></header>
            <div class="testing-mode">
                <!-- Selection Mode Toggle -->
                <div style="display:flex;gap:1rem;justify-content:center;margin-bottom:1.5rem;flex-wrap:wrap;">
                    <button class="selection-btn active" id="select-by-tier-btn" onclick="setSelectionMode('tier')">Select by Tier</button>
                    <button class="selection-btn" id="select-by-skill-btn" onclick="setSelectionMode('skill')">Select by Skill</button>
                    <button class="selection-btn needs-practice-btn" id="select-needs-practice-btn" onclick="setSelectionMode('needs-practice')">🎯 Needs Practice</button>
                </div>

                <!-- Needs Practice Panel -->
                <div id="needs-practice-panel" style="display:none;">
                    <h2 style="margin-bottom:1rem;color:var(--rose-400)">🎯 Skills That Need Practice</h2>
                    <p style="color:var(--slate-400);margin-bottom:1rem;">Auto-targeting skills based on your skill tree progress: decayed skills, low mastery, and skills you're working on.</p>
                    <div id="needs-practice-summary" style="margin-bottom:1rem;"></div>
                    <div class="skill-grid" id="needs-practice-grid" style="max-height:300px;overflow-y:auto;padding:0.5rem;"></div>
                    <div id="no-needs-practice" style="display:none;text-align:center;padding:2rem;color:var(--slate-400);">
                        <div style="font-size:3rem;margin-bottom:1rem;">✨</div>
                        <div style="font-size:1.1rem;">All caught up! No skills need practice right now.</div>
                        <div style="font-size:0.9rem;margin-top:0.5rem;">Try the Belt Test to unlock more skills.</div>
                    </div>
                </div>

                <!-- Tier Selection Panel -->
                <div id="tier-selection-panel">
                    <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select Tiers to Practice</h2>
                    <div class="selection-actions">
                        <button class="selection-btn" onclick="selectAllTiers()">Select All</button>
                        <button class="selection-btn" onclick="clearTierSelection()">Clear All</button>
                        <button class="selection-btn" onclick="selectTierRange(1,2)">Elementary</button>
                        <button class="selection-btn" onclick="selectTierRange(3,5)">Middle</button>
                        <button class="selection-btn" onclick="selectTierRange(6,10)">High</button>
                    </div>
                    <div class="tier-grid" id="tier-selection-grid"></div>
                </div>

                <!-- Skill Selection Panel -->
                <div id="skill-selection-panel" style="display:none;">
                    <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select Skills to Practice</h2>
                    <div class="selection-actions">
                        <button class="selection-btn" onclick="selectAllSkills()">Select All</button>
                        <button class="selection-btn" onclick="clearSkillSelection()">Clear All</button>
                    </div>
                    <div style="margin:1rem 0;">
                        <label style="color:var(--slate-300);margin-right:0.5rem;">Filter by Tier:</label>
                        <select id="skill-tier-filter" onchange="filterSkillsByTier()" style="padding:0.5rem;border-radius:8px;background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600);">
                            <option value="all">All Tiers</option>
                        </select>
                    </div>
                    <div class="skill-legend">
                        <div class="skill-legend-item"><span class="skill-legend-dot available"></span> Available</div>
                        <div class="skill-legend-item"><span class="skill-legend-dot mastered"></span> Mastered</div>
                        <div class="skill-legend-item"><span class="skill-legend-dot needs-review"></span> Needs Review</div>
                        <div class="skill-legend-item"><span class="skill-legend-dot locked"></span> Locked</div>
                    </div>
                    <div class="skill-grid" id="arena-skill-grid" style="max-height:300px;overflow-y:auto;padding:0.5rem;"></div>
                </div>

                <!-- Practice Mode Options -->
                <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--slate-700);">
                    <h2 style="margin-bottom:1rem;color:var(--slate-200)">Practice Mode</h2>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
                        <div class="mode-option selected" data-practice-mode="endless" onclick="setPracticeMode('endless')">
                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">♾️</div>
                            <div style="font-weight:600;color:var(--slate-200);">Endless</div>
                            <div style="font-size:0.8rem;color:var(--slate-400);">Practice until you stop</div>
                        </div>
                        <div class="mode-option" data-practice-mode="timed" onclick="setPracticeMode('timed')">
                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">⏱️</div>
                            <div style="font-weight:600;color:var(--slate-200);">Timed Challenge</div>
                            <div style="font-size:0.8rem;color:var(--slate-400);">Complete as many as possible</div>
                        </div>
                        <div class="mode-option" data-practice-mode="countdown" onclick="setPracticeMode('countdown')">
                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">🎯</div>
                            <div style="font-weight:600;color:var(--slate-200);">Question Goal</div>
                            <div style="font-size:0.8rem;color:var(--slate-400);">Race to finish N questions</div>
                        </div>
                    </div>

                    <!-- Timed Mode Options -->
                    <div id="timed-options" style="display:none;margin-top:1rem;padding:1rem;background:var(--slate-800);border-radius:12px;">
                        <label style="color:var(--slate-300);">Time Limit:</label>
                        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;align-items:center;">
                            <button class="time-btn selected" data-time="60" onclick="setTimeLimit(60)">1 min</button>
                            <button class="time-btn" data-time="120" onclick="setTimeLimit(120)">2 min</button>
                            <button class="time-btn" data-time="300" onclick="setTimeLimit(300)">5 min</button>
                            <button class="time-btn" data-time="600" onclick="setTimeLimit(600)">10 min</button>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <input type="number" id="custom-time-input" min="1" max="60" placeholder="Custom" style="width:70px;padding:0.5rem;border-radius:8px;background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600);text-align:center;" onchange="setCustomTimeLimit()">
                                <span style="color:var(--slate-400);">min</span>
                            </div>
                        </div>
                    </div>

                    <!-- Countdown Mode Options -->
                    <div id="countdown-options" style="display:none;margin-top:1rem;padding:1rem;background:var(--slate-800);border-radius:12px;">
                        <label style="color:var(--slate-300);">Number of Questions:</label>
                        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;align-items:center;">
                            <button class="count-btn selected" data-count="10" onclick="setQuestionCount(10)">10</button>
                            <button class="count-btn" data-count="20" onclick="setQuestionCount(20)">20</button>
                            <button class="count-btn" data-count="30" onclick="setQuestionCount(30)">30</button>
                            <button class="count-btn" data-count="50" onclick="setQuestionCount(50)">50</button>
                            <input type="number" id="custom-count-input" min="1" max="500" placeholder="Custom" style="width:80px;padding:0.5rem;border-radius:8px;background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600);text-align:center;" onchange="setCustomQuestionCount()">
                        </div>
                    </div>
                </div>

                <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem"><button class="btn btn-ghost" onclick="goToModeSelect()">← Back</button><button id="start-testing-btn" class="btn btn-cyan" onclick="startTestingCenter()" disabled>Enter the Arena</button></div>
            </div>
        </div>

        <div id="learning-setup-screen" class="screen">
            <header class="header learning-center"><div class="header-badge badge-learning">Training Grounds</div><h1>🥋 Training Grounds</h1><p>Learn new techniques with guided instruction</p></header>
            <div class="learning-setup">
                <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select a Discipline</h2>
                <div class="tier-select-row" id="learning-tier-select"></div>
                <h2 style="margin:2rem 0 1rem;color:var(--slate-200)">Select a Technique to Learn</h2>
                <div class="skill-legend">
                    <div class="skill-legend-item"><span class="skill-legend-dot available"></span> Available</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot in-progress"></span> In Progress</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot mastered"></span> Mastered</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot needs-review"></span> Needs Review</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot locked"></span> Locked</div>
                </div>
                <div class="skill-grid" id="skill-grid"></div>
                <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem"><button class="btn btn-ghost" onclick="goToModeSelect()">← Back</button><button id="start-learning-btn" class="btn btn-emerald" onclick="startLearning()" disabled>Begin Training</button></div>
            </div>
        </div>

        <div id="learning-screen" class="screen">
            <div class="learning-header">
                <div class="learning-progress">
                    <div class="phase-indicator">
                        <div class="phase-dot active" data-phase="learn">1</div>
                        <div class="phase-line"></div>
                        <div class="phase-dot" data-phase="guided">2</div>
                        <div class="phase-line"></div>
                        <div class="phase-dot" data-phase="practice">3</div>
                    </div>
                    <div class="phase-labels">
                        <span class="phase-label active" data-phase="learn">Learn</span>
                        <span class="phase-label" data-phase="guided">Guided</span>
                        <span class="phase-label" data-phase="practice">Practice</span>
                    </div>
                </div>
                <div class="learning-skill-badge">
                    <span id="learning-tier-badge">Tier 2</span>
                    <span id="learning-skill-name">Addition</span>
                </div>
            </div>

            <div class="learning-card" id="learning-card">
                <!-- Phase 1: Learn (I Do) -->
                <div class="learn-phase phase-content active" id="phase-learn">
                    <!-- Sub-skill progress indicator (hidden unless lesson has sub-skills) -->
                    <div id="subskill-progress-container" style="display:none;"></div>
                    <div class="concept-section">
                        <h2>📖 Let's Learn Step by Step</h2>
                        <div class="starting-problem" id="starting-problem">
                            <div class="problem-label">🎯 Our Goal</div>
                            <div class="problem-text" id="goal-problem-text"></div>
                        </div>
                        <div class="concept-steps" id="concept-steps"></div>
                        <div id="reveal-btn-container">
                            <button class="concept-reveal-btn" id="reveal-next-btn" onclick="revealNextConceptStep()">
                                <span class="btn-icon">👉</span>
                                <span>Show Next Step</span>
                            </button>
                        </div>
                        <div class="final-answer" id="final-answer">
                            <div class="answer-label">✅ The Answer</div>
                            <div class="answer-text" id="answer-text"></div>
                            <div class="answer-explanation" id="answer-explanation"></div>
                        </div>
                    </div>
                    <div class="key-points" id="key-points-section" style="display:none;">
                        <h3>💡 Key Points to Remember</h3>
                        <ul id="key-points-list"></ul>
                    </div>
                    <div class="common-mistakes" id="mistakes-section" style="display:none;">
                        <h3>⚠️ Common Mistakes to Avoid</h3>
                        <div id="common-mistakes-list"></div>
                    </div>
                </div>

                <!-- Phase 2: Guided Practice (We Do) -->
                <div class="guided-phase phase-content" id="phase-guided">
                    <div class="phase-header-row" style="display:flex;gap:1rem;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                        <button class="btn btn-ghost" onclick="previousLearningPhase()">← Back to Learn</button>
                        <button class="btn btn-ghost" onclick="endLearning()">✕ Exit to Skills</button>
                    </div>
                    <h2>🤝 Let's Solve Together</h2>
                    <p class="phase-intro">I'll guide you through each step - you provide the answers!</p>
                    <div class="guided-problem-card" id="guided-problem-card">
                        <div class="guided-problem-label">📝 Your Problem:</div>
                        <div class="guided-problem" id="guided-problem"></div>
                    </div>
                    <div class="guided-progress" id="guided-progress">
                        <span class="progress-text">Step <span id="guided-current-step">1</span> of <span id="guided-total-steps">3</span></span>
                        <div class="progress-dots" id="guided-progress-dots"></div>
                    </div>
                    <div class="guided-steps-container" id="guided-steps-container">
                        <div class="guided-completed-steps" id="guided-completed-steps"></div>
                        <div class="guided-current-step-area" id="guided-current-step-area">
                            <div class="step-prompt" id="guided-step-prompt"></div>
                            <div class="step-hint" id="guided-step-hint"></div>
                            <div class="guided-input-area" id="guided-input-area">
                                <input type="text" class="guided-input" id="guided-answer-input" placeholder="Your answer">
                                <button class="btn btn-emerald guided-submit" onclick="checkGuidedStepAnswer()">Check</button>
                            </div>
                            <div class="guided-feedback" id="guided-feedback"></div>
                        </div>
                    </div>
                    <div class="guided-completion" id="guided-completion" style="display:none;">
                        <div class="completion-icon">🎉</div>
                        <div class="completion-message">Great job! You completed the guided practice!</div>
                        <div class="final-answer-display" id="guided-final-answer"></div>
                        <div class="guided-inline-actions" id="guided-inline-actions">
                            <button class="btn btn-emerald" onclick="nextLearningPhase()">Continue to Practice →</button>
                        </div>
                    </div>
                </div>

                <!-- Phase 3: Independent Practice (You Do) -->
                <div class="practice-phase phase-content" id="phase-practice">
                    <div class="phase-header-row" style="display:flex;gap:1rem;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                        <button class="btn btn-ghost" onclick="goBackToLearn()">← Back to Learn</button>
                        <button class="btn btn-ghost" onclick="endLearning()">✕ Exit to Skills</button>
                    </div>
                    <h2>🎯 Now You Try!</h2>
                    <p class="phase-intro">Get 3 correct in a row to complete the lesson.</p>
                    <div class="practice-progress" id="practice-progress">
                        <span class="progress-text"><span id="practice-correct-count">0</span> / 3 in a row</span>
                        <div class="progress-dots">
                            <span class="progress-dot" id="dot-1"></span>
                            <span class="progress-dot" id="dot-2"></span>
                            <span class="progress-dot" id="dot-3"></span>
                        </div>
                    </div>
                    <div class="practice-problem" id="practice-problem"></div>
                    <div class="practice-options" id="practice-options"></div>
                    <div class="practice-feedback" id="practice-feedback"></div>
                    <div class="mistake-analysis" id="mistake-analysis"></div>
                </div>
            </div>

            <div class="learning-actions">
                <button class="btn btn-ghost" onclick="endLearning()">← Exit</button>
                <button class="btn btn-emerald" id="learning-continue-btn" onclick="nextLearningPhase()">Continue →</button>
            </div>
        </div>

        <div id="test-screen" class="screen">
            <div class="test-header" id="test-header">
                <div class="progress-info">
                    <div class="progress-item"><div class="label">Question</div><div class="value" id="question-number">1</div></div>
                    <div class="progress-item"><div class="label">Correct</div><div class="value" id="correct-count">0</div></div>
                </div>
                <div class="tier-badge">Current: <span class="tier-name" id="current-tier-display">Tier 5</span></div>
            </div>
            <div class="tc-stats-bar" id="tc-stats-bar" style="display:none">
                <div class="tc-stat"><span>📊</span><span class="stat-label">Accuracy:</span><span class="stat-value" id="tc-accuracy">--%</span></div>
                <div class="tc-stat"><span>⏱️</span><span class="stat-label">Avg:</span><span class="stat-value" id="tc-avg-time">--s</span></div>
                <div class="tc-stat"><span>🔥</span><span class="stat-label">Streak:</span><span class="stat-value" id="tc-streak">0</span></div>
                <div class="tc-stat" id="arena-timer-stat"><span>⏳</span><span class="stat-label" id="arena-timer-label">Time:</span><span class="stat-value" id="arena-timer-display" style="font-size:1.2rem;">--</span></div>
            </div>
            <div class="question-card">
                <div class="question-meta" id="question-meta"><span class="question-tag tag-tier" id="tag-tier">Tier 5</span><span class="question-tag tag-domain" id="tag-domain">Algebra</span><span class="question-tag tag-type" id="tag-type">Procedural</span></div>
                <div class="question-text" id="question-text">Loading...</div>
                <div class="visual-container" id="visual-container"></div>
                <div class="answer-options" id="answer-options"></div>
                <div class="explanation-box" id="explanation-box"><h4>💡 Explanation</h4><p id="explanation-text"></p></div>
                <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
                <div class="timer-display" id="timer-display">0.0s</div>
            </div>
            <div class="submit-area">
                <div class="feedback" id="feedback"></div>
                <div class="button-group">
                    <button id="end-session-btn" class="btn btn-secondary" onclick="endTest()" style="display:none">End Session</button>
                    <button id="idk-btn" class="btn btn-idk" onclick="submitIDK()" style="display:none">I Don't Know</button>
                    <button id="submit-btn" class="btn btn-primary" onclick="submitAnswer()" disabled>Submit Answer</button>
                    <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()" style="display:none">Next →</button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="screen">
            <div class="results-card">
                <h2 id="results-title">Results</h2>
                <div class="placement-result">
                    <div class="tier-number" id="result-tier-number">5</div>
                    <div class="tier-title" id="result-tier-title">Algebra I</div>
                    <div class="tier-grades" id="result-tier-grades">Grades 9-10</div>
                    <div class="fluency-badge fluency-normal" id="fluency-badge">Normal Fluency</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Questions</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-correct">0</div><div class="stat-label">Correct</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-idk">0</div><div class="stat-label">Unknown</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-accuracy">0%</div><div class="stat-label">Accuracy</div></div>
                </div>
            </div>
            <div class="results-card"><h2>Performance by Tier</h2><div class="tier-breakdown" id="tier-breakdown"></div></div>
            <div class="results-card"><h2>Gap Analysis</h2><div id="gap-log"></div></div>
            <div class="results-card"><h2>Recommendations</h2><div class="recommendations" id="recommendations"></div></div>
            <div class="results-card" id="tree-sync-card" style="display:none;"><h2>🌳 Skill Tree Progress</h2><div id="tree-sync-results"></div></div>
            <div class="results-card"><h2>Question History</h2><div class="question-history" id="question-history"></div></div>
            <div style="text-align:center;margin-top:2rem"><button class="btn btn-secondary" onclick="goToModeSelect()">← Back to Menu</button><button class="btn btn-primary" onclick="window.print()" style="margin-left:1rem">Print Results</button></div>
        </div>
    </div>

    <script>
// ========================================
// TIER & DOMAIN DEFINITIONS
// ========================================
const TIERS = {
    1: { name: "Foundations", grades: "K-1", domains: [
        "Counting", "Comparison", "Addition", "Subtraction", "Shapes", "Place Value",
        "Patterns", "Skip Counting", "Number Lines", "Even and Odd", "Ordering Numbers",
        "Teen Numbers", "Number Bonds", "Picture Graphs", "3D Shapes", "Partitioning Shapes",
        "Composing Shapes", "Comparing Lengths", "Positional Words", "Classifying Objects"
    ]},
    2: { name: "Core Operations", grades: "2-4", domains: [
        "Multi-Digit Addition", "Multi-Digit Subtraction", "Multiplication", "Division",
        "Long Division", "Fractions", "Fraction Operations", "Equivalent Fractions",
        "Simplifying Fractions", "Mixed Numbers", "Fraction Word Problems",
        "Word Problems", "Time", "Money", "Rounding", "Estimation", "Measurement",
        "Perimeter", "Arrays and Area Models", "Factors and Multiples", "Prime and Composite",
        "Area", "Bar Graphs", "Line Plots", "Line Symmetry", "Types of Angles",
        "Types of Lines", "Mass and Capacity", "Elapsed Time", "Multiplication Properties"
    ]},
    3: { name: "Rational Numbers", grades: "5-7", domains: [
        "Fractions", "Decimals", "Integers", "Percents", "Ratios", "Proportions",
        "Statistics", "Data Collection", "Mean Median Mode", "Unit Conversion",
        "Basic Graphing", "Absolute Value", "Scientific Notation", "Square Roots",
        "GCF and LCM", "Powers of 10", "Coordinate Plane", "Volume", "Order of Operations",
        "Expressions with Variables", "One-Step Equations", "Simple Probability",
        "Comparing Distributions", "Nets of 3D Shapes"
    ]},
    4: { name: "Pre-Algebra", grades: "7-8", domains: [
        "Equations", "Exponents", "Slope", "Pythagorean", "Angles and Lines",
        "Algebraic Expressions", "Surface Area", "Two-Way Tables", "Scatter Plots",
        "Box Plots", "Probability Basics", "Irrational Numbers", "Cube Roots",
        "Compound Probability", "Sampling Methods", "Transformations", "Similar Figures",
        "Parallel Lines and Transversals", "Volume of Cylinders Cones Spheres"
    ]},
    5: { name: "Algebra I", grades: "8-9", domains: [
        "Linear Equations", "Systems", "Factoring", "Functions", "Inequalities",
        "Radicals", "Exponential Functions", "Arithmetic Sequences", "Geometric Sequences",
        "Compound Interest", "Domain and Range", "Multi-Step Equations", "Literal Equations",
        "Absolute Value Equations", "Graphing Linear Inequalities", "Systems by Graphing",
        "Systems by Substitution", "Systems by Elimination", "Correlation and Trend Lines"
    ]},
    6: { name: "Geometry", grades: "9-10", domains: [
        "Area", "Volume", "Triangles", "Circles", "Trigonometry", "Transformations",
        "Similarity", "Congruence", "Proofs", "Law of Sines", "Law of Cosines",
        "Coordinate Geometry", "Angle Bisectors", "Perpendicular Bisectors",
        "Triangle Inequality", "Triangle Centers", "Midsegments", "Inscribed Angles",
        "Arc Length", "Sector Area", "Tangent Lines", "Dilations"
    ]},
    7: { name: "Algebra II", grades: "10-11", domains: [
        "Quadratics", "Completing the Square", "Logarithms", "Polynomials",
        "Sequences", "Probability", "Conic Sections", "Rational Functions",
        "Piecewise Functions", "Asymptotes", "Permutations", "Combinations",
        "Expected Value", "Synthetic Division", "Binomial Theorem", "Matrices Intro"
    ]},
    8: { name: "Pre-Calculus", grades: "11-12", domains: [
        "Trig Functions", "Radian Measure", "Inverse Trig", "Limits",
        "Complex Numbers", "Vectors", "Advanced Functions", "Parametric Equations",
        "Polar Coordinates", "Normal Distribution", "Unit Circle", "Trig Identities",
        "Graphing Trig Functions", "Series Convergence"
    ]},
    9: { name: "Calculus", grades: "12+", domains: [
        "Derivatives", "Integrals", "Limits", "Applications", "Differential Equations",
        "Chain Rule", "Product Rule", "Integration Techniques", "Quotient Rule",
        "Implicit Differentiation", "Related Rates", "U-Substitution", "Integration by Parts"
    ]},
    10: { name: "Advanced", grades: "College", domains: [
        "Partial Derivatives", "Matrices", "Series", "Discrete Math",
        "Multivariable Calculus", "Linear Algebra", "Eigenvalues", "Double Integrals",
        "Triple Integrals", "Vector Calculus", "Real Analysis", "Complex Analysis",
        "Abstract Algebra", "Number Theory", "Advanced Number Theory", "Mathematical Logic",
        "Differential Geometry", "Topology", "Advanced Statistics", "Applied Mathematics",
        "Theoretical Mathematics", "Advanced Computational Methods"
    ]}
};

// ========================================
// INTELLIGENT ANSWER INTERPRETER (T1-T10)
// ========================================
// Comprehensive answer matching with semantic equivalence for all tier levels
const AnswerInterpreter = {
    // Word-to-number mappings
    wordNumbers: {
        'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4, 'five': 5,
        'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10,
        'eleven': 11, 'twelve': 12, 'thirteen': 13, 'fourteen': 14, 'fifteen': 15,
        'sixteen': 16, 'seventeen': 17, 'eighteen': 18, 'nineteen': 19, 'twenty': 20,
        'thirty': 30, 'forty': 40, 'fifty': 50, 'sixty': 60, 'seventy': 70,
        'eighty': 80, 'ninety': 90, 'hundred': 100, 'thousand': 1000,
        'half': 0.5, 'quarter': 0.25, 'third': 1/3, 'fourth': 0.25
    },

    // Roman numeral mappings for quadrants
    romanNumerals: { 'i': 1, 'ii': 2, 'iii': 3, 'iv': 4, '1': 1, '2': 2, '3': 3, '4': 4 },

    // Detect the type of answer expected
    detectType(expectedAnswer) {
        const ans = String(expectedAnswer).toLowerCase().trim();
        const original = String(expectedAnswer).trim();

        // Division with remainder: "5 R 2", "12 R 3"
        if (/^\d+\s*r\s*\d+$/i.test(ans)) return 'division_remainder';

        // Scientific notation: "3.5 × 10^4", "2e5"
        if (/×\s*10\s*\^|e[+-]?\d+$/i.test(ans)) return 'scientific_notation';

        // Absolute value solutions: "5 or -5", "x = 3 or x = -3"
        if (/\d+\s+or\s+-?\d+/i.test(ans) || /x\s*=.*or.*x\s*=/i.test(ans)) return 'absolute_value_solution';

        // Radical expressions: "3√2", "√5", "2√3", "∛8"
        if (/\d*[√∛]\d+/.test(original) || /sqrt|cbrt/i.test(ans)) return 'radical';

        // Pi expressions: "16π", "25π", "πr²"
        if (/\d+\s*π|π/i.test(original) || /\d+\s*pi\b/i.test(ans)) return 'pi_expression';

        // Complex numbers: "3 + 2i", "5 - 4i"
        if (/[+-]?\s*\d*\s*i\b/.test(ans) && /\d/.test(ans)) return 'complex_number';

        // Vector notation: "⟨3, 4⟩", "<3, 4>"
        if (/[⟨<]\s*-?\d+\s*,\s*-?\d+\s*[⟩>]/.test(original)) return 'vector';

        // Matrix dimensions: "3 × 4", "2x3"
        if (/^\d+\s*[×x]\s*\d+$/i.test(ans)) return 'matrix_dimension';

        // Coordinate/ordered pair: "(3, 4)", "(-2, 5)"
        if (/^\(?\s*-?\d+\.?\d*\s*,\s*-?\d+\.?\d*\s*\)?$/.test(ans)) return 'coordinate';

        // Quadrant: "Quadrant I", "Quadrant III", "Q1"
        if (/quadrant\s*[iv1234]+|^q[1234]$/i.test(ans)) return 'quadrant';

        // Factored form: "(x+2)(x-3)", "(x + a)(x + b)"
        if (/\([^)]*[+-][^)]*\)\s*\([^)]*[+-][^)]*\)/.test(ans)) return 'factored_form';

        // Circle equation: "(x-h)² + (y-k)² = r²"
        if (/\(x[+-]\d+\)\s*²?\s*\+\s*\(y[+-]\d+\)\s*²?\s*=/.test(ans)) return 'circle_equation';

        // Inequality: "x > 5", "x ≤ 3", "x >= 2"
        if (/^x\s*[<>≤≥]=?\s*-?\d+/.test(ans) || /^-?\d+\s*[<>≤≥]=?\s*x/.test(ans)) return 'inequality';

        // Domain notation: "x ≠ 3", "x != 0"
        if (/x\s*[≠!]=?\s*-?\d+/.test(ans)) return 'domain_restriction';

        // Asymptotes: "VA: x = 2", "HA: y = 1", "x = 2, y = 1"
        if (/[vh]a\s*:|asymptote/i.test(ans) || /^x\s*=\s*-?\d+\s*,\s*y\s*=/.test(ans)) return 'asymptote';

        // Equation: "y = 2x + 1", "y = x/2"
        if (/^y\s*=\s*.+x/.test(ans) || /^x\s*=\s*.+y/.test(ans)) return 'equation';

        // Algebraic expression: "5x", "3x + 2", "2x² + 3x"
        if (/\d*x\s*[²³⁴]?\s*[+-]?\s*\d*x?|\d+x/.test(ans)) return 'algebraic';

        // Integral with constant: "x^3/3 + C", "2x + C"
        if (/\+\s*c\s*$/i.test(ans)) return 'integral_constant';

        // Derivative/calculus notation: "d/dx", "∫", "∂"
        if (/d\/dx|∫|∂/.test(original)) return 'calculus';

        // Power expression: "3x^2", "nx^(n-1)", "2x²"
        if (/\d*x\s*\^?\s*[\d\(]/.test(ans) || /x\s*[²³⁴⁵⁶]/.test(original)) return 'power_expression';

        // Trig expression: "2cos(3x)", "sin(2x)", "tan(x)"
        if (/(sin|cos|tan|sec|csc|cot)\s*\(/i.test(ans)) return 'trig_expression';

        // Exponential expression: "2e^(3x)", "e^x", "e^(ax)"
        if (/e\s*\^\s*[\(\d\-x]/i.test(ans)) return 'exponential_expression';

        // Log expression: "log(a) + log(b)", "ln(x)"
        if (/\b(log|ln)\s*\(/i.test(ans)) return 'log_expression';

        // Eigenvalues: "3, 5" (comma-separated numbers, not coordinates)
        if (/^-?\d+\s*,\s*-?\d+$/.test(ans) && !/\(/.test(ans)) return 'eigenvalues';

        // Divisibility statement: "a divides b"
        if (/divides/i.test(ans)) return 'divisibility';

        // Z-score interpretation: "2 SD above the mean"
        if (/sd\s+(above|below)/i.test(ans)) return 'zscore_interpretation';

        // Polar coordinate: "(5, 45°)", "(r, π/4)"
        if (/\(\s*\d+\s*,\s*[\dπ].*[°\/]/.test(original)) return 'polar_coordinate';

        // Gradient with variables: "⟨2x, 3y⟩", "<ax, by>"
        if (/[⟨<][^⟩>]*[xy][^⟩>]*[⟩>]/.test(original)) return 'gradient_expression';

        // Simple fraction expression: "1/r", "a/(x+2)²"
        if (/^\d+\s*\/\s*[a-z\(]/.test(ans) || /\/\s*\([^)]+\)\s*²?$/.test(ans)) return 'fraction_expression';

        // Range expression: "3 and 7", "between 4 and 5"
        if (/\d+\s+and\s+\d+/i.test(ans) && !/or/i.test(ans)) return 'range_expression';

        // Directional shift: "left 3", "up 5", "right 2"
        if (/^(left|right|up|down)\s+\d+$/i.test(ans)) return 'directional';

        // Positional words: "above", "below", "beside"
        if (/^(above|below|beside|between|behind|next to|in front of)$/i.test(ans)) return 'positional';

        // Pattern symbols
        if (/^[●○△□★◐◑]+$/.test(original)) return 'pattern_symbol';

        // Fraction: contains / but not a date-like format
        if (/^\d+\s*\/\s*\d+$/.test(ans) || /^\d+\s+\d+\s*\/\s*\d+$/.test(ans)) return 'fraction';
        if (/mixed|improper/i.test(ans)) return 'fraction';

        // Percent
        if (ans.includes('%') || /percent/i.test(ans)) return 'percent';

        // Money
        if (/^\$|¢$|cents?$|dollars?$/i.test(ans)) return 'money';

        // Time
        if (/^\d{1,2}:\d{2}/.test(ans) || /\d+\s*(hours?|minutes?|seconds?|hr|min|sec)/i.test(ans)) return 'time';
        if (/\bam\b|\bpm\b/i.test(ans)) return 'time';

        // Measurement with units
        if (/\d+\s*(ft|feet|foot|in|inch|inches|cm|m|mm|km|mi|mile|yd|yard)/i.test(ans)) return 'measurement';
        if (/\d+\s*(lb|lbs|pound|oz|ounce|kg|g|gram|mg)/i.test(ans)) return 'weight';
        if (/\d+\s*(l|liter|litre|ml|gal|gallon|cup|qt|quart|pt|pint)/i.test(ans)) return 'capacity';

        // Angle
        if (/\d+\s*°|degrees?$/i.test(ans)) return 'angle';
        if (/acute|obtuse|right|straight|reflex/i.test(ans)) return 'angle_type';

        // Pure number (integer or decimal)
        if (/^-?\d+\.?\d*$/.test(ans.replace(/,/g, ''))) return 'number';

        // Ratio
        if (/^\d+\s*:\s*\d+$/.test(ans) || /^\d+\s+to\s+\d+$/i.test(ans)) return 'ratio';

        // Boolean/Yes-No
        if (/^(yes|no|true|false)$/i.test(ans)) return 'boolean';

        // Operation name
        if (/^(add|subtract|multiply|divide|addition|subtraction|multiplication|division)$/i.test(ans)) return 'operation';

        // Shape/geometry terms
        if (/triangle|square|rectangle|circle|pentagon|hexagon|parallel|perpendicular|vertical|horizontal|intersecting/i.test(ans)) return 'geometry';

        // Fraction words
        if (/^(half|third|fourth|quarter|fifth|sixth|seventh|eighth|ninth|tenth)s?$/i.test(ans)) return 'fraction_word';

        // Default to text
        return 'text';
    },

    // ========== PARSER METHODS ==========

    // Parse division with remainder: "5 R 2" -> { quotient: 5, remainder: 2 }
    parseDivisionRemainder(str) {
        const s = String(str).trim();
        const match = s.match(/^(\d+)\s*r\s*(\d+)$/i);
        if (match) {
            return { quotient: parseInt(match[1]), remainder: parseInt(match[2]) };
        }
        return null;
    },

    // Parse scientific notation: "3.5 × 10^4" -> 35000
    parseScientificNotation(str) {
        const s = String(str).trim();
        // Format: 3.5 × 10^4 or 3.5 x 10^4
        const match1 = s.match(/^(-?\d+\.?\d*)\s*[×x]\s*10\s*\^\s*(-?\d+)$/i);
        if (match1) {
            return parseFloat(match1[1]) * Math.pow(10, parseInt(match1[2]));
        }
        // Format: 3.5e4
        const match2 = s.match(/^(-?\d+\.?\d*)e([+-]?\d+)$/i);
        if (match2) {
            return parseFloat(match2[1]) * Math.pow(10, parseInt(match2[2]));
        }
        return null;
    },

    // Parse absolute value solutions: "5 or -5" -> [5, -5]
    parseAbsoluteValueSolution(str) {
        const s = String(str).toLowerCase().trim();
        // Format: "5 or -5" or "x = 5 or x = -5"
        const cleaned = s.replace(/x\s*=\s*/g, '');
        const match = cleaned.match(/(-?\d+\.?\d*)\s+or\s+(-?\d+\.?\d*)/i);
        if (match) {
            const vals = [parseFloat(match[1]), parseFloat(match[2])].sort((a, b) => a - b);
            return vals;
        }
        return null;
    },

    // Parse radical: "3√2" -> { coefficient: 3, radicand: 2, index: 2 }
    parseRadical(str) {
        const s = String(str).trim();
        // Format: 3√2, √5, ∛8
        const sqrtMatch = s.match(/^(\d*)√(\d+)$/);
        if (sqrtMatch) {
            return {
                coefficient: sqrtMatch[1] ? parseInt(sqrtMatch[1]) : 1,
                radicand: parseInt(sqrtMatch[2]),
                index: 2,
                value: (sqrtMatch[1] ? parseInt(sqrtMatch[1]) : 1) * Math.sqrt(parseInt(sqrtMatch[2]))
            };
        }
        const cbrtMatch = s.match(/^(\d*)∛(\d+)$/);
        if (cbrtMatch) {
            return {
                coefficient: cbrtMatch[1] ? parseInt(cbrtMatch[1]) : 1,
                radicand: parseInt(cbrtMatch[2]),
                index: 3,
                value: (cbrtMatch[1] ? parseInt(cbrtMatch[1]) : 1) * Math.cbrt(parseInt(cbrtMatch[2]))
            };
        }
        return null;
    },

    // Parse pi expression: "16π" -> { coefficient: 16, value: 16 * Math.PI }
    parsePiExpression(str) {
        const s = String(str).trim();
        const match = s.match(/^(-?\d*\.?\d*)\s*[π]$/i) || s.match(/^(-?\d*\.?\d*)\s*pi$/i);
        if (match) {
            const coef = match[1] === '' || match[1] === '-' ? (match[1] === '-' ? -1 : 1) : parseFloat(match[1]);
            return { coefficient: coef, value: coef * Math.PI };
        }
        return null;
    },

    // Parse complex number: "3 + 2i" -> { real: 3, imaginary: 2 }
    parseComplexNumber(str) {
        const s = String(str).toLowerCase().trim().replace(/\s/g, '');
        // Format: 3+2i, 3-2i, 2i, -3i, 5
        const match = s.match(/^(-?\d*\.?\d*)([+-])(\d*\.?\d*)i$/) ||
                      s.match(/^(-?\d*\.?\d*)([+-])i$/) ||
                      s.match(/^(-?\d*\.?\d*)i$/) ||
                      s.match(/^(-?\d+\.?\d*)$/);
        if (match) {
            if (match.length === 2) {
                // Pure imaginary or pure real
                if (s.includes('i')) {
                    return { real: 0, imaginary: match[1] === '' || match[1] === '-' ? (match[1] === '-' ? -1 : 1) : parseFloat(match[1]) };
                } else {
                    return { real: parseFloat(match[1]), imaginary: 0 };
                }
            } else if (match.length === 3) {
                // Format: 3+i or 3-i
                const real = parseFloat(match[1]) || 0;
                const sign = match[2] === '-' ? -1 : 1;
                return { real, imaginary: sign };
            } else if (match.length === 4) {
                // Format: 3+2i
                const real = parseFloat(match[1]) || 0;
                const sign = match[2] === '-' ? -1 : 1;
                const imag = match[3] === '' ? 1 : parseFloat(match[3]);
                return { real, imaginary: sign * imag };
            }
        }
        return null;
    },

    // Parse vector: "⟨3, 4⟩" -> { x: 3, y: 4 }
    parseVector(str) {
        const s = String(str).trim();
        const match = s.match(/[⟨<]\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*[⟩>]/);
        if (match) {
            return { x: parseFloat(match[1]), y: parseFloat(match[2]) };
        }
        return null;
    },

    // Parse coordinate: "(3, 4)" -> { x: 3, y: 4 }
    parseCoordinate(str) {
        const s = String(str).trim();
        const match = s.match(/\(?\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*\)?/);
        if (match) {
            return { x: parseFloat(match[1]), y: parseFloat(match[2]) };
        }
        return null;
    },

    // Parse quadrant: "Quadrant I" -> 1
    parseQuadrant(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/quadrant\s*([iv1234]+)|^q([1234])$/i);
        if (match) {
            const val = match[1] || match[2];
            return this.romanNumerals[val.toLowerCase()] || parseInt(val);
        }
        return null;
    },

    // Parse matrix dimension: "3 × 4" -> { rows: 3, cols: 4 }
    parseMatrixDimension(str) {
        const s = String(str).trim();
        const match = s.match(/^(\d+)\s*[×x]\s*(\d+)$/i);
        if (match) {
            return { rows: parseInt(match[1]), cols: parseInt(match[2]) };
        }
        return null;
    },

    // Parse factored form: "(x+2)(x-3)" -> { factors: [[1, 2], [1, -3]] }
    parseFactoredForm(str) {
        const s = String(str).toLowerCase().replace(/\s/g, '');
        const factors = [];
        const regex = /\(x([+-]\d+)\)/g;
        let match;
        while ((match = regex.exec(s)) !== null) {
            factors.push(parseInt(match[1]));
        }
        if (factors.length >= 2) {
            return { factors: factors.sort((a, b) => a - b) };
        }
        return null;
    },

    // Parse inequality: "x > 5" -> { variable: 'x', operator: '>', value: 5 }
    parseInequality(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/^([xy])\s*([<>≤≥]=?|<=|>=)\s*(-?\d+\.?\d*)$/) ||
                      s.match(/^(-?\d+\.?\d*)\s*([<>≤≥]=?|<=|>=)\s*([xy])$/);
        if (match) {
            const operators = { '<': '<', '>': '>', '≤': '<=', '≥': '>=', '<=': '<=', '>=': '>=' };
            if (match[1].match(/[xy]/)) {
                return { variable: match[1], operator: operators[match[2]] || match[2], value: parseFloat(match[3]) };
            } else {
                // Flip operator if number comes first
                const flipped = { '<': '>', '>': '<', '<=': '>=', '>=': '<=', '≤': '>=', '≥': '<=' };
                return { variable: match[3], operator: flipped[match[2]] || match[2], value: parseFloat(match[1]) };
            }
        }
        return null;
    },

    // Parse domain restriction: "x ≠ 3" -> { variable: 'x', excluded: 3 }
    parseDomainRestriction(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/^([xy])\s*[≠!]=?\s*(-?\d+\.?\d*)$/);
        if (match) {
            return { variable: match[1], excluded: parseFloat(match[2]) };
        }
        return null;
    },

    // Parse range expression: "3 and 7" -> [3, 7]
    parseRangeExpression(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/(-?\d+\.?\d*)\s+and\s+(-?\d+\.?\d*)/);
        if (match) {
            return [parseFloat(match[1]), parseFloat(match[2])].sort((a, b) => a - b);
        }
        return null;
    },

    // Parse directional: "left 3" -> { direction: 'left', amount: 3 }
    parseDirectional(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/^(left|right|up|down)\s+(\d+)$/);
        if (match) {
            return { direction: match[1], amount: parseInt(match[2]) };
        }
        return null;
    },

    // Parse algebraic expression: "3x + 2" -> { terms: [{coef: 3, var: 'x', exp: 1}, {coef: 2, var: null, exp: 0}] }
    parseAlgebraic(str) {
        const s = String(str).toLowerCase().replace(/\s/g, '').replace(/−/g, '-');
        // Simplified: extract coefficient of x terms
        const xTerms = s.match(/([+-]?\d*)x\^?(\d*)/g) || [];
        const constMatch = s.match(/([+-]\d+)(?![x\d])|^(\d+)(?![x])/);

        let xCoef = 0, x2Coef = 0, constant = 0;

        for (const term of xTerms) {
            const m = term.match(/([+-]?\d*)x\^?(\d*)/);
            if (m) {
                const coef = m[1] === '' || m[1] === '+' ? 1 : m[1] === '-' ? -1 : parseInt(m[1]);
                const exp = m[2] === '' ? 1 : parseInt(m[2]);
                if (exp === 1) xCoef += coef;
                if (exp === 2) x2Coef += coef;
            }
        }

        if (constMatch) {
            constant = parseInt(constMatch[1] || constMatch[2]) || 0;
        }

        return { x2Coef, xCoef, constant, normalized: `${x2Coef}x²+${xCoef}x+${constant}` };
    },

    // Parse integral with constant: "x^3/3 + C" -> { expression: "x^3/3", hasConstant: true }
    parseIntegralConstant(str) {
        const s = String(str).trim();
        const match = s.match(/^(.+?)\s*\+\s*c$/i);
        if (match) {
            return { expression: match[1].trim(), hasConstant: true, normalized: match[1].toLowerCase().replace(/\s/g, '') };
        }
        return null;
    },

    // Parse power expression: "3x^2", "2x²" -> { coefficient: 3, variable: 'x', exponent: 2 }
    parsePowerExpression(str) {
        const s = String(str).trim();
        // Handle superscript exponents: ²³⁴⁵⁶
        const superscripts = { '²': 2, '³': 3, '⁴': 4, '⁵': 5, '⁶': 6 };
        let normalized = s;
        for (const [sup, num] of Object.entries(superscripts)) {
            normalized = normalized.replace(sup, `^${num}`);
        }
        normalized = normalized.toLowerCase().replace(/\s/g, '');

        const match = normalized.match(/^(-?\d*)([a-z])\^(-?\d+|\([^)]+\))$/);
        if (match) {
            const coef = match[1] === '' || match[1] === '-' ? (match[1] === '-' ? -1 : 1) : parseInt(match[1]);
            return { coefficient: coef, variable: match[2], exponent: match[3], normalized };
        }
        return { normalized };
    },

    // Parse trig expression: "2cos(3x)" -> { coefficient: 2, func: 'cos', argument: '3x' }
    parseTrigExpression(str) {
        const s = String(str).toLowerCase().replace(/\s/g, '');
        const match = s.match(/^(-?\d*)(sin|cos|tan|sec|csc|cot)\(([^)]+)\)$/);
        if (match) {
            const coef = match[1] === '' || match[1] === '-' ? (match[1] === '-' ? -1 : 1) : parseInt(match[1]);
            return { coefficient: coef, func: match[2], argument: match[3], normalized: s };
        }
        return { normalized: s };
    },

    // Parse exponential expression: "2e^(3x)" -> { coefficient: 2, exponent: '3x' }
    parseExponentialExpression(str) {
        const s = String(str).toLowerCase().replace(/\s/g, '');
        const match = s.match(/^(-?\d*\.?\d*)e\^\(?([^)]+)\)?$/);
        if (match) {
            const coef = match[1] === '' ? 1 : parseFloat(match[1]);
            return { coefficient: coef, exponent: match[2], normalized: s };
        }
        return { normalized: s };
    },

    // Parse log expression: "log(a) + log(b)" -> { parts: ['log(a)', 'log(b)'], normalized }
    parseLogExpression(str) {
        const s = String(str).toLowerCase().replace(/\s/g, '');
        const parts = s.match(/(log|ln)\([^)]+\)/g) || [];
        return { parts, normalized: s };
    },

    // Parse eigenvalues: "3, 5" -> [3, 5]
    parseEigenvalues(str) {
        const s = String(str).trim();
        const match = s.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
        if (match) {
            return [parseFloat(match[1]), parseFloat(match[2])].sort((a, b) => a - b);
        }
        return null;
    },

    // Parse divisibility: "5 divides 25" -> { divisor: 5, dividend: 25 }
    parseDivisibility(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/(\d+)\s*divides\s*(\d+)/);
        if (match) {
            return { divisor: parseInt(match[1]), dividend: parseInt(match[2]) };
        }
        return null;
    },

    // Parse z-score interpretation: "2 SD above the mean" -> { sd: 2, direction: 'above' }
    parseZScoreInterpretation(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/(\d+\.?\d*)\s*sd\s+(above|below)/);
        if (match) {
            return { sd: parseFloat(match[1]), direction: match[2] };
        }
        return null;
    },

    // Parse polar coordinate: "(5, 45°)" or "(5, π/4)" -> { r: 5, theta: value, format: 'degrees'|'radians' }
    parsePolarCoordinate(str) {
        const s = String(str).trim();
        // Degrees format: (5, 45°)
        const degMatch = s.match(/\(\s*(\d+\.?\d*)\s*,\s*(\d+\.?\d*)\s*°?\s*\)/);
        if (degMatch) {
            return { r: parseFloat(degMatch[1]), theta: parseFloat(degMatch[2]), format: 'degrees' };
        }
        // Radians with π: (5, π/4)
        const radMatch = s.match(/\(\s*(\d+\.?\d*)\s*,\s*π\s*\/?\s*(\d*)\s*\)/);
        if (radMatch) {
            const denom = radMatch[2] ? parseInt(radMatch[2]) : 1;
            return { r: parseFloat(radMatch[1]), theta: Math.PI / denom, format: 'radians' };
        }
        return null;
    },

    // Parse gradient expression: "⟨2x, 3y⟩" -> { components: ['2x', '3y'], normalized }
    parseGradientExpression(str) {
        const s = String(str).trim();
        const match = s.match(/[⟨<]\s*([^,⟩>]+)\s*,\s*([^⟩>]+)\s*[⟩>]/);
        if (match) {
            return {
                components: [match[1].trim().toLowerCase(), match[2].trim().toLowerCase()],
                normalized: s.toLowerCase().replace(/\s/g, '').replace(/</g, '⟨').replace(/>/g, '⟩')
            };
        }
        return null;
    },

    // Parse simple fraction expression: "1/r", "a/(x+2)²" -> normalized form
    parseFractionExpression(str) {
        const s = String(str).toLowerCase().replace(/\s/g, '');
        return { normalized: s };
    },

    // Parse fraction
    parseFraction(str) {
        const s = String(str).trim();
        // Mixed number: "2 3/4"
        const mixedMatch = s.match(/^(-?\d+)\s+(\d+)\s*\/\s*(\d+)$/);
        if (mixedMatch) {
            const whole = parseInt(mixedMatch[1]);
            const num = parseInt(mixedMatch[2]);
            const den = parseInt(mixedMatch[3]);
            const sign = whole < 0 ? -1 : 1;
            return { value: sign * (Math.abs(whole) + num / den), whole: Math.abs(whole), num, den };
        }
        // Simple fraction: "3/4"
        const fracMatch = s.match(/^(-?\d+)\s*\/\s*(\d+)$/);
        if (fracMatch) {
            const num = parseInt(fracMatch[1]);
            const den = parseInt(fracMatch[2]);
            return { value: num / den, whole: 0, num: Math.abs(num), den };
        }
        return null;
    },

    // Parse money value to cents
    parseMoney(str) {
        const s = String(str).toLowerCase().trim();
        const dollarMatch = s.match(/\$\s*(\d+)(?:\.(\d{1,2}))?/);
        if (dollarMatch) {
            const dollars = parseInt(dollarMatch[1]);
            const cents = dollarMatch[2] ? parseInt(dollarMatch[2].padEnd(2, '0')) : 0;
            return dollars * 100 + cents;
        }
        const centsMatch = s.match(/(\d+)\s*(?:¢|cents?)/i);
        if (centsMatch) return parseInt(centsMatch[1]);
        const numMatch = s.match(/^(\d+)$/);
        if (numMatch) return parseInt(numMatch[1]);
        return null;
    },

    // Parse time to minutes from midnight
    parseTime(str) {
        const s = String(str).toLowerCase().trim();
        const timeMatch = s.match(/(\d{1,2}):(\d{2})\s*(am|pm)?/i);
        if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            const period = timeMatch[3]?.toLowerCase();
            if (period === 'pm' && hours !== 12) hours += 12;
            if (period === 'am' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        }
        const durationMatch = s.match(/(\d+)\s*h(?:ours?)?\s*(?:and\s*)?(\d+)?\s*m(?:in(?:utes?)?)?/i);
        if (durationMatch) {
            return (parseInt(durationMatch[1]) || 0) * 60 + (parseInt(durationMatch[2]) || 0);
        }
        const hoursOnly = s.match(/^(\d+)\s*h(?:ours?)?$/i);
        if (hoursOnly) return parseInt(hoursOnly[1]) * 60;
        const minsOnly = s.match(/^(\d+)\s*m(?:in(?:utes?)?)?$/i);
        if (minsOnly) return parseInt(minsOnly[1]);
        return null;
    },

    // Parse measurement to base unit
    parseMeasurement(str) {
        const s = String(str).toLowerCase().trim();
        const lengthUnits = {
            'in': 1, 'inch': 1, 'inches': 1, '"': 1,
            'ft': 12, 'feet': 12, 'foot': 12, "'": 12,
            'yd': 36, 'yard': 36, 'yards': 36,
            'cm': 0.3937, 'm': 39.37, 'mm': 0.03937
        };
        const feetInches = s.match(/(\d+)\s*(?:ft|feet|foot|')\s*(\d+)?\s*(?:in|inch|inches|")?/i);
        if (feetInches) {
            return (parseInt(feetInches[1]) || 0) * 12 + (parseInt(feetInches[2]) || 0);
        }
        const singleUnit = s.match(/^(\d+\.?\d*)\s*([a-z'"]+)$/i);
        if (singleUnit && lengthUnits[singleUnit[2].toLowerCase()]) {
            return parseFloat(singleUnit[1]) * lengthUnits[singleUnit[2].toLowerCase()];
        }
        return null;
    },

    // Parse percentage to decimal
    parsePercent(str) {
        const s = String(str).toLowerCase().trim();
        const match = s.match(/^(\d+\.?\d*)\s*%?$/);
        if (match) return parseFloat(match[1]) / 100;
        for (const [word, val] of Object.entries(this.wordNumbers)) {
            if (s.includes(word) && s.includes('percent')) return val / 100;
        }
        return null;
    },

    // Convert word numbers to numeric
    parseWordNumber(str) {
        let s = String(str).toLowerCase().trim().replace(/-/g, ' ');
        let total = 0, current = 0;
        for (const word of s.split(/\s+/)) {
            if (this.wordNumbers[word] !== undefined) {
                const val = this.wordNumbers[word];
                if (val === 100) current = (current || 1) * 100;
                else if (val === 1000) { current = (current || 1) * 1000; total += current; current = 0; }
                else current += val;
            }
        }
        return (total + current) || null;
    },

    // ========== NORMALIZE METHOD ==========
    normalize(input, type = null) {
        if (input === null || input === undefined) return null;
        const s = String(input).toLowerCase().trim();
        const original = String(input).trim();
        const answerType = type || this.detectType(original);

        switch (answerType) {
            case 'division_remainder': {
                const parsed = this.parseDivisionRemainder(s);
                if (parsed) return { type: 'division_remainder', ...parsed, original: s };
                break;
            }
            case 'scientific_notation': {
                const val = this.parseScientificNotation(original);
                if (val !== null) return { type: 'scientific_notation', value: val, original: s };
                break;
            }
            case 'absolute_value_solution': {
                const vals = this.parseAbsoluteValueSolution(s);
                if (vals) return { type: 'absolute_value_solution', values: vals, original: s };
                break;
            }
            case 'radical': {
                const rad = this.parseRadical(original);
                if (rad) return { type: 'radical', ...rad, original };
                break;
            }
            case 'pi_expression': {
                const pi = this.parsePiExpression(original);
                if (pi) return { type: 'pi_expression', ...pi, original };
                break;
            }
            case 'complex_number': {
                const cplx = this.parseComplexNumber(s);
                if (cplx) return { type: 'complex_number', ...cplx, original: s };
                break;
            }
            case 'vector': {
                const vec = this.parseVector(original);
                if (vec) return { type: 'vector', ...vec, original };
                break;
            }
            case 'coordinate': {
                const coord = this.parseCoordinate(s);
                if (coord) return { type: 'coordinate', ...coord, original: s };
                break;
            }
            case 'quadrant': {
                const q = this.parseQuadrant(s);
                if (q) return { type: 'quadrant', value: q, original: s };
                break;
            }
            case 'matrix_dimension': {
                const dim = this.parseMatrixDimension(s);
                if (dim) return { type: 'matrix_dimension', ...dim, original: s };
                break;
            }
            case 'factored_form': {
                const fac = this.parseFactoredForm(s);
                if (fac) return { type: 'factored_form', ...fac, original: s };
                break;
            }
            case 'inequality': {
                const ineq = this.parseInequality(s);
                if (ineq) return { type: 'inequality', ...ineq, original: s };
                break;
            }
            case 'domain_restriction': {
                const dom = this.parseDomainRestriction(s);
                if (dom) return { type: 'domain_restriction', ...dom, original: s };
                break;
            }
            case 'range_expression': {
                const range = this.parseRangeExpression(s);
                if (range) return { type: 'range_expression', values: range, original: s };
                break;
            }
            case 'directional': {
                const dir = this.parseDirectional(s);
                if (dir) return { type: 'directional', ...dir, original: s };
                break;
            }
            case 'algebraic': {
                const alg = this.parseAlgebraic(s);
                if (alg) return { type: 'algebraic', ...alg, original: s };
                break;
            }
            case 'integral_constant': {
                const integ = this.parseIntegralConstant(original);
                if (integ) return { type: 'integral_constant', ...integ, original };
                break;
            }
            case 'power_expression': {
                const pow = this.parsePowerExpression(original);
                if (pow) return { type: 'power_expression', ...pow, original };
                break;
            }
            case 'trig_expression': {
                const trig = this.parseTrigExpression(original);
                if (trig) return { type: 'trig_expression', ...trig, original };
                break;
            }
            case 'exponential_expression': {
                const exp = this.parseExponentialExpression(original);
                if (exp) return { type: 'exponential_expression', ...exp, original };
                break;
            }
            case 'log_expression': {
                const log = this.parseLogExpression(original);
                if (log) return { type: 'log_expression', ...log, original };
                break;
            }
            case 'eigenvalues': {
                const eig = this.parseEigenvalues(s);
                if (eig) return { type: 'eigenvalues', values: eig, original: s };
                break;
            }
            case 'divisibility': {
                const div = this.parseDivisibility(s);
                if (div) return { type: 'divisibility', ...div, original: s };
                break;
            }
            case 'zscore_interpretation': {
                const zscore = this.parseZScoreInterpretation(s);
                if (zscore) return { type: 'zscore_interpretation', ...zscore, original: s };
                break;
            }
            case 'polar_coordinate': {
                const polar = this.parsePolarCoordinate(original);
                if (polar) return { type: 'polar_coordinate', ...polar, original };
                break;
            }
            case 'gradient_expression': {
                const grad = this.parseGradientExpression(original);
                if (grad) return { type: 'gradient_expression', ...grad, original };
                break;
            }
            case 'fraction_expression': {
                const fracExp = this.parseFractionExpression(original);
                if (fracExp) return { type: 'fraction_expression', ...fracExp, original };
                break;
            }
            case 'positional': {
                const posMap = {
                    'above': 'above', 'below': 'below', 'beside': 'beside', 'between': 'between',
                    'behind': 'behind', 'next to': 'next_to', 'in front of': 'in_front_of'
                };
                for (const [key, val] of Object.entries(posMap)) {
                    if (s.includes(key)) return { type: 'positional', value: val, original: s };
                }
                break;
            }
            case 'pattern_symbol': {
                return { type: 'pattern_symbol', value: original, original };
            }
            case 'fraction_word': {
                const wordMap = { 'half': 0.5, 'third': 1/3, 'fourth': 0.25, 'quarter': 0.25, 'fifth': 0.2 };
                for (const [word, val] of Object.entries(wordMap)) {
                    if (s.includes(word)) return { type: 'fraction_word', value: val, word, original: s };
                }
                break;
            }
            case 'fraction': {
                const frac = this.parseFraction(s);
                if (frac) return { type: 'fraction', value: frac.value, original: s };
                const num = parseFloat(s);
                if (!isNaN(num)) return { type: 'fraction', value: num, original: s };
                break;
            }
            case 'percent': {
                const pct = this.parsePercent(s);
                if (pct !== null) return { type: 'percent', value: pct, original: s };
                break;
            }
            case 'money': {
                const cents = this.parseMoney(s);
                if (cents !== null) return { type: 'money', value: cents, original: s };
                break;
            }
            case 'time': {
                const mins = this.parseTime(s);
                if (mins !== null) return { type: 'time', value: mins, original: s };
                break;
            }
            case 'measurement': {
                const inches = this.parseMeasurement(s);
                if (inches !== null) return { type: 'measurement', value: inches, original: s };
                break;
            }
            case 'number': {
                const cleaned = s.replace(/,/g, '').replace(/\s/g, '');
                let num = parseFloat(cleaned);
                if (isNaN(num)) num = this.parseWordNumber(s);
                if (num !== null && !isNaN(num)) return { type: 'number', value: num, original: s };
                break;
            }
            case 'ratio': {
                const ratioMatch = s.match(/(\d+)\s*(?::|to)\s*(\d+)/i);
                if (ratioMatch) {
                    const a = parseInt(ratioMatch[1]), b = parseInt(ratioMatch[2]);
                    const gcd = this.gcd(a, b);
                    return { type: 'ratio', value: a / b, simplified: [a/gcd, b/gcd], original: s };
                }
                break;
            }
            case 'boolean': {
                const isYes = /^(yes|true|y|correct|right)$/i.test(s);
                return { type: 'boolean', value: isYes, original: s };
            }
            case 'operation': {
                const opMap = {
                    'add': 'addition', 'addition': 'addition', 'plus': 'addition', '+': 'addition',
                    'subtract': 'subtraction', 'subtraction': 'subtraction', 'minus': 'subtraction', '-': 'subtraction',
                    'multiply': 'multiplication', 'multiplication': 'multiplication', 'times': 'multiplication', '×': 'multiplication', '*': 'multiplication',
                    'divide': 'division', 'division': 'division', '÷': 'division', '/': 'division'
                };
                if (opMap[s]) return { type: 'operation', value: opMap[s], original: s };
                break;
            }
            case 'angle_type': {
                if (/acute/i.test(s)) return { type: 'angle_type', value: 'acute', original: s };
                if (/obtuse/i.test(s)) return { type: 'angle_type', value: 'obtuse', original: s };
                if (/right/i.test(s)) return { type: 'angle_type', value: 'right', original: s };
                if (/straight/i.test(s)) return { type: 'angle_type', value: 'straight', original: s };
                if (/reflex/i.test(s)) return { type: 'angle_type', value: 'reflex', original: s };
                break;
            }
            case 'angle': {
                const angleMatch = s.match(/(\d+)\s*°?/);
                if (angleMatch) return { type: 'angle', value: parseInt(angleMatch[1]), original: s };
                break;
            }
            case 'geometry': {
                const geoTerms = ['parallel', 'perpendicular', 'intersecting', 'vertical', 'horizontal',
                    'triangle', 'square', 'rectangle', 'circle', 'pentagon', 'hexagon', 'octagon',
                    'equilateral', 'isosceles', 'scalene', 'prime', 'composite'];
                for (const term of geoTerms) {
                    if (s.includes(term)) return { type: 'geometry', value: term, original: s };
                }
                break;
            }
        }
        // Default: normalized text
        return { type: 'text', value: s.replace(/\s+/g, '').replace(/[.,!?]/g, ''), original: s };
    },

    // Greatest common divisor
    gcd(a, b) { return b === 0 ? a : this.gcd(b, a % b); },

    // ========== EQUIVALENCE CHECKING ==========
    isEquivalent(normA, normB, tolerance = 0.0001) {
        if (!normA || !normB) return false;

        // Same type comparison
        if (normA.type === normB.type) {
            switch (normA.type) {
                case 'number': case 'fraction': case 'percent': case 'money':
                case 'time': case 'measurement': case 'angle': case 'pi_expression':
                    return Math.abs(normA.value - normB.value) < tolerance;

                case 'scientific_notation':
                    return Math.abs(normA.value - normB.value) < Math.abs(normA.value * 0.0001);

                case 'radical':
                    return normA.coefficient === normB.coefficient && normA.radicand === normB.radicand && normA.index === normB.index;

                case 'division_remainder':
                    return normA.quotient === normB.quotient && normA.remainder === normB.remainder;

                case 'absolute_value_solution':
                    return normA.values[0] === normB.values[0] && normA.values[1] === normB.values[1];

                case 'complex_number':
                    return Math.abs(normA.real - normB.real) < tolerance && Math.abs(normA.imaginary - normB.imaginary) < tolerance;

                case 'vector': case 'coordinate':
                    return Math.abs(normA.x - normB.x) < tolerance && Math.abs(normA.y - normB.y) < tolerance;

                case 'quadrant':
                    return normA.value === normB.value;

                case 'matrix_dimension':
                    return normA.rows === normB.rows && normA.cols === normB.cols;

                case 'factored_form':
                    return JSON.stringify(normA.factors) === JSON.stringify(normB.factors);

                case 'inequality':
                    return normA.variable === normB.variable && normA.operator === normB.operator && Math.abs(normA.value - normB.value) < tolerance;

                case 'domain_restriction':
                    return normA.variable === normB.variable && Math.abs(normA.excluded - normB.excluded) < tolerance;

                case 'range_expression':
                    return normA.values[0] === normB.values[0] && normA.values[1] === normB.values[1];

                case 'directional':
                    return normA.direction === normB.direction && normA.amount === normB.amount;

                case 'algebraic':
                    return normA.x2Coef === normB.x2Coef && normA.xCoef === normB.xCoef && normA.constant === normB.constant;

                case 'integral_constant':
                    return normA.normalized === normB.normalized;

                case 'power_expression':
                    return normA.normalized === normB.normalized;

                case 'trig_expression':
                    return normA.normalized === normB.normalized;

                case 'exponential_expression':
                    return normA.normalized === normB.normalized;

                case 'log_expression':
                    return normA.normalized === normB.normalized;

                case 'eigenvalues':
                    return normA.values[0] === normB.values[0] && normA.values[1] === normB.values[1];

                case 'divisibility':
                    return normA.divisor === normB.divisor && normA.dividend === normB.dividend;

                case 'zscore_interpretation':
                    return Math.abs(normA.sd - normB.sd) < tolerance && normA.direction === normB.direction;

                case 'polar_coordinate':
                    return Math.abs(normA.r - normB.r) < tolerance && Math.abs(normA.theta - normB.theta) < tolerance;

                case 'gradient_expression':
                    return normA.normalized === normB.normalized;

                case 'fraction_expression':
                    return normA.normalized === normB.normalized;

                case 'ratio':
                    if (normA.simplified && normB.simplified) {
                        return normA.simplified[0] === normB.simplified[0] && normA.simplified[1] === normB.simplified[1];
                    }
                    return Math.abs(normA.value - normB.value) < tolerance;

                case 'boolean': case 'operation': case 'angle_type': case 'geometry':
                case 'positional': case 'pattern_symbol': case 'fraction_word':
                    return normA.value === normB.value;

                case 'text':
                    return normA.value === normB.value;
            }
        }

        // Cross-type equivalence
        const numericTypes = ['number', 'fraction', 'percent', 'fraction_word'];
        if (numericTypes.includes(normA.type) && numericTypes.includes(normB.type)) {
            return Math.abs(normA.value - normB.value) < tolerance;
        }

        // Coordinate and vector are equivalent
        if ((normA.type === 'coordinate' && normB.type === 'vector') ||
            (normA.type === 'vector' && normB.type === 'coordinate')) {
            return Math.abs(normA.x - normB.x) < tolerance && Math.abs(normA.y - normB.y) < tolerance;
        }

        return false;
    },

    // ========== MAIN ENTRY POINT ==========
    checkAnswer(userInput, expectedAnswer, options = {}) {
        const { type = null, tolerance = 0.0001, acceptEquivalent = true } = options;

        if (Array.isArray(expectedAnswer)) {
            for (const exp of expectedAnswer) {
                const result = this.checkAnswer(userInput, exp, options);
                if (result.correct) return result;
            }
            return { correct: false, matchType: 'none' };
        }

        const userNorm = this.normalize(userInput, type);
        const expectedNorm = this.normalize(expectedAnswer, type);

        if (this.isEquivalent(userNorm, expectedNorm, tolerance)) {
            return { correct: true, matchType: 'exact' };
        }

        if (acceptEquivalent) {
            // Cross-type numeric equivalence
            if (expectedNorm.type === 'fraction' && userNorm.type === 'number') {
                if (Math.abs(userNorm.value - expectedNorm.value) < tolerance) {
                    return { correct: true, matchType: 'equivalent' };
                }
            }
            // Pi expression equivalence with number
            if (expectedNorm.type === 'pi_expression' && userNorm.type === 'number') {
                if (Math.abs(userNorm.value - expectedNorm.value) < tolerance) {
                    return { correct: true, matchType: 'equivalent' };
                }
            }
            // Radical equivalence with number
            if (expectedNorm.type === 'radical' && userNorm.type === 'number') {
                if (Math.abs(userNorm.value - expectedNorm.value) < tolerance) {
                    return { correct: true, matchType: 'equivalent' };
                }
            }
            // Power expression equivalence - allow different formats (x^2 = x²)
            if (expectedNorm.type === 'power_expression' && userNorm.type === 'power_expression') {
                if (expectedNorm.normalized === userNorm.normalized) {
                    return { correct: true, matchType: 'equivalent' };
                }
            }
            // Eigenvalues in different order
            if (expectedNorm.type === 'eigenvalues' && userNorm.type === 'eigenvalues') {
                const expSorted = [...expectedNorm.values].sort((a,b) => a-b);
                const userSorted = [...userNorm.values].sort((a,b) => a-b);
                if (expSorted[0] === userSorted[0] && expSorted[1] === userSorted[1]) {
                    return { correct: true, matchType: 'equivalent' };
                }
            }
            // Text fallback for calculus expressions
            if (['integral_constant', 'power_expression', 'trig_expression', 'exponential_expression', 'log_expression', 'gradient_expression', 'fraction_expression'].includes(expectedNorm.type)) {
                const expClean = expectedNorm.normalized || expectedNorm.original.toLowerCase().replace(/\s/g, '');
                const userClean = (userNorm.normalized || userNorm.original || String(userInput)).toLowerCase().replace(/\s/g, '');
                if (expClean === userClean) {
                    return { correct: true, matchType: 'equivalent' };
                }
            }
        }

        // Fuzzy text matching
        if (userNorm.type === 'text' && expectedNorm.type === 'text') {
            const dist = this.levenshtein(userNorm.value, expectedNorm.value);
            if (dist === 1 && userNorm.value.length >= 4) {
                return { correct: false, matchType: 'close', suggestion: expectedNorm.original };
            }
        }

        return { correct: false, matchType: 'none' };
    },

    // Levenshtein distance for fuzzy matching
    levenshtein(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) matrix[i] = [i];
        for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                matrix[i][j] = b.charAt(i-1) === a.charAt(j-1) ? matrix[i-1][j-1] :
                    Math.min(matrix[i-1][j-1] + 1, matrix[i][j-1] + 1, matrix[i-1][j] + 1);
            }
        }
        return matrix[b.length][a.length];
    }
};

const QUESTION_TYPES = ["procedural", "conceptual", "reasoning"];

// ========================================
// SKILL TREE COMMUNICATION
// ========================================
// Maps Dojo domain names to Skill Tree skill names
// Most names match exactly; only include those that differ
const SKILL_TREE_MAPPING = {
    // Tier 1 - Foundations
    "Comparison": "Number Comparison",
    "Place Value": "Place Value",
    "Number Lines": "Number Lines",
    "Even and Odd": "Even and Odd",
    "Ordering Numbers": "Ordering Numbers",
    // Tier 2 - Core Operations
    "Multi-Digit Addition": "Multi-Digit Addition",
    "Multi-Digit Subtraction": "Multi-Digit Subtraction",
    "Long Division": "Long Division",
    "Equivalent Fractions": "Equivalent Fractions",
    "Mixed Numbers": "Mixed Numbers",
    "Word Problems": "Word Problems",
    "Arrays and Area Models": "Arrays and Area Models",
    // Tier 3 - Rational Numbers
    "Mean Median Mode": "Mean Median Mode",
    "Data Collection": "Data Collection",
    "Basic Graphing": "Basic Graphing",
    "Unit Conversion": "Unit Conversion",
    "Absolute Value": "Absolute Value",
    "Scientific Notation": "Scientific Notation",
    "Square Roots": "Square Roots",
    // Tier 4 - Pre-Algebra
    "Order of Operations": "Order of Operations",
    "Algebraic Expressions": "Algebraic Expressions",
    "Angles and Lines": "Angles and Lines",
    "Surface Area": "Surface Area",
    "Two-Way Tables": "Two-Way Tables",
    "Scatter Plots": "Scatter Plots",
    "Box Plots": "Box Plots",
    "Probability Basics": "Probability Basics",
    // Tier 5 - Algebra I
    "Linear Equations": "Linear Equations",
    "Exponential Functions": "Exponential Functions",
    "Arithmetic Sequences": "Arithmetic Sequences",
    "Geometric Sequences": "Geometric Sequences",
    "Compound Interest": "Compound Interest",
    "Domain and Range": "Domain and Range",
    // Tier 6 - Geometry
    "Law of Sines": "Law of Sines",
    "Law of Cosines": "Law of Cosines",
    "Coordinate Geometry": "Coordinate Geometry",
    // Tier 7 - Algebra II
    "Completing the Square": "Completing the Square",
    "Conic Sections": "Conic Sections",
    "Rational Functions": "Rational Functions",
    "Piecewise Functions": "Piecewise Functions",
    "Expected Value": "Expected Value",
    // Tier 8 - Pre-Calculus
    "Trig Functions": "Trig Functions",
    "Radian Measure": "Radian Measure",
    "Inverse Trig": "Inverse Trig",
    "Advanced Functions": "Advanced Functions",
    "Parametric Equations": "Parametric Equations",
    "Polar Coordinates": "Polar Coordinates",
    "Normal Distribution": "Normal Distribution",
    // Tier 9 - Calculus
    "Differential Equations": "Differential Equations",
    "Chain Rule": "Chain Rule",
    "Product Rule": "Product Rule",
    "Integration Techniques": "Integration Techniques",
    // Tier 10 - Advanced
    "Partial Derivatives": "Partial Derivatives",
    "Multivariable Calculus": "Multivariable Calculus",
    "Linear Algebra": "Linear Algebra",
    "Discrete Math": "Discrete Math"
};

// Get the Skill Tree skill name for a Dojo domain
function getSkillTreeName(domain) {
    return SKILL_TREE_MAPPING[domain] || domain;
}

// ========================================
// SKILL TREE INTEGRATION - PHASE 1-4
// ========================================

// Skill tree state storage
let skillTreeData = {
    skills: {},        // { skillName: { state, mastery_score, last_practiced, prerequisites } }
    connections: [],   // [[from, to], ...] for prerequisites
    lastSync: null,
    userId: null
};

// Math skill tree connections (prerequisites) - matches SkillTreeViewer.html
const MATH_CONNECTIONS = [
    // Basic Arithmetic
    ["Counting and Number Recognition", "Place Value Understanding"],
    ["Counting and Number Recognition", "Comparing Numbers"],
    ["Counting and Number Recognition", "Skip Counting"],
    ["Counting and Number Recognition", "Number Lines"],
    ["Counting and Number Recognition", "Even and Odd"],
    ["Comparing Numbers", "Ordering Numbers"],
    ["Comparing Numbers", "Time Telling"],
    ["Place Value Understanding", "Time Telling"],
    ["Time Telling", "Money and Coins"],
    ["Money and Coins", "Patterns and Sequences"],
    ["Place Value Understanding", "Basic Addition"],
    ["Place Value Understanding", "Basic Subtraction"],
    // Additional Tier 1 connections
    ["Counting and Number Recognition", "Teen Numbers"],
    ["Counting and Number Recognition", "Number Bonds"],
    ["Teen Numbers", "Place Value Understanding"],
    ["Number Bonds", "Basic Addition"],
    ["Number Bonds", "Basic Subtraction"],
    ["Skip Counting", "Picture Graphs"],
    ["Basic Geometry Concepts", "3D Shapes"],
    ["Basic Geometry Concepts", "Partitioning Shapes"],
    ["Partitioning Shapes", "Composing Shapes"],
    ["Comparing Numbers", "Comparing Lengths"],
    ["Comparing Lengths", "Positional Words"],
    ["Positional Words", "Classifying Objects"],
    // Intermediate Arithmetic
    ["Basic Addition", "Multi-Digit Addition"],
    ["Basic Subtraction", "Multi-Digit Subtraction"],
    ["Multi-Digit Addition", "Multiplication"],
    ["Multi-Digit Subtraction", "Multiplication"],
    ["Basic Addition", "Multiplication"],
    ["Basic Subtraction", "Multiplication"],
    ["Multiplication", "Division"],
    ["Multiplication", "Arrays and Area Models"],
    ["Division", "Long Division"],
    ["Multiplication", "Basic Fractions"],
    ["Multiplication", "Rounding and Estimation"],
    ["Rounding and Estimation", "Estimation"],
    ["Division", "Basic Fractions"],
    ["Basic Fractions", "Equivalent Fractions"],
    ["Equivalent Fractions", "Mixed Numbers"],
    ["Basic Geometry Concepts", "Basic Measurement"],
    ["Basic Measurement", "Unit Conversion"],
    ["Basic Measurement", "Perimeter"],
    // Additional Tier 2 connections
    ["Basic Fractions", "Fraction Operations"],
    ["Equivalent Fractions", "Simplifying Fractions"],
    ["Fraction Operations", "Fraction Word Problems"],
    ["Division", "Word Problems"],
    ["Multiplication", "Factors and Multiples"],
    ["Factors and Multiples", "Prime and Composite"],
    ["Data Collection", "Bar Graphs"],
    ["Bar Graphs", "Line Plots"],
    ["Basic Geometry Concepts", "Line Symmetry"],
    ["Angles and Lines", "Types of Angles"],
    ["Types of Angles", "Types of Lines"],
    ["Basic Measurement", "Mass and Capacity"],
    ["Time Telling", "Elapsed Time"],
    ["Multiplication", "Multiplication Properties"],
    ["Perimeter", "Area"],
    // Advanced Arithmetic
    ["Basic Subtraction", "Negatives"],
    ["Negatives", "Absolute Value"],
    ["Basic Fractions", "Advanced Fractions"],
    ["Basic Fractions", "Basic Geometry Concepts"],
    ["Advanced Fractions", "Decimals"],
    ["Decimals", "Percentages"],
    ["Decimals", "Scientific Notation"],
    ["Percentages", "Proportions"],
    ["Advanced Fractions", "Square Roots"],
    ["Basic Graphing", "Data Collection"],
    ["Data Collection", "Mean Median Mode"],
    ["Mean Median Mode", "Probability and Statistics"],
    // Additional Tier 3 connections
    ["Factors and Multiples", "GCF and LCM"],
    ["Place Value Understanding", "Powers of 10"],
    ["Basic Graphing", "Coordinate Plane"],
    ["Basic Algebraic Expressions", "Expressions with Variables"],
    ["Solving Simple Equations", "One-Step Equations"],
    ["Probability Basics", "Simple Probability"],
    ["Mean Median Mode", "Comparing Distributions"],
    ["3D Shapes", "Nets of 3D Shapes"],
    // Additional forward connections for leaf nodes
    ["Long Division", "Basic Fractions"],
    ["Unit Conversion", "Proportions"],
    ["Proportions", "Ratio and Proportion"],
    ["Coordinate Plane", "Coordinate Geometry"],
    ["Ratio and Proportion", "Proportions"],
    ["GCF and LCM", "Simplifying Fractions"],
    ["Powers of 10", "Scientific Notation"],
    ["One-Step Equations", "Multi-Step Equations"],
    ["Expressions with Variables", "Basic Algebraic Expressions"],
    ["Simple Probability", "Compound Probability"],
    ["Mixed Numbers", "Fraction Operations"],
    ["Line Plots", "Mean Median Mode"],
    ["Types of Lines", "Parallel Lines and Transversals"],
    ["Area", "Area and Perimeter"],
    ["Prime and Composite", "GCF and LCM"],
    ["Fraction Word Problems", "Word Problems"],
    ["Simplifying Fractions", "Fraction Operations"],
    // Pre-Algebra
    ["Percentages", "Basic Algebraic Expressions"],
    ["Percentages", "Ratio and Proportion"],
    ["Percentages", "Basic Graphing"],
    ["Square Roots", "Order of Operations"],
    ["Basic Algebraic Expressions", "Order of Operations"],
    ["Basic Algebraic Expressions", "Solving Simple Equations"],
    ["Basic Graphing", "Two-Way Tables"],
    ["Basic Graphing", "Scatter Plots"],
    ["Scatter Plots", "Box Plots"],
    ["Data Collection", "Probability Basics"],
    ["Volume", "Surface Area"],
    // Additional Tier 4 connections
    ["Order of Operations", "Exponents"],
    ["Square Roots", "Irrational Numbers"],
    ["Square Roots", "Cube Roots"],
    ["Probability Basics", "Compound Probability"],
    ["Data Collection", "Sampling Methods"],
    ["Similarity", "Similar Figures"],
    ["Angles and Lines", "Parallel Lines and Transversals"],
    ["Volume", "Volume of Cylinders Cones Spheres"],
    // Additional forward connections
    ["Exponents", "Exponential Functions"],
    ["Irrational Numbers", "Radicals"],
    ["Cube Roots", "Radicals"],
    ["Sampling Methods", "Probability and Statistics"],
    ["Similar Figures", "Dilations"],
    ["Parallel Lines and Transversals", "Proofs"],
    ["Volume of Cylinders Cones Spheres", "Surface Area"],
    ["Surface Area", "Volume"],
    ["Compound Probability", "Permutations"],
    // Geometry
    ["Basic Geometry Concepts", "Angles and Lines"],
    ["Basic Geometry Concepts", "Transformations"],
    ["Angles and Lines", "Triangles and Pythagorean Theorem"],
    ["Triangles and Pythagorean Theorem", "Circles"],
    ["Angles and Lines", "Area and Perimeter"],
    ["Area and Perimeter", "Volume"],
    ["Triangles and Pythagorean Theorem", "Similarity"],
    ["Similarity", "Congruence"],
    ["Congruence", "Proofs"],
    ["Triangles and Pythagorean Theorem", "Law of Sines"],
    ["Triangles and Pythagorean Theorem", "Law of Cosines"],
    ["Angles and Lines", "Coordinate Geometry"],
    // Additional Tier 6 Geometry connections
    ["Angles and Lines", "Angle Bisectors"],
    ["Angles and Lines", "Perpendicular Bisectors"],
    ["Triangles and Pythagorean Theorem", "Triangle Inequality"],
    ["Triangles and Pythagorean Theorem", "Triangle Centers"],
    ["Triangles and Pythagorean Theorem", "Midsegments"],
    ["Circles", "Inscribed Angles"],
    ["Circles", "Arc Length"],
    ["Circles", "Sector Area"],
    ["Circles", "Tangent Lines"],
    ["Transformations", "Dilations"],
    // Additional Geometry forward connections
    ["Angle Bisectors", "Triangle Centers"],
    ["Perpendicular Bisectors", "Triangle Centers"],
    ["Triangle Inequality", "Proofs"],
    ["Midsegments", "Similarity"],
    ["Inscribed Angles", "Arc Length"],
    ["Arc Length", "Sector Area"],
    ["Tangent Lines", "Conic Sections"],
    ["Coordinate Geometry", "Conic Sections"],
    ["Law of Sines", "Trigonometry"],
    ["Law of Cosines", "Trigonometry"],
    ["Proofs", "Mathematical Logic"],
    // Algebra 1
    ["Solving Simple Equations", "Polynomials"],
    ["Solving Simple Equations", "Linear Equations"],
    ["Square Roots", "Radicals"],
    ["Linear Equations", "Inequalities"],
    ["Linear Equations", "Basic Functions"],
    ["Polynomials", "Factoring"],
    ["Factoring", "Quadratic Equations"],
    ["Basic Functions", "Domain and Range"],
    ["Basic Functions", "Exponential Functions"],
    ["Basic Functions", "Arithmetic Sequences"],
    ["Arithmetic Sequences", "Geometric Sequences"],
    ["Exponential Functions", "Compound Interest"],
    // Additional Tier 5 Algebra 1 connections
    ["Linear Equations", "Multi-Step Equations"],
    ["Solving Simple Equations", "Literal Equations"],
    ["Absolute Value", "Absolute Value Equations"],
    ["Inequalities", "Graphing Linear Inequalities"],
    ["Linear Equations", "Systems by Graphing"],
    ["Linear Equations", "Systems by Substitution"],
    ["Linear Equations", "Systems by Elimination"],
    ["Scatter Plots", "Correlation and Trend Lines"],
    // Additional Algebra 1 forward connections
    ["Multi-Step Equations", "Literal Equations"],
    ["Literal Equations", "Systems by Substitution"],
    ["Absolute Value Equations", "Piecewise Functions"],
    ["Graphing Linear Inequalities", "Systems by Graphing"],
    ["Systems by Graphing", "Conic Sections"],
    ["Systems by Substitution", "Systems by Elimination"],
    ["Systems by Elimination", "Matrices"],
    ["Correlation and Trend Lines", "Probability and Statistics"],
    ["Geometric Sequences", "Sequence and Series"],
    ["Domain and Range", "Rational Functions"],
    ["Compound Interest", "Exponential and Logarithmic Functions"],
    ["Radicals", "Complex Numbers"],
    // Algebra 2
    ["Quadratic Equations", "Complex Numbers"],
    ["Quadratic Equations", "Completing the Square"],
    ["Factoring", "Advanced Polynomials"],
    ["Basic Functions", "Exponential and Logarithmic Functions"],
    ["Basic Functions", "Rational Functions"],
    ["Basic Functions", "Piecewise Functions"],
    ["Rational Functions", "Asymptotes"],
    ["Basic Functions", "Sequence and Series"],
    ["Probability Basics", "Permutations"],
    ["Permutations", "Combinations"],
    ["Probability and Statistics", "Expected Value"],
    // Additional Tier 7 Algebra 2 connections
    ["Advanced Polynomials", "Synthetic Division"],
    ["Sequence and Series", "Binomial Theorem"],
    ["Matrices", "Matrices Intro"],
    // Additional Algebra 2 forward connections
    ["Completing the Square", "Conic Sections"],
    ["Piecewise Functions", "Advanced Functions"],
    ["Asymptotes", "Limits"],
    ["Combinations", "Binomial Theorem"],
    ["Expected Value", "Normal Distribution"],
    ["Synthetic Division", "Rational Functions"],
    ["Binomial Theorem", "Series"],
    ["Matrices Intro", "Matrices"],
    // Pre-Calculus
    ["Exponential and Logarithmic Functions", "Conic Sections"],
    ["Triangles and Pythagorean Theorem", "Trigonometry"],
    ["Trigonometry", "Radian Measure"],
    ["Trigonometry", "Inverse Trig"],
    ["Complex Numbers", "Matrices"],
    ["Advanced Polynomials", "Advanced Functions"],
    ["Advanced Functions", "Parametric Equations"],
    ["Trigonometry", "Vectors"],
    ["Vectors", "Polar Coordinates"],
    ["Probability and Statistics", "Normal Distribution"],
    // Additional Tier 8 Pre-Calculus connections
    ["Trigonometry", "Unit Circle"],
    ["Trigonometry", "Trig Identities"],
    ["Trigonometry", "Graphing Trig Functions"],
    ["Sequence and Series", "Series Convergence"],
    // Additional Pre-Calculus forward connections
    ["Unit Circle", "Trig Identities"],
    ["Trig Identities", "Inverse Trig"],
    ["Graphing Trig Functions", "Limits"],
    ["Series Convergence", "Series"],
    ["Radian Measure", "Unit Circle"],
    ["Inverse Trig", "Derivatives"],
    ["Parametric Equations", "Vector Calculus"],
    ["Polar Coordinates", "Double Integrals"],
    ["Normal Distribution", "Advanced Statistics"],
    ["Conic Sections", "Multivariable Calculus"],
    // Calculus
    ["Advanced Functions", "Limits"],
    ["Matrices", "Limits"],
    ["Vectors", "Limits"],
    ["Limits", "Derivatives"],
    ["Derivatives", "Chain Rule"],
    ["Derivatives", "Product Rule"],
    ["Derivatives", "Integrals"],
    ["Integrals", "Integration Techniques"],
    ["Integrals", "Multivariable Calculus"],
    ["Integrals", "Differential Equations"],
    // Additional Tier 9 Calculus connections
    ["Derivatives", "Quotient Rule"],
    ["Derivatives", "Implicit Differentiation"],
    ["Derivatives", "Related Rates"],
    ["Derivatives", "Applications"],
    ["Integrals", "U-Substitution"],
    ["Integrals", "Integration by Parts"],
    // Additional Calculus forward connections
    ["Chain Rule", "Implicit Differentiation"],
    ["Product Rule", "Integration by Parts"],
    ["Quotient Rule", "Rational Functions"],
    ["Implicit Differentiation", "Related Rates"],
    ["Related Rates", "Applications"],
    ["Applications", "Applied Mathematics"],
    ["U-Substitution", "Integration Techniques"],
    ["Integration by Parts", "Integration Techniques"],
    ["Integration Techniques", "Differential Equations"],
    // Advanced Mathematics connections
    ["Multivariable Calculus", "Partial Derivatives"],
    ["Sequence and Series", "Series"],
    ["Linear Algebra", "Eigenvalues"],
    ["Multivariable Calculus", "Double Integrals"],
    ["Double Integrals", "Triple Integrals"],
    ["Multivariable Calculus", "Vector Calculus"],
    ["Matrices", "Linear Algebra"],
    ["Basic Graphing", "Probability and Statistics"],
    ["Integrals", "Real Analysis"],
    ["Real Analysis", "Complex Analysis"],
    // Specialized Topics connections
    ["Advanced Polynomials", "Abstract Algebra"],
    ["Advanced Fractions", "Number Theory"],
    ["Basic Graphing", "Discrete Mathematics"],
    ["Number Theory", "Advanced Number Theory"],
    ["Discrete Mathematics", "Mathematical Logic"],
    // Mastery connections
    ["Differential Equations", "Applied Mathematics"],
    ["Abstract Algebra", "Theoretical Mathematics"],
    ["Real Analysis", "Theoretical Mathematics"],
    ["Complex Analysis", "Theoretical Mathematics"],
    ["Discrete Mathematics", "Advanced Computational Methods"],
    ["Probability and Statistics", "Advanced Computational Methods"],
    ["Applied Mathematics", "Mathematical Research Techniques"],
    ["Theoretical Mathematics", "Mathematical Research Techniques"],
    ["Advanced Computational Methods", "Mathematical Research Techniques"],
    ["Mathematical Research Techniques", "Differential Geometry"],
    ["Theoretical Mathematics", "Topology"],
    ["Advanced Computational Methods", "Advanced Statistics"]
];

// Map Dojo skill names to tree skill names for prerequisites
const DOJO_TO_TREE_SKILL = {
    // Tier 1 mappings
    "Counting": "Counting and Number Recognition",
    "Comparison": "Comparing Numbers",
    "Addition": "Basic Addition",
    "Subtraction": "Basic Subtraction",
    "Shapes": "Basic Geometry Concepts",
    "Place Value": "Place Value Understanding",
    "Patterns": "Patterns and Sequences",
    "Skip Counting": "Skip Counting",
    "Number Lines": "Number Lines",
    "Even and Odd": "Even and Odd",
    "Ordering Numbers": "Ordering Numbers",
    "Teen Numbers": "Teen Numbers",
    "Number Bonds": "Number Bonds",
    "Picture Graphs": "Picture Graphs",
    "3D Shapes": "3D Shapes",
    "Partitioning Shapes": "Partitioning Shapes",
    "Composing Shapes": "Composing Shapes",
    "Comparing Lengths": "Comparing Lengths",
    "Positional Words": "Positional Words",
    "Classifying Objects": "Classifying Objects",
    // Tier 2 mappings
    "Time": "Time Telling",
    "Money": "Money and Coins",
    "Fractions": "Basic Fractions",
    "Rounding": "Rounding and Estimation",
    "Estimation": "Estimation",
    "Measurement": "Basic Measurement",
    "Perimeter": "Perimeter",
    "Multi-Digit Addition": "Multi-Digit Addition",
    "Multi-Digit Subtraction": "Multi-Digit Subtraction",
    "Multiplication": "Multiplication",
    "Division": "Division",
    "Long Division": "Long Division",
    "Fraction Operations": "Fraction Operations",
    "Equivalent Fractions": "Equivalent Fractions",
    "Simplifying Fractions": "Simplifying Fractions",
    "Mixed Numbers": "Mixed Numbers",
    "Fraction Word Problems": "Fraction Word Problems",
    "Word Problems": "Word Problems",
    "Arrays and Area Models": "Arrays and Area Models",
    "Factors and Multiples": "Factors and Multiples",
    "Prime and Composite": "Prime and Composite",
    "Area": "Area",
    "Bar Graphs": "Bar Graphs",
    "Line Plots": "Line Plots",
    "Line Symmetry": "Line Symmetry",
    "Types of Angles": "Types of Angles",
    "Types of Lines": "Types of Lines",
    "Mass and Capacity": "Mass and Capacity",
    "Elapsed Time": "Elapsed Time",
    "Multiplication Properties": "Multiplication Properties",
    // Tier 3 mappings
    "Decimals": "Decimals",
    "Percents": "Percentages",
    "Ratios": "Ratio and Proportion",
    "Proportions": "Proportions",
    "Integers": "Negatives",
    "Statistics": "Probability and Statistics",
    "Basic Graphing": "Basic Graphing",
    "Absolute Value": "Absolute Value",
    "Scientific Notation": "Scientific Notation",
    "Square Roots": "Square Roots",
    "Volume": "Volume",
    "Order of Operations": "Order of Operations",
    "Data Collection": "Data Collection",
    "Mean Median Mode": "Mean Median Mode",
    "Unit Conversion": "Unit Conversion",
    "GCF and LCM": "GCF and LCM",
    "Powers of 10": "Powers of 10",
    "Coordinate Plane": "Coordinate Plane",
    "Expressions with Variables": "Expressions with Variables",
    "One-Step Equations": "One-Step Equations",
    "Simple Probability": "Simple Probability",
    "Comparing Distributions": "Comparing Distributions",
    "Nets of 3D Shapes": "Nets of 3D Shapes",
    // Tier 4 mappings
    "Equations": "Solving Simple Equations",
    "Exponents": "Exponents",
    "Slope": "Linear Equations",
    "Pythagorean": "Triangles and Pythagorean Theorem",
    "Angles and Lines": "Angles and Lines",
    "Algebraic Expressions": "Basic Algebraic Expressions",
    "Surface Area": "Surface Area",
    "Two-Way Tables": "Two-Way Tables",
    "Scatter Plots": "Scatter Plots",
    "Box Plots": "Box Plots",
    "Probability Basics": "Probability Basics",
    "Transformations": "Transformations",
    "Irrational Numbers": "Irrational Numbers",
    "Cube Roots": "Cube Roots",
    "Compound Probability": "Compound Probability",
    "Sampling Methods": "Sampling Methods",
    "Similar Figures": "Similar Figures",
    "Parallel Lines and Transversals": "Parallel Lines and Transversals",
    "Volume of Cylinders Cones Spheres": "Volume of Cylinders Cones Spheres",
    // Tier 5 mappings
    "Linear Equations": "Linear Equations",
    "Systems": "Linear Equations",
    "Factoring": "Factoring",
    "Functions": "Basic Functions",
    "Inequalities": "Inequalities",
    "Radicals": "Radicals",
    "Exponential Functions": "Exponential Functions",
    "Arithmetic Sequences": "Arithmetic Sequences",
    "Geometric Sequences": "Geometric Sequences",
    "Compound Interest": "Compound Interest",
    "Domain and Range": "Domain and Range",
    "Multi-Step Equations": "Multi-Step Equations",
    "Literal Equations": "Literal Equations",
    "Absolute Value Equations": "Absolute Value Equations",
    "Graphing Linear Inequalities": "Graphing Linear Inequalities",
    "Systems by Graphing": "Systems by Graphing",
    "Systems by Substitution": "Systems by Substitution",
    "Systems by Elimination": "Systems by Elimination",
    "Correlation and Trend Lines": "Correlation and Trend Lines",
    // Tier 6 mappings
    "Triangles": "Triangles and Pythagorean Theorem",
    "Circles": "Circles",
    "Trigonometry": "Trigonometry",
    "Similarity": "Similarity",
    "Congruence": "Congruence",
    "Proofs": "Proofs",
    "Law of Sines": "Law of Sines",
    "Law of Cosines": "Law of Cosines",
    "Coordinate Geometry": "Coordinate Geometry",
    "Angle Bisectors": "Angle Bisectors",
    "Perpendicular Bisectors": "Perpendicular Bisectors",
    "Triangle Inequality": "Triangle Inequality",
    "Triangle Centers": "Triangle Centers",
    "Midsegments": "Midsegments",
    "Inscribed Angles": "Inscribed Angles",
    "Arc Length": "Arc Length",
    "Sector Area": "Sector Area",
    "Tangent Lines": "Tangent Lines",
    "Dilations": "Dilations",
    // Tier 7 mappings
    "Quadratics": "Quadratic Equations",
    "Completing the Square": "Completing the Square",
    "Logarithms": "Exponential and Logarithmic Functions",
    "Polynomials": "Polynomials",
    "Sequences": "Sequence and Series",
    "Probability": "Probability and Statistics",
    "Conic Sections": "Conic Sections",
    "Rational Functions": "Rational Functions",
    "Piecewise Functions": "Piecewise Functions",
    "Asymptotes": "Asymptotes",
    "Permutations": "Permutations",
    "Combinations": "Combinations",
    "Expected Value": "Expected Value",
    "Synthetic Division": "Synthetic Division",
    "Binomial Theorem": "Binomial Theorem",
    "Matrices Intro": "Matrices Intro",
    // Tier 8 mappings
    "Trig Functions": "Trigonometry",
    "Radian Measure": "Radian Measure",
    "Inverse Trig": "Inverse Trig",
    "Limits": "Limits",
    "Complex Numbers": "Complex Numbers",
    "Vectors": "Vectors",
    "Advanced Functions": "Advanced Functions",
    "Parametric Equations": "Parametric Equations",
    "Polar Coordinates": "Polar Coordinates",
    "Normal Distribution": "Normal Distribution",
    "Unit Circle": "Unit Circle",
    "Trig Identities": "Trig Identities",
    "Graphing Trig Functions": "Graphing Trig Functions",
    "Series Convergence": "Series Convergence",
    // Tier 9 mappings
    "Derivatives": "Derivatives",
    "Integrals": "Integrals",
    "Differential Equations": "Differential Equations",
    "Chain Rule": "Chain Rule",
    "Product Rule": "Product Rule",
    "Integration Techniques": "Integration Techniques",
    "Applications": "Applications",
    "Quotient Rule": "Quotient Rule",
    "Implicit Differentiation": "Implicit Differentiation",
    "Related Rates": "Related Rates",
    "U-Substitution": "U-Substitution",
    "Integration by Parts": "Integration by Parts",
    // Tier 10 mappings
    "Partial Derivatives": "Partial Derivatives",
    "Matrices": "Matrices",
    "Series": "Series",
    "Discrete Math": "Discrete Mathematics",
    "Multivariable Calculus": "Multivariable Calculus",
    "Linear Algebra": "Linear Algebra",
    "Eigenvalues": "Eigenvalues",
    "Double Integrals": "Double Integrals",
    "Triple Integrals": "Triple Integrals",
    "Vector Calculus": "Vector Calculus",
    "Real Analysis": "Real Analysis",
    "Complex Analysis": "Complex Analysis",
    "Abstract Algebra": "Abstract Algebra",
    "Number Theory": "Number Theory",
    "Advanced Number Theory": "Advanced Number Theory",
    "Mathematical Logic": "Mathematical Logic",
    "Differential Geometry": "Differential Geometry",
    "Topology": "Topology",
    "Advanced Statistics": "Advanced Statistics",
    "Applied Mathematics": "Applied Mathematics",
    "Theoretical Mathematics": "Theoretical Mathematics",
    "Advanced Computational Methods": "Advanced Computational Methods"
};

// Get the tree skill name for a Dojo domain
function getTreeSkillName(domain) {
    return DOJO_TO_TREE_SKILL[domain] || SKILL_TREE_MAPPING[domain] || domain;
}

// Get prerequisites for a skill (returns Dojo domain names)
function getSkillPrerequisites(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const prereqs = MATH_CONNECTIONS
        .filter(([from, to]) => to === treeSkillName)
        .map(([from]) => from);

    // Convert tree names back to Dojo names
    const dojoPrereqs = [];
    for (const prereq of prereqs) {
        // Find Dojo name that maps to this tree skill
        let dojoName = null;
        for (const [dojo, tree] of Object.entries(DOJO_TO_TREE_SKILL)) {
            if (tree === prereq) {
                dojoName = dojo;
                break;
            }
        }
        // Also check SKILL_TREE_MAPPING
        if (!dojoName) {
            for (const [dojo, tree] of Object.entries(SKILL_TREE_MAPPING)) {
                if (tree === prereq) {
                    dojoName = dojo;
                    break;
                }
            }
        }
        // Use tree name if no Dojo mapping found
        dojoPrereqs.push(dojoName || prereq);
    }
    return dojoPrereqs;
}

// Check if a skill is unlocked (prerequisites mastered)
function isSkillUnlocked(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const skillData = skillTreeData.skills[treeSkillName];

    // Debug logging
    if (!skillData) {
        console.log(`isSkillUnlocked: ${domain} -> ${treeSkillName} - NO DATA in skillTreeData.skills`);
    }

    // If we have explicit state data, use it
    if (skillData && skillData.state) {
        const unlockedStates = ['activated', 'mastered', 'needs_review', 'available', 'in_progress'];
        return unlockedStates.includes(skillData.state);
    }

    // No skill data - check if this is a root skill (no prerequisites)
    const prereqs = MATH_CONNECTIONS
        .filter(([from, to]) => to === treeSkillName)
        .map(([from]) => from);

    // Root skills (no prerequisites) are always available
    if (prereqs.length === 0) return true;

    // Non-root skills without explicit data are locked
    return false;
}

// Get the state of a skill from tree data
function getSkillState(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const skillData = skillTreeData.skills[treeSkillName];
    return skillData ? skillData.state : 'locked';
}

// Get mastery score for a skill
function getSkillMastery(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const skillData = skillTreeData.skills[treeSkillName];
    return skillData ? (skillData.mastery_score || 0) : 0;
}

// Load skill tree data from localStorage (cross-tab sync)
function loadSkillTreeData() {
    try {
        // Merge data from multiple sources - tree viewer saves to math_skill_states
        // while user-specific data may be in math_skill_progress_${userId}
        const userId = getUserId();
        const userKey = userId ? `math_skill_progress_${userId}` : 'math_skill_progress_guest';

        // Start with tree viewer data (always check this)
        const treeData = localStorage.getItem('math_skill_states');
        if (treeData) {
            const parsed = JSON.parse(treeData);
            skillTreeData.skills = parsed.skills || parsed;
            skillTreeData.lastSync = parsed.lastSync || Date.now();
            console.log('Loaded skill tree data from math_skill_states:', Object.keys(skillTreeData.skills).length, 'skills');
        }

        // Merge with user-specific data if it exists and is newer
        const userData = localStorage.getItem(userKey);
        if (userData) {
            const parsed = JSON.parse(userData);
            const userSkills = parsed.skills || parsed;
            const userSync = parsed.lastSync || 0;

            // If user data is newer, merge it (user data takes precedence)
            if (userSync > (skillTreeData.lastSync || 0)) {
                Object.assign(skillTreeData.skills, userSkills);
                skillTreeData.lastSync = userSync;
                console.log('Merged newer user-specific data:', Object.keys(userSkills).length, 'skills');
            }
        }

        console.log('Total skills loaded:', Object.keys(skillTreeData.skills).length);
    } catch (e) {
        console.warn('Failed to load skill tree data:', e);
    }
}

// Save skill tree data to localStorage (for cross-tab sync)
function saveSkillTreeData() {
    try {
        const userId = getUserId();
        const userKey = userId ? `math_skill_progress_${userId}` : 'math_skill_progress_guest';

        const dataToSave = {
            skills: skillTreeData.skills,
            lastSync: Date.now()
        };

        // Save to user-specific key
        localStorage.setItem(userKey, JSON.stringify(dataToSave));

        // Also save to math_skill_states so Skill Tree can read it
        localStorage.setItem('math_skill_states', JSON.stringify(dataToSave));

        console.log('💾 Saved skill progress to localStorage');

        // Notify parent (portal) that skill data has been updated
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'DOJO_SKILL_DATA_UPDATED',
                skills: skillTreeData.skills,
                timestamp: Date.now()
            }, '*');
        }
    } catch (e) {
        console.warn('Failed to save skill tree data:', e);
    }
}

// Get user ID from various sources
function getUserId() {
    // Try to get from parent window data
    if (window.dojoUserId) return window.dojoUserId;

    // Try URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get('userId')) return params.get('userId');

    // Try localStorage
    const stored = localStorage.getItem('current_user_id');
    if (stored) return stored;

    return null;
}

// ========================================
// CROSS-TAB COMMUNICATION (localStorage events)
// ========================================

// Listen for skill tree updates from other tabs
window.addEventListener('storage', (event) => {
    // Tree practice request - open skill in Dojo
    if (event.key === 'tree_practice_request' && event.newValue) {
        try {
            const data = JSON.parse(event.newValue);
            // Only handle recent requests (within 5 seconds)
            if (Date.now() - data.timestamp < 5000) {
                handleTreePracticeRequest(data);
            }
        } catch (e) {
            console.warn('Failed to parse tree practice request:', e);
        }
    }

    // Skill tree data updated - refresh our local copy
    if (event.key && (event.key.includes('skill_progress') || event.key === 'math_skill_states')) {
        loadSkillTreeData();
        // Refresh UI if we're on skill selection screen
        if (document.getElementById('learning-setup-screen').classList.contains('active')) {
            updateSkillGrid();
        }
        if (document.getElementById('arena-skill-grid')) {
            renderArenaSkills(document.getElementById('skill-tier-filter')?.value || 'all');
        }
    }
});

// Handle practice request from skill tree
function handleTreePracticeRequest(data) {
    const { skill, subject } = data;
    if (subject !== 'Math') return;

    console.log('Received practice request from skill tree:', skill);

    // Find which tier this skill belongs to
    let targetTier = null;
    let targetDomain = null;

    for (let t = 1; t <= 10; t++) {
        for (const domain of TIERS[t].domains) {
            const treeName = getTreeSkillName(domain);
            if (treeName === skill || domain === skill) {
                targetTier = t;
                targetDomain = domain;
                break;
            }
        }
        if (targetTier) break;
    }

    if (targetTier && targetDomain) {
        // Navigate to Sparring Arena (testing mode) for practice
        selectMode('testing');

        // Wait for arena to initialize, then select the skill
        setTimeout(() => {
            // Switch to skill selection mode
            setSelectionMode('skill');

            // Filter to the correct tier
            const tierFilter = document.getElementById('skill-tier-filter');
            if (tierFilter) {
                tierFilter.value = targetTier.toString();
                filterSkillsByTier();
            }

            // Wait for grid to render then select the skill
            setTimeout(() => {
                selectArenaSkill(targetTier, targetDomain);
                showNotification(`Ready to practice: ${targetDomain}`);
            }, 150);
        }, 100);
    } else {
        console.warn('Could not find skill in any tier:', skill);
        // Still open testing mode even if skill not found
        selectMode('testing');
        showNotification(`Skill "${skill}" not found - select a skill to practice`);
    }
}

// Select a skill in the Sparring Arena
function selectArenaSkill(tier, skill) {
    const grid = document.getElementById('arena-skill-grid');
    if (!grid) return;

    // Find the skill card and click it
    const cards = grid.querySelectorAll('.skill-option');
    for (const card of cards) {
        const cardTier = parseInt(card.getAttribute('data-tier'));
        const cardSkill = card.getAttribute('data-skill');
        if (cardTier === tier && cardSkill === skill) {
            // Check if it's not locked
            if (!card.classList.contains('locked')) {
                card.click();
                // Scroll the card into view
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showNotification(`"${skill}" is locked - complete prerequisites first`);
            }
            return;
        }
    }
    console.warn('Skill card not found in arena grid:', skill);
}

// Send navigation request to skill tree
function requestTreeHighlight(domain) {
    const treeSkillName = getTreeSkillName(domain);
    localStorage.setItem('dojo_highlight_request', JSON.stringify({
        skill: treeSkillName,
        subject: 'Math',
        timestamp: Date.now()
    }));
}

// ========================================
// BATCHED SESSION UPDATES (Phase 2)
// ========================================

// Session tracking for batched updates
let sessionData = {
    startTime: null,
    questions: [],      // { domain, tier, correct, time }
    skillProgress: {},  // { domain: { correct, total, totalTime } }
    mode: null
};

// Start tracking a session
function startSessionTracking(mode) {
    sessionData = {
        startTime: Date.now(),
        questions: [],
        skillProgress: {},
        mode: mode
    };
}

// Record a question result
function recordQuestionResult(domain, tier, correct, time) {
    sessionData.questions.push({ domain, tier, correct, time, timestamp: Date.now() });

    // Update skill progress
    if (!sessionData.skillProgress[domain]) {
        sessionData.skillProgress[domain] = { correct: 0, total: 0, totalTime: 0, tier };
    }
    sessionData.skillProgress[domain].total++;
    sessionData.skillProgress[domain].totalTime += time;
    if (correct) {
        sessionData.skillProgress[domain].correct++;
    }
}

// End session and send batched update
function endSessionTracking() {
    if (!sessionData.startTime || sessionData.questions.length === 0) return;

    const sessionDuration = Date.now() - sessionData.startTime;

    // Prepare data for tree
    const batchedUpdate = {
        timestamp: Date.now(),
        userId: getUserId(),
        sessionDuration,
        mode: sessionData.mode,
        skillResults: []
    };

    // Compile skill results
    for (const [domain, data] of Object.entries(sessionData.skillProgress)) {
        const treeSkillName = getTreeSkillName(domain);
        batchedUpdate.skillResults.push({
            skill: treeSkillName,
            domain: domain,
            tier: data.tier,
            correct: data.correct,
            total: data.total,
            avgTime: data.total > 0 ? Math.round(data.totalTime / data.total) : 0,
            accuracy: data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0
        });
    }

    // Write to localStorage for tree to pick up
    localStorage.setItem('dojo_session_complete', JSON.stringify(batchedUpdate));

    // Also update our local skill data based on results
    for (const result of batchedUpdate.skillResults) {
        if (!skillTreeData.skills[result.skill]) {
            skillTreeData.skills[result.skill] = { state: 'in_progress' };
        }

        const skill = skillTreeData.skills[result.skill];
        skill.last_practiced = new Date().toISOString();
        skill.practice_count = (skill.practice_count || 0) + 1;

        // Update mastery based on this session (will be properly calculated by tree)
        if (result.accuracy >= 80 && result.total >= 3) {
            skill.state = 'mastered';
            skill.mastery_score = Math.max(skill.mastery_score || 0, result.accuracy);
            // Unlock dependent skills when mastery is achieved
            triggerDependentUnlocks(result.skill);
        } else if (result.accuracy >= 60 && result.total >= 2) {
            if (skill.state !== 'mastered') {
                skill.state = 'activated';
            }
            skill.mastery_score = Math.max(skill.mastery_score || 0, result.accuracy);
        }
    }

    saveSkillTreeData();

    // Reset session
    sessionData = { startTime: null, questions: [], skillProgress: {}, mode: null };
}

// Show notification toast
function showNotification(message) {
    // Check if notification container exists
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.style.cssText = `
        background: var(--slate-700);
        border: 1px solid var(--amber-500);
        color: var(--slate-100);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ========================================
// BELT TEST → SKILL TREE SYNC
// ========================================

// Apply belt test results to skill tree
// Returns object with lists of mastered, activated, and inferred skills
function applyBeltTestToTree() {
    const results = {
        mastered: [],      // Skills with 100% accuracy
        activated: [],     // Skills with ≥70% accuracy
        inProgress: [],    // Skills attempted but below threshold
        inferred: [],      // Prerequisites auto-unlocked
        totalSkillsUpdated: 0
    };

    // Process each tested domain
    for (let tier = 1; tier <= 10; tier++) {
        const domains = state.domainScores[tier];
        if (!domains) continue;

        for (const [domain, scores] of Object.entries(domains)) {
            if (scores.total === 0) continue;

            const accuracy = Math.round((scores.correct / scores.total) * 100);
            const treeSkillName = getTreeSkillName(domain);

            // Determine new state based on thresholds
            let newState = null;
            let newMastery = accuracy;

            if (accuracy === 100 && scores.total >= 2) {
                // 100% accuracy with at least 2 questions = mastered
                newState = 'mastered';
                newMastery = 100;
                results.mastered.push({ skill: treeSkillName, domain, tier, accuracy, questions: scores.total });
            } else if (accuracy >= 70 && scores.total >= 2) {
                // ≥70% accuracy with at least 2 questions = activated
                newState = 'activated';
                results.activated.push({ skill: treeSkillName, domain, tier, accuracy, questions: scores.total });
            } else if (scores.total >= 1) {
                // Attempted but below threshold = in_progress
                newState = 'in_progress';
                results.inProgress.push({ skill: treeSkillName, domain, tier, accuracy, questions: scores.total });
            }

            if (newState) {
                updateSkillInTree(treeSkillName, newState, newMastery);
                results.totalSkillsUpdated++;
            }
        }
    }

    // Infer prerequisites: if a skill is mastered/activated, prerequisites should be too
    const inferredSkills = inferPrerequisiteMastery(results.mastered, results.activated);
    results.inferred = inferredSkills;
    results.totalSkillsUpdated += inferredSkills.length;

    // Determine placement tier (highest tier with ≥60% accuracy and ≥2 questions)
    let placementTier = 1;
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total >= 2 && s.correct / s.total >= 0.6) placementTier = t;
    }

    // Unlock all skills in tiers below the placement tier
    // This ensures placing at Algebra unlocks foundational skills like counting, addition, etc.
    if (placementTier > 1) {
        const lowerTierSkills = unlockLowerTierSkills(placementTier);
        results.inferred = results.inferred.concat(lowerTierSkills);
        results.totalSkillsUpdated += lowerTierSkills.length;
    }

    // Save to localStorage for tree to pick up
    saveSkillTreeData();

    // Send ALL updated skills to parent for Supabase persistence
    // sendSessionResults() only covers directly tested skills, not inferred/unlocked ones
    if (window.parent && window.parent !== window) {
        const allUpdatedSkills = [];
        for (const [name, skill] of Object.entries(skillTreeData.skills)) {
            if (skill.state && skill.state !== 'locked') {
                allUpdatedSkills.push({
                    skillName: name,
                    state: skill.state,
                    mastery_score: skill.mastery_score || (skill.state === 'mastered' ? 100 : 0)
                });
            }
        }
        if (allUpdatedSkills.length > 0) {
            window.parent.postMessage({
                type: 'BACKFILL_SKILLS',
                subject: 'Math',
                skills: allUpdatedSkills
            }, '*');
        }
    }

    // Write belt test results to localStorage for tree cross-tab sync
    localStorage.setItem('belt_test_complete', JSON.stringify({
        timestamp: Date.now(),
        userId: getUserId(),
        results: results,
        tierScores: state.tierScores,
        domainScores: state.domainScores
    }));

    return results;
}

// Update a single skill in the tree data
function updateSkillInTree(skillName, newState, mastery) {
    if (!skillTreeData.skills[skillName]) {
        skillTreeData.skills[skillName] = {};
    }

    const skill = skillTreeData.skills[skillName];
    const currentState = skill.state;

    // Only upgrade states, never downgrade
    const stateRank = { 'locked': 0, 'available': 1, 'in_progress': 2, 'activated': 3, 'mastered': 4, 'needs_review': 3 };
    if (stateRank[newState] > (stateRank[currentState] || 0)) {
        skill.state = newState;
    }

    // Update mastery score (keep higher)
    skill.mastery_score = Math.max(skill.mastery_score || 0, mastery);
    skill.last_practiced = new Date().toISOString();
    skill.practice_count = (skill.practice_count || 0) + 1;

    if (newState === 'mastered' && !skill.mastered_at) {
        skill.mastered_at = new Date().toISOString();
    }
}

// When a skill is mastered, unlock dependent skills whose prerequisites are all met
function triggerDependentUnlocks(masteredSkillName) {
    // Find all skills that depend on the mastered skill
    const dependents = MATH_CONNECTIONS
        .filter(([from, to]) => from === masteredSkillName)
        .map(([from, to]) => to);

    for (const dependent of dependents) {
        // Initialize if not tracked yet
        if (!skillTreeData.skills[dependent]) {
            skillTreeData.skills[dependent] = { state: 'locked', mastery_score: 0 };
        }

        const depSkill = skillTreeData.skills[dependent];
        // Only unlock if currently locked
        if (depSkill.state !== 'locked') continue;

        // Check if ALL prerequisites for this dependent are mastered
        const prereqs = MATH_CONNECTIONS
            .filter(([from, to]) => to === dependent)
            .map(([from]) => from);

        const allMet = prereqs.every(prereq => {
            const s = skillTreeData.skills[prereq];
            return s && (s.state === 'mastered' || s.state === 'activated');
        });

        if (allMet) {
            depSkill.state = 'available';
            console.log(`Unlocked dependent skill: ${dependent}`);
            // Recurse in case this unlock cascades (available doesn't trigger further, but be safe)
        }
    }
}

// Unlock all skills in tiers below the placement tier
// This ensures that placing at Algebra unlocks all foundational skills like counting, addition, etc.
function unlockLowerTierSkills(placementTier) {
    const unlocked = [];

    // For each tier below the placement tier
    for (let tier = 1; tier < placementTier; tier++) {
        const tierData = TIERS[tier];
        if (!tierData || !tierData.domains) continue;

        // Get all domains in this tier and unlock them
        for (const domain of tierData.domains) {
            const treeSkillName = getTreeSkillName(domain);

            // Check if not already mastered
            const currentState = skillTreeData.skills[treeSkillName]?.state;
            if (currentState !== 'mastered') {
                updateSkillInTree(treeSkillName, 'mastered', 100);
                unlocked.push({ skill: treeSkillName, domain, tier, newState: 'mastered' });
            }
        }
    }

    return unlocked;
}

// Infer that prerequisites are mastered if higher-level skills are mastered
function inferPrerequisiteMastery(masteredSkills, activatedSkills) {
    const inferred = [];
    const processedSkills = new Set();

    // Helper to get all prerequisites recursively
    function getAllPrereqs(skillName, visited = new Set()) {
        if (visited.has(skillName)) return [];
        visited.add(skillName);

        const directPrereqs = MATH_CONNECTIONS
            .filter(([from, to]) => to === skillName)
            .map(([from]) => from);

        let allPrereqs = [...directPrereqs];
        for (const prereq of directPrereqs) {
            allPrereqs = allPrereqs.concat(getAllPrereqs(prereq, visited));
        }
        return [...new Set(allPrereqs)];
    }

    // For each mastered skill, mark all prerequisites as mastered
    for (const { skill } of masteredSkills) {
        const prereqs = getAllPrereqs(skill);
        for (const prereq of prereqs) {
            if (!processedSkills.has(prereq)) {
                processedSkills.add(prereq);

                // Check if not already mastered
                const currentState = skillTreeData.skills[prereq]?.state;
                if (currentState !== 'mastered') {
                    updateSkillInTree(prereq, 'mastered', 100);
                    inferred.push({ skill: prereq, inferredFrom: skill, newState: 'mastered' });
                }
            }
        }
    }

    // For each activated skill, mark prerequisites as at least activated
    for (const { skill, accuracy } of activatedSkills) {
        const prereqs = getAllPrereqs(skill);
        for (const prereq of prereqs) {
            if (!processedSkills.has(prereq)) {
                processedSkills.add(prereq);

                // Check if not already mastered or activated
                const currentState = skillTreeData.skills[prereq]?.state;
                if (currentState !== 'mastered' && currentState !== 'activated') {
                    updateSkillInTree(prereq, 'activated', Math.max(accuracy, 70));
                    inferred.push({ skill: prereq, inferredFrom: skill, newState: 'activated' });
                }
            }
        }
    }

    return inferred;
}

// Generate HTML for belt test skill tree results
function renderBeltTestTreeResults(results) {
    let html = '<div class="tree-sync-results">';
    html += '<h3 style="color: var(--amber-400); margin-bottom: 1rem;">🌳 Skill Tree Updated</h3>';

    if (results.mastered.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--emerald-400);">✓ Mastered (100%)</h4>';
        html += '<div class="skill-chips">';
        for (const s of results.mastered) {
            html += `<span class="skill-chip mastered">${s.domain}</span>`;
        }
        html += '</div></div>';
    }

    if (results.activated.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--cyan-400);">◐ Activated (≥70%)</h4>';
        html += '<div class="skill-chips">';
        for (const s of results.activated) {
            html += `<span class="skill-chip activated">${s.domain} (${s.accuracy}%)</span>`;
        }
        html += '</div></div>';
    }

    if (results.inferred.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--violet-400);">↑ Prerequisites Inferred</h4>';
        html += '<div class="skill-chips">';
        const masteredInferred = results.inferred.filter(s => s.newState === 'mastered');
        const activatedInferred = results.inferred.filter(s => s.newState === 'activated');
        for (const s of masteredInferred.slice(0, 8)) {
            html += `<span class="skill-chip inferred-mastered">${s.skill}</span>`;
        }
        for (const s of activatedInferred.slice(0, 8)) {
            html += `<span class="skill-chip inferred-activated">${s.skill}</span>`;
        }
        if (results.inferred.length > 16) {
            html += `<span class="skill-chip more">+${results.inferred.length - 16} more</span>`;
        }
        html += '</div></div>';
    }

    if (results.inProgress.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--slate-400);">○ Needs Practice</h4>';
        html += '<div class="skill-chips">';
        for (const s of results.inProgress) {
            html += `<span class="skill-chip in-progress">${s.domain} (${s.accuracy}%)</span>`;
        }
        html += '</div></div>';
    }

    html += `<div class="total-updated" style="margin-top: 1rem; color: var(--slate-400); font-size: 0.9rem;">`;
    html += `Total skills updated: ${results.totalSkillsUpdated}`;
    html += '</div></div>';

    return html;
}

// STATE — declared early so all functions can access it
// (full object defined here to avoid temporal dead zone errors)
let state = { mode: null, currentTier: 5, selectedTiers: [], history: [], tierScores: {}, domainScores: {}, gapLog: [], currentQuestion: null, selectedAnswer: null, startTime: null, timerInterval: null, elapsedTime: 0, consecutiveCorrect: 0, consecutiveWrong: 0, currentStreak: 0, probeMode: false,
    // Learning Center state
    learningTier: 1, learningSkill: null, learningPhase: 'learn', currentLesson: null, guidedStep: 0, practiceAttempts: 0, practiceCorrect: 0,
    // Progressive sub-skill state
    currentSubSkillIndex: 0,
    completedSubSkills: {},
    // Domain coverage tracking for placement test
    testedDomains: {},
    // Sparring Arena state
    arenaSelectionMode: 'tier',
    selectedSkills: [],
    practiceMode: 'endless',
    timeLimit: 60,
    questionGoal: 10,
    arenaStartTime: null,
    arenaTimeRemaining: 0,
    // Visual interaction state
    visualAnswer: null,
    visualType: null,
    visualInteractive: false
};

// Initialize skill tree integration on load
document.addEventListener('DOMContentLoaded', () => {
    loadSkillTreeData();
    loadSubSkillProgress(); // Load progressive sub-skill completion data

    // Request skill data from parent
    requestSkillData();

    // Check for pending practice request from skill tree
    checkPendingPracticeRequest();
});

// Check for and handle pending practice request from skill tree
function checkPendingPracticeRequest() {
    try {
        const requestData = localStorage.getItem('tree_practice_request');
        if (!requestData) return;

        const data = JSON.parse(requestData);
        // Only handle recent requests (within 10 seconds)
        if (Date.now() - data.timestamp < 10000) {
            console.log('Found pending practice request:', data.skill);
            // Clear the request so we don't handle it again
            localStorage.removeItem('tree_practice_request');
            // Small delay to let the page fully initialize
            setTimeout(() => {
                handleTreePracticeRequest(data);
            }, 500);
        } else {
            // Clear old request
            localStorage.removeItem('tree_practice_request');
        }
    } catch (e) {
        console.warn('Failed to check pending practice request:', e);
    }
}

// Also load on script execution (in case DOMContentLoaded already fired)
loadSkillTreeData();
loadSubSkillProgress();

// Send progress update to parent window (portal)
function sendSkillProgress(domain, tier, correct, total, time) {
    if (!window.parent || window.parent === window) return;

    const skillName = getSkillTreeName(domain);
    const masteryScore = total > 0 ? Math.round((correct / total) * 100) : 0;

    // Determine skill state based on mastery
    let skillState = 'in_progress';
    if (masteryScore >= 80 && total >= 3) {
        skillState = 'mastered';
    } else if (masteryScore >= 60 && total >= 2) {
        skillState = 'activated';
    }

    window.parent.postMessage({
        type: 'DOGO_SKILL_PROGRESS',
        skill: skillName,
        domain: domain,
        tier: tier,
        correct: correct,
        total: total,
        masteryScore: masteryScore,
        averageTime: time,
        skillState: skillState,
        timestamp: Date.now()
    }, '*');
}

// Send session results when test/learning ends
function sendSessionResults() {
    if (!window.parent || window.parent === window) return;

    const skillProgress = [];

    // Compile all domain scores into skill progress
    for (let t = 1; t <= 10; t++) {
        const domains = state.domainScores[t];
        if (!domains) continue;

        for (const [domain, scores] of Object.entries(domains)) {
            if (scores.total > 0) {
                const skillName = getSkillTreeName(domain);
                const masteryScore = Math.round((scores.correct / scores.total) * 100);

                let skillState = 'in_progress';
                if (masteryScore >= 80 && scores.total >= 3) {
                    skillState = 'mastered';
                } else if (masteryScore >= 60 && scores.total >= 2) {
                    skillState = 'activated';
                }

                skillProgress.push({
                    skill: skillName,
                    domain: domain,
                    tier: t,
                    correct: scores.correct,
                    total: scores.total,
                    masteryScore: masteryScore,
                    skillState: skillState
                });
            }
        }
    }

    window.parent.postMessage({
        type: 'DOGO_SESSION_COMPLETE',
        mode: state.mode,
        skillProgress: skillProgress,
        gapLog: state.gapLog.map(g => ({
            ...g,
            skill: getSkillTreeName(g.domain)
        })),
        history: state.history,
        timestamp: Date.now()
    }, '*');
}

// Request initial skill data from parent (for showing unlocked skills)
function requestSkillData() {
    if (!window.parent || window.parent === window) return;

    window.parent.postMessage({
        type: 'DOGO_REQUEST_SKILL_DATA'
    }, '*');
}

// Listen for messages from parent
window.addEventListener('message', (event) => {
    if (event.data.type === 'SKILL_DATA_FOR_DOGO') {
        // Could use this to show which skills are already mastered
        // or to unlock certain tiers based on skill tree progress
        console.log('Received skill data from parent:', event.data);
    } else if (event.data.type === 'SKILL_STATES_FROM_TREE') {
        // Skill tree has updated states - refresh our local data
        console.log('📥 Received skill states from tree:', Object.keys(event.data.skills || {}).length, 'skills');
        if (event.data.skills) {
            // Update our local skill data
            Object.assign(skillTreeData.skills, event.data.skills);
            skillTreeData.lastSync = Date.now();
            console.log('✅ Updated local skill data from tree');
        }
    } else if (event.data.type === 'FULLSCREEN_ENTER') {
        document.body.classList.add('fullscreen-mode');
    } else if (event.data.type === 'FULLSCREEN_EXIT') {
        document.body.classList.remove('fullscreen-mode');
    }
});

// ========================================
// UTILITY FUNCTIONS
// ========================================
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const pick = arr => arr[rand(0, arr.length - 1)];
const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
const simplifyFrac = (n, d) => { const g = gcd(Math.abs(n), Math.abs(d)); return [n/g, d/g]; };

function generateDistractors(correct, count = 3, variance = null) {
    const distractors = new Set();
    const v = variance || Math.max(Math.abs(correct) * 0.5, 2);
    while (distractors.size < count) {
        let d;
        const strategy = rand(0, 3);
        if (strategy === 0) d = correct + rand(1, Math.ceil(v));
        else if (strategy === 1) d = correct - rand(1, Math.ceil(v));
        else if (strategy === 2) d = correct * 2;
        else d = Math.abs(correct - rand(1, Math.ceil(v)));
        if (d !== correct && !distractors.has(d)) distractors.add(d);
    }
    return Array.from(distractors);
}

function formatNumber(n) {
    if (Number.isInteger(n)) return n.toString();
    return parseFloat(n.toFixed(3)).toString();
}

// ========================================
// QUESTION GENERATORS BY TIER
// ========================================
const generators = {
    // TIER 1: Foundations (K-1)
    1: {
        Counting: () => {
            const type = pick(["after", "before", "count"]);
            if (type === "after") {
                const n = rand(1, 18);
                return { question: `What number comes after ${n}?`, answer: n + 1, type: "procedural",
                    explanation: `When counting up, the next number after ${n} is ${n + 1}.` };
            } else if (type === "before") {
                const n = rand(2, 19);
                return { question: `What number comes before ${n}?`, answer: n - 1, type: "procedural",
                    explanation: `When counting, the number before ${n} is ${n - 1}.` };
            } else {
                const n = rand(3, 8);
                const stars = "★ ".repeat(n).trim();
                return { question: `Count the stars: ${stars}`, answer: n, type: "procedural",
                    explanation: `Counting each star: there are ${n} stars.` };
            }
        },
        Comparison: () => {
            const a = rand(1, 20), b = rand(1, 20);
            while (a === b) b = rand(1, 20);
            const answer = a > b ? a : b;
            return { question: `Which is larger: ${a} or ${b}?`, answer, type: "conceptual",
                options: [a, b], explanation: `${answer} is larger because it comes later when counting.` };
        },
        Addition: () => {
            const a = rand(1, 9), b = rand(1, 9);
            return { question: `What is ${a} + ${b}?`, answer: a + b, type: "procedural",
                explanation: `${a} + ${b} = ${a + b}. You can count up ${b} from ${a}.` };
        },
        Subtraction: () => {
            const a = rand(5, 15), b = rand(1, a - 1);
            return { question: `What is ${a} - ${b}?`, answer: a - b, type: "procedural",
                explanation: `${a} - ${b} = ${a - b}. You can count back ${b} from ${a}.` };
        },
        Shapes: () => {
            const shapes = [
                { name: "triangle", sides: 3 }, { name: "square", sides: 4 },
                { name: "pentagon", sides: 5 }, { name: "hexagon", sides: 6 }
            ];
            const shape = pick(shapes);
            return {
                question: `How many sides does this ${shape.name} have?`,
                answer: shape.sides, type: "conceptual",
                explanation: `A ${shape.name} has ${shape.sides} sides.`,
                visual: {
                    type: 'shape',
                    mode: 'display',
                    data: { shape: shape.name, showMeasurements: false }
                }
            };
        },
        "Place Value": () => {
            const type = pick(["tens", "ones", "identify"]);
            if (type === "tens") {
                const tens = rand(1, 9);
                const ones = rand(0, 9);
                const num = tens * 10 + ones;
                return { question: `In the number ${num}, what digit is in the tens place?`, answer: tens, type: "conceptual",
                    explanation: `In ${num}, the ${tens} is in the tens place (worth ${tens * 10}).` };
            } else if (type === "ones") {
                const tens = rand(1, 9);
                const ones = rand(0, 9);
                const num = tens * 10 + ones;
                return { question: `In the number ${num}, what digit is in the ones place?`, answer: ones, type: "conceptual",
                    explanation: `In ${num}, the ${ones} is in the ones place.` };
            } else {
                const tens = rand(2, 5);
                const ones = rand(1, 5);
                return { question: `What number has ${tens} tens and ${ones} ones?`, answer: tens * 10 + ones, type: "procedural",
                    explanation: `${tens} tens = ${tens * 10}, plus ${ones} ones = ${tens * 10 + ones}.` };
            }
        },
        Patterns: () => {
            const type = pick(["number", "shape"]);
            if (type === "number") {
                const start = rand(1, 5);
                const step = pick([1, 2, 3]);
                const seq = [start, start + step, start + 2 * step, start + 3 * step];
                const answer = start + 4 * step;
                return { question: `What comes next? ${seq.join(", ")}, ?`, answer, type: "reasoning",
                    explanation: `The pattern adds ${step} each time. ${seq[3]} + ${step} = ${answer}` };
            } else {
                const patterns = [
                    { seq: "○ ● ○ ● ○ ?", answer: "●", exp: "The pattern alternates: circle, filled circle" },
                    { seq: "□ □ △ □ □ △ □ □ ?", answer: "△", exp: "The pattern is: square, square, triangle (repeating)" },
                    { seq: "★ ○ ○ ★ ○ ○ ★ ?", answer: "○", exp: "The pattern is: star, circle, circle (repeating)" }
                ];
                const p = pick(patterns);
                return { question: `What comes next? ${p.seq}`, answer: p.answer, type: "reasoning",
                    options: ["○", "●", "□", "△", "★"].slice(0, 4), explanation: p.exp };
            }
        },
        "Skip Counting": () => {
            const by = pick([2, 5, 10]);
            const start = by * rand(1, 3);
            const seq = [start, start + by, start + 2 * by, start + 3 * by];
            const answer = start + 4 * by;
            return {
                question: `Count by ${by}s: ${seq.join(", ")}, ?`,
                answer, type: "procedural",
                explanation: `Counting by ${by}s: add ${by} each time. ${seq[3]} + ${by} = ${answer}`,
                visual: {
                    type: 'numberline',
                    mode: 'display',
                    data: { min: 0, max: answer + by, step: by, markers: seq }
                }
            };
        },
        "Number Lines": () => {
            const type = pick(["locate", "jump", "between"]);
            if (type === "locate") {
                const n = rand(0, 20);
                return {
                    question: `Drag the marker to show where ${n} is on the number line.`,
                    answer: n, type: "conceptual",
                    explanation: `${n} is located ${n} units from 0 on the number line.`,
                    visual: {
                        type: 'numberline',
                        mode: 'interactive',
                        data: { min: 0, max: 20, step: 1, target: n, initialValue: 10 }
                    }
                };
            } else if (type === "jump") {
                const start = rand(2, 10);
                const jump = rand(2, 5);
                return {
                    question: `Start at ${start}. Jump forward ${jump}. Drag to show where you land.`,
                    answer: start + jump, type: "procedural",
                    explanation: `${start} + ${jump} = ${start + jump}. Moving right on a number line means adding.`,
                    visual: {
                        type: 'numberline',
                        mode: 'interactive',
                        data: { min: 0, max: 20, step: 1, markers: [start], target: start + jump, initialValue: start }
                    }
                };
            } else {
                const a = rand(1, 8), b = a + 2;
                return {
                    question: `What number is between ${a} and ${b}? Drag to show it.`,
                    answer: a + 1, type: "conceptual",
                    explanation: `${a + 1} comes right after ${a} and right before ${b}.`,
                    visual: {
                        type: 'numberline',
                        mode: 'interactive',
                        data: { min: 0, max: 10, step: 1, markers: [a, b], target: a + 1, initialValue: a }
                    }
                };
            }
        },
        "Even and Odd": () => {
            const type = pick(["identify", "next"]);
            if (type === "identify") {
                const n = rand(1, 20);
                const isEven = n % 2 === 0;
                return { question: `Is ${n} even or odd?`, answer: isEven ? "even" : "odd", type: "conceptual",
                    options: ["even", "odd"],
                    explanation: `${n} is ${isEven ? "even" : "odd"} because it ${isEven ? "can" : "cannot"} be divided into 2 equal groups.` };
            } else {
                const n = rand(2, 18);
                const isEven = n % 2 === 0;
                const nextSame = isEven ? n + 2 : n + 2;
                return { question: `What is the next ${isEven ? "even" : "odd"} number after ${n}?`, answer: nextSame, type: "procedural",
                    explanation: `${isEven ? "Even" : "Odd"} numbers are 2 apart. ${n} + 2 = ${nextSame}` };
            }
        },
        "Ordering Numbers": () => {
            const nums = [rand(1, 20), rand(1, 20), rand(1, 20)];
            while (nums[1] === nums[0]) nums[1] = rand(1, 20);
            while (nums[2] === nums[0] || nums[2] === nums[1]) nums[2] = rand(1, 20);
            const sorted = [...nums].sort((a, b) => a - b);
            const type = pick(["smallest", "largest", "middle"]);
            const visual = {
                type: 'numberline',
                mode: 'display',
                data: { min: 0, max: 20, step: 1, markers: nums }
            };
            if (type === "smallest") {
                return { question: `Look at the number line. Which is smallest: ${nums.join(", ")}?`, answer: sorted[0], type: "conceptual",
                    options: nums, explanation: `${sorted[0]} is the smallest because it's leftmost on the number line.`, visual };
            } else if (type === "largest") {
                return { question: `Look at the number line. Which is largest: ${nums.join(", ")}?`, answer: sorted[2], type: "conceptual",
                    options: nums, explanation: `${sorted[2]} is the largest because it's rightmost on the number line.`, visual };
            } else {
                return { question: `Using the number line, put in order from least to greatest: ${nums.join(", ")}`, answer: sorted.join(", "), type: "procedural",
                    explanation: `Ordered left to right: ${sorted.join(" < ")}`, visual };
            }
        },
        "Teen Numbers": () => {
            const type = pick(["identify", "compose", "place_value", "compare"]);
            if (type === "identify") {
                const teen = rand(11, 19);
                const ones = teen - 10;
                return { question: `The number ${teen} has 1 ten and how many ones?`, answer: ones, type: "conceptual",
                    options: [ones, ones + 1, teen, 10],
                    explanation: `${teen} = 10 + ${ones}. It has 1 ten and ${ones} ones.` };
            } else if (type === "compose") {
                const ones = rand(1, 9);
                const teen = 10 + ones;
                return { question: `What number is 10 + ${ones}?`, answer: teen, type: "procedural",
                    options: [teen, ones, teen + 10, ones + 1],
                    explanation: `10 + ${ones} = ${teen}. Teen numbers are 10 plus some ones.` };
            } else if (type === "place_value") {
                const teen = rand(11, 19);
                return { question: `How many tens are in the number ${teen}?`, answer: 1, type: "conceptual",
                    options: [1, teen - 10, 10, 2],
                    explanation: `${teen} has exactly 1 ten (and ${teen - 10} ones).` };
            } else {
                const teen1 = rand(11, 15);
                const teen2 = rand(16, 19);
                const larger = teen2;
                return { question: `Which is larger: ${teen1} or ${teen2}?`, answer: larger, type: "conceptual",
                    options: [teen1, teen2],
                    explanation: `${teen2} > ${teen1} because ${teen2 - 10} ones > ${teen1 - 10} ones (both have 1 ten).` };
            }
        },
        "Number Bonds": () => {
            const type = pick(["make_5", "make_10", "break_apart", "missing"]);
            if (type === "make_5") {
                const part1 = rand(0, 5);
                const part2 = 5 - part1;
                return { question: `${part1} + ? = 5`, answer: part2, type: "procedural",
                    options: [part2, part1, 5, part2 + 1].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${part1} + ${part2} = 5. These are number bonds to 5.` };
            } else if (type === "make_10") {
                const part1 = rand(0, 10);
                const part2 = 10 - part1;
                return { question: `${part1} + ? = 10`, answer: part2, type: "procedural",
                    options: [part2, part1, 10, Math.abs(part2 - 1)].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${part1} + ${part2} = 10. Knowing bonds to 10 helps with mental math!` };
            } else if (type === "break_apart") {
                const total = pick([5, 10]);
                const part1 = rand(1, total - 1);
                const part2 = total - part1;
                return { question: `Break apart ${total}: ${total} = ${part1} + ?`, answer: part2, type: "procedural",
                    explanation: `${total} = ${part1} + ${part2}. We can break ${total} into ${part1} and ${part2}.` };
            } else {
                const total = rand(6, 10);
                const part1 = rand(1, total - 1);
                const part2 = total - part1;
                return { question: `? + ${part2} = ${total}`, answer: part1, type: "procedural",
                    options: [part1, part2, total, part1 + 1].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${part1} + ${part2} = ${total}. The missing part is ${part1}.` };
            }
        },
        "Picture Graphs": () => {
            const type = pick(["count", "compare", "total", "difference"]);
            const items = pick([
                { name: "apples", symbol: "🍎" },
                { name: "stars", symbol: "★" },
                { name: "hearts", symbol: "♥" },
                { name: "circles", symbol: "●" }
            ]);
            if (type === "count") {
                const count = rand(2, 6);
                const display = (items.symbol + " ").repeat(count).trim();
                return { question: `How many ${items.name}? ${display}`, answer: count, type: "procedural",
                    explanation: `Count each ${items.symbol}: there are ${count} ${items.name}.` };
            } else if (type === "compare") {
                const count1 = rand(2, 5);
                const count2 = rand(2, 5);
                while (count2 === count1) count2 = rand(2, 5);
                const row1 = "Red: " + (items.symbol + " ").repeat(count1).trim();
                const row2 = "Blue: " + (items.symbol + " ").repeat(count2).trim();
                const more = count1 > count2 ? "Red" : "Blue";
                return { question: `Which has more?\n${row1}\n${row2}`, answer: more, type: "conceptual",
                    options: ["Red", "Blue", "Same"],
                    explanation: `${more} has more (${Math.max(count1, count2)} vs ${Math.min(count1, count2)}).` };
            } else if (type === "total") {
                const count1 = rand(2, 4);
                const count2 = rand(2, 4);
                const row1 = "Cats: " + ("🐱 ").repeat(count1).trim();
                const row2 = "Dogs: " + ("🐶 ").repeat(count2).trim();
                return { question: `How many pets in all?\n${row1}\n${row2}`, answer: count1 + count2, type: "procedural",
                    explanation: `${count1} cats + ${count2} dogs = ${count1 + count2} pets total.` };
            } else {
                const count1 = rand(4, 7);
                const count2 = rand(1, count1 - 1);
                const row1 = "Sunny: " + ("☀ ").repeat(count1).trim();
                const row2 = "Rainy: " + ("🌧 ").repeat(count2).trim();
                return { question: `How many more sunny days than rainy?\n${row1}\n${row2}`, answer: count1 - count2, type: "reasoning",
                    explanation: `${count1} sunny - ${count2} rainy = ${count1 - count2} more sunny days.` };
            }
        },
        "3D Shapes": () => {
            const type = pick(["identify", "faces", "real_world", "compare"]);
            const shapes3D = [
                { name: "cube", faces: 6, edges: 12, vertices: 8, realWorld: ["dice", "ice cube", "box"] },
                { name: "sphere", faces: 0, edges: 0, vertices: 0, realWorld: ["ball", "globe", "orange"] },
                { name: "cylinder", faces: 2, edges: 2, vertices: 0, realWorld: ["can", "tube", "log"] },
                { name: "cone", faces: 1, edges: 1, vertices: 1, realWorld: ["ice cream cone", "party hat", "traffic cone"] },
                { name: "rectangular prism", faces: 6, edges: 12, vertices: 8, realWorld: ["cereal box", "brick", "book"] }
            ];
            const getVisual = (shapeName) => ({
                type: 'shape', mode: 'display',
                data: { shape: shapeName === 'rectangular prism' ? 'cube' : shapeName, showMeasurements: false }
            });
            if (type === "identify") {
                const shape = pick(shapes3D);
                const item = pick(shape.realWorld);
                return { question: `A ${item} is shaped like a...?`, answer: shape.name, type: "conceptual",
                    options: shapes3D.slice(0, 4).map(s => s.name),
                    explanation: `A ${item} is shaped like a ${shape.name}.` };
            } else if (type === "faces") {
                const shape = pick(shapes3D.filter(s => s.faces > 0));
                return { question: `How many flat faces does this ${shape.name} have?`, answer: shape.faces, type: "conceptual",
                    options: [shape.faces, shape.faces + 1, shape.faces - 1, shape.faces + 2].filter(n => n >= 0),
                    explanation: `A ${shape.name} has ${shape.faces} flat face${shape.faces !== 1 ? "s" : ""}.`,
                    visual: getVisual(shape.name) };
            } else if (type === "real_world") {
                const shape = pick(shapes3D);
                const correct = pick(shape.realWorld);
                const wrong = shapes3D.filter(s => s.name !== shape.name).flatMap(s => s.realWorld).slice(0, 3);
                return { question: `Look at this shape. Which object is shaped like it?`, answer: correct, type: "conceptual",
                    options: shuffle([correct, ...wrong]).slice(0, 4),
                    explanation: `A ${correct} is shaped like a ${shape.name}.`,
                    visual: getVisual(shape.name) };
            } else {
                const shape = pick(shapes3D.filter(s => s.name !== "sphere"));
                return { question: `Can this ${shape.name} roll?`, answer: shape.name === "sphere" || shape.name === "cylinder" || shape.name === "cone" ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: shape.name === "sphere" || shape.name === "cylinder" || shape.name === "cone" ?
                        `Yes! A ${shape.name} has curved surfaces and can roll.` :
                        `No. A ${shape.name} has only flat faces and cannot roll.`,
                    visual: getVisual(shape.name) };
            }
        },
        "Partitioning Shapes": () => {
            const type = pick(["halves", "fourths", "identify", "equal_parts"]);
            if (type === "halves") {
                const shape = pick(["circle", "square", "rectangle"]);
                return { question: `If we cut a ${shape} into 2 equal parts, what is each part called?`, answer: "half", type: "conceptual",
                    options: ["half", "fourth", "third", "whole"],
                    explanation: `When we divide something into 2 equal parts, each part is called a half.` };
            } else if (type === "fourths") {
                const shape = pick(["circle", "square", "rectangle"]);
                return { question: `If we cut a ${shape} into 4 equal parts, what is each part called?`, answer: "fourth", type: "conceptual",
                    options: ["fourth", "half", "third", "whole"],
                    explanation: `When we divide something into 4 equal parts, each part is called a fourth (or quarter).` };
            } else if (type === "identify") {
                const parts = pick([2, 4]);
                const partName = parts === 2 ? "halves" : "fourths";
                return { question: `A pizza is cut into ${parts} equal slices. The pizza is cut into...?`, answer: partName, type: "conceptual",
                    options: ["halves", "fourths", "thirds", "sixths"],
                    explanation: `${parts} equal parts are called ${partName}.` };
            } else {
                const total = pick([2, 4]);
                const shaded = rand(1, total);
                return { question: `A shape is divided into ${total} equal parts. ${shaded} part${shaded > 1 ? "s are" : " is"} shaded. How many parts are shaded?`, answer: shaded, type: "procedural",
                    explanation: `${shaded} out of ${total} equal parts are shaded.` };
            }
        },
        "Composing Shapes": () => {
            const type = pick(["combine", "build", "identify_parts"]);
            if (type === "combine") {
                const combos = [
                    { parts: "2 triangles", result: "square", explanation: "Two right triangles can form a square." },
                    { parts: "2 triangles", result: "rectangle", explanation: "Two triangles can form a rectangle." },
                    { parts: "2 squares", result: "rectangle", explanation: "Two squares side by side make a rectangle." },
                    { parts: "6 squares", result: "cube", explanation: "Six squares can fold into a cube." }
                ];
                const combo = pick(combos);
                return { question: `What shape can you make with ${combo.parts}?`, answer: combo.result, type: "reasoning",
                    options: ["square", "rectangle", "triangle", "cube"].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: combo.explanation };
            } else if (type === "build") {
                const shapes = [
                    { target: "rectangle", needs: "2 squares" },
                    { target: "hexagon", needs: "6 triangles" },
                    { target: "square", needs: "2 triangles" }
                ];
                const shape = pick(shapes);
                return { question: `To build a ${shape.target}, you could use...?`, answer: shape.needs, type: "reasoning",
                    options: ["2 squares", "2 triangles", "6 triangles", "4 circles"],
                    explanation: `You can build a ${shape.target} using ${shape.needs}.` };
            } else {
                const wholes = [
                    { shape: "rectangle", parts: 2, partName: "squares" },
                    { shape: "square", parts: 4, partName: "smaller squares" },
                    { shape: "hexagon", parts: 6, partName: "triangles" }
                ];
                const whole = pick(wholes);
                return { question: `A ${whole.shape} is made of ${whole.parts} ${whole.partName}. How many ${whole.partName}?`, answer: whole.parts, type: "conceptual",
                    options: [whole.parts, whole.parts + 1, whole.parts - 1, whole.parts * 2],
                    explanation: `The ${whole.shape} is composed of ${whole.parts} ${whole.partName}.` };
            }
        },
        "Comparing Lengths": () => {
            const type = pick(["compare", "order", "measure", "estimate"]);
            if (type === "compare") {
                const items = [
                    { name: "pencil", length: 7 },
                    { name: "crayon", length: 4 },
                    { name: "book", length: 10 },
                    { name: "eraser", length: 2 }
                ];
                const item1 = pick(items);
                let item2 = pick(items);
                while (item2.name === item1.name) item2 = pick(items);
                const longer = item1.length > item2.length ? item1.name : item2.name;
                return { question: `Which is longer: a ${item1.name} or a ${item2.name}?`, answer: longer, type: "conceptual",
                    options: [item1.name, item2.name, "Same length"],
                    explanation: `A ${longer} is longer than a ${item1.name === longer ? item2.name : item1.name}.` };
            } else if (type === "order") {
                const items = ["ant", "cat", "bus"];
                return { question: `Order from shortest to longest: ${shuffle([...items]).join(", ")}`, answer: items.join(", "), type: "reasoning",
                    explanation: `From shortest to longest: ant (tiny), cat (small), bus (large).` };
            } else if (type === "measure") {
                const cubes = rand(3, 8);
                return { question: `A ribbon is ${cubes} cubes long. How many cubes?`, answer: cubes, type: "procedural",
                    explanation: `The ribbon measures ${cubes} cubes in length.` };
            } else {
                const objects = [
                    { name: "your hand", length: "about 6 inches" },
                    { name: "a door", length: "about 7 feet" },
                    { name: "a paperclip", length: "about 1 inch" }
                ];
                const obj = pick(objects);
                return { question: `About how long is ${obj.name}?`, answer: obj.length, type: "conceptual",
                    options: ["about 1 inch", "about 6 inches", "about 7 feet", "about 100 feet"],
                    explanation: `${obj.name.charAt(0).toUpperCase() + obj.name.slice(1)} is ${obj.length}.` };
            }
        },
        "Positional Words": () => {
            const positions = [
                { word: "above", opposite: "below", example: "The bird is ___ the tree", answer: "above" },
                { word: "below", opposite: "above", example: "The fish is ___ the water surface", answer: "below" },
                { word: "beside", opposite: "far from", example: "The chair is ___ the table", answer: "beside" },
                { word: "between", opposite: "outside", example: "The number 5 is ___ 4 and 6", answer: "between" },
                { word: "behind", opposite: "in front of", example: "The sun is ___ the clouds", answer: "behind" },
                { word: "next to", opposite: "far from", example: "My desk is ___ the window", answer: "next to" }
            ];
            const type = pick(["fill_in", "identify", "opposite"]);
            if (type === "fill_in") {
                const pos = pick(positions);
                return { question: pos.example.replace("___", "____"), answer: pos.answer, type: "conceptual",
                    options: shuffle(positions.slice(0, 4).map(p => p.word)),
                    explanation: `"${pos.word}" describes the position correctly.` };
            } else if (type === "identify") {
                const pos = pick(positions);
                return { question: `What word means the same as "${pos.word}"?`, answer: pos.word, type: "conceptual",
                    options: shuffle([pos.word, pos.opposite, pick(positions.filter(p => p.word !== pos.word)).word, "inside"]).slice(0, 4),
                    explanation: `"${pos.word}" describes a position.` };
            } else {
                const pos = pick(positions.filter(p => p.opposite !== "far from"));
                return { question: `What is the opposite of "${pos.word}"?`, answer: pos.opposite, type: "conceptual",
                    options: shuffle([pos.opposite, pos.word, "beside", "through"]).slice(0, 4),
                    explanation: `The opposite of "${pos.word}" is "${pos.opposite}".` };
            }
        },
        "Classifying Objects": () => {
            const type = pick(["by_color", "by_size", "by_shape", "odd_one_out"]);
            if (type === "by_color") {
                const colors = ["red", "blue", "green", "yellow"];
                const color = pick(colors);
                const items = [
                    { name: "apple", color: "red" }, { name: "fire truck", color: "red" },
                    { name: "sky", color: "blue" }, { name: "ocean", color: "blue" },
                    { name: "grass", color: "green" }, { name: "leaf", color: "green" },
                    { name: "sun", color: "yellow" }, { name: "banana", color: "yellow" }
                ];
                const matching = items.filter(i => i.color === color);
                const item = pick(matching);
                return { question: `What color group does a ${item.name} belong to?`, answer: color, type: "conceptual",
                    options: colors,
                    explanation: `A ${item.name} is ${color}, so it belongs in the ${color} group.` };
            } else if (type === "by_size") {
                const sizes = [
                    { item: "elephant", size: "big" },
                    { item: "ant", size: "small" },
                    { item: "house", size: "big" },
                    { item: "button", size: "small" },
                    { item: "car", size: "big" },
                    { item: "penny", size: "small" }
                ];
                const obj = pick(sizes);
                return { question: `Is a ${obj.item} big or small?`, answer: obj.size, type: "conceptual",
                    options: ["big", "small"],
                    explanation: `A ${obj.item} is ${obj.size}.` };
            } else if (type === "by_shape") {
                const items = [
                    { name: "clock", shape: "circle" },
                    { name: "window", shape: "square" },
                    { name: "door", shape: "rectangle" },
                    { name: "slice of pizza", shape: "triangle" },
                    { name: "wheel", shape: "circle" },
                    { name: "book", shape: "rectangle" }
                ];
                const item = pick(items);
                return { question: `What shape is a ${item.name}?`, answer: item.shape, type: "conceptual",
                    options: ["circle", "square", "rectangle", "triangle"],
                    explanation: `A ${item.name} is shaped like a ${item.shape}.` };
            } else {
                const groups = [
                    { items: ["apple", "banana", "orange", "car"], odd: "car", reason: "car is not a fruit" },
                    { items: ["dog", "cat", "bird", "table"], odd: "table", reason: "table is not an animal" },
                    { items: ["2", "4", "6", "7"], odd: "7", reason: "7 is not an even number" },
                    { items: ["circle", "square", "triangle", "red"], odd: "red", reason: "red is a color, not a shape" }
                ];
                const group = pick(groups);
                return { question: `Which one does NOT belong: ${group.items.join(", ")}?`, answer: group.odd, type: "reasoning",
                    options: group.items,
                    explanation: `${group.odd} does not belong because ${group.reason}.` };
            }
        }
    },

    // TIER 2: Core Operations (2-4)
    2: {
        "Multi-Digit Addition": () => {
            const a = rand(100, 999), b = rand(100, 999);
            return { question: `What is ${a} + ${b}?`, answer: a + b, type: "procedural",
                explanation: `Add ones, then tens, then hundreds. Carry when needed. ${a} + ${b} = ${a + b}` };
        },
        "Multi-Digit Subtraction": () => {
            const a = rand(200, 999), b = rand(100, a - 50);
            return { question: `What is ${a} - ${b}?`, answer: a - b, type: "procedural",
                explanation: `Subtract ones, tens, hundreds. Borrow when needed. ${a} - ${b} = ${a - b}` };
        },
        Multiplication: () => {
            const a = rand(2, 12), b = rand(2, 12);
            return { question: `What is ${a} × ${b}?`, answer: a * b, type: "procedural",
                explanation: `${a} × ${b} = ${a * b}. This means ${a} groups of ${b}.` };
        },
        Division: () => {
            const b = rand(2, 12), answer = rand(2, 12);
            const a = b * answer;
            return { question: `What is ${a} ÷ ${b}?`, answer, type: "procedural",
                explanation: `${a} ÷ ${b} = ${answer} because ${b} × ${answer} = ${a}.` };
        },
        "Long Division": () => {
            const divisor = rand(2, 9);
            const quotient = rand(10, 30);
            const remainder = rand(0, divisor - 1);
            const dividend = divisor * quotient + remainder;
            if (remainder === 0) {
                return { question: `What is ${dividend} ÷ ${divisor}?`, answer: quotient, type: "procedural",
                    explanation: `${dividend} ÷ ${divisor} = ${quotient} with no remainder.` };
            } else {
                return { question: `${dividend} ÷ ${divisor} = ? R ?`, answer: `${quotient} R ${remainder}`, type: "procedural",
                    options: [`${quotient} R ${remainder}`, `${quotient + 1} R ${remainder}`, `${quotient} R ${remainder + 1}`, `${quotient - 1} R ${divisor}`],
                    explanation: `${dividend} = ${divisor} × ${quotient} + ${remainder}, so ${dividend} ÷ ${divisor} = ${quotient} R ${remainder}` };
            }
        },
        Fractions: () => {
            const type = pick(["identify", "compare_same", "compare_diff", "of_number", "number_line", "order"]);

            if (type === "identify") {
                // Identify fraction from visual
                const d = pick([2, 3, 4, 5, 6, 8]);
                const n = rand(1, d - 1);
                const style = pick(['bar', 'circle']);
                return {
                    question: `What fraction of the shape is shaded?`,
                    answer: `${n}/${d}`, type: "conceptual",
                    options: [`${n}/${d}`, `${d}/${n}`, `${n}/${d+1}`, `${d-n}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${n} shaded out of ${d} equal parts = ${n}/${d}. The numerator is parts shaded, the denominator is total parts.`,
                    visual: { type: 'fraction', mode: 'display', data: { style, numerator: n, denominator: d } }
                };
            } else if (type === "compare_same") {
                // Compare fractions with same denominator
                const d = pick([2, 3, 4, 5, 6, 8]);
                const n1 = rand(1, d - 1);
                let n2 = rand(1, d - 1);
                while (n2 === n1) n2 = rand(1, d - 1);
                const larger = n1 > n2 ? `${n1}/${d}` : `${n2}/${d}`;
                return {
                    question: `Which fraction is larger?`,
                    answer: larger, type: "conceptual",
                    options: [`${n1}/${d}`, `${n2}/${d}`, "They are equal"],
                    explanation: `With the same denominator, compare numerators. ${Math.max(n1,n2)} > ${Math.min(n1,n2)}, so ${larger} is larger.`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n1, denominator: d, compare: { numerator: n2, denominator: d } } }
                };
            } else if (type === "compare_diff") {
                // Compare fractions with different denominators
                const pairs = [
                    { n1: 1, d1: 4, n2: 1, d2: 3 }, { n1: 1, d1: 2, n2: 2, d2: 3 },
                    { n1: 2, d1: 3, n2: 3, d2: 4 }, { n1: 1, d1: 3, n2: 1, d2: 2 }
                ];
                const p = pick(pairs);
                const v1 = p.n1 / p.d1, v2 = p.n2 / p.d2;
                const larger = v1 > v2 ? `${p.n1}/${p.d1}` : `${p.n2}/${p.d2}`;
                return {
                    question: `Compare these fractions. Which is larger?`,
                    answer: larger, type: "conceptual",
                    options: [`${p.n1}/${p.d1}`, `${p.n2}/${p.d2}`, "They are equal"],
                    explanation: `${larger} is larger. You can compare by finding common denominators or using the visuals.`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'circle', numerator: p.n1, denominator: p.d1, compare: { numerator: p.n2, denominator: p.d2 } } }
                };
            } else if (type === "of_number") {
                // Fraction of a whole number
                const d = pick([2, 3, 4, 5]);
                const n = rand(1, d - 1);
                const multiples = [d * 2, d * 3, d * 4, d * 5, d * 6];
                const whole = pick(multiples);
                const answer = (n * whole) / d;
                return {
                    question: `What is ${n}/${d} of ${whole}?`,
                    answer: answer, type: "procedural",
                    options: [answer, whole / d, n * whole, whole - answer].filter((v,i,a) => a.indexOf(v) === i && v > 0),
                    explanation: `To find ${n}/${d} of ${whole}: First divide ${whole} ÷ ${d} = ${whole/d}. Then multiply ${whole/d} × ${n} = ${answer}.`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n, denominator: d } }
                };
            } else if (type === "number_line") {
                // Fractions on number line
                const d = pick([2, 3, 4]);
                const n = rand(1, d);
                const lineDesc = d === 2 ? "two equal parts" : d === 3 ? "three equal parts" : "four equal parts";
                return { question: `A number line from 0 to 1 is divided into ${lineDesc}. What fraction is at the ${n === 1 ? "1st" : n === 2 ? "2nd" : n === 3 ? "3rd" : "4th"} mark after 0?`,
                    answer: n === d ? "1" : `${n}/${d}`, type: "conceptual",
                    options: [`${n}/${d}`, `${d}/${n}`, `${n}/${d+1}`, `${d-n}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `The number line is divided into ${d} equal parts. The ${n === 1 ? "first" : n === 2 ? "second" : n === 3 ? "third" : "fourth"} mark represents ${n}/${d}${n === d ? " = 1" : ""}.` };
            } else {
                // Order fractions (same denominator)
                const d = pick([4, 6, 8]);
                const nums = [];
                while (nums.length < 3) {
                    const n = rand(1, d - 1);
                    if (!nums.includes(n)) nums.push(n);
                }
                const sorted = [...nums].sort((a, b) => a - b);
                const answer = sorted.map(n => `${n}/${d}`).join(", ");
                const reversed = [...sorted].reverse().map(n => `${n}/${d}`).join(", ");
                const swapped = [sorted[1], sorted[0], sorted[2]].map(n => `${n}/${d}`).join(", ");
                const swapped2 = [sorted[0], sorted[2], sorted[1]].map(n => `${n}/${d}`).join(", ");
                return { question: `Order from least to greatest: ${nums.map(n => `${n}/${d}`).join(", ")}`, answer: answer, type: "procedural",
                    options: [answer, reversed, swapped, swapped2],
                    explanation: `With the same denominator (${d}), order by numerator: ${sorted.join(" < ")}. Answer: ${answer}` };
            }
        },
        "Fraction Operations": () => {
            const type = pick(["add_same", "subtract_same", "add_visual", "subtract_visual"]);
            const d = pick([2, 3, 4, 5, 6, 8]);

            if (type === "add_same") {
                // Adding fractions with same denominator
                const n1 = rand(1, d - 2);
                const n2 = rand(1, d - n1);
                const sum = n1 + n2;
                const answerStr = sum >= d ? (sum === d ? "1" : `${sum}/${d}`) : `${sum}/${d}`;
                return { question: `What is ${n1}/${d} + ${n2}/${d}?`, answer: answerStr, type: "procedural",
                    options: [`${sum}/${d}`, `${n1 + n2}/${d + d}`, `${n1}/${d + n2}`, `${sum}/${d * 2}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `When adding fractions with the same denominator, add the numerators and keep the denominator: ${n1}/${d} + ${n2}/${d} = ${n1 + n2}/${d}${sum === d ? " = 1" : ""}` };
            } else if (type === "subtract_same") {
                // Subtracting fractions with same denominator
                const n1 = rand(2, d - 1);
                const n2 = rand(1, n1 - 1);
                const diff = n1 - n2;
                return { question: `What is ${n1}/${d} - ${n2}/${d}?`, answer: `${diff}/${d}`, type: "procedural",
                    options: [`${diff}/${d}`, `${n1 + n2}/${d}`, `${diff}/${d * 2}`, `${n1}/${n2}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `When subtracting fractions with the same denominator, subtract the numerators and keep the denominator: ${n1}/${d} - ${n2}/${d} = ${diff}/${d}` };
            } else if (type === "add_visual") {
                // Visual addition with context
                const d = pick([4, 8]);
                const n1 = rand(1, d - 2);
                const n2 = rand(1, d - n1);
                const sum = n1 + n2;
                const item = d === 4 ? "pizza" : "pie";
                return { question: `You eat ${n1}/${d} of a ${item}. Your friend eats ${n2}/${d} of the same ${item}. How much ${item} was eaten in total?`,
                    answer: `${sum}/${d}`, type: "reasoning",
                    options: [`${sum}/${d}`, `${n1 + n2}/${d + d}`, `${sum}/${d * 2}`, `${n1 * n2}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Add the parts: ${n1}/${d} + ${n2}/${d} = ${sum}/${d} of the ${item} was eaten.` };
            } else {
                // Visual subtraction with context
                const d = pick([4, 8]);
                const n1 = rand(3, d - 1);
                const n2 = rand(1, n1 - 1);
                const diff = n1 - n2;
                const item = d === 4 ? "cake" : "pie";
                return { question: `A ${item} has ${n1}/${d} remaining. If you eat ${n2}/${d} of it, how much is left?`,
                    answer: `${diff}/${d}`, type: "reasoning",
                    options: [`${diff}/${d}`, `${n1 + n2}/${d}`, `${diff}/${d * 2}`, `${n1 * n2}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Subtract the parts: ${n1}/${d} - ${n2}/${d} = ${diff}/${d} of the ${item} remains.` };
            }
        },
        "Equivalent Fractions": () => {
            const type = pick(["multiply", "divide", "identify"]);

            if (type === "multiply") {
                const n = rand(1, 4), d = rand(n + 1, 6);
                const mult = rand(2, 4);
                return {
                    question: `This fraction bar shows ${n}/${d}. What equivalent fraction has ${d * mult} parts?`,
                    answer: `${n * mult}/${d * mult}`, type: "procedural",
                    options: [`${n * mult}/${d * mult}`, `${n + mult}/${d + mult}`, `${n * mult}/${d}`, `${n}/${d * mult}`],
                    explanation: `Multiply both by ${mult}: ${n}×${mult}/${d}×${mult} = ${n * mult}/${d * mult}`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n, denominator: d } }
                };
            } else if (type === "divide") {
                const n = rand(1, 3), d = rand(n + 1, 5);
                const mult = rand(2, 4);
                const bigN = n * mult, bigD = d * mult;
                return {
                    question: `Simplify ${bigN}/${bigD} by dividing by ${mult}.`,
                    answer: `${n}/${d}`, type: "procedural",
                    options: [`${n}/${d}`, `${bigN - mult}/${bigD - mult}`, `${bigN}/${d}`, `${n}/${bigD}`],
                    explanation: `Divide both by ${mult}: ${bigN}÷${mult}/${bigD}÷${mult} = ${n}/${d}`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: bigN, denominator: bigD } }
                };
            } else {
                const n = rand(1, 3), d = rand(n + 1, 5);
                const mult = rand(2, 4);
                const isEquiv = pick([true, false]);
                const n2 = isEquiv ? n * mult : n * mult + 1;
                const d2 = d * mult;
                return {
                    question: `Are these fractions equivalent?`,
                    answer: isEquiv ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isEquiv ?
                        `Yes! ${n}×${mult}=${n2} and ${d}×${mult}=${d2}, so ${n}/${d} = ${n2}/${d2}` :
                        `No. ${n}×${mult}=${n*mult} (not ${n2}), so ${n}/${d} ≠ ${n2}/${d2}`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n, denominator: d, compare: { numerator: n2, denominator: d2 } } }
                };
            }
        },
        "Simplifying Fractions": () => {
            const type = pick(["simplify_basic", "simplify_gcf", "already_simplified", "simplify_to_whole"]);

            if (type === "simplify_basic") {
                // Simple cases with small common factors
                const simplified = [
                    { n: 1, d: 2, mult: pick([2, 3, 4]) },
                    { n: 1, d: 3, mult: pick([2, 3]) },
                    { n: 1, d: 4, mult: pick([2, 3]) },
                    { n: 2, d: 3, mult: pick([2, 3]) },
                    { n: 3, d: 4, mult: pick([2, 3]) }
                ];
                const frac = pick(simplified);
                const bigN = frac.n * frac.mult, bigD = frac.d * frac.mult;
                return { question: `Simplify ${bigN}/${bigD} to lowest terms.`, answer: `${frac.n}/${frac.d}`, type: "procedural",
                    options: [`${frac.n}/${frac.d}`, `${bigN}/${frac.d}`, `${frac.n}/${bigD}`, `${bigN - 1}/${bigD - 1}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Find the GCF of ${bigN} and ${bigD}, which is ${frac.mult}. Divide both by ${frac.mult}: ${bigN}÷${frac.mult}/${bigD}÷${frac.mult} = ${frac.n}/${frac.d}` };
            } else if (type === "simplify_gcf") {
                // Teach GCF concept
                const gcf = pick([2, 3, 4, 5]);
                const simpN = rand(1, 3);
                const simpD = rand(simpN + 1, 5);
                const n = simpN * gcf;
                const d = simpD * gcf;
                return { question: `Simplify ${n}/${d}. (Hint: GCF is ${gcf})`, answer: `${simpN}/${simpD}`, type: "procedural",
                    options: [`${simpN}/${simpD}`, `${n - gcf}/${d - gcf}`, `${n}/${simpD}`, `${simpN}/${d}`].filter((v,i,a) => a.indexOf(v) === i && !v.includes("-") && !v.includes("/0")),
                    explanation: `Divide both numerator and denominator by the GCF (${gcf}): ${n}÷${gcf}/${d}÷${gcf} = ${simpN}/${simpD}` };
            } else if (type === "already_simplified") {
                // Recognize when a fraction is already in lowest terms
                const fractions = [
                    { n: 1, d: 2 }, { n: 1, d: 3 }, { n: 2, d: 3 }, { n: 1, d: 4 }, { n: 3, d: 4 },
                    { n: 1, d: 5 }, { n: 2, d: 5 }, { n: 3, d: 5 }, { n: 4, d: 5 }, { n: 5, d: 6 }
                ];
                const frac = pick(fractions);
                return { question: `Is ${frac.n}/${frac.d} already in simplest form?`, answer: "Yes", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `Yes! ${frac.n} and ${frac.d} share no common factors other than 1, so ${frac.n}/${frac.d} is already in simplest form.` };
            } else {
                // Simplify to a whole number
                const whole = rand(2, 5);
                const d = pick([2, 3, 4, 5]);
                const n = whole * d;
                return { question: `Simplify ${n}/${d}.`, answer: `${whole}`, type: "procedural",
                    options: [`${whole}`, `${n - 1}/${d}`, `1/${d}`, `${d}/${n}`],
                    explanation: `${n} ÷ ${d} = ${whole}. When the numerator is divisible by the denominator, the fraction equals a whole number.` };
            }
        },
        "Mixed Numbers": () => {
            const whole = rand(1, 5), n = rand(1, 3), d = rand(n + 1, 5);
            const improper = whole * d + n;
            const type = pick(["toImproper", "toMixed", "compare", "add_mixed"]);
            if (type === "toImproper") {
                return { question: `Convert ${whole} ${n}/${d} to an improper fraction.`, answer: `${improper}/${d}`, type: "procedural",
                    options: [`${improper}/${d}`, `${whole + n}/${d}`, `${whole * n}/${d}`, `${n}/${whole * d}`],
                    explanation: `${whole} × ${d} + ${n} = ${improper}, so ${whole} ${n}/${d} = ${improper}/${d}` };
            } else if (type === "toMixed") {
                return { question: `Convert ${improper}/${d} to a mixed number.`, answer: `${whole} ${n}/${d}`, type: "procedural",
                    options: [`${whole} ${n}/${d}`, `${whole + 1} ${n}/${d}`, `${whole} ${n + 1}/${d}`, `${improper - d} ${n}/${d}`],
                    explanation: `${improper} ÷ ${d} = ${whole} R ${n}, so ${improper}/${d} = ${whole} ${n}/${d}` };
            } else if (type === "compare") {
                // Compare mixed number to improper fraction
                const w2 = whole + pick([-1, 0, 1]);
                const improper2 = w2 * d + n;
                if (improper === improper2) {
                    return { question: `Are ${whole} ${n}/${d} and ${improper}/${d} equal?`, answer: "Yes", type: "conceptual",
                        options: ["Yes", "No"],
                        explanation: `Yes! ${whole} ${n}/${d} = ${improper}/${d} because ${whole}×${d}+${n} = ${improper}.` };
                }
                const larger = improper > improper2 ? `${whole} ${n}/${d}` : `${improper2}/${d}`;
                return { question: `Which is larger: ${whole} ${n}/${d} or ${improper2}/${d}?`, answer: larger, type: "conceptual",
                    options: [`${whole} ${n}/${d}`, `${improper2}/${d}`, "They are equal"],
                    explanation: `Convert to compare: ${whole} ${n}/${d} = ${improper}/${d}. Since ${Math.max(improper, improper2)} > ${Math.min(improper, improper2)}, ${larger} is larger.` };
            } else {
                // Add mixed numbers with same denominator
                const w1 = rand(1, 3), w2 = rand(1, 3);
                const d = pick([2, 3, 4]);
                const n1 = rand(1, d - 1), n2 = rand(1, d - 1);
                const sumWhole = w1 + w2 + Math.floor((n1 + n2) / d);
                const sumFrac = (n1 + n2) % d;
                const answer = sumFrac === 0 ? `${sumWhole}` : `${sumWhole} ${sumFrac}/${d}`;
                const noRegroup = `${w1 + w2} ${n1 + n2}/${d}`;
                const offByOne = sumFrac === 0 ? `${sumWhole + 1}` : `${sumWhole + 1} ${sumFrac}/${d}`;
                const offByOneDown = sumFrac === 0 ? `${sumWhole - 1}` : `${sumWhole - 1} ${sumFrac}/${d}`;
                return { question: `What is ${w1} ${n1}/${d} + ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                    options: [answer, noRegroup, offByOne, offByOneDown].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                    explanation: `Add whole numbers: ${w1} + ${w2} = ${w1 + w2}. Add fractions: ${n1}/${d} + ${n2}/${d} = ${n1 + n2}/${d}${n1 + n2 >= d ? ` = 1 ${(n1+n2) - d}/${d}` : ""}. Total: ${answer}` };
            }
        },
        "Fraction Word Problems": () => {
            const type = pick(["part_of_whole", "remaining", "sharing", "combining", "comparing"]);

            if (type === "part_of_whole") {
                // Finding a fraction of a group
                const d = pick([2, 3, 4, 5]);
                const n = rand(1, d - 1);
                const total = d * rand(2, 5);
                const answer = (n * total) / d;
                const items = pick(["cookies", "marbles", "stickers", "books", "apples"]);
                return { question: `There are ${total} ${items}. ${n}/${d} of them are red. How many red ${items} are there?`,
                    answer: answer, type: "reasoning",
                    explanation: `To find ${n}/${d} of ${total}: Divide ${total} ÷ ${d} = ${total/d} (one part). Multiply ${total/d} × ${n} = ${answer} red ${items}.` };
            } else if (type === "remaining") {
                // What fraction remains
                const d = pick([4, 6, 8]);
                const eaten = rand(1, d - 2);
                const remaining = d - eaten;
                const food = pick(["pizza", "pie", "cake", "sandwich"]);
                return { question: `A ${food} is cut into ${d} equal slices. ${eaten} slices are eaten. What fraction of the ${food} is left?`,
                    answer: `${remaining}/${d}`, type: "reasoning",
                    options: [`${remaining}/${d}`, `${eaten}/${d}`, `${remaining}/${eaten}`, `${d}/${remaining}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Started with ${d}/${d} (whole ${food}). Eaten: ${eaten}/${d}. Remaining: ${d}/${d} - ${eaten}/${d} = ${remaining}/${d}` };
            } else if (type === "sharing") {
                // Equal sharing problem
                const items = rand(2, 4);
                const people = pick([2, 3, 4]);
                const thing = pick(["pizzas", "cakes", "pies", "sandwiches"]);
                if (items % people === 0) {
                    return { question: `${items} ${thing} are shared equally among ${people} friends. How much does each friend get?`,
                        answer: items / people, type: "reasoning",
                        explanation: `${items} ÷ ${people} = ${items / people} ${thing.slice(0, -1)} per person.` };
                } else {
                    const ans = `${items}/${people}`;
                    return { question: `${items} ${thing} are shared equally among ${people} friends. How much does each friend get?`,
                        answer: ans, type: "reasoning",
                        options: [ans, `${people}/${items}`, `${items - 1}/${people}`, `${items}/${people + 1}`],
                        explanation: `${items} ÷ ${people} = ${ans} ${thing.slice(0, -1)} per person.` };
                }
            } else if (type === "combining") {
                // Adding fractions in context
                const d = pick([4, 8]);
                const n1 = rand(1, d - 2);
                const n2 = rand(1, d - n1);
                const sum = n1 + n2;
                const liquid = pick(["juice", "milk", "water"]);
                const ans = sum === d ? "1 cup" : `${sum}/${d} cup`;
                const opts = sum === d
                    ? ["1 cup", `${sum}/${d} cup`, `${sum - 1}/${d} cup`, `${sum + 1}/${d} cup`]
                    : [`${sum}/${d} cup`, `${sum + 1}/${d} cup`, `${Math.abs(n1 - n2)}/${d} cup`, `${sum}/${d * 2} cup`];
                return { question: `Mom pours ${n1}/${d} cup of ${liquid}. Then she adds ${n2}/${d} cup more. How much ${liquid} in total?`,
                    answer: ans, type: "reasoning",
                    options: opts,
                    explanation: `${n1}/${d} + ${n2}/${d} = ${sum}/${d}${sum === d ? " = 1 whole cup" : " cup"} of ${liquid}.` };
            } else {
                // Comparing fractions in context
                const d = pick([4, 6, 8]);
                const n1 = rand(1, d - 1);
                let n2 = rand(1, d - 1);
                while (n2 === n1) n2 = rand(1, d - 1);
                const name1 = pick(["Emma", "Liam", "Olivia", "Noah"]);
                const name2 = pick(["Sophia", "Jackson", "Ava", "Lucas"]);
                const winner = n1 > n2 ? name1 : name2;
                const food = pick(["pizza", "pie", "cake"]);
                return { question: `${name1} ate ${n1}/${d} of a ${food}. ${name2} ate ${n2}/${d} of the same ${food}. Who ate more?`,
                    answer: winner, type: "reasoning",
                    options: [name1, name2, "They ate the same"],
                    explanation: `Compare numerators (same denominator): ${Math.max(n1, n2)} > ${Math.min(n1, n2)}, so ${winner} ate more (${Math.max(n1, n2)}/${d} vs ${Math.min(n1, n2)}/${d}).` };
            }
        },
        "Word Problems": () => {
            const templates = [
                () => { const a = rand(10, 30), b = rand(5, 15); return { q: `Sam has ${a} apples and buys ${b} more. How many total?`, ans: a + b, exp: `${a} + ${b} = ${a + b} apples` }; },
                () => { const a = rand(20, 50), b = rand(5, 15); return { q: `Maria has ${a} stickers and gives ${b} away. How many left?`, ans: a - b, exp: `${a} - ${b} = ${a - b} stickers` }; },
                () => { const a = rand(3, 8), b = rand(4, 10); return { q: `${a} bags with ${b} marbles each. How many total?`, ans: a * b, exp: `${a} × ${b} = ${a * b} marbles` }; }
            ];
            const t = pick(templates)();
            return { question: t.q, answer: t.ans, type: "reasoning", explanation: t.exp };
        },
        Time: () => {
            const type = pick(["read", "set", "elapsed", "convert"]);
            if (type === "read") {
                const hour = rand(1, 12);
                const min = pick([0, 15, 30, 45]);
                return {
                    question: `What time does this clock show?`,
                    answer: `${hour}:${min.toString().padStart(2, '0')}`, type: "procedural",
                    options: [`${hour}:${min.toString().padStart(2, '0')}`, `${hour}:${((min + 15) % 60).toString().padStart(2, '0')}`, `${(hour % 12) + 1}:${min.toString().padStart(2, '0')}`, `${hour}:${((min + 30) % 60).toString().padStart(2, '0')}`],
                    explanation: `The hour hand points to ${hour} and the minute hand shows ${min} minutes. Time: ${hour}:${min.toString().padStart(2, '0')}`,
                    visual: { type: 'clock', mode: 'display', data: { hour, minute: min } }
                };
            } else if (type === "set") {
                const hour = rand(1, 12);
                const min = pick([0, 15, 30, 45]);
                return {
                    question: `Set the clock to ${hour}:${min.toString().padStart(2, '0')}`,
                    answer: `${hour}:${min.toString().padStart(2, '0')}`, type: "procedural",
                    explanation: `${hour}:${min.toString().padStart(2, '0')} means the hour hand at ${hour} and minute hand at ${min === 0 ? 12 : min / 5}.`,
                    visual: { type: 'clock', mode: 'interactive', data: { hour: 12, minute: 0, target: { hour, minute: min } } }
                };
            } else if (type === "elapsed") {
                const start = rand(1, 10);
                const elapsed = pick([1, 2, 3]);
                const end = start + elapsed;
                return {
                    question: `The clock shows ${start}:00 ${start < 12 ? 'AM' : 'PM'}. What time will it be in ${elapsed} hour${elapsed > 1 ? 's' : ''}?`,
                    answer: `${end}:00`, type: "procedural",
                    options: [`${end}:00`, `${start + elapsed - 1}:00`, `${start}:${elapsed}0`, `${end + 1}:00`],
                    explanation: `${start}:00 + ${elapsed} hours = ${end}:00`,
                    visual: { type: 'clock', mode: 'display', data: { hour: start, minute: 0 } }
                };
            } else {
                const hours = rand(1, 3);
                const minutes = hours * 60;
                return { question: `How many minutes are in ${hours} hour${hours > 1 ? 's' : ''}?`, answer: minutes, type: "procedural",
                    explanation: `1 hour = 60 minutes. ${hours} hours = ${hours} × 60 = ${minutes} minutes` };
            }
        },
        Money: () => {
            const type = pick(["count", "add", "change"]);
            if (type === "count") {
                const quarters = rand(0, 4);
                const dimes = rand(0, 5);
                const nickels = rand(0, 4);
                const total = quarters * 25 + dimes * 10 + nickels * 5;
                return { question: `${quarters === 0 ? 'no quarters' : quarters + ' quarter' + (quarters !== 1 ? 's' : '')}, ${dimes === 0 ? 'no dimes' : dimes + ' dime' + (dimes !== 1 ? 's' : '')}, ${nickels === 0 ? 'no nickels' : nickels + ' nickel' + (nickels !== 1 ? 's' : '')}. How many cents?`,
                    answer: total, type: "procedural",
                    explanation: `${quarters}×25¢ + ${dimes}×10¢ + ${nickels}×5¢ = ${quarters*25} + ${dimes*10} + ${nickels*5} = ${total}¢` };
            } else if (type === "add") {
                const a = rand(10, 50);
                const b = rand(10, 40);
                return { question: `$0.${a.toString().padStart(2, '0')} + $0.${b.toString().padStart(2, '0')} = ?`, answer: `$${((a + b) / 100).toFixed(2)}`, type: "procedural",
                    options: [`$${((a + b) / 100).toFixed(2)}`, `$${((a + b + 10) / 100).toFixed(2)}`, `$${((a + b - 10) / 100).toFixed(2)}`, `$${(a + b)}`],
                    explanation: `${a}¢ + ${b}¢ = ${a + b}¢ = $${((a + b) / 100).toFixed(2)}` };
            } else {
                const price = rand(1, 5) * 10;
                const paid = 100;
                const change = paid - price;
                return { question: `Item costs ${price}¢. You pay $1.00. How much change?`, answer: `${change}¢`, type: "procedural",
                    options: [`${change}¢`, `${change + 10}¢`, `${change - 10}¢`, `${price}¢`],
                    explanation: `100¢ - ${price}¢ = ${change}¢` };
            }
        },
        Rounding: () => {
            const type = pick(["tens", "hundreds"]);
            if (type === "tens") {
                const num = rand(11, 99);
                const rounded = Math.round(num / 10) * 10;
                return { question: `Round ${num} to the nearest ten.`, answer: rounded, type: "procedural",
                    explanation: `${num} is closer to ${rounded} than ${rounded <= num ? rounded + 10 : rounded - 10}. Rounded: ${rounded}` };
            } else {
                const num = rand(101, 999);
                const rounded = Math.round(num / 100) * 100;
                return { question: `Round ${num} to the nearest hundred.`, answer: rounded, type: "procedural",
                    explanation: `${num} rounds to ${rounded} (look at the tens digit: ${Math.floor((num % 100) / 10)})` };
            }
        },
        Measurement: () => {
            const type = pick(["length", "compare", "estimate"]);
            if (type === "length") {
                const inches = rand(12, 36);
                const feet = Math.floor(inches / 12);
                const remainInches = inches % 12;
                return { question: `Convert ${inches} inches to feet and inches.`, answer: `${feet} ft ${remainInches} in`, type: "procedural",
                    options: [`${feet} ft ${remainInches} in`, `${feet + 1} ft ${remainInches} in`, `${feet} ft ${remainInches + 1} in`, `${remainInches} ft ${feet} in`],
                    explanation: `${inches} ÷ 12 = ${feet} remainder ${remainInches}. So ${feet} feet and ${remainInches} inches.` };
            } else if (type === "compare") {
                const items = [
                    { name: "new pencil", length: "about 7 inches", article: "a" },
                    { name: "standard ruler", length: "about 1 foot", article: "a" },
                    { name: "classroom door", length: "about 7 feet", article: "a" },
                    { name: "typical car", length: "about 15 feet", article: "a" }
                ];
                const item = pick(items);
                return { question: `What is the approximate length of ${item.article} ${item.name}?`, answer: item.length, type: "conceptual",
                    options: ["about 7 inches", "about 1 foot", "about 7 feet", "about 15 feet"],
                    explanation: `A ${item.name} is typically ${item.length} long.` };
            } else {
                const cm = rand(2, 10) * 10;
                const inches = Math.round(cm / 2.54);
                return { question: `About how many inches is ${cm} centimeters? (1 inch ≈ 2.5 cm)`, answer: inches, type: "procedural",
                    explanation: `${cm} ÷ 2.5 ≈ ${inches} inches` };
            }
        },
        Estimation: () => {
            const type = pick(["round_add", "round_mult", "estimate_count"]);
            if (type === "round_add") {
                const a = rand(18, 89), b = rand(18, 89);
                const roundA = Math.round(a / 10) * 10, roundB = Math.round(b / 10) * 10;
                const estimate = roundA + roundB;
                return { question: `Estimate ${a} + ${b} by rounding to the nearest ten.`, answer: estimate, type: "procedural",
                    options: [estimate, estimate + 10, estimate - 10, a + b],
                    explanation: `${a} ≈ ${roundA}, ${b} ≈ ${roundB}. Estimate: ${roundA} + ${roundB} = ${estimate}` };
            } else if (type === "round_mult") {
                const a = rand(3, 9), b = rand(18, 52);
                const roundB = Math.round(b / 10) * 10;
                const estimate = a * roundB;
                return { question: `Estimate ${a} × ${b} by rounding ${b} to the nearest ten.`, answer: estimate, type: "procedural",
                    options: [estimate, a * b, estimate + 10, estimate - 10],
                    explanation: `${b} ≈ ${roundB}. Estimate: ${a} × ${roundB} = ${estimate}` };
            } else {
                const scenarios = [
                    { item: "jelly beans in a small jar", reasonable: 50, wrong: [5, 500, 5000] },
                    { item: "students in an elementary school", reasonable: 300, wrong: [30, 3000, 30000] },
                    { item: "pages in a chapter book", reasonable: 200, wrong: [20, 2000, 20000] },
                    { item: "apples in a grocery bag", reasonable: 8, wrong: [1, 80, 800] },
                    { item: "seats in a movie theater", reasonable: 150, wrong: [15, 1500, 15000] },
                    { item: "cars in a parking lot", reasonable: 100, wrong: [10, 1000, 10000] }
                ];
                const scenario = pick(scenarios);
                const options = [scenario.reasonable, ...scenario.wrong].sort(() => Math.random() - 0.5);
                return { question: `About how many ${scenario.item} would there be? Pick the most reasonable estimate.`, answer: scenario.reasonable, type: "reasoning",
                    options: options,
                    explanation: `${scenario.reasonable} is the most reasonable estimate. ${scenario.wrong[0]} is too few, and ${scenario.wrong[1]} or ${scenario.wrong[2]} would be way too many.` };
            }
        },
        Perimeter: () => {
            const type = pick(["rectangle", "square", "triangle"]);
            if (type === "rectangle") {
                const length = rand(5, 15), width = rand(3, 10);
                const perimeter = 2 * (length + width);
                return {
                    question: `Find the perimeter of this rectangle.`,
                    answer: perimeter, type: "procedural",
                    explanation: `Perimeter = 2 × (length + width) = 2 × (${length} + ${width}) = ${perimeter}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'rectangle', dimensions: { width: length, height: width }, showMeasurements: true } }
                };
            } else if (type === "square") {
                const side = rand(4, 12);
                const perimeter = 4 * side;
                return {
                    question: `Find the perimeter of this square.`,
                    answer: perimeter, type: "procedural",
                    explanation: `Perimeter = 4 × side = 4 × ${side} = ${perimeter}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'square', dimensions: { side }, showMeasurements: true } }
                };
            } else {
                const a = rand(4, 8);
                const b = rand(4, 8);
                const minC = Math.abs(a - b) + 1;
                const maxC = Math.min(a + b - 1, 10);
                const c = rand(minC, maxC);
                const perimeter = a + b + c;
                return {
                    question: `Find the perimeter of this triangle with sides ${a}, ${b}, and ${c}.`,
                    answer: perimeter, type: "procedural",
                    explanation: `Perimeter = ${a} + ${b} + ${c} = ${perimeter}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'triangle', dimensions: { sides: [a, b, c] }, showMeasurements: true } }
                };
            }
        },
        "Arrays and Area Models": () => {
            const type = pick(["array", "area_model"]);
            if (type === "array") {
                const rows = rand(2, 6), cols = rand(3, 8);
                const total = rows * cols;
                return { question: `An array has ${rows} rows and ${cols} columns. How many total?`, answer: total, type: "conceptual",
                    explanation: `Arrays show multiplication: ${rows} rows × ${cols} columns = ${total}` };
            } else {
                const tens = rand(1, 3) * 10, ones = rand(2, 8);
                const mult = rand(2, 5);
                const total = (tens + ones) * mult;
                return { question: `Use area model: ${tens + ones} × ${mult} = (${tens} × ${mult}) + (${ones} × ${mult}) = ?`, answer: total, type: "procedural",
                    explanation: `Break apart: ${tens} × ${mult} = ${tens * mult}, ${ones} × ${mult} = ${ones * mult}. Total: ${tens * mult} + ${ones * mult} = ${total}` };
            }
        },
        "Factors and Multiples": () => {
            const type = pick(["find_factors", "is_factor", "find_multiples", "is_multiple", "common_factors"]);
            if (type === "find_factors") {
                const nums = [12, 18, 24, 20, 16, 30, 36];
                const n = pick(nums);
                const factors = [];
                for (let i = 1; i <= n; i++) { if (n % i === 0) factors.push(i); }
                const askFor = pick(["smallest", "largest", "count"]);
                if (askFor === "smallest") {
                    return { question: `What is the smallest factor of ${n} (other than 1)?`, answer: factors[1], type: "procedural",
                        options: [factors[1], factors[2] || 3, n, 1],
                        explanation: `Factors of ${n}: ${factors.join(", ")}. The smallest (other than 1) is ${factors[1]}.` };
                } else if (askFor === "largest") {
                    return { question: `What is the largest factor of ${n}?`, answer: n, type: "conceptual",
                        options: [n, n/2, factors[factors.length-2], factors[1]],
                        explanation: `The largest factor of any number is the number itself. ${n} ÷ ${n} = 1 ✓` };
                } else {
                    return { question: `How many factors does ${n} have?`, answer: factors.length, type: "procedural",
                        explanation: `Factors of ${n}: ${factors.join(", ")}. Count: ${factors.length} factors.` };
                }
            } else if (type === "is_factor") {
                const n = pick([12, 15, 18, 20, 24, 30]);
                const testNum = pick([2, 3, 4, 5, 6, 7]);
                const isFactor = n % testNum === 0;
                return { question: `Is ${testNum} a factor of ${n}?`, answer: isFactor ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isFactor ? `Yes! ${n} ÷ ${testNum} = ${n/testNum} with no remainder.` : `No. ${n} ÷ ${testNum} = ${Math.floor(n/testNum)} R ${n % testNum}.` };
            } else if (type === "find_multiples") {
                const n = pick([2, 3, 4, 5, 6, 7, 8, 9]);
                const multiples = [n, n*2, n*3, n*4, n*5];
                const position = pick([3, 4, 5]);
                return { question: `What is the ${position === 3 ? "3rd" : position === 4 ? "4th" : "5th"} multiple of ${n}?`, answer: n * position, type: "procedural",
                    options: [n * position, n * (position - 1), n * (position + 1), n + position],
                    explanation: `Multiples of ${n}: ${multiples.join(", ")}... The ${position === 3 ? "3rd" : position === 4 ? "4th" : "5th"} is ${n * position}.` };
            } else if (type === "is_multiple") {
                const n = pick([3, 4, 5, 6]);
                const mult = n * rand(2, 8);
                const testNum = pick([mult, mult + 1, mult - 1]);
                const isMultiple = testNum % n === 0;
                return { question: `Is ${testNum} a multiple of ${n}?`, answer: isMultiple ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isMultiple ? `Yes! ${testNum} ÷ ${n} = ${testNum/n} exactly.` : `No. ${testNum} ÷ ${n} = ${Math.floor(testNum/n)} R ${testNum % n}.` };
            } else {
                const pairs = [[12, 18], [8, 12], [15, 20], [10, 15]];
                const [a, b] = pick(pairs);
                const commonFactors = [];
                for (let i = 1; i <= Math.min(a, b); i++) { if (a % i === 0 && b % i === 0) commonFactors.push(i); }
                return { question: `What is the greatest common factor of ${a} and ${b}?`, answer: commonFactors[commonFactors.length - 1], type: "procedural",
                    options: shuffle([commonFactors[commonFactors.length - 1], commonFactors[0], a, b]).slice(0, 4),
                    explanation: `Common factors of ${a} and ${b}: ${commonFactors.join(", ")}. GCF = ${commonFactors[commonFactors.length - 1]}` };
            }
        },
        "Prime and Composite": () => {
            const type = pick(["identify", "classify", "find_primes", "prime_factors"]);
            const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31];
            const composites = [4, 6, 8, 9, 10, 12, 14, 15, 16, 18, 20, 21, 22, 24, 25, 26, 27, 28];
            if (type === "identify") {
                const isPrime = pick([true, false]);
                const n = isPrime ? pick(primes.slice(0, 8)) : pick(composites.slice(0, 10));
                return { question: `Is ${n} prime or composite?`, answer: isPrime ? "Prime" : "Composite", type: "conceptual",
                    options: ["Prime", "Composite"],
                    explanation: isPrime ? `${n} is prime (only divisible by 1 and itself).` : `${n} is composite (has factors other than 1 and ${n}).` };
            } else if (type === "classify") {
                const n = pick([...primes.slice(0, 6), ...composites.slice(0, 6)]);
                const isPrime = primes.includes(n);
                const factors = [];
                for (let i = 1; i <= n; i++) { if (n % i === 0) factors.push(i); }
                return { question: `${n} has factors: ${factors.join(", ")}. Is it prime or composite?`, answer: isPrime ? "Prime" : "Composite", type: "reasoning",
                    options: ["Prime", "Composite"],
                    explanation: isPrime ? `Only 2 factors (1 and ${n}) = Prime` : `More than 2 factors = Composite` };
            } else if (type === "find_primes") {
                const start = pick([1, 10, 20]);
                const end = start + 10;
                const primesInRange = primes.filter(p => p > start && p <= end);
                return { question: `How many prime numbers are there from ${start + 1} to ${end}?`, answer: primesInRange.length, type: "procedural",
                    options: [primesInRange.length, primesInRange.length + 1, primesInRange.length - 1, primesInRange.length + 2].filter(n => n >= 0),
                    explanation: `Primes from ${start + 1} to ${end}: ${primesInRange.join(", ")}. Count: ${primesInRange.length}` };
            } else {
                const n = pick([12, 18, 20, 24, 30]);
                const primeFactorsList = {
                    12: "2 × 2 × 3", 18: "2 × 3 × 3", 20: "2 × 2 × 5", 24: "2 × 2 × 2 × 3", 30: "2 × 3 × 5"
                };
                const smallestPrime = n % 2 === 0 ? 2 : 3;
                return { question: `What is the smallest prime factor of ${n}?`, answer: smallestPrime, type: "procedural",
                    options: [2, 3, 5, 7],
                    explanation: `${n} = ${primeFactorsList[n]}. Smallest prime factor is ${smallestPrime}.` };
            }
        },
        "Area": () => {
            const type = pick(["rectangle", "square", "find_side", "word_problem"]);
            if (type === "rectangle") {
                const length = rand(3, 12);
                const width = rand(2, 8);
                const area = length * width;
                return {
                    question: `Find the area of this rectangle.`,
                    answer: area, type: "procedural",
                    explanation: `Area = length × width = ${length} × ${width} = ${area} square units`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'rectangle', dimensions: { width: length, height: width }, showMeasurements: true } }
                };
            } else if (type === "square") {
                const side = rand(2, 10);
                const area = side * side;
                return {
                    question: `Find the area of this square.`,
                    answer: area, type: "procedural",
                    explanation: `Area = side × side = ${side} × ${side} = ${area} square units`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'square', dimensions: { side }, showMeasurements: true } }
                };
            } else if (type === "find_side") {
                const side = rand(3, 8);
                const area = side * side;
                return {
                    question: `This square has an area of ${area} square units. What is the side length?`,
                    answer: side, type: "reasoning",
                    options: [side, side + 1, side - 1, area / 2],
                    explanation: `If area = side × side = ${area}, think: what number times itself equals ${area}? ${side} × ${side} = ${area}, so the side is ${side}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'square', dimensions: { side }, showMeasurements: false, shaded: true } }
                };
            } else {
                const length = rand(5, 15);
                const width = rand(4, 10);
                const area = length * width;
                const context = pick(["garden", "room", "rug", "poster"]);
                return {
                    question: `A ${context} is ${length} feet long and ${width} feet wide. What is its area?`,
                    answer: area, type: "reasoning",
                    explanation: `Area = ${length} × ${width} = ${area} square feet`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'rectangle', dimensions: { width: length, height: width }, showMeasurements: true } }
                };
            }
        },
        "Bar Graphs": () => {
            const type = pick(["read", "compare", "total", "difference"]);
            const data = {
                labels: ["Mon", "Tue", "Wed", "Thu", "Fri"],
                values: [rand(2, 8), rand(2, 8), rand(2, 8), rand(2, 8), rand(2, 8)]
            };
            const visual = { type: 'chart', mode: 'display', data: { type: 'bar', labels: data.labels, values: data.values } };
            if (type === "read") {
                const idx = rand(0, 4);
                return {
                    question: `This bar graph shows books read each day. How many books on ${data.labels[idx]}?`,
                    answer: data.values[idx], type: "procedural",
                    explanation: `Reading the bar for ${data.labels[idx]}: ${data.values[idx]} books.`,
                    visual
                };
            } else if (type === "compare") {
                const maxVal = Math.max(...data.values);
                const maxIdx = data.values.indexOf(maxVal);
                const correctLabel = data.labels[maxIdx];
                // Pick 3 wrong days as distractors, then shuffle all 4 options
                const wrongLabels = data.labels.filter((_, i) => i !== maxIdx);
                const distractors = shuffle(wrongLabels).slice(0, 3);
                const options = shuffle([correctLabel, ...distractors]);
                return {
                    question: `Look at the bar graph. Which day had the most books read?`,
                    answer: correctLabel, type: "conceptual",
                    options,
                    explanation: `${correctLabel} had the most with ${maxVal}.`,
                    visual
                };
            } else if (type === "total") {
                const total = data.values.reduce((a, b) => a + b, 0);
                return {
                    question: `Look at the bar graph. What is the total number of books read?`,
                    answer: total, type: "procedural",
                    explanation: `Total = ${data.values.join(" + ")} = ${total}`,
                    visual
                };
            } else {
                const maxVal = Math.max(...data.values);
                const minVal = Math.min(...data.values);
                return {
                    question: `Using the bar graph, what is the difference between the highest and lowest days?`,
                    answer: maxVal - minVal, type: "procedural",
                    explanation: `Highest: ${maxVal}, Lowest: ${minVal}. Difference: ${maxVal} - ${minVal} = ${maxVal - minVal}`,
                    visual
                };
            }
        },
        "Line Plots": () => {
            const type = pick(["read", "count", "most_common", "range"]);
            // Generate random line plot data
            const baseVal = rand(1, 5);
            const labels = [baseVal, baseVal + 1, baseVal + 2, baseVal + 3];
            const counts = [rand(1, 4), rand(2, 5), rand(1, 4), rand(1, 3)];
            const values = [];
            labels.forEach((label, i) => { for (let j = 0; j < counts[i]; j++) values.push(label); });
            const total = counts.reduce((a, b) => a + b, 0);
            const maxCount = Math.max(...counts);
            const mostCommonIdx = counts.indexOf(maxCount);
            const mostCommonVal = labels[mostCommonIdx];
            const topics = pick([['Shoe Sizes', 'shoe size'], ['Books Read', 'books'], ['Goals Scored', 'goals'], ['Pets Owned', 'pets']]);
            const linePlotData = { type: 'line_plot', labels, counts, title: topics[0] };
            const visual = { type: 'chart', mode: 'display', data: linePlotData };
            if (type === "read") {
                const targetIdx = rand(0, 3);
                const target = labels[targetIdx];
                const count = counts[targetIdx];
                return { question: `How many students have ${topics[1]} ${target}?`, answer: count, type: "procedural",
                    explanation: `Count the X's above ${target}: ${count} students.`, visual };
            } else if (type === "count") {
                return { question: `How many students are shown in this line plot?`, answer: total, type: "procedural",
                    explanation: `Total X's: ${counts.join(' + ')} = ${total} students.`, visual };
            } else if (type === "most_common") {
                return { question: `What is the most common ${topics[1]}?`, answer: mostCommonVal, type: "conceptual",
                    options: labels,
                    explanation: `${mostCommonVal} has the most X's (${maxCount}), so it's most common.`, visual };
            } else {
                const min = Math.min(...labels);
                const max = Math.max(...labels);
                return { question: `What is the range of ${topics[1]}?`, answer: max - min, type: "procedural",
                    explanation: `Range = largest - smallest = ${max} - ${min} = ${max - min}`, visual };
            }
        },
        "Line Symmetry": () => {
            const type = pick(["identify", "count_lines", "draw", "real_world"]);
            const symmetricShapes = [
                { name: "square", lines: 4 },
                { name: "rectangle", lines: 2 },
                { name: "equilateral triangle", lines: 3 },
                { name: "circle", lines: "infinite" },
                { name: "regular hexagon", lines: 6 },
                { name: "isosceles triangle", lines: 1 }
            ];
            const asymmetricShapes = ["scalene triangle", "parallelogram", "trapezoid"];
            if (type === "identify") {
                const isSymmetric = pick([true, false]);
                const shape = isSymmetric ? pick(symmetricShapes).name : pick(asymmetricShapes);
                return { question: `Does a ${shape} have line symmetry?`, answer: isSymmetric ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isSymmetric ? `Yes! A ${shape} can be folded so both halves match.` : `No. A ${shape} cannot be folded into matching halves.` };
            } else if (type === "count_lines") {
                const shape = pick(symmetricShapes.filter(s => typeof s.lines === "number"));
                return { question: `How many lines of symmetry does a ${shape.name} have?`, answer: shape.lines, type: "conceptual",
                    options: [shape.lines, shape.lines + 1, shape.lines - 1, 0].filter(n => n >= 0),
                    explanation: `A ${shape.name} has ${shape.lines} line(s) of symmetry.` };
            } else if (type === "draw") {
                const options = ["vertical", "horizontal", "diagonal", "no line"];
                const shape = pick(["heart", "butterfly", "letter A", "arrow pointing up"]);
                return { question: `Where is the line of symmetry for a ${shape}?`, answer: "vertical", type: "conceptual",
                    options: options,
                    explanation: `A ${shape} has a vertical line of symmetry (down the middle).` };
            } else {
                const items = [
                    { name: "butterfly", symmetric: true },
                    { name: "human face", symmetric: true },
                    { name: "leaf", symmetric: true },
                    { name: "scissors", symmetric: false },
                    { name: "starfish", symmetric: true }
                ];
                const item = pick(items);
                return { question: `Does a ${item.name} have line symmetry in nature?`, answer: item.symmetric ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: item.symmetric ? `Yes! A ${item.name} is approximately symmetric.` : `No. A ${item.name} is not symmetric.` };
            }
        },
        "Types of Angles": () => {
            const type = pick(["identify", "measure", "compare", "classify"]);
            if (type === "identify") {
                const angles = [
                    { name: "acute", range: "less than 90°", example: 45 },
                    { name: "right", range: "exactly 90°", example: 90 },
                    { name: "obtuse", range: "between 90° and 180°", example: 120 }
                ];
                const angle = pick(angles);
                return {
                    question: `This shape shows an angle. What type is it?`,
                    answer: angle.name, type: "conceptual",
                    options: angles.map(a => a.name),
                    explanation: `${angle.example}° is ${angle.range}, so it's ${angle.name}.`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'triangle', dimensions: { base: 80, height: 60, isRight: angle.name === 'right' }, showAngles: true } }
                };
            } else if (type === "measure") {
                const angles = [30, 45, 60, 90, 120, 135, 150];
                const angle = pick(angles);
                const angleType = angle < 90 ? "acute" : angle === 90 ? "right" : "obtuse";
                return { question: `What type of angle measures ${angle}°?`, answer: angleType, type: "conceptual",
                    options: ["acute", "right", "obtuse", "straight"],
                    explanation: `${angle}° is ${angleType} because it's ${angle < 90 ? "less than" : angle === 90 ? "exactly" : "greater than"} 90°.` };
            } else if (type === "compare") {
                const angle1 = rand(20, 80);
                const angle2 = rand(100, 160);
                return { question: `Which is larger: a ${angle1}° angle or a ${angle2}° angle?`, answer: `${angle2}°`, type: "conceptual",
                    options: [`${angle1}°`, `${angle2}°`],
                    explanation: `${angle2}° > ${angle1}°. The obtuse angle is larger than the acute angle.` };
            } else {
                const cornerType = pick(["book", "door", "thin pizza slice", "clock at 3:00"]);
                const isRight = cornerType === "book" || cornerType === "door" || cornerType === "clock at 3:00";
                return { question: `The corner of a ${cornerType} is most likely what type of angle?`, answer: isRight ? "right" : "acute", type: "reasoning",
                    options: ["acute", "right", "obtuse"],
                    explanation: isRight ? `A ${cornerType} typically has a right angle (90°).` : `A ${cornerType} typically has an acute angle (less than 90°).` };
            }
        },
        "Types of Lines": () => {
            const type = pick(["identify", "parallel", "perpendicular", "intersecting", "real_world"]);
            if (type === "identify") {
                const lineTypes = [
                    { name: "parallel", desc: "lines that never meet" },
                    { name: "perpendicular", desc: "lines that meet at a 90° angle" },
                    { name: "intersecting", desc: "lines that cross at any angle" }
                ];
                const line = pick(lineTypes);
                return { question: `Lines that ${line.desc.replace("lines that ", "")} are called...?`, answer: line.name, type: "conceptual",
                    options: lineTypes.map(l => l.name),
                    explanation: `${line.name.charAt(0).toUpperCase() + line.name.slice(1)} lines: ${line.desc}.` };
            } else if (type === "parallel") {
                const examples = [
                    { item: "railroad tracks", isParallel: true },
                    { item: "opposite sides of a rectangle", isParallel: true },
                    { item: "the letter X", isParallel: false },
                    { item: "rungs on a ladder", isParallel: true }
                ];
                const ex = pick(examples);
                return { question: `Are the lines in "${ex.item}" parallel?`, answer: ex.isParallel ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: ex.isParallel ? `Yes! ${ex.item} shows parallel lines (never meet).` : `No. ${ex.item} shows lines that cross.` };
            } else if (type === "perpendicular") {
                const examples = [
                    { item: "corner of a paper", isPerpendicular: true },
                    { item: "plus sign (+)", isPerpendicular: true },
                    { item: "letter V", isPerpendicular: false },
                    { item: "floor and wall meeting", isPerpendicular: true }
                ];
                const ex = pick(examples);
                return { question: `Do the lines in "${ex.item}" form perpendicular lines?`, answer: ex.isPerpendicular ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: ex.isPerpendicular ? `Yes! They meet at a 90° angle.` : `No. They don't meet at a right angle.` };
            } else if (type === "intersecting") {
                return { question: `When two lines cross at a point, they are called...?`, answer: "intersecting", type: "conceptual",
                    options: ["parallel", "perpendicular", "intersecting", "skew"],
                    explanation: `Lines that cross are intersecting lines. They share one point.` };
            } else {
                const items = [
                    { name: "opposite edges of a door", type: "parallel" },
                    { name: "hands of a clock at 3:00", type: "perpendicular" },
                    { name: "scissors blades", type: "intersecting" },
                    { name: "lines on notebook paper", type: "parallel" }
                ];
                const item = pick(items);
                return { question: `The ${item.name} are an example of what type of lines?`, answer: item.type, type: "reasoning",
                    options: ["parallel", "perpendicular", "intersecting"],
                    explanation: `${item.name} are ${item.type} lines.` };
            }
        },
        "Mass and Capacity": () => {
            const type = pick(["compare_mass", "compare_capacity", "units", "estimate", "convert"]);
            if (type === "compare_mass") {
                const items = [
                    { name: "feather", mass: "light" },
                    { name: "brick", mass: "heavy" },
                    { name: "apple", mass: "medium" },
                    { name: "elephant", mass: "very heavy" },
                    { name: "paperclip", mass: "light" }
                ];
                const item1 = pick(items);
                let item2 = pick(items);
                while (item2.name === item1.name) item2 = pick(items);
                const massOrder = { "light": 1, "medium": 2, "heavy": 3, "very heavy": 4 };
                const heavier = massOrder[item1.mass] > massOrder[item2.mass] ? item1.name : item2.name;
                return { question: `Which is heavier: a ${item1.name} or a ${item2.name}?`, answer: heavier, type: "conceptual",
                    options: [item1.name, item2.name, "Same"],
                    explanation: `A ${heavier} is heavier.` };
            } else if (type === "compare_capacity") {
                const containers = [
                    { name: "teaspoon", capacity: 1 },
                    { name: "cup", capacity: 2 },
                    { name: "bottle", capacity: 3 },
                    { name: "bucket", capacity: 4 },
                    { name: "bathtub", capacity: 5 }
                ];
                const c1 = pick(containers);
                let c2 = pick(containers);
                while (c2.name === c1.name) c2 = pick(containers);
                const more = c1.capacity > c2.capacity ? c1.name : c2.name;
                return { question: `Which holds more: a ${c1.name} or a ${c2.name}?`, answer: more, type: "conceptual",
                    options: [c1.name, c2.name, "Same"],
                    explanation: `A ${more} holds more liquid.` };
            } else if (type === "units") {
                const units = [
                    { unit: "gram", measures: "mass", abbrev: "g" },
                    { unit: "kilogram", measures: "mass", abbrev: "kg" },
                    { unit: "liter", measures: "capacity", abbrev: "L" },
                    { unit: "milliliter", measures: "capacity", abbrev: "mL" }
                ];
                const u = pick(units);
                return { question: `A ${u.unit} (${u.abbrev}) measures...?`, answer: u.measures, type: "conceptual",
                    options: ["mass", "capacity", "length", "time"],
                    explanation: `${u.unit}s measure ${u.measures}.` };
            } else if (type === "estimate") {
                const estimates = [
                    { item: "paperclip", value: "1 gram", unit: "mass" },
                    { item: "textbook", value: "1 kilogram", unit: "mass" },
                    { item: "water bottle", value: "500 milliliters", unit: "capacity" },
                    { item: "fish tank", value: "40 liters", unit: "capacity" }
                ];
                const est = pick(estimates);
                return { question: `About how much ${est.unit} does a ${est.item} have?`, answer: est.value, type: "reasoning",
                    options: ["1 gram", "1 kilogram", "500 milliliters", "40 liters"],
                    explanation: `A ${est.item} is about ${est.value}.` };
            } else {
                const kg = rand(1, 5);
                const g = kg * 1000;
                return { question: `${kg} kilogram${kg > 1 ? "s" : ""} = ? grams`, answer: g, type: "procedural",
                    explanation: `1 kg = 1000 g, so ${kg} kg = ${kg} × 1000 = ${g} grams.` };
            }
        },
        "Elapsed Time": () => {
            const type = pick(["forward_hours", "forward_minutes", "backward", "word_problem", "duration"]);
            if (type === "forward_hours") {
                const startHour = rand(1, 10);
                const elapsed = rand(1, 3);
                const endHour = startHour + elapsed;
                return { question: `It is ${startHour}:00. What time will it be in ${elapsed} hour${elapsed > 1 ? "s" : ""}?`, answer: `${endHour}:00`, type: "procedural",
                    options: [`${endHour}:00`, `${endHour - 1}:00`, `${startHour}:${elapsed}0`, `${endHour + 1}:00`],
                    explanation: `${startHour}:00 + ${elapsed} hours = ${endHour}:00` };
            } else if (type === "forward_minutes") {
                const startHour = rand(1, 11);
                const startMin = pick([0, 15, 30]);
                const elapsed = pick([15, 30, 45]);
                const totalMin = startMin + elapsed;
                const endHour = startHour + Math.floor(totalMin / 60);
                const endMin = totalMin % 60;
                const correctTime = `${endHour}:${endMin.toString().padStart(2, '0')}`;
                const wrongMin = ((endMin + 15) % 60).toString().padStart(2, '0');
                const wrongHour = endHour > 1 ? endHour - 1 : endHour + 2;
                return { question: `It is ${startHour}:${startMin.toString().padStart(2, '0')}. What time will it be in ${elapsed} minutes?`,
                    answer: correctTime, type: "procedural",
                    options: [correctTime, `${wrongHour}:${endMin.toString().padStart(2, '0')}`, `${endHour}:${wrongMin}`, `${endHour + 1}:${endMin.toString().padStart(2, '0')}`],
                    explanation: `${startHour}:${startMin.toString().padStart(2, '0')} + ${elapsed} min = ${correctTime}` };
            } else if (type === "backward") {
                const endHour = rand(3, 12);
                const elapsed = rand(1, 2);
                const startHour = endHour - elapsed;
                return { question: `It is ${endHour}:00 now. What time was it ${elapsed} hour${elapsed > 1 ? "s" : ""} ago?`, answer: `${startHour}:00`, type: "procedural",
                    options: [`${startHour}:00`, `${startHour - 1}:00`, `${startHour + 1}:00`, `${endHour + elapsed}:00`],
                    explanation: `${endHour}:00 - ${elapsed} hours = ${startHour}:00` };
            } else if (type === "word_problem") {
                const startHour = rand(8, 11);
                const duration = rand(1, 3);
                const endHour = startHour + duration;
                const activity = pick(["movie", "soccer game", "class", "car trip"]);
                return { question: `The ${activity} starts at ${startHour}:00 and lasts ${duration} hour${duration > 1 ? "s" : ""}. What time does it end?`,
                    answer: `${endHour}:00`, type: "reasoning",
                    options: [`${endHour}:00`, `${endHour - 1}:00`, `${endHour + 1}:00`, `${startHour}:${duration}0`],
                    explanation: `${startHour}:00 + ${duration} hours = ${endHour}:00` };
            } else {
                const startHour = rand(9, 12);
                const endHour = startHour + rand(1, 3);
                const duration = endHour - startHour;
                return { question: `School starts at ${startHour}:00 and ends at ${endHour}:00. How long is school?`, answer: `${duration} hours`, type: "procedural",
                    options: [`${duration} hours`, `${duration + 1} hours`, `${duration - 1} hours`, `${endHour} hours`],
                    explanation: `From ${startHour}:00 to ${endHour}:00 is ${duration} hours.` };
            }
        },
        "Multiplication Properties": () => {
            const type = pick(["commutative", "associative", "distributive", "identity", "zero"]);
            if (type === "commutative") {
                const a = rand(2, 9), b = rand(2, 9);
                return { question: `If ${a} × ${b} = ${a * b}, what is ${b} × ${a}?`, answer: a * b, type: "conceptual",
                    explanation: `Commutative Property: ${a} × ${b} = ${b} × ${a} = ${a * b}. Order doesn't matter!` };
            } else if (type === "associative") {
                const a = rand(2, 5), b = rand(2, 5), c = rand(2, 5);
                return { question: `(${a} × ${b}) × ${c} = ${a} × (${b} × ${c}) = ?`, answer: a * b * c, type: "conceptual",
                    explanation: `Associative Property: (${a} × ${b}) × ${c} = ${a * b} × ${c} = ${a * b * c}. Grouping doesn't matter!` };
            } else if (type === "distributive") {
                const a = rand(2, 5), b = rand(3, 7), c = rand(2, 5);
                const sum = b + c;
                return { question: `Use distributive property: ${a} × ${sum} = ${a} × ${b} + ${a} × ${c} = ?`, answer: a * sum, type: "procedural",
                    explanation: `${a} × ${sum} = ${a} × ${b} + ${a} × ${c} = ${a * b} + ${a * c} = ${a * sum}` };
            } else if (type === "identity") {
                const n = rand(5, 50);
                return { question: `${n} × 1 = ?`, answer: n, type: "conceptual",
                    explanation: `Identity Property: Any number × 1 = itself. ${n} × 1 = ${n}` };
            } else {
                const n = rand(5, 100);
                return { question: `${n} × 0 = ?`, answer: 0, type: "conceptual",
                    explanation: `Zero Property: Any number × 0 = 0. ${n} × 0 = 0` };
            }
        }
    },

    // TIER 3: Rational Numbers (5-7)
    3: {
        Fractions: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'lcd': 'lcd_find',
                'add_different_denom': 'add_diff_denom',
                'subtract_different_denom': 'subtract_diff_denom',
                'multiply': 'multiply',
                'divide': 'divide',
                'mixed_add': 'mixed_add',
                'mixed_subtract': 'mixed_subtract'
            };

            // Get unlocked question types based on completed sub-skills
            const completedSubSkills = state.completedSubSkills['3_Fractions'] || [];
            let availableTypes = completedSubSkills.length > 0
                ? completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean)
                : ["add_diff_denom", "subtract_diff_denom", "multiply", "divide", "mixed_add", "mixed_subtract", "lcd_find"]; // All if none tracked

            // Ensure at least one type is available
            if (availableTypes.length === 0) {
                availableTypes = ["lcd_find"]; // Default to easiest
            }

            const type = pick(availableTypes);

            // Helper to find LCD
            const findLCD = (d1, d2) => {
                const max = d1 * d2;
                for (let i = Math.max(d1, d2); i <= max; i++) {
                    if (i % d1 === 0 && i % d2 === 0) return i;
                }
                return max;
            };

            if (type === "add_diff_denom") {
                // Adding fractions with different denominators
                const denoms = [[2, 3], [2, 4], [3, 4], [2, 5], [3, 6], [4, 6], [2, 6], [3, 5]];
                const [d1, d2] = pick(denoms);
                const n1 = rand(1, d1 - 1), n2 = rand(1, d2 - 1);
                const lcd = findLCD(d1, d2);
                const newN1 = n1 * (lcd / d1), newN2 = n2 * (lcd / d2);
                const sumN = newN1 + newN2;
                const [simpN, simpD] = simplifyFrac(sumN, lcd);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                const addedDenoms = `${n1 + n2}/${d1 + d2}`;
                const unsimplified = `${sumN}/${lcd}`;
                const offBy = simpD === 1 ? `${simpN + 1}` : `${simpN + 1}/${simpD}`;
                return { question: `What is ${n1}/${d1} + ${n2}/${d2}?`, answer: answer, type: "procedural",
                    options: [answer, addedDenoms, unsimplified !== answer ? unsimplified : offBy, offBy].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                    explanation: `Find LCD of ${d1} and ${d2} = ${lcd}. Convert: ${n1}/${d1} = ${newN1}/${lcd}, ${n2}/${d2} = ${newN2}/${lcd}. Add: ${newN1}/${lcd} + ${newN2}/${lcd} = ${sumN}/${lcd}${simpD !== lcd ? ` = ${answer}` : ""}` };
            } else if (type === "subtract_diff_denom") {
                // Subtracting fractions with different denominators
                const denoms = [[2, 3], [2, 4], [3, 4], [2, 5], [3, 6], [4, 6]];
                const [d1, d2] = pick(denoms);
                const lcd = findLCD(d1, d2);
                // Ensure first fraction is larger
                let n1 = rand(Math.ceil(d1 / 2), d1 - 1), n2 = rand(1, Math.floor(d2 / 2));
                const newN1 = n1 * (lcd / d1), newN2 = n2 * (lcd / d2);
                if (newN1 <= newN2) { n1 = d1 - 1; }
                const finalN1 = n1 * (lcd / d1), finalN2 = n2 * (lcd / d2);
                const diffN = finalN1 - finalN2;
                const [simpN, simpD] = simplifyFrac(diffN, lcd);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                const subDenoms = `${Math.abs(n1 - n2)}/${Math.abs(d1 - d2) || d1}`;
                const unsimplified = `${diffN}/${lcd}`;
                const offBy = simpD === 1 ? `${simpN + 1}` : `${simpN + 1}/${simpD}`;
                return { question: `What is ${n1}/${d1} - ${n2}/${d2}?`, answer: answer, type: "procedural",
                    options: [answer, subDenoms, unsimplified !== answer ? unsimplified : offBy, offBy].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                    explanation: `Find LCD of ${d1} and ${d2} = ${lcd}. Convert: ${n1}/${d1} = ${finalN1}/${lcd}, ${n2}/${d2} = ${finalN2}/${lcd}. Subtract: ${finalN1}/${lcd} - ${finalN2}/${lcd} = ${diffN}/${lcd}${simpD !== lcd ? ` = ${answer}` : ""}` };
            } else if (type === "multiply") {
                // Multiplying fractions (different fractions)
                const n1 = rand(1, 4), d1 = rand(n1 + 1, 6);
                const n2 = rand(1, 4), d2 = rand(n2 + 1, 6);
                const prodN = n1 * n2, prodD = d1 * d2;
                const [simpN, simpD] = simplifyFrac(prodN, prodD);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                const addedInstead = `${n1 + n2}/${d1 + d2}`;
                const unsimplified = `${prodN}/${prodD}`;
                const crossMult = `${n1 * d2}/${d1 * n2}`;
                return { question: `What is ${n1}/${d1} × ${n2}/${d2}?`, answer: answer, type: "procedural",
                    options: [answer, addedInstead, unsimplified !== answer ? unsimplified : crossMult, crossMult !== answer ? crossMult : `${prodN + 1}/${prodD}`].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                    explanation: `Multiply numerators: ${n1} × ${n2} = ${prodN}. Multiply denominators: ${d1} × ${d2} = ${prodD}. Result: ${prodN}/${prodD}${simpN !== prodN || simpD !== prodD ? ` = ${answer} (simplified)` : ""}` };
            } else if (type === "divide") {
                // Dividing fractions (keep, change, flip)
                const n1 = rand(1, 4), d1 = rand(2, 5);
                const n2 = rand(1, 3), d2 = rand(2, 5);
                const prodN = n1 * d2, prodD = d1 * n2;
                const [simpN, simpD] = simplifyFrac(prodN, prodD);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                const noFlip = `${n1 * n2}/${d1 * d2}`;
                const [invN, invD] = simplifyFrac(prodD, prodN);
                const inverted = invD === 1 ? `${invN}` : `${invN}/${invD}`;
                const unsimplified = `${prodN}/${prodD}`;
                return { question: `What is ${n1}/${d1} ÷ ${n2}/${d2}?`, answer: answer, type: "procedural",
                    options: [answer, noFlip, inverted !== answer ? inverted : unsimplified, unsimplified !== answer ? unsimplified : `${simpN + 1}/${simpD}`].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                    explanation: `Keep ${n1}/${d1}, change ÷ to ×, flip ${n2}/${d2} to ${d2}/${n2}. Then multiply: ${n1}/${d1} × ${d2}/${n2} = ${prodN}/${prodD}${simpN !== prodN || simpD !== prodD ? ` = ${answer}` : ""}` };
            } else if (type === "mixed_add") {
                // Adding mixed numbers
                const w1 = rand(1, 3), w2 = rand(1, 3);
                const d = pick([2, 3, 4, 5]);
                const n1 = rand(1, d - 1), n2 = rand(1, d - 1);
                const totalFrac = n1 + n2;
                const extraWhole = Math.floor(totalFrac / d);
                const remainFrac = totalFrac % d;
                const totalWhole = w1 + w2 + extraWhole;
                const answer = remainFrac === 0 ? `${totalWhole}` : `${totalWhole} ${remainFrac}/${d}`;
                const noRegroup = `${w1 + w2} ${totalFrac}/${d}`;
                const offByOne = remainFrac === 0 ? `${totalWhole + 1}` : `${totalWhole + 1} ${remainFrac}/${d}`;
                const offByOneDown = remainFrac === 0 ? `${totalWhole - 1}` : `${totalWhole - 1} ${remainFrac}/${d}`;
                return { question: `What is ${w1} ${n1}/${d} + ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                    options: [answer, noRegroup, offByOne, offByOneDown].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                    explanation: `Add whole numbers: ${w1} + ${w2} = ${w1 + w2}. Add fractions: ${n1}/${d} + ${n2}/${d} = ${totalFrac}/${d}${extraWhole > 0 ? ` = ${extraWhole} ${remainFrac}/${d}` : ""}. Total: ${answer}` };
            } else if (type === "mixed_subtract") {
                // Subtracting mixed numbers
                const w1 = rand(3, 5), w2 = rand(1, w1 - 1);
                const d = pick([2, 3, 4, 5]);
                const n1 = rand(1, d - 1);
                let n2 = rand(1, d - 1);
                // Handle borrowing case sometimes
                if (n2 > n1 && pick([true, false])) {
                    // Need to borrow
                    const borrowed = d + n1 - n2;
                    const newW1 = w1 - 1;
                    const resultW = newW1 - w2;
                    const answer = borrowed === 0 ? `${resultW}` : `${resultW} ${borrowed}/${d}`;
                    const noBorrow = `${w1 - w2} ${Math.abs(n1 - n2)}/${d}`;
                    const offByOne = borrowed === 0 ? `${resultW + 1}` : `${resultW + 1} ${borrowed}/${d}`;
                    const offByOneDown = borrowed === 0 ? `${resultW - 1}` : (resultW > 1 ? `${resultW - 1} ${borrowed}/${d}` : `${borrowed + d}/${d}`);
                    return { question: `What is ${w1} ${n1}/${d} - ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                        options: [answer, noBorrow, offByOne, offByOneDown].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                        explanation: `Since ${n1}/${d} < ${n2}/${d}, borrow 1 from ${w1}: ${w1} ${n1}/${d} = ${newW1} ${d + n1}/${d}. Then subtract: ${newW1} - ${w2} = ${resultW}, ${d + n1}/${d} - ${n2}/${d} = ${borrowed}/${d}. Answer: ${answer}` };
                } else {
                    if (n2 > n1) n2 = n1 - 1 > 0 ? n1 - 1 : 1;
                    const resultW = w1 - w2;
                    const resultN = n1 - n2;
                    const answer = resultN === 0 ? `${resultW}` : `${resultW} ${resultN}/${d}`;
                    const offByOne = resultN === 0 ? `${resultW + 1}` : `${resultW + 1} ${resultN}/${d}`;
                    const offByOneDown = resultN === 0 ? `${resultW - 1}` : `${resultW - 1} ${resultN}/${d}`;
                    const wrongFrac = resultN === 0 ? `${resultW} 1/${d}` : `${resultW} ${Math.min(resultN + 1, d - 1)}/${d}`;
                    return { question: `What is ${w1} ${n1}/${d} - ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                        options: [answer, offByOne, offByOneDown, wrongFrac].filter((v, i, a) => a.indexOf(v) === i).slice(0, 4),
                        explanation: `Subtract whole numbers: ${w1} - ${w2} = ${resultW}. Subtract fractions: ${n1}/${d} - ${n2}/${d} = ${resultN}/${d}. Answer: ${answer}` };
                }
            } else {
                // Find the LCD
                const denoms = [[2, 3, 6], [2, 4, 4], [3, 4, 12], [2, 5, 10], [3, 6, 6], [4, 6, 12], [2, 8, 8], [3, 9, 9]];
                const [d1, d2, lcd] = pick(denoms);
                return { question: `What is the LCD (Least Common Denominator) of ${d1} and ${d2}?`, answer: lcd, type: "procedural",
                    options: [lcd, d1 * d2, Math.max(d1, d2), lcd + d1],
                    explanation: `The LCD is the smallest number that both ${d1} and ${d2} divide into evenly. ${lcd} ÷ ${d1} = ${lcd/d1} ✓, ${lcd} ÷ ${d2} = ${lcd/d2} ✓. LCD = ${lcd}` };
            }
        },
        Decimals: () => {
            // Map sub-skill IDs to operations
            const subSkillToOp = {
                'understanding': 'compare',
                'add': '+',
                'subtract': '-',
                'multiply': '×'
            };

            // Get unlocked operations based on completed sub-skills
            const completedSubSkills = state.completedSubSkills['3_Decimals'] || [];
            let availableOps = completedSubSkills.length > 0
                ? completedSubSkills.map(id => subSkillToOp[id]).filter(Boolean)
                : ["+", "-", "×"]; // All if none tracked

            // Filter to only actual operations
            availableOps = availableOps.filter(op => ['+', '-', '×', 'compare'].includes(op));
            if (availableOps.length === 0) availableOps = ['compare'];

            const op = pick(availableOps);
            const a = (rand(10, 99) / 10).toFixed(1), b = (rand(10, 99) / 10).toFixed(1);

            if (op === 'compare') {
                const bigger = parseFloat(a) > parseFloat(b) ? a : b;
                return { question: `Which is greater: ${a} or ${b}?`, answer: bigger, type: "procedural",
                    options: [a, b, "They're equal"].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Compare place by place: ${a} vs ${b}. ${bigger} is greater.` };
            }

            let answer;
            if (op === "+") answer = (parseFloat(a) + parseFloat(b)).toFixed(2);
            else if (op === "-") { const big = Math.max(a, b), sm = Math.min(a, b); answer = (big - sm).toFixed(2); return { question: `What is ${big} - ${sm}?`, answer: parseFloat(answer), type: "procedural", explanation: `${big} - ${sm} = ${answer}` }; }
            else answer = (parseFloat(a) * parseFloat(b)).toFixed(2);
            return { question: `What is ${a} ${op} ${b}?`, answer: parseFloat(answer), type: "procedural",
                explanation: `${a} ${op} ${b} = ${answer}` };
        },
        Integers: () => {
            // Map sub-skill IDs to operations
            const subSkillToOp = {
                'understanding': 'compare',
                'add': '+',
                'subtract': '-',
                'multiply': '×'
            };

            // Get unlocked operations based on completed sub-skills
            const completedSubSkills = state.completedSubSkills['3_Integers'] || [];
            let availableOps = completedSubSkills.length > 0
                ? completedSubSkills.map(id => subSkillToOp[id]).filter(Boolean)
                : ["+", "-", "×"]; // All if none tracked

            // Filter to actual operations
            availableOps = availableOps.filter(op => ['+', '-', '×', 'compare'].includes(op));
            if (availableOps.length === 0) availableOps = ['compare'];

            const op = pick(availableOps);
            const a = rand(-15, 15), b = rand(-15, 15);

            if (op === 'compare') {
                const bigger = a > b ? a : b;
                const aStr = a < 0 ? `(${a})` : a;
                const bStr = b < 0 ? `(${b})` : b;
                return { question: `Which is greater: ${aStr} or ${bStr}?`, answer: bigger, type: "procedural",
                    options: [a, b, "They're equal"].filter((v,i,arr) => arr.indexOf(v) === i),
                    explanation: `On the number line, ${bigger} is further right, so it's greater.` };
            }

            let answer;
            if (op === "+") answer = a + b;
            else if (op === "-") answer = a - b;
            else answer = a * b;
            const aStr = a < 0 ? `(${a})` : a;
            const bStr = b < 0 ? `(${b})` : b;
            return { question: `What is ${aStr} ${op} ${bStr}?`, answer, type: "procedural",
                explanation: `${aStr} ${op} ${bStr} = ${answer}` };
        },
        Percents: () => {
            const pct = pick([10, 20, 25, 50, 75]);
            const base = pick([20, 40, 50, 80, 100, 200]);
            const answer = (pct / 100) * base;
            return { question: `What is ${pct}% of ${base}?`, answer, type: "procedural",
                explanation: `${pct}% = ${pct}/100 = ${pct/100}. Multiply: ${pct/100} × ${base} = ${answer}` };
        },
        Ratios: () => {
            const a = rand(2, 5), b = rand(2, 5);
            const mult = rand(2, 6);
            const total = a * mult;
            return { question: `Ratio of cats to dogs is ${a}:${b}. If there are ${total} cats, how many dogs?`, answer: b * mult, type: "reasoning",
                explanation: `${a} parts = ${total}, so 1 part = ${mult}. Dogs = ${b} × ${mult} = ${b * mult}` };
        },
        Statistics: () => {
            const n = rand(4, 6);
            const nums = Array.from({length: n}, () => rand(2, 15));
            const sum = nums.reduce((a, b) => a + b, 0);
            const mean = sum / n;
            return { question: `What is the mean of: ${nums.join(", ")}?`, answer: parseFloat(mean.toFixed(2)), type: "procedural",
                explanation: `Sum = ${sum}, count = ${n}. Mean = ${sum}/${n} = ${mean.toFixed(2)}` };
        },
        "Data Collection": () => {
            const type = pick(["tally", "read", "organize"]);
            if (type === "tally") {
                const count = rand(3, 12);
                const tallyStr = "||||".repeat(Math.floor(count / 5)) + "|".repeat(count % 5);
                return { question: `How many does this tally show? ${tallyStr.replace(/\|\|\|\|\|/g, '||||̸ ')}`, answer: count, type: "procedural",
                    explanation: `Each group of 5 is ||||̸. Count: ${Math.floor(count/5)} groups of 5 + ${count % 5} = ${count}` };
            } else if (type === "read") {
                const categories = ["Red", "Blue", "Green"];
                const values = [rand(2, 8), rand(2, 8), rand(2, 8)];
                const maxIdx = values.indexOf(Math.max(...values));
                return { question: `Bar graph shows: Red=${values[0]}, Blue=${values[1]}, Green=${values[2]}. Which has the most?`,
                    answer: categories[maxIdx], type: "conceptual",
                    options: categories.concat(["They're equal"]),
                    explanation: `${categories[maxIdx]} has ${values[maxIdx]}, which is the highest.` };
            } else {
                const data = [rand(5, 10), rand(3, 8), rand(7, 12), rand(4, 9)];
                const total = data.reduce((a, b) => a + b, 0);
                return { question: `Survey results: Mon=${data[0]}, Tue=${data[1]}, Wed=${data[2]}, Thu=${data[3]}. Total responses?`,
                    answer: total, type: "procedural",
                    explanation: `${data.join(" + ")} = ${total}` };
            }
        },
        "Mean Median Mode": () => {
            const type = pick(["median", "mode", "range"]);
            if (type === "median") {
                const n = 5;
                const nums = Array.from({length: n}, () => rand(2, 20)).sort((a, b) => a - b);
                const median = nums[Math.floor(n / 2)];
                return { question: `Find the median: ${nums.join(", ")}`, answer: median, type: "procedural",
                    explanation: `Ordered: ${nums.join(", ")}. Middle value = ${median}` };
            } else if (type === "mode") {
                const base = rand(2, 10);
                const nums = [base, base, base, rand(1, 15), rand(1, 15)].sort((a, b) => a - b);
                return { question: `Find the mode: ${nums.join(", ")}`, answer: base, type: "conceptual",
                    explanation: `${base} appears most often (3 times). Mode = ${base}` };
            } else {
                const nums = Array.from({length: 5}, () => rand(5, 25)).sort((a, b) => a - b);
                const range = nums[4] - nums[0];
                return { question: `Find the range: ${nums.join(", ")}`, answer: range, type: "procedural",
                    explanation: `Range = max - min = ${nums[4]} - ${nums[0]} = ${range}` };
            }
        },
        "Unit Conversion": () => {
            const type = pick(["length", "weight", "volume"]);
            if (type === "length") {
                const feet = rand(2, 10);
                const inches = feet * 12;
                return { question: `Convert ${feet} feet to inches.`, answer: inches, type: "procedural",
                    explanation: `1 foot = 12 inches. ${feet} × 12 = ${inches} inches` };
            } else if (type === "weight") {
                const pounds = rand(2, 10);
                const ounces = pounds * 16;
                return { question: `Convert ${pounds} pounds to ounces.`, answer: ounces, type: "procedural",
                    explanation: `1 pound = 16 ounces. ${pounds} × 16 = ${ounces} ounces` };
            } else {
                const gallons = rand(1, 5);
                const quarts = gallons * 4;
                return { question: `Convert ${gallons} gallon${gallons > 1 ? 's' : ''} to quarts.`, answer: quarts, type: "procedural",
                    explanation: `1 gallon = 4 quarts. ${gallons} × 4 = ${quarts} quarts` };
            }
        },
        "Basic Graphing": () => {
            const type = pick(["plot", "quadrant", "distance"]);
            if (type === "plot") {
                const x = rand(-5, 5);
                const y = rand(-5, 5);
                const quadrant = x > 0 && y > 0 ? "I" : x < 0 && y > 0 ? "II" : x < 0 && y < 0 ? "III" : x > 0 && y < 0 ? "IV" : "axis";
                return { question: `Point (${x}, ${y}) is in which quadrant?`, answer: quadrant === "axis" ? "on an axis" : `Quadrant ${quadrant}`, type: "conceptual",
                    options: ["Quadrant I", "Quadrant II", "Quadrant III", "Quadrant IV"],
                    explanation: `(${x}, ${y}): x is ${x > 0 ? "positive" : x < 0 ? "negative" : "zero"}, y is ${y > 0 ? "positive" : y < 0 ? "negative" : "zero"}. That's ${quadrant === "axis" ? "on an axis" : "Quadrant " + quadrant}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-6, 6], yRange: [-6, 6], gridStep: 1, points: [{ x, y, label: `(${x},${y})` }] } } };
            } else if (type === "quadrant") {
                const quadrants = [
                    { q: "I", desc: "x positive, y positive", ex: "(3, 2)", x: 3, y: 2 },
                    { q: "II", desc: "x negative, y positive", ex: "(-3, 2)", x: -3, y: 2 },
                    { q: "III", desc: "x negative, y negative", ex: "(-3, -2)", x: -3, y: -2 },
                    { q: "IV", desc: "x positive, y negative", ex: "(3, -2)", x: 3, y: -2 }
                ];
                const quad = pick(quadrants);
                return { question: `In Quadrant ${quad.q}, x is ___ and y is ___.`, answer: quad.desc, type: "conceptual",
                    options: quadrants.map(q => q.desc),
                    explanation: `Quadrant ${quad.q} has ${quad.desc}. Example: ${quad.ex}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, showQuadrantLabels: true } } };
            } else {
                const x1 = 0, y1 = 0;
                const x2 = rand(3, 5), y2 = 0;
                return { question: `Distance from (${x1}, ${y1}) to (${x2}, ${y2})?`, answer: x2, type: "procedural",
                    explanation: `Points on same horizontal line: distance = |${x2} - ${x1}| = ${x2}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 7], yRange: [-3, 3], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }], dashed: true }] } } };
            }
        },
        Proportions: () => {
            const type = pick(["solve", "setup", "word"]);
            if (type === "solve") {
                const a = rand(2, 8), b = rand(2, 6), c = rand(3, 12);
                const d = (b * c) / a;
                if (d === Math.floor(d)) {
                    return { question: `Solve: ${a}/${b} = ${c}/x`, answer: d, type: "procedural",
                        explanation: `Cross multiply: ${a} × x = ${b} × ${c} → ${a}x = ${b*c} → x = ${d}` };
                } else {
                    const newA = rand(2, 5), newB = rand(2, 4), newC = newA * rand(2, 4);
                    const newD = (newB * newC) / newA;
                    return { question: `Solve: ${newA}/${newB} = ${newC}/x`, answer: newD, type: "procedural",
                        explanation: `Cross multiply: ${newA} × x = ${newB} × ${newC} → ${newA}x = ${newB*newC} → x = ${newD}` };
                }
            } else if (type === "setup") {
                const rate = rand(2, 5), unit = rand(3, 10);
                const total = rate * unit;
                return { question: `If ${rate} apples cost $${unit}, write a proportion to find the cost of ${total/rate * 2} apples.`,
                    answer: `${rate}/${unit} = ${total/rate * 2}/x`, type: "conceptual",
                    options: [`${rate}/${unit} = ${total/rate * 2}/x`, `${unit}/${rate} = x/${total/rate * 2}`, `${rate}/x = ${unit}/${total/rate * 2}`, `${total/rate * 2}/${rate} = x/${unit}`],
                    explanation: `Set up: apples/cost = apples/cost → ${rate}/${unit} = ${total/rate * 2}/x` };
            } else {
                const miles = rand(50, 150), hours = rand(2, 4);
                const rate = miles / hours;
                const newHours = hours + rand(1, 3);
                const newMiles = rate * newHours;
                return { question: `You drive ${miles} miles in ${hours} hours. At this rate, how far in ${newHours} hours?`, answer: newMiles, type: "reasoning",
                    explanation: `Rate = ${miles}/${hours} = ${rate} mph. Distance = ${rate} × ${newHours} = ${newMiles} miles` };
            }
        },
        "Absolute Value": () => {
            const type = pick(["evaluate", "compare", "solve"]);
            if (type === "evaluate") {
                const n = rand(-15, 15);
                return { question: `What is |${n}|?`, answer: Math.abs(n), type: "procedural",
                    explanation: `|${n}| = ${Math.abs(n)}. Absolute value is the distance from 0, always positive.` };
            } else if (type === "compare") {
                const a = rand(-10, -1), b = rand(1, 10);
                const absA = Math.abs(a), absB = Math.abs(b);
                const larger = absA > absB ? `|${a}|` : absA < absB ? `|${b}|` : "equal";
                return { question: `Which is greater: |${a}| or |${b}|?`, answer: larger, type: "conceptual",
                    options: [`|${a}|`, `|${b}|`, "equal"],
                    explanation: `|${a}| = ${absA}, |${b}| = ${absB}. ${larger === "equal" ? "They are equal." : larger + " is greater."}` };
            } else {
                const ans = rand(2, 10);
                return { question: `Solve: |x| = ${ans}`, answer: `${ans} or -${ans}`, type: "procedural",
                    options: [`${ans} or -${ans}`, `${ans}`, `-${ans}`, `${ans * 2}`],
                    explanation: `|x| = ${ans} means x = ${ans} or x = -${ans} (both are ${ans} away from 0)` };
            }
        },
        "Scientific Notation": () => {
            const type = pick(["convert_to", "convert_from", "multiply"]);
            if (type === "convert_to") {
                const sig = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(3, 7);
                const standard = sig * Math.pow(10, exp);
                return { question: `Write ${standard.toLocaleString()} in scientific notation.`, answer: `${sig} × 10^${exp}`, type: "procedural",
                    options: [`${sig} × 10^${exp}`, `${sig} × 10^${exp-1}`, `${sig * 10} × 10^${exp-1}`, `${sig / 10} × 10^${exp+1}`],
                    explanation: `Move decimal ${exp} places left: ${standard.toLocaleString()} = ${sig} × 10^${exp}` };
            } else if (type === "convert_from") {
                const sig = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(2, 5);
                const answer = sig * Math.pow(10, exp);
                return { question: `Convert ${sig} × 10^${exp} to standard form.`, answer: answer, type: "procedural",
                    explanation: `Move decimal ${exp} places right: ${sig} × 10^${exp} = ${answer}` };
            } else {
                const a = rand(2, 5), b = rand(2, 4), expA = rand(3, 5), expB = rand(2, 4);
                const product = a * b;
                const expSum = expA + expB;
                return { question: `(${a} × 10^${expA}) × (${b} × 10^${expB}) = ?`, answer: `${product} × 10^${expSum}`, type: "procedural",
                    options: [`${product} × 10^${expSum}`, `${a + b} × 10^${expSum}`, `${product} × 10^${expA * expB}`, `${product} × 10^${expA}`],
                    explanation: `Multiply coefficients: ${a} × ${b} = ${product}. Add exponents: ${expA} + ${expB} = ${expSum}` };
            }
        },
        "Square Roots": () => {
            const type = pick(["perfect", "estimate", "simplify"]);
            if (type === "perfect") {
                const root = rand(2, 12);
                const square = root * root;
                return { question: `What is √${square}?`, answer: root, type: "procedural",
                    explanation: `√${square} = ${root} because ${root} × ${root} = ${square}` };
            } else if (type === "estimate") {
                const root = rand(4, 9);
                const between = root * root + rand(1, root * 2 - 1);
                const low = root, high = root + 1;
                return { question: `Between which two integers is √${between}?`, answer: `${low} and ${high}`, type: "reasoning",
                    options: [`${low} and ${high}`, `${low - 1} and ${low}`, `${high} and ${high + 1}`, `${low - 1} and ${high + 1}`],
                    explanation: `${low}² = ${low*low}, ${high}² = ${high*high}. Since ${low*low} < ${between} < ${high*high}, √${between} is between ${low} and ${high}.` };
            } else {
                const outside = rand(2, 5), inside = rand(2, 5);
                const radicand = outside * outside * inside;
                return { question: `Simplify √${radicand}`, answer: `${outside}√${inside}`, type: "procedural",
                    options: [`${outside}√${inside}`, `${inside}√${outside}`, `√${radicand}`, `${outside * inside}`],
                    explanation: `√${radicand} = √(${outside}² × ${inside}) = ${outside}√${inside}` };
            }
        },
        "GCF and LCM": () => {
            const type = pick(["gcf", "lcm", "gcf_word", "lcm_word"]);
            const pairs = [[12, 18], [8, 12], [15, 20], [10, 15], [14, 21], [16, 24], [9, 12], [6, 8]];
            const [a, b] = pick(pairs);
            // Calculate GCF
            const findGCF = (x, y) => { while (y) { [x, y] = [y, x % y]; } return x; };
            const gcfVal = findGCF(a, b);
            // Calculate LCM
            const lcmVal = (a * b) / gcfVal;
            if (type === "gcf") {
                return { question: `What is the GCF (Greatest Common Factor) of ${a} and ${b}?`, answer: gcfVal, type: "procedural",
                    options: [gcfVal, lcmVal, Math.min(a, b), a + b].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `Factors of ${a}: ${[...Array(a)].map((_,i)=>i+1).filter(n=>a%n===0).join(", ")}. Factors of ${b}: ${[...Array(b)].map((_,i)=>i+1).filter(n=>b%n===0).join(", ")}. GCF = ${gcfVal}` };
            } else if (type === "lcm") {
                return { question: `What is the LCM (Least Common Multiple) of ${a} and ${b}?`, answer: lcmVal, type: "procedural",
                    options: [lcmVal, a * b, gcfVal, Math.max(a, b)].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `Multiples of ${a}: ${a}, ${a*2}, ${a*3}... Multiples of ${b}: ${b}, ${b*2}, ${b*3}... LCM = ${lcmVal}` };
            } else if (type === "gcf_word") {
                return { question: `${a} red beads and ${b} blue beads are divided into equal groups. What is the greatest number of groups possible?`, answer: gcfVal, type: "reasoning",
                    explanation: `GCF of ${a} and ${b} = ${gcfVal}. You can make ${gcfVal} equal groups.` };
            } else {
                return { question: `Hot dogs come in packs of ${a}. Buns come in packs of ${b}. What's the least number of each to have the same amount?`, answer: lcmVal, type: "reasoning",
                    explanation: `LCM of ${a} and ${b} = ${lcmVal}. Buy ${lcmVal / a} packs of hot dogs and ${lcmVal / b} packs of buns.` };
            }
        },
        "Powers of 10": () => {
            const type = pick(["multiply", "divide", "pattern", "decimal", "scientific"]);
            if (type === "multiply") {
                const n = rand(1, 99);
                const power = rand(1, 4);
                const result = n * Math.pow(10, power);
                return { question: `${n} × 10${power > 1 ? `^${power}` : ""} = ?`, answer: result, type: "procedural",
                    explanation: `Move the decimal ${power} place(s) right: ${n} → ${result}` };
            } else if (type === "divide") {
                const n = rand(1, 9) * Math.pow(10, rand(2, 4));
                const power = rand(1, 3);
                const result = n / Math.pow(10, power);
                return { question: `${n} ÷ 10${power > 1 ? `^${power}` : ""} = ?`, answer: result, type: "procedural",
                    explanation: `Move the decimal ${power} place(s) left: ${n} → ${result}` };
            } else if (type === "pattern") {
                const base = rand(2, 9);
                const exp = rand(2, 5);
                const value = base * Math.pow(10, exp);
                return { question: `${base} × 10^${exp} = ?`, answer: value, type: "procedural",
                    options: [value, base * exp, Math.pow(base, exp), value / 10],
                    explanation: `10^${exp} = ${Math.pow(10, exp)}. So ${base} × 10^${exp} = ${value}` };
            } else if (type === "decimal") {
                const n = rand(1, 99) / 100;
                const power = rand(2, 4);
                const result = n * Math.pow(10, power);
                return { question: `${n} × 10^${power} = ?`, answer: result, type: "procedural",
                    explanation: `Move decimal ${power} places right: ${n} → ${result}` };
            } else {
                const coefficient = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(3, 6);
                const value = coefficient * Math.pow(10, exp);
                return { question: `Write ${coefficient} × 10^${exp} in standard form.`, answer: value, type: "procedural",
                    explanation: `${coefficient} × 10^${exp} = ${value}` };
            }
        },
        "Coordinate Plane": () => {
            const type = pick(["identify", "plot", "quadrant", "distance", "midpoint"]);
            if (type === "identify") {
                const x = rand(-5, 5);
                const y = rand(-5, 5);
                const which = pick(["x", "y"]);
                return {
                    question: `Look at point A on the graph. What is its ${which}-coordinate?`,
                    answer: which === "x" ? x : y, type: "conceptual",
                    options: [x, y, -x, -y].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `In (${x}, ${y}), the x-coordinate is ${x} and y-coordinate is ${y}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-6, 6], yRange: [-6, 6], gridStep: 1, points: [{ x, y, label: 'A' }] } }
                };
            } else if (type === "plot") {
                const x = rand(-4, 4);
                const y = rand(-4, 4);
                return {
                    question: `Click on the coordinate plane to plot the point (${x}, ${y}).`,
                    answer: `(${x}, ${y})`, type: "procedural",
                    explanation: `(${x}, ${y}) means go ${x} on x-axis and ${y} on y-axis.`,
                    visual: { type: 'coordinate', mode: 'interactive', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, targetPoint: { x, y } } }
                };
            } else if (type === "quadrant") {
                const quadrants = [
                    { q: "I", x: rand(1, 5), y: rand(1, 5), signs: "(+, +)" },
                    { q: "II", x: rand(-5, -1), y: rand(1, 5), signs: "(-, +)" },
                    { q: "III", x: rand(-5, -1), y: rand(-5, -1), signs: "(-, -)" },
                    { q: "IV", x: rand(1, 5), y: rand(-5, -1), signs: "(+, -)" }
                ];
                const quad = pick(quadrants);
                return {
                    question: `In which quadrant is point A?`,
                    answer: `Quadrant ${quad.q}`, type: "conceptual",
                    options: ["Quadrant I", "Quadrant II", "Quadrant III", "Quadrant IV"],
                    explanation: `${quad.signs} means Quadrant ${quad.q}. (${quad.x}, ${quad.y}) is in Quadrant ${quad.q}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-6, 6], yRange: [-6, 6], gridStep: 1, points: [{ x: quad.x, y: quad.y, label: 'A' }] } }
                };
            } else if (type === "distance") {
                const x1 = 0, y1 = 0, x2 = 3, y2 = 4;
                return {
                    question: `Find the distance from A to B.`,
                    answer: 5, type: "procedural",
                    options: [5, 7, 12, 1],
                    explanation: `Distance = √(3² + 4²) = √(9 + 16) = √25 = 5`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 6], yRange: [-1, 6], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] }] } }
                };
            } else {
                const x1 = rand(0, 2) * 2, y1 = rand(0, 2) * 2;
                const x2 = rand(2, 4) * 2, y2 = rand(2, 4) * 2;
                const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
                return {
                    question: `Find the midpoint of segment AB.`,
                    answer: `(${midX}, ${midY})`, type: "procedural",
                    options: [`(${midX}, ${midY})`, `(${x1 + x2}, ${y1 + y2})`, `(${midY}, ${midX})`, `(${x2 - x1}, ${y2 - y1})`],
                    explanation: `Midpoint = ((${x1}+${x2})/2, (${y1}+${y2})/2) = (${midX}, ${midY})`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 10], yRange: [-1, 10], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] }] } }
                };
            }
        },
        "Volume": () => {
            const type = pick(["rectangular_prism", "cube", "find_dimension", "word_problem", "compare"]);
            if (type === "rectangular_prism") {
                const l = rand(2, 8), w = rand(2, 6), h = rand(2, 5);
                const vol = l * w * h;
                return { question: `Find the volume of a rectangular prism: length ${l}, width ${w}, height ${h}.`, answer: vol, type: "procedural",
                    explanation: `Volume = l × w × h = ${l} × ${w} × ${h} = ${vol} cubic units` };
            } else if (type === "cube") {
                const s = rand(2, 6);
                const vol = s * s * s;
                return { question: `Find the volume of a cube with side length ${s}.`, answer: vol, type: "procedural",
                    explanation: `Volume = s³ = ${s}³ = ${vol} cubic units` };
            } else if (type === "find_dimension") {
                const l = rand(3, 6), w = rand(2, 4);
                const vol = l * w * rand(2, 4);
                const h = vol / (l * w);
                return { question: `A box has volume ${vol} cubic units. Length = ${l}, width = ${w}. What is the height?`, answer: h, type: "reasoning",
                    options: [h, h + 1, h - 1, vol / l].filter((v,i,arr) => arr.indexOf(v) === i),
                    explanation: `Volume = l × w × h, so h = Volume ÷ (l × w) = ${vol} ÷ ${l * w} = ${h}` };
            } else if (type === "word_problem") {
                const l = rand(3, 8), w = rand(2, 5), h = rand(2, 4);
                const vol = l * w * h;
                const container = pick(["fish tank", "storage box", "shipping crate"]);
                return { question: `A ${container} is ${l} ft long, ${w} ft wide, and ${h} ft tall. What is its volume?`, answer: vol, type: "reasoning",
                    explanation: `Volume = ${l} × ${w} × ${h} = ${vol} cubic feet` };
            } else {
                const v1 = { l: rand(3, 5), w: rand(2, 4), h: rand(2, 3) };
                const v2 = { l: rand(3, 5), w: rand(2, 4), h: rand(2, 3) };
                const vol1 = v1.l * v1.w * v1.h;
                const vol2 = v2.l * v2.w * v2.h;
                const larger = vol1 > vol2 ? "Box A" : vol2 > vol1 ? "Box B" : "Same";
                return { question: `Box A: ${v1.l}×${v1.w}×${v1.h}. Box B: ${v2.l}×${v2.w}×${v2.h}. Which has more volume?`, answer: larger, type: "reasoning",
                    options: ["Box A", "Box B", "Same"],
                    explanation: `A: ${vol1} cu units. B: ${vol2} cu units. ${larger} has more volume.` };
            }
        },
        "Order of Operations": () => {
            const type = pick(["basic", "with_exponents", "with_parentheses", "complex"]);
            if (type === "basic") {
                const a = rand(2, 8), b = rand(2, 6), c = rand(2, 5);
                const result = a + b * c;
                return { question: `${a} + ${b} × ${c} = ?`, answer: result, type: "procedural",
                    explanation: `PEMDAS: Multiply first: ${b} × ${c} = ${b * c}. Then add: ${a} + ${b * c} = ${result}` };
            } else if (type === "with_exponents") {
                const a = rand(2, 4), b = rand(2, 5), c = rand(1, 4);
                const result = a * a + b * c;
                return { question: `${a}² + ${b} × ${c} = ?`, answer: result, type: "procedural",
                    explanation: `PEMDAS: Exponents first: ${a}² = ${a * a}. Then multiply: ${b} × ${c} = ${b * c}. Add: ${a * a} + ${b * c} = ${result}` };
            } else if (type === "with_parentheses") {
                const a = rand(2, 5), b = rand(2, 5), c = rand(2, 4);
                const result = (a + b) * c;
                return { question: `(${a} + ${b}) × ${c} = ?`, answer: result, type: "procedural",
                    explanation: `PEMDAS: Parentheses first: ${a} + ${b} = ${a + b}. Then multiply: ${a + b} × ${c} = ${result}` };
            } else {
                const a = rand(2, 3), b = rand(2, 4), c = rand(2, 3), d = rand(1, 3);
                const result = a * a + b * (c + d);
                return { question: `${a}² + ${b} × (${c} + ${d}) = ?`, answer: result, type: "procedural",
                    explanation: `Parentheses: ${c} + ${d} = ${c + d}. Exponent: ${a}² = ${a * a}. Multiply: ${b} × ${c + d} = ${b * (c + d)}. Add: ${a * a} + ${b * (c + d)} = ${result}` };
            }
        },
        "Expressions with Variables": () => {
            const type = pick(["evaluate", "simplify", "translate", "like_terms"]);
            if (type === "evaluate") {
                const x = rand(2, 8);
                const a = rand(2, 5), b = rand(1, 10);
                const result = a * x + b;
                return { question: `Evaluate ${a}x + ${b} when x = ${x}`, answer: result, type: "procedural",
                    explanation: `${a}(${x}) + ${b} = ${a * x} + ${b} = ${result}` };
            } else if (type === "simplify") {
                const a = rand(2, 6), b = rand(1, 5);
                const sum = a + b;
                return { question: `Simplify: ${a}x + ${b}x`, answer: `${sum}x`, type: "procedural",
                    options: [`${sum}x`, `${a * b}x`, `${a}x²`, `x${sum}`],
                    explanation: `${a}x + ${b}x = (${a} + ${b})x = ${sum}x` };
            } else if (type === "translate") {
                const phrases = [
                    { words: "5 more than a number", expr: "n + 5" },
                    { words: "twice a number", expr: "2n" },
                    { words: "a number decreased by 3", expr: "n - 3" },
                    { words: "a number divided by 4", expr: "n ÷ 4" },
                    { words: "3 times a number plus 2", expr: "3n + 2" }
                ];
                const phrase = pick(phrases);
                return { question: `Write an expression: "${phrase.words}"`, answer: phrase.expr, type: "reasoning",
                    options: shuffle(phrases.map(p => p.expr)).slice(0, 4),
                    explanation: `"${phrase.words}" translates to ${phrase.expr}` };
            } else {
                const a = rand(2, 5), b = rand(1, 4);
                let c = rand(1, 5);
                while (c === b) c = rand(1, 5);
                const d = rand(1, 4);
                const xCoef = a + c, constant = b + d;
                return { question: `Combine like terms: ${a}x + ${b} + ${c}x + ${d}`, answer: `${xCoef}x + ${constant}`, type: "procedural",
                    options: [`${xCoef}x + ${constant}`, `${a + b}x + ${c + d}`, `${xCoef + constant}x`, `${xCoef}x + ${constant + 1}`],
                    explanation: `x terms: ${a}x + ${c}x = ${xCoef}x. Constants: ${b} + ${d} = ${constant}. Result: ${xCoef}x + ${constant}` };
            }
        },
        "One-Step Equations": () => {
            const type = pick(["add", "subtract", "multiply", "divide"]);
            const x = rand(2, 12);
            if (type === "add") {
                const b = rand(3, 15);
                return { question: `Solve: x + ${b} = ${x + b}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b} from both sides: x = ${x + b} - ${b} = ${x}` };
            } else if (type === "subtract") {
                const b = rand(3, 10);
                return { question: `Solve: x - ${b} = ${x - b}`, answer: x, type: "procedural",
                    explanation: `Add ${b} to both sides: x = ${x - b} + ${b} = ${x}` };
            } else if (type === "multiply") {
                const a = rand(2, 6);
                return { question: `Solve: ${a}x = ${a * x}`, answer: x, type: "procedural",
                    explanation: `Divide both sides by ${a}: x = ${a * x} ÷ ${a} = ${x}` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve: x/${a} = ${x / a}`, answer: x, type: "procedural",
                    explanation: `Multiply both sides by ${a}: x = ${x / a} × ${a} = ${x}` };
            }
        },
        "Simple Probability": () => {
            const type = pick(["basic", "fraction", "complement", "word_problem", "compare"]);
            if (type === "basic") {
                const total = pick([6, 8, 10, 12]);
                const favorable = rand(1, total - 1);
                const prob = `${favorable}/${total}`;
                const color = pick(["red", "blue", "green"]);
                return { question: `A bag has ${total} marbles. ${favorable} are ${color}. What is P(${color})?`, answer: prob, type: "procedural",
                    options: [prob, `${total - favorable}/${total}`, `${favorable}/${favorable}`, `${total}/${favorable}`],
                    explanation: `P(${color}) = favorable/total = ${favorable}/${total}` };
            } else if (type === "fraction") {
                const die = true;
                const event = pick(["even", "odd", "greater than 4", "less than 3"]);
                const probs = { "even": "3/6", "odd": "3/6", "greater than 4": "2/6", "less than 3": "2/6" };
                return { question: `Roll a die. What is P(${event})?`, answer: probs[event], type: "procedural",
                    options: ["1/6", "2/6", "3/6", "4/6"],
                    explanation: `P(${event}) = ${probs[event]}` };
            } else if (type === "complement") {
                const total = 10;
                const favorable = rand(2, 8);
                const complement = total - favorable;
                return { question: `P(winning) = ${favorable}/${total}. What is P(not winning)?`, answer: `${complement}/${total}`, type: "procedural",
                    options: [`${complement}/${total}`, `${favorable}/${total}`, `${total}/${favorable}`, `1/${total}`],
                    explanation: `P(not winning) = 1 - P(winning) = 1 - ${favorable}/${total} = ${complement}/${total}` };
            } else if (type === "word_problem") {
                const total = rand(5, 10);
                const red = rand(1, total - 1);
                const blue = total - red;
                const probOpts = red !== blue
                    ? [`${blue}/${total}`, `${red}/${total}`, `${total}/${blue}`, `${blue}/${red}`]
                    : [`${blue}/${total}`, `${total}/${blue}`, `1/${total}`, `${blue}/${blue}`];
                return { question: `Bag has ${red} red and ${blue} blue balls. What is P(blue)?`, answer: `${blue}/${total}`, type: "reasoning",
                    options: probOpts,
                    explanation: `Total = ${total}. P(blue) = ${blue}/${total}` };
            } else {
                const p1 = rand(1, 4), p2 = rand(1, 4);
                const total = 8;
                const more = p1 > p2 ? "Event A" : p2 > p1 ? "Event B" : "Same";
                return { question: `P(A) = ${p1}/8, P(B) = ${p2}/8. Which is more likely?`, answer: more, type: "reasoning",
                    options: ["Event A", "Event B", "Same"],
                    explanation: `${p1}/8 ${p1 > p2 ? ">" : p1 < p2 ? "<" : "="} ${p2}/8. ${more} is more likely.` };
            }
        },
        "Comparing Distributions": () => {
            const type = pick(["mean", "spread", "center", "shape"]);
            if (type === "mean") {
                const set1 = [rand(10, 20), rand(10, 20), rand(10, 20), rand(10, 20), rand(10, 20)];
                const set2 = [rand(15, 25), rand(15, 25), rand(15, 25), rand(15, 25), rand(15, 25)];
                const mean1 = set1.reduce((a, b) => a + b, 0) / 5;
                const mean2 = set2.reduce((a, b) => a + b, 0) / 5;
                const higher = mean1 > mean2 ? "Set A" : "Set B";
                return { question: `Set A: ${set1.join(", ")}. Set B: ${set2.join(", ")}. Which has a higher mean?`, answer: higher, type: "reasoning",
                    options: ["Set A", "Set B", "Same"],
                    explanation: `Mean A = ${mean1.toFixed(1)}. Mean B = ${mean2.toFixed(1)}. ${higher} is higher.` };
            } else if (type === "spread") {
                const set1 = [10, 11, 12, 13, 14];
                const set2 = [5, 10, 12, 15, 23];
                return { question: `Set A: ${set1.join(", ")}. Set B: ${set2.join(", ")}. Which has more spread?`, answer: "Set B", type: "conceptual",
                    options: ["Set A", "Set B", "Same"],
                    explanation: `Set A ranges 10-14 (4). Set B ranges 5-23 (18). Set B has more spread.` };
            } else if (type === "center") {
                const median1 = rand(15, 25);
                const median2 = rand(10, 20);
                const higher = median1 > median2 ? "Class A" : "Class B";
                return { question: `Class A median score: ${median1}. Class B median score: ${median2}. Which class performed better?`, answer: higher, type: "reasoning",
                    options: ["Class A", "Class B", "Same"],
                    explanation: `Higher median = better typical performance. ${higher} (median ${Math.max(median1, median2)}) did better.` };
            } else {
                return { question: `A distribution where most values cluster around the mean is called...?`, answer: "symmetric", type: "conceptual",
                    options: ["symmetric", "skewed left", "skewed right", "uniform"],
                    explanation: `When data clusters around the center with similar spread on both sides, it's symmetric.` };
            }
        },
        "Nets of 3D Shapes": () => {
            const type = pick(["identify", "surface_area", "count_faces", "fold"]);
            const shapes = [
                { name: "cube", faces: 6, net: "6 squares" },
                { name: "rectangular prism", faces: 6, net: "6 rectangles (or 4 rectangles + 2 squares)" },
                { name: "triangular prism", faces: 5, net: "2 triangles + 3 rectangles" },
                { name: "square pyramid", faces: 5, net: "1 square + 4 triangles" },
                { name: "cylinder", faces: 3, net: "2 circles + 1 rectangle" }
            ];
            if (type === "identify") {
                const shape = pick(shapes);
                return { question: `A net with ${shape.net} folds into a...?`, answer: shape.name, type: "conceptual",
                    options: shapes.slice(0, 4).map(s => s.name),
                    explanation: `${shape.net} makes a ${shape.name}.` };
            } else if (type === "surface_area") {
                const side = rand(2, 5);
                const sa = 6 * side * side;
                return { question: `A cube has side length ${side}. What is its surface area?`, answer: sa, type: "procedural",
                    explanation: `Surface area = 6 × side² = 6 × ${side}² = 6 × ${side * side} = ${sa} sq units` };
            } else if (type === "count_faces") {
                const shape = pick(shapes);
                return { question: `How many faces does a ${shape.name} have?`, answer: shape.faces, type: "conceptual",
                    options: [shape.faces, shape.faces + 1, shape.faces - 1, shape.faces + 2].filter(n => n > 0),
                    explanation: `A ${shape.name} has ${shape.faces} faces.` };
            } else {
                const shape = pick(shapes.filter(s => s.name !== "cylinder"));
                return { question: `What 2D shapes appear in the net of a ${shape.name}?`, answer: shape.net, type: "conceptual",
                    options: shapes.filter(s => s.name !== "cylinder").map(s => s.net),
                    explanation: `The net of a ${shape.name} contains ${shape.net}.` };
            }
        }
    },

    // TIER 4: Pre-Algebra (7-8)
    4: {
        "Order of Operations": () => {
            const templates = [
                () => { const a = rand(2, 8), b = rand(2, 6), c = rand(2, 5); return { q: `${a} + ${b} × ${c}`, ans: a + b * c, exp: `Multiply first: ${b} × ${c} = ${b*c}. Then add: ${a} + ${b*c} = ${a + b*c}` }; },
                () => { const a = rand(2, 5), b = rand(2, 5), c = rand(2, 4); return { q: `(${a} + ${b}) × ${c}`, ans: (a + b) * c, exp: `Parentheses first: ${a} + ${b} = ${a+b}. Then multiply: ${(a+b)} × ${c} = ${(a+b)*c}` }; },
                () => { const a = rand(2, 4), b = rand(2, 4), c = rand(1, 5); return { q: `${a}² + ${b} × ${c}`, ans: a*a + b*c, exp: `Exponent first: ${a}² = ${a*a}. Multiply: ${b} × ${c} = ${b*c}. Add: ${a*a} + ${b*c} = ${a*a + b*c}` }; }
            ];
            const t = pick(templates)();
            return { question: `What is ${t.q}?`, answer: t.ans, type: "procedural", explanation: t.exp };
        },
        Equations: () => {
            // Map sub-skill IDs to question types
            const subSkillToTypes = {
                'one_step_add_sub': ['add', 'sub'],
                'one_step_mult_div': ['mult', 'div'],
                'two_step': ['two_step'],
                'variables_both_sides': ['both_sides']
            };

            // Get unlocked question types based on completed sub-skills
            const completedSubSkills = state.completedSubSkills['4_Equations'] || [];
            let availableTypes = [];
            if (completedSubSkills.length > 0) {
                completedSubSkills.forEach(id => {
                    if (subSkillToTypes[id]) availableTypes.push(...subSkillToTypes[id]);
                });
            }
            if (availableTypes.length === 0) availableTypes = ['add', 'sub']; // Default

            const type = pick(availableTypes);
            const x = rand(2, 12);
            let question, explanation, answer = x;

            if (type === "add") {
                const b = rand(3, 12);
                question = `x + ${b} = ${x + b}`;
                explanation = `Subtract ${b}: x = ${x + b} - ${b} = ${x}`;
            } else if (type === "sub") {
                const b = rand(3, 12);
                question = `x - ${b} = ${x - b}`;
                explanation = `Add ${b}: x = ${x - b} + ${b} = ${x}`;
            } else if (type === "mult") {
                const b = rand(2, 8);
                question = `${b}x = ${b * x}`;
                explanation = `Divide by ${b}: x = ${b * x} ÷ ${b} = ${x}`;
            } else if (type === "div") {
                const b = rand(2, 6);
                question = `x ÷ ${b} = ${x}`;
                answer = x * b;
                explanation = `Multiply by ${b}: x = ${x} × ${b} = ${x * b}`;
            } else if (type === "two_step") {
                const a = rand(2, 5), b = rand(2, 10);
                const result = a * x + b;
                question = `${a}x + ${b} = ${result}`;
                explanation = `Subtract ${b}: ${a}x = ${result - b}. Divide by ${a}: x = ${x}`;
            } else if (type === "both_sides") {
                const a1 = rand(3, 6), a2 = rand(2, a1 - 1), b1 = rand(1, 5), b2 = rand(b1 + 1, 15);
                const diff = a1 - a2;
                answer = (b2 - b1) / diff;
                if (!Number.isInteger(answer)) { answer = x; const b2New = (a1 - a2) * x + b1; question = `${a1}x + ${b1} = ${a2}x + ${b2New}`; explanation = `Subtract ${a2}x: ${diff}x + ${b1} = ${b2New}. Subtract ${b1}: ${diff}x = ${b2New - b1}. Divide: x = ${x}`; }
                else { question = `${a1}x + ${b1} = ${a2}x + ${b2}`; explanation = `Move x's: ${diff}x + ${b1} = ${b2}. Solve: x = ${answer}`; }
            }
            return { question: `Solve: ${question}`, answer, type: "procedural", explanation };
        },
        Exponents: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'eval': 'eval',
                'multiply': 'multiply',
                'power': 'power'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['4_Exponents'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["eval", "multiply", "power"];
            }

            const type = pick(availableTypes);
            const superscripts = ["⁰","¹","²","³","⁴","⁵","⁶","⁷","⁸","⁹"];

            if (type === "eval") {
                const base = rand(2, 5), exp = rand(2, 4);
                return { question: `What is ${base}${superscripts[exp]}?`, answer: Math.pow(base, exp), type: "procedural",
                    explanation: `${base}^${exp} = ${Array(exp).fill(base).join(" × ")} = ${Math.pow(base, exp)}` };
            } else if (type === "multiply") {
                const base = rand(2, 4), e1 = rand(2, 4), e2 = rand(2, 3);
                return { question: `Simplify: ${base}${superscripts[e1]} × ${base}${superscripts[e2]}`, answer: `${base}^${e1+e2}`, type: "procedural",
                    options: [`${base}^${e1+e2}`, `${base}^${e1*e2}`, `${base*2}^${e1}`, `${base}^${e1}`],
                    explanation: `Add exponents when multiplying same base: ${base}^${e1} × ${base}^${e2} = ${base}^${e1+e2}` };
            } else {
                const base = rand(2, 3), e1 = rand(2, 3), e2 = rand(2, 3);
                return { question: `Simplify: (${base}${superscripts[e1]})${superscripts[e2]}`, answer: `${base}^${e1*e2}`, type: "procedural",
                    options: [`${base}^${e1*e2}`, `${base}^${e1+e2}`, `${base*e2}^${e1}`, `${base}^${e1}`],
                    explanation: `Multiply exponents for power of power: (${base}^${e1})^${e2} = ${base}^${e1*e2}` };
            }
        },
        Slope: () => {
            const rise = rand(1, 4), run = rand(1, 4);
            const type = pick(["formula", "points"]);
            if (type === "formula") {
                const x1 = 0, y1 = 1;
                const x2 = run, y2 = y1 + rise;
                return {
                    question: `What is the slope of this line?`,
                    answer: rise / run, type: "conceptual",
                    explanation: `Slope = rise/run = ${rise}/${run} = ${(rise/run).toFixed(2)}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 6], yRange: [-1, 6], gridStep: 1, lines: [{ equation: { m: rise/run, b: y1 } }], points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] } }
                };
            } else {
                const x1 = rand(0, 2), y1 = rand(0, 2);
                const x2 = x1 + run, y2 = y1 + rise;
                return {
                    question: `Find the slope of the line through A and B.`,
                    answer: rise / run, type: "procedural",
                    explanation: `Slope = (${y2}-${y1})/(${x2}-${x1}) = ${rise}/${run} = ${(rise/run).toFixed(2)}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 7], yRange: [-1, 7], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] }] } }
                };
            }
        },
        Pythagorean: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'hyp': 'hyp',
                'leg': 'leg'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['4_Pythagorean'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["hyp", "leg"];
            }

            const triples = [[3,4,5], [5,12,13], [8,15,17], [6,8,10]];
            const [a, b, c] = pick(triples);
            const type = pick(availableTypes);

            if (type === "hyp") {
                return { question: `Right triangle legs ${a} and ${b}. Find hypotenuse.`, answer: c, type: "procedural",
                    explanation: `a² + b² = c². ${a}² + ${b}² = ${a*a} + ${b*b} = ${c*c}. c = ${c}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'right-triangle', dimensions: { a, b, c: '?' }, showMeasurements: true, highlightSides: ['c'] } } };
            } else {
                return { question: `Right triangle: leg ${a}, hypotenuse ${c}. Find other leg.`, answer: b, type: "procedural",
                    explanation: `a² + b² = c². ${a}² + b² = ${c}². b² = ${c*c} - ${a*a} = ${b*b}. b = ${b}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'right-triangle', dimensions: { a, b: '?', c }, showMeasurements: true, highlightSides: ['b'] } } };
            }
        },
        "Angles and Lines": () => {
            const type = pick(["complementary", "supplementary", "vertical", "parallel"]);
            if (type === "complementary") {
                const angle1 = rand(10, 80);
                const angle2 = 90 - angle1;
                return { question: `Two complementary angles: one is ${angle1}°. Find the other.`, answer: angle2, type: "procedural",
                    explanation: `Complementary angles add to 90°. 90° - ${angle1}° = ${angle2}°` };
            } else if (type === "supplementary") {
                const angle1 = rand(30, 150);
                const angle2 = 180 - angle1;
                return { question: `Two supplementary angles: one is ${angle1}°. Find the other.`, answer: angle2, type: "procedural",
                    explanation: `Supplementary angles add to 180°. 180° - ${angle1}° = ${angle2}°` };
            } else if (type === "vertical") {
                const angle = rand(20, 160);
                return { question: `Two lines intersect. One angle is ${angle}°. What is the vertical angle?`, answer: angle, type: "conceptual",
                    explanation: `Vertical angles are equal. The vertical angle is also ${angle}°.` };
            } else {
                const angle = rand(40, 140);
                const type2 = pick(["corresponding", "alternate"]);
                return { question: `Parallel lines cut by a transversal. One angle is ${angle}°. Find the ${type2} angle.`, answer: angle, type: "conceptual",
                    explanation: `${type2.charAt(0).toUpperCase() + type2.slice(1)} angles with parallel lines are equal: ${angle}°` };
            }
        },
        "Algebraic Expressions": () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'evaluate': 'evaluate',
                'simplify': 'simplify',
                'translate': 'translate'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['4_Algebraic Expressions'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["evaluate", "simplify", "translate"];
            }

            const type = pick(availableTypes);

            if (type === "evaluate") {
                const a = rand(2, 5);
                const b = rand(1, 10);
                const x = rand(2, 6);
                const answer = a * x + b;
                return { question: `Evaluate ${a}x + ${b} when x = ${x}`, answer, type: "procedural",
                    explanation: `Substitute x = ${x}: ${a}(${x}) + ${b} = ${a * x} + ${b} = ${answer}` };
            } else if (type === "simplify") {
                const a = rand(2, 6);
                const b = rand(1, 5);
                const c = rand(1, 4);
                const d = rand(1, 5);
                return { question: `Simplify: ${a}x + ${b} + ${c}x + ${d}`, answer: `${a + c}x + ${b + d}`, type: "procedural",
                    options: [`${a + c}x + ${b + d}`, `${a * c}x + ${b + d}`, `${a + c}x + ${b * d}`, `${a + b}x + ${c + d}`],
                    explanation: `Combine like terms: (${a} + ${c})x + (${b} + ${d}) = ${a + c}x + ${b + d}` };
            } else {
                const templates = [
                    { phrase: "5 more than a number x", expr: "x + 5" },
                    { phrase: "3 times a number x", expr: "3x" },
                    { phrase: "a number x decreased by 7", expr: "x - 7" },
                    { phrase: "twice a number x plus 4", expr: "2x + 4" }
                ];
                const t = pick(templates);
                return { question: `Write as an expression: "${t.phrase}"`, answer: t.expr, type: "conceptual",
                    options: ["x + 5", "3x", "x - 7", "2x + 4"],
                    explanation: `"${t.phrase}" translates to ${t.expr}` };
            }
        },
        "Surface Area": () => {
            const type = pick(["cube", "rectangular_prism", "cylinder"]);
            if (type === "cube") {
                const s = rand(2, 6);
                const sa = 6 * s * s;
                return { question: `Find the surface area of a cube with side length ${s}.`, answer: sa, type: "procedural",
                    explanation: `SA = 6s² = 6 × ${s}² = 6 × ${s*s} = ${sa}` };
            } else if (type === "rectangular_prism") {
                const l = rand(3, 6), w = rand(2, 5), h = rand(2, 4);
                const sa = 2 * (l*w + l*h + w*h);
                return { question: `Surface area of a box: length=${l}, width=${w}, height=${h}?`, answer: sa, type: "procedural",
                    explanation: `SA = 2(lw + lh + wh) = 2(${l*w} + ${l*h} + ${w*h}) = 2(${l*w + l*h + w*h}) = ${sa}` };
            } else {
                const r = rand(2, 5), h = rand(3, 8);
                const sa = Math.round(2 * Math.PI * r * (r + h));
                return { question: `Surface area of cylinder: radius=${r}, height=${h}? (Round to nearest whole, use π≈3.14)`, answer: sa, type: "procedural",
                    explanation: `SA = 2πr(r+h) = 2×3.14×${r}×${r+h} ≈ ${sa}` };
            }
        },
        "Two-Way Tables": () => {
            const type = pick(["read", "total", "relative"]);
            const a = rand(10, 25), b = rand(15, 30), c = rand(12, 22), d = rand(8, 18);
            if (type === "read") {
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. How many boys like sports?`,
                    answer: a, type: "conceptual",
                    explanation: `Read directly from the table: Boys who like Sports = ${a}` };
            } else if (type === "total") {
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. Total boys?`,
                    answer: a + b, type: "procedural",
                    explanation: `Total boys = ${a} + ${b} = ${a + b}` };
            } else {
                const total = a + b + c + d;
                const pct = Math.round((a / total) * 100);
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. What percent are boys who like sports?`,
                    answer: pct, type: "procedural",
                    explanation: `Total = ${total}. Boys-Sports/Total = ${a}/${total} = ${pct}%` };
            }
        },
        "Scatter Plots": () => {
            const type = pick(["correlation", "trend", "outlier"]);
            if (type === "correlation") {
                const corr = pick(["positive", "negative", "none"]);
                const desc = corr === "positive" ? "points go up from left to right" :
                            corr === "negative" ? "points go down from left to right" :
                            "points are scattered randomly";
                return { question: `A scatter plot shows ${desc}. What type of correlation?`, answer: corr, type: "conceptual",
                    options: ["positive", "negative", "none"],
                    explanation: `When ${desc}, the correlation is ${corr}.` };
            } else if (type === "trend") {
                const scenarios = [
                    { desc: "hours studied vs. test score", trend: "positive" },
                    { desc: "temperature vs. hot chocolate sales", trend: "negative" },
                    { desc: "age vs. height (for children)", trend: "positive" },
                    { desc: "price vs. quantity demanded", trend: "negative" }
                ];
                const s = pick(scenarios);
                return { question: `What correlation would you expect: ${s.desc}?`, answer: s.trend, type: "reasoning",
                    options: ["positive", "negative", "none"],
                    explanation: `${s.desc} shows a ${s.trend} correlation.` };
            } else {
                const points = [[2, 3], [3, 5], [4, 6], [5, 8], [6, 9], [4, 20]];
                return { question: `Points: (2,3), (3,5), (4,6), (5,8), (6,9), (4,20). Which is the outlier?`, answer: "(4, 20)", type: "conceptual",
                    options: ["(2, 3)", "(4, 6)", "(4, 20)", "(6, 9)"],
                    explanation: `(4, 20) is far from the pattern of other points, making it an outlier.` };
            }
        },
        "Box Plots": () => {
            const type = pick(["identify", "IQR", "compare"]);
            const data = [12, 15, 18, 22, 25, 28, 30, 35, 40];
            const min = data[0], q1 = data[2], median = data[4], q3 = data[6], max = data[8];
            if (type === "identify") {
                const part = pick(["minimum", "Q1", "median", "Q3", "maximum"]);
                const values = { minimum: min, Q1: q1, median: median, Q3: q3, maximum: max };
                return { question: `Data: ${data.join(", ")}. What is the ${part}?`, answer: values[part], type: "procedural",
                    explanation: `${part} = ${values[part]}. Min=${min}, Q1=${q1}, Med=${median}, Q3=${q3}, Max=${max}` };
            } else if (type === "IQR") {
                const iqr = q3 - q1;
                return { question: `Data: ${data.join(", ")}. What is the IQR (Interquartile Range)?`, answer: iqr, type: "procedural",
                    explanation: `IQR = Q3 - Q1 = ${q3} - ${q1} = ${iqr}` };
            } else {
                const range = max - min;
                return { question: `Data: ${data.join(", ")}. What is the range?`, answer: range, type: "procedural",
                    explanation: `Range = Max - Min = ${max} - ${min} = ${range}` };
            }
        },
        "Probability Basics": () => {
            const type = pick(["simple", "complement", "word"]);
            if (type === "simple") {
                const favorable = rand(1, 5), total = favorable + rand(2, 6);
                return { question: `A bag has ${favorable} red and ${total - favorable} blue marbles. P(red)?`, answer: `${favorable}/${total}`, type: "procedural",
                    options: [`${favorable}/${total}`, `${total - favorable}/${total}`, `${favorable}/${total - favorable}`, `1/${total}`],
                    explanation: `P(red) = favorable/total = ${favorable}/${total}` };
            } else if (type === "complement") {
                const pct = rand(20, 80);
                const complement = 100 - pct;
                return { question: `If P(rain) = ${pct}%, what is P(no rain)?`, answer: `${complement}%`, type: "procedural",
                    options: [`${complement}%`, `${pct}%`, `${100 - complement}%`, `${pct / 2}%`],
                    explanation: `P(no rain) = 100% - P(rain) = 100% - ${pct}% = ${complement}%` };
            } else {
                const dice = rand(1, 6);
                return { question: `Roll a fair die. What is P(rolling a ${dice})?`, answer: "1/6", type: "conceptual",
                    options: ["1/6", "1/3", "1/2", "6/6"],
                    explanation: `Each number 1-6 has equal chance: P(${dice}) = 1/6` };
            }
        },
        "Irrational Numbers": () => {
            const type = pick(["identify", "approximate", "compare", "classify"]);
            if (type === "identify") {
                const irrational = pick(["√2", "√3", "√5", "π", "√7"]);
                return { question: `Is ${irrational} rational or irrational?`, answer: "Irrational", type: "conceptual",
                    options: ["Rational", "Irrational"],
                    explanation: `${irrational} cannot be written as a fraction of integers, so it's irrational.` };
            } else if (type === "approximate") {
                const roots = { 2: 1.414, 3: 1.732, 5: 2.236, 7: 2.646, 10: 3.162 };
                const n = pick([2, 3, 5, 7, 10]);
                return { question: `Approximate √${n} to 3 decimal places.`, answer: roots[n], type: "procedural",
                    options: [roots[n], roots[n] + 0.1, roots[n] - 0.1, n / 2],
                    explanation: `√${n} ≈ ${roots[n]}` };
            } else if (type === "compare") {
                const a = rand(2, 4);
                const b = rand(a + 1, a + 3);
                const sqrtA = Math.sqrt(a);
                const larger = sqrtA > b / 2 ? `√${a}` : `${b}/2`;
                return { question: `Which is larger: √${a} or ${b}/2?`, answer: larger, type: "reasoning",
                    options: [`√${a}`, `${b}/2`],
                    explanation: `√${a} ≈ ${sqrtA.toFixed(2)}, ${b}/2 = ${b / 2}. ${larger} is larger.` };
            } else {
                const nums = [
                    { num: "0.333...", type: "Rational" },
                    { num: "0.141421356...", type: "Irrational" },
                    { num: "3/7", type: "Rational" },
                    { num: "π", type: "Irrational" },
                    { num: "√16", type: "Rational" },
                    { num: "√15", type: "Irrational" }
                ];
                const n = pick(nums);
                return { question: `Classify: ${n.num}`, answer: n.type, type: "conceptual",
                    options: ["Rational", "Irrational"],
                    explanation: n.type === "Rational" ? `${n.num} can be written as a fraction.` : `${n.num} has a non-repeating, non-terminating decimal.` };
            }
        },
        "Cube Roots": () => {
            const type = pick(["perfect", "estimate", "negative"]);
            if (type === "perfect") {
                const cubes = [1, 8, 27, 64, 125, 216];
                const roots = [1, 2, 3, 4, 5, 6];
                const idx = rand(0, 5);
                return { question: `What is ∛${cubes[idx]}?`, answer: roots[idx], type: "procedural",
                    options: [roots[idx], roots[idx] + 1, roots[idx] - 1, cubes[idx] / 3].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `∛${cubes[idx]} = ${roots[idx]} because ${roots[idx]}³ = ${cubes[idx]}` };
            } else if (type === "estimate") {
                const root = rand(2, 4);
                const cube = root * root * root;
                const between = cube + rand(1, root * root);
                return { question: `Between which integers is ∛${between}?`, answer: `${root} and ${root + 1}`, type: "reasoning",
                    options: [`${root} and ${root + 1}`, `${root - 1} and ${root}`, `${root + 1} and ${root + 2}`, `1 and 2`],
                    explanation: `${root}³ = ${cube}, ${root + 1}³ = ${(root + 1) ** 3}. Since ${cube} < ${between} < ${(root + 1) ** 3}, ∛${between} is between ${root} and ${root + 1}.` };
            } else {
                const root = rand(2, 4);
                const cube = root * root * root;
                return { question: `What is ∛-${cube}?`, answer: -root, type: "procedural",
                    options: [-root, root, -cube, cube / root],
                    explanation: `∛-${cube} = -${root} because (-${root})³ = -${cube}` };
            }
        },
        "Compound Probability": () => {
            const type = pick(["and_independent", "or_mutually_exclusive", "with_replacement", "without_replacement"]);
            if (type === "and_independent") {
                const p1 = pick([1, 2, 3]);
                const p2 = pick([1, 2, 3]);
                const d = 6;
                return { question: `Two dice are rolled. P(first shows ${p1} AND second shows ${p2})?`, answer: `1/${d * d}`, type: "procedural",
                    options: [`1/${d * d}`, `2/${d}`, `1/${d}`, `${p1 + p2}/${d * d}`],
                    explanation: `P(A and B) = P(A) × P(B) = 1/${d} × 1/${d} = 1/${d * d}` };
            } else if (type === "or_mutually_exclusive") {
                const n1 = rand(1, 3), n2 = rand(4, 6);
                return { question: `Roll a die. P(${n1} OR ${n2})?`, answer: "2/6", type: "procedural",
                    options: ["2/6", "1/6", "1/36", "12/6"],
                    explanation: `P(A or B) = P(A) + P(B) = 1/6 + 1/6 = 2/6 = 1/3` };
            } else if (type === "with_replacement") {
                const red = rand(2, 4), blue = rand(2, 4);
                const total = red + blue;
                return { question: `Bag: ${red} red, ${blue} blue. Draw one, replace, draw again. P(both red)?`, answer: `${red * red}/${total * total}`, type: "procedural",
                    options: [`${red * red}/${total * total}`, `${red}/${total}`, `${red * (red - 1)}/${total * (total - 1)}`, `${2 * red}/${2 * total}`],
                    explanation: `With replacement: P(red, red) = ${red}/${total} × ${red}/${total} = ${red * red}/${total * total}` };
            } else {
                const red = 3, blue = 2;
                const total = red + blue;
                return { question: `Bag: ${red} red, ${blue} blue. Draw two without replacing. P(both red)?`, answer: `${red * (red - 1)}/${total * (total - 1)}`, type: "procedural",
                    options: [`${red * (red - 1)}/${total * (total - 1)}`, `${red * red}/${total * total}`, `${red}/${total}`, `2/${total}`],
                    explanation: `Without replacement: P = ${red}/${total} × ${red - 1}/${total - 1} = ${red * (red - 1)}/${total * (total - 1)}` };
            }
        },
        "Sampling Methods": () => {
            const type = pick(["identify", "bias", "best_method"]);
            const methods = [
                { name: "Simple Random", desc: "Every member has equal chance of being selected" },
                { name: "Stratified", desc: "Population divided into groups, samples taken from each" },
                { name: "Systematic", desc: "Select every nth member from a list" },
                { name: "Convenience", desc: "Use easily available members (often biased)" }
            ];
            if (type === "identify") {
                const method = pick(methods);
                return { question: `"${method.desc}" describes which sampling method?`, answer: method.name, type: "conceptual",
                    options: methods.map(m => m.name),
                    explanation: `${method.name} sampling: ${method.desc}` };
            } else if (type === "bias") {
                const scenarios = [
                    { scenario: "Survey only honors students about school satisfaction", biased: true, reason: "Only surveys high-achieving students" },
                    { scenario: "Randomly select 100 names from all student IDs", biased: false, reason: "Every student has equal chance" },
                    { scenario: "Ask people leaving a gym about exercise habits", biased: true, reason: "Only surveys gym-goers" }
                ];
                const s = pick(scenarios);
                return { question: `Is this sampling biased? "${s.scenario}"`, answer: s.biased ? "Yes" : "No", type: "reasoning",
                    options: ["Yes", "No"],
                    explanation: s.biased ? `Biased: ${s.reason}` : `Unbiased: ${s.reason}` };
            } else {
                const situations = [
                    { situation: "Survey opinions of all school grades", best: "Stratified", reason: "Sample from each grade ensures representation" },
                    { situation: "Quality check every 10th item on assembly line", best: "Systematic", reason: "Regular intervals for consistent checking" },
                    { situation: "Select lottery winners", best: "Simple Random", reason: "Everyone must have equal chance" }
                ];
                const s = pick(situations);
                return { question: `Best sampling method for: "${s.situation}"?`, answer: s.best, type: "reasoning",
                    options: methods.map(m => m.name),
                    explanation: `${s.best}: ${s.reason}` };
            }
        },
        "Transformations": () => {
            const type = pick(["translation", "reflection", "rotation", "identify"]);
            if (type === "translation") {
                const dx = rand(-5, 5), dy = rand(-5, 5);
                const x = rand(0, 5), y = rand(0, 5);
                return { question: `Point (${x}, ${y}) is translated ${dx > 0 ? "right" : "left"} ${Math.abs(dx)} and ${dy > 0 ? "up" : "down"} ${Math.abs(dy)}. New coordinates?`,
                    answer: `(${x + dx}, ${y + dy})`, type: "procedural",
                    options: [`(${x + dx}, ${y + dy})`, `(${x - dx}, ${y - dy})`, `(${x + dy}, ${y + dx})`, `(${dx}, ${dy})`],
                    explanation: `(${x} + ${dx}, ${y} + ${dy}) = (${x + dx}, ${y + dy})` };
            } else if (type === "reflection") {
                const x = rand(1, 5), y = rand(1, 5);
                const axis = pick(["x-axis", "y-axis"]);
                const newCoord = axis === "x-axis" ? `(${x}, ${-y})` : `(${-x}, ${y})`;
                return { question: `Reflect (${x}, ${y}) over the ${axis}. New coordinates?`, answer: newCoord, type: "procedural",
                    options: [`(${x}, ${-y})`, `(${-x}, ${y})`, `(${-x}, ${-y})`, `(${y}, ${x})`],
                    explanation: `Reflection over ${axis}: ${axis === "x-axis" ? "y changes sign" : "x changes sign"}. New point: ${newCoord}` };
            } else if (type === "rotation") {
                const x = rand(1, 4), y = rand(1, 4);
                const degrees = pick([90, 180, 270]);
                const rotations = {
                    90: `(${-y}, ${x})`,
                    180: `(${-x}, ${-y})`,
                    270: `(${y}, ${-x})`
                };
                return { question: `Rotate (${x}, ${y}) by ${degrees}° counterclockwise around the origin. New coordinates?`, answer: rotations[degrees], type: "procedural",
                    options: [rotations[90], rotations[180], rotations[270], `(${x}, ${y})`],
                    explanation: `${degrees}° rotation: (${x}, ${y}) → ${rotations[degrees]}` };
            } else {
                const transformations = [
                    { desc: "Slides a figure without changing size or orientation", name: "Translation" },
                    { desc: "Flips a figure over a line", name: "Reflection" },
                    { desc: "Turns a figure around a point", name: "Rotation" },
                    { desc: "Changes the size of a figure", name: "Dilation" }
                ];
                const t = pick(transformations);
                return { question: `"${t.desc}" describes which transformation?`, answer: t.name, type: "conceptual",
                    options: transformations.map(tr => tr.name),
                    explanation: `${t.name}: ${t.desc}` };
            }
        },
        "Similar Figures": () => {
            const type = pick(["identify", "find_side", "scale_factor", "perimeter"]);
            if (type === "identify") {
                const same = pick([true, false]);
                if (same) {
                    const ratio = pick([2, 3, 4]);
                    return { question: `Triangle A: 3, 4, 5. Triangle B: ${3 * ratio}, ${4 * ratio}, ${5 * ratio}. Are they similar?`, answer: "Yes", type: "conceptual",
                        options: ["Yes", "No"],
                        explanation: `All sides have the same ratio (1:${ratio}), so they are similar.` };
                } else {
                    return { question: `Triangle A: 3, 4, 5. Triangle B: 6, 8, 11. Are they similar?`, answer: "No", type: "conceptual",
                        options: ["Yes", "No"],
                        explanation: `Ratios: 3/6=0.5, 4/8=0.5, 5/11≈0.45. Not all equal, so not similar.` };
                }
            } else if (type === "find_side") {
                const scale = rand(2, 4);
                const a = rand(3, 6), b = rand(4, 8);
                const missing = a * scale;
                return { question: `Similar triangles. Small: ${a}, ${b}. Large: ?, ${b * scale}. Find the missing side.`, answer: missing, type: "procedural",
                    explanation: `Scale factor = ${b * scale}/${b} = ${scale}. Missing = ${a} × ${scale} = ${missing}` };
            } else if (type === "scale_factor") {
                const a1 = rand(2, 5), a2 = a1 * rand(2, 4);
                const scale = a2 / a1;
                return { question: `Similar rectangles. Small side: ${a1}. Large side: ${a2}. Scale factor?`, answer: scale, type: "procedural",
                    options: [scale, scale + 1, a2 - a1, a1 / a2],
                    explanation: `Scale factor = large/small = ${a2}/${a1} = ${scale}` };
            } else {
                const scale = rand(2, 3);
                const p1 = rand(10, 20);
                const p2 = p1 * scale;
                return { question: `Similar figures have scale factor ${scale}. If small perimeter = ${p1}, large perimeter = ?`, answer: p2, type: "procedural",
                    explanation: `Perimeters have the same scale factor. ${p1} × ${scale} = ${p2}` };
            }
        },
        "Parallel Lines and Transversals": () => {
            const type = pick(["corresponding", "alternate_interior", "same_side", "identify"]);
            if (type === "corresponding") {
                const angle = rand(40, 140);
                return { question: `Parallel lines cut by a transversal. One angle is ${angle}°. Its corresponding angle is?`, answer: `${angle}°`, type: "conceptual",
                    options: [`${angle}°`, `${180 - angle}°`, `${90 - angle}°`, `${angle + 90}°`],
                    explanation: `Corresponding angles are equal when lines are parallel. Both are ${angle}°.` };
            } else if (type === "alternate_interior") {
                const angle = rand(40, 140);
                return { question: `Parallel lines cut by a transversal. One alternate interior angle is ${angle}°. The other is?`, answer: `${angle}°`, type: "conceptual",
                    options: [`${angle}°`, `${180 - angle}°`, `${90}°`, `${angle / 2}°`],
                    explanation: `Alternate interior angles are equal. Both are ${angle}°.` };
            } else if (type === "same_side") {
                const angle = rand(40, 140);
                const supplement = 180 - angle;
                return { question: `Parallel lines cut by a transversal. One same-side interior angle is ${angle}°. The other is?`, answer: `${supplement}°`, type: "procedural",
                    options: [`${supplement}°`, `${angle}°`, `${90}°`, `${angle * 2}°`],
                    explanation: `Same-side interior angles are supplementary. ${angle}° + ${supplement}° = 180°` };
            } else {
                const pairs = [
                    { name: "Corresponding", property: "equal" },
                    { name: "Alternate Interior", property: "equal" },
                    { name: "Alternate Exterior", property: "equal" },
                    { name: "Same-Side Interior", property: "supplementary (sum to 180°)" }
                ];
                const pair = pick(pairs);
                return { question: `When parallel lines are cut by a transversal, ${pair.name} angles are...?`, answer: pair.property, type: "conceptual",
                    options: ["equal", "supplementary (sum to 180°)", "complementary (sum to 90°)", "vertical"],
                    explanation: `${pair.name} angles are ${pair.property}.` };
            }
        },
        "Volume of Cylinders Cones Spheres": () => {
            const type = pick(["cylinder", "cone", "sphere", "compare"]);
            if (type === "cylinder") {
                const r = rand(2, 5), h = rand(3, 8);
                const vol = Math.round(Math.PI * r * r * h * 100) / 100;
                return { question: `Cylinder: radius ${r}, height ${h}. Volume = ? (use π ≈ 3.14)`, answer: Math.round(3.14 * r * r * h * 100) / 100, type: "procedural",
                    explanation: `V = πr²h = 3.14 × ${r}² × ${h} = 3.14 × ${r * r} × ${h} = ${Math.round(3.14 * r * r * h * 100) / 100}` };
            } else if (type === "cone") {
                const r = rand(2, 4), h = rand(3, 6);
                const vol = Math.round(3.14 * r * r * h / 3 * 100) / 100;
                return { question: `Cone: radius ${r}, height ${h}. Volume = ? (use π ≈ 3.14)`, answer: vol, type: "procedural",
                    explanation: `V = (1/3)πr²h = (1/3) × 3.14 × ${r}² × ${h} = ${vol}` };
            } else if (type === "sphere") {
                const r = rand(2, 4);
                const vol = Math.round(4 / 3 * 3.14 * r * r * r * 100) / 100;
                return { question: `Sphere: radius ${r}. Volume = ? (use π ≈ 3.14)`, answer: vol, type: "procedural",
                    explanation: `V = (4/3)πr³ = (4/3) × 3.14 × ${r}³ = ${vol}` };
            } else {
                const r = rand(2, 3), h = r * 3;
                const vCyl = Math.round(3.14 * r * r * h);
                const vCone = Math.round(3.14 * r * r * h / 3);
                return { question: `Cylinder and cone have same radius (${r}) and height (${h}). Cylinder volume is how many times the cone volume?`, answer: 3, type: "reasoning",
                    options: [3, 2, 4, 1],
                    explanation: `Cylinder = πr²h, Cone = (1/3)πr²h. Cylinder is 3× the cone.` };
            }
        }
    },

    // TIER 5: Algebra I (8-9)
    5: {
        "Linear Equations": () => {
            const type = pick(["solve", "graph"]);
            if (type === "solve") {
                const x = rand(2, 10);
                const a = rand(2, 5), b = rand(3, 15);
                const c = a * x + b;
                return { question: `Solve: ${a}x + ${b} = ${c}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b}: ${a}x = ${c - b}. Divide by ${a}: x = ${(c-b)/a}` };
            } else {
                const m = pick([1, 2, -1, -2, 0.5]);
                const b = rand(-2, 3);
                return {
                    question: `What is the slope of this line?`,
                    answer: m, type: "conceptual",
                    options: [m, -m, b, m + 1].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `The line y = ${m}x + ${b} has slope ${m}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, lines: [{ equation: { m, b } }] } }
                };
            }
        },
        Systems: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'elimination': 'elimination',
                'substitution': 'substitution'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['5_Systems'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["elimination", "substitution"];
            }

            const x = rand(2, 8), y = rand(2, 8);
            const type = pick(availableTypes);

            if (type === "elimination") {
                return { question: `x + y = ${x + y} and x - y = ${x - y}. Find x.`, answer: x, type: "procedural",
                    explanation: `Add equations: 2x = ${2*x}, so x = ${x}` };
            } else {
                const a = rand(2, 4);
                return { question: `${a}x + y = ${a*x + y} and x = ${x}. Find y.`, answer: y, type: "procedural",
                    explanation: `Substitute x=${x}: ${a}(${x}) + y = ${a*x + y}. ${a*x} + y = ${a*x + y}. y = ${y}` };
            }
        },
        Factoring: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'trinomial': 'trinomial',
                'difference': 'difference'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['5_Factoring'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["trinomial", "difference"];
            }

            const type = pick(availableTypes);

            if (type === "trinomial") {
                const a = rand(1, 6), b = rand(1, 6);
                const sum = a + b, prod = a * b;
                return { question: `Factor: x² + ${sum}x + ${prod}`, answer: `(x+${a})(x+${b})`, type: "procedural",
                    options: [`(x+${a})(x+${b})`, `(x+${sum})(x+1)`, `(x-${a})(x-${b})`, `(x+${prod})(x+1)`],
                    explanation: `Find two numbers that multiply to ${prod} and add to ${sum}: ${a} and ${b}. Factor: (x+${a})(x+${b})` };
            } else {
                const a = rand(2, 8);
                return { question: `Factor: x² - ${a*a}`, answer: `(x+${a})(x-${a})`, type: "procedural",
                    options: [`(x+${a})(x-${a})`, `(x-${a})²`, `(x+${a})²`, `(x-${a*a})(x+1)`],
                    explanation: `Difference of squares: x² - ${a}² = (x+${a})(x-${a})` };
            }
        },
        Functions: () => {
            const a = rand(2, 5), b = rand(-5, 10);
            const x = rand(1, 6);
            const answer = a * x + b;
            return { question: `If f(x) = ${a}x ${b >= 0 ? '+' : ''} ${b}, what is f(${x})?`, answer, type: "procedural",
                explanation: `f(${x}) = ${a}(${x}) + ${b} = ${a*x} + ${b} = ${answer}` };
        },
        Inequalities: () => {
            const a = rand(2, 5), b = rand(5, 20);
            const boundary = b / a;
            const dir = pick(["<", ">", "≤", "≥"]);
            return { question: `Solve: ${a}x ${dir} ${b}`, answer: `x ${dir} ${boundary}`, type: "procedural",
                options: [`x ${dir} ${boundary}`, `x ${dir === '<' ? '>' : dir === '>' ? '<' : dir === '≤' ? '≥' : '≤'} ${boundary}`, `x ${dir} ${-boundary}`, `x ${dir} ${a}`],
                explanation: `Divide both sides by ${a}: x ${dir} ${boundary}` };
        },
        "Rational Functions": () => {
            const type = pick(["simplify", "domain", "asymptote"]);
            if (type === "simplify") {
                const a = rand(2, 6);
                return { question: `Simplify: ${a}x/(${a})`, answer: "x", type: "procedural",
                    options: ["x", `${a}x`, "1", `x/${a}`],
                    explanation: `${a}x/${a} = x (divide out common factor ${a})` };
            } else if (type === "domain") {
                const a = rand(2, 8);
                return { question: `For f(x) = 1/(x - ${a}), what value of x is NOT in the domain?`, answer: a, type: "conceptual",
                    explanation: `Cannot divide by zero. x - ${a} = 0 when x = ${a}. So x ≠ ${a}.` };
            } else {
                const a = rand(1, 5);
                return { question: `For f(x) = 1/(x - ${a}), what is the vertical asymptote?`, answer: `x = ${a}`, type: "conceptual",
                    options: [`x = ${a}`, `x = ${-a}`, `y = ${a}`, `y = 0`],
                    explanation: `Vertical asymptote where denominator = 0: x - ${a} = 0, so x = ${a}` };
            }
        },
        Radicals: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'simplify': 'simplify',
                'add': 'add',
                'multiply': 'multiply'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['5_Radicals'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["simplify", "add", "multiply"];
            }

            const type = pick(availableTypes);

            if (type === "simplify") {
                const outside = rand(2, 5), inside = rand(2, 7);
                const radicand = outside * outside * inside;
                return { question: `Simplify: √${radicand}`, answer: `${outside}√${inside}`, type: "procedural",
                    options: [`${outside}√${inside}`, `${inside}√${outside}`, `${outside * inside}`, `√${radicand}`],
                    explanation: `√${radicand} = √(${outside}² × ${inside}) = ${outside}√${inside}` };
            } else if (type === "add") {
                const coeff1 = rand(2, 5), coeff2 = rand(2, 5), inside = rand(2, 7);
                const sum = coeff1 + coeff2;
                return { question: `Simplify: ${coeff1}√${inside} + ${coeff2}√${inside}`, answer: `${sum}√${inside}`, type: "procedural",
                    options: [`${sum}√${inside}`, `${coeff1 * coeff2}√${inside}`, `${sum}√${inside * 2}`, `√${inside * sum}`],
                    explanation: `Like terms: (${coeff1} + ${coeff2})√${inside} = ${sum}√${inside}` };
            } else {
                const a = rand(2, 5), b = rand(2, 6);
                const product = a * b;
                return { question: `Simplify: √${a} × √${b}`, answer: `√${product}`, type: "procedural",
                    options: [`√${product}`, `√${a + b}`, `${a}√${b}`, `${b}√${a}`],
                    explanation: `√${a} × √${b} = √(${a} × ${b}) = √${product}` };
            }
        },
        "Exponential Functions": () => {
            const type = pick(["evaluate", "growth_decay", "identify"]);
            if (type === "evaluate") {
                const base = rand(2, 4), exp = rand(2, 4);
                const result = Math.pow(base, exp);
                return { question: `If f(x) = ${base}^x, find f(${exp}).`, answer: result, type: "procedural",
                    explanation: `f(${exp}) = ${base}^${exp} = ${result}` };
            } else if (type === "growth_decay") {
                const init = rand(100, 500), rate = rand(5, 20);
                const isGrowth = pick([true, false]);
                const factor = isGrowth ? 1 + rate/100 : 1 - rate/100;
                const years = 2;
                const final = Math.round(init * Math.pow(factor, years));
                return { question: `Initial value ${init}, ${isGrowth ? "growth" : "decay"} ${rate}% per year. Value after ${years} years?`, answer: final, type: "procedural",
                    explanation: `${init} × ${factor.toFixed(2)}^${years} = ${init} × ${Math.pow(factor, years).toFixed(3)} ≈ ${final}` };
            } else {
                const a = rand(2, 5);
                const isGrowth = pick([true, false]);
                const b = isGrowth ? 1 + rand(1, 5)/10 : rand(1, 9)/10;
                return { question: `y = ${a}(${b.toFixed(1)})^x represents growth or decay?`, answer: isGrowth ? "growth" : "decay", type: "conceptual",
                    options: ["growth", "decay"],
                    explanation: `Base ${b.toFixed(1)} is ${b > 1 ? "> 1, so growth" : "< 1, so decay"}` };
            }
        },
        "Arithmetic Sequences": () => {
            const type = pick(["find_term", "find_d", "formula"]);
            const a1 = rand(2, 10), d = rand(2, 6);
            if (type === "find_term") {
                const n = rand(5, 10);
                const an = a1 + (n - 1) * d;
                return { question: `Arithmetic sequence: first term ${a1}, common difference ${d}. Find the ${n}th term.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ + (n-1)d = ${a1} + (${n}-1)(${d}) = ${a1} + ${(n-1)*d} = ${an}` };
            } else if (type === "find_d") {
                const seq = [a1, a1 + d, a1 + 2*d, a1 + 3*d];
                return { question: `Find common difference: ${seq.join(", ")}, ...`, answer: d, type: "procedural",
                    explanation: `d = ${seq[1]} - ${seq[0]} = ${d}` };
            } else {
                const seq = [a1, a1 + d, a1 + 2*d];
                return { question: `Sequence: ${seq.join(", ")}, ... Write the formula for the nth term.`, answer: `${a1} + ${d}(n-1)`, type: "conceptual",
                    options: [`${a1} + ${d}(n-1)`, `${a1}n + ${d}`, `${d}n + ${a1}`, `${a1} × ${d}^(n-1)`],
                    explanation: `aₙ = a₁ + (n-1)d = ${a1} + ${d}(n-1)` };
            }
        },
        "Geometric Sequences": () => {
            const type = pick(["find_term", "find_r", "formula"]);
            const a1 = rand(2, 5), r = rand(2, 4);
            if (type === "find_term") {
                const n = rand(4, 6);
                const an = a1 * Math.pow(r, n - 1);
                return { question: `Geometric sequence: first term ${a1}, common ratio ${r}. Find the ${n}th term.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ × r^(n-1) = ${a1} × ${r}^${n-1} = ${a1} × ${Math.pow(r, n-1)} = ${an}` };
            } else if (type === "find_r") {
                const seq = [a1, a1 * r, a1 * r * r];
                return { question: `Find common ratio: ${seq.join(", ")}, ...`, answer: r, type: "procedural",
                    explanation: `r = ${seq[1]}/${seq[0]} = ${r}` };
            } else {
                return { question: `Geometric sequence with a₁ = ${a1} and r = ${r}. Which formula?`, answer: `${a1} × ${r}^(n-1)`, type: "conceptual",
                    options: [`${a1} × ${r}^(n-1)`, `${a1} + ${r}(n-1)`, `${a1}n × ${r}`, `${r} × ${a1}^(n-1)`],
                    explanation: `Geometric: aₙ = a₁ × r^(n-1) = ${a1} × ${r}^(n-1)` };
            }
        },
        "Compound Interest": () => {
            const type = pick(["annual", "multiple", "formula"]);
            const P = pick([100, 200, 500, 1000]);
            const r = pick([5, 6, 8, 10]);
            if (type === "annual") {
                const t = rand(1, 3);
                const A = Math.round(P * Math.pow(1 + r/100, t));
                return { question: `$${P} at ${r}% annual interest compounded yearly for ${t} year${t > 1 ? 's' : ''}. Final amount?`, answer: A, type: "procedural",
                    explanation: `A = P(1 + r)^t = ${P}(1.${r.toString().padStart(2, '0')})^${t} ≈ $${A}` };
            } else if (type === "multiple") {
                const n = pick([2, 4, 12]); // semiannual, quarterly, monthly
                const nName = n === 2 ? "semiannually" : n === 4 ? "quarterly" : "monthly";
                const t = 1;
                const A = Math.round(P * Math.pow(1 + r/(100*n), n*t));
                return { question: `$${P} at ${r}% compounded ${nName} for 1 year. Final amount?`, answer: A, type: "procedural",
                    explanation: `A = P(1 + r/n)^(nt) = ${P}(1 + ${r/100}/${n})^${n} ≈ $${A}` };
            } else {
                return { question: `Which formula calculates compound interest?`, answer: "A = P(1 + r/n)^(nt)", type: "conceptual",
                    options: ["A = P(1 + r/n)^(nt)", "A = P + Prt", "A = P × r × t", "A = P(1 + rt)"],
                    explanation: `Compound interest: A = P(1 + r/n)^(nt). Simple interest is A = P(1 + rt).` };
            }
        },
        "Domain and Range": () => {
            const type = pick(["linear", "quadratic", "rational"]);
            if (type === "linear") {
                const m = rand(-5, 5), b = rand(-10, 10);
                return { question: `What is the domain of f(x) = ${m}x + ${b}?`, answer: "all real numbers", type: "conceptual",
                    options: ["all real numbers", "x ≥ 0", "x ≤ 0", "x ≠ 0"],
                    explanation: `Linear functions have domain of all real numbers (no restrictions).` };
            } else if (type === "quadratic") {
                const a = pick([-1, 1, 2, -2]);
                const vertex = rand(-5, 5);
                const range = a > 0 ? `y ≥ ${vertex}` : `y ≤ ${vertex}`;
                return { question: `Parabola opens ${a > 0 ? "up" : "down"} with vertex at y = ${vertex}. What is the range?`, answer: range, type: "conceptual",
                    options: [`y ≥ ${vertex}`, `y ≤ ${vertex}`, "all real numbers", `y ≠ ${vertex}`],
                    explanation: `Opens ${a > 0 ? "up" : "down"} from vertex, so range is ${range}` };
            } else {
                const a = rand(1, 5);
                return { question: `What is the domain of f(x) = 1/(x - ${a})?`, answer: `x ≠ ${a}`, type: "conceptual",
                    options: [`x ≠ ${a}`, "all real numbers", `x ≥ ${a}`, `x > ${a}`],
                    explanation: `Cannot divide by 0. x - ${a} = 0 when x = ${a}, so x ≠ ${a}` };
            }
        },
        "Multi-Step Equations": () => {
            const type = pick(["two_step", "distribute", "variables_both_sides", "combine_like"]);
            const x = rand(2, 8);
            if (type === "two_step") {
                const a = rand(2, 5), b = rand(3, 10), c = a * x + b;
                return { question: `Solve: ${a}x + ${b} = ${c}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b}: ${a}x = ${c - b}. Divide by ${a}: x = ${x}` };
            } else if (type === "distribute") {
                const a = rand(2, 4), b = rand(1, 5), c = a * (x + b);
                return { question: `Solve: ${a}(x + ${b}) = ${c}`, answer: x, type: "procedural",
                    explanation: `Distribute: ${a}x + ${a * b} = ${c}. Subtract ${a * b}: ${a}x = ${c - a * b}. Divide: x = ${x}` };
            } else if (type === "variables_both_sides") {
                const a = rand(3, 6), b = rand(2, 4), c = rand(1, 10);
                const result = a * x + c;
                return { question: `Solve: ${a}x + ${c} = ${b}x + ${c + (a - b) * x}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b}x: ${a - b}x + ${c} = ${c + (a - b) * x}. Subtract ${c}: ${a - b}x = ${(a - b) * x}. x = ${x}` };
            } else {
                const a = rand(2, 4), b = rand(1, 3), c = rand(5, 15);
                const sum = (a + b) * x + c;
                return { question: `Solve: ${a}x + ${b}x + ${c} = ${sum}`, answer: x, type: "procedural",
                    explanation: `Combine like terms: ${a + b}x + ${c} = ${sum}. Subtract ${c}: ${a + b}x = ${sum - c}. x = ${x}` };
            }
        },
        "Literal Equations": () => {
            const type = pick(["solve_for_x", "formula", "rearrange"]);
            if (type === "solve_for_x") {
                const formulas = [
                    { eq: "ax + b = c", solve: "x", answer: "(c - b)/a", steps: "Subtract b: ax = c - b. Divide by a: x = (c - b)/a" },
                    { eq: "y = mx + b", solve: "x", answer: "(y - b)/m", steps: "Subtract b: y - b = mx. Divide by m: x = (y - b)/m" },
                    { eq: "A = lw", solve: "w", answer: "A/l", steps: "Divide both sides by l: w = A/l" }
                ];
                const f = pick(formulas);
                return { question: `Solve ${f.eq} for ${f.solve}.`, answer: f.answer, type: "procedural",
                    options: [f.answer, `${f.solve} + ${f.answer}`, f.answer.split("/").reverse().join("/"), "Cannot solve"],
                    explanation: f.steps };
            } else if (type === "formula") {
                const formulas = [
                    { name: "Perimeter of rectangle", eq: "P = 2l + 2w", solve: "l", answer: "(P - 2w)/2", opts: ["(P - 2w)/2", "P - 2w", "P/2 - w", "2P - w"] },
                    { name: "Area of triangle", eq: "A = ½bh", solve: "h", answer: "2A/b", opts: ["2A/b", "A/2b", "Ab/2", "A/(2b)"] },
                    { name: "Distance", eq: "d = rt", solve: "t", answer: "d/r", opts: ["d/r", "dr", "r/d", "d - r"] }
                ];
                const f = pick(formulas);
                return { question: `${f.name}: ${f.eq}. Solve for ${f.solve}.`, answer: f.answer, type: "procedural",
                    options: f.opts,
                    explanation: `Isolate ${f.solve}: ${f.solve} = ${f.answer}` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve for y: ${a}y - x = 0`, answer: `y = x/${a}`, type: "procedural",
                    options: [`y = x/${a}`, `y = ${a}x`, `y = x - ${a}`, `y = ${a}/x`],
                    explanation: `Add x: ${a}y = x. Divide by ${a}: y = x/${a}` };
            }
        },
        "Absolute Value Equations": () => {
            const type = pick(["basic", "with_constant", "no_solution"]);
            if (type === "basic") {
                const a = rand(2, 8);
                return { question: `Solve: |x| = ${a}`, answer: `x = ${a} or x = -${a}`, type: "procedural",
                    options: [`x = ${a} or x = -${a}`, `x = ${a}`, `x = -${a}`, "No solution"],
                    explanation: `|x| = ${a} means x = ${a} or x = -${a}` };
            } else if (type === "with_constant") {
                const a = rand(2, 6), b = rand(1, 5);
                const sol1 = a + b, sol2 = -a + b;
                return { question: `Solve: |x - ${b}| = ${a}`, answer: `x = ${sol1} or x = ${sol2}`, type: "procedural",
                    options: [`x = ${sol1} or x = ${sol2}`, `x = ${sol1}`, `x = ${sol2}`, "No solution"],
                    explanation: `x - ${b} = ${a} gives x = ${sol1}. x - ${b} = -${a} gives x = ${sol2}.` };
            } else {
                const a = rand(2, 8);
                return { question: `Solve: |x| = -${a}`, answer: "No solution", type: "conceptual",
                    options: [`x = ${a}`, `x = -${a}`, `x = ${a} or x = -${a}`, "No solution"],
                    explanation: `Absolute value cannot equal a negative number. No solution.` };
            }
        },
        "Graphing Linear Inequalities": () => {
            const type = pick(["boundary", "shading", "test_point", "system"]);
            if (type === "boundary") {
                const m = rand(1, 3), b = rand(-5, 5);
                const strict = pick([true, false]);
                const lineType = strict ? "dashed" : "solid";
                return { question: `For y ${strict ? "<" : "≤"} ${m}x + ${b}, the boundary line is...?`, answer: lineType, type: "conceptual",
                    options: ["dashed", "solid"],
                    explanation: `< or > uses dashed (not included). ≤ or ≥ uses solid (included). Answer: ${lineType}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, lines: [{ equation: { m, b }, dashed: strict }] } } };
            } else if (type === "shading") {
                const above = pick([true, false]);
                const symbol = above ? ">" : "<";
                const shade = above ? "above" : "below";
                return { question: `For y ${symbol} 2x + 1, shade...?`, answer: shade, type: "conceptual",
                    options: ["above", "below"],
                    explanation: `y ${symbol} means shade ${shade} the line.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, lines: [{ equation: { m: 2, b: 1 }, dashed: true }], shadeRegion: shade } } };
            } else if (type === "test_point") {
                const m = rand(1, 2), b = rand(1, 5);
                const testX = 0, testY = 0;
                const isSolution = testY < m * testX + b;
                return { question: `Is (0, 0) a solution to y < ${m}x + ${b}?`, answer: isSolution ? "Yes" : "No", type: "reasoning",
                    options: ["Yes", "No"],
                    explanation: `Test: 0 < ${m}(0) + ${b} → 0 < ${b}. ${isSolution ? "True" : "False"}, so ${isSolution ? "yes" : "no"}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, lines: [{ equation: { m, b }, dashed: true }], points: [{ x: 0, y: 0, label: '(0,0)', highlight: true }] } } };
            } else {
                return { question: `The solution to a system of linear inequalities is...?`, answer: "the overlapping shaded region", type: "conceptual",
                    options: ["the overlapping shaded region", "any shaded region", "the boundary lines", "a single point"],
                    explanation: `The solution is where all inequality regions overlap.` };
            }
        },
        "Systems by Graphing": () => {
            const x = rand(1, 5), y = rand(1, 5);
            const m1 = rand(1, 2), b1 = y - m1 * x;
            const m2 = rand(-2, -1), b2 = y - m2 * x;
            return { question: `Lines y = ${m1}x + ${b1} and y = ${m2}x + ${b2} intersect at...?`, answer: `(${x}, ${y})`, type: "procedural",
                options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${-x}, ${y})`, `(${x}, ${-y})`],
                explanation: `Set equal: ${m1}x + ${b1} = ${m2}x + ${b2}. Solve: x = ${x}. Then y = ${m1}(${x}) + ${b1} = ${y}. Point: (${x}, ${y})`,
                visual: { type: 'coordinate', mode: 'display', data: { xRange: [-2, 8], yRange: [-4, 8], gridStep: 1, lines: [{ equation: { m: m1, b: b1 } }, { equation: { m: m2, b: b2 }, secondary: true }], points: [{ x, y, label: '?' }] } } };
        },
        "Systems by Substitution": () => {
            const x = rand(2, 6), y = rand(1, 5);
            const a = rand(1, 3), b = rand(1, 3);
            return { question: `y = ${a}x - ${a * x - y} and ${b}x + y = ${b * x + y}. Find x using substitution.`, answer: x, type: "procedural",
                explanation: `Substitute first equation into second: ${b}x + (${a}x - ${a * x - y}) = ${b * x + y}. Solve for x = ${x}` };
        },
        "Systems by Elimination": () => {
            const x = rand(2, 5), y = rand(1, 4);
            const type = pick(["add", "subtract", "multiply"]);
            if (type === "add") {
                return { question: `x + y = ${x + y} and x - y = ${x - y}. Add equations to find x.`, answer: x, type: "procedural",
                    explanation: `Adding: 2x = ${2 * x}, so x = ${x}` };
            } else if (type === "subtract") {
                return { question: `2x + y = ${2 * x + y} and x + y = ${x + y}. Subtract to find x.`, answer: x, type: "procedural",
                    explanation: `Subtracting: x = ${x}` };
            } else {
                const a = 2;
                return { question: `${a}x + y = ${a * x + y} and x + y = ${x + y}. Find x.`, answer: x, type: "procedural",
                    explanation: `Subtract equations: ${a - 1}x = ${(a - 1) * x}, so x = ${x}` };
            }
        },
        "Correlation and Trend Lines": () => {
            const type = pick(["identify", "predict", "strength", "equation"]);
            if (type === "identify") {
                const correlations = [
                    { desc: "As x increases, y increases", type: "Positive" },
                    { desc: "As x increases, y decreases", type: "Negative" },
                    { desc: "No pattern between x and y", type: "None" }
                ];
                const c = pick(correlations);
                return { question: `"${c.desc}" describes what type of correlation?`, answer: c.type, type: "conceptual",
                    options: ["Positive", "Negative", "None"],
                    explanation: `${c.type} correlation: ${c.desc}` };
            } else if (type === "predict") {
                const m = rand(2, 5), b = rand(5, 20);
                const x = rand(5, 10);
                const y = m * x + b;
                return { question: `Trend line: y = ${m}x + ${b}. Predict y when x = ${x}.`, answer: y, type: "procedural",
                    explanation: `y = ${m}(${x}) + ${b} = ${m * x} + ${b} = ${y}` };
            } else if (type === "strength") {
                const r = pick([0.95, 0.75, 0.45, 0.15]);
                const strength = r > 0.8 ? "strong" : r > 0.5 ? "moderate" : "weak";
                return { question: `Correlation coefficient r = ${r}. How strong is the correlation?`, answer: strength, type: "conceptual",
                    options: ["strong", "moderate", "weak", "none"],
                    explanation: `|r| close to 1 = strong, close to 0 = weak. ${r} is ${strength}.` };
            } else {
                return { question: `A trend line that best fits scattered data is called the line of...?`, answer: "best fit", type: "conceptual",
                    options: ["best fit", "symmetry", "reflection", "slope"],
                    explanation: `The line of best fit minimizes distance to all points.` };
            }
        }
    },

    // TIER 6: Geometry (9-10)
    6: {
        Area: () => {
            const shape = pick(["rectangle", "triangle", "parallelogram"]);
            const a = rand(3, 12), b = rand(3, 12);
            let answer, explanation, question;
            if (shape === "rectangle") {
                answer = a * b;
                question = `Rectangle with length ${a} and width ${b}. Find area.`;
                explanation = `Area = length × width = ${a} × ${b} = ${answer}`;
            } else if (shape === "triangle") {
                answer = (a * b) / 2;
                question = `Triangle with base ${a} and height ${b}. Find area.`;
                explanation = `Area = ½ × base × height = ½ × ${a} × ${b} = ${answer}`;
            } else {
                answer = a * b;
                question = `Parallelogram with base ${a} and height ${b}. Find area.`;
                explanation = `Area = base × height = ${a} × ${b} = ${answer}`;
            }
            return { question, answer, type: "procedural", explanation };
        },
        Volume: () => {
            const shape = pick(["cube", "rectangular", "cylinder"]);
            if (shape === "cube") {
                const s = rand(2, 7);
                return { question: `Cube with side ${s}. Find volume.`, answer: s * s * s, type: "procedural",
                    explanation: `V = s³ = ${s}³ = ${s*s*s}` };
            } else if (shape === "rectangular") {
                const l = rand(2, 8), w = rand(2, 6), h = rand(2, 5);
                return { question: `Box with dimensions ${l} × ${w} × ${h}. Find volume.`, answer: l * w * h, type: "procedural",
                    explanation: `V = l × w × h = ${l} × ${w} × ${h} = ${l*w*h}` };
            } else {
                const r = rand(2, 5), h = rand(3, 8);
                return { question: `Cylinder: radius ${r}, height ${h}. Volume in terms of π?`, answer: `${r*r*h}π`, type: "procedural",
                    options: [`${r*r*h}π`, `${r*h}π`, `${2*r*r*h}π`, `${r*r}π`],
                    explanation: `V = πr²h = π(${r})²(${h}) = ${r*r*h}π` };
            }
        },
        Circles: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'area': 'area',
                'circumference': 'circumference'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['6_Circles'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                availableTypes = ["area", "circumference"]; // Fallback if none completed
            }

            const r = rand(2, 10);
            const type = pick(availableTypes);
            if (type === "area") {
                return { question: `Circle radius ${r}. Area in terms of π?`, answer: `${r*r}π`, type: "procedural",
                    options: [`${r*r}π`, `${2*r}π`, `${r}π`, `${2*r*r}π`],
                    explanation: `A = πr² = π(${r})² = ${r*r}π` };
            } else {
                return { question: `Circle radius ${r}. Circumference in terms of π?`, answer: `${2*r}π`, type: "procedural",
                    options: [`${2*r}π`, `${r*r}π`, `${r}π`, `${4*r}π`],
                    explanation: `C = 2πr = 2π(${r}) = ${2*r}π` };
            }
        },
        Triangles: () => {
            const type = pick(["congruence", "angles"]);
            if (type === "congruence") {
                const rules = ["SSS", "SAS", "ASA", "AAS"];
                const invalid = "AAA";
                const answer = invalid;
                return { question: `Which does NOT prove triangle congruence?`, answer, type: "conceptual",
                    options: shuffle([...rules.slice(0, 3), invalid]),
                    explanation: `AAA proves similarity, not congruence. The triangles could be different sizes.` };
            } else {
                const a = rand(30, 80), b = rand(30, 80);
                const c = 180 - a - b;
                return { question: `Triangle angles: ${a}° and ${b}°. Find third angle.`, answer: c, type: "procedural",
                    explanation: `Angles sum to 180°. Third = 180 - ${a} - ${b} = ${c}°` };
            }
        },
        Trigonometry: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'sin': 'sin',
                'cos': 'cos',
                'tan': 'tan'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['6_Trigonometry'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["sin", "cos", "tan"];
            }

            const triples = [[3,4,5], [5,12,13], [8,15,17]];
            const [opp, adj, hyp] = pick(triples);
            const func = pick(availableTypes);
            let answer, explanation;
            if (func === "sin") { answer = `${opp}/${hyp}`; explanation = `sin = opposite/hypotenuse = ${opp}/${hyp}`; }
            else if (func === "cos") { answer = `${adj}/${hyp}`; explanation = `cos = adjacent/hypotenuse = ${adj}/${hyp}`; }
            else { answer = `${opp}/${adj}`; explanation = `tan = opposite/adjacent = ${opp}/${adj}`; }
            return { question: `Right triangle: opposite=${opp}, adjacent=${adj}, hypotenuse=${hyp}. Find ${func}(θ).`, answer, type: "procedural",
                options: [`${opp}/${hyp}`, `${adj}/${hyp}`, `${opp}/${adj}`, `${hyp}/${opp}`], explanation };
        },
        Transformations: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'translate': 'translate',
                'reflect': 'reflect',
                'rotate': 'rotate',
                'dilate': 'dilate'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['6_Transformations'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                // Fallback: all types available if no sub-skill tracking
                availableTypes = ["translate", "reflect", "rotate", "dilate"];
            }

            const type = pick(availableTypes);

            if (type === "translate") {
                const x = rand(1, 5), y = rand(1, 5);
                const dx = rand(2, 6), dy = rand(2, 6);
                return { question: `Point (${x}, ${y}) translated right ${dx} and up ${dy}. New point?`, answer: `(${x + dx}, ${y + dy})`, type: "procedural",
                    options: [`(${x + dx}, ${y + dy})`, `(${x - dx}, ${y + dy})`, `(${x + dx}, ${y - dy})`, `(${x + dy}, ${y + dx})`],
                    explanation: `Right ${dx}: x + ${dx} = ${x + dx}. Up ${dy}: y + ${dy} = ${y + dy}. New point: (${x + dx}, ${y + dy})` };
            } else if (type === "reflect") {
                const x = rand(1, 8), y = rand(1, 8);
                const axis = pick(["x-axis", "y-axis"]);
                const newPoint = axis === "x-axis" ? `(${x}, ${-y})` : `(${-x}, ${y})`;
                return { question: `Point (${x}, ${y}) reflected over the ${axis}. New point?`, answer: newPoint, type: "procedural",
                    options: [`(${x}, ${-y})`, `(${-x}, ${y})`, `(${-x}, ${-y})`, `(${y}, ${x})`],
                    explanation: `Reflect over ${axis}: ${axis === "x-axis" ? "negate y" : "negate x"}. New point: ${newPoint}` };
            } else if (type === "rotate") {
                const x = rand(1, 5), y = rand(1, 5);
                return { question: `Point (${x}, ${y}) rotated 180° about origin. New point?`, answer: `(${-x}, ${-y})`, type: "procedural",
                    options: [`(${-x}, ${-y})`, `(${x}, ${-y})`, `(${-x}, ${y})`, `(${y}, ${x})`],
                    explanation: `180° rotation: negate both coordinates. (${x}, ${y}) → (${-x}, ${-y})` };
            } else {
                const x = rand(1, 4), y = rand(1, 4);
                const scale = rand(2, 3);
                return { question: `Point (${x}, ${y}) dilated by factor ${scale} from origin. New point?`, answer: `(${x * scale}, ${y * scale})`, type: "procedural",
                    options: [`(${x * scale}, ${y * scale})`, `(${x + scale}, ${y + scale})`, `(${x * scale}, ${y})`, `(${x}, ${y * scale})`],
                    explanation: `Dilation by ${scale}: multiply both coordinates. (${x}, ${y}) → (${x * scale}, ${y * scale})` };
            }
        },
        Similarity: () => {
            const type = pick(["ratio", "find_side", "identify"]);
            if (type === "ratio") {
                const small = rand(3, 8), large = small * rand(2, 4);
                return { question: `Similar triangles have sides ${small} and ${large}. Scale factor?`, answer: large / small, type: "procedural",
                    explanation: `Scale factor = ${large}/${small} = ${large / small}` };
            } else if (type === "find_side") {
                const s1 = rand(4, 8), s2 = rand(6, 12), scale = rand(2, 3);
                const x = s2 * scale;
                return { question: `Similar triangles: sides ${s1} and ${s2} match to ${s1 * scale} and x. Find x.`, answer: x, type: "procedural",
                    explanation: `Scale factor = ${s1 * scale}/${s1} = ${scale}. So x = ${s2} × ${scale} = ${x}` };
            } else {
                return { question: `Two triangles have angles 30°, 60°, 90° and 30°, 60°, 90°. Are they similar?`, answer: "Yes", type: "conceptual",
                    options: ["Yes", "No", "Need more info"],
                    explanation: `AA Similarity: If two angles are equal, triangles are similar.` };
            }
        },
        Congruence: () => {
            const type = pick(["postulate", "identify", "corresponding"]);
            if (type === "postulate") {
                const postulates = ["SSS", "SAS", "ASA", "AAS", "HL"];
                const post = pick(postulates);
                const descriptions = {
                    "SSS": "all three sides equal",
                    "SAS": "two sides and included angle equal",
                    "ASA": "two angles and included side equal",
                    "AAS": "two angles and non-included side equal",
                    "HL": "hypotenuse and leg of right triangles equal"
                };
                return { question: `Which postulate: ${descriptions[post]}?`, answer: post, type: "conceptual",
                    options: postulates,
                    explanation: `${post}: ${descriptions[post]}` };
            } else if (type === "identify") {
                const given = pick(["3 sides", "2 sides and included angle", "2 angles and 1 side"]);
                const answers = { "3 sides": "SSS", "2 sides and included angle": "SAS", "2 angles and 1 side": "ASA or AAS" };
                return { question: `Given: ${given}. Which congruence can you prove?`, answer: answers[given], type: "reasoning",
                    options: ["SSS", "SAS", "ASA or AAS", "Cannot prove"],
                    explanation: `With ${given}, use ${answers[given]} to prove congruence.` };
            } else {
                return { question: `If △ABC ≅ △DEF, which side corresponds to BC?`, answer: "EF", type: "conceptual",
                    options: ["DE", "EF", "DF", "FE"],
                    explanation: `Corresponding parts: A↔D, B↔E, C↔F. So BC↔EF.` };
            }
        },
        Proofs: () => {
            const type = pick(["reason", "statement", "property"]);
            if (type === "reason") {
                const reasons = [
                    { statement: "If a = b and b = c, then a = c", reason: "Transitive Property" },
                    { statement: "If a = b, then b = a", reason: "Symmetric Property" },
                    { statement: "a = a", reason: "Reflexive Property" },
                    { statement: "If a = b, then a + c = b + c", reason: "Addition Property of Equality" }
                ];
                const r = pick(reasons);
                return { question: `"${r.statement}" uses which property?`, answer: r.reason, type: "conceptual",
                    options: ["Transitive Property", "Symmetric Property", "Reflexive Property", "Addition Property of Equality"],
                    explanation: `${r.reason}: ${r.statement}` };
            } else if (type === "statement") {
                return { question: `If ∠A and ∠B are supplementary and m∠A = 70°, what can you conclude?`, answer: "m∠B = 110°", type: "reasoning",
                    options: ["m∠B = 110°", "m∠B = 70°", "m∠B = 90°", "m∠B = 180°"],
                    explanation: `Supplementary angles sum to 180°. So m∠B = 180° - 70° = 110°` };
            } else {
                return { question: `Vertical angles are always:`, answer: "congruent", type: "conceptual",
                    options: ["congruent", "supplementary", "complementary", "adjacent"],
                    explanation: `Vertical Angles Theorem: Vertical angles are congruent.` };
            }
        },
        "Law of Sines": () => {
            const type = pick(["find_side", "find_angle", "formula"]);
            if (type === "formula") {
                return { question: `The Law of Sines states:`, answer: "a/sin(A) = b/sin(B) = c/sin(C)", type: "conceptual",
                    options: ["a/sin(A) = b/sin(B) = c/sin(C)", "a² + b² = c²", "a/b = c/d", "sin²(A) + cos²(A) = 1"],
                    explanation: `Law of Sines: a/sin(A) = b/sin(B) = c/sin(C)` };
            } else if (type === "find_side") {
                const A = 30, B = 60, a = 5;
                const b = Math.round(a * Math.sin(B * Math.PI/180) / Math.sin(A * Math.PI/180));
                return { question: `Triangle: A=30°, B=60°, a=5. Find b using Law of Sines.`, answer: b, type: "procedural",
                    explanation: `b/sin(60°) = 5/sin(30°) → b = 5 × sin(60°)/sin(30°) ≈ ${b}` };
            } else {
                return { question: `When do you use Law of Sines?`, answer: "When you know AAS, ASA, or SSA", type: "conceptual",
                    options: ["When you know AAS, ASA, or SSA", "When you know SAS", "When you know SSS", "Only for right triangles"],
                    explanation: `Law of Sines is used when you have angle-side pairs (AAS, ASA, SSA).` };
            }
        },
        "Law of Cosines": () => {
            const type = pick(["formula", "find_side", "when_to_use"]);
            if (type === "formula") {
                return { question: `Law of Cosines formula for side c:`, answer: "c² = a² + b² - 2ab·cos(C)", type: "conceptual",
                    options: ["c² = a² + b² - 2ab·cos(C)", "c² = a² + b²", "c = a + b", "c² = a² + b² + 2ab·cos(C)"],
                    explanation: `Law of Cosines: c² = a² + b² - 2ab·cos(C)` };
            } else if (type === "find_side") {
                const a = 5, b = 7, C = 60;
                const c = Math.round(Math.sqrt(a*a + b*b - 2*a*b*Math.cos(C * Math.PI/180)));
                return { question: `Triangle: a=5, b=7, C=60°. Find c using Law of Cosines.`, answer: c, type: "procedural",
                    explanation: `c² = 25 + 49 - 2(5)(7)cos(60°) = 74 - 35 = 39. c ≈ ${c}` };
            } else {
                return { question: `When do you use Law of Cosines?`, answer: "When you know SAS or SSS", type: "conceptual",
                    options: ["When you know SAS or SSS", "When you know AAS", "When you know ASA", "Only for right triangles"],
                    explanation: `Law of Cosines is used for SAS (find third side) or SSS (find an angle).` };
            }
        },
        "Coordinate Geometry": () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'midpoint': 'midpoint',
                'distance': 'distance',
                'slope': 'slope'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['6_Coordinate Geometry'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                availableTypes = ["midpoint", "distance", "slope"]; // Fallback
            }

            const type = pick(availableTypes);
            if (type === "midpoint") {
                const x1 = rand(2, 10), y1 = rand(2, 10), x2 = rand(2, 10), y2 = rand(2, 10);
                const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
                return { question: `Midpoint of (${x1}, ${y1}) and (${x2}, ${y2})?`, answer: `(${mx}, ${my})`, type: "procedural",
                    options: [`(${mx}, ${my})`, `(${(x1+x2)}, ${(y1+y2)})`, `(${x2-x1}, ${y2-y1})`, `(${Math.abs(x1-x2)}, ${Math.abs(y1-y2)})`],
                    explanation: `Midpoint = ((${x1}+${x2})/2, (${y1}+${y2})/2) = (${mx}, ${my})` };
            } else if (type === "distance") {
                const x1 = rand(1, 5), y1 = rand(1, 5), x2 = x1 + rand(3, 6), y2 = y1 + rand(3, 6);
                const dx = x2 - x1, dy = y2 - y1;
                const dist = Math.sqrt(dx*dx + dy*dy).toFixed(2);
                return { question: `Distance from (${x1}, ${y1}) to (${x2}, ${y2})?`, answer: parseFloat(dist), type: "procedural",
                    explanation: `d = √[(${x2}-${x1})² + (${y2}-${y1})²] = √[${dx}² + ${dy}²] = √${dx*dx + dy*dy} ≈ ${dist}` };
            } else {
                const x1 = rand(1, 5), y1 = rand(1, 5), x2 = x1 + rand(2, 5), y2 = y1 + rand(2, 8);
                const slope = (y2 - y1) / (x2 - x1);
                return { question: `Slope of line through (${x1}, ${y1}) and (${x2}, ${y2})?`, answer: parseFloat(slope.toFixed(2)), type: "procedural",
                    explanation: `m = (${y2}-${y1})/(${x2}-${x1}) = ${y2-y1}/${x2-x1} = ${slope.toFixed(2)}` };
            }
        },
        "Angle Bisectors": () => {
            const type = pick(["definition", "property", "calculate"]);
            if (type === "definition") {
                return { question: `An angle bisector divides an angle into...?`, answer: "two equal parts", type: "conceptual",
                    options: ["two equal parts", "two unequal parts", "a right angle", "three parts"],
                    explanation: `An angle bisector splits an angle into two congruent angles.` };
            } else if (type === "property") {
                return { question: `Points on an angle bisector are equidistant from the...?`, answer: "sides of the angle", type: "conceptual",
                    options: ["sides of the angle", "vertex", "opposite side", "other angles"],
                    explanation: `Any point on an angle bisector is equally far from both sides of the angle.` };
            } else {
                const angle = rand(4, 16) * 10;
                const half = angle / 2;
                return { question: `An angle bisector splits a ${angle}° angle. Each part measures...?`, answer: `${half}°`, type: "procedural",
                    options: [`${half}°`, `${angle}°`, `${angle * 2}°`, `${90 - half}°`],
                    explanation: `${angle}° ÷ 2 = ${half}°` };
            }
        },
        "Perpendicular Bisectors": () => {
            const type = pick(["definition", "property", "find_point"]);
            if (type === "definition") {
                return { question: `A perpendicular bisector of a segment...?`, answer: "passes through the midpoint at 90°", type: "conceptual",
                    options: ["passes through the midpoint at 90°", "passes through an endpoint", "is parallel to the segment", "bisects an angle"],
                    explanation: `A perpendicular bisector passes through the midpoint and forms a 90° angle with the segment.` };
            } else if (type === "property") {
                return { question: `Points on the perpendicular bisector of AB are equidistant from...?`, answer: "A and B", type: "conceptual",
                    options: ["A and B", "the midpoint only", "the origin", "the x-axis"],
                    explanation: `Any point on the perpendicular bisector is equally far from both endpoints.` };
            } else {
                const x1 = 0, y1 = 0, x2 = rand(2, 6) * 2, y2 = 0;
                const midX = (x1 + x2) / 2;
                return { question: `Segment from (${x1}, ${y1}) to (${x2}, ${y2}). Perpendicular bisector passes through...?`, answer: `(${midX}, any y)`, type: "reasoning",
                    options: [`(${midX}, any y)`, `(${x2}, 0)`, `(0, ${midX})`, `(${x1}, ${y1})`],
                    explanation: `Midpoint is (${midX}, 0). Perpendicular bisector is vertical line x = ${midX}.` };
            }
        },
        "Triangle Inequality": () => {
            const type = pick(["valid", "find_range", "identify"]);
            if (type === "valid") {
                const a = rand(3, 8), b = rand(3, 8);
                const valid = rand(Math.abs(a - b) + 1, a + b - 1);
                const invalid = a + b + rand(1, 3);
                const testC = pick([valid, invalid]);
                const isValid = testC < a + b && testC > Math.abs(a - b);
                return { question: `Can a triangle have sides ${a}, ${b}, ${testC}?`, answer: isValid ? "Yes" : "No", type: "reasoning",
                    options: ["Yes", "No"],
                    explanation: isValid ?
                        `Yes! ${a} + ${b} = ${a + b} > ${testC}, and ${a} + ${testC} > ${b}, and ${b} + ${testC} > ${a}.` :
                        `No! ${a} + ${b} = ${a + b} is not greater than ${testC}. Violates triangle inequality.` };
            } else if (type === "find_range") {
                const a = rand(4, 8), b = rand(3, 6);
                const min = Math.abs(a - b) + 1;
                const max = a + b - 1;
                return { question: `Sides ${a} and ${b}. Third side must be between...?`, answer: `${min} and ${max}`, type: "procedural",
                    options: [`${min} and ${max}`, `1 and ${a + b}`, `${a} and ${b}`, `0 and ${a * b}`],
                    explanation: `Third side c: |${a} - ${b}| < c < ${a} + ${b}, so ${Math.abs(a-b)} < c < ${a + b}. Range: ${min} to ${max}.` };
            } else {
                return { question: `Triangle Inequality Theorem states:`, answer: "sum of any two sides > third side", type: "conceptual",
                    options: ["sum of any two sides > third side", "all sides must be equal", "angles sum to 180°", "largest angle opposite longest side"],
                    explanation: `The sum of any two sides must be greater than the third side.` };
            }
        },
        "Triangle Centers": () => {
            const centers = [
                { name: "Centroid", formed: "medians", property: "center of gravity, divides medians 2:1" },
                { name: "Incenter", formed: "angle bisectors", property: "equidistant from all three sides" },
                { name: "Circumcenter", formed: "perpendicular bisectors", property: "equidistant from all three vertices" },
                { name: "Orthocenter", formed: "altitudes", property: "where all altitudes meet" }
            ];
            const center = pick(centers);
            const type = pick(["identify", "property"]);
            if (type === "identify") {
                return { question: `The ${center.name} is formed by the intersection of...?`, answer: center.formed, type: "conceptual",
                    options: ["medians", "angle bisectors", "perpendicular bisectors", "altitudes"],
                    explanation: `${center.name}: intersection of ${center.formed}.` };
            } else {
                return { question: `The ${center.name} of a triangle is...?`, answer: center.property, type: "conceptual",
                    options: centers.map(c => c.property),
                    explanation: `${center.name}: ${center.property}.` };
            }
        },
        "Midsegments": () => {
            const type = pick(["triangle", "length", "parallel"]);
            if (type === "triangle") {
                return { question: `A midsegment of a triangle connects...?`, answer: "midpoints of two sides", type: "conceptual",
                    options: ["midpoints of two sides", "a vertex to the opposite side", "two vertices", "the centroid to a vertex"],
                    explanation: `A midsegment connects the midpoints of two sides of a triangle.` };
            } else if (type === "length") {
                const base = rand(6, 16);
                const mid = base / 2;
                return { question: `Triangle base = ${base}. The midsegment parallel to it = ?`, answer: mid, type: "procedural",
                    options: [mid, base, base * 2, mid + 1],
                    explanation: `Midsegment = ½ × parallel side = ½ × ${base} = ${mid}` };
            } else {
                return { question: `A midsegment is parallel to which side?`, answer: "the third side (not connected to it)", type: "conceptual",
                    options: ["the third side (not connected to it)", "the longest side", "the shortest side", "no side"],
                    explanation: `The midsegment is parallel to the side it doesn't touch.` };
            }
        },
        "Inscribed Angles": () => {
            const type = pick(["relationship", "calculate", "diameter"]);
            if (type === "relationship") {
                return { question: `An inscribed angle is _____ the central angle with the same arc.`, answer: "half", type: "conceptual",
                    options: ["half", "equal to", "twice", "unrelated to"],
                    explanation: `Inscribed Angle = ½ × Central Angle (same arc).` };
            } else if (type === "calculate") {
                const central = rand(4, 16) * 10;
                const inscribed = central / 2;
                return { question: `Central angle = ${central}°. Inscribed angle on same arc = ?`, answer: `${inscribed}°`, type: "procedural",
                    options: [`${inscribed}°`, `${central}°`, `${central * 2}°`, `${180 - central}°`],
                    explanation: `Inscribed = ½ × Central = ½ × ${central}° = ${inscribed}°` };
            } else {
                return { question: `An inscribed angle that intercepts a semicircle measures...?`, answer: "90°", type: "conceptual",
                    options: ["90°", "180°", "45°", "60°"],
                    explanation: `Semicircle = 180° arc. Inscribed angle = ½ × 180° = 90°.` };
            }
        },
        "Arc Length": () => {
            const r = rand(3, 10);
            const degrees = pick([30, 45, 60, 90, 120, 180]);
            const arcLength = (degrees / 360) * 2 * 3.14 * r;
            const type = pick(["formula", "calculate"]);
            if (type === "formula") {
                return { question: `Arc length formula (in degrees):`, answer: "(θ/360) × 2πr", type: "conceptual",
                    options: ["(θ/360) × 2πr", "πr²", "2πr", "θ × r"],
                    explanation: `Arc length = (central angle/360°) × circumference = (θ/360) × 2πr` };
            } else {
                return { question: `Circle radius ${r}, central angle ${degrees}°. Arc length ≈ ? (π ≈ 3.14)`, answer: Math.round(arcLength * 100) / 100, type: "procedural",
                    explanation: `Arc = (${degrees}/360) × 2(3.14)(${r}) = (${degrees}/360) × ${(2 * 3.14 * r).toFixed(2)} ≈ ${(arcLength).toFixed(2)}` };
            }
        },
        "Sector Area": () => {
            const r = rand(3, 8);
            const degrees = pick([30, 45, 60, 90, 120, 180]);
            const area = (degrees / 360) * 3.14 * r * r;
            const type = pick(["formula", "calculate"]);
            if (type === "formula") {
                return { question: `Sector area formula (in degrees):`, answer: "(θ/360) × πr²", type: "conceptual",
                    options: ["(θ/360) × πr²", "πr²", "2πr", "(θ/360) × 2πr"],
                    explanation: `Sector area = (central angle/360°) × circle area = (θ/360) × πr²` };
            } else {
                return { question: `Circle radius ${r}, central angle ${degrees}°. Sector area ≈ ? (π ≈ 3.14)`, answer: Math.round(area * 100) / 100, type: "procedural",
                    explanation: `Area = (${degrees}/360) × 3.14 × ${r}² = (${degrees}/360) × ${(3.14 * r * r).toFixed(2)} ≈ ${area.toFixed(2)}` };
            }
        },
        "Tangent Lines": () => {
            const type = pick(["property", "perpendicular", "two_tangents"]);
            if (type === "property") {
                return { question: `A tangent line touches a circle at how many points?`, answer: "exactly 1", type: "conceptual",
                    options: ["exactly 1", "exactly 2", "0", "infinitely many"],
                    explanation: `A tangent line touches a circle at exactly one point (point of tangency).` };
            } else if (type === "perpendicular") {
                return { question: `A tangent line is _____ to the radius at the point of tangency.`, answer: "perpendicular", type: "conceptual",
                    options: ["perpendicular", "parallel", "equal", "congruent"],
                    explanation: `The tangent is always perpendicular (90°) to the radius at the point of tangency.` };
            } else {
                return { question: `Two tangent segments from the same external point are...?`, answer: "congruent", type: "conceptual",
                    options: ["congruent", "perpendicular", "parallel", "complementary"],
                    explanation: `Tangent segments from an external point to a circle are always equal in length.` };
            }
        },
        "Dilations": () => {
            const type = pick(["identify", "calculate", "properties"]);
            if (type === "identify") {
                const k = pick([0.5, 2, 3]);
                const result = k > 1 ? "enlargement" : "reduction";
                return { question: `A dilation with scale factor ${k} produces a(n)...?`, answer: result, type: "conceptual",
                    options: ["enlargement", "reduction", "reflection", "rotation"],
                    explanation: `Scale factor > 1 = enlargement. Scale factor < 1 = reduction. ${k} gives ${result}.` };
            } else if (type === "calculate") {
                const x = rand(2, 6), y = rand(2, 6);
                const k = rand(2, 4);
                return { question: `Dilate (${x}, ${y}) by scale factor ${k} from origin. New point?`, answer: `(${x * k}, ${y * k})`, type: "procedural",
                    options: [`(${x * k}, ${y * k})`, `(${x + k}, ${y + k})`, `(${x - k}, ${y - k})`, `(${k}, ${k})`],
                    explanation: `Multiply each coordinate by k: (${x} × ${k}, ${y} × ${k}) = (${x * k}, ${y * k})` };
            } else {
                return { question: `Dilations preserve...?`, answer: "angle measures and shape", type: "conceptual",
                    options: ["angle measures and shape", "side lengths", "area", "perimeter"],
                    explanation: `Dilations create similar figures: same angles, proportional sides.` };
            }
        }
    },

    // TIER 7: Algebra II (10-11)
    7: {
        Quadratics: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'solve': 'solve',
                'vertex': 'vertex',
                'graph': 'graph'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['7_Quadratics'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                availableTypes = ["solve", "vertex", "graph"]; // Fallback
            }

            const type = pick(availableTypes);
            if (type === "solve") {
                const r1 = rand(1, 6), r2 = rand(1, 6);
                const b = -(r1 + r2), c = r1 * r2;
                return { question: `Solve: x² ${b >= 0 ? '+' : ''}${b}x + ${c} = 0`, answer: `x = ${r1}, ${r2}`, type: "procedural",
                    options: [`x = ${r1}, ${r2}`, `x = ${-r1}, ${-r2}`, `x = ${r1 + r2}, 0`, `x = ${c}, ${-b}`],
                    explanation: `Factor: (x - ${r1})(x - ${r2}) = 0. Solutions: x = ${r1} or x = ${r2}` };
            } else if (type === "vertex") {
                const h = rand(1, 4), k = rand(-3, 3);
                return {
                    question: `What is the vertex of this parabola?`,
                    answer: `(${h}, ${k})`, type: "conceptual",
                    options: [`(${h}, ${k})`, `(${-h}, ${k})`, `(${h}, ${-k})`, `(${-h}, ${-k})`],
                    explanation: `The vertex is the minimum/maximum point: (${h}, ${k})`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-2, 8], yRange: [-5, 5], gridStep: 1, curves: [{ type: 'quadratic', a: 1, b: -2*h, c: h*h + k }] } }
                };
            } else {
                const a = pick([1, -1]);
                const opens = a > 0 ? "up" : "down";
                return {
                    question: `Does this parabola open up or down?`,
                    answer: opens, type: "conceptual",
                    options: ["up", "down"],
                    explanation: `When a > 0, parabola opens up. When a < 0, it opens down.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, curves: [{ type: 'quadratic', a, b: 0, c: 0 }] } }
                };
            }
        },
        Logarithms: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'eval': 'eval',
                'property': 'property'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['7_Logarithms'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                availableTypes = ["eval", "property"]; // Fallback
            }

            const bases = [[2, 8, 3], [2, 16, 4], [3, 9, 2], [3, 27, 3], [10, 100, 2], [10, 1000, 3]];
            const [base, val, ans] = pick(bases);
            const type = pick(availableTypes);
            if (type === "eval") {
                return { question: `log${base === 10 ? '' : '₊'.replace('₊', base)}(${val}) = ?`, answer: ans, type: "procedural",
                    explanation: `${base}^? = ${val}. Since ${base}^${ans} = ${val}, answer is ${ans}` };
            } else {
                const a = rand(2, 5), b = rand(2, 5);
                return { question: `Simplify: log(${a * b}) using log(${a}) + log(${b})`, answer: `log(${a}) + log(${b})`, type: "conceptual",
                    options: [`log(${a}) + log(${b})`, `log(${a}) × log(${b})`, `log(${a + b})`, `${a} × log(${b})`],
                    explanation: `log(ab) = log(a) + log(b). So log(${a*b}) = log(${a}) + log(${b})` };
            }
        },
        Polynomials: () => {
            // Map sub-skill IDs to question types
            const subSkillToQuestionType = {
                'degree': 'degree',
                'add': 'add'
            };

            // Get completed sub-skills for this domain
            const completedSubSkills = state.completedSubSkills['7_Polynomials'] || [];

            // Determine available question types based on completed sub-skills
            let availableTypes;
            if (completedSubSkills.length > 0) {
                availableTypes = completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean);
            } else {
                availableTypes = ["degree", "add"]; // Fallback
            }

            const type = pick(availableTypes);
            if (type === "degree") {
                const deg = rand(2, 5);
                const terms = [`${rand(1,5)}x^${deg}`, `${rand(1,5)}x^${deg-1}`, `${rand(1,5)}`].join(" + ");
                return { question: `Degree of ${terms}?`, answer: deg, type: "conceptual",
                    explanation: `Highest exponent is ${deg}, so degree = ${deg}` };
            } else {
                const a1 = rand(1, 4), a2 = rand(1, 4), b1 = rand(1, 5), b2 = rand(1, 5);
                return { question: `(${a1}x² + ${b1}x) + (${a2}x² + ${b2}x) = ?`, answer: `${a1+a2}x² + ${b1+b2}x`, type: "procedural",
                    options: [`${a1+a2}x² + ${b1+b2}x`, `${a1*a2}x² + ${b1*b2}x`, `${a1+a2}x⁴ + ${b1+b2}x²`, `${a1+b1}x² + ${a2+b2}x`],
                    explanation: `Combine like terms: (${a1}+${a2})x² + (${b1}+${b2})x = ${a1+a2}x² + ${b1+b2}x` };
            }
        },
        Sequences: () => {
            const subSkillToQuestionType = { 'arithmetic': 'arithmetic', 'geometric': 'geometric', 'sum': 'sum' };
            const completedSubSkills = state.completedSubSkills['7_Sequences'] || [];
            let availableTypes = completedSubSkills.length > 0 ? completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean) : ["arithmetic", "geometric", "sum"];

            const type = pick(availableTypes);
            if (type === "arithmetic") {
                const a1 = rand(2, 10), d = rand(2, 5), n = rand(8, 12);
                const an = a1 + (n - 1) * d;
                return { question: `Arithmetic: first term ${a1}, common difference ${d}. Find term ${n}.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ + (n-1)d = ${a1} + ${n-1}(${d}) = ${a1} + ${(n-1)*d} = ${an}` };
            } else if (type === "geometric") {
                const a1 = rand(2, 5), r = rand(2, 3), n = rand(4, 6);
                const an = a1 * Math.pow(r, n - 1);
                return { question: `Geometric: first term ${a1}, ratio ${r}. Find term ${n}.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ × r^(n-1) = ${a1} × ${r}^${n-1} = ${a1} × ${Math.pow(r, n-1)} = ${an}` };
            } else {
                const n = rand(10, 20);
                const sum = (n * (n + 1)) / 2;
                return { question: `Sum: 1 + 2 + 3 + ... + ${n} = ?`, answer: sum, type: "procedural",
                    explanation: `Sum = n(n+1)/2 = ${n}(${n+1})/2 = ${sum}` };
            }
        },
        Probability: () => {
            const type = pick(["permutation", "combination"]);
            if (type === "permutation") {
                const n = rand(3, 6);
                let factorial = 1;
                for (let i = 2; i <= n; i++) factorial *= i;
                return { question: `How many ways to arrange ${n} items?`, answer: factorial, type: "procedural",
                    explanation: `${n}! = ${Array.from({length: n}, (_, i) => n - i).join(" × ")} = ${factorial}` };
            } else {
                const n = rand(4, 7), r = rand(2, 3);
                const nFact = (x) => { let f = 1; for (let i = 2; i <= x; i++) f *= i; return f; };
                const comb = nFact(n) / (nFact(r) * nFact(n - r));
                return { question: `Choose ${r} from ${n}. How many ways?`, answer: comb, type: "procedural",
                    explanation: `C(${n},${r}) = ${n}!/(${r}!×${n-r}!) = ${comb}` };
            }
        },
        "Conic Sections": () => {
            const subSkillToQuestionType = { 'identify': 'identify', 'circle': 'circle', 'parabola': 'parabola', 'ellipse': 'ellipse' };
            const completedSubSkills = state.completedSubSkills['7_Conic Sections'] || [];
            let availableTypes = completedSubSkills.length > 0 ? completedSubSkills.map(id => subSkillToQuestionType[id]).filter(Boolean) : ["identify", "circle", "parabola", "ellipse"];

            const type = pick(availableTypes);
            if (type === "identify") {
                const conics = [
                    { eq: "x² + y² = 25", name: "circle", exp: "Both x² and y² with same coefficient", curveType: 'circle', r: 5 },
                    { eq: "y = x²", name: "parabola", exp: "Only one variable is squared", curveType: 'quadratic', a: 1, b: 0, c: 0 },
                    { eq: "x²/9 + y²/4 = 1", name: "ellipse", exp: "x² and y² with different denominators, sum = 1", curveType: 'ellipse', a: 3, b: 2 },
                    { eq: "x²/9 - y²/4 = 1", name: "hyperbola", exp: "x² and y² with subtraction", curveType: 'hyperbola', a: 3, b: 2 }
                ];
                const c = pick(conics);
                const visualData = { xRange: [-6, 6], yRange: [-6, 6], gridStep: 1 };
                if (c.curveType === 'circle') visualData.curves = [{ type: 'circle', r: c.r }];
                else if (c.curveType === 'quadratic') visualData.curves = [{ type: 'quadratic', a: c.a, b: c.b, c: c.c }];
                else if (c.curveType === 'ellipse') visualData.curves = [{ type: 'ellipse', a: c.a, b: c.b }];
                else if (c.curveType === 'hyperbola') visualData.curves = [{ type: 'hyperbola', a: c.a, b: c.b }];
                return { question: `Identify the conic: ${c.eq}`, answer: c.name, type: "conceptual",
                    options: ["circle", "parabola", "ellipse", "hyperbola"],
                    explanation: `${c.eq} is a ${c.name}. ${c.exp}`,
                    visual: { type: 'coordinate', mode: 'display', data: visualData } };
            } else if (type === "circle") {
                const r = rand(2, 5);
                return { question: `Circle x² + y² = ${r * r}. What is the radius?`, answer: r, type: "procedural",
                    explanation: `x² + y² = r². Here r² = ${r * r}, so r = ${r}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-7, 7], yRange: [-7, 7], gridStep: 1, curves: [{ type: 'circle', r }] } } };
            } else if (type === "parabola") {
                const a = pick([1, 2, -1, -2]);
                const dir = a > 0 ? "upward" : "downward";
                return { question: `Parabola y = ${a === 1 ? '' : a === -1 ? '-' : a}x². Opens which direction?`, answer: dir, type: "conceptual",
                    options: ["upward", "downward", "left", "right"],
                    explanation: `When coefficient of x² is ${a > 0 ? "positive" : "negative"}, parabola opens ${dir}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, curves: [{ type: 'quadratic', a, b: 0, c: 0 }] } } };
            } else {
                let a = rand(2, 5), b = rand(2, 5);
                while (a === b) b = rand(2, 5);
                const major = a > b ? "horizontal" : "vertical";
                return { question: `Ellipse x²/${a*a} + y²/${b*b} = 1. Major axis is...?`, answer: major, type: "conceptual",
                    options: ["horizontal", "vertical"],
                    explanation: `Larger denominator (${Math.max(a*a, b*b)}) is under ${a > b ? "x²" : "y²"}, so major axis is ${major}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-7, 7], yRange: [-7, 7], gridStep: 1, curves: [{ type: 'ellipse', a, b }] } } };
            }
        },
        "Completing the Square": () => {
            const subSkillToType = { 'rewrite': 'rewrite', 'solve': 'solve', 'vertex': 'vertex' };
            const completed = state.completedSubSkills['7_Completing the Square'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["rewrite", "solve", "vertex"];
            const type = pick(available);
            if (type === "rewrite") {
                const b = rand(2, 8) * 2;
                const c = rand(1, 10);
                const halfB = b / 2;
                return { question: `Complete the square: x² + ${b}x + ${c} = (x + ?)² + ?`, answer: `(x + ${halfB})² + ${c - halfB*halfB}`, type: "procedural",
                    options: [`(x + ${halfB})² + ${c - halfB*halfB}`, `(x + ${b})² + ${c}`, `(x + ${halfB})² + ${c}`, `(x + ${halfB})² - ${halfB*halfB}`],
                    explanation: `Half of ${b} is ${halfB}. x² + ${b}x + ${halfB}² = (x + ${halfB})². Adjust: ${c} - ${halfB*halfB} = ${c - halfB*halfB}` };
            } else if (type === "solve") {
                const r = rand(1, 5);
                const c = r * r;
                return { question: `Solve by completing the square: x² - ${2*r}x + ${c} = 0`, answer: r, type: "procedural",
                    explanation: `(x - ${r})² = 0, so x = ${r}` };
            } else {
                const h = rand(1, 5), k = rand(-5, 5);
                return { question: `y = (x - ${h})² + ${k}. Vertex is?`, answer: `(${h}, ${k})`, type: "conceptual",
                    options: [`(${h}, ${k})`, `(${-h}, ${k})`, `(${h}, ${-k})`, `(${k}, ${h})`],
                    explanation: `Vertex form y = (x - h)² + k has vertex at (h, k) = (${h}, ${k})` };
            }
        },
        "Piecewise Functions": () => {
            const subSkillToType = { 'evaluate': 'evaluate', 'identify': 'identify', 'graph': 'graph' };
            const completed = state.completedSubSkills['7_Piecewise Functions'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["evaluate", "identify", "graph"];
            const type = pick(available);
            if (type === "evaluate") {
                const x = rand(-3, 5);
                const boundary = rand(0, 2);
                const ans = x < boundary ? x + 5 : 2 * x;
                return { question: `f(x) = {x + 5 if x < ${boundary}, 2x if x ≥ ${boundary}}. Find f(${x}).`, answer: ans, type: "procedural",
                    explanation: `Since ${x} ${x < boundary ? '<' : '≥'} ${boundary}, use ${x < boundary ? 'x + 5' : '2x'}. f(${x}) = ${ans}` };
            } else if (type === "identify") {
                return { question: `A piecewise function has different rules for different:`, answer: "intervals of x", type: "conceptual",
                    options: ["intervals of x", "values of y", "slopes", "intercepts"],
                    explanation: `Piecewise functions have different rules for different intervals of x.` };
            } else {
                return { question: `At x = 2, f(x) = {x² if x < 2, 2x if x ≥ 2}. Is f continuous at x = 2?`, answer: "Yes", type: "reasoning",
                    options: ["Yes", "No", "Cannot determine"],
                    explanation: `Left: 2² = 4. Right: 2(2) = 4. Both equal, so continuous.` };
            }
        },
        Asymptotes: () => {
            const subSkillToType = { 'vertical': 'vertical', 'horizontal': 'horizontal', 'both': 'both' };
            const completed = state.completedSubSkills['7_Asymptotes'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["vertical", "horizontal", "both"];
            const type = pick(available);
            if (type === "vertical") {
                const a = rand(1, 6);
                return { question: `f(x) = 1/(x - ${a}). Vertical asymptote at x = ?`, answer: a, type: "procedural",
                    explanation: `Vertical asymptote where denominator = 0: x - ${a} = 0, so x = ${a}` };
            } else if (type === "horizontal") {
                const num = rand(2, 5), denom = rand(2, 5);
                return { question: `f(x) = ${num}x/(${denom}x + 1). Horizontal asymptote at y = ?`, answer: num / denom, type: "procedural",
                    explanation: `Same degree: HA = leading coefficients ratio = ${num}/${denom}` };
            } else {
                const a = rand(1, 4), b = rand(1, 4);
                return { question: `f(x) = (x + ${a})/(x - ${b}). Find both asymptotes.`, answer: `x = ${b}, y = 1`, type: "procedural",
                    options: [`x = ${b}, y = 1`, `x = ${-b}, y = 1`, `x = ${b}, y = 0`, `x = ${a}, y = 1`],
                    explanation: `VA: x - ${b} = 0 → x = ${b}. HA: same degree → y = 1/1 = 1` };
            }
        },
        Permutations: () => {
            const subSkillToType = { 'formula': 'formula', 'calculate': 'calculate', 'word': 'word' };
            const completed = state.completedSubSkills['7_Permutations'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["formula", "calculate", "word"];
            const type = pick(available);
            if (type === "formula") {
                return { question: `The permutation formula P(n,r) equals:`, answer: "n!/(n-r)!", type: "conceptual",
                    options: ["n!/(n-r)!", "n!/r!", "n!/(n-r)!r!", "(n-r)!/n!"],
                    explanation: `P(n,r) = n!/(n-r)! counts ordered arrangements.` };
            } else if (type === "calculate") {
                const n = rand(4, 7), r = rand(2, 3);
                let result = 1;
                for (let i = 0; i < r; i++) result *= (n - i);
                return { question: `Calculate P(${n}, ${r})`, answer: result, type: "procedural",
                    explanation: `P(${n},${r}) = ${n}!/${n-r}! = ${Array.from({length: r}, (_, i) => n - i).join(' × ')} = ${result}` };
            } else {
                const n = rand(4, 6);
                let factorial = 1;
                for (let i = 2; i <= n; i++) factorial *= i;
                return { question: `How many ways to arrange ${n} different books on a shelf?`, answer: factorial, type: "reasoning",
                    explanation: `All different, order matters: ${n}! = ${factorial}` };
            }
        },
        Combinations: () => {
            const subSkillToType = { 'formula': 'formula', 'calculate': 'calculate', 'word': 'word' };
            const completed = state.completedSubSkills['7_Combinations'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["formula", "calculate", "word"];
            const type = pick(available);
            if (type === "formula") {
                return { question: `The combination formula C(n,r) equals:`, answer: "n!/(r!(n-r)!)", type: "conceptual",
                    options: ["n!/(r!(n-r)!)", "n!/(n-r)!", "n!/r!", "(n-r)!"],
                    explanation: `C(n,r) = n!/(r!(n-r)!) counts unordered selections.` };
            } else if (type === "calculate") {
                const n = rand(5, 8), r = rand(2, 3);
                let num = 1, denom = 1;
                for (let i = 0; i < r; i++) { num *= (n - i); denom *= (i + 1); }
                const result = num / denom;
                return { question: `Calculate C(${n}, ${r})`, answer: result, type: "procedural",
                    explanation: `C(${n},${r}) = ${n}!/(${r}!${n-r}!) = ${result}` };
            } else {
                const n = rand(8, 12), r = rand(3, 4);
                let num = 1, denom = 1;
                for (let i = 0; i < r; i++) { num *= (n - i); denom *= (i + 1); }
                const result = num / denom;
                return { question: `How many ways to choose ${r} students from ${n} for a committee?`, answer: result, type: "reasoning",
                    explanation: `Order doesn't matter: C(${n},${r}) = ${result}` };
            }
        },
        "Expected Value": () => {
            const subSkillToType = { 'dice': 'dice', 'coins': 'coins', 'custom': 'custom' };
            const completed = state.completedSubSkills['7_Expected Value'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["dice", "coins", "custom"];
            const type = pick(available);
            if (type === "dice") {
                return { question: `Roll a fair die. What is the expected value?`, answer: 3.5, type: "procedural",
                    explanation: `E(X) = (1+2+3+4+5+6)/6 = 21/6 = 3.5` };
            } else if (type === "coins") {
                const win = rand(5, 10), lose = rand(2, 4);
                const ev = (0.5 * win - 0.5 * lose).toFixed(2);
                return { question: `Flip coin: win $${win} for heads, lose $${lose} for tails. Expected value?`, answer: parseFloat(ev), type: "procedural",
                    explanation: `E(X) = 0.5(${win}) + 0.5(-${lose}) = ${win/2} - ${lose/2} = ${ev}` };
            } else {
                const p1 = 0.3, v1 = rand(10, 20), p2 = 0.7, v2 = rand(2, 8);
                const ev = (p1 * v1 + p2 * v2).toFixed(2);
                return { question: `30% chance to win $${v1}, 70% chance to win $${v2}. Expected value?`, answer: parseFloat(ev), type: "procedural",
                    explanation: `E(X) = 0.3(${v1}) + 0.7(${v2}) = ${(p1*v1).toFixed(1)} + ${(p2*v2).toFixed(1)} = ${ev}` };
            }
        },
        "Synthetic Division": () => {
            const subSkillToType = { 'setup': 'setup', 'divide': 'divide', 'remainder': 'remainder' };
            const completed = state.completedSubSkills['7_Synthetic Division'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["setup", "divide", "remainder"];
            const type = pick(available);
            if (type === "setup") {
                const a = rand(1, 4);
                return { question: `To divide by (x - ${a}) using synthetic division, use which number?`, answer: a, type: "conceptual",
                    options: [a, -a, a * 2, 0],
                    explanation: `For (x - ${a}), use +${a} in synthetic division (opposite sign).` };
            } else if (type === "divide") {
                const a = rand(1, 3);
                const otherRoot = rand(-3, 3);
                const b = -(a + otherRoot);
                const c = a * otherRoot;
                return { question: `Use synthetic division: (x² ${b >= 0 ? '+' : ''}${b}x ${c >= 0 ? '+' : ''}${c}) ÷ (x - ${a}). Quotient?`, answer: `x ${otherRoot >= 0 ? '+' : ''}${-otherRoot}`, type: "procedural",
                    options: [`x ${-otherRoot >= 0 ? '+' : ''}${-otherRoot}`, `x ${otherRoot >= 0 ? '+' : ''}${otherRoot}`, `x² + ${a}`, `x - ${a}`],
                    explanation: `Synthetic division with ${a}: quotient is x ${-otherRoot >= 0 ? '+' : ''}${-otherRoot} with remainder 0.` };
            } else {
                const a = rand(1, 3);
                const b = rand(-5, 5);
                const c = rand(-10, 10);
                const remainder = a * a + b * a + c;
                return { question: `By Remainder Theorem: f(x) = x² ${b >= 0 ? '+' : ''}${b}x ${c >= 0 ? '+' : ''}${c}. Find f(${a}).`, answer: remainder, type: "procedural",
                    explanation: `f(${a}) = ${a}² ${b >= 0 ? '+' : ''}${b}(${a}) ${c >= 0 ? '+' : ''}${c} = ${a * a} ${b * a >= 0 ? '+' : ''}${b * a} ${c >= 0 ? '+' : ''}${c} = ${remainder}` };
            }
        },
        "Binomial Theorem": () => {
            const subSkillToType = { 'pascal': 'pascal', 'coefficient': 'coefficient', 'expand_simple': 'expand_simple' };
            const completed = state.completedSubSkills['7_Binomial Theorem'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["pascal", "coefficient", "expand_simple"];
            const type = pick(available);
            if (type === "pascal") {
                const row = rand(3, 5);
                const pascalRows = { 3: "1 3 3 1", 4: "1 4 6 4 1", 5: "1 5 10 10 5 1" };
                return { question: `Row ${row} of Pascal's Triangle:`, answer: pascalRows[row], type: "conceptual",
                    options: [pascalRows[3], pascalRows[4], pascalRows[5], "1 2 1"],
                    explanation: `Row ${row}: ${pascalRows[row]}` };
            } else if (type === "coefficient") {
                const n = 4;
                const k = rand(1, 3);
                const coef = { 1: 4, 2: 6, 3: 4 };
                return { question: `In (a + b)⁴, coefficient of a^${4-k}b^${k}?`, answer: coef[k], type: "procedural",
                    options: [coef[1], coef[2], coef[3], 1],
                    explanation: `C(4, ${k}) = ${coef[k]}` };
            } else {
                return { question: `(x + 1)² expands to:`, answer: "x² + 2x + 1", type: "procedural",
                    options: ["x² + 2x + 1", "x² + x + 1", "x² + 1", "2x² + 2x"],
                    explanation: `(x + 1)² = x² + 2(x)(1) + 1² = x² + 2x + 1` };
            }
        },
        "Matrices Intro": () => {
            const subSkillToType = { 'dimensions': 'dimensions', 'add': 'add', 'scalar_mult': 'scalar_mult', 'element': 'element' };
            const completed = state.completedSubSkills['7_Matrices Intro'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["dimensions", "add", "scalar_mult", "element"];
            const type = pick(available);
            if (type === "dimensions") {
                const rows = rand(2, 4), cols = rand(2, 4);
                return { question: `A matrix with ${rows} rows and ${cols} columns has dimensions:`, answer: `${rows} × ${cols}`, type: "conceptual",
                    options: [`${rows} × ${cols}`, `${cols} × ${rows}`, `${rows + cols}`, `${rows * cols}`],
                    explanation: `Matrix dimensions: rows × columns = ${rows} × ${cols}` };
            } else if (type === "add") {
                const a = rand(1, 5), b = rand(1, 5), c = rand(1, 5), d = rand(1, 5);
                const e = rand(1, 5), f = rand(1, 5), g = rand(1, 5), h = rand(1, 5);
                return { question: `[${a} ${b}; ${c} ${d}] + [${e} ${f}; ${g} ${h}] = ? (top-left element)`, answer: a + e, type: "procedural",
                    explanation: `Add corresponding elements: ${a} + ${e} = ${a + e}` };
            } else if (type === "scalar_mult") {
                const k = rand(2, 5);
                const a = rand(1, 5), b = rand(1, 5);
                return { question: `${k} × [${a} ${b}] = ?`, answer: `[${k * a} ${k * b}]`, type: "procedural",
                    options: [`[${k * a} ${k * b}]`, `[${a + k} ${b + k}]`, `[${a} ${b}]`, `[${k} ${k}]`],
                    explanation: `Multiply each element by ${k}: [${k}×${a} ${k}×${b}] = [${k * a} ${k * b}]` };
            } else {
                const matrix = [[rand(1, 9), rand(1, 9)], [rand(1, 9), rand(1, 9)]];
                const row = rand(1, 2), col = rand(1, 2);
                return { question: `Matrix [${matrix[0][0]} ${matrix[0][1]}; ${matrix[1][0]} ${matrix[1][1]}]. Element at row ${row}, column ${col}?`, answer: matrix[row - 1][col - 1], type: "procedural",
                    options: [matrix[0][0], matrix[0][1], matrix[1][0], matrix[1][1]],
                    explanation: `Row ${row}, Column ${col} = ${matrix[row - 1][col - 1]}` };
            }
        }
    },

    // TIER 8: Pre-Calculus (11-12)
    8: {
        Transformations: () => {
            const subSkillToType = { 'horizontal': 'horizontal', 'vertical': 'vertical', 'combined': 'combined' };
            const completed = state.completedSubSkills['8_Transformations'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["horizontal", "vertical", "combined"];
            const h = rand(1, 5), k = rand(1, 5);
            const type = pick(available);
            if (type === "horizontal") {
                const dir = pick(["left", "right"]);
                const sign = dir === "right" ? "-" : "+";
                return { question: `f(x ${sign} ${h}) shifts the graph...`, answer: `${dir} ${h}`, type: "conceptual",
                    options: [`${dir} ${h}`, `${dir === "left" ? "right" : "left"} ${h}`, `up ${h}`, `down ${h}`],
                    explanation: `f(x ${sign} ${h}) shifts ${dir} by ${h} units` };
            } else if (type === "vertical") {
                const dir = pick(["up", "down"]);
                const sign = dir === "up" ? "+" : "-";
                return { question: `f(x) ${sign} ${k} shifts the graph...`, answer: `${dir} ${k}`, type: "conceptual",
                    options: [`${dir} ${k}`, `${dir === "up" ? "down" : "up"} ${k}`, `left ${k}`, `right ${k}`],
                    explanation: `f(x) ${sign} ${k} shifts ${dir} by ${k} units` };
            } else {
                return { question: `-f(x) does what to the graph?`, answer: "reflects over x-axis", type: "conceptual",
                    options: ["reflects over x-axis", "reflects over y-axis", "shifts up", "shifts down"],
                    explanation: `Negating f(x) reflects the graph over the x-axis` };
            }
        },
        "Trig Functions": () => {
            const values = [
                { angle: "π/6", radians: Math.PI/6, sin: "1/2", cos: "√3/2", tan: "1/√3" },
                { angle: "π/4", radians: Math.PI/4, sin: "√2/2", cos: "√2/2", tan: "1" },
                { angle: "π/3", radians: Math.PI/3, sin: "√3/2", cos: "1/2", tan: "√3" },
                { angle: "π/2", radians: Math.PI/2, sin: "1", cos: "0", tan: "undefined" }
            ];
            const v = pick(values);
            const func = pick(["sin", "cos"]);
            return { question: `${func}(${v.angle}) = ?`, answer: v[func], type: "procedural",
                options: ["1/2", "√2/2", "√3/2", "1"],
                explanation: `${func}(${v.angle}) = ${v[func]} (standard angle)`,
                visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1.5, 1.5], yRange: [-1.5, 1.5], gridStep: 0.5, unitCircle: true, angleRadians: v.radians, showAngleLabel: v.angle } } };
        },
        Limits: () => {
            const subSkillToType = { 'direct': 'direct', 'factor': 'factor', 'infinity': 'infinity' };
            const completed = state.completedSubSkills['8_Limits'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["direct", "factor", "infinity"];
            const type = pick(available);
            if (type === "direct") {
                const a = rand(1, 5), b = rand(1, 5);
                const c = rand(1, 4);
                const answer = a * c + b;
                return { question: `lim(x→${c}) (${a}x + ${b}) = ?`, answer, type: "procedural",
                    explanation: `Direct substitution: ${a}(${c}) + ${b} = ${answer}` };
            } else if (type === "factor") {
                const a = rand(1, 4);
                return { question: `lim(x→${a}) (x² - ${a*a})/(x - ${a}) = ?`, answer: 2 * a, type: "procedural",
                    explanation: `Factor: (x+${a})(x-${a})/(x-${a}) = x+${a}. At x=${a}: ${2*a}` };
            } else {
                const a = rand(2, 5), b = rand(1, 4);
                return { question: `lim(x→∞) (${a}x² + 1)/(${b}x² + x) = ?`, answer: a / b, type: "procedural",
                    explanation: `Highest powers: ${a}x²/${b}x² = ${a}/${b} = ${(a/b).toFixed(2)}` };
            }
        },
        "Complex Numbers": () => {
            const subSkillToType = { 'i_power': 'i_power', 'multiply': 'multiply', 'add': 'add' };
            const completed = state.completedSubSkills['8_Complex Numbers'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["i_power", "multiply", "add"];
            const type = pick(available);
            if (type === "i_power") {
                const powers = [{ n: 2, ans: "-1" }, { n: 3, ans: "-i" }, { n: 4, ans: "1" }];
                const p = pick(powers);
                return { question: `i${["⁰","¹","²","³","⁴"][p.n]} = ?`, answer: p.ans, type: "procedural",
                    options: ["1", "-1", "i", "-i"],
                    explanation: `i² = -1, i³ = -i, i⁴ = 1. So i^${p.n} = ${p.ans}` };
            } else if (type === "add") {
                const a = rand(1, 5), b = rand(1, 5), c = rand(1, 5), d = rand(1, 5);
                return { question: `(${a} + ${b}i) + (${c} + ${d}i) = ?`, answer: `${a+c} + ${b+d}i`, type: "procedural",
                    options: [`${a+c} + ${b+d}i`, `${a*c} + ${b*d}i`, `${a+c} + ${b*d}i`, `${a+b} + ${c+d}i`],
                    explanation: `Add real and imaginary parts: (${a}+${c}) + (${b}+${d})i = ${a+c} + ${b+d}i` };
            } else {
                const a = rand(1, 4), b = rand(1, 3);
                const answer = a * a + b * b;
                return { question: `(${a} + ${b}i)(${a} - ${b}i) = ?`, answer, type: "procedural",
                    explanation: `Conjugate product: a² + b² = ${a}² + ${b}² = ${answer}` };
            }
        },
        Vectors: () => {
            const subSkillToType = { 'add': 'add', 'magnitude': 'magnitude', 'scalar': 'scalar' };
            const completed = state.completedSubSkills['8_Vectors'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["add", "magnitude", "scalar"];
            const type = pick(available);
            if (type === "add") {
                const a1 = rand(1, 5), a2 = rand(1, 5);
                const b1 = rand(1, 5), b2 = rand(1, 5);
                return { question: `⟨${a1}, ${a2}⟩ + ⟨${b1}, ${b2}⟩ = ?`, answer: `⟨${a1+b1}, ${a2+b2}⟩`, type: "procedural",
                    options: [`⟨${a1+b1}, ${a2+b2}⟩`, `⟨${a1*b1}, ${a2*b2}⟩`, `⟨${a1+a2}, ${b1+b2}⟩`, `⟨${a1-b1}, ${a2-b2}⟩`],
                    explanation: `Add components: ⟨${a1}+${b1}, ${a2}+${b2}⟩ = ⟨${a1+b1}, ${a2+b2}⟩` };
            } else if (type === "magnitude") {
                const pairs = [[3, 4, 5], [5, 12, 13], [6, 8, 10]];
                const [a, b, mag] = pick(pairs);
                return { question: `Magnitude of ⟨${a}, ${b}⟩ = ?`, answer: mag, type: "procedural",
                    explanation: `|v| = √(${a}² + ${b}²) = √(${a*a} + ${b*b}) = √${mag*mag} = ${mag}` };
            } else {
                const k = rand(2, 4);
                const a = rand(1, 5), b = rand(1, 5);
                return { question: `${k}⟨${a}, ${b}⟩ = ?`, answer: `⟨${k*a}, ${k*b}⟩`, type: "procedural",
                    options: [`⟨${k*a}, ${k*b}⟩`, `⟨${k+a}, ${k+b}⟩`, `⟨${a}, ${b}⟩`, `⟨${k*a}, ${b}⟩`],
                    explanation: `Multiply each component by ${k}: ⟨${k}×${a}, ${k}×${b}⟩ = ⟨${k*a}, ${k*b}⟩` };
            }
        },
        "Advanced Functions": () => {
            const subSkillToType = { 'composite': 'composite', 'inverse': 'inverse', 'domain': 'domain' };
            const completed = state.completedSubSkills['8_Advanced Functions'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["composite", "inverse", "domain"];
            const type = pick(available);
            if (type === "composite") {
                const a = rand(2, 4), b = rand(1, 5);
                const x = rand(1, 4);
                const gx = a * x;
                const fgx = gx + b;
                return { question: `f(x) = x + ${b}, g(x) = ${a}x. Find f(g(${x})).`, answer: fgx, type: "procedural",
                    explanation: `g(${x}) = ${a}(${x}) = ${gx}. Then f(${gx}) = ${gx} + ${b} = ${fgx}` };
            } else if (type === "inverse") {
                const a = rand(2, 5);
                return { question: `f(x) = ${a}x. Find f⁻¹(x).`, answer: `x/${a}`, type: "procedural",
                    options: [`x/${a}`, `${a}x`, `${a}/x`, `x - ${a}`],
                    explanation: `If f(x) = ${a}x, then f⁻¹(x) = x/${a} (divide by ${a} to undo multiplication)` };
            } else {
                const a = rand(1, 5);
                return { question: `f(x) = √(x - ${a}). Domain is x ≥ ?`, answer: a, type: "conceptual",
                    explanation: `Can't take square root of negative. x - ${a} ≥ 0 means x ≥ ${a}` };
            }
        },
        "Radian Measure": () => {
            const subSkillToType = { 'convert_to_rad': 'convert_to_rad', 'convert_to_deg': 'convert_to_deg', 'arc_length': 'arc_length' };
            const completed = state.completedSubSkills['8_Radian Measure'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["convert_to_rad", "convert_to_deg", "arc_length"];
            const type = pick(available);
            if (type === "convert_to_rad") {
                const degrees = pick([30, 45, 60, 90, 120, 180, 270, 360]);
                const radians = { 30: "π/6", 45: "π/4", 60: "π/3", 90: "π/2", 120: "2π/3", 180: "π", 270: "3π/2", 360: "2π" };
                return { question: `Convert ${degrees}° to radians.`, answer: radians[degrees], type: "procedural",
                    options: ["π/6", "π/4", "π/3", "π/2", "2π/3", "π", "3π/2", "2π"].slice(0, 4),
                    explanation: `${degrees}° × (π/180°) = ${radians[degrees]}` };
            } else if (type === "convert_to_deg") {
                const rads = pick(["π/6", "π/4", "π/3", "π/2"]);
                const degs = { "π/6": 30, "π/4": 45, "π/3": 60, "π/2": 90 };
                return { question: `Convert ${rads} radians to degrees.`, answer: degs[rads], type: "procedural",
                    options: [30, 45, 60, 90],
                    explanation: `${rads} × (180°/π) = ${degs[rads]}°` };
            } else {
                const r = rand(3, 8), theta = pick([Math.PI/2, Math.PI/3, Math.PI/4]);
                const arc = (r * theta).toFixed(2);
                const thetaStr = theta === Math.PI/2 ? "π/2" : theta === Math.PI/3 ? "π/3" : "π/4";
                return { question: `Arc length: radius ${r}, central angle ${thetaStr}. (Round to 2 decimal places)`, answer: parseFloat(arc), type: "procedural",
                    explanation: `s = rθ = ${r} × ${thetaStr} ≈ ${arc}` };
            }
        },
        "Inverse Trig": () => {
            const subSkillToType = { 'evaluate': 'evaluate', 'domain': 'domain', 'range': 'range' };
            const completed = state.completedSubSkills['8_Inverse Trig'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["evaluate", "domain", "range"];
            const type = pick(available);
            if (type === "evaluate") {
                const values = [
                    { input: "0", func: "sin⁻¹", output: "0" },
                    { input: "1", func: "sin⁻¹", output: "π/2" },
                    { input: "1", func: "cos⁻¹", output: "0" },
                    { input: "0", func: "cos⁻¹", output: "π/2" },
                    { input: "1", func: "tan⁻¹", output: "π/4" },
                    { input: "0", func: "tan⁻¹", output: "0" }
                ];
                const v = pick(values);
                return { question: `Evaluate ${v.func}(${v.input})`, answer: v.output, type: "procedural",
                    options: ["0", "π/6", "π/4", "π/3", "π/2"],
                    explanation: `${v.func}(${v.input}) = ${v.output}` };
            } else if (type === "domain") {
                const func = pick(["sin⁻¹", "cos⁻¹"]);
                return { question: `What is the domain of ${func}(x)?`, answer: "[-1, 1]", type: "conceptual",
                    options: ["[-1, 1]", "all real numbers", "[0, π]", "[-π/2, π/2]"],
                    explanation: `${func} only accepts inputs from -1 to 1 (sine and cosine output range).` };
            } else {
                const func = pick(["sin⁻¹", "tan⁻¹"]);
                const range = func === "sin⁻¹" ? "[-π/2, π/2]" : "(-π/2, π/2)";
                return { question: `What is the range of ${func}(x)?`, answer: range, type: "conceptual",
                    options: ["[-π/2, π/2]", "(-π/2, π/2)", "[0, π]", "all real numbers"],
                    explanation: `Range of ${func} is ${range}` };
            }
        },
        "Parametric Equations": () => {
            const subSkillToType = { 'evaluate': 'evaluate', 'eliminate': 'eliminate', 'identify': 'identify' };
            const completed = state.completedSubSkills['8_Parametric Equations'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["evaluate", "eliminate", "identify"];
            const type = pick(available);
            if (type === "evaluate") {
                const t = rand(1, 4);
                const x = 2 * t, y = t * t;
                return { question: `x = 2t, y = t². Find (x, y) when t = ${t}.`, answer: `(${x}, ${y})`, type: "procedural",
                    options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${t}, ${t})`, `(${x + y}, ${x * y})`],
                    explanation: `x = 2(${t}) = ${x}, y = ${t}² = ${y}. Point: (${x}, ${y})` };
            } else if (type === "eliminate") {
                return { question: `x = t + 1, y = t - 2. Eliminate the parameter.`, answer: "y = x - 3", type: "procedural",
                    options: ["y = x - 3", "y = x + 3", "y = 2x - 1", "y = x - 1"],
                    explanation: `From x = t + 1: t = x - 1. Substitute: y = (x - 1) - 2 = x - 3` };
            } else {
                return { question: `x = cos(t), y = sin(t) traces what shape?`, answer: "circle", type: "conceptual",
                    options: ["circle", "line", "parabola", "ellipse"],
                    explanation: `x² + y² = cos²(t) + sin²(t) = 1, which is a unit circle.` };
            }
        },
        "Polar Coordinates": () => {
            const subSkillToType = { 'convert_to_rect': 'convert_to_rect', 'convert_to_polar': 'convert_to_polar', 'identify': 'identify' };
            const completed = state.completedSubSkills['8_Polar Coordinates'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["convert_to_rect", "convert_to_polar", "identify"];
            const type = pick(available);
            if (type === "convert_to_rect") {
                const r = rand(2, 5), theta = pick([0, Math.PI/2, Math.PI, 3*Math.PI/2]);
                const thetaStr = theta === 0 ? "0" : theta === Math.PI/2 ? "π/2" : theta === Math.PI ? "π" : "3π/2";
                const x = Math.round(r * Math.cos(theta)), y = Math.round(r * Math.sin(theta));
                return { question: `Convert polar (${r}, ${thetaStr}) to rectangular.`, answer: `(${x}, ${y})`, type: "procedural",
                    options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${r}, ${r})`, `(${-x}, ${-y})`],
                    explanation: `x = r·cos(θ) = ${r}·cos(${thetaStr}) = ${x}. y = r·sin(θ) = ${y}` };
            } else if (type === "convert_to_polar") {
                const pairs = [
                    [3, 4, 5, "0.93", ["(5, 0.93)", "(5, 0.64)", "(4, 0.93)", "(3, π/4)"]],
                    [0, 5, 5, "π/2", ["(5, π/2)", "(5, 0)", "(5, π)", "(√5, π/2)"]],
                    [5, 0, 5, "0", ["(5, 0)", "(5, π/2)", "(0, 5)", "(5, π)"]],
                    [-3, 0, 3, "π", ["(3, π)", "(3, 0)", "(-3, 0)", "(3, π/2)"]]
                ];
                const [x, y, r, theta, opts] = pick(pairs);
                return { question: `Convert rectangular (${x}, ${y}) to polar (r, θ).`, answer: `(${r}, ${theta})`, type: "procedural",
                    options: opts,
                    explanation: `r = √(${x}² + ${y}²) = ${r}. θ = arctan(${y}/${x}) ≈ ${theta}` };
            } else {
                return { question: `r = 5 in polar coordinates represents a:`, answer: "circle with radius 5", type: "conceptual",
                    options: ["circle with radius 5", "line", "point", "spiral"],
                    explanation: `r = constant is a circle centered at origin with that radius.` };
            }
        },
        "Normal Distribution": () => {
            const subSkillToType = { 'z_score': 'z_score', 'empirical': 'empirical', 'interpret': 'interpret' };
            const completed = state.completedSubSkills['8_Normal Distribution'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["z_score", "empirical", "interpret"];
            const type = pick(available);
            if (type === "z_score") {
                const mean = rand(50, 80), sd = rand(5, 15), x = mean + sd * rand(1, 2);
                const z = (x - mean) / sd;
                return { question: `Mean = ${mean}, SD = ${sd}. Find z-score for x = ${x}.`, answer: z.toFixed(1), type: "procedural",
                    explanation: `z = (x - μ)/σ = (${x} - ${mean})/${sd} = ${z.toFixed(1)}` };
            } else if (type === "empirical") {
                const pct = pick([68, 95, 99.7]);
                const sds = pct === 68 ? 1 : pct === 95 ? 2 : 3;
                return { question: `In a normal distribution, ${pct}% of data falls within how many standard deviations?`, answer: sds, type: "conceptual",
                    options: [1, 2, 3, 4],
                    explanation: `Empirical Rule: ${pct}% within ${sds} SD${sds > 1 ? 's' : ''} of the mean.` };
            } else {
                const z = pick([1, 2, -1, -2]);
                const direction = z > 0 ? "above" : "below";
                return { question: `A z-score of ${z} means the value is:`, answer: `${Math.abs(z)} SD ${direction} the mean`, type: "conceptual",
                    options: [`${Math.abs(z)} SD above the mean`, `${Math.abs(z)} SD below the mean`, "equal to the mean", `${Math.abs(z)} times the mean`],
                    explanation: `z = ${z} means ${Math.abs(z)} standard deviation${Math.abs(z) > 1 ? 's' : ''} ${direction} the mean.` };
            }
        },
        "Unit Circle": () => {
            const subSkillToType = { 'coordinates': 'coordinates', 'quadrant': 'quadrant', 'reference': 'reference', 'special': 'special' };
            const completed = state.completedSubSkills['8_Unit Circle'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["coordinates", "quadrant", "reference", "special"];
            const type = pick(available);
            if (type === "coordinates") {
                const angles = [
                    { angle: "0", radians: 0, coords: "(1, 0)" },
                    { angle: "π/6", radians: Math.PI/6, coords: "(√3/2, 1/2)" },
                    { angle: "π/4", radians: Math.PI/4, coords: "(√2/2, √2/2)" },
                    { angle: "π/3", radians: Math.PI/3, coords: "(1/2, √3/2)" },
                    { angle: "π/2", radians: Math.PI/2, coords: "(0, 1)" },
                    { angle: "π", radians: Math.PI, coords: "(-1, 0)" },
                    { angle: "3π/2", radians: 3*Math.PI/2, coords: "(0, -1)" }
                ];
                const a = pick(angles);
                return { question: `Point on unit circle at angle ${a.angle}?`, answer: a.coords, type: "procedural",
                    options: ["(1, 0)", "(√2/2, √2/2)", "(1/2, √3/2)", "(0, 1)"],
                    explanation: `At ${a.angle}: (cos(${a.angle}), sin(${a.angle})) = ${a.coords}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1.5, 1.5], yRange: [-1.5, 1.5], gridStep: 0.5, unitCircle: true, angleRadians: a.radians, showAngleLabel: a.angle } } };
            } else if (type === "quadrant") {
                const quads = [
                    { q: "I", sin: "+", cos: "+", radians: Math.PI/4 },
                    { q: "II", sin: "+", cos: "-", radians: 3*Math.PI/4 },
                    { q: "III", sin: "-", cos: "-", radians: 5*Math.PI/4 },
                    { q: "IV", sin: "-", cos: "+", radians: 7*Math.PI/4 }
                ];
                const quad = pick(quads);
                return { question: `In Quadrant ${quad.q}, sin is ${quad.sin} and cos is:`, answer: quad.cos, type: "conceptual",
                    options: ["+", "-"],
                    explanation: `Quadrant ${quad.q}: sin is ${quad.sin}, cos is ${quad.cos}. (Remember: All Students Take Calculus)`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1.5, 1.5], yRange: [-1.5, 1.5], gridStep: 0.5, unitCircle: true, showQuadrantLabels: true, highlightQuadrant: quad.q } } };
            } else if (type === "reference") {
                const angles = [
                    { angle: "5π/6", radians: 5*Math.PI/6, ref: "π/6" },
                    { angle: "3π/4", radians: 3*Math.PI/4, ref: "π/4" },
                    { angle: "2π/3", radians: 2*Math.PI/3, ref: "π/3" },
                    { angle: "7π/6", radians: 7*Math.PI/6, ref: "π/6" },
                    { angle: "5π/4", radians: 5*Math.PI/4, ref: "π/4" },
                    { angle: "4π/3", radians: 4*Math.PI/3, ref: "π/3" }
                ];
                const a = pick(angles);
                return { question: `Reference angle for ${a.angle}?`, answer: a.ref, type: "procedural",
                    options: ["π/6", "π/4", "π/3", "π/2"],
                    explanation: `${a.angle} has reference angle ${a.ref} (acute angle to x-axis)`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1.5, 1.5], yRange: [-1.5, 1.5], gridStep: 0.5, unitCircle: true, angleRadians: a.radians, showAngleLabel: a.angle, showReferenceAngle: true } } };
            } else {
                const angle = pick(["30°", "45°", "60°"]);
                const sides = { "30°": "1, √3, 2", "45°": "1, 1, √2", "60°": "1, √3, 2" };
                return { question: `Special right triangle with ${angle}: opposite, adjacent, hypotenuse?`, answer: sides[angle], type: "conceptual",
                    options: ["1, √3, 2", "1, 1, √2", "3, 4, 5", "1, 2, √5"],
                    explanation: `${angle} triangle has sides ${sides[angle]}` };
            }
        },
        "Trig Identities": () => {
            const subSkillToType = { 'pythagorean': 'pythagorean', 'double_angle': 'double_angle', 'sum_diff': 'sum_diff', 'verify': 'verify' };
            const completed = state.completedSubSkills['8_Trig Identities'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["pythagorean", "double_angle", "sum_diff", "verify"];
            const type = pick(available);
            if (type === "pythagorean") {
                const identities = [
                    { q: "sin²θ + cos²θ = ?", a: "1" },
                    { q: "1 + tan²θ = ?", a: "sec²θ" },
                    { q: "1 + cot²θ = ?", a: "csc²θ" }
                ];
                const id = pick(identities);
                return { question: id.q, answer: id.a, type: "procedural",
                    options: ["1", "sec²θ", "csc²θ", "tan²θ"],
                    explanation: `Pythagorean identity: ${id.q.replace('?', id.a)}` };
            } else if (type === "double_angle") {
                const identities = [
                    { q: "sin(2θ) = ?", a: "2sin(θ)cos(θ)" },
                    { q: "cos(2θ) = ? (first form)", a: "cos²θ - sin²θ" }
                ];
                const id = pick(identities);
                return { question: id.q, answer: id.a, type: "procedural",
                    options: ["2sin(θ)cos(θ)", "cos²θ - sin²θ", "sin²θ + cos²θ", "2cos²θ"],
                    explanation: `Double angle formula: ${id.q.replace('?', id.a)}` };
            } else if (type === "sum_diff") {
                return { question: `sin(A + B) = ?`, answer: "sin(A)cos(B) + cos(A)sin(B)", type: "procedural",
                    options: ["sin(A)cos(B) + cos(A)sin(B)", "sin(A)sin(B) + cos(A)cos(B)", "sin(A) + sin(B)", "cos(A)cos(B) - sin(A)sin(B)"],
                    explanation: `Sum formula: sin(A + B) = sin(A)cos(B) + cos(A)sin(B)` };
            } else {
                const sinVal = pick(["3/5", "4/5"]);
                const cosVal = sinVal === "3/5" ? "4/5" : "3/5";
                return { question: `If sin(θ) = ${sinVal} in Q1, find cos(θ).`, answer: cosVal, type: "procedural",
                    options: ["3/5", "4/5", "5/3", "5/4"],
                    explanation: `sin²θ + cos²θ = 1. If sin = ${sinVal}, then cos = ${cosVal} (3-4-5 triangle)` };
            }
        },
        "Graphing Trig Functions": () => {
            const subSkillToType = { 'amplitude': 'amplitude', 'period': 'period', 'phase_shift': 'phase_shift', 'identify': 'identify' };
            const completed = state.completedSubSkills['8_Graphing Trig Functions'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["amplitude", "period", "phase_shift", "identify"];
            const type = pick(available);
            if (type === "amplitude") {
                const a = rand(2, 6);
                return { question: `Amplitude of y = ${a}sin(x)?`, answer: a, type: "conceptual",
                    options: [a, a * 2, 1, a - 1],
                    explanation: `Amplitude = |A| in y = Asin(x). Here amplitude = ${a}` };
            } else if (type === "period") {
                const b = pick([2, 3, 4]);
                const period = `2π/${b}`;
                return { question: `Period of y = sin(${b}x)?`, answer: period, type: "procedural",
                    options: [`2π/${b}`, "2π", `${b}π`, `π/${b}`],
                    explanation: `Period = 2π/B. Here B = ${b}, so period = ${period}` };
            } else if (type === "phase_shift") {
                const c = rand(1, 4);
                const dir = pick(["left", "right"]);
                const sign = dir === "right" ? "-" : "+";
                return { question: `Phase shift of y = sin(x ${sign} ${c})?`, answer: `${dir} ${c}`, type: "conceptual",
                    options: [`left ${c}`, `right ${c}`, `up ${c}`, `down ${c}`],
                    explanation: `y = sin(x ${sign} ${c}) shifts ${dir} by ${c} units` };
            } else {
                const func = pick(["sin", "cos", "tan"]);
                const props = {
                    "sin": { period: "2π", zeros: "0, π, 2π" },
                    "cos": { period: "2π", zeros: "π/2, 3π/2" },
                    "tan": { period: "π", zeros: "0, π" }
                };
                return { question: `The period of y = ${func}(x) is:`, answer: props[func].period, type: "conceptual",
                    options: ["π", "2π", "π/2", "4π"],
                    explanation: `${func}(x) has period ${props[func].period}` };
            }
        },
        "Series Convergence": () => {
            const subSkillToType = { 'geometric': 'geometric', 'harmonic': 'harmonic', 'p_series': 'p_series', 'comparison': 'comparison' };
            const completed = state.completedSubSkills['8_Series Convergence'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["geometric", "harmonic", "p_series", "comparison"];
            const type = pick(available);
            if (type === "geometric") {
                const r = pick(["1/2", "1/3", "2", "3"]);
                const converges = r === "1/2" || r === "1/3";
                return { question: `Geometric series with r = ${r}. Converges?`, answer: converges ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `Geometric series converges when |r| < 1. |${r}| ${converges ? "< 1, converges" : "≥ 1, diverges"}` };
            } else if (type === "harmonic") {
                return { question: `Does the harmonic series Σ(1/n) converge?`, answer: "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `The harmonic series Σ(1/n) diverges (classic result - grows without bound)` };
            } else if (type === "p_series") {
                const p = pick(["1/2", "1", "2", "3"]);
                const converges = p === "2" || p === "3";
                return { question: `P-series Σ(1/n^${p}). Converges?`, answer: converges ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `P-series converges when p > 1. p = ${p} ${converges ? "> 1, converges" : "≤ 1, diverges"}` };
            } else {
                const series = pick(["Σ(1/n²)", "Σ(1/2ⁿ)"]);
                return { question: `${series} converges or diverges?`, answer: "Converges", type: "conceptual",
                    options: ["Converges", "Diverges"],
                    explanation: `${series} converges. (${series === "Σ(1/n²)" ? "p-series with p=2>1" : "geometric with r=1/2<1"})` };
            }
        }
    },

    // TIER 9: Calculus (12+)
    9: {
        Derivatives: () => {
            const subSkillToType = { 'power': 'power', 'trig': 'trig', 'chain': 'chain' };
            const completed = state.completedSubSkills['9_Derivatives'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["power", "trig", "chain"];
            const type = pick(available);
            if (type === "power") {
                const n = rand(2, 6);
                return { question: `d/dx(x${["⁰","¹","²","³","⁴","⁵","⁶"][n]}) = ?`, answer: `${n}x^${n-1}`, type: "procedural",
                    options: [`${n}x^${n-1}`, `x^${n+1}`, `${n}x^${n}`, `x^${n-1}`],
                    explanation: `Power rule: d/dx(x^n) = nx^(n-1). So d/dx(x^${n}) = ${n}x^${n-1}` };
            } else if (type === "trig") {
                const funcs = [
                    { f: "sin(x)", d: "cos(x)" }, { f: "cos(x)", d: "-sin(x)" },
                    { f: "tan(x)", d: "sec²(x)" }
                ];
                const func = pick(funcs);
                return { question: `d/dx(${func.f}) = ?`, answer: func.d, type: "procedural",
                    options: ["cos(x)", "-sin(x)", "sin(x)", "sec²(x)"],
                    explanation: `d/dx(${func.f}) = ${func.d}` };
            } else {
                const a = rand(2, 5);
                return { question: `d/dx(${a}x³) = ?`, answer: `${3*a}x²`, type: "procedural",
                    options: [`${3*a}x²`, `${a}x²`, `${3*a}x³`, `${a}x⁴`],
                    explanation: `Constant multiple + power rule: ${a} × 3x² = ${3*a}x²` };
            }
        },
        Integrals: () => {
            const subSkillToType = { 'power': 'power', 'trig': 'trig', 'definite': 'definite' };
            const completed = state.completedSubSkills['9_Integrals'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["power", "trig", "definite"];
            const type = pick(available);
            if (type === "power") {
                const n = rand(1, 4);
                return { question: `∫x${["⁰","¹","²","³","⁴"][n]} dx = ?`, answer: `x^${n+1}/${n+1} + C`, type: "procedural",
                    options: [`x^${n+1}/${n+1} + C`, `${n}x^${n-1} + C`, `x^${n+1} + C`, `x^${n}/${n} + C`],
                    explanation: `Power rule: ∫x^n dx = x^(n+1)/(n+1) + C` };
            } else if (type === "trig") {
                const funcs = [
                    { f: "cos(x)", i: "sin(x) + C" }, { f: "sin(x)", i: "-cos(x) + C" }
                ];
                const func = pick(funcs);
                return { question: `∫${func.f} dx = ?`, answer: func.i, type: "procedural",
                    options: ["sin(x) + C", "-cos(x) + C", "cos(x) + C", "-sin(x) + C"],
                    explanation: `∫${func.f} dx = ${func.i}` };
            } else {
                const a = 0, b = rand(2, 4);
                const answer = (b * b) / 2;
                return { question: `∫₀${["⁰","¹","²","³","⁴"][b]} x dx = ?`, answer, type: "procedural",
                    explanation: `[x²/2]₀^${b} = ${b}²/2 - 0 = ${answer}` };
            }
        },
        "Calculus Limits": () => {
            const subSkillToType = { 'fundamental': 'fundamental', 'lhopital': 'lhopital' };
            const completed = state.completedSubSkills['9_Calculus Limits'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["fundamental", "lhopital"];
            const type = pick(available);
            if (type === "fundamental") {
                return { question: `lim(x→0) sin(x)/x = ?`, answer: 1, type: "procedural",
                    explanation: `This is a fundamental limit: lim(x→0) sin(x)/x = 1` };
            } else {
                const a = rand(2, 4);
                return { question: `lim(x→0) (e^(${a}x) - 1)/${a}x = ?`, answer: 1, type: "procedural",
                    explanation: `Using L'Hôpital's or substitution: limit = 1` };
            }
        },
        Applications: () => {
            const subSkillToType = { 'critical': 'critical', 'maxmin': 'maxmin' };
            const completed = state.completedSubSkills['9_Applications'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["critical", "maxmin"];
            const type = pick(available);
            if (type === "critical") {
                const a = rand(1, 3);
                return { question: `f(x) = x² - ${2*a}x. Find critical point.`, answer: a, type: "procedural",
                    explanation: `f'(x) = 2x - ${2*a} = 0. x = ${a}` };
            } else {
                return { question: `If f'(c) = 0 and f''(c) > 0, then x = c is a...`, answer: "local minimum", type: "conceptual",
                    options: ["local minimum", "local maximum", "inflection point", "saddle point"],
                    explanation: `Second derivative test: f''(c) > 0 means concave up, so minimum` };
            }
        },
        "Differential Equations": () => {
            const subSkillToType = { 'identify': 'identify', 'verify': 'verify', 'separate': 'separate' };
            const completed = state.completedSubSkills['9_Differential Equations'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["identify", "verify", "separate"];
            const type = pick(available);
            if (type === "identify") {
                const eqs = [
                    { eq: "dy/dx = 2x", order: 1, type: "first-order" },
                    { eq: "d²y/dx² + y = 0", order: 2, type: "second-order" },
                    { eq: "dy/dx = y", order: 1, type: "first-order" }
                ];
                const e = pick(eqs);
                return { question: `What order is ${e.eq}?`, answer: e.type, type: "conceptual",
                    options: ["first-order", "second-order", "third-order"],
                    explanation: `Highest derivative is ${e.order === 1 ? "dy/dx" : "d²y/dx²"}, so it's ${e.type}` };
            } else if (type === "verify") {
                const a = rand(2, 4);
                return { question: `Is y = e^(${a}x) a solution to dy/dx = ${a}y?`, answer: "yes", type: "conceptual",
                    options: ["yes", "no"],
                    explanation: `dy/dx = ${a}e^(${a}x) = ${a}y ✓ Yes, it satisfies the equation.` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve: dy/dx = ${a}. What is y?`, answer: `${a}x + C`, type: "procedural",
                    options: [`${a}x + C`, `${a}x`, `x/${a} + C`, `e^(${a}x)`],
                    explanation: `Integrate both sides: y = ∫${a} dx = ${a}x + C` };
            }
        },
        "Chain Rule": () => {
            const subSkillToType = { 'basic': 'basic', 'trig': 'trig', 'exponential': 'exponential' };
            const completed = state.completedSubSkills['9_Chain Rule'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["basic", "trig", "exponential"];
            const type = pick(available);
            if (type === "basic") {
                const a = rand(2, 4), n = rand(2, 4);
                return { question: `d/dx(${a}x + 1)^${n} = ?`, answer: `${a * n}(${a}x + 1)^${n - 1}`, type: "procedural",
                    options: [`${a * n}(${a}x + 1)^${n - 1}`, `${n}(${a}x + 1)^${n - 1}`, `${a}(${a}x + 1)^${n}`, `${n}x^${n - 1}`],
                    explanation: `Chain rule: ${n}(${a}x + 1)^${n-1} × ${a} = ${a * n}(${a}x + 1)^${n - 1}` };
            } else if (type === "trig") {
                const a = rand(2, 5);
                return { question: `d/dx[sin(${a}x)] = ?`, answer: `${a}cos(${a}x)`, type: "procedural",
                    options: [`${a}cos(${a}x)`, `cos(${a}x)`, `-${a}cos(${a}x)`, `${a}sin(${a}x)`],
                    explanation: `Chain rule: cos(${a}x) × ${a} = ${a}cos(${a}x)` };
            } else {
                const a = rand(2, 4);
                return { question: `d/dx[e^(${a}x)] = ?`, answer: `${a}e^(${a}x)`, type: "procedural",
                    options: [`${a}e^(${a}x)`, `e^(${a}x)`, `${a}e^x`, `xe^(${a}x)`],
                    explanation: `Chain rule: e^(${a}x) × ${a} = ${a}e^(${a}x)` };
            }
        },
        "Product Rule": () => {
            const subSkillToType = { 'basic': 'basic', 'trig': 'trig' };
            const completed = state.completedSubSkills['9_Product Rule'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["basic", "trig"];
            const type = pick(available);
            if (type === "basic") {
                const a = rand(2, 4);
                return { question: `d/dx[x · e^(${a}x)] = ?`, answer: `e^(${a}x) + ${a}xe^(${a}x)`, type: "procedural",
                    options: [`e^(${a}x) + ${a}xe^(${a}x)`, `${a}xe^(${a}x)`, `e^(${a}x)`, `${a}e^(${a}x)`],
                    explanation: `Product rule: (1)·e^(${a}x) + x·(${a}e^(${a}x)) = e^(${a}x) + ${a}xe^(${a}x)` };
            } else {
                return { question: `d/dx[x·sin(x)] = ?`, answer: "sin(x) + x·cos(x)", type: "procedural",
                    options: ["sin(x) + x·cos(x)", "x·cos(x)", "sin(x)", "cos(x)"],
                    explanation: `Product rule: (1)·sin(x) + x·cos(x) = sin(x) + x·cos(x)` };
            }
        },
        "Integration Techniques": () => {
            const subSkillToType = { 'substitution': 'substitution', 'parts': 'parts', 'trig': 'trig' };
            const completed = state.completedSubSkills['9_Integration Techniques'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["substitution", "parts", "trig"];
            const type = pick(available);
            if (type === "substitution") {
                const a = rand(2, 4);
                return { question: `∫${a}x·e^(x²) dx. What substitution?`, answer: "u = x²", type: "procedural",
                    options: ["u = x²", "u = e^(x²)", "u = x", "u = ${a}x"],
                    explanation: `Let u = x², du = 2x dx. Rewrite as (${a}/2)∫e^u du` };
            } else if (type === "parts") {
                return { question: `∫x·e^x dx uses integration by parts. What is u?`, answer: "u = x", type: "procedural",
                    options: ["u = x", "u = e^x", "u = xe^x", "u = 1"],
                    explanation: `LIATE rule: Logarithms, Inverse trig, Algebraic (x), Trig, Exponential. Pick u = x.` };
            } else {
                return { question: `∫sin²(x) dx uses which identity?`, answer: "sin²(x) = (1 - cos(2x))/2", type: "conceptual",
                    options: ["sin²(x) = (1 - cos(2x))/2", "sin²(x) + cos²(x) = 1", "sin(2x) = 2sin(x)cos(x)", "cos²(x) = (1 + cos(2x))/2"],
                    explanation: `Power-reducing: sin²(x) = (1 - cos(2x))/2 makes integration easier.` };
            }
        },
        "Quotient Rule": () => {
            const subSkillToType = { 'formula': 'formula', 'apply': 'apply', 'simplify': 'simplify' };
            const completed = state.completedSubSkills['9_Quotient Rule'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["formula", "apply", "simplify"];
            const type = pick(available);
            if (type === "formula") {
                return { question: `Quotient rule: d/dx[f/g] = ?`, answer: "(f'g - fg')/g²", type: "conceptual",
                    options: ["(f'g - fg')/g²", "(f'g + fg')/g²", "f'/g'", "(fg' - f'g)/g²"],
                    explanation: `Quotient rule: d/dx[f/g] = (f'g - fg')/g² (lo d-hi minus hi d-lo over lo-lo)` };
            } else if (type === "apply") {
                const a = rand(2, 4);
                return { question: `d/dx[x/(x + ${a})] = ?`, answer: `${a}/(x + ${a})²`, type: "procedural",
                    options: [`${a}/(x + ${a})²`, `1/(x + ${a})`, `x/(x + ${a})²`, `-${a}/(x + ${a})²`],
                    explanation: `f=x, g=x+${a}. (1·(x+${a}) - x·1)/(x+${a})² = ${a}/(x + ${a})²` };
            } else {
                return { question: `d/dx[sin(x)/x] at x = π/2 is approximately:`, answer: "-0.21", type: "procedural",
                    options: ["-0.21", "0.21", "0", "1"],
                    explanation: `(cos(x)·x - sin(x)·1)/x². At π/2: (0·π/2 - 1·1)/(π/2)² ≈ -0.21` };
            }
        },
        "Implicit Differentiation": () => {
            const subSkillToType = { 'circle': 'circle', 'product': 'product', 'concept': 'concept' };
            const completed = state.completedSubSkills['9_Implicit Differentiation'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["circle", "product", "concept"];
            const type = pick(available);
            if (type === "circle") {
                const r = rand(2, 5);
                return { question: `x² + y² = ${r*r}. Find dy/dx.`, answer: "-x/y", type: "procedural",
                    options: ["-x/y", "x/y", "-y/x", "y/x"],
                    explanation: `Differentiate: 2x + 2y(dy/dx) = 0. Solve: dy/dx = -x/y` };
            } else if (type === "product") {
                return { question: `xy = 6. Find dy/dx.`, answer: "-y/x", type: "procedural",
                    options: ["-y/x", "y/x", "-x/y", "-6/x²"],
                    explanation: `Product rule: y + x(dy/dx) = 0. So dy/dx = -y/x` };
            } else {
                return { question: `When do we use implicit differentiation?`, answer: "When y isn't isolated", type: "conceptual",
                    options: ["When y isn't isolated", "When y = f(x)", "For polynomials only", "When there's no y"],
                    explanation: `Implicit differentiation is used when y cannot be easily solved for as a function of x.` };
            }
        },
        "Related Rates": () => {
            const subSkillToType = { 'sphere': 'setup', 'circle': 'circle', 'concept': 'concept' };
            const completed = state.completedSubSkills['9_Related Rates'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["setup", "circle", "concept"];
            const type = pick(available);
            if (type === "setup") {
                return { question: `Sphere volume V = (4/3)πr³. If dr/dt = 2, what is dV/dt when r = 3?`, answer: "72π", type: "procedural",
                    options: ["72π", "36π", "108π", "24π"],
                    explanation: `dV/dt = 4πr²(dr/dt) = 4π(3)²(2) = 72π` };
            } else if (type === "circle") {
                return { question: `Circle area A = πr². If dr/dt = 3, what is dA/dt when r = 5?`, answer: "30π", type: "procedural",
                    options: ["30π", "15π", "75π", "10π"],
                    explanation: `dA/dt = 2πr(dr/dt) = 2π(5)(3) = 30π` };
            } else {
                return { question: `In related rates, we differentiate with respect to:`, answer: "time (t)", type: "conceptual",
                    options: ["time (t)", "x", "y", "the dependent variable"],
                    explanation: `Related rates problems involve quantities changing with respect to time.` };
            }
        },
        "U-Substitution": () => {
            const subSkillToType = { 'identify': 'identify', 'solve': 'solve', 'reverse': 'reverse' };
            const completed = state.completedSubSkills['9_U-Substitution'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["identify", "solve", "reverse"];
            const type = pick(available);
            if (type === "identify") {
                const a = rand(2, 4);
                return { question: `∫${a}x(x² + 1)³ dx. Best substitution?`, answer: "u = x² + 1", type: "procedural",
                    options: ["u = x² + 1", "u = x²", "u = ${a}x", "u = (x² + 1)³"],
                    explanation: `u = x² + 1, du = 2x dx. The ${a}x dx can be written as (${a}/2)du.` };
            } else if (type === "solve") {
                return { question: `∫2x·e^(x²) dx = ?`, answer: "e^(x²) + C", type: "procedural",
                    options: ["e^(x²) + C", "2e^(x²) + C", "x²e^(x²) + C", "e^(2x) + C"],
                    explanation: `u = x², du = 2x dx. ∫e^u du = e^u + C = e^(x²) + C` };
            } else {
                return { question: `If u = 3x + 2, then du = ?`, answer: "3 dx", type: "procedural",
                    options: ["3 dx", "dx", "3x dx", "(3x + 2) dx"],
                    explanation: `Differentiate u = 3x + 2: du/dx = 3, so du = 3 dx` };
            }
        },
        "Integration by Parts": () => {
            const subSkillToType = { 'formula': 'formula', 'choose_u': 'choose_u', 'apply': 'apply' };
            const completed = state.completedSubSkills['9_Integration by Parts'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["formula", "choose_u", "apply"];
            const type = pick(available);
            if (type === "formula") {
                return { question: `Integration by parts formula: ∫u dv = ?`, answer: "uv - ∫v du", type: "conceptual",
                    options: ["uv - ∫v du", "uv + ∫v du", "u dv - v du", "∫u·∫v"],
                    explanation: `Integration by parts: ∫u dv = uv - ∫v du` };
            } else if (type === "choose_u") {
                const funcs = [
                    { integral: "∫x·cos(x) dx", u: "x", reason: "LIATE: Algebraic before Trig" },
                    { integral: "∫x·e^x dx", u: "x", reason: "LIATE: Algebraic before Exponential" },
                    { integral: "∫ln(x) dx", u: "ln(x)", reason: "LIATE: Logarithm first" }
                ];
                const f = pick(funcs);
                return { question: `${f.integral}. What should u be?`, answer: f.u, type: "procedural",
                    options: ["x", "cos(x)", "e^x", "ln(x)"],
                    explanation: `${f.reason}. So u = ${f.u}` };
            } else {
                return { question: `∫x·e^x dx = ?`, answer: "xe^x - e^x + C", type: "procedural",
                    options: ["xe^x - e^x + C", "xe^x + C", "x²e^x/2 + C", "e^x + C"],
                    explanation: `u = x, dv = e^x dx. uv - ∫v du = xe^x - ∫e^x dx = xe^x - e^x + C` };
            }
        }
    },

    // TIER 10: Advanced (College)
    10: {
        "Partial Derivatives": () => {
            const subSkillToType = { 'partial_x': 'x', 'partial_y': 'y' };
            const completed = state.completedSubSkills['10_Partial Derivatives'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["x", "y"];
            const type = pick(available);
            const a = rand(2, 5), b = rand(1, 4);
            if (type === "x") {
                return { question: `∂/∂x(${a}x²y + ${b}xy) = ?`, answer: `${2*a}xy + ${b}y`, type: "procedural",
                    options: [`${2*a}xy + ${b}y`, `${a}x²  + ${b}x`, `${2*a}x + ${b}`, `${a}y + ${b}y`],
                    explanation: `Treat y as constant: ∂/∂x(${a}x²y) = ${2*a}xy, ∂/∂x(${b}xy) = ${b}y` };
            } else {
                return { question: `∂/∂y(${a}x²y + ${b}y²) = ?`, answer: `${a}x² + ${2*b}y`, type: "procedural",
                    options: [`${a}x² + ${2*b}y`, `${2*a}xy + ${b}y`, `${a}x² + ${b}y`, `${2*a}x + ${2*b}y`],
                    explanation: `Treat x as constant: ∂/∂y(${a}x²y) = ${a}x², ∂/∂y(${b}y²) = ${2*b}y` };
            }
        },
        Matrices: () => {
            const subSkillToType = { 'determinant': 'determinant', 'multiply_size': 'multiply_size' };
            const completed = state.completedSubSkills['10_Matrices'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["determinant", "multiply_size"];
            const type = pick(available);
            if (type === "determinant") {
                const a = rand(1, 4), b = rand(1, 4), c = rand(1, 4), d = rand(1, 4);
                const det = a * d - b * c;
                return { question: `det([${a} ${b}; ${c} ${d}]) = ?`, answer: det, type: "procedural",
                    explanation: `det = ad - bc = ${a}×${d} - ${b}×${c} = ${det}` };
            } else {
                const m = rand(2, 4), n = rand(2, 4), p = rand(2, 4);
                return { question: `(${m}×${n}) × (${n}×${p}) matrix = ?`, answer: `${m}×${p}`, type: "procedural",
                    options: [`${m}×${p}`, `${n}×${n}`, `${m}×${n}`, `${n}×${p}`],
                    explanation: `(m×n)(n×p) = m×p. Result: ${m}×${p}` };
            }
        },
        Series: () => {
            const subSkillToType = { 'geometric': 'geometric', 'convergence': 'convergence' };
            const completed = state.completedSubSkills['10_Series'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["geometric", "convergence"];
            const type = pick(available);
            if (type === "geometric") {
                const a = rand(1, 3), r = pick([0.5, 0.25, 0.1]);
                const sum = a / (1 - r);
                return { question: `Sum of infinite geometric: a=${a}, r=${r}?`, answer: sum, type: "procedural",
                    explanation: `S = a/(1-r) = ${a}/(1-${r}) = ${a}/${1-r} = ${sum}` };
            } else {
                return { question: `Σ(1/n²) from n=1 to ∞ converges or diverges?`, answer: "converges", type: "conceptual",
                    options: ["converges", "diverges"],
                    explanation: `p-series with p=2 > 1, so it converges` };
            }
        },
        "Discrete Math": () => {
            const subSkillToType = { 'subsets': 'subsets', 'pigeonhole': 'pigeonhole' };
            const completed = state.completedSubSkills['10_Discrete Math'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["subsets", "pigeonhole"];
            const type = pick(available);
            if (type === "subsets") {
                const n = rand(3, 6);
                return { question: `How many subsets of a ${n}-element set?`, answer: Math.pow(2, n), type: "procedural",
                    explanation: `2^n = 2^${n} = ${Math.pow(2, n)} subsets` };
            } else {
                const n = rand(3, 5);
                return { question: `${n*2 + 1} items in ${n} boxes. Min items in one box?`, answer: 3, type: "reasoning",
                    explanation: `Pigeonhole: ⌈${n*2+1}/${n}⌉ = ⌈${(n*2+1)/n}⌉ = 3` };
            }
        },
        "Multivariable Calculus": () => {
            const subSkillToType = { 'gradient': 'gradient', 'double': 'double', 'chain': 'chain' };
            const completed = state.completedSubSkills['10_Multivariable Calculus'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["gradient", "double", "chain"];
            const type = pick(available);
            if (type === "gradient") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `f(x,y) = ${a}x + ${b}y. Find ∇f.`, answer: `⟨${a}, ${b}⟩`, type: "procedural",
                    options: [`⟨${a}, ${b}⟩`, `⟨${b}, ${a}⟩`, `${a} + ${b}`, `⟨${a*b}, 0⟩`],
                    explanation: `∇f = ⟨∂f/∂x, ∂f/∂y⟩ = ⟨${a}, ${b}⟩` };
            } else if (type === "double") {
                const a = rand(2, 4);
                return { question: `∫∫ ${a} dA over unit square [0,1]×[0,1] = ?`, answer: a, type: "procedural",
                    explanation: `∫₀¹∫₀¹ ${a} dx dy = ${a}(1)(1) = ${a}` };
            } else {
                return { question: `If z = f(x,y), x = g(t), y = h(t), then dz/dt uses...`, answer: "chain rule", type: "conceptual",
                    options: ["chain rule", "product rule", "quotient rule", "power rule"],
                    explanation: `dz/dt = (∂z/∂x)(dx/dt) + (∂z/∂y)(dy/dt) - the multivariable chain rule` };
            }
        },
        "Linear Algebra": () => {
            const subSkillToType = { 'eigenvalue': 'eigenvalue', 'span': 'span', 'independence': 'independence' };
            const completed = state.completedSubSkills['10_Linear Algebra'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["eigenvalue", "span", "independence"];
            const type = pick(available);
            if (type === "eigenvalue") {
                const a = rand(2, 5);
                return { question: `If Av = ${a}v, then ${a} is called a(n)...`, answer: "eigenvalue", type: "conceptual",
                    options: ["eigenvalue", "eigenvector", "determinant", "trace"],
                    explanation: `When Av = λv, λ (here ${a}) is an eigenvalue and v is an eigenvector.` };
            } else if (type === "span") {
                return { question: `Vectors ⟨1,0⟩ and ⟨0,1⟩ span...`, answer: "ℝ²", type: "conceptual",
                    options: ["ℝ²", "ℝ", "ℝ³", "a line"],
                    explanation: `These two vectors can create any point in the plane, so they span ℝ²` };
            } else {
                return { question: `⟨1,2⟩ and ⟨2,4⟩ are linearly...`, answer: "dependent", type: "conceptual",
                    options: ["dependent", "independent"],
                    explanation: `⟨2,4⟩ = 2⟨1,2⟩, so one is a multiple of the other - linearly dependent` };
            }
        },
        Eigenvalues: () => {
            const subSkillToType = { 'definition': 'definition', 'calculate_2x2': 'calculate_2x2', 'properties': 'properties', 'characteristic': 'characteristic' };
            const completed = state.completedSubSkills['10_Eigenvalues'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["definition", "calculate_2x2", "properties", "characteristic"];
            const type = pick(available);
            if (type === "definition") {
                return { question: `In Av = λv, what is λ called?`, answer: "eigenvalue", type: "conceptual",
                    options: ["eigenvalue", "eigenvector", "determinant", "inverse"],
                    explanation: `λ is the eigenvalue. It's the scalar by which the eigenvector v is scaled under transformation A.` };
            } else if (type === "calculate_2x2") {
                // Simple 2x2 diagonal matrix
                const a = rand(1, 4), b = rand(1, 4);
                return { question: `Matrix [${a} 0; 0 ${b}]. Eigenvalues?`, answer: `${a}, ${b}`, type: "procedural",
                    options: [`${a}, ${b}`, `${a+b}, ${a*b}`, `0, ${a+b}`, `${a-b}, ${a+b}`],
                    explanation: `For diagonal matrices, eigenvalues are the diagonal entries: ${a} and ${b}` };
            } else if (type === "properties") {
                return { question: `Sum of eigenvalues equals the matrix's...`, answer: "trace", type: "conceptual",
                    options: ["trace", "determinant", "rank", "norm"],
                    explanation: `Sum of eigenvalues = trace (sum of diagonal elements)` };
            } else {
                return { question: `To find eigenvalues, we solve det(A - λI) = ?`, answer: "0", type: "conceptual",
                    options: ["0", "1", "λ", "det(A)"],
                    explanation: `The characteristic equation det(A - λI) = 0 gives us the eigenvalues.` };
            }
        },
        "Double Integrals": () => {
            const subSkillToType = { 'evaluate': 'evaluate', 'setup': 'setup', 'region': 'region', 'order': 'order' };
            const completed = state.completedSubSkills['10_Double Integrals'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["evaluate", "setup", "region", "order"];
            const type = pick(available);
            if (type === "evaluate") {
                const a = rand(2, 4);
                return { question: `∫₀¹∫₀¹ ${a} dx dy = ?`, answer: a, type: "procedural",
                    options: [a, a * 2, a / 2, 1],
                    explanation: `∫₀¹∫₀¹ ${a} dx dy = ${a}∫₀¹ dx ∫₀¹ dy = ${a}(1)(1) = ${a}` };
            } else if (type === "setup") {
                const r = rand(2, 4);
                return { question: `Area of circle radius ${r} using double integral: ∫∫ dA = ?`, answer: `${r*r}π`, type: "procedural",
                    options: [`${r*r}π`, `${2*r}π`, `${r}π`, `${r*r*r}π`],
                    explanation: `∫∫ dA over circle = πr² = π(${r})² = ${r*r}π` };
            } else if (type === "region") {
                return { question: `∫₀²∫₀ˣ dy dx. What is the region?`, answer: "triangle with vertices (0,0), (2,0), (2,2)", type: "conceptual",
                    options: ["triangle with vertices (0,0), (2,0), (2,2)", "square [0,2]×[0,2]", "rectangle", "semicircle"],
                    explanation: `y goes from 0 to x (line y=x), x goes 0 to 2. Triangle below y=x.` };
            } else {
                return { question: `When should we change the order of integration?`, answer: "when one order is easier to evaluate", type: "conceptual",
                    options: ["when one order is easier to evaluate", "never", "always", "only for rectangles"],
                    explanation: `Changing order can simplify the integral if one direction has easier antiderivatives.` };
            }
        },
        "Triple Integrals": () => {
            const subSkillToType = { 'evaluate': 'evaluate', 'volume': 'volume', 'setup': 'setup', 'coordinates': 'coordinates' };
            const completed = state.completedSubSkills['10_Triple Integrals'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["evaluate", "volume", "setup", "coordinates"];
            const type = pick(available);
            if (type === "evaluate") {
                const a = rand(2, 4);
                return { question: `∫₀¹∫₀¹∫₀¹ ${a} dx dy dz = ?`, answer: a, type: "procedural",
                    options: [a, a * 3, a / 3, 1],
                    explanation: `∫₀¹∫₀¹∫₀¹ ${a} dx dy dz = ${a}(1)(1)(1) = ${a}` };
            } else if (type === "volume") {
                const s = rand(2, 4);
                return { question: `Volume of cube with side ${s} using ∫∫∫ dV = ?`, answer: s * s * s, type: "procedural",
                    options: [s * s * s, s * s, s * 3, 6 * s * s],
                    explanation: `∫∫∫ dV = s³ = ${s}³ = ${s * s * s}` };
            } else if (type === "setup") {
                return { question: `For sphere of radius R, which coordinates are best?`, answer: "spherical", type: "conceptual",
                    options: ["spherical", "Cartesian", "cylindrical", "polar"],
                    explanation: `Spherical coordinates (ρ, θ, φ) are best for spheres due to symmetry.` };
            } else {
                const r = rand(2, 3), h = rand(3, 5);
                return { question: `Volume of cylinder (radius ${r}, height ${h}) = ∫∫∫ dV = ?`, answer: `${r*r*h}π`, type: "procedural",
                    options: [`${r*r*h}π`, `${2*r*h}π`, `${r*r}π`, `${r*h}π`],
                    explanation: `V = πr²h = π(${r})²(${h}) = ${r*r*h}π` };
            }
        },
        "Vector Calculus": () => {
            const subSkillToType = { 'gradient': 'gradient', 'divergence': 'divergence', 'curl': 'curl', 'line_integral': 'line_integral' };
            const completed = state.completedSubSkills['10_Vector Calculus'] || [];
            let available = completed.length > 0 ? completed.map(id => subSkillToType[id]).filter(Boolean) : ["gradient", "divergence", "curl", "line_integral"];
            const type = pick(available);
            if (type === "gradient") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `∇(${a}x² + ${b}y) = ?`, answer: `⟨${2*a}x, ${b}⟩`, type: "procedural",
                    options: [`⟨${2*a}x, ${b}⟩`, `⟨${a}x, ${b}y⟩`, `${2*a}x + ${b}`, `⟨${a}, ${b}⟩`],
                    explanation: `∇f = ⟨∂f/∂x, ∂f/∂y⟩ = ⟨${2*a}x, ${b}⟩` };
            } else if (type === "divergence") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `div⟨${a}x, ${b}y⟩ = ∇·F = ?`, answer: a + b, type: "procedural",
                    options: [a + b, a * b, a - b, `${a}x + ${b}y`],
                    explanation: `∇·F = ∂(${a}x)/∂x + ∂(${b}y)/∂y = ${a} + ${b} = ${a + b}` };
            } else if (type === "curl") {
                return { question: `For F = ⟨y, -x, 0⟩, curl F = ∇×F has z-component:`, answer: "-2", type: "procedural",
                    options: ["-2", "2", "0", "1"],
                    explanation: `z-component of curl = ∂(-x)/∂x - ∂y/∂y = -1 - 1 = -2` };
            } else {
                return { question: `∫_C F·dr is called a:`, answer: "line integral", type: "conceptual",
                    options: ["line integral", "surface integral", "double integral", "gradient"],
                    explanation: `∫_C F·dr is a line integral - integrating a vector field along a curve C.` };
            }
        },
        "Real Analysis": () => {
            const type = pick(["limits", "continuity", "sequences", "series"]);
            if (type === "limits") {
                return { question: `The ε-δ definition of limit is: For all ε > 0, there exists δ > 0 such that...`, answer: "|f(x) - L| < ε when |x - a| < δ", type: "conceptual",
                    options: ["|f(x) - L| < ε when |x - a| < δ", "|f(x) - L| < δ when |x - a| < ε", "f(x) = L when x = a", "|f(x)| < ε"],
                    explanation: `The formal ε-δ definition captures that f(x) can be made arbitrarily close to L by making x sufficiently close to a.` };
            } else if (type === "continuity") {
                return { question: `A function f is continuous at a if:`, answer: "lim(x→a) f(x) = f(a)", type: "conceptual",
                    options: ["lim(x→a) f(x) = f(a)", "f(a) exists", "f is differentiable at a", "f has no jumps"],
                    explanation: `Continuity requires: (1) f(a) exists, (2) lim(x→a) f(x) exists, (3) they are equal.` };
            } else if (type === "sequences") {
                return { question: `A sequence (aₙ) is Cauchy if for all ε > 0:`, answer: "|aₘ - aₙ| < ε for large enough m, n", type: "conceptual",
                    options: ["|aₘ - aₙ| < ε for large enough m, n", "aₙ is bounded", "aₙ is increasing", "|aₙ| < ε"],
                    explanation: `A Cauchy sequence has terms that get arbitrarily close to each other as n increases.` };
            } else {
                return { question: `In ℝ, every Cauchy sequence:`, answer: "converges", type: "conceptual",
                    options: ["converges", "diverges", "oscillates", "is bounded"],
                    explanation: `ℝ is complete: every Cauchy sequence of real numbers converges to a real number.` };
            }
        },
        "Complex Analysis": () => {
            const type = pick(["residue", "cauchy", "analytic", "poles"]);
            if (type === "residue") {
                return { question: `The residue of f(z) = 1/z at z = 0 is:`, answer: "1", type: "procedural",
                    options: ["1", "0", "-1", "undefined"],
                    explanation: `For f(z) = 1/z, the Laurent series is just 1/z, so the coefficient of 1/z (residue) is 1.` };
            } else if (type === "cauchy") {
                return { question: `∮ₒ f(z)dz for analytic f on and inside C equals:`, answer: "0", type: "conceptual",
                    options: ["0", "2πi", "1", "πi"],
                    explanation: `Cauchy's theorem: the integral of an analytic function over a closed contour is 0.` };
            } else if (type === "analytic") {
                return { question: `The Cauchy-Riemann equations are:`, answer: "∂u/∂x = ∂v/∂y and ∂u/∂y = -∂v/∂x", type: "conceptual",
                    options: ["∂u/∂x = ∂v/∂y and ∂u/∂y = -∂v/∂x", "∂u/∂x = ∂v/∂x", "u = v", "∇²u = 0"],
                    explanation: `The Cauchy-Riemann equations are necessary conditions for f = u + iv to be analytic.` };
            } else {
                return { question: `f(z) = 1/(z-2) has a pole at z = ?`, answer: "2", type: "procedural",
                    options: ["2", "0", "-2", "1"],
                    explanation: `A pole occurs where the denominator is zero: z - 2 = 0, so z = 2.` };
            }
        },
        "Abstract Algebra": () => {
            const type = pick(["groups", "rings", "homomorphism", "subgroups"]);
            if (type === "groups") {
                const n = rand(2, 6);
                return { question: `Order of (ℤ/${n}ℤ, +)?`, answer: n, type: "procedural",
                    options: [n, n - 1, n + 1, 2 * n],
                    explanation: `ℤ/${n}ℤ has ${n} elements: {0, 1, 2, ..., ${n-1}}, so its order is ${n}.` };
            } else if (type === "rings") {
                return { question: `A ring must have:`, answer: "addition, multiplication, and additive identity", type: "conceptual",
                    options: ["addition, multiplication, and additive identity", "only addition", "a multiplicative inverse for all elements", "commutativity"],
                    explanation: `A ring requires an abelian group under addition, closed multiplication, and distributivity.` };
            } else if (type === "homomorphism") {
                return { question: `A group homomorphism φ: G → H preserves:`, answer: "the group operation", type: "conceptual",
                    options: ["the group operation", "only the identity", "all elements", "cardinality"],
                    explanation: `φ(ab) = φ(a)φ(b) - the operation is preserved. This implies φ(e) = e and φ(a⁻¹) = φ(a)⁻¹.` };
            } else {
                return { question: `Every group G has at least these two subgroups:`, answer: "{e} and G", type: "conceptual",
                    options: ["{e} and G", "ℤ and ℝ", "{0} and {1}", "none"],
                    explanation: `The trivial subgroup {e} and G itself are always subgroups of G.` };
            }
        },
        "Number Theory": () => {
            const type = pick(["prime", "gcd", "modular", "divisibility"]);
            if (type === "prime") {
                const n = pick([17, 19, 23, 29, 31]);
                return { question: `Is ${n} prime?`, answer: "yes", type: "procedural",
                    options: ["yes", "no"],
                    explanation: `${n} has no divisors other than 1 and itself, so it is prime.` };
            } else if (type === "gcd") {
                const a = rand(12, 24), b = rand(6, 18);
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const result = gcd(a, b);
                return { question: `gcd(${a}, ${b}) = ?`, answer: result, type: "procedural",
                    options: [result, a, b, 1],
                    explanation: `Using Euclidean algorithm: gcd(${a}, ${b}) = ${result}` };
            } else if (type === "modular") {
                const a = rand(10, 20), m = rand(3, 7);
                return { question: `${a} mod ${m} = ?`, answer: a % m, type: "procedural",
                    options: [a % m, (a % m) + 1, m, a],
                    explanation: `${a} = ${Math.floor(a/m)}×${m} + ${a % m}, so ${a} mod ${m} = ${a % m}` };
            } else {
                const a = rand(2, 5), b = rand(3, 8);
                return { question: `${a} | ${a * b} means:`, answer: `${a} divides ${a * b}`, type: "conceptual",
                    options: [`${a} divides ${a * b}`, `${a * b} divides ${a}`, `${a} = ${a * b}`, `${a} > ${a * b}`],
                    explanation: `a | b means "a divides b" - there exists integer k such that b = ak. Here ${a * b} = ${a}×${b}.` };
            }
        },
        "Advanced Number Theory": () => {
            const type = pick(["fermat", "euler", "quadratic_residue", "diophantine"]);
            if (type === "fermat") {
                const p = pick([5, 7, 11, 13]);
                const a = rand(2, p - 1);
                return { question: `By Fermat's Little Theorem, ${a}^${p-1} mod ${p} = ?`, answer: "1", type: "procedural",
                    options: ["1", "0", `${a}`, `${p}`],
                    explanation: `Fermat: aᵖ⁻¹ ≡ 1 (mod p) for prime p and gcd(a,p) = 1. So ${a}^${p-1} ≡ 1 (mod ${p}).` };
            } else if (type === "euler") {
                return { question: `Euler's totient φ(p) for prime p equals:`, answer: "p - 1", type: "conceptual",
                    options: ["p - 1", "p", "p + 1", "1"],
                    explanation: `For prime p, all numbers 1 to p-1 are coprime to p, so φ(p) = p - 1.` };
            } else if (type === "quadratic_residue") {
                return { question: `3 is a quadratic residue mod 7 if:`, answer: "x² ≡ 3 (mod 7) has a solution", type: "conceptual",
                    options: ["x² ≡ 3 (mod 7) has a solution", "3 | 7", "7 | 3", "gcd(3,7) = 1"],
                    explanation: `a is a quadratic residue mod n if x² ≡ a (mod n) is solvable. Here, 3² = 9 ≡ 2 ≠ 3, 5² = 25 ≡ 4 ≠ 3, etc.` };
            } else {
                return { question: `ax + by = gcd(a,b) always has:`, answer: "integer solutions", type: "conceptual",
                    options: ["integer solutions", "no solutions", "unique solutions", "infinite prime solutions"],
                    explanation: `Bézout's identity: For any integers a,b, there exist integers x,y such that ax + by = gcd(a,b).` };
            }
        },
        "Mathematical Logic": () => {
            const type = pick(["propositional", "predicate", "proof", "completeness"]);
            if (type === "propositional") {
                return { question: `p → q is logically equivalent to:`, answer: "¬p ∨ q", type: "conceptual",
                    options: ["¬p ∨ q", "p ∨ q", "p ∧ q", "¬p ∧ q"],
                    explanation: `"If p then q" is false only when p is true and q is false. This matches ¬p ∨ q.` };
            } else if (type === "predicate") {
                return { question: `¬∀x P(x) is equivalent to:`, answer: "∃x ¬P(x)", type: "conceptual",
                    options: ["∃x ¬P(x)", "∀x ¬P(x)", "¬∃x P(x)", "∀x P(x)"],
                    explanation: `"Not all x satisfy P" means "there exists some x that doesn't satisfy P."` };
            } else if (type === "proof") {
                return { question: `To prove "if P then Q" by contrapositive, we prove:`, answer: "if ¬Q then ¬P", type: "conceptual",
                    options: ["if ¬Q then ¬P", "if Q then P", "¬P and ¬Q", "P or ¬Q"],
                    explanation: `The contrapositive ¬Q → ¬P is logically equivalent to P → Q.` };
            } else {
                return { question: `Gödel's Completeness Theorem states:`, answer: "every valid formula is provable", type: "conceptual",
                    options: ["every valid formula is provable", "some true statements are unprovable", "all statements are provable", "logic is inconsistent"],
                    explanation: `Completeness: if a first-order formula is true in all models, it has a formal proof.` };
            }
        },
        "Differential Geometry": () => {
            const type = pick(["curvature", "manifold", "geodesic", "tangent"]);
            if (type === "curvature") {
                const r = rand(2, 5);
                return { question: `Curvature κ of a circle with radius ${r}:`, answer: `1/${r}`, type: "procedural",
                    options: [`1/${r}`, `${r}`, `2π${r}`, `π${r}²`],
                    explanation: `For a circle, curvature κ = 1/r. Smaller radius means higher curvature (tighter turn).` };
            } else if (type === "manifold") {
                return { question: `A 2-dimensional manifold is locally like:`, answer: "ℝ²", type: "conceptual",
                    options: ["ℝ²", "ℝ³", "a sphere", "a circle"],
                    explanation: `An n-manifold is locally homeomorphic to ℝⁿ. A 2-manifold looks like a plane near any point.` };
            } else if (type === "geodesic") {
                return { question: `On a sphere, geodesics are:`, answer: "great circles", type: "conceptual",
                    options: ["great circles", "small circles", "straight lines", "spirals"],
                    explanation: `Geodesics are shortest paths. On a sphere, these are arcs of great circles (like the equator).` };
            } else {
                return { question: `The tangent space TₚM at point p is:`, answer: "a vector space of tangent vectors at p", type: "conceptual",
                    options: ["a vector space of tangent vectors at p", "the manifold itself", "a single vector", "the normal line"],
                    explanation: `TₚM contains all vectors tangent to M at p, forming a vector space of the same dimension as M.` };
            }
        },
        Topology: () => {
            const type = pick(["open_sets", "continuity", "homeomorphism", "compactness"]);
            if (type === "open_sets") {
                return { question: `In a topology, the intersection of two open sets is:`, answer: "open", type: "conceptual",
                    options: ["open", "closed", "neither", "undefined"],
                    explanation: `By definition, a topology must be closed under finite intersections of open sets.` };
            } else if (type === "continuity") {
                return { question: `f: X → Y is continuous if the preimage of every open set is:`, answer: "open", type: "conceptual",
                    options: ["open", "closed", "compact", "connected"],
                    explanation: `Topological continuity: f⁻¹(U) is open in X for every open U in Y.` };
            } else if (type === "homeomorphism") {
                return { question: `A coffee cup and a donut are topologically equivalent because:`, answer: "they have the same number of holes (genus 1)", type: "conceptual",
                    options: ["they have the same number of holes (genus 1)", "they have the same volume", "they are both round", "they can both hold liquid"],
                    explanation: `Both have exactly one hole (handle/hole), so they're homeomorphic - can be continuously deformed into each other.` };
            } else {
                return { question: `[0, 1] is compact in ℝ because:`, answer: "it is closed and bounded", type: "conceptual",
                    options: ["it is closed and bounded", "it contains 0", "it is connected", "it is finite"],
                    explanation: `Heine-Borel: In ℝⁿ, compact ⟺ closed and bounded. [0,1] satisfies both.` };
            }
        },
        "Advanced Statistics": () => {
            const type = pick(["hypothesis", "confidence", "regression", "bayesian"]);
            if (type === "hypothesis") {
                return { question: `In hypothesis testing, the p-value represents:`, answer: "probability of observing data as extreme given H₀ is true", type: "conceptual",
                    options: ["probability of observing data as extreme given H₀ is true", "probability H₀ is true", "probability of Type II error", "the sample mean"],
                    explanation: `p-value = P(data as or more extreme | H₀ true). It's NOT the probability that H₀ is true.` };
            } else if (type === "confidence") {
                return { question: `A 95% confidence interval means:`, answer: "95% of intervals from repeated sampling contain the true parameter", type: "conceptual",
                    options: ["95% of intervals from repeated sampling contain the true parameter", "95% probability the parameter is in this interval", "the parameter is in the interval 95% of the time", "95% of data is in the interval"],
                    explanation: `Frequentist interpretation: 95% of CIs constructed this way would contain the true value.` };
            } else if (type === "regression") {
                return { question: `In linear regression, R² measures:`, answer: "proportion of variance explained by the model", type: "conceptual",
                    options: ["proportion of variance explained by the model", "the slope", "correlation", "standard error"],
                    explanation: `R² = 1 - (SS_residual/SS_total). It ranges from 0 to 1; higher means better fit.` };
            } else {
                return { question: `Bayes' theorem: P(A|B) = ?`, answer: "P(B|A)P(A) / P(B)", type: "conceptual",
                    options: ["P(B|A)P(A) / P(B)", "P(A)P(B)", "P(A) + P(B)", "P(A|B)P(B)"],
                    explanation: `Bayes: P(A|B) = P(B|A)P(A)/P(B). Updates prior P(A) with likelihood P(B|A).` };
            }
        },
        "Applied Mathematics": () => {
            const type = pick(["modeling", "optimization", "numerical", "ode"]);
            if (type === "modeling") {
                return { question: `Population growth P' = kP is called:`, answer: "exponential growth model", type: "conceptual",
                    options: ["exponential growth model", "logistic model", "linear model", "harmonic model"],
                    explanation: `dP/dt = kP has solution P = P₀eᵏᵗ - exponential growth (or decay if k < 0).` };
            } else if (type === "optimization") {
                return { question: `At a local minimum, the gradient ∇f equals:`, answer: "0 (zero vector)", type: "conceptual",
                    options: ["0 (zero vector)", "1", "undefined", "maximum"],
                    explanation: `First-order necessary condition: ∇f = 0 at local extrema. Need second derivatives to classify.` };
            } else if (type === "numerical") {
                return { question: `Euler's method approximates y' = f(x,y) using:`, answer: "yₙ₊₁ = yₙ + hf(xₙ, yₙ)", type: "conceptual",
                    options: ["yₙ₊₁ = yₙ + hf(xₙ, yₙ)", "y'' = f(x,y)", "∫f dx", "y = eˣ"],
                    explanation: `Euler: step forward using the tangent line. yₙ₊₁ = yₙ + h×slope, where slope = f(xₙ, yₙ).` };
            } else {
                return { question: `The heat equation ∂u/∂t = k∂²u/∂x² is a:`, answer: "parabolic PDE", type: "conceptual",
                    options: ["parabolic PDE", "elliptic PDE", "hyperbolic PDE", "ODE"],
                    explanation: `Heat/diffusion equations are parabolic. Wave equations are hyperbolic. Laplace's equation is elliptic.` };
            }
        },
        "Theoretical Mathematics": () => {
            const type = pick(["foundations", "proof_theory", "set_theory", "axioms"]);
            if (type === "foundations") {
                return { question: `ZFC stands for:`, answer: "Zermelo-Fraenkel with Choice", type: "conceptual",
                    options: ["Zermelo-Fraenkel with Choice", "Zero-Free Calculus", "Zorn's Fundamental Conjecture", "Zeros and Functions of C"],
                    explanation: `ZFC is the standard axiomatic system for modern mathematics, including the Axiom of Choice.` };
            } else if (type === "proof_theory") {
                return { question: `Gödel's Incompleteness Theorem states:`, answer: "any consistent system has unprovable true statements", type: "conceptual",
                    options: ["any consistent system has unprovable true statements", "all statements are provable", "mathematics is inconsistent", "proofs are unnecessary"],
                    explanation: `Gödel showed that sufficiently powerful, consistent systems contain true statements that cannot be proved within the system.` };
            } else if (type === "set_theory") {
                return { question: `|ℕ| = |ℤ| = |ℚ| is called:`, answer: "ℵ₀ (aleph-null)", type: "conceptual",
                    options: ["ℵ₀ (aleph-null)", "ℵ₁", "∞", "ω"],
                    explanation: `ℕ, ℤ, and ℚ are all countably infinite with cardinality ℵ₀ (aleph-null).` };
            } else {
                return { question: `The Continuum Hypothesis states:`, answer: "there's no set with cardinality between ℵ₀ and |ℝ|", type: "conceptual",
                    options: ["there's no set with cardinality between ℵ₀ and |ℝ|", "ℝ is countable", "all sets are finite", "ℵ₀ = ℵ₁"],
                    explanation: `CH: |ℝ| = ℵ₁. Gödel and Cohen proved CH is independent of ZFC - it can't be proved or disproved.` };
            }
        },
        "Advanced Computational Methods": () => {
            const type = pick(["complexity", "algorithms", "numerical", "approximation"]);
            if (type === "complexity") {
                return { question: `O(n log n) is the best possible for:`, answer: "comparison-based sorting", type: "conceptual",
                    options: ["comparison-based sorting", "searching", "matrix multiplication", "addition"],
                    explanation: `Information-theoretic lower bound: n! permutations require log(n!) = Ω(n log n) comparisons to distinguish.` };
            } else if (type === "algorithms") {
                return { question: `The Master Theorem solves recurrences of the form:`, answer: "T(n) = aT(n/b) + f(n)", type: "conceptual",
                    options: ["T(n) = aT(n/b) + f(n)", "T(n) = T(n-1) + n", "T(n) = 2ⁿ", "T(n) = n!"],
                    explanation: `Master Theorem handles divide-and-conquer recurrences T(n) = aT(n/b) + f(n).` };
            } else if (type === "numerical") {
                return { question: `Newton's method converges:`, answer: "quadratically (doubles digits each step)", type: "conceptual",
                    options: ["quadratically (doubles digits each step)", "linearly", "logarithmically", "never"],
                    explanation: `Near a root, Newton's method has quadratic convergence: error ≈ C(error)² each iteration.` };
            } else {
                return { question: `Monte Carlo methods use:`, answer: "random sampling to estimate quantities", type: "conceptual",
                    options: ["random sampling to estimate quantities", "exact calculations", "symbolic computation", "recursive calls"],
                    explanation: `Monte Carlo: use randomness to estimate integrals, expectations, or solve problems probabilistically.` };
            }
        }
    }
};

// ========================================
// LESSON GENERATORS FOR LEARNING CENTER
// ========================================
const lessons = {
    1: {
        Counting: () => {
            return {
                goalProblem: `Count the stars: ★ ★ ★ ★ ★ ★`,
                teachingSteps: [
                    {
                        title: "What is counting?",
                        explanation: "Counting means finding out <strong>how many</strong> things there are. We say numbers in order (1, 2, 3, 4...) while pointing to each item.",
                        visual: "1 → 2 → 3 → 4 → 5 → ..."
                    },
                    {
                        title: "The Golden Rule: One touch, one number",
                        explanation: "Point to each item <strong>exactly once</strong>. Don't skip any items, and don't count any item twice!",
                        visual: "★ = 1 count (not 0, not 2)"
                    },
                    {
                        title: "Let's count our stars - Start at the left",
                        explanation: "We always start on the left side and move right. This keeps us organized. Touch the first star and say '1'.",
                        visual: "★(1)  ★  ★  ★  ★  ★"
                    },
                    {
                        title: "Keep going - touch and count each star",
                        explanation: "Move to the next star, say the next number. Keep going until you've touched every star.",
                        visual: "★(1) ★(2) ★(3) ★(4) ★(5) ★(6)"
                    },
                    {
                        title: "The answer is the LAST number you said",
                        explanation: "We stopped at 6. That means there are 6 stars! The last number always tells you the total.",
                        visual: "Last number said = <strong>6</strong>"
                    }
                ],
                finalAnswer: "6 stars",
                answerExplanation: "We counted each star once, from left to right: 1, 2, 3, 4, 5, 6. The last number (6) is our answer!",
                example: { problem: `Count the stars: ★ ★ ★ ★ ★ ★`, steps: [
                    { text: "Start at the left and point to each star", math: "★(1) ★(2) ★(3) ★(4) ★(5) ★(6)" },
                    { text: "Say each number as you touch each star", math: "One... two... three... four... five... six" },
                    { text: "The LAST number you said is your answer", math: "We stopped at 6, so there are <strong>6 stars</strong>" }
                ]},
                keyPoints: [
                    "Point to each item as you count - this keeps you organized",
                    "The LAST number you say tells you the total",
                    "Go slow! It's better to be careful than fast"
                ],
                mistakes: [
                    { wrong: "Counting too fast and skipping items", why: "Touch each item as you count. Say the number out loud." },
                    { wrong: "Counting the same item twice", why: "Move left to right in a line. Mark items if needed." },
                    { wrong: "Stopping before counting all items", why: "Make sure you've touched every single item." }
                ],
                guided: {
                    problem: `Count the dots: ● ● ● ● ●`,
                    steps: [
                        { label: "Touch and count each dot", value: "●(1) ●(2) ●(3) ●(4) ●(5)" },
                        { label: "What was the last number?", value: "?" }
                    ],
                    answer: "5",
                    answerLabel: "How many dots?",
                    interactiveSteps: [
                        {
                            prompt: "When counting, we touch each item and say a number. Start at the first dot - what number do you say?",
                            hint: "We always start counting at...",
                            answer: "1",
                            acceptableAnswers: ["1", "one"],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                "0": "We start counting at 1, not 0! Touch the first dot and say '1'.",
                                "2": "Start at the beginning! The first item is always 1."
                            }
                        },
                        {
                            prompt: "Now count each dot from left to right: ●(1) ●(2) ●(3) ●(4) ●(?). What number goes on the last dot?",
                            hint: "After 4 comes...",
                            answer: "5",
                            acceptableAnswers: ["5", "five"],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                "4": "You stopped too early! After ●(4), there's one more dot.",
                                "6": "Count again - there are only 5 dots, not 6."
                            }
                        },
                        {
                            prompt: "The LAST number you said tells you the total. How many dots are there?",
                            hint: "What was the last number you counted to?",
                            answer: "5",
                            acceptableAnswers: ["5", "five", "5 dots"],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                "1": "That's the first number. The LAST number (5) tells us the total!",
                                "15": "Don't add up the numbers! The last number you said IS the answer."
                            }
                        }
                    ]
                },
                practice: { problem: `Count: ▲ ▲ ▲ ▲ ▲ ▲ ▲`, answer: "7", options: ["5", "6", "7", "8"],
                    mistakeAnalysis: {
                        "5": "You missed 2 triangles. Go slower - point to EACH one: ▲(1) ▲(2) ▲(3) ▲(4) ▲(5) ▲(6) ▲(7)",
                        "6": "You missed 1 triangle. Count again carefully from left to right.",
                        "8": "You counted one triangle twice. Remember: each item gets counted only ONCE."
                    }}
            };
        },
        Addition: () => {
            const a = rand(3, 6), b = rand(2, 4);
            return {
                goalProblem: `What is 5 + 3?`,
                teachingSteps: [
                    {
                        title: "What does addition mean?",
                        explanation: "Addition means <strong>putting two groups together</strong> to find the total. The + sign means 'add' or 'plus'.",
                        visual: "●●● + ●● = ?"
                    },
                    {
                        title: "The counting-up method",
                        explanation: "To add, we <strong>start at the first number</strong> and <strong>count up</strong> by the second number. Where we land is our answer!",
                        visual: "Start → Count up → Land on answer"
                    },
                    {
                        title: "Let's solve 5 + 3 - Start at 5",
                        explanation: "Put your finger on 5. This is where we <strong>start</strong>. Don't count 5 as 'one' - it's our starting point!",
                        visual: "Start at: 5"
                    },
                    {
                        title: "Now count up 3 times",
                        explanation: "Starting from 5, count up 3 numbers: <strong>6, 7, 8</strong>. Use your fingers to keep track - put up 3 fingers and lower one for each count.",
                        visual: "5 → 6 (one) → 7 (two) → 8 (three)"
                    },
                    {
                        title: "Where did we land?",
                        explanation: "We landed on <strong>8</strong>! That's our answer. We can check: 5 dots + 3 dots = 8 dots.",
                        visual: "●●●●● + ●●● = ●●●●●●●●"
                    }
                ],
                finalAnswer: "5 + 3 = 8",
                answerExplanation: "Starting at 5 and counting up 3 times (6, 7, 8), we land on 8!",
                example: { problem: `What is 5 + 3?`, steps: [
                    { text: "Start at the first number", math: "Put your finger on 5" },
                    { text: "Count UP by the second number (3 times)", math: "5... then 6, 7, 8 (that's 3 more)" },
                    { text: "You landed on 8!", math: "5 + 3 = <strong>8</strong>" }
                ]},
                keyPoints: [
                    "Start AT the first number (don't count it as 'one')",
                    "Count up as many times as the second number says",
                    "You can also add by combining: ●●●●● + ●●● = ●●●●●●●● (8 dots)"
                ],
                mistakes: [
                    { wrong: "Counting the first number (5, 6, 7, 8 = wrong!)", why: "START at 5, then count 6, 7, 8. That's adding 3." },
                    { wrong: "Writing 5 + 3 = 53", why: "We're not putting digits next to each other - we're combining amounts!" },
                    { wrong: "Losing track of how many you counted up", why: "Use your fingers to keep track: hold up 3 fingers and put them down one by one." }
                ],
                guided: {
                    problem: `What is ${a} + ${b}?`,
                    steps: [
                        { label: "Start at", value: `${a}` },
                        { label: `Count up ${b} more`, value: `${a}... ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}` },
                        { label: "You landed on", value: "?" }
                    ],
                    answer: String(a + b),
                    answerLabel: `${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `To add ${a} + ${b}, we start at the first number. What number do we start at?`,
                            hint: "Look at the first number in the problem",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `That's the second number. We START at the first number: ${a}`,
                                "1": `Don't start at 1! Start at the first number: ${a}`,
                                "0": `Start at ${a}, not at 0!`
                            }
                        },
                        {
                            prompt: `Now count UP ${b} times from ${a}. Say the numbers out loud: ${a}... then what comes next?`,
                            hint: `What's one more than ${a}?`,
                            answer: String(a + 1),
                            acceptableAnswers: [String(a + 1)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a)]: `${a} is where we started. Now count UP one: ${a + 1}`,
                                [String(a + b)]: `That's the final answer! But let's count up one at a time. After ${a} comes ${a + 1}`
                            }
                        },
                        {
                            prompt: `Keep counting! ${a}, ${a + 1}... After counting up ${b} times total, where do you land?`,
                            hint: `Count: ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}`,
                            answer: String(a + b),
                            acceptableAnswers: [String(a + b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a + b - 1)]: `You stopped one short! Count ${b} full times: ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}`,
                                [String(a + b + 1)]: `You counted one too many! Only count up ${b} times.`,
                                [String(a)]: `You didn't count up! Starting at ${a}, count up ${b} more.`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1, pb = b; return { problem: `What is ${pa} + ${pb}?`, answer: String(pa + pb),
                    options: shuffle([String(pa + pb), String(pa + pb - 1), String(pa + pb + 1), String(pa + pb - 2)]),
                    mistakeAnalysis: {
                        [String(pa + pb - 1)]: `You undercounted by 1. Start at ${pa}, then count up ${pb}: ${Array.from({length: pb}, (_, i) => pa + i + 1).join(', ')}`,
                        [String(pa + pb + 1)]: "You counted one too many. Make sure you only count up " + pb + " times.",
                        [String(pa + pb - 2)]: `You undercounted by 2. Remember to count up exactly ${pb} times from ${pa}.`
                    }}; })()
            };
        },
        Subtraction: () => {
            const a = rand(8, 12), b = rand(3, 5);
            return {
                goalProblem: `What is 9 - 4?`,
                teachingSteps: [
                    {
                        title: "What does subtraction mean?",
                        explanation: "Subtraction means <strong>taking away</strong> from a group. The − sign (minus) means 'take away' or 'subtract'.",
                        visual: "●●●●●●●●● take away ●●●● = ?"
                    },
                    {
                        title: "The counting-back method",
                        explanation: "To subtract, we <strong>start at the first number</strong> and <strong>count backwards</strong> by the second number. Where we land is our answer!",
                        visual: "Start → Count back → Land on answer"
                    },
                    {
                        title: "Let's solve 9 - 4 - Start at 9",
                        explanation: "Put your finger on 9. This is where we <strong>start</strong>. Don't count 9 as 'one' - it's our starting point!",
                        visual: "Start at: 9"
                    },
                    {
                        title: "Now count BACK 4 times",
                        explanation: "Starting from 9, count backwards 4 numbers: <strong>8, 7, 6, 5</strong>. Use your fingers - put up 4 fingers and lower one for each count back.",
                        visual: "9 → 8 (one) → 7 (two) → 6 (three) → 5 (four)"
                    },
                    {
                        title: "Where did we land?",
                        explanation: "We landed on <strong>5</strong>! That's our answer. Think of it as: 'I had 9 things, I took away 4, now I have 5 left.'",
                        visual: "●●●●●●●●● − ●●●● = ●●●●●"
                    }
                ],
                finalAnswer: "9 - 4 = 5",
                answerExplanation: "Starting at 9 and counting back 4 times (8, 7, 6, 5), we land on 5!",
                example: { problem: `What is 9 - 4?`, steps: [
                    { text: "Start at the first number", math: "Put your finger on 9" },
                    { text: "Count BACK by the second number (4 times)", math: "9... then 8, 7, 6, 5 (that's going back 4)" },
                    { text: "You landed on 5!", math: "9 - 4 = <strong>5</strong>" }
                ]},
                keyPoints: [
                    "Start AT the first number, then count backwards",
                    "Count back as many times as the second number says",
                    "Think: 'I have 9, I take away 4, I have 5 left'"
                ],
                mistakes: [
                    { wrong: "Counting the starting number (9, 8, 7, 6 = wrong!)", why: "START at 9, then go back: 8, 7, 6, 5. The answer is 5." },
                    { wrong: "Adding instead of subtracting", why: "The minus sign (−) means go DOWN, not up!" },
                    { wrong: "Subtracting in the wrong order (4 - 9)", why: "Always start with the FIRST number. 9 - 4 is not the same as 4 - 9." }
                ],
                guided: {
                    problem: `What is ${a} - ${b}?`,
                    steps: [
                        { label: "Start at", value: `${a}` },
                        { label: `Count back ${b}`, value: `${a}... ${Array.from({length: b}, (_, i) => a - i - 1).join(', ')}` },
                        { label: "You landed on", value: "?" }
                    ],
                    answer: String(a - b),
                    answerLabel: `${a} - ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `For ${a} - ${b}, we start at the first number. What number do we start at?`,
                            hint: "Look at the first number in the problem",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `That's the second number. We START at ${a}`,
                                [String(a - b)]: `That's the answer! But first we need to start at ${a}`
                            }
                        },
                        {
                            prompt: `Now count BACK (down) ${b} times. Starting at ${a}, what's the first number when we go back?`,
                            hint: `What's one less than ${a}?`,
                            answer: String(a - 1),
                            acceptableAnswers: [String(a - 1)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a)]: `${a} is where we started. Now go BACK one: ${a - 1}`,
                                [String(a + 1)]: `That's going UP! We need to go DOWN (subtract). One less than ${a} is ${a - 1}`
                            }
                        },
                        {
                            prompt: `Keep counting back! ${a}, ${a - 1}... After counting back ${b} times, where do you land?`,
                            hint: `Count backwards: ${Array.from({length: b}, (_, i) => a - i - 1).join(', ')}`,
                            answer: String(a - b),
                            acceptableAnswers: [String(a - b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a - b + 1)]: `You didn't count back far enough! Go back ${b} full times.`,
                                [String(a - b - 1)]: `You counted back one too many! Only count back ${b} times.`,
                                [String(a + b)]: `You added instead of subtracted! Count BACKWARDS from ${a}.`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1; return { problem: `What is ${pa} - ${b}?`, answer: String(pa - b),
                    options: shuffle([String(pa - b), String(pa - b - 1), String(pa - b + 1), String(pa + b)]),
                    mistakeAnalysis: {
                        [String(pa - b - 1)]: "You went back one too many. Count carefully: start at " + pa + " and go back exactly " + b + " times.",
                        [String(pa - b + 1)]: "You didn't go back enough. Make sure you count back " + b + " full times.",
                        [String(pa + b)]: "Oops! You added instead of subtracted. The − sign means count BACKWARDS."
                    }}; })()
            };
        },
        Shapes: () => ({
            goalProblem: `How many sides does a triangle have?`,
            teachingSteps: [
                {
                    title: "What is a 'side'?",
                    explanation: "A <strong>side</strong> is a straight line on the outside edge of a shape. We count these lines to identify shapes!",
                    visual: "Side = one straight edge"
                },
                {
                    title: "Shape names come from number of sides",
                    explanation: "Each shape has a special name based on how many sides it has. The name gives us a clue!",
                    visual: "TRI = 3 | QUAD = 4 | PENTA = 5 | HEXA = 6"
                },
                {
                    title: "Let's look at a triangle",
                    explanation: "Here's a triangle: △. We need to count how many straight lines make up its edges.",
                    visual: "△"
                },
                {
                    title: "Count each side",
                    explanation: "Go around the triangle and count each straight edge: one on the left, one on the right, one on the bottom.",
                    visual: "Side 1 (left) + Side 2 (right) + Side 3 (bottom)"
                },
                {
                    title: "The answer is in the name!",
                    explanation: "<strong>TRI</strong> means 3. A <strong>TRI</strong>angle has <strong>3 sides</strong>. The name tells us the answer!",
                    visual: "TRI-angle = 3 sides"
                }
            ],
            finalAnswer: "3 sides",
            answerExplanation: "A triangle has 3 sides. 'Tri' means 3, so TRI-angle = 3 angles and 3 sides!",
            example: { problem: `How many sides does a triangle have?`, steps: [
                { text: "Look at the triangle", math: "△" },
                { text: "Count each straight edge around the outside", math: "Side 1 (left) + Side 2 (right) + Side 3 (bottom) = 3" },
                { text: "A triangle has...", math: "<strong>3 sides</strong> (that's why it's called a TRI-angle!)" }
            ]},
            keyPoints: [
                "TRI means 3 → Triangle has 3 sides",
                "QUAD means 4 → Quadrilateral has 4 sides",
                "PENTA means 5 → Pentagon has 5 sides",
                "HEXA means 6 → Hexagon has 6 sides"
            ],
            mistakes: [
                { wrong: "Confusing sides with corners", why: "Sides are the LINES. Corners are where lines MEET." },
                { wrong: "Thinking a circle has 1 side", why: "A circle has 0 straight sides - it's curved all around!" }
            ],
            guided: {
                problem: `How many sides does a square have?`,
                steps: [
                    { label: "Picture the square", value: "□ (it has a top, bottom, left, and right)" },
                    { label: "Count the sides", value: "Top(1) + Right(2) + Bottom(3) + Left(4)" },
                    { label: "Total sides", value: "?" }
                ],
                answer: "4",
                answerLabel: "Number of sides:",
                interactiveSteps: [
                    {
                        prompt: "What is a 'side' of a shape?",
                        hint: "It's one of the straight lines on the edge...",
                        answer: "straight edge",
                        acceptableAnswers: ["straight edge", "straight line", "edge", "line", "a line", "a straight line"],
                        formatHint: "e.g., edge, line",
                        commonMistakes: {
                            "corner": "A corner is where two sides MEET. A side is the straight line itself!",
                            "angle": "An angle is formed where sides meet. A side is the straight edge."
                        }
                    },
                    {
                        prompt: "Look at a square: □. Start at the top and go around. How many straight lines do you count?",
                        hint: "Count: top, right side, bottom, left side...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "2": "You might have only counted top/bottom or left/right. Count ALL four sides!",
                            "8": "Each side is counted ONCE. Go around: top(1), right(2), bottom(3), left(4)."
                        }
                    },
                    {
                        prompt: "A square has 4 sides. What do we call a shape with 4 sides?",
                        hint: "QUAD means 4...",
                        answer: "quadrilateral",
                        acceptableAnswers: ["quadrilateral", "quad", "rectangle", "square"],
                        formatHint: "Name the shape",
                        commonMistakes: {
                            "triangle": "TRI means 3. A shape with 4 sides is a QUADrilateral (QUAD = 4)",
                            "pentagon": "PENTA means 5. A shape with 4 sides is a QUADrilateral."
                        }
                    }
                ]
            },
            practice: { problem: `How many sides does a hexagon have?`, answer: "6", options: ["4", "5", "6", "8"],
                mistakeAnalysis: {
                    "4": "That's a quadrilateral/square. HEXA means 6!",
                    "5": "That's a pentagon. HEXA means 6!",
                    "8": "That's an octagon. HEXA means 6!"
                }}
        }),
        "Place Value": () => {
            const tens = rand(2, 8), ones = rand(1, 9);
            const num = tens * 10 + ones;
            return {
                goalProblem: `In the number 58, what digit is in the tens place?`,
                teachingSteps: [
                    {
                        title: "What is place value?",
                        explanation: "<strong>Place value</strong> tells us what each digit in a number is worth. The same digit can mean different amounts depending on where it sits!",
                        visual: "The 5 in '50' is worth more than the 5 in '5'"
                    },
                    {
                        title: "Two-digit numbers have two places",
                        explanation: "In a 2-digit number, there are two positions: the <strong>tens place</strong> (left) and the <strong>ones place</strong> (right).",
                        visual: "[TENS] [ONES]"
                    },
                    {
                        title: "Let's look at 58",
                        explanation: "The number 58 has two digits. Let's figure out which digit is in which place.",
                        visual: "58 → [?] [?]"
                    },
                    {
                        title: "The LEFT digit is in the tens place",
                        explanation: "In 58, the digit <strong>5</strong> is on the left, so it's in the <strong>tens place</strong>. It's worth 5 × 10 = 50!",
                        visual: "58 → [5=tens] [8]"
                    },
                    {
                        title: "The RIGHT digit is in the ones place",
                        explanation: "The digit <strong>8</strong> is on the right, so it's in the <strong>ones place</strong>. It's worth just 8.",
                        visual: "58 = 50 + 8 = 5 tens + 8 ones"
                    }
                ],
                finalAnswer: "5",
                answerExplanation: "The digit in the tens place is 5. It's on the LEFT side. Remember: LEFT = tens, RIGHT = ones!",
                example: { problem: `In the number 58, what digit is in the tens place?`, steps: [
                    { text: "Write the number and label each place", math: "58 → [5][8]" },
                    { text: "Left digit = tens, Right digit = ones", math: "5 is in tens place, 8 is in ones place" },
                    { text: "The tens digit is...", math: "<strong>5</strong> (worth 50)" }
                ]},
                keyPoints: [
                    "In a 2-digit number: LEFT = tens, RIGHT = ones",
                    "The tens place is worth 10× more than the ones place",
                    "Example: 36 = 3 tens + 6 ones = 30 + 6"
                ],
                mistakes: [
                    { wrong: "Mixing up left and right", why: "Remember: Tens is on the LEFT (like how you read left-to-right, tens comes first)" },
                    { wrong: "Thinking 5 tens = 5", why: "5 tens = 5 × 10 = 50, not 5!" }
                ],
                guided: {
                    problem: `In the number ${num}, what digit is in the tens place?`,
                    steps: [
                        { label: "The number is", value: `${num}` },
                        { label: "Left digit is tens", value: `${tens} is on the left` },
                        { label: "Tens digit is", value: "?" }
                    ],
                    answer: String(tens),
                    answerLabel: "Tens digit:",
                    interactiveSteps: [
                        {
                            prompt: `In a 2-digit number like ${num}, which position is the TENS place - left or right?`,
                            hint: "We read left to right, and tens comes before ones...",
                            answer: "left",
                            acceptableAnswers: ["left", "the left", "on the left"],
                            formatHint: "left or right",
                            commonMistakes: {
                                "right": "The RIGHT digit is the ones place. TENS is on the LEFT!"
                            }
                        },
                        {
                            prompt: `Look at ${num}. What digit is on the LEFT side?`,
                            hint: `The number is ${num}. The left digit is...`,
                            answer: String(tens),
                            acceptableAnswers: [String(tens)],
                            formatHint: "Enter a digit (0-9)",
                            commonMistakes: {
                                [String(ones)]: `That's the ones digit (on the right). The LEFT digit is ${tens}`,
                                [String(num)]: `That's the whole number! We need just the LEFT digit: ${tens}`
                            }
                        },
                        {
                            prompt: `So the digit ${tens} is in the tens place. How much is ${tens} tens worth?`,
                            hint: `${tens} tens = ${tens} × 10 = ?`,
                            answer: String(tens * 10),
                            acceptableAnswers: [String(tens * 10)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(tens)]: `${tens} is the digit, but ${tens} TENS = ${tens} × 10 = ${tens * 10}`,
                                [String(tens + 10)]: `Don't add! Multiply: ${tens} × 10 = ${tens * 10}`
                            }
                        }
                    ]
                },
                practice: { problem: `What number has 7 tens and 2 ones?`, answer: "72", options: ["27", "72", "79", "702"],
                    mistakeAnalysis: {
                        "27": "You switched them! Tens come FIRST (on the left). 7 tens = 70, plus 2 ones = 72",
                        "79": "Close! 7 tens is correct, but we need 2 ones, not 9",
                        "702": "7 tens = 70, not 700. The answer is 72"
                    }}
            };
        },
        Patterns: () => {
            const start = rand(2, 5);
            const step = rand(2, 4);
            return {
                goalProblem: `What comes next? 2, 5, 8, 11, ?`,
                teachingSteps: [
                    {
                        title: "What is a pattern?",
                        explanation: "A <strong>pattern</strong> is a set of numbers that follow a rule. Once we find the rule, we can figure out what comes next!",
                        visual: "Pattern = numbers following a rule"
                    },
                    {
                        title: "Find the 'gap' between numbers",
                        explanation: "To find the rule, look at the <strong>difference</strong> between each pair of numbers. How much do we add to get from one number to the next?",
                        visual: "2 → ? → 5 → ? → 8 → ? → 11"
                    },
                    {
                        title: "Calculate each gap",
                        explanation: "Let's find the gap between each pair: 2 to 5 is +3, 5 to 8 is +3, 8 to 11 is +3. The gap is always the same!",
                        visual: "2 →(+3)→ 5 →(+3)→ 8 →(+3)→ 11"
                    },
                    {
                        title: "The rule is: Add 3 each time",
                        explanation: "Every time we move to the next number, we add 3. This is our rule! A pattern that adds the same number is called an 'arithmetic pattern'.",
                        visual: "Rule: +3"
                    },
                    {
                        title: "Apply the rule to find the answer",
                        explanation: "The last number is 11. Add 3 to get the next number: 11 + 3 = <strong>14</strong>",
                        visual: "11 →(+3)→ 14"
                    }
                ],
                finalAnswer: "14",
                answerExplanation: "The pattern adds 3 each time. Starting from 11, we add 3 to get 14!",
                example: { problem: `What comes next? 2, 5, 8, 11, ?`, steps: [
                    { text: "Find the difference between each pair", math: "2→5 is +3, 5→8 is +3, 8→11 is +3" },
                    { text: "The rule is: add 3 each time", math: "This pattern adds 3" },
                    { text: "Apply the rule to find the next number", math: "11 + 3 = <strong>14</strong>" }
                ]},
                keyPoints: [
                    "Look at the GAPS between numbers, not just the numbers",
                    "Check that your rule works for ALL the numbers in the pattern",
                    "Common patterns: +1, +2, +3, +5, +10, ×2"
                ],
                mistakes: [
                    { wrong: "Just guessing the next number", why: "Find the rule first! What's being added each time?" },
                    { wrong: "Finding a rule that only works for some numbers", why: "Your rule must work for EVERY step in the pattern." }
                ],
                guided: {
                    problem: `What comes next? ${start}, ${start+step}, ${start+2*step}, ${start+3*step}, ?`,
                    steps: [
                        { label: "Find the gap between numbers", value: `${start}→${start+step} is +${step}, ${start+step}→${start+2*step} is +${step}` },
                        { label: "The rule is", value: `Add ${step} each time` },
                        { label: "Next number", value: "?" }
                    ],
                    answer: String(start + 4*step),
                    answerLabel: "What comes next?",
                    interactiveSteps: [
                        {
                            prompt: `Look at ${start}, ${start+step}, ${start+2*step}... What's the difference between ${start} and ${start+step}?`,
                            hint: `${start+step} - ${start} = ?`,
                            answer: String(step),
                            acceptableAnswers: [String(step), `+${step}`],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(start)]: `That's the first number. The DIFFERENCE is ${start+step} - ${start} = ${step}`,
                                [String(start + step)]: `That's the second number. Subtract to find the gap: ${start+step} - ${start} = ${step}`
                            }
                        },
                        {
                            prompt: `The gap is ${step}. Check: is the gap the same between ${start+step} and ${start+2*step}?`,
                            hint: `${start+2*step} - ${start+step} = ?`,
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "yep", String(step), `+${step}`],
                            formatHint: "yes or no",
                            commonMistakes: {
                                "no": `Actually, ${start+2*step} - ${start+step} = ${step}, same as before! The rule is add ${step}.`
                            }
                        },
                        {
                            prompt: `The rule is: add ${step} each time. The last number is ${start+3*step}. What comes next?`,
                            hint: `${start+3*step} + ${step} = ?`,
                            answer: String(start + 4*step),
                            acceptableAnswers: [String(start + 4*step)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(start + 3*step)]: `That's the last number given. Add ${step} more: ${start+3*step} + ${step} = ${start+4*step}`,
                                [String(start + 3*step + 1)]: `You added 1 instead of ${step}. The rule is +${step}, so ${start+3*step} + ${step} = ${start+4*step}`,
                                [String(start + 5*step)]: `You added ${step} twice! Only add it once: ${start+3*step} + ${step} = ${start+4*step}`
                            }
                        }
                    ]
                },
                practice: { problem: `What comes next? 4, 8, 12, 16, ?`, answer: "20", options: ["17", "18", "20", "24"],
                    mistakeAnalysis: {
                        "17": "You added 1 instead of 4. The pattern is +4 each time: 16 + 4 = 20",
                        "18": "You added 2 instead of 4. Check the gaps: 4→8 is +4, 8→12 is +4",
                        "24": "You added 8 instead of 4. The gaps are +4, not +8."
                    }}
            };
        },
        "Skip Counting": () => ({
            goalProblem: `Count by 5s starting at 5. What comes after 20?`,
            teachingSteps: [
                {
                    title: "What is skip counting?",
                    explanation: "<strong>Skip counting</strong> means counting by a number other than 1. Instead of 1, 2, 3, 4... we skip some numbers!",
                    visual: "Regular: 1, 2, 3, 4, 5... | Skip by 2s: 2, 4, 6, 8, 10..."
                },
                {
                    title: "Why skip count?",
                    explanation: "Skip counting helps us count faster! It's also the foundation for <strong>multiplication</strong>. Counting by 5s is the same as the 5 times table!",
                    visual: "5, 10, 15, 20 = 5×1, 5×2, 5×3, 5×4"
                },
                {
                    title: "Let's count by 5s",
                    explanation: "When we count by 5s, we add 5 each time. Start at 5, then 10, then 15, then 20...",
                    visual: "5 →(+5)→ 10 →(+5)→ 15 →(+5)→ 20"
                },
                {
                    title: "What comes after 20?",
                    explanation: "We're at 20 and need to find the next number. Since we're counting by 5s, we add 5!",
                    visual: "20 + 5 = ?"
                },
                {
                    title: "The answer",
                    explanation: "20 + 5 = <strong>25</strong>. The next number when counting by 5s after 20 is 25!",
                    visual: "5, 10, 15, 20, <strong>25</strong>"
                }
            ],
            finalAnswer: "25",
            answerExplanation: "When counting by 5s, we add 5 each time. 20 + 5 = 25!",
            example: { problem: `Count by 5s starting at 5. What comes after 20?`, steps: [
                { text: "List what we know", math: "5, 10, 15, 20, ?" },
                { text: "Each number is 5 more than the last", math: "5+5=10, 10+5=15, 15+5=20, 20+5=?" },
                { text: "Add 5 to find the next number", math: "20 + 5 = <strong>25</strong>" }
            ]},
            keyPoints: [
                "Skip counting by 2s: all even numbers (ends in 0, 2, 4, 6, 8)",
                "Skip counting by 5s: ends in 0 or 5",
                "Skip counting by 10s: always ends in 0"
            ],
            mistakes: [
                { wrong: "Adding 1 instead of the skip number", why: "If counting by 5s, add 5 each time, not 1!" },
                { wrong: "Losing track of the skip amount", why: "Say it out loud: 'plus 5, plus 5, plus 5...'" }
            ],
            guided: {
                problem: `Count by 2s: 2, 4, 6, 8, ?`,
                steps: [
                    { label: "What are we counting by?", value: "2s (adding 2 each time)" },
                    { label: "The last number is", value: "8" },
                    { label: "Add 2 to get", value: "?" }
                ],
                answer: "10",
                answerLabel: "What comes next?",
                interactiveSteps: [
                    {
                        prompt: "We're 'skip counting by 2s'. What number do we add each time?",
                        hint: "Look at the sequence: 2, 4, 6, 8... What's the difference between each number?",
                        answer: "2",
                        acceptableAnswers: ["2", "two", "+2"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "1": "If we added 1 each time, we'd get 2, 3, 4, 5... But we're skipping to 2, 4, 6, 8 (adding 2)",
                            "4": "Check the gaps: 4-2=2, 6-4=2, 8-6=2. We add 2 each time!"
                        }
                    },
                    {
                        prompt: "The last number in our list is 8. What do we add to find the next number?",
                        hint: "We're counting by 2s, so we add...",
                        answer: "2",
                        acceptableAnswers: ["2", "two", "+2"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "8 is the last number. We need to ADD 2 to it!",
                            "1": "We're skip counting by 2, not by 1. Add 2!"
                        }
                    },
                    {
                        prompt: "8 + 2 = ? What's the next number in our sequence?",
                        hint: "Add 2 to 8...",
                        answer: "10",
                        acceptableAnswers: ["10", "ten"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "9": "You added 1 instead of 2. 8 + 2 = 10",
                            "82": "We ADD, not combine digits! 8 + 2 = 10",
                            "6": "You subtracted! We ADD 2: 8 + 2 = 10"
                        }
                    }
                ]
            },
            practice: { problem: `Count by 10s: 30, 40, 50, 60, ?`, answer: "70", options: ["61", "65", "70", "100"],
                mistakeAnalysis: {
                    "61": "You added 1 instead of 10. When counting by 10s, add 10: 60 + 10 = 70",
                    "65": "You added 5 instead of 10. This is counting by 10s, not 5s.",
                    "100": "That's too big of a jump. We're adding 10, not 40."
                }}
        }),
        "Number Lines": () => ({
            goalProblem: `Where is 7 on a number line from 0 to 10?`,
            teachingSteps: [
                {
                    title: "What is a number line?",
                    explanation: "A <strong>number line</strong> is like a ruler for numbers! Numbers are arranged in order from left to right, with smaller numbers on the left and bigger numbers on the right.",
                    visual: "0 ← smaller ... bigger → 10"
                },
                {
                    title: "The number line starts at 0",
                    explanation: "The number line usually starts at <strong>0</strong> on the left. Each mark shows the next number as we move right.",
                    visual: "0--1--2--3--4--5--6--7--8--9--10"
                },
                {
                    title: "Equal spacing is important",
                    explanation: "The marks on a number line are <strong>evenly spaced</strong>. The distance from 0 to 1 is the same as from 1 to 2, 2 to 3, and so on.",
                    visual: "|--|--|--|--| (all spaces equal)"
                },
                {
                    title: "Finding 7 on the number line",
                    explanation: "To find 7, start at 0 and count 7 marks to the right. Or count: 0, 1, 2, 3, 4, 5, 6, <strong>7</strong>!",
                    visual: "0--1--2--3--4--5--6--[7]--8--9--10"
                },
                {
                    title: "Notice: 7 is closer to 10 than to 0",
                    explanation: "Looking at our number line, 7 is past the middle (5). It's only 3 steps from 10, but 7 steps from 0. Number lines help us SEE these relationships!",
                    visual: "0←--7 steps--→[7]←--3 steps--→10"
                }
            ],
            finalAnswer: "7 is at the 7th mark from 0",
            answerExplanation: "Starting at 0, count 7 spaces to the right to find 7. It's between 6 and 8, closer to 10 than to 0.",
            example: { problem: `Where is 7 on a number line from 0 to 10?`, steps: [
                { text: "Start at 0 on the left", math: "0 is our starting point" },
                { text: "Count 7 marks to the right", math: "0, 1, 2, 3, 4, 5, 6, 7" },
                { text: "7 is between 6 and 8", math: "...5--6--<strong>[7]</strong>--8--9..." }
            ]},
            keyPoints: [
                "Number lines go from smaller (left) to bigger (right)",
                "Each mark is evenly spaced - same distance between all numbers",
                "Moving RIGHT means getting bigger, moving LEFT means getting smaller"
            ],
            mistakes: [
                { wrong: "Thinking bigger numbers are on the left", why: "Bigger numbers are always on the RIGHT side of a number line" },
                { wrong: "Uneven spacing between numbers", why: "All spaces must be equal! The jump from 3 to 4 equals the jump from 7 to 8" }
            ],
            guided: {
                problem: `Point to where 4 would be on a number line from 0 to 10`,
                steps: [
                    { label: "Start at 0", value: "The left end" },
                    { label: "Count 4 spaces right", value: "0, 1, 2, 3, 4" },
                    { label: "4 is between", value: "?" }
                ],
                answer: "3 and 5",
                answerLabel: "4 is between which numbers?",
                interactiveSteps: [
                    {
                        prompt: "On a number line, which end has the smaller numbers - left or right?",
                        hint: "Think about how we read: we start on the left and go right...",
                        answer: "left",
                        acceptableAnswers: ["left", "the left"],
                        formatHint: "left or right",
                        commonMistakes: {
                            "right": "Right side has BIGGER numbers. Smaller numbers are on the LEFT."
                        }
                    },
                    {
                        prompt: "To find 4, we start at 0 and move which direction?",
                        hint: "We need to get to a bigger number...",
                        answer: "right",
                        acceptableAnswers: ["right", "to the right"],
                        formatHint: "left or right",
                        commonMistakes: {
                            "left": "Left goes to smaller numbers. We need to go RIGHT to get to 4."
                        }
                    },
                    {
                        prompt: "What number comes right BEFORE 4 on the number line?",
                        hint: "Count: 1, 2, 3, ...",
                        answer: "3",
                        acceptableAnswers: ["3", "three"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "5": "5 comes AFTER 4. Before 4 is 3."
                        }
                    },
                    {
                        prompt: "What number comes right AFTER 4 on the number line?",
                        hint: "After 4 comes...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "3": "3 comes BEFORE 4. After 4 is 5."
                        }
                    }
                ]
            },
            practice: { problem: `On a number line, what number is exactly halfway between 0 and 10?`, answer: "5",
                options: ["4", "5", "6", "7"],
                mistakeAnalysis: {
                    "4": "4 is a bit less than halfway. The middle of 0 to 10 is 5.",
                    "6": "6 is past the middle. Exactly halfway is 5.",
                    "7": "7 is closer to 10 than to 0. Halfway between 0 and 10 is 5."
                }}
        }),
        "Even and Odd": () => ({
            goalProblem: `Is 7 even or odd?`,
            teachingSteps: [
                {
                    title: "What are even and odd numbers?",
                    explanation: "Every whole number is either <strong>EVEN</strong> or <strong>ODD</strong>. They take turns! Even numbers can be split into two equal groups; odd numbers cannot.",
                    visual: "1(odd), 2(even), 3(odd), 4(even), 5(odd)..."
                },
                {
                    title: "Even numbers: Can be split in half",
                    explanation: "<strong>Even numbers</strong> can be divided into 2 equal groups with nothing left over. Try splitting 6 cookies between 2 friends - each gets 3!",
                    visual: "6 = ●●● | ●●● (3 each, fair!)"
                },
                {
                    title: "Odd numbers: One left over",
                    explanation: "<strong>Odd numbers</strong> cannot be split equally in half. If you try to split 7 cookies between 2 friends, there's always 1 left over!",
                    visual: "7 = ●●● | ●●● + ● (one left!)"
                },
                {
                    title: "The easy trick: Look at the last digit!",
                    explanation: "For any number, just look at the <strong>last digit</strong>:<br>• Ends in 0, 2, 4, 6, 8 → <strong>EVEN</strong><br>• Ends in 1, 3, 5, 7, 9 → <strong>ODD</strong>",
                    visual: "Even: 0,2,4,6,8 | Odd: 1,3,5,7,9"
                },
                {
                    title: "Is 7 even or odd?",
                    explanation: "7 ends in 7, which is in our odd list (1,3,5,7,9). Also, we can't split 7 into 2 equal groups. So <strong>7 is ODD</strong>!",
                    visual: "7 → ends in 7 → ODD"
                }
            ],
            finalAnswer: "7 is odd",
            answerExplanation: "7 ends in 7, and 7 is in our odd digits list (1,3,5,7,9). Also, 7 ÷ 2 = 3 remainder 1 - can't split evenly!",
            example: { problem: `Is 7 even or odd?`, steps: [
                { text: "Look at the last digit", math: "7 → last digit is 7" },
                { text: "Is 7 in the even list (0,2,4,6,8) or odd list (1,3,5,7,9)?", math: "7 is in the ODD list" },
                { text: "Try splitting: can 7 be split into 2 equal groups?", math: "7 = 3 + 3 + 1 leftover → NO, can't split evenly" },
                { text: "The answer", math: "<strong>7 is ODD</strong>" }
            ]},
            keyPoints: [
                "Even numbers end in 0, 2, 4, 6, or 8",
                "Odd numbers end in 1, 3, 5, 7, or 9",
                "Even + Even = Even, Odd + Odd = Even, Even + Odd = Odd"
            ],
            mistakes: [
                { wrong: "Thinking 0 is odd", why: "0 is EVEN! You can split 0 things into 2 groups of 0." },
                { wrong: "Confusing 'ends in' with the whole number", why: "For 24: look at the 4, not the 2. 24 ends in 4, so it's EVEN." }
            ],
            guided: {
                problem: `Is 12 even or odd?`,
                steps: [
                    { label: "What is the last digit?", value: "2" },
                    { label: "Is 2 in the even or odd list?", value: "Even (0,2,4,6,8)" },
                    { label: "So 12 is", value: "?" }
                ],
                answer: "even",
                answerLabel: "12 is even or odd?",
                interactiveSteps: [
                    {
                        prompt: "To check if a number is even or odd, we look at what part of the number?",
                        hint: "We only need to check one digit...",
                        answer: "last digit",
                        acceptableAnswers: ["last digit", "the last digit", "ones place", "ones digit"],
                        formatHint: "e.g., last digit",
                        commonMistakes: {
                            "first digit": "No, we look at the LAST digit. For 12, look at the 2, not the 1."
                        }
                    },
                    {
                        prompt: "What is the last digit of 12?",
                        hint: "12 → what's the digit on the right?",
                        answer: "2",
                        acceptableAnswers: ["2", "two"],
                        formatHint: "Enter a digit (0-9)",
                        commonMistakes: {
                            "1": "That's the first digit. The LAST digit of 12 is 2."
                        }
                    },
                    {
                        prompt: "The even digits are 0, 2, 4, 6, 8. Is 2 in this list?",
                        hint: "Look for 2 in the list: 0, 2, 4, 6, 8",
                        answer: "yes",
                        acceptableAnswers: ["yes", "yeah", "yep"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "no": "Look again: 0, 2, 4, 6, 8. The number 2 IS in this list!"
                        }
                    },
                    {
                        prompt: "Since 12 ends in 2 (an even digit), 12 is _____.",
                        hint: "If the last digit is even, the whole number is...",
                        answer: "even",
                        acceptableAnswers: ["even"],
                        formatHint: "even or odd",
                        commonMistakes: {
                            "odd": "Numbers ending in 2 are EVEN. 12 is even."
                        }
                    }
                ]
            },
            practice: { problem: `Is 15 even or odd?`, answer: "odd",
                options: ["even", "odd"],
                mistakeAnalysis: {
                    "even": "15 ends in 5. The digit 5 is in the ODD list (1,3,5,7,9), so 15 is ODD."
                }}
        }),
        "Ordering Numbers": () => {
            const a = rand(3, 8), b = rand(10, 15), c = rand(16, 20);
            const nums = shuffle([a, b, c]);
            const sorted = [a, b, c];
            return {
                goalProblem: `Put these numbers in order from smallest to largest: 8, 3, 5`,
                teachingSteps: [
                    {
                        title: "What does 'ordering numbers' mean?",
                        explanation: "<strong>Ordering numbers</strong> means arranging them from smallest to largest (or largest to smallest). We use what we know about comparing numbers!",
                        visual: "3, 8, 5 → smallest to largest → 3, 5, 8"
                    },
                    {
                        title: "Think of a number line",
                        explanation: "On a number line, smaller numbers are on the LEFT and bigger numbers are on the RIGHT. We can use this to help us order numbers!",
                        visual: "0--1--2--[3]--4--[5]--6--7--[8]--9--10"
                    },
                    {
                        title: "Step 1: Find the SMALLEST number",
                        explanation: "Look at all your numbers: 8, 3, 5. Which comes first when counting?<br>3 comes before 5 and 8, so <strong>3 is smallest</strong>!",
                        visual: "8, 3, 5 → smallest is 3"
                    },
                    {
                        title: "Step 2: Find the next smallest",
                        explanation: "Now look at what's left: 8 and 5. Which is smaller?<br>5 comes before 8 when counting, so <strong>5 is next</strong>.",
                        visual: "Remaining: 8, 5 → 5 is smaller"
                    },
                    {
                        title: "Step 3: The rest goes at the end",
                        explanation: "8 is the only number left, so it must be the <strong>largest</strong>.<br>Our order: <strong>3, 5, 8</strong>",
                        visual: "Smallest → Largest: 3, 5, 8"
                    }
                ],
                finalAnswer: "3, 5, 8",
                answerExplanation: "We found the smallest (3), then the next smallest (5), then the largest (8). In order: 3 < 5 < 8",
                example: { problem: `Put in order from smallest to largest: 8, 3, 5`, steps: [
                    { text: "Find the smallest", math: "Compare 8, 3, 5 → 3 is smallest" },
                    { text: "Find the next smallest from what's left", math: "Compare 8, 5 → 5 is smaller" },
                    { text: "The last one is the largest", math: "8 is largest" },
                    { text: "Write in order", math: "<strong>3, 5, 8</strong>" }
                ]},
                keyPoints: [
                    "Think of the number line to help you compare",
                    "Find the smallest first, then work your way up",
                    "Check your answer: each number should be bigger than the one before it"
                ],
                mistakes: [
                    { wrong: "Putting numbers in the order they were given", why: "You need to REARRANGE them! Find smallest to largest (or largest to smallest)." },
                    { wrong: "Confusing smallest to largest with largest to smallest", why: "Read the question carefully! 'Smallest to largest' means smallest number first." }
                ],
                guided: {
                    problem: `Put in order from smallest to largest: ${nums.join(", ")}`,
                    steps: [
                        { label: "Find the smallest", value: String(a) },
                        { label: "Find the next smallest", value: String(b) },
                        { label: "The largest", value: "?" }
                    ],
                    answer: String(c),
                    answerLabel: "What is the largest number?",
                    interactiveSteps: [
                        {
                            prompt: `Look at these numbers: ${nums.join(", ")}. Which one is the SMALLEST?`,
                            hint: "Which number would come first if you were counting?",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `Compare to the other numbers. ${a} is smaller than ${b}.`,
                                [String(c)]: `${c} is actually the LARGEST. The smallest is ${a}.`
                            }
                        },
                        {
                            prompt: `Good! ${a} is smallest. Now look at the remaining numbers: ${b} and ${c}. Which is smaller?`,
                            hint: "Which comes first when counting?",
                            answer: String(b),
                            acceptableAnswers: [String(b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(c)]: `${c} > ${b}, so ${b} is smaller.`
                            }
                        },
                        {
                            prompt: `So the order from smallest to largest is: ${a}, ${b}, ___`,
                            hint: "What's the only number left?",
                            answer: String(c),
                            acceptableAnswers: [String(c)],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Check: Is ${a} < ${b} < ${c}? Does each number get bigger?`,
                            hint: "Verify the order is correct...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "correct", "true"],
                            formatHint: "yes or no",
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Put in order from smallest to largest: 9, 2, 6`, answer: "2, 6, 9",
                    options: ["2, 6, 9", "9, 6, 2", "6, 2, 9", "2, 9, 6"],
                    mistakeAnalysis: {
                        "9, 6, 2": "That's largest to smallest! We want smallest to largest: 2, 6, 9",
                        "6, 2, 9": "Start with the smallest. 2 is smaller than 6, so 2 comes first: 2, 6, 9",
                        "2, 9, 6": "Close! But 6 < 9, so 6 should come before 9: 2, 6, 9"
                    }}
            };
        },
        Comparison: () => ({
            goalProblem: `Which is greater: 7 or 4?`,
            teachingSteps: [
                {
                    title: "What does 'comparing' mean?",
                    explanation: "<strong>Comparing numbers</strong> means deciding which number is bigger (greater) or smaller (less than). We use special symbols to show this!",
                    visual: "Bigger? Smaller? Or Equal?"
                },
                {
                    title: "The comparison symbols",
                    explanation: "We use three symbols: <strong>></strong> (greater than), <strong><</strong> (less than), and <strong>=</strong> (equals). The open side always faces the BIGGER number!",
                    visual: "> means greater than | < means less than | = means equal"
                },
                {
                    title: "The 'hungry alligator' trick",
                    explanation: "Think of > and < as an alligator's mouth. The alligator is hungry and always wants to eat the BIGGER number! The open mouth faces the bigger one.",
                    visual: "7 > 4 (alligator wants the 7!)"
                },
                {
                    title: "Let's compare 7 and 4",
                    explanation: "Think about counting: 1, 2, 3, 4, 5, 6, 7... Numbers that come later when counting are bigger. 7 comes after 4!",
                    visual: "1, 2, 3, <u>4</u>, 5, 6, <u>7</u> ← 7 is farther along"
                },
                {
                    title: "7 is greater than 4",
                    explanation: "Since 7 is bigger, the open mouth (the 'greater than' symbol) faces 7. We write: <strong>7 > 4</strong>",
                    visual: "7 > 4"
                }
            ],
            finalAnswer: "7 > 4",
            answerExplanation: "7 is greater than 4 because 7 comes after 4 when counting. The > symbol opens toward the bigger number (7).",
            example: { problem: `Which is greater: 7 or 4?`, steps: [
                { text: "Think about counting", math: "When we count, we say: 1, 2, 3, 4, 5, 6, 7..." },
                { text: "Numbers that come later are bigger", math: "7 comes after 4, so 7 is greater" },
                { text: "The answer", math: "<strong>7 > 4</strong> (7 is greater than 4)" }
            ]},
            keyPoints: [
                "Think of a number line: numbers on the RIGHT are bigger",
                "The 'hungry alligator' eats the bigger number: 7 > 4",
                "For 2-digit numbers: compare tens first, then ones"
            ],
            mistakes: [
                { wrong: "Confusing > and <", why: "The symbol points TO the smaller number. The open mouth faces the bigger number." },
                { wrong: "Only looking at one digit in 2-digit numbers", why: "32 > 29 even though 9 > 2, because 3 tens > 2 tens" }
            ],
            guided: {
                problem: `Which is greater: 12 or 8?`,
                steps: [
                    { label: "Count up to find which is bigger", value: "...6, 7, 8, 9, 10, 11, 12" },
                    { label: "12 comes after 8, so", value: "12 is greater" },
                    { label: "Answer", value: "?" }
                ],
                answer: "12",
                answerLabel: "Which is greater?",
                interactiveSteps: [
                    {
                        prompt: "When we count up (1, 2, 3, 4...), which number comes LATER: 12 or 8?",
                        hint: "Numbers that come later when counting are bigger...",
                        answer: "12",
                        acceptableAnswers: ["12", "twelve"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "When counting: ...7, 8, 9, 10, 11, 12. 12 comes LATER, so 12 is greater!"
                        }
                    },
                    {
                        prompt: "If 12 comes after 8, that means 12 is ______ than 8.",
                        hint: "Bigger numbers come later when counting...",
                        answer: "greater",
                        acceptableAnswers: ["greater", "bigger", "larger", "more"],
                        formatHint: "greater or less",
                        commonMistakes: {
                            "less": "Numbers that come LATER are GREATER. 12 comes after 8, so 12 is GREATER.",
                            "smaller": "12 is bigger! Later in counting = greater."
                        }
                    },
                    {
                        prompt: "What symbol shows '12 is greater than 8'? Is it 12 > 8 or 12 < 8?",
                        hint: "The open side of the symbol points to the bigger number...",
                        answer: "12 > 8",
                        acceptableAnswers: ["12 > 8", ">", "12>8"],
                        formatHint: "e.g., 12 > 8",
                        commonMistakes: {
                            "12 < 8": "< means 'less than'. Since 12 is GREATER, we use >: 12 > 8",
                            "<": "< means less than. We want GREATER than, which is >"
                        }
                    }
                ]
            },
            practice: { problem: `Compare: 15 ? 9 (use >, <, or =)`, answer: ">", options: ["<", ">", "="],
                mistakeAnalysis: {
                    "<": "15 is BIGGER than 9, so we need the 'greater than' symbol: 15 > 9",
                    "=": "15 and 9 are not equal. 15 is bigger, so 15 > 9"
                }}
        }),
        "Teen Numbers": () => ({
            goalProblem: `The number 14 has 1 ten and how many ones?`,
            teachingSteps: [
                {
                    title: "What are teen numbers?",
                    explanation: "<strong>Teen numbers</strong> are the numbers from 11 to 19. They all have something special: they're made of 1 ten plus some extra ones!",
                    visual: "11, 12, 13, 14, 15, 16, 17, 18, 19"
                },
                {
                    title: "Every teen number has ONE ten",
                    explanation: "All teen numbers are bigger than 10 but smaller than 20. That means they all have exactly <strong>1 ten</strong> (which equals 10).",
                    visual: "Teen = 10 + some ones"
                },
                {
                    title: "The 'ones' tell us how many extra",
                    explanation: "After the 1 ten, we count the extra ones. For 14: the '4' tells us there are 4 ones. So 14 = 10 + 4.",
                    visual: "14 = 1 ten + 4 ones = 10 + 4"
                },
                {
                    title: "Let's see 14 with dots",
                    explanation: "Watch: 10 dots in a row (that's our 1 ten), plus 4 extra dots (our ones). Count them all: 14!",
                    visual: "●●●●●●●●●● + ●●●● = 14"
                },
                {
                    title: "The answer: 14 has 4 ones",
                    explanation: "14 = 1 ten + <strong>4 ones</strong>. The digit 4 in 14 tells us how many ones after the ten.",
                    visual: "1 4 → 1 ten, 4 ones"
                }
            ],
            finalAnswer: "4 ones",
            answerExplanation: "14 = 1 ten + 4 ones. Every teen number has 1 ten, and the second digit tells us the ones.",
            example: { problem: `The number 14 has 1 ten and how many ones?`, steps: [
                { text: "Teen numbers are 10 plus some ones", math: "14 = 10 + ?" },
                { text: "Count what's left after 10", math: "14 - 10 = 4" },
                { text: "So 14 has 4 ones", math: "14 = 1 ten + <strong>4 ones</strong>" }
            ]},
            keyPoints: [
                "ALL teen numbers (11-19) have exactly 1 ten",
                "The second digit tells you how many ones",
                "Teen numbers = 10 + the ones digit"
            ],
            mistakes: [
                { wrong: "Saying 14 has 14 ones", why: "14 ones would be written as '14' with no tens. 14 has 1 TEN and 4 ones." },
                { wrong: "Confusing tens and ones", why: "The left digit is tens, the right digit is ones. In 14: 1 ten, 4 ones." }
            ],
            guided: {
                problem: `The number 16 has 1 ten and how many ones?`,
                steps: [
                    { label: "16 is a teen number, so it has", value: "1 ten" },
                    { label: "The ones digit is", value: "6" },
                    { label: "So 16 = 10 + ", value: "?" }
                ],
                answer: "6",
                answerLabel: "How many ones?",
                interactiveSteps: [
                    {
                        prompt: "Is 16 a teen number? (Teen numbers are 11-19)",
                        hint: "Is 16 between 11 and 19?",
                        answer: "yes",
                        acceptableAnswers: ["yes", "yeah", "yep", "y"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "no": "16 IS a teen number! It's between 11 and 19."
                        }
                    },
                    {
                        prompt: "How many tens does 16 have?",
                        hint: "All teen numbers have this many tens...",
                        answer: "1",
                        acceptableAnswers: ["1", "one"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "6": "That's the ones digit. Teen numbers all have 1 ten.",
                            "16": "16 is the whole number. It has 1 TEN and some ones."
                        }
                    },
                    {
                        prompt: "16 = 10 + ?. How many ones does 16 have?",
                        hint: "What number plus 10 equals 16?",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "1": "1 is the tens digit. The ONES digit is 6.",
                            "16": "16 is the whole number. The ones part is just 6."
                        }
                    }
                ]
            },
            practice: { problem: `The number 18 has 1 ten and how many ones?`, answer: "8", options: ["1", "8", "10", "18"],
                mistakeAnalysis: {
                    "1": "1 is the tens digit (1 ten = 10). The ONES digit is 8.",
                    "10": "10 is how much 1 ten is worth. The ones digit is 8.",
                    "18": "18 is the whole number. It has 1 ten and 8 ones."
                }}
        }),
        "Number Bonds": () => {
            const total = pick([5, 10]);
            const part1 = rand(1, total - 1);
            const part2 = total - part1;
            return {
                goalProblem: `6 + ? = 10`,
                teachingSteps: [
                    {
                        title: "What are number bonds?",
                        explanation: "<strong>Number bonds</strong> show how numbers can be broken apart or put together. They're pairs of numbers that make a total!",
                        visual: "Number Bond: 10 = 6 + 4"
                    },
                    {
                        title: "Why are bonds to 10 special?",
                        explanation: "Knowing all the ways to make 10 is <strong>super important</strong> for mental math! It helps with adding bigger numbers quickly.",
                        visual: "10 = 1+9 = 2+8 = 3+7 = 4+6 = 5+5"
                    },
                    {
                        title: "Think: What plus 6 makes 10?",
                        explanation: "We need to find the <strong>missing part</strong>. Start with 10 (the whole) and take away 6 (the part we know). What's left?",
                        visual: "10 - 6 = ?"
                    },
                    {
                        title: "Count up from 6 to 10",
                        explanation: "Another way: start at 6 and count up to 10. How many did you count? 7, 8, 9, 10 - that's <strong>4 more</strong>!",
                        visual: "6 → 7 → 8 → 9 → 10 (4 jumps)"
                    },
                    {
                        title: "The missing part is 4!",
                        explanation: "6 + <strong>4</strong> = 10. We can check: 6, 7, 8, 9, 10 ✓ or 10 - 6 = 4 ✓",
                        visual: "6 + 4 = 10 ✓"
                    }
                ],
                finalAnswer: "4",
                answerExplanation: "6 + 4 = 10. These are number bonds to 10! Memorizing all bonds to 10 makes math easier.",
                example: { problem: `6 + ? = 10`, steps: [
                    { text: "We need the part that goes with 6 to make 10", math: "6 + ? = 10" },
                    { text: "Subtract to find the missing part", math: "10 - 6 = 4" },
                    { text: "Check your answer", math: "6 + 4 = 10 ✓" }
                ]},
                keyPoints: [
                    "Number bonds to 10: 1+9, 2+8, 3+7, 4+6, 5+5",
                    "To find a missing part: subtract from the total",
                    "You can also count up from the known part to the total"
                ],
                mistakes: [
                    { wrong: "Adding instead of finding the missing part", why: "We want what ADDS TO 6 to make 10, not 6+10." },
                    { wrong: "Not knowing bonds to 10", why: "Practice! 1+9, 2+8, 3+7, 4+6, 5+5 all make 10." }
                ],
                guided: {
                    problem: `${part1} + ? = ${total}`,
                    steps: [
                        { label: "The total is", value: String(total) },
                        { label: "One part is", value: String(part1) },
                        { label: "The missing part is", value: "?" }
                    ],
                    answer: String(part2),
                    answerLabel: "What's the missing number?",
                    interactiveSteps: [
                        {
                            prompt: `What is the total we're trying to make?`,
                            hint: "Look at the right side of the equation",
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(part1)]: `${part1} is one part. The TOTAL is ${total}.`
                            }
                        },
                        {
                            prompt: `To find the missing part, we can subtract: ${total} - ${part1} = ?`,
                            hint: `What is ${total} minus ${part1}?`,
                            answer: String(part2),
                            acceptableAnswers: [String(part2)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(total)]: `That's the total. Subtract: ${total} - ${part1} = ${part2}`,
                                [String(part1)]: `That's the known part. We need ${total} - ${part1} = ${part2}`
                            }
                        },
                        {
                            prompt: `Let's check: ${part1} + ${part2} = ?`,
                            hint: "Add the two parts together",
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `7 + ? = 10`, answer: "3", options: ["2", "3", "7", "17"],
                    mistakeAnalysis: {
                        "2": "7 + 2 = 9, not 10. Try 7 + 3 = 10.",
                        "7": "7 + 7 = 14, not 10. We need the number that makes 10.",
                        "17": "You added 7 + 10 = 17. We want what ADDS TO 7 to make 10."
                    }}
            };
        },
        "Comparing Lengths": () => ({
            goalProblem: `Which is longer: a pencil or an eraser?`,
            teachingSteps: [
                {
                    title: "What does 'length' mean?",
                    explanation: "<strong>Length</strong> is how long something is from one end to the other. We can compare lengths to see which is longer or shorter.",
                    visual: "Length = end ←→ end"
                },
                {
                    title: "How to compare lengths",
                    explanation: "To compare, line up objects at one end. The object that sticks out farther on the other end is <strong>longer</strong>!",
                    visual: "|====pencil=====|\n|==eraser==|"
                },
                {
                    title: "Think about real objects",
                    explanation: "Picture a pencil and an eraser. A pencil is usually about 7 inches long. An eraser is usually about 2 inches. Which sticks out more?",
                    visual: "Pencil: ▭▭▭▭▭▭▭\nEraser: ▭▭"
                },
                {
                    title: "The pencil is longer!",
                    explanation: "A pencil is <strong>longer</strong> than an eraser. The eraser is <strong>shorter</strong> than the pencil.",
                    visual: "pencil > eraser (in length)"
                },
                {
                    title: "Words for comparing length",
                    explanation: "Longer/shorter, taller/shorter, bigger/smaller all describe length comparisons. 'Longer' means more length, 'shorter' means less length.",
                    visual: "longer ↔ shorter"
                }
            ],
            finalAnswer: "pencil",
            answerExplanation: "A pencil is longer than an eraser. Pencils are typically 6-7 inches, while erasers are about 2 inches.",
            example: { problem: `Which is longer: a pencil or an eraser?`, steps: [
                { text: "Think about the size of each object", math: "Pencil ≈ 7 inches, Eraser ≈ 2 inches" },
                { text: "Compare: which has more length?", math: "7 inches > 2 inches" },
                { text: "The pencil is longer", math: "Answer: <strong>pencil</strong>" }
            ]},
            keyPoints: [
                "Line up objects at one end to compare fairly",
                "The object that extends further is LONGER",
                "Use words like longer/shorter, taller/shorter to describe"
            ],
            mistakes: [
                { wrong: "Comparing without lining up ends", why: "Always start objects at the same point to compare fairly!" },
                { wrong: "Confusing width with length", why: "Length is how LONG something is (end to end), not how wide." }
            ],
            guided: {
                problem: `Which is longer: a book or a paperclip?`,
                steps: [
                    { label: "Think about a book", value: "About 10 inches long" },
                    { label: "Think about a paperclip", value: "About 1 inch long" },
                    { label: "Which is longer?", value: "?" }
                ],
                answer: "book",
                answerLabel: "Which is longer?",
                interactiveSteps: [
                    {
                        prompt: "Picture a book. Is it about the size of your hand or much bigger?",
                        hint: "Think about a book you've read...",
                        answer: "bigger",
                        acceptableAnswers: ["bigger", "big", "much bigger", "large", "larger"],
                        formatHint: "bigger or smaller",
                        commonMistakes: {
                            "smaller": "Most books are bigger than your hand - about 8-10 inches long!"
                        }
                    },
                    {
                        prompt: "A paperclip is very small - about how long is it?",
                        hint: "Paperclips are tiny...",
                        answer: "1 inch",
                        acceptableAnswers: ["1 inch", "1", "one inch", "small", "very small", "tiny"],
                        formatHint: "Describe the size",
                        commonMistakes: {
                            "10 inches": "That's way too big! Paperclips are tiny - about 1 inch."
                        }
                    },
                    {
                        prompt: "A book is about 10 inches and a paperclip is about 1 inch. Which is longer?",
                        hint: "10 inches vs 1 inch...",
                        answer: "book",
                        acceptableAnswers: ["book", "the book", "a book"],
                        formatHint: "book or paperclip",
                        commonMistakes: {
                            "paperclip": "A paperclip is only 1 inch! A book at 10 inches is much LONGER."
                        }
                    }
                ]
            },
            practice: { problem: `Which is longer: a car or a bicycle?`, answer: "car", options: ["car", "bicycle", "same length"],
                mistakeAnalysis: {
                    "bicycle": "A bicycle is about 6 feet long. A car is about 15 feet! The car is longer.",
                    "same length": "They're very different sizes. A car is about 15 feet, a bicycle about 6 feet."
                }}
        }),
        "3D Shapes": () => ({
            goalProblem: `A ball is shaped like a...?`,
            teachingSteps: [
                {
                    title: "What are 3D shapes?",
                    explanation: "<strong>3D shapes</strong> (three-dimensional) are solid shapes that take up space. Unlike flat 2D shapes, you can hold 3D shapes in your hand!",
                    visual: "2D: ○ (flat) → 3D: ⚽ (solid)"
                },
                {
                    title: "Meet the sphere",
                    explanation: "A <strong>sphere</strong> is perfectly round like a ball. It has no flat surfaces, no edges, and no corners. It can roll in any direction!",
                    visual: "Sphere: ⚽ 🏀 🌍 (balls, globes)"
                },
                {
                    title: "Meet the cube",
                    explanation: "A <strong>cube</strong> has 6 square faces that are all the same size. It has 12 edges and 8 corners (vertices). Dice and ice cubes are cubes!",
                    visual: "Cube: 🎲 (6 faces, 12 edges, 8 corners)"
                },
                {
                    title: "Meet the cylinder",
                    explanation: "A <strong>cylinder</strong> has 2 flat circular faces (top and bottom) connected by a curved surface. Cans and tubes are cylinders!",
                    visual: "Cylinder: 🥫 (2 circles + curved side)"
                },
                {
                    title: "A ball is a sphere!",
                    explanation: "A ball is perfectly round with no flat parts - that's a <strong>sphere</strong>! Oranges, globes, and marbles are also spheres.",
                    visual: "Ball = Sphere ⚽"
                }
            ],
            finalAnswer: "sphere",
            answerExplanation: "A ball is round in every direction with no flat surfaces - that's a sphere!",
            example: { problem: `A ball is shaped like a...?`, steps: [
                { text: "Look at the shape of a ball", math: "It's perfectly round" },
                { text: "Does it have flat surfaces?", math: "No - it's curved all around" },
                { text: "A round shape with no flat parts is a sphere", math: "Answer: <strong>sphere</strong>" }
            ]},
            keyPoints: [
                "Sphere = round like a ball (no flat surfaces)",
                "Cube = 6 square faces (like dice)",
                "Cylinder = 2 circles connected by curved surface (like a can)",
                "Cone = 1 circle and a point (like an ice cream cone)"
            ],
            mistakes: [
                { wrong: "Calling a sphere a circle", why: "A circle is flat (2D). A sphere is solid (3D) - you can hold it!" },
                { wrong: "Confusing cube and square", why: "A square is flat. A cube is like a 3D box made of 6 squares." }
            ],
            guided: {
                problem: `A dice is shaped like a...?`,
                steps: [
                    { label: "How many flat faces does a dice have?", value: "6 square faces" },
                    { label: "Are all faces the same?", value: "Yes, all squares" },
                    { label: "What 3D shape has 6 square faces?", value: "?" }
                ],
                answer: "cube",
                answerLabel: "What shape is a dice?",
                interactiveSteps: [
                    {
                        prompt: "Look at a dice. Does it have flat surfaces or is it all curved?",
                        hint: "Can you set a dice flat on a table?",
                        answer: "flat",
                        acceptableAnswers: ["flat", "flat surfaces", "yes", "flat sides"],
                        formatHint: "flat or curved",
                        commonMistakes: {
                            "curved": "A dice has flat surfaces - you can set it on a table!"
                        }
                    },
                    {
                        prompt: "How many flat faces (sides) does a dice have? Count them!",
                        hint: "A dice shows numbers 1-6, one on each face...",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "4": "Count again! A dice has faces on top, bottom, front, back, left, and right = 6",
                            "8": "That's too many. A dice has exactly 6 faces."
                        }
                    },
                    {
                        prompt: "A 3D shape with 6 square faces is called a...?",
                        hint: "It rhymes with 'tube'...",
                        answer: "cube",
                        acceptableAnswers: ["cube", "a cube"],
                        formatHint: "Name the shape",
                        commonMistakes: {
                            "square": "A square is flat (2D). The 3D shape is called a cube!",
                            "box": "Good thinking! The math word for a box shape is 'cube'."
                        }
                    }
                ]
            },
            practice: { problem: `A soup can is shaped like a...?`, answer: "cylinder", options: ["sphere", "cube", "cylinder", "cone"],
                mistakeAnalysis: {
                    "sphere": "A sphere is round like a ball. A can has flat top and bottom circles.",
                    "cube": "A cube has square faces. A can has circular faces and curved sides.",
                    "cone": "A cone has a point. A can has two flat circular ends."
                }}
        }),
        "Partitioning Shapes": () => ({
            goalProblem: `If we cut a circle into 2 equal parts, what is each part called?`,
            teachingSteps: [
                {
                    title: "What does 'partitioning' mean?",
                    explanation: "<strong>Partitioning</strong> means cutting or dividing a shape into smaller pieces. The pieces must be <strong>equal</strong> (the same size)!",
                    visual: "Whole → Cut → Equal Parts"
                },
                {
                    title: "Cutting into 2 equal parts = Halves",
                    explanation: "When we cut something into <strong>2 equal parts</strong>, each part is called a <strong>half</strong>. Two halves make a whole!",
                    visual: "○ → ◐ + ◑ (2 halves)"
                },
                {
                    title: "Cutting into 4 equal parts = Fourths",
                    explanation: "When we cut something into <strong>4 equal parts</strong>, each part is called a <strong>fourth</strong> (or quarter). Four fourths make a whole!",
                    visual: "○ → ◔ + ◔ + ◔ + ◔ (4 fourths)"
                },
                {
                    title: "The parts MUST be equal!",
                    explanation: "For the parts to have these special names, they must be the <strong>same size</strong>. If one piece is bigger, they're not true halves or fourths!",
                    visual: "✓ Equal parts   ✗ Unequal parts"
                },
                {
                    title: "A circle cut into 2 equal parts = halves",
                    explanation: "When we cut our circle into 2 equal parts, each part is a <strong>half</strong>. Half means 'one of two equal parts'.",
                    visual: "○ → ◐ = half"
                }
            ],
            finalAnswer: "half",
            answerExplanation: "When we divide something into 2 equal parts, each part is called a half.",
            example: { problem: `If we cut a circle into 2 equal parts, what is each part called?`, steps: [
                { text: "Count how many parts", math: "2 equal parts" },
                { text: "2 equal parts have a special name", math: "2 parts = halves" },
                { text: "Each single part is one half", math: "Answer: <strong>half</strong>" }
            ]},
            keyPoints: [
                "2 equal parts = halves (each part is a half)",
                "4 equal parts = fourths or quarters",
                "Parts MUST be equal to use these names",
                "The more parts, the smaller each piece"
            ],
            mistakes: [
                { wrong: "Saying 'half' when parts aren't equal", why: "Halves must be equal! If one piece is bigger, they're not halves." },
                { wrong: "Confusing fourths and halves", why: "2 parts = halves, 4 parts = fourths. Count the pieces!" }
            ],
            guided: {
                problem: `A pizza is cut into 4 equal slices. What is each slice called?`,
                steps: [
                    { label: "How many slices?", value: "4 equal slices" },
                    { label: "4 equal parts are called", value: "?" },
                    { label: "Each slice is one", value: "?" }
                ],
                answer: "fourth",
                answerLabel: "What is each slice called?",
                interactiveSteps: [
                    {
                        prompt: "The pizza is cut into how many equal pieces?",
                        hint: "Count the slices...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "2": "Read again - the pizza has 4 slices, not 2."
                        }
                    },
                    {
                        prompt: "When something is cut into 4 equal parts, the parts are called fourths. What is another name for fourths?",
                        hint: "Think about coins - a quarter is 1/4 of a dollar...",
                        answer: "quarters",
                        acceptableAnswers: ["quarters", "quarter", "fourths"],
                        formatHint: "Enter the name",
                        commonMistakes: {
                            "halves": "Halves are 2 parts. With 4 parts, we have fourths (or quarters)."
                        }
                    },
                    {
                        prompt: "So each pizza slice is called a...?",
                        hint: "One of four equal parts...",
                        answer: "fourth",
                        acceptableAnswers: ["fourth", "quarter", "a fourth", "a quarter", "one fourth"],
                        formatHint: "Enter the name",
                        commonMistakes: {
                            "half": "A half is 1 of 2 parts. This is 1 of 4 parts = a fourth."
                        }
                    }
                ]
            },
            practice: { problem: `A sandwich is cut into 2 equal pieces. What is each piece?`, answer: "half", options: ["half", "fourth", "third", "whole"],
                mistakeAnalysis: {
                    "fourth": "Fourths are when you have 4 equal pieces. 2 pieces = halves.",
                    "third": "Thirds are when you have 3 equal pieces. 2 pieces = halves.",
                    "whole": "A whole is the entire thing uncut. Each piece is a half."
                }}
        }),
        "Composing Shapes": () => ({
            goalProblem: `What shape can you make with 2 triangles?`,
            teachingSteps: [
                {
                    title: "What does 'composing' mean?",
                    explanation: "<strong>Composing shapes</strong> means putting smaller shapes together to make bigger shapes. It's like building with blocks!",
                    visual: "Small shapes + Small shapes = Bigger shape"
                },
                {
                    title: "Triangles are great building blocks",
                    explanation: "Triangles can fit together in many ways! Two triangles can make squares, rectangles, or even bigger triangles.",
                    visual: "△ + △ = ?"
                },
                {
                    title: "Two triangles can make a square",
                    explanation: "If you put two <strong>right triangles</strong> together along their longest side, you get a <strong>square</strong>!",
                    visual: "◸ + ◿ = □"
                },
                {
                    title: "Two triangles can make a rectangle",
                    explanation: "Two triangles can also be arranged to make a <strong>rectangle</strong> - a shape with 4 sides and 4 corners.",
                    visual: "△ + ▽ = ▭"
                },
                {
                    title: "The answer: 2 triangles make a square (or rectangle)",
                    explanation: "With 2 triangles, we can make a <strong>square</strong> or a <strong>rectangle</strong> depending on how we arrange them!",
                    visual: "△ + △ = □ or ▭"
                }
            ],
            finalAnswer: "square",
            answerExplanation: "Two right triangles put together can form a square! They can also form a rectangle.",
            example: { problem: `What shape can you make with 2 triangles?`, steps: [
                { text: "Think about how triangles fit together", math: "△ + △" },
                { text: "Place them along matching sides", math: "◸ ◿" },
                { text: "Together they form a square!", math: "Answer: <strong>square</strong>" }
            ]},
            keyPoints: [
                "2 triangles → square or rectangle",
                "2 squares → rectangle",
                "6 triangles → hexagon",
                "4 squares → bigger square"
            ],
            mistakes: [
                { wrong: "Thinking shapes can only make the same shape", why: "Different shapes can combine! 2 triangles make a square." },
                { wrong: "Forgetting to match the sides", why: "Shapes fit together when their sides match in length." }
            ],
            guided: {
                problem: `What can you build with 2 squares?`,
                steps: [
                    { label: "Start with", value: "2 squares □ □" },
                    { label: "Put them side by side", value: "□□" },
                    { label: "The new shape is a", value: "?" }
                ],
                answer: "rectangle",
                answerLabel: "What shape do 2 squares make?",
                interactiveSteps: [
                    {
                        prompt: "If you put 2 squares side by side, is the new shape still a square?",
                        hint: "A square has all sides equal. If you double one direction...",
                        answer: "no",
                        acceptableAnswers: ["no", "nope", "n"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "yes": "Look carefully - the new shape is longer than it is tall. Not a square!"
                        }
                    },
                    {
                        prompt: "The new shape has 4 sides and 4 corners, but it's longer than it is tall. What shape is that?",
                        hint: "A shape with 4 corners that isn't a square...",
                        answer: "rectangle",
                        acceptableAnswers: ["rectangle", "a rectangle"],
                        formatHint: "Name the shape",
                        commonMistakes: {
                            "square": "A square has all equal sides. This shape is longer one way - it's a rectangle!"
                        }
                    }
                ]
            },
            practice: { problem: `6 triangles can be arranged to make a...?`, answer: "hexagon", options: ["square", "pentagon", "hexagon", "circle"],
                mistakeAnalysis: {
                    "square": "A square only needs 2-4 triangles. 6 triangles make a hexagon!",
                    "pentagon": "A pentagon has 5 sides. 6 triangles make a 6-sided hexagon.",
                    "circle": "Triangles have straight edges and can't make a curved circle."
                }}
        }),
        "Picture Graphs": () => ({
            goalProblem: `How many apples? 🍎 🍎 🍎 🍎 🍎`,
            teachingSteps: [
                {
                    title: "What is a picture graph?",
                    explanation: "A <strong>picture graph</strong> uses pictures or symbols to show data. Each picture stands for one thing (or sometimes more)!",
                    visual: "🍎 🍎 🍎 = 3 apples"
                },
                {
                    title: "How to read a picture graph",
                    explanation: "To find out 'how many', simply <strong>count the pictures</strong>! Each picture = 1 item (unless it says otherwise).",
                    visual: "Count: 🍎(1) 🍎(2) 🍎(3) = 3"
                },
                {
                    title: "Let's count our apples",
                    explanation: "Point to each apple and count: 1, 2, 3, 4, 5. There are <strong>5 apples</strong>!",
                    visual: "🍎(1) 🍎(2) 🍎(3) 🍎(4) 🍎(5)"
                },
                {
                    title: "Comparing in picture graphs",
                    explanation: "Picture graphs make it easy to compare! The row with MORE pictures has MORE items.",
                    visual: "🍎🍎🍎🍎🍎 (5) vs 🍊🍊🍊 (3) → More apples!"
                },
                {
                    title: "The answer is 5 apples",
                    explanation: "We counted 5 apple pictures, so there are <strong>5 apples</strong>!",
                    visual: "🍎 🍎 🍎 🍎 🍎 = 5"
                }
            ],
            finalAnswer: "5",
            answerExplanation: "Count each apple picture: 1, 2, 3, 4, 5. There are 5 apples!",
            example: { problem: `How many apples? 🍎 🍎 🍎 🍎 🍎`, steps: [
                { text: "Each picture represents 1 apple", math: "🍎 = 1 apple" },
                { text: "Count each picture", math: "🍎(1) 🍎(2) 🍎(3) 🍎(4) 🍎(5)" },
                { text: "The total is 5", math: "Answer: <strong>5 apples</strong>" }
            ]},
            keyPoints: [
                "Each picture = 1 item (usually)",
                "Count all the pictures to find the total",
                "More pictures = more items",
                "Picture graphs make comparing easy - just look at which row is longer!"
            ],
            mistakes: [
                { wrong: "Miscounting pictures", why: "Point to each picture as you count. Go slowly!" },
                { wrong: "Forgetting what each picture means", why: "Always check the key - each picture might mean 1, 2, or more!" }
            ],
            guided: {
                problem: `Which has more?\nCats: 🐱 🐱 🐱 🐱\nDogs: 🐶 🐶 🐶 🐶 🐶 🐶`,
                steps: [
                    { label: "Count the cats", value: "4 cats" },
                    { label: "Count the dogs", value: "6 dogs" },
                    { label: "Which has more?", value: "?" }
                ],
                answer: "dogs",
                answerLabel: "Which has more?",
                interactiveSteps: [
                    {
                        prompt: "Count the cats: 🐱 🐱 🐱 🐱. How many?",
                        hint: "Count each cat picture...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Count the dogs: 🐶 🐶 🐶 🐶 🐶 🐶. How many?",
                        hint: "Count each dog picture...",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "4 cats vs 6 dogs. Which group has MORE?",
                        hint: "Which number is bigger: 4 or 6?",
                        answer: "dogs",
                        acceptableAnswers: ["dogs", "dog", "the dogs"],
                        formatHint: "cats or dogs",
                        commonMistakes: {
                            "cats": "4 is less than 6. Dogs (6) is more than cats (4)!"
                        }
                    }
                ]
            },
            practice: { problem: `Stars: ⭐ ⭐ ⭐\nHearts: ♥ ♥ ♥ ♥ ♥\nHow many more hearts than stars?`, answer: "2", options: ["1", "2", "3", "5"],
                mistakeAnalysis: {
                    "1": "Count again: 5 hearts - 3 stars = 2 more hearts.",
                    "3": "That's how many stars there are. The difference is 5 - 3 = 2.",
                    "5": "That's how many hearts there are. The difference is 5 - 3 = 2."
                }}
        }),
        "Positional Words": () => ({
            goalProblem: `The bird is ___ the tree. (above/below)`,
            teachingSteps: [
                {
                    title: "What are positional words?",
                    explanation: "<strong>Positional words</strong> describe WHERE something is located. They help us explain the position of objects!",
                    visual: "Where is it? → Positional word!"
                },
                {
                    title: "Above and Below",
                    explanation: "<strong>Above</strong> means higher up. <strong>Below</strong> means lower down. Think of a ladder - your head is above your feet!",
                    visual: "☁ (above) ← bird → (below) 🌳"
                },
                {
                    title: "Beside and Between",
                    explanation: "<strong>Beside</strong> means next to (on the side). <strong>Between</strong> means in the middle of two things.",
                    visual: "A [beside] B [between A and C] C"
                },
                {
                    title: "In front of and Behind",
                    explanation: "<strong>In front of</strong> means at the front, where you can see it. <strong>Behind</strong> means at the back, hidden from view.",
                    visual: "You → [in front] Tree [behind] → ?"
                },
                {
                    title: "The bird is ABOVE the tree",
                    explanation: "Birds fly high in the sky, higher than trees. So the bird is <strong>above</strong> the tree!",
                    visual: "🐦 ← above\n🌳 ← below"
                }
            ],
            finalAnswer: "above",
            answerExplanation: "A bird in the sky is higher than a tree, so the bird is above the tree.",
            example: { problem: `The bird is ___ the tree.`, steps: [
                { text: "Where do birds usually fly?", math: "In the sky, up high" },
                { text: "Is that higher or lower than a tree?", math: "Higher" },
                { text: "Higher = above", math: "Answer: <strong>above</strong>" }
            ]},
            keyPoints: [
                "Above = higher up, Below = lower down",
                "Beside = next to, Between = in the middle",
                "In front of = at the front, Behind = at the back",
                "Inside = within, Outside = not within"
            ],
            mistakes: [
                { wrong: "Mixing up above and below", why: "Above = up (like the sky), Below = down (like the ground)" },
                { wrong: "Confusing beside and between", why: "Beside = next to ONE thing, Between = in the middle of TWO things" }
            ],
            guided: {
                problem: `The number 5 is ___ 4 and 6.`,
                steps: [
                    { label: "What numbers are given?", value: "4 and 6" },
                    { label: "Where is 5 compared to them?", value: "In the middle" },
                    { label: "The position word is", value: "?" }
                ],
                answer: "between",
                answerLabel: "What word fits?",
                interactiveSteps: [
                    {
                        prompt: "On a number line: 4, 5, 6. Where is 5 located?",
                        hint: "Is 5 at the end or in the middle?",
                        answer: "middle",
                        acceptableAnswers: ["middle", "in the middle", "center", "in between"],
                        formatHint: "Describe the position",
                        commonMistakes: {
                            "end": "5 is not at the end - it has 4 on one side and 6 on the other!"
                        }
                    },
                    {
                        prompt: "When something is in the middle of two things, it is ___ them.",
                        hint: "The word starts with 'bet'...",
                        answer: "between",
                        acceptableAnswers: ["between", "in between"],
                        formatHint: "Enter the position word",
                        commonMistakes: {
                            "beside": "Beside means next to ONE thing. Between means in the middle of TWO things."
                        }
                    }
                ]
            },
            practice: { problem: `The fish swims ___ the water surface. (above/below)`, answer: "below", options: ["above", "below", "beside", "between"],
                mistakeAnalysis: {
                    "above": "Fish swim IN the water, which is lower than (below) the surface.",
                    "beside": "Beside means next to. Fish swim under (below) the surface.",
                    "between": "Between needs two things. Fish are simply below the water's surface."
                }}
        }),
        "Classifying Objects": () => ({
            goalProblem: `Which does NOT belong: apple, banana, orange, car?`,
            teachingSteps: [
                {
                    title: "What is classifying?",
                    explanation: "<strong>Classifying</strong> means sorting things into groups based on what they have in common. Things in the same group share something!",
                    visual: "Sorting: 🍎🍌🍊 = Fruits | 🚗🚌🚲 = Vehicles"
                },
                {
                    title: "Look for what's the SAME",
                    explanation: "To classify, ask: 'What do most of these have in common?' Find the pattern or category that connects them.",
                    visual: "apple, banana, orange → All FRUIT!"
                },
                {
                    title: "Find the one that's DIFFERENT",
                    explanation: "Once you know the group, look for the item that <strong>doesn't fit</strong>. It's the 'odd one out'!",
                    visual: "🍎 🍌 🍊 🚗 ← Which is different?"
                },
                {
                    title: "Apple, banana, orange are all fruits",
                    explanation: "Apples, bananas, and oranges are all <strong>fruits</strong> - they grow on trees/plants and we eat them!",
                    visual: "✓ apple (fruit) ✓ banana (fruit) ✓ orange (fruit)"
                },
                {
                    title: "Car does NOT belong!",
                    explanation: "A <strong>car</strong> is a vehicle, not a fruit! It doesn't belong with the fruits.",
                    visual: "✗ car (NOT a fruit) - Doesn't belong!"
                }
            ],
            finalAnswer: "car",
            answerExplanation: "Apple, banana, and orange are all fruits. A car is a vehicle - it doesn't belong in the fruit group!",
            example: { problem: `Which does NOT belong: apple, banana, orange, car?`, steps: [
                { text: "Find what 3 items have in common", math: "Apple, banana, orange = fruits" },
                { text: "Check if the 4th item fits", math: "Car = vehicle, NOT a fruit" },
                { text: "The odd one out is car", math: "Answer: <strong>car</strong>" }
            ]},
            keyPoints: [
                "Look for what most items have in common",
                "The odd one out doesn't share that feature",
                "Common categories: colors, sizes, shapes, types (animals, foods, etc.)"
            ],
            mistakes: [
                { wrong: "Not looking for the pattern", why: "First find what most items share, THEN find the different one." },
                { wrong: "Picking something that does belong", why: "Make sure your answer is truly different from the others." }
            ],
            guided: {
                problem: `Which does NOT belong: dog, cat, bird, table?`,
                steps: [
                    { label: "What are dog, cat, and bird?", value: "Animals" },
                    { label: "Is a table an animal?", value: "No" },
                    { label: "The odd one out is", value: "?" }
                ],
                answer: "table",
                answerLabel: "Which doesn't belong?",
                interactiveSteps: [
                    {
                        prompt: "Dog, cat, and bird are all living things that move around. What category are they?",
                        hint: "They're all...",
                        answer: "animals",
                        acceptableAnswers: ["animals", "animal", "pets", "living things"],
                        formatHint: "What type of things are they?",
                        commonMistakes: {
                            "objects": "Animals are living creatures, not just objects!"
                        }
                    },
                    {
                        prompt: "Is a table an animal?",
                        hint: "Can a table move on its own? Is it alive?",
                        answer: "no",
                        acceptableAnswers: ["no", "nope", "n"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "yes": "A table is furniture, not a living animal!"
                        }
                    },
                    {
                        prompt: "Dog, cat, and bird are animals. Table is furniture. Which one does NOT belong?",
                        hint: "Which one is different from the others?",
                        answer: "table",
                        acceptableAnswers: ["table", "the table", "a table"],
                        formatHint: "Which item?",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Which does NOT belong: circle, square, triangle, red?`, answer: "red", options: ["circle", "square", "triangle", "red"],
                mistakeAnalysis: {
                    "circle": "Circle is a shape, just like square and triangle. They all belong together!",
                    "square": "Square is a shape, just like circle and triangle. They all belong together!",
                    "triangle": "Triangle is a shape, just like circle and square. They all belong together!"
                }}
        })
    },
    2: {
        Multiplication: () => {
            const a = rand(3, 5), b = rand(2, 4);
            return {
                goalProblem: `What is 4 × 3?`,
                teachingSteps: [
                    {
                        title: "What is multiplication?",
                        explanation: "<strong>Multiplication</strong> is a faster way to add the same number many times. Instead of writing 3+3+3+3, we can write 4×3!",
                        visual: "3 + 3 + 3 + 3 = 4 × 3"
                    },
                    {
                        title: "What does 4 × 3 mean?",
                        explanation: "4 × 3 means '<strong>4 groups of 3</strong>' or '3 added 4 times'. The × symbol means 'groups of'.",
                        visual: "4 × 3 = '4 groups of 3'"
                    },
                    {
                        title: "Let's picture it",
                        explanation: "Imagine 4 groups with 3 dots in each group. We need to count all the dots!",
                        visual: "●●●  ●●●  ●●●  ●●●"
                    },
                    {
                        title: "Add the groups together",
                        explanation: "We have 4 groups of 3. Let's add: 3 + 3 = 6, then 6 + 3 = 9, then 9 + 3 = 12.",
                        visual: "3 + 3 + 3 + 3 = 12"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>4 × 3 = 12</strong>. You can also skip count by 3s four times: 3, 6, 9, 12!",
                        visual: "4 × 3 = 12"
                    }
                ],
                finalAnswer: "4 × 3 = 12",
                answerExplanation: "4 groups of 3 equals 12. We added 3 four times: 3 + 3 + 3 + 3 = 12!",
                example: { problem: `What is 4 × 3?`, steps: [
                    { text: "Read it as: 4 groups of 3", math: "4 × 3 = 3 + 3 + 3 + 3" },
                    { text: "Add step by step", math: "3 + 3 = 6, then 6 + 3 = 9, then 9 + 3 = 12" },
                    { text: "Or visualize 4 groups", math: "●●● ●●● ●●● ●●● = <strong>12</strong>" }
                ]},
                keyPoints: [
                    "× means 'groups of': 5 × 2 = 5 groups of 2",
                    "You can flip them: 4 × 3 = 3 × 4 = 12",
                    "Skip counting helps: 3, 6, 9, 12 (that's counting by 3s, four times)"
                ],
                mistakes: [
                    { wrong: "4 × 3 = 7 (adding instead)", why: "× means multiply, not add. 4 + 3 = 7, but 4 × 3 = 12" },
                    { wrong: "4 × 3 = 43 (putting digits together)", why: "We're making groups, not combining digits!" }
                ],
                guided: {
                    problem: `What is ${a} × ${b}?`,
                    steps: [
                        { label: `Read as "${a} groups of ${b}"`, value: `${Array(a).fill(b).join(' + ')}` },
                        { label: "Add them up", value: `${Array(a).fill(b).join(' + ')} = ?` },
                        { label: "Total", value: "?" }
                    ],
                    answer: String(a * b),
                    answerLabel: `${a} × ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `What does ${a} × ${b} mean in words?`,
                            hint: `It means ${a} groups of...`,
                            answer: `${a} groups of ${b}`,
                            acceptableAnswers: [`${a} groups of ${b}`, `${b} added ${a} times`, `${b}+${b}` + (a > 2 ? `+${b}` : '') + (a > 3 ? `+${b}` : '') + (a > 4 ? `+${b}` : '')],
                            formatHint: "e.g., 4 groups of 3",
                            commonMistakes: {
                                [`${a} + ${b}`]: `That's addition! ${a} × ${b} means ${a} GROUPS of ${b}.`,
                                [`${b} groups of ${a}`]: `Close! ${a} × ${b} means ${a} groups of ${b} (first number = how many groups).`
                            }
                        },
                        {
                            prompt: `Let's skip count by ${b}s, ${a} times. Start: ${b}... What comes next?`,
                            hint: `${b} + ${b} = ?`,
                            answer: String(b * 2),
                            acceptableAnswers: [String(b * 2)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b + 1)]: `You added 1. Skip count by ${b}s: ${b}, ${b*2}, ${b*3}...`,
                                [String(b)]: `That's the first number. Next is ${b} + ${b} = ${b * 2}`
                            }
                        },
                        {
                            prompt: `Keep counting by ${b}s: ${Array.from({length: a-1}, (_, i) => b * (i + 1)).join(', ')}... What's the ${a}th number?`,
                            hint: `Count ${a} jumps of ${b}`,
                            answer: String(a * b),
                            acceptableAnswers: [String(a * b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String((a - 1) * b)]: `That's only ${a - 1} groups. Count one more: ${(a-1)*b} + ${b} = ${a * b}`,
                                [String((a + 1) * b)]: `That's ${a + 1} groups - one too many! We need exactly ${a} groups.`,
                                [String(a + b)]: `You added instead of multiplied! ${a} × ${b} = ${a * b}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1; return { problem: `What is ${pa} × ${b}?`, answer: String(pa * b),
                    options: shuffle([String(pa * b), String(a * b), String(pa + b), String((pa + 1) * b)]),
                    mistakeAnalysis: {
                        [String(a * b)]: `That's ${a} × ${b}. We need ${pa} groups of ${b}.`,
                        [String(pa + b)]: `You added instead of multiplied. ${pa} × ${b} means ${pa} groups of ${b}.`,
                        [String((pa + 1) * b)]: `That's one group too many. We need exactly ${pa} groups of ${b}.`
                    }}; })()
            };
        },
        Division: () => {
            const ans = rand(3, 6), b = rand(2, 4);
            const a = ans * b;
            return {
                goalProblem: `What is 12 ÷ 4?`,
                teachingSteps: [
                    {
                        title: "What is division?",
                        explanation: "<strong>Division</strong> means splitting things into <strong>equal groups</strong>. The ÷ symbol means 'divided by' or 'split into'.",
                        visual: "12 things ÷ 4 groups = ? in each"
                    },
                    {
                        title: "What does 12 ÷ 4 mean?",
                        explanation: "12 ÷ 4 asks: 'If we split 12 things into 4 equal groups, how many are in each group?'",
                        visual: "12 items → split into 4 groups → how many each?"
                    },
                    {
                        title: "Let's picture it",
                        explanation: "Imagine 12 dots. We want to put them into 4 equal groups. Let's deal them out one at a time to each group.",
                        visual: "●●●●●●●●●●●● → 4 groups"
                    },
                    {
                        title: "Deal them into 4 groups",
                        explanation: "Put one dot in each group, then repeat until all dots are used. Each group ends up with 3 dots!",
                        visual: "●●● | ●●● | ●●● | ●●●"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>12 ÷ 4 = 3</strong>. Each group has 3! You can check: 4 groups × 3 in each = 12 total.",
                        visual: "12 ÷ 4 = 3"
                    }
                ],
                finalAnswer: "12 ÷ 4 = 3",
                answerExplanation: "When we split 12 into 4 equal groups, each group has 3. Division is the opposite of multiplication!",
                example: { problem: `What is 12 ÷ 4?`, steps: [
                    { text: "Read it as: Split 12 into 4 equal groups", math: "12 items → 4 groups → how many each?" },
                    { text: "Draw it out", math: "●●● | ●●● | ●●● | ●●●" },
                    { text: "Count how many in each group", math: "Each group has <strong>3</strong>, so 12 ÷ 4 = <strong>3</strong>" }
                ]},
                keyPoints: [
                    "Division is splitting into EQUAL groups",
                    "Think multiplication backwards: ___ × 4 = 12? Answer: 3",
                    "The dividend (12) gets split into groups of the divisor (4)"
                ],
                mistakes: [
                    { wrong: "Dividing in the wrong order (4 ÷ 12)", why: "The big number gets divided BY the small number. 12 ÷ 4 ≠ 4 ÷ 12" },
                    { wrong: "Subtracting instead of dividing", why: "12 - 4 = 8, but 12 ÷ 4 = 3. Division is about equal groups." }
                ],
                guided: {
                    problem: `What is ${a} ÷ ${b}?`,
                    steps: [
                        { label: `Split ${a} into ${b} equal groups`, value: `●●● `.repeat(b).trim() + ` (${ans} in each)` },
                        { label: `Think: ${b} × ___ = ${a}`, value: `${b} × ${ans} = ${a}` },
                        { label: "How many in each group?", value: "?" }
                    ],
                    answer: String(ans),
                    answerLabel: `${a} ÷ ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `${a} ÷ ${b} means: "Split ${a} into ${b} equal groups." What are we trying to find?`,
                            hint: "We want to know how many are in EACH group...",
                            answer: "how many in each group",
                            acceptableAnswers: ["how many in each group", "items per group", "number in each group", "each group", String(ans)],
                            formatHint: "Enter a number or phrase",
                            commonMistakes: {
                                [String(a)]: `${a} is the total we're splitting up. We want to find how many in EACH group.`,
                                [String(b)]: `${b} is the number of groups. We want how many are IN each group.`
                            }
                        },
                        {
                            prompt: `Division is the opposite of multiplication. Think: ${b} × ___ = ${a}. What number times ${b} equals ${a}?`,
                            hint: `Try counting by ${b}s until you reach ${a}...`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `${b} × ${b} = ${b * b}. We need ${b} × ? = ${a}. The answer is ${ans}.`,
                                [String(a)]: `${b} × ${a} = ${b * a}, which is too big! We need ${b} × ${ans} = ${a}.`
                            }
                        },
                        {
                            prompt: `So if ${b} × ${ans} = ${a}, then ${a} ÷ ${b} = ?`,
                            hint: "Division and multiplication are opposites!",
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `${b} is the divisor (what we divide BY). The answer is ${ans}.`,
                                [String(a - b)]: `You subtracted! ${a} ÷ ${b} = ${ans}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = (ans + 1) * b; return { problem: `What is ${pa} ÷ ${b}?`, answer: String(ans + 1),
                    options: shuffle([String(ans + 1), String(ans), String(ans + 2), String(b)]),
                    mistakeAnalysis: {
                        [String(ans)]: `That's ${a} ÷ ${b}. With ${pa} total, each group gets more.`,
                        [String(b)]: "You flipped the answer. Think: how many in EACH group?",
                        [String(ans + 2)]: `Too many per group. Check: ${b} × ${ans + 2} = ${b * (ans + 2)}, not ${pa}.`
                    }}; })()
            };
        },
        Time: () => ({
            goalProblem: `What time does the clock show when the short hand is on 3 and long hand is on 6?`,
            teachingSteps: [
                {
                    title: "A clock has two hands",
                    explanation: "Every clock has two hands: a <strong>short hand</strong> and a <strong>long hand</strong>. Each tells us something different!",
                    visual: "Short hand (small) + Long hand (big)"
                },
                {
                    title: "Short hand = HOURS",
                    explanation: "The <strong>short hand</strong> tells us the <strong>hour</strong>. It moves slowly - it only goes around twice a day!",
                    visual: "Short hand → HOUR"
                },
                {
                    title: "Long hand = MINUTES",
                    explanation: "The <strong>long hand</strong> tells us the <strong>minutes</strong>. Each number on the clock = 5 minutes (1=5, 2=10, 3=15...).",
                    visual: "Long hand → MINUTES (each number × 5)"
                },
                {
                    title: "Let's read our clock",
                    explanation: "Short hand is on <strong>3</strong> → Hour is 3. Long hand is on <strong>6</strong> → Minutes = 6 × 5 = 30.",
                    visual: "Hour: 3 | Minutes: 6 × 5 = 30"
                },
                {
                    title: "Put it together",
                    explanation: "Hour is 3, minutes is 30. We write this as <strong>3:30</strong> (said 'three thirty').",
                    visual: "3:30"
                }
            ],
            finalAnswer: "3:30",
            answerExplanation: "Short hand on 3 = hour is 3. Long hand on 6 = 30 minutes (6 × 5). The time is 3:30!",
            example: { problem: `What time does the clock show when the short hand is on 3 and long hand is on 6?`, steps: [
                { text: "Find the hour (short hand)", math: "Short hand points to 3 → Hour is 3" },
                { text: "Find the minutes (long hand)", math: "Long hand points to 6 → 6 × 5 = 30 minutes" },
                { text: "Put them together", math: "Time is <strong>3:30</strong> (three-thirty)" }
            ]},
            keyPoints: [
                "Short hand = hour, Long hand = minutes",
                "Multiply the minute hand's number by 5",
                "1 hour = 60 minutes, Half hour = 30 minutes"
            ],
            mistakes: [
                { wrong: "Mixing up the hands", why: "SHORT = hours (like 'short' word). LONG = minutes (longer word)." },
                { wrong: "Reading 6 as 6 minutes", why: "Multiply by 5! The 6 means 6 × 5 = 30 minutes." }
            ],
            guided: {
                problem: `It's 4:00 now. What time will it be in 2 hours?`,
                steps: [
                    { label: "Start time", value: "4:00" },
                    { label: "Add 2 hours to the hour", value: "4 + 2 = 6" },
                    { label: "New time", value: "?" }
                ],
                answer: "6:00",
                answerLabel: "What time?",
                interactiveSteps: [
                    {
                        prompt: "We start at 4:00. When we add hours, which number changes - the hour or the minutes?",
                        hint: "Hours are before the colon, minutes are after...",
                        answer: "hour",
                        acceptableAnswers: ["hour", "the hour", "hours"],
                        formatHint: "hour or minutes",
                        commonMistakes: {
                            "minutes": "When adding HOURS, the hour changes. The minutes (00) stay the same.",
                            "both": "Only the hour changes when we add hours. 4:00 + 2 hours keeps the :00"
                        }
                    },
                    {
                        prompt: "What is 4 + 2?",
                        hint: "Add 2 to the starting hour...",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "2": "4 + 2 = 6, not 2. Add the hours together!",
                            "42": "We ADD the hours, not combine digits. 4 + 2 = 6"
                        }
                    },
                    {
                        prompt: "The hour is now 6. The minutes stay at 00. What is the full time?",
                        hint: "Write it as hour:minutes",
                        answer: "6:00",
                        acceptableAnswers: ["6:00", "6 o'clock", "6 oclock"],
                        formatHint: "e.g., 6:00",
                        commonMistakes: {
                            "6": "Include the minutes! It's 6:00 (six o'clock)",
                            "600": "Use a colon: 6:00, not 600"
                        }
                    }
                ]
            },
            practice: { problem: `How many minutes are in 1 hour?`, answer: "60", options: ["30", "60", "100", "12"],
                mistakeAnalysis: {
                    "30": "30 is HALF an hour. A full hour has 60 minutes.",
                    "100": "We use 60 for time, not 100. There are 60 minutes in 1 hour.",
                    "12": "12 is the number of hours on a clock face. Each hour has 60 minutes."
                }}
        }),
        Money: () => ({
            goalProblem: `How much is 2 quarters and 1 dime?`,
            teachingSteps: [
                {
                    title: "Know your coins",
                    explanation: "There are 4 main coins. Each has a different value. <strong>Size doesn't equal value!</strong>",
                    visual: "Quarter=25¢ | Dime=10¢ | Nickel=5¢ | Penny=1¢"
                },
                {
                    title: "Quarters are worth 25 cents",
                    explanation: "A <strong>quarter</strong> is the biggest coin and worth <strong>25¢</strong>. It has ridged edges and shows a design on the back.",
                    visual: "Quarter = 25¢"
                },
                {
                    title: "Let's count our quarters first",
                    explanation: "We have 2 quarters. Each is worth 25¢. 2 quarters = 2 × 25¢ = 50¢",
                    visual: "2 × 25¢ = 50¢"
                },
                {
                    title: "Now count the dime",
                    explanation: "We have 1 dime. A <strong>dime</strong> is the smallest coin but worth <strong>10¢</strong>. 1 dime = 10¢",
                    visual: "1 × 10¢ = 10¢"
                },
                {
                    title: "Add them together",
                    explanation: "Quarters: 50¢ + Dime: 10¢ = <strong>60¢</strong>. Always add from biggest to smallest coin!",
                    visual: "50¢ + 10¢ = 60¢"
                }
            ],
            finalAnswer: "60 cents (60¢)",
            answerExplanation: "2 quarters (50¢) + 1 dime (10¢) = 60¢. Remember: Quarter=25¢, Dime=10¢!",
            example: { problem: `How much is 2 quarters and 1 dime?`, steps: [
                { text: "Find the value of quarters", math: "2 quarters = 2 × 25¢ = 50¢" },
                { text: "Find the value of the dime", math: "1 dime = 10¢" },
                { text: "Add them together", math: "50¢ + 10¢ = <strong>60¢</strong>" }
            ]},
            keyPoints: [
                "Start with the biggest coins (quarters first)",
                "Skip count: quarters by 25s, dimes by 10s, nickels by 5s",
                "4 quarters = 100¢ = $1.00"
            ],
            mistakes: [
                { wrong: "Thinking a dime is worth less than a nickel because it's smaller", why: "Size doesn't equal value! Dime = 10¢, Nickel = 5¢. The smaller coin is worth more!" },
                { wrong: "Forgetting to count all the coins", why: "Count each type separately, then add them up." }
            ],
            guided: {
                problem: `What is 3 dimes + 2 nickels?`,
                steps: [
                    { label: "Value of 3 dimes", value: "3 × 10¢ = 30¢" },
                    { label: "Value of 2 nickels", value: "2 × 5¢ = 10¢" },
                    { label: "Total", value: "?" }
                ],
                answer: "40",
                answerLabel: "Total cents:",
                interactiveSteps: [
                    {
                        prompt: "How much is ONE dime worth?",
                        hint: "A dime is the small silver coin...",
                        answer: "10",
                        acceptableAnswers: ["10", "10¢", "10 cents", "ten"],
                        formatHint: "Enter cents (e.g., 10)",
                        commonMistakes: {
                            "5": "That's a nickel! A dime = 10¢",
                            "25": "That's a quarter! A dime = 10¢",
                            "1": "That's a penny! A dime = 10¢"
                        }
                    },
                    {
                        prompt: "We have 3 dimes. How much is 3 × 10¢?",
                        hint: "Count by 10s: 10, 20, 30...",
                        answer: "30",
                        acceptableAnswers: ["30", "30¢", "30 cents"],
                        formatHint: "Enter cents (e.g., 30)",
                        commonMistakes: {
                            "13": "You added 10 + 3. Multiply: 3 × 10 = 30",
                            "10": "That's just 1 dime. We have 3 dimes: 3 × 10 = 30"
                        }
                    },
                    {
                        prompt: "How much is ONE nickel worth?",
                        hint: "A nickel is the big silver coin with a face...",
                        answer: "5",
                        acceptableAnswers: ["5", "5¢", "5 cents", "five"],
                        formatHint: "Enter cents (e.g., 5)",
                        commonMistakes: {
                            "10": "That's a dime! A nickel = 5¢",
                            "1": "That's a penny! A nickel = 5¢"
                        }
                    },
                    {
                        prompt: "We have 2 nickels. How much is 2 × 5¢?",
                        hint: "5 + 5 = ?",
                        answer: "10",
                        acceptableAnswers: ["10", "10¢", "10 cents"],
                        formatHint: "Enter cents (e.g., 10)",
                        commonMistakes: {
                            "7": "You added 5 + 2. Multiply: 2 × 5 = 10",
                            "5": "That's just 1 nickel. We have 2: 2 × 5 = 10"
                        }
                    },
                    {
                        prompt: "Now add the totals: 30¢ + 10¢ = ?",
                        hint: "Add the dimes total and nickels total...",
                        answer: "40",
                        acceptableAnswers: ["40", "40¢", "40 cents"],
                        formatHint: "Enter cents (e.g., 40)",
                        commonMistakes: {
                            "20": "You might have added 10 + 10. It's 30 + 10 = 40",
                            "310": "Don't combine digits! Add: 30 + 10 = 40"
                        }
                    }
                ]
            },
            practice: { problem: `1 quarter + 3 nickels = ? cents`, answer: "40", options: ["28", "35", "40", "45"],
                mistakeAnalysis: {
                    "28": "Check your coin values: Quarter = 25¢, Nickel = 5¢",
                    "35": "That's 1 quarter + 2 nickels. We have 3 nickels: 25 + 15 = 40",
                    "45": "That would be 4 nickels. We only have 3: 25 + 15 = 40"
                }}
        }),
        Rounding: () => {
            const num = rand(23, 87);
            const ones = num % 10;
            const rounded = ones >= 5 ? Math.ceil(num/10)*10 : Math.floor(num/10)*10;
            return {
                goalProblem: `Round 67 to the nearest ten`,
                teachingSteps: [
                    {
                        title: "What is rounding?",
                        explanation: "<strong>Rounding</strong> means finding the nearest 'friendly' number - a number that ends in 0, like 10, 20, 30, etc.",
                        visual: "67 → nearest 10 → 60 or 70?"
                    },
                    {
                        title: "Find the neighbors",
                        explanation: "67 sits between two tens: <strong>60</strong> and <strong>70</strong>. Which one is 67 closer to?",
                        visual: "60 ← 67 → 70"
                    },
                    {
                        title: "Look at the ones digit",
                        explanation: "The <strong>ones digit</strong> (the last digit) tells us which way to round. In 67, the ones digit is <strong>7</strong>.",
                        visual: "6<u>7</u> ← ones digit is 7"
                    },
                    {
                        title: "The rounding rule",
                        explanation: "If the ones digit is <strong>5 or more → round UP</strong>. If it's <strong>4 or less → round DOWN</strong>. Since 7 ≥ 5, we round UP!",
                        visual: "5, 6, 7, 8, 9 → UP | 0, 1, 2, 3, 4 → DOWN"
                    },
                    {
                        title: "67 rounds to 70",
                        explanation: "The ones digit is 7 (5 or more), so we round UP from 60 to 70. <strong>67 rounds to 70</strong>!",
                        visual: "67 → 70"
                    }
                ],
                finalAnswer: "70",
                answerExplanation: "67 has a ones digit of 7. Since 7 ≥ 5, we round UP to the next ten: 70.",
                example: { problem: `Round 67 to the nearest ten`, steps: [
                    { text: "Find the neighbors (tens around 67)", math: "67 is between 60 and 70" },
                    { text: "Look at the ones digit", math: "The ones digit is 7" },
                    { text: "Apply the rule: 7 ≥ 5, so round UP", math: "67 rounds to <strong>70</strong>" }
                ]},
                keyPoints: [
                    "5, 6, 7, 8, 9 → round UP",
                    "0, 1, 2, 3, 4 → round DOWN (stay at the lower ten)",
                    "Think: which ten is it CLOSER to?"
                ],
                mistakes: [
                    { wrong: "Rounding 45 down to 40", why: "5 is the special number - it rounds UP! 45 → 50" },
                    { wrong: "Changing the wrong digit", why: "When rounding to tens, only the tens digit changes. 67 → 70 (not 77)" }
                ],
                guided: {
                    problem: `Round ${num} to the nearest ten`,
                    steps: [
                        { label: `${num} is between`, value: `${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}` },
                        { label: "The ones digit is", value: `${ones}` },
                        { label: `${ones} is ${ones >= 5 ? '5 or more, so round UP' : '4 or less, so round DOWN'}`, value: "?" }
                    ],
                    answer: String(rounded),
                    answerLabel: "Rounded to:",
                    interactiveSteps: [
                        {
                            prompt: `When rounding ${num} to the nearest ten, which two tens is ${num} between?`,
                            hint: "Find the ten below and the ten above...",
                            answer: `${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`,
                            acceptableAnswers: [`${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`, `${Math.floor(num/10)*10}, ${Math.ceil(num/10)*10}`, `${Math.floor(num/10)*10}-${Math.ceil(num/10)*10}`],
                            formatHint: "e.g., 60 and 70",
                            commonMistakes: {
                                [String(num)]: `${num} is the number we're rounding. It sits BETWEEN ${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`
                            }
                        },
                        {
                            prompt: `What is the ones digit (last digit) of ${num}?`,
                            hint: "The ones digit is the rightmost digit...",
                            answer: String(ones),
                            acceptableAnswers: [String(ones)],
                            formatHint: "Enter a digit (0-9)",
                            commonMistakes: {
                                [String(Math.floor(num/10))]: `That's the tens digit. The ONES digit (last digit) of ${num} is ${ones}`
                            }
                        },
                        {
                            prompt: `Is ${ones} five or more (round UP) or four or less (round DOWN)?`,
                            hint: "5, 6, 7, 8, 9 round UP. 0, 1, 2, 3, 4 round DOWN.",
                            answer: ones >= 5 ? "round up" : "round down",
                            acceptableAnswers: ones >= 5 ? ["round up", "up", "rounds up"] : ["round down", "down", "rounds down"],
                            formatHint: "round up or round down",
                            commonMistakes: ones >= 5 ? {
                                "round down": `${ones} is 5 or more, so we round UP!`
                            } : {
                                "round up": `${ones} is less than 5, so we round DOWN!`
                            }
                        },
                        {
                            prompt: `So ${num} rounded to the nearest ten is?`,
                            hint: ones >= 5 ? `Round UP to ${Math.ceil(num/10)*10}` : `Round DOWN to ${Math.floor(num/10)*10}`,
                            answer: String(rounded),
                            acceptableAnswers: [String(rounded)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(ones >= 5 ? Math.floor(num/10)*10 : Math.ceil(num/10)*10)]: `${ones} is ${ones >= 5 ? '5 or more, so round UP' : 'less than 5, so round DOWN'} to ${rounded}`
                            }
                        }
                    ]
                },
                practice: { problem: `Round 84 to the nearest ten`, answer: "80", options: ["80", "84", "85", "90"],
                    mistakeAnalysis: {
                        "84": "We need to round to a 'tens' number (ending in 0). 84's ones digit is 4, so round DOWN to 80.",
                        "85": "Close, but we round to the nearest TEN (80 or 90), not to 5.",
                        "90": "The ones digit is 4, which is less than 5, so we round DOWN to 80, not up to 90."
                    }}
            };
        },
        Measurement: () => ({
            goalProblem: `How many inches are in 2 feet?`,
            teachingSteps: [
                {
                    title: "Why do we convert measurements?",
                    explanation: "Sometimes we need to change from one unit to another. For example, your height might be in feet, but you need it in inches!",
                    visual: "Feet ↔ Inches"
                },
                {
                    title: "The key conversion: 1 foot = 12 inches",
                    explanation: "Memorize this! There are <strong>12 inches in 1 foot</strong>. A ruler is usually 12 inches long - that's 1 foot!",
                    visual: "1 foot = 12 inches"
                },
                {
                    title: "Going to smaller units? MULTIPLY!",
                    explanation: "Inches are smaller than feet. When converting to smaller units, you get MORE of them, so you <strong>multiply</strong>.",
                    visual: "Bigger → Smaller = MULTIPLY"
                },
                {
                    title: "Let's convert 2 feet to inches",
                    explanation: "We have 2 feet. Each foot has 12 inches. So we multiply: 2 × 12.",
                    visual: "2 feet × 12 inches/foot"
                },
                {
                    title: "Calculate the answer",
                    explanation: "2 × 12 = <strong>24</strong>. There are 24 inches in 2 feet!",
                    visual: "2 feet = 24 inches"
                }
            ],
            finalAnswer: "24 inches",
            answerExplanation: "2 feet × 12 inches per foot = 24 inches. Always multiply when going to smaller units!",
            example: { problem: `How many inches are in 2 feet?`, steps: [
                { text: "Know the conversion", math: "1 foot = 12 inches" },
                { text: "We have 2 feet, so multiply", math: "2 feet × 12 inches/foot" },
                { text: "Calculate", math: "2 × 12 = <strong>24 inches</strong>" }
            ]},
            keyPoints: [
                "1 foot = 12 inches (memorize this!)",
                "Feet → inches: MULTIPLY by 12",
                "Inches → feet: DIVIDE by 12"
            ],
            mistakes: [
                { wrong: "Adding 12 instead of multiplying", why: "2 feet = 2 × 12 = 24 inches, not 2 + 12 = 14" },
                { wrong: "Confusing which way to convert", why: "Smaller units = bigger number. Inches are smaller than feet, so more of them." }
            ],
            guided: {
                problem: `How many inches are in 3 feet?`,
                steps: [
                    { label: "Conversion", value: "1 foot = 12 inches" },
                    { label: "Multiply", value: "3 × 12" },
                    { label: "Answer", value: "?" }
                ],
                answer: "36",
                answerLabel: "Inches:",
                interactiveSteps: [
                    {
                        prompt: "How many inches are in ONE foot?",
                        hint: "Think of a ruler - it's one foot long...",
                        answer: "12",
                        acceptableAnswers: ["12", "twelve", "12 inches"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "1": "1 foot = 12 inches, not 1 inch!",
                            "10": "Close, but 1 foot = 12 inches (not 10).",
                            "3": "We have 3 feet, but 1 foot = 12 inches."
                        }
                    },
                    {
                        prompt: "We have 3 feet. To find the total inches, do we add or multiply?",
                        hint: "3 feet means 3 groups of 12 inches...",
                        answer: "multiply",
                        acceptableAnswers: ["multiply", "multiplication", "×", "times"],
                        formatHint: "add or multiply",
                        commonMistakes: {
                            "add": "Adding gives 3 + 12 = 15. But we need 3 GROUPS of 12, so multiply!",
                            "divide": "Division would give us fewer. We want more inches, so multiply."
                        }
                    },
                    {
                        prompt: "Calculate: 3 × 12 = ?",
                        hint: "3 groups of 12...",
                        answer: "36",
                        acceptableAnswers: ["36", "36 inches"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "15": "You added 3 + 12. Multiply: 3 × 12 = 36",
                            "24": "That's 2 × 12. We need 3 × 12 = 36",
                            "312": "Don't combine digits! 3 × 12 = 36"
                        }
                    }
                ]
            },
            practice: { problem: `24 inches = how many feet?`, answer: "2", options: ["1", "2", "12", "36"],
                mistakeAnalysis: {
                    "1": "24 ÷ 12 = 2, not 1. Check your division.",
                    "12": "You need to DIVIDE 24 by 12, not just use 12 as the answer.",
                    "36": "That's going the wrong way! To get feet from inches, divide: 24 ÷ 12 = 2"
                }}
        }),
        Fractions: () => ({
            goalProblem: `What fraction of the pizza is shaded? ◐◐◐○ (3 of 4 pieces)`,
            teachingSteps: [
                {
                    title: "What is a fraction?",
                    explanation: "A <strong>fraction</strong> represents <strong>part of a whole</strong>. When something is divided into equal pieces, a fraction tells us how many pieces we have.",
                    visual: "Part ÷ Whole = Fraction"
                },
                {
                    title: "The two parts of a fraction",
                    explanation: "A fraction has two numbers: the <strong>numerator</strong> (top) and <strong>denominator</strong> (bottom), separated by a line.",
                    visual: "numerator / denominator"
                },
                {
                    title: "Denominator = total equal parts",
                    explanation: "The <strong>bottom number</strong> (denominator) tells us how many <strong>equal parts</strong> the whole is divided into.",
                    visual: "◐◐◐○ = 4 total pieces → denominator is 4"
                },
                {
                    title: "Numerator = parts we have",
                    explanation: "The <strong>top number</strong> (numerator) tells us how many parts we're talking about (the shaded ones).",
                    visual: "◐◐◐○ = 3 shaded → numerator is 3"
                },
                {
                    title: "Write the fraction",
                    explanation: "Numerator on top (3), denominator on bottom (4). The fraction is <strong>3/4</strong>, read as 'three fourths' or '3 out of 4'.",
                    visual: "3/4 (three-fourths)"
                }
            ],
            finalAnswer: "3/4",
            answerExplanation: "3 out of 4 pieces are shaded. Numerator (what we have) = 3, Denominator (total pieces) = 4. The fraction is 3/4!",
            example: { problem: `What fraction of the pizza is shaded? ◐◐◐○ (3 of 4 pieces shaded)`, steps: [
                { text: "Count the TOTAL pieces", math: "There are 4 pieces total → this is the denominator" },
                { text: "Count the SHADED pieces", math: "3 pieces are shaded → this is the numerator" },
                { text: "Write the fraction", math: "<strong>3/4</strong> (three-fourths)" }
            ]},
            keyPoints: [
                "Denominator (bottom) = total equal parts",
                "Numerator (top) = parts you're counting",
                "The line means 'out of' → 3/4 = '3 out of 4'"
            ],
            mistakes: [
                { wrong: "Writing the numbers upside down", why: "Parts you HAVE go on TOP. Total parts go on BOTTOM." },
                { wrong: "Thinking 2/4 is bigger than 3/4 because 2 comes before 3", why: "Compare numerators when denominators match: 3 > 2, so 3/4 > 2/4. More shaded parts = bigger fraction!" }
            ],
            guided: {
                problem: `A cake is cut into 8 equal slices. You eat 3. What fraction did you eat?`,
                steps: [
                    { label: "Total slices (denominator)", value: "8" },
                    { label: "Slices you ate (numerator)", value: "3" },
                    { label: "Fraction eaten", value: "?" }
                ],
                answer: "3/8",
                answerLabel: "Fraction:",
                interactiveSteps: [
                    {
                        prompt: "In a fraction, the BOTTOM number (denominator) tells us the TOTAL parts. How many slices is the cake cut into?",
                        hint: "Read the problem - how many equal slices?",
                        answer: "8",
                        acceptableAnswers: ["8", "eight"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "3": "3 is how many you ATE. The total slices = 8",
                            "5": "The cake has 8 slices total, not 5"
                        }
                    },
                    {
                        prompt: "The TOP number (numerator) is the part we're talking about. How many slices did you EAT?",
                        hint: "The problem says 'You eat...'",
                        answer: "3",
                        acceptableAnswers: ["3", "three"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "8 is the total. You only ATE 3 slices.",
                            "5": "You ate 3 slices, not 5"
                        }
                    },
                    {
                        prompt: "Write the fraction: numerator on top, denominator on bottom. What fraction did you eat?",
                        hint: "3 (what you ate) over 8 (total slices)",
                        answer: "3/8",
                        acceptableAnswers: ["3/8", "3 / 8", "three eighths"],
                        formatHint: "e.g., 3/8",
                        commonMistakes: {
                            "8/3": "The numerator (3) goes on TOP, denominator (8) goes on BOTTOM: 3/8",
                            "5/8": "You ate 3 slices, so 3 goes on top: 3/8"
                        }
                    }
                ]
            },
            practice: { problem: `Which is larger: 2/5 or 4/5?`, answer: "4/5", options: ["2/5", "4/5", "They're equal"],
                mistakeAnalysis: {
                    "2/5": "When denominators are the same, compare numerators. 4 > 2, so 4/5 > 2/5",
                    "They're equal": "2 parts is less than 4 parts (out of the same 5). 4/5 is larger."
                }}
        }),
        "Word Problems": () => ({
            goalProblem: `Sam has 12 apples. He gives 5 to his friend. How many are left?`,
            teachingSteps: [
                {
                    title: "What is a word problem?",
                    explanation: "A <strong>word problem</strong> is a math question written as a story. We need to figure out which operation to use (add, subtract, multiply, or divide).",
                    visual: "Story → Find operation → Solve"
                },
                {
                    title: "Look for clue words",
                    explanation: "Certain words tell us which operation to use. In our problem, the word '<strong>left</strong>' is a clue!",
                    visual: "left, remaining = SUBTRACT"
                },
                {
                    title: "Clue words cheat sheet",
                    explanation: "<strong>Add:</strong> total, altogether, combined, sum. <strong>Subtract:</strong> left, remaining, difference, fewer. <strong>Multiply:</strong> each, groups of, times. <strong>Divide:</strong> split, share equally.",
                    visual: "total=ADD | left=SUBTRACT | each=MULTIPLY | split=DIVIDE"
                },
                {
                    title: "Identify the numbers",
                    explanation: "Sam <strong>has 12</strong> apples. He <strong>gives away 5</strong>. These are our two numbers: 12 and 5.",
                    visual: "Started with: 12 | Gave away: 5"
                },
                {
                    title: "Solve it!",
                    explanation: "'Left' means subtract. We take away the 5 apples he gave away from the 12 he started with: 12 - 5 = <strong>7</strong>",
                    visual: "12 - 5 = 7 apples left"
                }
            ],
            finalAnswer: "7 apples",
            answerExplanation: "The word 'left' tells us to subtract. 12 - 5 = 7. Sam has 7 apples left!",
            example: { problem: `Sam has 12 apples. He gives 5 to his friend. How many are left?`, steps: [
                { text: "Find the key word", math: "'Left' means SUBTRACTION" },
                { text: "Identify the numbers", math: "Started with: 12, Gave away: 5" },
                { text: "Set up and solve", math: "12 - 5 = <strong>7 apples left</strong>" }
            ]},
            keyPoints: [
                "Read the whole problem first",
                "Look for clue words to find the operation",
                "Write the number sentence before solving"
            ],
            mistakes: [
                { wrong: "Using the wrong operation", why: "Look for clue words! 'Left' = subtract, 'Total' = add" },
                { wrong: "Not answering what was asked", why: "Re-read the question. What exactly are they asking for?" }
            ],
            guided: {
                problem: `There are 4 boxes with 6 crayons in each box. How many crayons total?`,
                steps: [
                    { label: "Clue words", value: "'each' and 'total' suggest multiplication" },
                    { label: "Set up", value: "4 groups of 6 = 4 × 6" },
                    { label: "Answer", value: "?" }
                ],
                answer: "24",
                answerLabel: "Total crayons:",
                interactiveSteps: [
                    {
                        prompt: "The problem says '4 boxes with 6 crayons in EACH box'. The word 'each' suggests which operation?",
                        hint: "Equal groups usually means...",
                        answer: "multiplication",
                        acceptableAnswers: ["multiplication", "multiply", "times", "×"],
                        formatHint: "e.g., multiplication",
                        commonMistakes: {
                            "addition": "'Each' means equal groups - that's multiplication, not addition!",
                            "subtraction": "We're finding a TOTAL of equal groups, so we multiply.",
                            "division": "Division splits things up. We're combining groups, so multiply."
                        }
                    },
                    {
                        prompt: "How many boxes are there?",
                        hint: "Read the first part of the problem...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "6": "6 is the crayons per box. The number of BOXES is 4."
                        }
                    },
                    {
                        prompt: "How many crayons are in EACH box?",
                        hint: "The problem says '6 crayons in each box'",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "4": "4 is the number of boxes. Each box has 6 crayons."
                        }
                    },
                    {
                        prompt: "Calculate: 4 boxes × 6 crayons = ?",
                        hint: "4 groups of 6...",
                        answer: "24",
                        acceptableAnswers: ["24", "24 crayons"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "10": "You added 4 + 6. Multiply: 4 × 6 = 24",
                            "46": "Don't combine digits! 4 × 6 = 24"
                        }
                    }
                ]
            },
            practice: { problem: `Emma has 15 stickers. She gets 8 more. How many does she have now?`, answer: "23", options: ["7", "23", "120", "87"],
                mistakeAnalysis: {
                    "7": "You subtracted! 'Gets more' means ADD: 15 + 8 = 23",
                    "120": "You multiplied! 'Gets more' means ADD: 15 + 8 = 23",
                    "87": "You put the digits together. Add them: 15 + 8 = 23"
                }}
        }),
        "Multi-Digit Addition": () => {
            const a = rand(234, 567), b = rand(345, 456);
            const sum = a + b;
            return {
                goalProblem: `What is 347 + 285?`,
                teachingSteps: [
                    {
                        title: "Why add column by column?",
                        explanation: "When numbers get big, we can't just 'see' the answer. We break it down by <strong>place value</strong>: ones, tens, hundreds.",
                        visual: "347 + 285 → break into columns"
                    },
                    {
                        title: "Line up the numbers",
                        explanation: "Write the numbers vertically, <strong>lining up the ones, tens, and hundreds</strong>. This keeps us organized!",
                        visual: "  347\n+ 285\n-----"
                    },
                    {
                        title: "Step 1: Add the ONES column",
                        explanation: "Start on the right! 7 + 5 = 12. That's more than 9, so we write <strong>2</strong> and <strong>carry the 1</strong> to the tens.",
                        visual: "7 + 5 = 12 → write 2, carry 1"
                    },
                    {
                        title: "Step 2: Add the TENS column (don't forget the carry!)",
                        explanation: "4 + 8 = 12, plus the carried 1 = <strong>13</strong>. Write 3, carry 1 to hundreds.",
                        visual: "4 + 8 + 1 = 13 → write 3, carry 1"
                    },
                    {
                        title: "Step 3: Add the HUNDREDS column",
                        explanation: "3 + 2 = 5, plus the carried 1 = <strong>6</strong>. No more columns, so we're done!",
                        visual: "3 + 2 + 1 = 6"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>347 + 285 = 632</strong>. Always work right to left, carrying when a column adds to 10 or more!",
                        visual: "347 + 285 = 632"
                    }
                ],
                finalAnswer: "632",
                answerExplanation: "Add column by column from right to left: ones (7+5=12, carry 1), tens (4+8+1=13, carry 1), hundreds (3+2+1=6). Answer: 632!",
                example: { problem: `What is 347 + 285?`, steps: [
                    { text: "Line up by place value", math: "  347\n+ 285\n-----" },
                    { text: "Add ones: 7 + 5 = 12", math: "Write 2, carry 1" },
                    { text: "Add tens: 4 + 8 + 1 = 13", math: "Write 3, carry 1" },
                    { text: "Add hundreds: 3 + 2 + 1 = 6", math: "Answer: <strong>632</strong>" }
                ]},
                keyPoints: [
                    "Always start from the RIGHT (ones place)",
                    "When a column adds to 10+, write the ones digit and CARRY the tens digit",
                    "Don't forget to add the carried number to the next column!"
                ],
                mistakes: [
                    { wrong: "Forgetting to carry", why: "If ones add to 12, you must carry the 1 to tens!" },
                    { wrong: "Adding left to right", why: "Always go RIGHT to LEFT so you can carry properly" },
                    { wrong: "Not lining up columns", why: "Ones must be under ones, tens under tens, etc." }
                ],
                guided: {
                    problem: `What is ${a} + ${b}?`,
                    steps: [
                        { label: "Add ones", value: `${a % 10} + ${b % 10} = ?` },
                        { label: "Add tens (+ carry)", value: `${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} + carry = ?` },
                        { label: "Add hundreds (+ carry)", value: `${Math.floor(a/100)} + ${Math.floor(b/100)} + carry = ?` }
                    ],
                    answer: String(sum),
                    answerLabel: `${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `Let's add ${a} + ${b}. Start with the ones column: ${a % 10} + ${b % 10} = ?`,
                            hint: "Add the rightmost digits...",
                            answer: String((a % 10) + (b % 10)),
                            acceptableAnswers: [String((a % 10) + (b % 10))],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a % 10)]: `Add both ones digits: ${a % 10} + ${b % 10} = ${(a % 10) + (b % 10)}`
                            }
                        },
                        {
                            prompt: `${(a % 10) + (b % 10)} in the ones column. ${(a % 10) + (b % 10) >= 10 ? `That's 10 or more! Write ${(a % 10 + b % 10) % 10} and carry ${Math.floor((a % 10 + b % 10) / 10)}. Now add tens: ${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} + ${Math.floor((a % 10 + b % 10) / 10)} = ?` : `Less than 10, no carry needed. Now add tens: ${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} = ?`}`,
                            hint: "Add the tens digits (and any carry)...",
                            answer: String((Math.floor(a/10) % 10) + (Math.floor(b/10) % 10) + Math.floor((a % 10 + b % 10) / 10)),
                            acceptableAnswers: [String((Math.floor(a/10) % 10) + (Math.floor(b/10) % 10) + Math.floor((a % 10 + b % 10) / 10))],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now put it all together. What is ${a} + ${b}?`,
                            hint: "Combine all your column answers...",
                            answer: String(sum),
                            acceptableAnswers: [String(sum)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a)]: `Don't forget to add! ${a} + ${b} = ${sum}`,
                                [String(sum + 10)]: "Check your carrying - you may have an extra 10"
                            }
                        }
                    ]
                },
                practice: (() => { const pa = rand(400, 550), pb = rand(350, 450); return {
                    problem: `What is ${pa} + ${pb}?`, answer: String(pa + pb),
                    options: shuffle([String(pa + pb), String(pa + pb + 10), String(pa + pb - 10), String(pa + pb + 100)]),
                    mistakeAnalysis: {
                        [String(pa + pb + 10)]: "Check your carrying in the tens column",
                        [String(pa + pb - 10)]: "Did you forget to carry?",
                        [String(pa + pb + 100)]: "Check your carrying in the hundreds column"
                    }}; })()
            };
        },
        "Multi-Digit Subtraction": () => {
            const a = rand(500, 800), b = rand(200, 400);
            const diff = a - b;
            return {
                goalProblem: `What is 532 - 278?`,
                teachingSteps: [
                    {
                        title: "Subtraction with borrowing",
                        explanation: "When subtracting big numbers, sometimes the top digit is <strong>smaller</strong> than the bottom. That's when we <strong>borrow</strong>!",
                        visual: "532 - 278 = ?"
                    },
                    {
                        title: "Line up and start at the right",
                        explanation: "Write vertically, line up place values. Start with the ones: 2 - 8. Uh oh! 2 is less than 8!",
                        visual: "  532\n- 278\n-----\nOnes: 2 - 8 = ??"
                    },
                    {
                        title: "Step 1: Borrow from the tens",
                        explanation: "We need to <strong>borrow 1 ten</strong> from the 3 (making it 2). That 1 ten = 10 ones, so 2 becomes 12. Now: 12 - 8 = <strong>4</strong>",
                        visual: "Borrow: 3→2, ones: 2→12. Now 12 - 8 = 4"
                    },
                    {
                        title: "Step 2: Subtract the tens",
                        explanation: "Tens column: 2 - 7 (remember we borrowed!). 2 < 7, so borrow from hundreds: 5→4, and 2→12. Now: 12 - 7 = <strong>5</strong>",
                        visual: "Borrow: 5→4, tens: 2→12. Now 12 - 7 = 5"
                    },
                    {
                        title: "Step 3: Subtract the hundreds",
                        explanation: "Hundreds: 4 - 2 = <strong>2</strong>. No more borrowing needed!",
                        visual: "4 - 2 = 2"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>532 - 278 = 254</strong>. Borrowing makes the top number bigger so we can subtract!",
                        visual: "532 - 278 = 254"
                    }
                ],
                finalAnswer: "254",
                answerExplanation: "Borrow when needed: ones (12-8=4), tens (12-7=5), hundreds (4-2=2). Answer: 254!",
                example: { problem: `What is 532 - 278?`, steps: [
                    { text: "Ones: 2 - 8? Can't! Borrow from tens", math: "3→2, 2→12. Now 12 - 8 = 4" },
                    { text: "Tens: 2 - 7? Can't! Borrow from hundreds", math: "5→4, 2→12. Now 12 - 7 = 5" },
                    { text: "Hundreds: 4 - 2 = 2", math: "Answer: <strong>254</strong>" }
                ]},
                keyPoints: [
                    "If top < bottom, BORROW from the next column left",
                    "Borrowing: take 1 from the left column, add 10 to current column",
                    "Always subtract: TOP minus BOTTOM"
                ],
                mistakes: [
                    { wrong: "Flipping digits when bottom is bigger (doing 8 - 2 instead of 2 - 8)", why: "Always subtract TOP - BOTTOM! If top is smaller, borrow first." },
                    { wrong: "Forgetting you borrowed", why: "After borrowing, the digit you borrowed FROM is 1 less!" },
                    { wrong: "Borrowing when you don't need to", why: "Only borrow if top digit < bottom digit" }
                ],
                guided: {
                    problem: `What is ${a} - ${b}?`,
                    steps: [
                        { label: "Subtract ones (borrow if needed)", value: `${a % 10} - ${b % 10} = ?` },
                        { label: "Subtract tens (borrow if needed)", value: `? - ${Math.floor(b/10) % 10} = ?` },
                        { label: "Subtract hundreds", value: "?" }
                    ],
                    answer: String(diff),
                    answerLabel: `${a} - ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `Let's subtract ${a} - ${b}. Look at the ones: ${a % 10} - ${b % 10}. ${a % 10 < b % 10 ? "Can we do this, or do we need to borrow?" : "Can we do this without borrowing?"}`,
                            hint: a % 10 < b % 10 ? `${a % 10} is less than ${b % 10}, so we need to...` : "Compare the digits...",
                            answer: a % 10 < b % 10 ? "borrow" : "yes",
                            acceptableAnswers: a % 10 < b % 10 ? ["borrow", "no", "need to borrow", "can't"] : ["yes", "no borrowing", "don't need to borrow"],
                            formatHint: "borrow or yes",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Work through the subtraction. What is ${a} - ${b}?`,
                            hint: "Subtract column by column, borrowing when needed...",
                            answer: String(diff),
                            acceptableAnswers: [String(diff)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(diff + 10)]: "Check your borrowing - you may have missed one",
                                [String(diff - 10)]: "Check if you borrowed when you didn't need to"
                            }
                        }
                    ]
                },
                practice: (() => { const pa = rand(600, 900), pb = rand(250, 450); return {
                    problem: `What is ${pa} - ${pb}?`, answer: String(pa - pb),
                    options: shuffle([String(pa - pb), String(pa - pb + 10), String(pa - pb - 10), String(pb - pa + 1000)]),
                    mistakeAnalysis: {
                        [String(pa - pb + 10)]: "Check your borrowing - did you forget to reduce a digit?",
                        [String(pa - pb - 10)]: "Check your borrowing - did you borrow when you didn't need to?"
                    }}; })()
            };
        },
        "Long Division": () => {
            const divisor = rand(3, 7);
            const quotient = rand(12, 25);
            const dividend = divisor * quotient;
            return {
                goalProblem: `What is 84 ÷ 4?`,
                teachingSteps: [
                    {
                        title: "What is long division?",
                        explanation: "<strong>Long division</strong> is a step-by-step method for dividing larger numbers. We work digit by digit from left to right.",
                        visual: "84 ÷ 4 = ? (using long division)"
                    },
                    {
                        title: "Set up the problem",
                        explanation: "Write it in the 'house' format: divisor outside, dividend inside. We'll find the quotient on top.",
                        visual: "    ?\n  -----\n4 | 84"
                    },
                    {
                        title: "Step 1: Divide the first digit",
                        explanation: "How many times does 4 go into 8? <strong>4 × 2 = 8</strong>, so write 2 above the 8.",
                        visual: "    2\n  -----\n4 | 84\n   -8\n    0"
                    },
                    {
                        title: "Step 2: Multiply and subtract",
                        explanation: "2 × 4 = 8. Write 8 under the 8 and subtract: 8 - 8 = 0. Bring down the next digit (4).",
                        visual: "    2\n  -----\n4 | 84\n   -8↓\n    04"
                    },
                    {
                        title: "Step 3: Divide again",
                        explanation: "How many times does 4 go into 4? <strong>4 × 1 = 4</strong>, so write 1 above the 4.",
                        visual: "    21\n  -----\n4 | 84\n   -8\n    04\n    -4\n     0"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>84 ÷ 4 = 21</strong>. The remainder is 0, so it divides evenly!",
                        visual: "84 ÷ 4 = 21"
                    }
                ],
                finalAnswer: "21",
                answerExplanation: "Using long division: 4 into 8 = 2, 4 into 4 = 1. Answer: 21!",
                example: { problem: `What is 84 ÷ 4?`, steps: [
                    { text: "Set up: 4 | 84", math: "Divide 4 into 8: 8 ÷ 4 = 2" },
                    { text: "Multiply and subtract", math: "2 × 4 = 8, then 8 - 8 = 0" },
                    { text: "Bring down 4, divide again", math: "4 ÷ 4 = 1" },
                    { text: "Final answer", math: "<strong>84 ÷ 4 = 21</strong>" }
                ]},
                keyPoints: [
                    "Divide → Multiply → Subtract → Bring down → Repeat",
                    "Work from LEFT to RIGHT",
                    "Check: quotient × divisor should equal dividend"
                ],
                mistakes: [
                    { wrong: "Dividing right to left", why: "Long division goes LEFT to RIGHT!" },
                    { wrong: "Forgetting to bring down", why: "After subtracting, always bring down the next digit" },
                    { wrong: "Wrong multiplication", why: "Double-check: quotient digit × divisor" }
                ],
                guided: {
                    problem: `What is ${dividend} ÷ ${divisor}?`,
                    steps: [
                        { label: `${divisor} into ${Math.floor(dividend/10)}`, value: `${Math.floor(dividend/10)} ÷ ${divisor} = ${Math.floor(Math.floor(dividend/10)/divisor)}` },
                        { label: "Bring down, divide again", value: "?" },
                        { label: "Final quotient", value: "?" }
                    ],
                    answer: String(quotient),
                    answerLabel: `${dividend} ÷ ${divisor} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `Let's divide ${dividend} ÷ ${divisor}. First, how many times does ${divisor} go into ${Math.floor(dividend/10)}?`,
                            hint: `Think: ${divisor} × ? ≤ ${Math.floor(dividend/10)}`,
                            answer: String(Math.floor(Math.floor(dividend/10)/divisor)),
                            acceptableAnswers: [String(Math.floor(Math.floor(dividend/10)/divisor))],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Good! Now complete the division. What is ${dividend} ÷ ${divisor}?`,
                            hint: "Continue the long division process...",
                            answer: String(quotient),
                            acceptableAnswers: [String(quotient)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(divisor)]: `That's the divisor. The quotient (answer) is ${quotient}`,
                                [String(dividend)]: `That's the dividend. We're dividing to get ${quotient}`
                            }
                        },
                        {
                            prompt: `Let's check: ${quotient} × ${divisor} = ?`,
                            hint: "Multiply to verify...",
                            answer: String(dividend),
                            acceptableAnswers: [String(dividend)],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pd = divisor * rand(15, 30); return {
                    problem: `What is ${pd} ÷ ${divisor}?`, answer: String(pd / divisor),
                    options: shuffle([String(pd / divisor), String(pd / divisor + 1), String(pd / divisor - 1), String(divisor)]),
                    mistakeAnalysis: {
                        [String(pd / divisor + 1)]: `Check: ${pd / divisor + 1} × ${divisor} = ${(pd / divisor + 1) * divisor}, not ${pd}`,
                        [String(pd / divisor - 1)]: `Check: ${pd / divisor - 1} × ${divisor} = ${(pd / divisor - 1) * divisor}, not ${pd}`,
                        [String(divisor)]: "That's the divisor, not the quotient!"
                    }}; })()
            };
        },
        "Equivalent Fractions": () => {
            const n = rand(1, 3), d = rand(n + 1, 5);
            const mult = rand(2, 4);
            return {
                goalProblem: `Find a fraction equivalent to 2/3`,
                teachingSteps: [
                    {
                        title: "What are equivalent fractions?",
                        explanation: "<strong>Equivalent fractions</strong> are different fractions that represent the <strong>same amount</strong>. Like 1/2 and 2/4 - they're both 'half'!",
                        visual: "1/2 = 2/4 = 3/6 (all equal half)"
                    },
                    {
                        title: "The golden rule",
                        explanation: "To make an equivalent fraction, <strong>multiply (or divide) BOTH the top AND bottom by the same number</strong>.",
                        visual: "× same number on top AND bottom"
                    },
                    {
                        title: "Let's find a fraction equal to 2/3",
                        explanation: "We'll multiply both parts by 2. This is like cutting each piece in half - more pieces, but same total amount!",
                        visual: "2/3 → multiply both by 2"
                    },
                    {
                        title: "Multiply the numerator",
                        explanation: "Top (numerator): 2 × 2 = <strong>4</strong>",
                        visual: "2 × 2 = 4 (new numerator)"
                    },
                    {
                        title: "Multiply the denominator",
                        explanation: "Bottom (denominator): 3 × 2 = <strong>6</strong>",
                        visual: "3 × 2 = 6 (new denominator)"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>2/3 = 4/6</strong>. They're the same amount! You can also multiply by 3 to get 6/9, or by 4 to get 8/12.",
                        visual: "2/3 = 4/6 ✓"
                    }
                ],
                finalAnswer: "4/6",
                answerExplanation: "Multiply both numerator and denominator by 2: (2×2)/(3×2) = 4/6. The fractions are equivalent!",
                example: { problem: `Find a fraction equivalent to 2/3`, steps: [
                    { text: "Choose a multiplier (let's use 2)", math: "Multiply BOTH parts by 2" },
                    { text: "Multiply numerator", math: "2 × 2 = 4" },
                    { text: "Multiply denominator", math: "3 × 2 = 6" },
                    { text: "Equivalent fraction", math: "2/3 = <strong>4/6</strong>" }
                ]},
                keyPoints: [
                    "Multiply BOTH top and bottom by the SAME number",
                    "This doesn't change the VALUE, just how it looks",
                    "You can also DIVIDE both by the same number to simplify"
                ],
                mistakes: [
                    { wrong: "Only multiplying the top", why: "Must multiply BOTH! 2×2/3 = 4/3 is NOT equal to 2/3" },
                    { wrong: "Adding instead of multiplying", why: "(2+2)/(3+2) = 4/5 ≠ 2/3. You must MULTIPLY!" },
                    { wrong: "Multiplying by different numbers", why: "Both parts must be multiplied by the SAME number" }
                ],
                guided: {
                    problem: `Find a fraction equivalent to ${n}/${d} (multiply by ${mult})`,
                    steps: [
                        { label: `Multiply numerator: ${n} × ${mult}`, value: `${n * mult}` },
                        { label: `Multiply denominator: ${d} × ${mult}`, value: `${d * mult}` },
                        { label: "New equivalent fraction", value: "?" }
                    ],
                    answer: `${n * mult}/${d * mult}`,
                    answerLabel: "Equivalent fraction:",
                    interactiveSteps: [
                        {
                            prompt: `To find an equivalent fraction, we multiply BOTH parts by the same number. What is ${n} × ${mult} (the new numerator)?`,
                            hint: `Multiply the top: ${n} × ${mult} = ?`,
                            answer: String(n * mult),
                            acceptableAnswers: [String(n * mult)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(n + mult)]: `You added! Multiply: ${n} × ${mult} = ${n * mult}`,
                                [String(n)]: `Don't forget to multiply! ${n} × ${mult} = ${n * mult}`
                            }
                        },
                        {
                            prompt: `Now multiply the denominator: ${d} × ${mult} = ?`,
                            hint: `Multiply the bottom by the same number...`,
                            answer: String(d * mult),
                            acceptableAnswers: [String(d * mult)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(d + mult)]: `You added! Multiply: ${d} × ${mult} = ${d * mult}`,
                                [String(d)]: `Multiply the bottom too! ${d} × ${mult} = ${d * mult}`
                            }
                        },
                        {
                            prompt: `So ${n}/${d} is equivalent to what fraction?`,
                            hint: `Put your new numerator over your new denominator...`,
                            answer: `${n * mult}/${d * mult}`,
                            acceptableAnswers: [`${n * mult}/${d * mult}`, `${n*mult}/${d*mult}`],
                            formatHint: "e.g., 4/6",
                            commonMistakes: {
                                [`${n}/${d * mult}`]: `You only multiplied the bottom! The numerator should be ${n * mult}`,
                                [`${n * mult}/${d}`]: `You only multiplied the top! The denominator should be ${d * mult}`
                            }
                        }
                    ]
                },
                practice: { problem: `Which fraction is equivalent to 3/4?`, answer: "6/8",
                    options: ["6/8", "6/4", "3/8", "4/6"],
                    mistakeAnalysis: {
                        "6/4": "You only multiplied the top! 3/4 × 2/2 = 6/8",
                        "3/8": "You only multiplied the bottom! 3/4 × 2/2 = 6/8",
                        "4/6": "That's not equivalent. 3/4 × 2/2 = 6/8"
                    }}
            };
        },
        "Mixed Numbers": () => {
            const whole = rand(1, 4), n = rand(1, 3), d = rand(n + 1, 5);
            const improper = whole * d + n;
            return {
                goalProblem: `Convert 2 3/4 to an improper fraction`,
                teachingSteps: [
                    {
                        title: "Mixed numbers vs. improper fractions",
                        explanation: "A <strong>mixed number</strong> has a whole part and a fraction part (like 2 3/4). An <strong>improper fraction</strong> has a numerator bigger than the denominator (like 11/4).",
                        visual: "2 3/4 (mixed) = 11/4 (improper)"
                    },
                    {
                        title: "Converting mixed → improper",
                        explanation: "To convert, we need to figure out <strong>how many pieces total</strong>. Think: the whole parts become pieces too!",
                        visual: "2 wholes + 3/4 = how many fourths total?"
                    },
                    {
                        title: "Step 1: Multiply whole × denominator",
                        explanation: "Each whole has 4 fourths. We have 2 wholes: 2 × 4 = <strong>8 fourths</strong> from the whole part.",
                        visual: "2 × 4 = 8 fourths"
                    },
                    {
                        title: "Step 2: Add the numerator",
                        explanation: "We also have 3 more fourths from the fraction part. Total: 8 + 3 = <strong>11 fourths</strong>.",
                        visual: "8 + 3 = 11 fourths"
                    },
                    {
                        title: "Step 3: Keep the same denominator",
                        explanation: "The denominator stays the same (4). We're still counting fourths!",
                        visual: "11 fourths = 11/4"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>2 3/4 = 11/4</strong>. Formula: (whole × denominator + numerator) / denominator",
                        visual: "2 3/4 = 11/4"
                    }
                ],
                finalAnswer: "11/4",
                answerExplanation: "(2 × 4) + 3 = 11, denominator stays 4. So 2 3/4 = 11/4!",
                example: { problem: `Convert 2 3/4 to an improper fraction`, steps: [
                    { text: "Multiply whole × denominator", math: "2 × 4 = 8" },
                    { text: "Add the numerator", math: "8 + 3 = 11" },
                    { text: "Keep the denominator", math: "11/4" },
                    { text: "Final answer", math: "2 3/4 = <strong>11/4</strong>" }
                ]},
                keyPoints: [
                    "Formula: (whole × denominator + numerator) / denominator",
                    "The denominator NEVER changes",
                    "To go the other way: divide numerator by denominator"
                ],
                mistakes: [
                    { wrong: "Forgetting to add the numerator", why: "Don't forget the extra pieces! 2 × 4 = 8, then 8 + 3 = 11" },
                    { wrong: "Changing the denominator", why: "The denominator stays the same - we're counting the same size pieces" },
                    { wrong: "Adding instead of multiplying first", why: "Multiply first (whole × denominator), THEN add the numerator" }
                ],
                guided: {
                    problem: `Convert ${whole} ${n}/${d} to an improper fraction`,
                    steps: [
                        { label: `Multiply whole × denominator: ${whole} × ${d}`, value: `${whole * d}` },
                        { label: `Add numerator: ${whole * d} + ${n}`, value: `${improper}` },
                        { label: `Keep denominator: ?/${d}`, value: "?" }
                    ],
                    answer: `${improper}/${d}`,
                    answerLabel: "Improper fraction:",
                    interactiveSteps: [
                        {
                            prompt: `First, multiply the whole number by the denominator: ${whole} × ${d} = ?`,
                            hint: "This tells us how many pieces are in the whole parts...",
                            answer: String(whole * d),
                            acceptableAnswers: [String(whole * d)],
                            commonMistakes: {
                                [String(whole + d)]: `You added! Multiply: ${whole} × ${d} = ${whole * d}`
                            }
                        },
                        {
                            prompt: `Now add the numerator: ${whole * d} + ${n} = ?`,
                            hint: "Add the extra pieces from the fraction part...",
                            answer: String(improper),
                            acceptableAnswers: [String(improper)],
                            commonMistakes: {
                                [String(whole * d)]: `Don't forget to add ${n}! ${whole * d} + ${n} = ${improper}`
                            }
                        },
                        {
                            prompt: `The denominator stays ${d}. What is ${whole} ${n}/${d} as an improper fraction?`,
                            hint: "Put your total over the original denominator...",
                            answer: `${improper}/${d}`,
                            acceptableAnswers: [`${improper}/${d}`, `${improper} / ${d}`],
                            commonMistakes: {
                                [`${improper}/${improper}`]: `The denominator stays the same! It should be ${d}`,
                                [`${n}/${d}`]: `That's just the fraction part. The full answer is ${improper}/${d}`
                            }
                        }
                    ]
                },
                practice: { problem: `Convert 3 1/2 to an improper fraction`, answer: "7/2",
                    options: ["7/2", "4/2", "6/2", "3/2"],
                    mistakeAnalysis: {
                        "4/2": "You forgot to add the numerator! (3 × 2) + 1 = 7",
                        "6/2": "That's just 3 × 2. Don't forget to add the 1!",
                        "3/2": "That's less than the original! (3 × 2) + 1 = 7, so it's 7/2"
                    }}
            };
        },
        Estimation: () => {
            const a = rand(28, 77), b = rand(23, 68);
            const roundA = Math.round(a / 10) * 10, roundB = Math.round(b / 10) * 10;
            const estimate = roundA + roundB;
            return {
                goalProblem: `Estimate 47 + 32 by rounding to the nearest ten`,
                teachingSteps: [
                    {
                        title: "What is estimation?",
                        explanation: "<strong>Estimation</strong> means finding an <strong>approximate answer</strong> quickly. It's useful for checking work or making quick decisions!",
                        visual: "47 + 32 ≈ ? (close to what?)"
                    },
                    {
                        title: "Why round to estimate?",
                        explanation: "Numbers ending in 0 are easy to add mentally! Rounding gives us 'friendly numbers' to work with.",
                        visual: "47 → 50, 32 → 30 (easier!)"
                    },
                    {
                        title: "Step 1: Round the first number",
                        explanation: "Round 47 to the nearest ten. The ones digit is 7 (5 or more → round UP). <strong>47 → 50</strong>",
                        visual: "47 → 50"
                    },
                    {
                        title: "Step 2: Round the second number",
                        explanation: "Round 32 to the nearest ten. The ones digit is 2 (less than 5 → round DOWN). <strong>32 → 30</strong>",
                        visual: "32 → 30"
                    },
                    {
                        title: "Step 3: Add the rounded numbers",
                        explanation: "Now add the friendly numbers: 50 + 30 = <strong>80</strong>. That's our estimate!",
                        visual: "50 + 30 = 80"
                    },
                    {
                        title: "Check: Is our estimate close?",
                        explanation: "Actual answer: 47 + 32 = 79. Our estimate of 80 is very close! Estimation works!",
                        visual: "Estimate: 80 | Actual: 79 ✓"
                    }
                ],
                finalAnswer: "80",
                answerExplanation: "Round 47 → 50, round 32 → 30. Then 50 + 30 = 80. The actual answer (79) is very close!",
                example: { problem: `Estimate 47 + 32 by rounding to the nearest ten`, steps: [
                    { text: "Round first number", math: "47 → 50 (7 ≥ 5, round up)" },
                    { text: "Round second number", math: "32 → 30 (2 < 5, round down)" },
                    { text: "Add rounded numbers", math: "50 + 30 = <strong>80</strong>" },
                    { text: "Verify", math: "Actual: 47 + 32 = 79 (close to 80!)" }
                ]},
                keyPoints: [
                    "Round each number first, then calculate",
                    "Estimates are APPROXIMATE - they won't be exact",
                    "Use estimation to check if your exact answer makes sense"
                ],
                mistakes: [
                    { wrong: "Rounding and then forgetting to add", why: "After rounding, you still need to do the operation!" },
                    { wrong: "Rounding incorrectly", why: "Remember: 5+ rounds UP, 4 or less rounds DOWN" },
                    { wrong: "Expecting an exact answer", why: "Estimates are approximate! Close is good enough." }
                ],
                guided: {
                    problem: `Estimate ${a} + ${b} by rounding to the nearest ten`,
                    steps: [
                        { label: `Round ${a}`, value: `${roundA}` },
                        { label: `Round ${b}`, value: `${roundB}` },
                        { label: "Add rounded numbers", value: "?" }
                    ],
                    answer: String(estimate),
                    answerLabel: "Estimate:",
                    interactiveSteps: [
                        {
                            prompt: `Round ${a} to the nearest ten. The ones digit is ${a % 10}. Does it round up or down?`,
                            hint: `${a % 10} is ${a % 10 >= 5 ? "5 or more, so..." : "less than 5, so..."}`,
                            answer: a % 10 >= 5 ? "up" : "down",
                            acceptableAnswers: a % 10 >= 5 ? ["up", "round up"] : ["down", "round down"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `So ${a} rounds to what?`,
                            hint: `Round ${a % 10 >= 5 ? "up" : "down"} to the nearest ten...`,
                            answer: String(roundA),
                            acceptableAnswers: [String(roundA)],
                            commonMistakes: {
                                [String(a)]: `That's the original number! Round to the nearest ten: ${roundA}`
                            }
                        },
                        {
                            prompt: `Round ${b} to the nearest ten.`,
                            hint: `The ones digit is ${b % 10}...`,
                            answer: String(roundB),
                            acceptableAnswers: [String(roundB)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now add your rounded numbers: ${roundA} + ${roundB} = ?`,
                            hint: "Add the friendly numbers...",
                            answer: String(estimate),
                            acceptableAnswers: [String(estimate)],
                            commonMistakes: {
                                [String(a + b)]: `That's the exact answer! We want the estimate: ${roundA} + ${roundB} = ${estimate}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = rand(35, 65), pb = rand(25, 55); const pra = Math.round(pa/10)*10, prb = Math.round(pb/10)*10; return {
                    problem: `Estimate ${pa} + ${pb}`, answer: String(pra + prb),
                    options: shuffle([String(pra + prb), String(pa + pb), String(pra + prb + 10), String(pra + prb - 10)]),
                    mistakeAnalysis: {
                        [String(pa + pb)]: "That's the exact answer! For estimation, round first, then add.",
                        [String(pra + prb + 10)]: "Check your rounding - one number may have rounded wrong.",
                        [String(pra + prb - 10)]: "Check your rounding - one number may have rounded wrong."
                    }}; })()
            };
        },
        Perimeter: () => {
            const length = rand(6, 12), width = rand(4, 8);
            const perimeter = 2 * (length + width);
            return {
                goalProblem: `Find the perimeter of a rectangle with length 8 and width 5`,
                teachingSteps: [
                    {
                        title: "What is perimeter?",
                        explanation: "<strong>Perimeter</strong> is the <strong>distance around</strong> ANY shape - like walking along all the edges. Whether it's a rectangle, triangle, hexagon, or any other shape, you just add up all the sides!",
                        visual: "Perimeter = total distance around (works for ALL shapes!)"
                    },
                    {
                        title: "The Basic Rule",
                        explanation: "For <strong>ANY shape</strong>, perimeter = <strong>add all the sides together</strong>. That's it! This works for triangles, rectangles, pentagons - everything!",
                        visual: "Triangle: a + b + c | Rectangle: L + W + L + W | Pentagon: add all 5 sides"
                    },
                    {
                        title: "Triangle Example",
                        explanation: "A triangle has 3 sides. If the sides are 3, 4, and 5:<br>Perimeter = 3 + 4 + 5 = <strong>12</strong>",
                        visual: "Triangle: 3 + 4 + 5 = 12"
                    },
                    {
                        title: "Square Shortcut",
                        explanation: "A square has 4 <strong>equal</strong> sides. Instead of adding 4 times, multiply!<br>Side = 6: P = 6 + 6 + 6 + 6 = 4 × 6 = <strong>24</strong>",
                        visual: "Square: P = 4 × side"
                    },
                    {
                        title: "Rectangle: Method 1 (Add all sides)",
                        explanation: "A rectangle has 2 lengths and 2 widths. For length 8, width 5:<br>Add: 8 + 5 + 8 + 5 = <strong>26</strong>",
                        visual: "8 + 5 + 8 + 5 = 26"
                    },
                    {
                        title: "Rectangle: Method 2 (Formula shortcut)",
                        explanation: "Since opposite sides are equal, use: P = 2 × (length + width)<br>P = 2 × (8 + 5) = 2 × 13 = <strong>26</strong>",
                        visual: "P = 2 × (L + W) = 2 × 13 = 26"
                    },
                    {
                        title: "The answer!",
                        explanation: "The perimeter is <strong>26 units</strong>. Don't forget the units (cm, ft, m, etc.) if given!",
                        visual: "Perimeter = 26 units"
                    }
                ],
                finalAnswer: "26 units",
                answerExplanation: "Perimeter = 2 × (length + width) = 2 × (8 + 5) = 2 × 13 = 26 units!",
                example: { problem: `Find the perimeter of a rectangle with length 8 and width 5`, steps: [
                    { text: "Identify the sides", math: "Length = 8, Width = 5" },
                    { text: "Use the formula", math: "P = 2 × (L + W)" },
                    { text: "Substitute and calculate", math: "P = 2 × (8 + 5) = 2 × 13 = <strong>26</strong>" }
                ]},
                keyPoints: [
                    "Perimeter = distance AROUND any shape (add all sides!)",
                    "Universal rule: add all the sides together (works for ANY shape)",
                    "Triangle: P = side₁ + side₂ + side₃ (add all 3 sides)",
                    "Square shortcut: P = 4 × side (all sides equal)",
                    "Rectangle shortcut: P = 2 × (length + width)"
                ],
                mistakes: [
                    { wrong: "Multiplying length × width", why: "That's AREA! Perimeter is adding the sides together." },
                    { wrong: "Only adding two sides", why: "Count ALL sides - rectangles have 4, triangles have 3!" },
                    { wrong: "Forgetting to multiply by 2 for rectangles", why: "Two lengths AND two widths: 2 × (L + W)" }
                ],
                guided: {
                    problem: `Find the perimeter of a rectangle with length ${length} and width ${width}`,
                    steps: [
                        { label: `Add length + width: ${length} + ${width}`, value: `${length + width}` },
                        { label: "Multiply by 2 (for all 4 sides)", value: "?" },
                        { label: "Perimeter", value: "?" }
                    ],
                    answer: String(perimeter),
                    answerLabel: "Perimeter:",
                    interactiveSteps: [
                        {
                            prompt: `First, add the length and width: ${length} + ${width} = ?`,
                            hint: "Add one length and one width... (enter just the number)",
                            answer: String(length + width),
                            acceptableAnswers: [String(length + width)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(length * width)]: `You multiplied! Add: ${length} + ${width} = ${length + width}`
                            }
                        },
                        {
                            prompt: `Now multiply by 2 (because there are 2 lengths and 2 widths): 2 × ${length + width} = ?`,
                            hint: "Double your sum to account for all 4 sides... (enter just the number)",
                            answer: String(perimeter),
                            acceptableAnswers: [String(perimeter)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(length + width)]: `You need to multiply by 2! 2 × ${length + width} = ${perimeter}`
                            }
                        },
                        {
                            prompt: `What is the final perimeter? (enter a number, with or without "units")`,
                            hint: "What's the total distance around?",
                            answer: String(perimeter),
                            acceptableAnswers: [String(perimeter), `${perimeter} units`, `${perimeter}units`],
                            formatHint: "e.g., 26 or 26 units",
                            commonMistakes: {
                                [String(length * width)]: `That's the area! Perimeter = 2 × (${length} + ${width}) = ${perimeter}`
                            }
                        }
                    ]
                },
                practice: (() => { const pl = rand(7, 15), pw = rand(4, 10); return {
                    problem: `Find the perimeter of a rectangle: length = ${pl}, width = ${pw}`, answer: String(2 * (pl + pw)),
                    options: shuffle([String(2 * (pl + pw)), String(pl * pw), String(pl + pw), String(4 * pl)]),
                    mistakeAnalysis: {
                        [String(pl * pw)]: "You found the area! Perimeter = 2 × (L + W), not L × W",
                        [String(pl + pw)]: "You only counted two sides! Multiply by 2 for all 4 sides.",
                        [String(4 * pl)]: "That would be a square! Use 2 × (L + W) for rectangles."
                    }}; })()
            };
        },
        "Arrays and Area Models": () => {
            const rows = rand(3, 5), cols = rand(4, 7);
            const product = rows * cols;
            return {
                goalProblem: `Use an array to find 4 × 6`,
                teachingSteps: [
                    {
                        title: "What is an array?",
                        explanation: "An <strong>array</strong> is a way to arrange objects in equal <strong>rows</strong> and <strong>columns</strong>. It helps us visualize multiplication!",
                        visual: "●●●●●●\n●●●●●●\n●●●●●●\n●●●●●● (4 rows, 6 columns)"
                    },
                    {
                        title: "Rows × Columns = Total",
                        explanation: "An array shows <strong>rows × columns</strong>. Our array has 4 rows of 6, so we're finding 4 × 6.",
                        visual: "4 rows × 6 in each row"
                    },
                    {
                        title: "Count the total",
                        explanation: "We can count all the dots: 6 + 6 + 6 + 6 = 24. Or multiply: 4 × 6 = <strong>24</strong>!",
                        visual: "6 + 6 + 6 + 6 = 24"
                    },
                    {
                        title: "The area model",
                        explanation: "An <strong>area model</strong> is like an array, but drawn as a rectangle. Length × Width = Area, just like rows × columns!",
                        visual: "[Rectangle: 4 tall, 6 wide] Area = 4 × 6"
                    },
                    {
                        title: "Breaking apart with area models",
                        explanation: "We can split numbers to make multiplication easier: 4 × 6 = 4 × (5 + 1) = (4 × 5) + (4 × 1) = 20 + 4 = 24",
                        visual: "4 × 5 = 20, 4 × 1 = 4, Total = 24"
                    },
                    {
                        title: "Arrays and area models show the same thing!",
                        explanation: "<strong>4 × 6 = 24</strong>. Arrays and area models both help us see WHY multiplication works!",
                        visual: "4 × 6 = 24"
                    }
                ],
                finalAnswer: "24",
                answerExplanation: "4 rows × 6 columns = 24 total. Arrays help us visualize multiplication!",
                example: { problem: `Use an array to find 4 × 6`, steps: [
                    { text: "Draw the array", math: "4 rows of 6 dots each" },
                    { text: "Count or multiply", math: "4 × 6 = 24" },
                    { text: "Or break apart", math: "4 × 6 = 4×5 + 4×1 = 20 + 4 = <strong>24</strong>" }
                ]},
                keyPoints: [
                    "Array: rows × columns = total",
                    "Area model: length × width = area",
                    "Breaking apart makes big multiplications easier"
                ],
                mistakes: [
                    { wrong: "Confusing rows and columns", why: "Rows go across (horizontal) like rows of seats. Columns go up/down (vertical) like columns on a building. But 4×6 = 6×4!" },
                    { wrong: "Adding instead of multiplying", why: "4 rows of 6 means 4 × 6, not 4 + 6" },
                    { wrong: "Miscounting the array", why: "Multiply: rows × columns. Don't count one by one!" }
                ],
                guided: {
                    problem: `An array has ${rows} rows and ${cols} columns. How many total?`,
                    steps: [
                        { label: "Number of rows", value: `${rows}` },
                        { label: "Number of columns", value: `${cols}` },
                        { label: "Total (rows × columns)", value: "?" }
                    ],
                    answer: String(product),
                    answerLabel: "Total:",
                    interactiveSteps: [
                        {
                            prompt: `The array has ${rows} rows. Each row has ${cols} items. What operation do we use to find the total?`,
                            hint: "Equal groups means...",
                            answer: "multiplication",
                            acceptableAnswers: ["multiplication", "multiply", "times", "×"],
                            commonMistakes: {
                                "addition": "We could add ${rows} groups of ${cols}, but multiplication is faster!",
                                "division": "Division splits things up. We're combining equal groups."
                            }
                        },
                        {
                            prompt: `Calculate: ${rows} × ${cols} = ?`,
                            hint: `${rows} groups of ${cols}...`,
                            answer: String(product),
                            acceptableAnswers: [String(product)],
                            commonMistakes: {
                                [String(rows + cols)]: `You added! Multiply: ${rows} × ${cols} = ${product}`,
                                [String(rows)]: `That's just the rows. Multiply: ${rows} × ${cols} = ${product}`
                            }
                        },
                        {
                            prompt: `So an array with ${rows} rows and ${cols} columns has how many total items?`,
                            hint: "What was your multiplication result?",
                            answer: String(product),
                            acceptableAnswers: [String(product), `${product} items`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pr = rand(3, 6), pc = rand(5, 8); return {
                    problem: `An array has ${pr} rows and ${pc} columns. Find the total.`, answer: String(pr * pc),
                    options: shuffle([String(pr * pc), String(pr + pc), String(pr * pc + pr), String(pr * pc - pc)]),
                    mistakeAnalysis: {
                        [String(pr + pc)]: "You added! Arrays show multiplication: rows × columns",
                        [String(pr * pc + pr)]: "Check your multiplication - you added an extra row",
                        [String(pr * pc - pc)]: "Check your multiplication - you're missing a row"
                    }}; })()
            };
        },
        Area: () => ({
            goalProblem: `Find the area of a rectangle that is 6 units long and 4 units wide.`,
            teachingSteps: [
                {
                    title: "What is area?",
                    explanation: "<strong>Area</strong> is the amount of space inside a flat shape. We measure area in <strong>square units</strong> (like square inches or square centimeters).",
                    visual: "Area = space inside □"
                },
                {
                    title: "Area of a rectangle formula",
                    explanation: "For rectangles and squares: <strong>Area = length × width</strong>. We multiply the two sides!",
                    visual: "Area = L × W"
                },
                {
                    title: "Set up our problem",
                    explanation: "Our rectangle is 6 units long and 4 units wide. We need to multiply: 6 × 4",
                    visual: "Length = 6, Width = 4"
                },
                {
                    title: "Calculate: 6 × 4",
                    explanation: "6 × 4 = <strong>24</strong>. The area is 24 square units!",
                    visual: "6 × 4 = 24 square units"
                },
                {
                    title: "Why square units?",
                    explanation: "We say 'square units' because area counts how many unit squares fit inside the shape. Our rectangle fits 24 unit squares!",
                    visual: "□□□□□□\n□□□□□□\n□□□□□□\n□□□□□□ (24 squares)"
                }
            ],
            finalAnswer: "24 square units",
            answerExplanation: "Area = length × width = 6 × 4 = 24 square units",
            example: { problem: `Find the area of a 6×4 rectangle`, steps: [
                { text: "Write the formula", math: "Area = length × width" },
                { text: "Plug in the values", math: "Area = 6 × 4" },
                { text: "Calculate", math: "Area = <strong>24 square units</strong>" }
            ]},
            keyPoints: [
                "Area = length × width (for rectangles)",
                "Area is measured in SQUARE units",
                "A square is a special rectangle where length = width"
            ],
            mistakes: [
                { wrong: "Adding length + width", why: "That gives perimeter (distance around), not area. For area, MULTIPLY!" },
                { wrong: "Forgetting 'square' units", why: "Area is 2D, so we need square units (sq in, sq cm, etc.)" }
            ],
            guided: {
                problem: `Find the area of a rectangle: 5 cm long, 3 cm wide`,
                steps: [
                    { label: "Formula", value: "Area = length × width" },
                    { label: "Values", value: "5 × 3" },
                    { label: "Answer", value: "?" }
                ],
                answer: "15",
                answerLabel: "Area = ? square cm",
                interactiveSteps: [
                    {
                        prompt: "What operation do we use to find area?",
                        hint: "Area = length ___ width",
                        answer: "multiplication",
                        acceptableAnswers: ["multiplication", "multiply", "times", "×"],
                        formatHint: "What operation?",
                        commonMistakes: {
                            "addition": "Addition gives perimeter. For AREA, we multiply!"
                        }
                    },
                    {
                        prompt: "Calculate: 5 × 3 = ?",
                        hint: "5 groups of 3...",
                        answer: "15",
                        acceptableAnswers: ["15", "15 square cm", "15 sq cm"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "You added 5+3=8. For area, multiply: 5×3=15"
                        }
                    }
                ]
            },
            practice: { problem: `Find the area: length = 8 m, width = 7 m`, answer: "56", options: ["15", "30", "56", "112"],
                mistakeAnalysis: {
                    "15": "You added 8+7=15. For area, multiply: 8×7=56",
                    "30": "Check your multiplication: 8×7=56, not 30",
                    "112": "You doubled the answer. 8×7=56"
                }}
        }),
        "Bar Graphs": () => ({
            goalProblem: `A bar graph shows: Mon=3, Tue=5, Wed=4. Which day had the most?`,
            teachingSteps: [
                {
                    title: "What is a bar graph?",
                    explanation: "A <strong>bar graph</strong> uses bars of different heights to show data. Taller bars = bigger numbers!",
                    visual: "█ █ █\n█ █ █\n█ █ (different heights)"
                },
                {
                    title: "Reading bar graphs",
                    explanation: "To read a bar graph: look at a bar, follow it to the number scale on the side. That's the value!",
                    visual: "Bar height → Number on scale"
                },
                {
                    title: "Compare our data",
                    explanation: "Monday = 3, Tuesday = 5, Wednesday = 4. We need to find which day has the MOST (biggest number).",
                    visual: "Mon: 3 | Tue: 5 | Wed: 4"
                },
                {
                    title: "Find the tallest bar",
                    explanation: "Tuesday has 5, which is more than Monday's 3 and Wednesday's 4. Tuesday's bar is the tallest!",
                    visual: "5 > 4 > 3 → Tuesday wins!"
                },
                {
                    title: "Answer: Tuesday",
                    explanation: "<strong>Tuesday</strong> had the most with 5. We can see this because its bar is the tallest.",
                    visual: "Answer: Tuesday (5)"
                }
            ],
            finalAnswer: "Tuesday",
            answerExplanation: "Tuesday had 5, which is more than Monday (3) or Wednesday (4).",
            example: { problem: `Which day had the most?`, steps: [
                { text: "Read each bar", math: "Mon=3, Tue=5, Wed=4" },
                { text: "Compare the values", math: "5 > 4 > 3" },
                { text: "The largest is Tuesday", math: "Answer: <strong>Tuesday</strong>" }
            ]},
            keyPoints: [
                "Taller bar = bigger number",
                "Always check the scale on the side",
                "Compare bar heights to find most/least"
            ],
            mistakes: [
                { wrong: "Looking at bar color instead of height", why: "It's the HEIGHT that matters, not the color!" },
                { wrong: "Misreading the scale", why: "Always trace from the bar top to the number axis" }
            ],
            guided: {
                problem: `Bar graph: Apples=7, Oranges=4, Bananas=9. What is the total?`,
                steps: [
                    { label: "Read each bar", value: "7, 4, 9" },
                    { label: "Add them up", value: "7 + 4 + 9" },
                    { label: "Total", value: "?" }
                ],
                answer: "20",
                answerLabel: "Total = ?",
                interactiveSteps: [
                    {
                        prompt: "First, add Apples and Oranges: 7 + 4 = ?",
                        hint: "7 + 4...",
                        answer: "11",
                        acceptableAnswers: ["11"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Now add Bananas: 11 + 9 = ?",
                        hint: "11 + 9...",
                        answer: "20",
                        acceptableAnswers: ["20"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Bar graph: Red=8, Blue=6. How many more red than blue?`, answer: "2", options: ["2", "6", "8", "14"],
                mistakeAnalysis: {
                    "6": "That's how many blue. The DIFFERENCE is 8-6=2",
                    "8": "That's how many red. The DIFFERENCE is 8-6=2",
                    "14": "You added them. To find 'how many more', subtract: 8-6=2"
                }}
        }),
        "Elapsed Time": () => ({
            goalProblem: `A movie starts at 2:00 PM and ends at 4:30 PM. How long is the movie?`,
            teachingSteps: [
                {
                    title: "What is elapsed time?",
                    explanation: "<strong>Elapsed time</strong> is how much time passes between a start time and an end time. It's the duration!",
                    visual: "Start → [elapsed time] → End"
                },
                {
                    title: "Method: Count the hours first",
                    explanation: "From 2:00 PM to 4:00 PM is 2 hours. We count: 2:00 → 3:00 (1 hour) → 4:00 (2 hours).",
                    visual: "2:00 → 3:00 → 4:00 = 2 hours"
                },
                {
                    title: "Then add the extra minutes",
                    explanation: "From 4:00 PM to 4:30 PM is 30 more minutes. So total = 2 hours + 30 minutes.",
                    visual: "4:00 → 4:30 = 30 minutes"
                },
                {
                    title: "Combine hours and minutes",
                    explanation: "2 hours + 30 minutes = <strong>2 hours 30 minutes</strong> (or 2½ hours).",
                    visual: "2 h + 30 min = 2 h 30 min"
                },
                {
                    title: "Answer: 2 hours 30 minutes",
                    explanation: "The movie is <strong>2 hours 30 minutes</strong> long. That's 150 minutes total!",
                    visual: "2:00 PM → 4:30 PM = 2 h 30 min"
                }
            ],
            finalAnswer: "2 hours 30 minutes",
            answerExplanation: "From 2:00 to 4:00 is 2 hours, plus 30 more minutes = 2 hours 30 minutes.",
            example: { problem: `How long from 2:00 PM to 4:30 PM?`, steps: [
                { text: "Count hours: 2:00 to 4:00", math: "2 hours" },
                { text: "Add minutes: 4:00 to 4:30", math: "+ 30 minutes" },
                { text: "Total elapsed time", math: "<strong>2 hours 30 minutes</strong>" }
            ]},
            keyPoints: [
                "Count hours first, then add extra minutes",
                "60 minutes = 1 hour",
                "Watch for AM/PM changes (noon, midnight)"
            ],
            mistakes: [
                { wrong: "Subtracting times like regular numbers", why: "3:15 - 1:45 ≠ 2:30 (you can't just subtract 45 from 15). Count hours, then handle minutes carefully!" },
                { wrong: "Forgetting about AM/PM", why: "From 10:00 AM to 1:00 PM is 3 hours, not 3 hours backward!" }
            ],
            guided: {
                problem: `School starts at 8:00 AM and ends at 3:00 PM. How long is the school day?`,
                steps: [
                    { label: "Start time", value: "8:00 AM" },
                    { label: "End time", value: "3:00 PM" },
                    { label: "Elapsed time", value: "?" }
                ],
                answer: "7",
                answerLabel: "School day = ? hours",
                interactiveSteps: [
                    {
                        prompt: "From 8:00 AM to 12:00 PM (noon) is how many hours?",
                        hint: "Count: 8, 9, 10, 11, 12...",
                        answer: "4",
                        acceptableAnswers: ["4", "4 hours"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "From 12:00 PM to 3:00 PM is how many hours?",
                        hint: "Count: 12, 1, 2, 3...",
                        answer: "3",
                        acceptableAnswers: ["3", "3 hours"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Total: 4 hours + 3 hours = ?",
                        hint: "Add them up...",
                        answer: "7",
                        acceptableAnswers: ["7", "7 hours"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `From 9:15 AM to 11:45 AM, how much time passed?`, answer: "2 hours 30 minutes", options: ["2 hours", "2 hours 30 minutes", "3 hours", "2 hours 45 minutes"],
                mistakeAnalysis: {
                    "2 hours": "You forgot the minutes. 9:15 to 11:15 is 2 hours, plus 30 more minutes to 11:45.",
                    "3 hours": "That's too much. 9:15 to 11:45 is 2 hours 30 minutes.",
                    "2 hours 45 minutes": "Check the minutes: from :15 to :45 is 30 minutes, not 45."
                }}
        }),
        "Factors and Multiples": () => ({
            goalProblem: `What are the factors of 12?`,
            teachingSteps: [
                {
                    title: "What is a factor?",
                    explanation: "<strong>Factors</strong> are numbers that divide evenly into another number with no remainder.",
                    visual: "12 ÷ factor = whole number"
                },
                {
                    title: "Find factors by dividing",
                    explanation: "To find factors of 12, ask: which numbers divide 12 evenly? Try 1, 2, 3, 4, 5, 6...",
                    visual: "12 ÷ 1 = 12 ✓  12 ÷ 2 = 6 ✓"
                },
                {
                    title: "Test each number",
                    explanation: "12 ÷ 1 = 12 ✓, 12 ÷ 2 = 6 ✓, 12 ÷ 3 = 4 ✓, 12 ÷ 4 = 3 ✓, 12 ÷ 5 = 2.4 ✗, 12 ÷ 6 = 2 ✓",
                    visual: "Factors so far: 1, 2, 3, 4, 6"
                },
                {
                    title: "Don't forget 12 itself!",
                    explanation: "12 ÷ 12 = 1. So 12 is also a factor. Every number has 1 and itself as factors.",
                    visual: "Add 12 to our list"
                },
                {
                    title: "All factors of 12",
                    explanation: "The factors of 12 are: <strong>1, 2, 3, 4, 6, 12</strong>",
                    visual: "Factors of 12: 1, 2, 3, 4, 6, 12"
                }
            ],
            finalAnswer: "1, 2, 3, 4, 6, 12",
            answerExplanation: "These are all the numbers that divide evenly into 12.",
            example: { problem: `Find the factors of 12`, steps: [
                { text: "Test which numbers divide 12 evenly", math: "12÷1=12, 12÷2=6, 12÷3=4..." },
                { text: "List all that work", math: "1, 2, 3, 4, 6, 12" },
                { text: "Answer", math: "Factors: <strong>1, 2, 3, 4, 6, 12</strong>" }
            ]},
            keyPoints: [
                "Factors divide evenly (no remainder)",
                "1 and the number itself are always factors",
                "Multiples are the opposite: 12, 24, 36... are multiples of 12"
            ],
            mistakes: [
                { wrong: "Confusing factors and multiples", why: "Factors divide INTO a number. Multiples are what you get when you multiply BY a number." },
                { wrong: "Missing factor pairs", why: "Factors come in pairs! If 2 is a factor, so is 12÷2=6" }
            ],
            guided: {
                problem: `List all factors of 8`,
                steps: [
                    { label: "8 ÷ 1 = 8, so factors include", value: "1 and 8" },
                    { label: "8 ÷ 2 = 4, so factors include", value: "2 and 4" },
                    { label: "All factors of 8", value: "?" }
                ],
                answer: "1, 2, 4, 8",
                answerLabel: "Factors of 8",
                interactiveSteps: [
                    {
                        prompt: "Does 8 ÷ 2 have a remainder?",
                        hint: "8 ÷ 2 = ?",
                        answer: "no",
                        acceptableAnswers: ["no", "n", "4"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "yes": "8 ÷ 2 = 4 exactly, no remainder. So 2 is a factor!"
                        }
                    },
                    {
                        prompt: "Is 3 a factor of 8? (Does 8 ÷ 3 divide evenly?)",
                        hint: "8 ÷ 3 = 2 remainder ?",
                        answer: "no",
                        acceptableAnswers: ["no", "n"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "yes": "8 ÷ 3 = 2 R2. There's a remainder, so 3 is NOT a factor."
                        }
                    }
                ]
            },
            practice: { problem: `Which is NOT a factor of 20?`, answer: "8", options: ["2", "4", "5", "8"],
                mistakeAnalysis: {
                    "2": "20 ÷ 2 = 10 exactly. 2 IS a factor of 20.",
                    "4": "20 ÷ 4 = 5 exactly. 4 IS a factor of 20.",
                    "5": "20 ÷ 5 = 4 exactly. 5 IS a factor of 20."
                }}
        }),
        "Fraction Operations": () => ({
            goalProblem: `What is 1/4 + 2/4?`,
            teachingSteps: [
                {
                    title: "Adding fractions with SAME denominators",
                    explanation: "When fractions have the <strong>same denominator</strong> (bottom number), we just add the numerators (top numbers)!",
                    visual: "Same bottom → Add the tops"
                },
                {
                    title: "Check: Do they have the same denominator?",
                    explanation: "1/4 and 2/4 both have 4 as the denominator. Yes! We can add them directly.",
                    visual: "1/4 + 2/4 → denominators match ✓"
                },
                {
                    title: "Add the numerators",
                    explanation: "Add the top numbers: 1 + 2 = 3. The denominator stays the same (4).",
                    visual: "(1 + 2)/4 = 3/4"
                },
                {
                    title: "The answer is 3/4",
                    explanation: "1/4 + 2/4 = <strong>3/4</strong>. Think of it as: 1 piece + 2 pieces = 3 pieces (out of 4).",
                    visual: "1 quarter + 2 quarters = 3 quarters"
                },
                {
                    title: "Visual check",
                    explanation: "Picture a pizza cut into 4 slices. Take 1 slice, then 2 more. You have 3 out of 4 slices = 3/4!",
                    visual: "🍕: [1/4] + [2/4] = [3/4]"
                }
            ],
            finalAnswer: "3/4",
            answerExplanation: "1/4 + 2/4 = (1+2)/4 = 3/4. We add numerators when denominators are the same.",
            example: { problem: `1/4 + 2/4`, steps: [
                { text: "Check denominators are the same", math: "Both are 4 ✓" },
                { text: "Add numerators, keep denominator", math: "(1+2)/4" },
                { text: "Simplify", math: "= <strong>3/4</strong>" }
            ]},
            keyPoints: [
                "Same denominators: add numerators only",
                "Different denominators: find common denominator first",
                "Always simplify if possible"
            ],
            mistakes: [
                { wrong: "Adding denominators too", why: "1/4 + 2/4 ≠ 3/8. The denominator stays the same!" },
                { wrong: "Forgetting to simplify", why: "2/4 = 1/2. Always check if your answer can be reduced." }
            ],
            guided: {
                problem: `What is 2/5 + 1/5?`,
                steps: [
                    { label: "Same denominator?", value: "Yes, both 5" },
                    { label: "Add numerators", value: "2 + 1 = 3" },
                    { label: "Answer", value: "?" }
                ],
                answer: "3/5",
                answerLabel: "2/5 + 1/5 = ?",
                interactiveSteps: [
                    {
                        prompt: "Do 2/5 and 1/5 have the same denominator?",
                        hint: "Look at the bottom numbers...",
                        answer: "yes",
                        acceptableAnswers: ["yes", "y"],
                        formatHint: "yes or no",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Add the numerators: 2 + 1 = ?",
                        hint: "Just add the top numbers",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Keep the denominator 5. What is 2/5 + 1/5?",
                        hint: "numerator/denominator",
                        answer: "3/5",
                        acceptableAnswers: ["3/5", "3 / 5"],
                        formatHint: "Enter as a fraction",
                        commonMistakes: {
                            "3/10": "Don't add denominators! The answer is 3/5"
                        }
                    }
                ]
            },
            practice: { problem: `What is 3/8 + 2/8?`, answer: "5/8", options: ["5/8", "5/16", "1/8", "6/8"],
                mistakeAnalysis: {
                    "5/16": "Don't add denominators! 3/8 + 2/8 = 5/8",
                    "1/8": "You subtracted. 3+2=5, so answer is 5/8",
                    "6/8": "Check your addition: 3+2=5, not 6"
                }}
        }),
        "Fraction Word Problems": () => ({
            goalProblem: `Tom ate 1/3 of a pizza. Maria ate 1/3. How much did they eat together?`,
            teachingSteps: [
                {
                    title: "Understand the problem",
                    explanation: "Tom ate some pizza, Maria ate some pizza. We need to find the <strong>total</strong> amount eaten. Total means ADD!",
                    visual: "Tom: 1/3 + Maria: 1/3 = Total: ?"
                },
                {
                    title: "Identify the fractions",
                    explanation: "Tom ate 1/3 of the pizza. Maria ate 1/3 of the pizza. We need to add 1/3 + 1/3.",
                    visual: "1/3 + 1/3 = ?"
                },
                {
                    title: "Add the fractions",
                    explanation: "Same denominators (both 3), so add numerators: 1 + 1 = 2. The answer is 2/3!",
                    visual: "1/3 + 1/3 = 2/3"
                },
                {
                    title: "Check: Does it make sense?",
                    explanation: "2/3 is less than a whole pizza (3/3). That makes sense - they didn't eat the whole thing!",
                    visual: "2/3 < 3/3 ✓"
                },
                {
                    title: "Answer: 2/3 of the pizza",
                    explanation: "Together, Tom and Maria ate <strong>2/3</strong> of the pizza.",
                    visual: "Answer: 2/3"
                }
            ],
            finalAnswer: "2/3",
            answerExplanation: "1/3 + 1/3 = 2/3. They ate 2/3 of the pizza together.",
            example: { problem: `How much pizza did they eat together?`, steps: [
                { text: "Find what we're combining", math: "Tom's 1/3 + Maria's 1/3" },
                { text: "Add the fractions", math: "1/3 + 1/3 = 2/3" },
                { text: "Answer in context", math: "They ate <strong>2/3</strong> of the pizza" }
            ]},
            keyPoints: [
                "'Together', 'total', 'in all' = ADD",
                "'How much more', 'left', 'difference' = SUBTRACT",
                "Always label your answer (2/3 of the pizza, not just 2/3)"
            ],
            mistakes: [
                { wrong: "Not identifying the operation", why: "Read carefully! 'Together' means add, 'how much more' means subtract." },
                { wrong: "Forgetting the context", why: "The answer is '2/3 of the pizza', not just '2/3'." }
            ],
            guided: {
                problem: `A recipe needs 3/4 cup flour. You have 1/4 cup. How much more do you need?`,
                steps: [
                    { label: "Need", value: "3/4 cup" },
                    { label: "Have", value: "1/4 cup" },
                    { label: "More needed (subtract)", value: "?" }
                ],
                answer: "1/2",
                answerLabel: "How much more?",
                interactiveSteps: [
                    {
                        prompt: "'How much MORE' tells us to do what operation?",
                        hint: "More = find the difference...",
                        answer: "subtract",
                        acceptableAnswers: ["subtract", "subtraction", "minus"],
                        formatHint: "What operation?",
                        commonMistakes: {
                            "add": "'How much MORE' means find the difference - that's subtraction!"
                        }
                    },
                    {
                        prompt: "Calculate: 3/4 - 1/4 = ?",
                        hint: "Same denominators, subtract numerators",
                        answer: "2/4",
                        acceptableAnswers: ["2/4", "1/2", "2 / 4", "1 / 2"],
                        formatHint: "Enter as a fraction",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Jake ran 2/5 mile. Sara ran 3/5 mile. How much did they run in total?`, answer: "5/5 mile", options: ["5/10 mile", "5/5 mile", "1/5 mile", "6/5 miles"],
                mistakeAnalysis: {
                    "5/10 mile": "Don't add denominators! 2/5 + 3/5 = 5/5 = 1 mile",
                    "1/5 mile": "You subtracted. 'Total' means add: 2/5 + 3/5 = 5/5",
                    "6/5 miles": "Check your addition: 2+3=5, so 5/5 = 1 mile"
                }}
        }),
        "Line Plots": () => ({
            goalProblem: `Line plot: 2(XX), 3(XXX), 4(XX). How many data points total?`,
            teachingSteps: [
                {
                    title: "What is a line plot?",
                    explanation: "A <strong>line plot</strong> shows data using X's above a number line. Each X represents one data point.",
                    visual: "X X\nX X X\n2  3  4"
                },
                {
                    title: "Reading a line plot",
                    explanation: "Count the X's above each number. 2 has XX (2 X's), 3 has XXX (3 X's), 4 has XX (2 X's).",
                    visual: "2: 2 X's | 3: 3 X's | 4: 2 X's"
                },
                {
                    title: "Find the total",
                    explanation: "To find how many data points total, add up ALL the X's: 2 + 3 + 2 = 7",
                    visual: "2 + 3 + 2 = 7"
                },
                {
                    title: "Answer: 7 data points",
                    explanation: "There are <strong>7</strong> data points (X's) on this line plot.",
                    visual: "Total X's = 7"
                }
            ],
            finalAnswer: "7",
            answerExplanation: "Count all X's: 2 + 3 + 2 = 7 total data points.",
            example: { problem: `How many data points total?`, steps: [
                { text: "Count X's at each value", math: "2: two, 3: three, 4: two" },
                { text: "Add them all", math: "2 + 3 + 2 = 7" },
                { text: "Answer", math: "<strong>7 data points</strong>" }
            ]},
            keyPoints: [
                "Each X = one data point",
                "Count X's to find totals",
                "The most X's = most common value (mode)"
            ],
            mistakes: [
                { wrong: "Counting the numbers instead of X's", why: "The numbers are labels. Count the X marks!" },
                { wrong: "Forgetting some X's", why: "Count carefully - check each column" }
            ],
            guided: {
                problem: `Line plot: 5(X), 6(XXX), 7(XX). What's the most common value?`,
                steps: [
                    { label: "5 has", value: "1 X" },
                    { label: "6 has", value: "3 X's" },
                    { label: "7 has", value: "2 X's" },
                    { label: "Most common", value: "?" }
                ],
                answer: "6",
                answerLabel: "Most common value?",
                interactiveSteps: [
                    {
                        prompt: "Which number has the most X's?",
                        hint: "Compare: 1 vs 3 vs 2",
                        answer: "6",
                        acceptableAnswers: ["6"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "3": "3 is how many X's. We want the NUMBER that has those X's: 6"
                        }
                    }
                ]
            },
            practice: { problem: `Line plot: 1(XX), 2(X), 3(XXXX). How many values are 3?`, answer: "4", options: ["1", "2", "3", "4"],
                mistakeAnalysis: {
                    "1": "1 has two X's. Look at 3, which has XXXX = 4 X's",
                    "2": "2 has one X. Look at 3, which has XXXX = 4 X's",
                    "3": "3 is the value. Count the X's above 3: XXXX = 4"
                }}
        }),
        "Line Symmetry": () => ({
            goalProblem: `How many lines of symmetry does a square have?`,
            teachingSteps: [
                {
                    title: "What is line symmetry?",
                    explanation: "A shape has <strong>line symmetry</strong> if you can fold it in half and both sides match exactly.",
                    visual: "Fold here → Both sides match!"
                },
                {
                    title: "Finding lines of symmetry",
                    explanation: "A line of symmetry divides a shape into two <strong>identical mirror images</strong>. Some shapes have many lines of symmetry!",
                    visual: "Mirror line → Left = Right"
                },
                {
                    title: "A square's symmetry",
                    explanation: "A square can be folded many ways! Vertically (↕), horizontally (↔), and diagonally (↗↙ and ↖↘).",
                    visual: "□ can fold: | — / \\"
                },
                {
                    title: "Count: 4 lines of symmetry",
                    explanation: "1 vertical line, 1 horizontal line, 2 diagonal lines = <strong>4 lines of symmetry</strong>!",
                    visual: "4 ways to fold a square"
                }
            ],
            finalAnswer: "4",
            answerExplanation: "A square has 4 lines of symmetry: vertical, horizontal, and both diagonals.",
            example: { problem: `Lines of symmetry in a square`, steps: [
                { text: "Check vertical fold", math: "✓ matches" },
                { text: "Check horizontal fold", math: "✓ matches" },
                { text: "Check diagonal folds", math: "✓ both match" },
                { text: "Count total", math: "<strong>4 lines</strong>" }
            ]},
            keyPoints: [
                "Square: 4 lines | Rectangle: 2 lines",
                "Circle: infinite lines | Triangle: depends on type",
                "Test by asking: would both halves match if folded?"
            ],
            mistakes: [
                { wrong: "Forgetting diagonal lines", why: "A square has 4 lines: 2 diagonal + vertical + horizontal" },
                { wrong: "Confusing rectangles and squares", why: "Rectangles have 2 lines; squares have 4" }
            ],
            guided: {
                problem: `How many lines of symmetry does a rectangle have?`,
                steps: [
                    { label: "Fold vertically?", value: "✓ matches" },
                    { label: "Fold horizontally?", value: "✓ matches" },
                    { label: "Fold diagonally?", value: "✗ doesn't match" },
                    { label: "Total lines", value: "?" }
                ],
                answer: "2",
                answerLabel: "Lines of symmetry",
                interactiveSteps: [
                    {
                        prompt: "If you fold a rectangle diagonally, do both halves match?",
                        hint: "Try to picture it...",
                        answer: "no",
                        acceptableAnswers: ["no", "n"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "yes": "A rectangle's diagonal fold doesn't match - one half is bigger!"
                        }
                    },
                    {
                        prompt: "Vertical fold ✓, horizontal fold ✓, no diagonals. How many total?",
                        hint: "1 + 1 = ?",
                        answer: "2",
                        acceptableAnswers: ["2", "two"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Which shape has exactly 1 line of symmetry?`, answer: "isosceles triangle", options: ["square", "rectangle", "isosceles triangle", "equilateral triangle"],
                mistakeAnalysis: {
                    "square": "A square has 4 lines of symmetry",
                    "rectangle": "A rectangle has 2 lines of symmetry",
                    "equilateral triangle": "An equilateral triangle has 3 lines of symmetry"
                }}
        }),
        "Mass and Capacity": () => ({
            goalProblem: `Which is heavier: a feather or a brick?`,
            teachingSteps: [
                {
                    title: "What is mass?",
                    explanation: "<strong>Mass</strong> (or weight) is how heavy something is. We measure it in grams, kilograms, ounces, or pounds.",
                    visual: "Mass = how heavy 🏋️"
                },
                {
                    title: "Comparing mass",
                    explanation: "We can compare objects to determine which is heavier or lighter. Think about holding each object!",
                    visual: "Heavy 🧱 vs Light 🪶"
                },
                {
                    title: "Think about a feather",
                    explanation: "A feather is very light - it floats through the air slowly. It weighs almost nothing!",
                    visual: "Feather 🪶 = very light"
                },
                {
                    title: "Think about a brick",
                    explanation: "A brick is heavy and solid. It would fall quickly and be hard to hold for long.",
                    visual: "Brick 🧱 = heavy"
                },
                {
                    title: "Answer: The brick is heavier",
                    explanation: "A <strong>brick</strong> is much heavier than a feather!",
                    visual: "🧱 > 🪶 in mass"
                }
            ],
            finalAnswer: "brick",
            answerExplanation: "A brick is solid and heavy, while a feather is very light.",
            example: { problem: `Which is heavier?`, steps: [
                { text: "Think about each object", math: "Feather = light, Brick = heavy" },
                { text: "Compare", math: "Brick is heavier" },
                { text: "Answer", math: "<strong>brick</strong>" }
            ]},
            keyPoints: [
                "Mass = weight (how heavy)",
                "Capacity = how much a container holds",
                "Common units: grams, kg, oz, pounds (mass) | mL, L, cups, gallons (capacity)"
            ],
            mistakes: [
                { wrong: "Confusing mass and size", why: "Big things aren't always heavy! A balloon is big but light." },
                { wrong: "Mixing up mass and capacity units", why: "Grams measure mass; liters measure capacity (liquid volume)" }
            ],
            guided: {
                problem: `Which holds more: a cup or a bathtub?`,
                steps: [
                    { label: "Cup capacity", value: "About 250 mL" },
                    { label: "Bathtub capacity", value: "About 150 liters" },
                    { label: "Which holds more?", value: "?" }
                ],
                answer: "bathtub",
                answerLabel: "Which holds more?",
                interactiveSteps: [
                    {
                        prompt: "Capacity means how much a container can hold. Which is a bigger container: a cup or a bathtub?",
                        hint: "Think about their sizes...",
                        answer: "bathtub",
                        acceptableAnswers: ["bathtub", "the bathtub", "a bathtub"],
                        formatHint: "cup or bathtub",
                        commonMistakes: {
                            "cup": "A bathtub is MUCH bigger and holds way more water!"
                        }
                    }
                ]
            },
            practice: { problem: `Order from lightest to heaviest: elephant, apple, car`, answer: "apple, car, elephant", options: ["apple, car, elephant", "car, apple, elephant", "elephant, car, apple", "apple, elephant, car"],
                mistakeAnalysis: {
                    "car, apple, elephant": "An apple is lighter than a car!",
                    "elephant, car, apple": "That's heaviest to lightest - we want lightest first",
                    "apple, elephant, car": "An elephant is heavier than a car"
                }}
        }),
        "Multiplication Properties": () => ({
            goalProblem: `Use the commutative property: If 7 × 3 = 21, what is 3 × 7?`,
            teachingSteps: [
                {
                    title: "The Commutative Property",
                    explanation: "The <strong>commutative property</strong> says we can multiply numbers in any order and get the same answer!",
                    visual: "a × b = b × a"
                },
                {
                    title: "Why does order not matter?",
                    explanation: "3 groups of 7 = 21 items. 7 groups of 3 = 21 items. Same total!",
                    visual: "3 × 7 = ●●● ●●● ●●● ●●● ●●● ●●● ●●●\n7 × 3 = ●●●●●●● ●●●●●●● ●●●●●●●"
                },
                {
                    title: "Apply to our problem",
                    explanation: "If 7 × 3 = 21, then 3 × 7 must also equal 21. We just switched the order!",
                    visual: "7 × 3 = 21, so 3 × 7 = 21"
                },
                {
                    title: "Answer: 21",
                    explanation: "By the commutative property, 3 × 7 = <strong>21</strong> (same as 7 × 3).",
                    visual: "3 × 7 = 21 ✓"
                }
            ],
            finalAnswer: "21",
            answerExplanation: "The commutative property: 7 × 3 = 3 × 7 = 21",
            example: { problem: `If 7×3=21, what is 3×7?`, steps: [
                { text: "Commutative property", math: "a × b = b × a" },
                { text: "Apply it", math: "7 × 3 = 3 × 7" },
                { text: "Answer", math: "3 × 7 = <strong>21</strong>" }
            ]},
            keyPoints: [
                "Commutative: a × b = b × a (order doesn't matter)",
                "Associative: (a × b) × c = a × (b × c) (grouping doesn't matter)",
                "Identity: a × 1 = a (multiplying by 1 keeps the number)",
                "Zero property: a × 0 = 0 (multiplying by 0 gives 0)"
            ],
            mistakes: [
                { wrong: "Thinking order changes the answer", why: "For multiplication, order doesn't matter! 3×7 = 7×3" },
                { wrong: "Confusing with addition properties", why: "Both + and × are commutative, but not subtraction or division!" }
            ],
            guided: {
                problem: `What is 8 × 0?`,
                steps: [
                    { label: "Zero property states", value: "Any number × 0 = 0" },
                    { label: "Apply to 8 × 0", value: "?" }
                ],
                answer: "0",
                answerLabel: "8 × 0 = ?",
                interactiveSteps: [
                    {
                        prompt: "The zero property says: any number times 0 equals what?",
                        hint: "If you have 0 groups of 8...",
                        answer: "0",
                        acceptableAnswers: ["0", "zero"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "Zero groups of anything = nothing. 8 × 0 = 0"
                        }
                    }
                ]
            },
            practice: { problem: `Which property? 5 × (2 × 4) = (5 × 2) × 4`, answer: "associative", options: ["commutative", "associative", "identity", "distributive"],
                mistakeAnalysis: {
                    "commutative": "Commutative switches order (a×b = b×a). This changes grouping: that's associative!",
                    "identity": "Identity involves multiplying by 1. This is about grouping (associative).",
                    "distributive": "Distributive involves both + and ×. This is just about grouping in multiplication."
                }}
        }),
        "Prime and Composite": () => ({
            goalProblem: `Is 7 prime or composite?`,
            teachingSteps: [
                {
                    title: "What is a prime number?",
                    explanation: "A <strong>prime number</strong> has exactly 2 factors: 1 and itself. No other numbers divide it evenly!",
                    visual: "Prime: only 1 × itself"
                },
                {
                    title: "What is a composite number?",
                    explanation: "A <strong>composite number</strong> has more than 2 factors. It can be divided by other numbers too.",
                    visual: "Composite: 1 × itself + other factors"
                },
                {
                    title: "Test: What divides 7 evenly?",
                    explanation: "7 ÷ 1 = 7 ✓, 7 ÷ 2 = 3.5 ✗, 7 ÷ 3 = 2.3... ✗, 7 ÷ 4 = 1.75 ✗, 7 ÷ 5 = 1.4 ✗, 7 ÷ 6 = 1.16... ✗, 7 ÷ 7 = 1 ✓",
                    visual: "Only 1 and 7 work!"
                },
                {
                    title: "7 has exactly 2 factors",
                    explanation: "The only factors of 7 are 1 and 7. That's exactly 2 factors, so 7 is <strong>prime</strong>!",
                    visual: "Factors of 7: just 1 and 7"
                },
                {
                    title: "Answer: 7 is prime",
                    explanation: "<strong>7 is prime</strong> because its only factors are 1 and itself.",
                    visual: "7 = PRIME ✓"
                }
            ],
            finalAnswer: "prime",
            answerExplanation: "7 only has two factors (1 and 7), so it's prime.",
            example: { problem: `Is 7 prime or composite?`, steps: [
                { text: "Find all factors of 7", math: "1 and 7 only" },
                { text: "Count: exactly 2 factors", math: "2 factors = prime" },
                { text: "Answer", math: "7 is <strong>prime</strong>" }
            ]},
            keyPoints: [
                "Prime = exactly 2 factors (1 and itself)",
                "Composite = more than 2 factors",
                "1 is neither prime nor composite (only 1 factor)",
                "2 is the only even prime number"
            ],
            mistakes: [
                { wrong: "Thinking all odd numbers are prime", why: "9 is odd but 9 = 3 × 3, so it's composite" },
                { wrong: "Saying 1 is prime", why: "1 only has ONE factor. Prime needs exactly TWO." }
            ],
            guided: {
                problem: `Is 12 prime or composite?`,
                steps: [
                    { label: "Factors of 12", value: "1, 2, 3, 4, 6, 12" },
                    { label: "How many factors?", value: "6 factors" },
                    { label: "Prime or composite?", value: "?" }
                ],
                answer: "composite",
                answerLabel: "12 is...",
                interactiveSteps: [
                    {
                        prompt: "Can any number other than 1 and 12 divide 12 evenly?",
                        hint: "Try 2, 3, 4, 6...",
                        answer: "yes",
                        acceptableAnswers: ["yes", "y"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "no": "12 ÷ 2 = 6, 12 ÷ 3 = 4, etc. Yes, other numbers divide 12!"
                        }
                    },
                    {
                        prompt: "12 has more than 2 factors. Is it prime or composite?",
                        hint: "More than 2 factors = ...",
                        answer: "composite",
                        acceptableAnswers: ["composite"],
                        formatHint: "prime or composite",
                        commonMistakes: {
                            "prime": "Prime has exactly 2 factors. 12 has 6 factors, so it's COMPOSITE."
                        }
                    }
                ]
            },
            practice: { problem: `Which number is prime?`, answer: "11", options: ["9", "10", "11", "12"],
                mistakeAnalysis: {
                    "9": "9 = 3 × 3. It has factors 1, 3, 9 (3 factors) - composite!",
                    "10": "10 = 2 × 5. It has factors 1, 2, 5, 10 (4 factors) - composite!",
                    "12": "12 has factors 1, 2, 3, 4, 6, 12 (6 factors) - composite!"
                }}
        }),
        "Simplifying Fractions": () => ({
            goalProblem: `Simplify 4/8 to lowest terms.`,
            teachingSteps: [
                {
                    title: "What does simplify mean?",
                    explanation: "To <strong>simplify</strong> a fraction means to reduce it to its smallest form while keeping the same value.",
                    visual: "4/8 = ?/? (smaller numbers, same amount)"
                },
                {
                    title: "Find a common factor",
                    explanation: "Look for a number that divides BOTH the numerator and denominator evenly. 4 and 8 are both divisible by 4!",
                    visual: "4 ÷ 4 = 1, 8 ÷ 4 = 2"
                },
                {
                    title: "Divide both by the common factor",
                    explanation: "Divide top and bottom by 4: 4÷4 = 1, 8÷4 = 2. So 4/8 = 1/2!",
                    visual: "4/8 → (4÷4)/(8÷4) = 1/2"
                },
                {
                    title: "Check: Is 1/2 fully simplified?",
                    explanation: "Can we divide 1 and 2 by anything other than 1? No! So 1/2 is in lowest terms.",
                    visual: "1/2 is simplified ✓"
                },
                {
                    title: "Answer: 4/8 = 1/2",
                    explanation: "4/8 simplified = <strong>1/2</strong>. They represent the same amount!",
                    visual: "4/8 = 1/2 (half a pizza either way!)"
                }
            ],
            finalAnswer: "1/2",
            answerExplanation: "4/8 ÷ 4/4 = 1/2. Both are half of the whole!",
            example: { problem: `Simplify 4/8`, steps: [
                { text: "Find common factor", math: "GCF of 4 and 8 is 4" },
                { text: "Divide both by 4", math: "(4÷4)/(8÷4) = 1/2" },
                { text: "Answer", math: "<strong>1/2</strong>" }
            ]},
            keyPoints: [
                "Find the GCF (greatest common factor)",
                "Divide BOTH top and bottom by GCF",
                "Simplified when no common factors remain (except 1)"
            ],
            mistakes: [
                { wrong: "Only dividing the top or bottom", why: "You must divide BOTH by the same number!" },
                { wrong: "Not fully simplifying", why: "6/8 = 3/4, not 6/8. Always find the largest common factor!" }
            ],
            guided: {
                problem: `Simplify 6/9`,
                steps: [
                    { label: "Find GCF of 6 and 9", value: "3" },
                    { label: "Divide both by 3", value: "6÷3 and 9÷3" },
                    { label: "Simplified fraction", value: "?" }
                ],
                answer: "2/3",
                answerLabel: "6/9 simplified = ?",
                interactiveSteps: [
                    {
                        prompt: "What number divides both 6 and 9 evenly?",
                        hint: "Try 3...",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "2": "9 ÷ 2 has a remainder. Try 3 instead!"
                        }
                    },
                    {
                        prompt: "6 ÷ 3 = ? and 9 ÷ 3 = ?",
                        hint: "Calculate both divisions",
                        answer: "2 and 3",
                        acceptableAnswers: ["2 and 3", "2, 3", "2/3"],
                        formatHint: "Enter both results",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Simplify 10/15`, answer: "2/3", options: ["1/5", "2/3", "5/3", "10/15"],
                mistakeAnalysis: {
                    "1/5": "Check your division. 10÷5=2 and 15÷5=3, so answer is 2/3",
                    "5/3": "You flipped it! 10/15 simplifies to 2/3, not 5/3",
                    "10/15": "This isn't simplified! GCF is 5: 10/15 = 2/3"
                }}
        }),
        "Types of Angles": () => ({
            goalProblem: `What type of angle measures 45°?`,
            teachingSteps: [
                {
                    title: "The three main angle types",
                    explanation: "Angles are classified by their size compared to 90°: <strong>acute</strong> (smaller), <strong>right</strong> (exactly 90°), <strong>obtuse</strong> (larger).",
                    visual: "< 90° | = 90° | > 90°"
                },
                {
                    title: "Acute angles: less than 90°",
                    explanation: "An <strong>acute</strong> angle is small and sharp - less than 90°. Think of a pizza slice!",
                    visual: "Acute: 1° to 89°"
                },
                {
                    title: "Right angles: exactly 90°",
                    explanation: "A <strong>right</strong> angle is exactly 90° - like the corner of a book or door.",
                    visual: "Right: exactly 90° ∟"
                },
                {
                    title: "Obtuse angles: more than 90°",
                    explanation: "An <strong>obtuse</strong> angle is wide and open - between 90° and 180°.",
                    visual: "Obtuse: 91° to 179°"
                },
                {
                    title: "45° is acute",
                    explanation: "45° is less than 90°, so it's an <strong>acute</strong> angle!",
                    visual: "45° < 90° → ACUTE"
                }
            ],
            finalAnswer: "acute",
            answerExplanation: "45° is less than 90°, making it an acute angle.",
            example: { problem: `Classify a 45° angle`, steps: [
                { text: "Compare to 90°", math: "45° < 90°" },
                { text: "Less than 90° = acute", math: "Type: acute" },
                { text: "Answer", math: "<strong>acute angle</strong>" }
            ]},
            keyPoints: [
                "Acute: 0° < angle < 90°",
                "Right: angle = 90°",
                "Obtuse: 90° < angle < 180°",
                "Straight: angle = 180°"
            ],
            mistakes: [
                { wrong: "Confusing acute and obtuse", why: "Acute = sharp (small), Obtuse = open (big)" },
                { wrong: "Forgetting right angles are exactly 90°", why: "Right angles are exactly 90°, not 'about' 90°" }
            ],
            guided: {
                problem: `What type of angle measures 120°?`,
                steps: [
                    { label: "Compare to 90°", value: "120° > 90°" },
                    { label: "Greater than 90° = ", value: "?" }
                ],
                answer: "obtuse",
                answerLabel: "Type of angle",
                interactiveSteps: [
                    {
                        prompt: "Is 120° greater than, less than, or equal to 90°?",
                        hint: "120 vs 90...",
                        answer: "greater",
                        acceptableAnswers: ["greater", "greater than", "more", "bigger"],
                        formatHint: "Compare to 90",
                        commonMistakes: {
                            "less": "120 > 90, so 120° is GREATER than 90°"
                        }
                    },
                    {
                        prompt: "An angle greater than 90° is called...",
                        hint: "Starts with 'ob'...",
                        answer: "obtuse",
                        acceptableAnswers: ["obtuse", "obtuse angle"],
                        formatHint: "Name the angle type",
                        commonMistakes: {
                            "acute": "Acute is LESS than 90°. Greater than 90° = obtuse"
                        }
                    }
                ]
            },
            practice: { problem: `A corner of a rectangle is what type of angle?`, answer: "right", options: ["acute", "right", "obtuse", "straight"],
                mistakeAnalysis: {
                    "acute": "Rectangle corners are exactly 90°, not less. That's a right angle!",
                    "obtuse": "Rectangle corners are exactly 90°, not more. That's a right angle!",
                    "straight": "A straight angle is 180° (a straight line). Rectangle corners are 90°."
                }}
        }),
        "Types of Lines": () => ({
            goalProblem: `What do we call lines that never meet?`,
            teachingSteps: [
                {
                    title: "Three types of lines",
                    explanation: "Lines can be <strong>parallel</strong> (never meet), <strong>perpendicular</strong> (meet at 90°), or <strong>intersecting</strong> (cross somewhere).",
                    visual: "‖ parallel  ⊥ perpendicular  ╳ intersecting"
                },
                {
                    title: "Parallel lines",
                    explanation: "<strong>Parallel lines</strong> are always the same distance apart. They go in the same direction and NEVER meet!",
                    visual: "═══════\n═══════ (railroad tracks)"
                },
                {
                    title: "Perpendicular lines",
                    explanation: "<strong>Perpendicular lines</strong> meet at exactly 90° (a right angle). Like a plus sign: +",
                    visual: "┼ or + (90° angle)"
                },
                {
                    title: "Intersecting lines",
                    explanation: "<strong>Intersecting lines</strong> cross at some point (any angle). Perpendicular lines are a special type of intersecting lines.",
                    visual: "╳ (cross somewhere)"
                },
                {
                    title: "Answer: Parallel",
                    explanation: "Lines that never meet are called <strong>parallel</strong> lines!",
                    visual: "Never meet = PARALLEL"
                }
            ],
            finalAnswer: "parallel",
            answerExplanation: "Parallel lines never intersect - they stay the same distance apart forever!",
            example: { problem: `Lines that never meet are...`, steps: [
                { text: "Never meet = always same distance apart", math: "Like railroad tracks" },
                { text: "This describes parallel lines", math: "Answer: <strong>parallel</strong>" }
            ]},
            keyPoints: [
                "Parallel: never meet, same direction",
                "Perpendicular: meet at 90°",
                "Intersecting: cross at any angle"
            ],
            mistakes: [
                { wrong: "Confusing parallel and perpendicular", why: "Parallel never meet; perpendicular meet at 90°" },
                { wrong: "Thinking any crossing lines are perpendicular", why: "Perpendicular must be 90°. Other crossing lines are just 'intersecting'." }
            ],
            guided: {
                problem: `The lines formed by a plus sign (+) are what type?`,
                steps: [
                    { label: "Do they meet?", value: "Yes" },
                    { label: "At what angle?", value: "90°" },
                    { label: "Type of lines", value: "?" }
                ],
                answer: "perpendicular",
                answerLabel: "Type of lines",
                interactiveSteps: [
                    {
                        prompt: "Look at a + sign. What angle do the lines make where they cross?",
                        hint: "It's a right angle...",
                        answer: "90",
                        acceptableAnswers: ["90", "90°", "90 degrees", "right angle"],
                        formatHint: "Enter the angle",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Lines that meet at 90° are called...",
                        hint: "Starts with 'per'...",
                        answer: "perpendicular",
                        acceptableAnswers: ["perpendicular"],
                        formatHint: "Name the type",
                        commonMistakes: {
                            "parallel": "Parallel lines never meet! Lines meeting at 90° are perpendicular."
                        }
                    }
                ]
            },
            practice: { problem: `Opposite sides of a rectangle are what type of lines?`, answer: "parallel", options: ["parallel", "perpendicular", "intersecting", "curved"],
                mistakeAnalysis: {
                    "perpendicular": "Adjacent sides are perpendicular. OPPOSITE sides are parallel (never meet)!",
                    "intersecting": "Opposite sides of a rectangle never meet - they're parallel!",
                    "curved": "Rectangles have straight sides, not curved."
                }}
        })
    },
    3: {
        Percents: () => {
            const pct = pick([10, 20, 25, 50]);
            const base = pick([20, 40, 50, 100]);
            const ans = (pct / 100) * base;
            return {
                goalProblem: `What is 25% of 80?`,
                teachingSteps: [
                    {
                        title: "What does percent mean?",
                        explanation: "<strong>Percent</strong> means 'per hundred' or 'out of 100'. The symbol % tells us we're working with parts of 100.",
                        visual: "25% = 25 out of 100"
                    },
                    {
                        title: "Common percents to memorize",
                        explanation: "50% = half, 25% = quarter, 10% = tenth, 100% = all of it. These shortcuts make calculations faster!",
                        visual: "100%=all | 50%=half | 25%=quarter | 10%=tenth"
                    },
                    {
                        title: "Step 1: Convert percent to decimal",
                        explanation: "To calculate with percents, divide by 100 (move decimal 2 places left). 25% = 25 ÷ 100 = <strong>0.25</strong>",
                        visual: "25% → 25. → 2.5 → 0.25"
                    },
                    {
                        title: "Step 2: 'Of' means multiply",
                        explanation: "In math, 'of' means multiply. '25% of 80' becomes 0.25 × 80.",
                        visual: "25% OF 80 = 0.25 × 80"
                    },
                    {
                        title: "Step 3: Calculate the answer",
                        explanation: "0.25 × 80 = <strong>20</strong>. Quick check: 25% is a quarter, and 80 ÷ 4 = 20 ✓",
                        visual: "0.25 × 80 = 20"
                    }
                ],
                finalAnswer: "20",
                answerExplanation: "25% = 0.25, and 0.25 × 80 = 20. Since 25% is a quarter, we're finding a quarter of 80!",
                example: { problem: `What is 25% of 80?`, steps: [
                    { text: "Convert percent to decimal", math: "25% = 25 ÷ 100 = 0.25" },
                    { text: "Set up the multiplication", math: "25% of 80 means 0.25 × 80" },
                    { text: "Multiply step by step", math: "0.25 × 80 = 25 × 80 ÷ 100 = 2000 ÷ 100 = <strong>20</strong>" },
                    { text: "Check: Is 20 about 1/4 of 80?", math: "Yes! 80 ÷ 4 = 20 ✓" }
                ]},
                keyPoints: [
                    "Percent to decimal: move decimal point 2 places LEFT (25% → 0.25)",
                    "50% = ×0.5 = ÷2 (half), 25% = ×0.25 = ÷4 (quarter), 10% = ×0.1 = ÷10",
                    "To find 10% of any number, just move the decimal one place left: 10% of 80 = 8"
                ],
                mistakes: [
                    { wrong: "25% of 80 = 25 + 80 = 105", why: "'Of' in math means MULTIPLY, not add. 25% OF 80 = 0.25 × 80" },
                    { wrong: "25% = 2.5 or 0.025", why: "Move decimal 2 places LEFT: 25.0% → 0.25 (not 1 or 3 places)" },
                    { wrong: "Thinking 25% of 80 should be bigger than 80", why: "A percent less than 100% gives you a SMALLER answer" }
                ],
                guided: {
                    problem: `What is ${pct}% of ${base}?`,
                    steps: [
                        { label: `Convert ${pct}% to decimal`, value: `${pct}% = ${pct} ÷ 100 = ${pct/100}` },
                        { label: `Multiply by ${base}`, value: `${pct/100} × ${base} = ?` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(ans),
                    answerLabel: `${pct}% of ${base} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "To use a percent in calculations, we first convert it to a decimal. How do we convert a percent to a decimal?",
                            hint: "Move the decimal point or divide by...",
                            answer: "divide by 100",
                            acceptableAnswers: ["divide by 100", "÷ 100", "move decimal 2 places left", "move decimal left 2"],
                            commonMistakes: {
                                "divide by 10": "Divide by 100, not 10 (percent means 'per hundred')",
                                "multiply by 100": "That's decimal → percent. For percent → decimal, DIVIDE by 100."
                            }
                        },
                        {
                            prompt: `Convert ${pct}% to a decimal: ${pct} ÷ 100 = ?`,
                            hint: `Move the decimal point 2 places left: ${pct}.0 → ?`,
                            answer: String(pct / 100),
                            acceptableAnswers: [String(pct / 100)],
                            commonMistakes: {
                                [String(pct)]: `Don't forget to divide! ${pct} ÷ 100 = ${pct / 100}`,
                                [String(pct * 100)]: `You multiplied instead of divided. ${pct} ÷ 100 = ${pct / 100}`
                            }
                        },
                        {
                            prompt: `Now multiply: ${pct / 100} × ${base} = ?`,
                            hint: `${pct}% of ${base} means ${pct / 100} × ${base}`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(pct + base)]: `You added instead of multiplied! ${pct / 100} × ${base} = ${ans}`,
                                [String(pct / 100 + base)]: `Add the decimal? No - MULTIPLY it: ${pct / 100} × ${base} = ${ans}`
                            }
                        }
                    ]
                },
                practice: (() => { const newBase = base * 2; const newAns = (pct / 100) * newBase; return {
                    problem: `What is ${pct}% of ${newBase}?`, answer: String(newAns),
                    options: shuffle([String(newAns), String(ans), String(pct + newBase), String(newAns * 2)]),
                    mistakeAnalysis: {
                        [String(ans)]: `You used ${base} instead of ${newBase}. With ${newBase}, the answer is ${pct/100} × ${newBase} = ${newAns}`,
                        [String(pct + newBase)]: `You added instead of multiplied. '${pct}% OF ${newBase}' means ${pct/100} × ${newBase}`,
                        [String(newAns * 2)]: `Check your calculation: ${pct}% = ${pct/100}, and ${pct/100} × ${newBase} = ${newAns}`
                    }}; })()
            };
        },
        Integers: () => ({
            // Progressive sub-skills for T3 Integers
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Understanding Integers
                {
                    id: "understanding",
                    name: "Understanding Integers",
                    goalProblem: `On a number line, which is further left: -3 or -7?`,
                    teachingSteps: [
                        {
                            title: "What are integers?",
                            explanation: "<strong>Integers</strong> are whole numbers that include positive numbers, negative numbers, and zero. No fractions or decimals!",
                            visual: "...-3, -2, -1, 0, 1, 2, 3..."
                        },
                        {
                            title: "The number line",
                            explanation: "A number line shows all integers in order. <strong>Zero</strong> is in the middle. Positive numbers go right, negative numbers go left.",
                            visual: "← -5 -4 -3 -2 -1 [0] 1 2 3 4 5 →"
                        },
                        {
                            title: "Negative numbers: Further left = smaller",
                            explanation: "The further LEFT a number is, the <strong>smaller</strong> it is. So -7 is smaller than -3 because -7 is further left!",
                            visual: "← ... -7 ... -3 ... 0 → (-7 < -3)"
                        },
                        {
                            title: "Absolute value",
                            explanation: "The <strong>absolute value</strong> of a number is its distance from zero (always positive).<br>|-7| = 7 and |7| = 7<br>Think: 'How far from zero?'",
                            visual: "|-7| = 7 (7 steps from 0)<br>|5| = 5 (5 steps from 0)"
                        },
                        {
                            title: "Answer: -7 is further left",
                            explanation: "<strong>-7 is further left than -3</strong>. Remember: bigger negative = further left = smaller number!",
                            visual: "-7 ← ← ← ← -3"
                        }
                    ],
                    finalAnswer: "-7",
                    answerExplanation: "-7 is further left on the number line than -3, making it smaller. The larger the absolute value of a negative, the further left it is.",
                    example: { problem: `Which is further left: -3 or -7?`, steps: [
                        { text: "Place both on a number line", math: "← -7 ... -3 ... 0 →" },
                        { text: "-7 is further from zero (to the left)", math: "|-7| = 7, |-3| = 3" },
                        { text: "Further left = smaller", math: "<strong>-7 is further left</strong>" }
                    ]},
                    keyPoints: [
                        "Number line: left = smaller, right = bigger",
                        "Negative numbers with larger absolute values are SMALLER (-10 < -5)",
                        "Absolute value = distance from zero (always positive)",
                        "Zero is neither positive nor negative"
                    ],
                    mistakes: [
                        { wrong: "Thinking -3 < -7 because 3 < 7", why: "For negatives, it's opposite! -7 is further left (smaller) than -3" },
                        { wrong: "Confusing absolute value with the number itself", why: "|-5| = 5 (positive!), but -5 is still negative" }
                    ],
                    guided: {
                        problem: `Which is greater: -4 or -9?`,
                        steps: [
                            { label: "Place on number line", value: "-9 ... -4 ... 0" },
                            { label: "Which is further right?", value: "?" }
                        ],
                        answer: "-4",
                        answerLabel: "Greater number:",
                        interactiveSteps: [
                            {
                                prompt: "On a number line, is -9 to the left or right of -4?",
                                hint: "-9 is further from zero than -4...",
                                answer: "left",
                                acceptableAnswers: ["left", "to the left"],
                                formatHint: "left or right",
                                commonMistakes: {
                                    "right": "-9 has a larger absolute value, so it's FURTHER left from zero"
                                }
                            },
                            {
                                prompt: "On a number line, numbers to the right are greater. Which is greater: -4 or -9?",
                                hint: "-4 is to the right of -9...",
                                answer: "-4",
                                acceptableAnswers: ["-4", "negative 4"],
                                formatHint: "Enter the number",
                                commonMistakes: {
                                    "-9": "-9 is further LEFT, which means it's SMALLER. -4 > -9"
                                }
                            }
                        ]
                    },
                    practice: { problem: `Order from least to greatest: -2, 5, -8, 0`, answer: "-8, -2, 0, 5",
                        options: ["-8, -2, 0, 5", "-2, -8, 0, 5", "0, -2, 5, -8", "-8, 0, -2, 5"],
                        mistakeAnalysis: {
                            "-2, -8, 0, 5": "-8 is smaller than -2! Further left on number line.",
                            "0, -2, 5, -8": "That's not ordered. -8 < -2 < 0 < 5",
                            "-8, 0, -2, 5": "-2 comes between -8 and 0 on the number line"
                        }}
                },

                // Sub-skill 2: Adding Integers
                {
                    id: "add",
                    name: "Adding Integers",
                    goalProblem: `What is -5 + 8?`,
                    teachingSteps: [
                        {
                            title: "Two rules for adding integers",
                            explanation: "Adding integers has different rules depending on whether the signs are the <strong>same</strong> or <strong>different</strong>.",
                            visual: "Same signs → Add | Different signs → Subtract"
                        },
                        {
                            title: "Same signs: ADD, keep the sign",
                            explanation: "If both numbers have the <strong>same sign</strong>, add their absolute values and keep the sign.<br>-3 + -5 = -(3+5) = <strong>-8</strong><br>+3 + +5 = +(3+5) = <strong>+8</strong>",
                            visual: "Same signs: ADD, keep sign"
                        },
                        {
                            title: "Different signs: SUBTRACT, keep sign of larger",
                            explanation: "If signs are <strong>different</strong>, subtract the absolute values. The answer takes the sign of the number with the larger absolute value.",
                            visual: "Different signs: SUBTRACT, winner's sign"
                        },
                        {
                            title: "Let's solve -5 + 8",
                            explanation: "Signs are different (-5 is negative, +8 is positive).<br>Subtract: 8 - 5 = 3<br>8 has larger absolute value and is positive.<br>Answer: <strong>+3</strong>",
                            visual: "-5 + 8 → 8 - 5 = 3, positive wins → +3"
                        },
                        {
                            title: "Number line method",
                            explanation: "Start at -5, add +8 means move RIGHT 8 spaces:<br>-5 → -4 → -3 → -2 → -1 → 0 → 1 → 2 → <strong>3</strong>",
                            visual: "-5 + 8 = 3 ✓"
                        }
                    ],
                    finalAnswer: "3",
                    answerExplanation: "Different signs: subtract (8-5=3). 8 is larger and positive, so answer is +3",
                    example: { problem: `What is -5 + 8?`, steps: [
                        { text: "Check signs", math: "-5 (negative) + 8 (positive) = different signs" },
                        { text: "Subtract absolute values", math: "8 - 5 = 3" },
                        { text: "Larger absolute value wins", math: "|8| > |-5|, positive wins" },
                        { text: "Answer", math: "<strong>+3</strong>" }
                    ]},
                    keyPoints: [
                        "Same signs: ADD absolute values, keep the sign",
                        "Different signs: SUBTRACT absolute values, take sign of larger",
                        "Number line: adding positive = right, adding negative = left"
                    ],
                    mistakes: [
                        { wrong: "-5 + 8 = -13 (adding instead of subtracting)", why: "Different signs means SUBTRACT: 8 - 5 = 3" },
                        { wrong: "-5 + 8 = -3 (wrong sign)", why: "8 > 5 and 8 is positive, so answer is POSITIVE 3" }
                    ],
                    guided: {
                        problem: `What is -7 + (-3)?`,
                        steps: [
                            { label: "Check signs", value: "Both negative (same)" },
                            { label: "Same signs: ADD", value: "7 + 3 = 10" },
                            { label: "Keep the sign", value: "?" }
                        ],
                        answer: "-10",
                        answerLabel: "Sum:",
                        interactiveSteps: [
                            {
                                prompt: "Are -7 and -3 the same sign or different signs?",
                                hint: "Both are negative...",
                                answer: "same",
                                acceptableAnswers: ["same", "same sign", "same signs"],
                                formatHint: "same or different",
                                commonMistakes: {
                                    "different": "Both -7 and -3 are NEGATIVE - that's the same sign!"
                                }
                            },
                            {
                                prompt: "Same signs: ADD the absolute values. |-7| + |-3| = ?",
                                hint: "7 + 3 = ?",
                                answer: "10",
                                acceptableAnswers: ["10", "ten"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Same signs: keep the sign. Both were negative, so the answer is?",
                                hint: "Negative + Negative = Negative",
                                answer: "-10",
                                acceptableAnswers: ["-10", "negative 10"],
                                formatHint: "e.g., -10",
                                commonMistakes: {
                                    "10": "Both numbers were negative, so the sum is also NEGATIVE: -10"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is -6 + 4?`, answer: "-2",
                        options: ["-2", "2", "-10", "10"],
                        mistakeAnalysis: {
                            "2": "Check the sign! |-6| > |4|, so negative wins. Answer: -2",
                            "-10": "Different signs means SUBTRACT, not add! 6 - 4 = 2, negative wins → -2",
                            "10": "Different signs: subtract (6-4=2), larger absolute value's sign wins (-6), so -2"
                        }}
                },

                // Sub-skill 3: Subtracting Integers
                {
                    id: "subtract",
                    name: "Subtracting Integers",
                    goalProblem: `What is 3 - (-5)?`,
                    teachingSteps: [
                        {
                            title: "The golden rule: Add the opposite!",
                            explanation: "Subtracting an integer is the same as <strong>adding its opposite</strong>!<br>a - b = a + (-b)",
                            visual: "Subtract → Add the Opposite"
                        },
                        {
                            title: "What's the opposite?",
                            explanation: "The opposite of a number is the same distance from zero but on the other side:<br>Opposite of 5 is -5<br>Opposite of -5 is 5",
                            visual: "opposite(5) = -5<br>opposite(-5) = 5"
                        },
                        {
                            title: "Apply to 3 - (-5)",
                            explanation: "3 - (-5) = 3 + <strong>opposite of -5</strong><br>Opposite of -5 is +5<br>So: 3 - (-5) = 3 + 5",
                            visual: "3 - (-5) → 3 + 5"
                        },
                        {
                            title: "Now it's addition!",
                            explanation: "3 + 5 = <strong>8</strong><br>Same signs (both positive), add and keep sign.",
                            visual: "3 + 5 = 8"
                        },
                        {
                            title: "Remember: Minus a negative = Plus!",
                            explanation: "Subtracting a negative is like adding a positive.<br>3 - (-5) = 3 + 5 = 8<br>Think: 'Two negatives make a positive!'",
                            visual: "- (-) = + ✓"
                        }
                    ],
                    finalAnswer: "8",
                    answerExplanation: "3 - (-5) = 3 + 5 = 8. Subtracting a negative is the same as adding a positive!",
                    example: { problem: `What is 3 - (-5)?`, steps: [
                        { text: "Rewrite as addition", math: "3 - (-5) = 3 + opposite of -5" },
                        { text: "Find the opposite", math: "opposite of -5 = +5" },
                        { text: "Add", math: "3 + 5 = <strong>8</strong>" }
                    ]},
                    keyPoints: [
                        "Subtracting = Adding the opposite",
                        "a - b = a + (-b)",
                        "Minus a negative = Plus (two negatives make positive)",
                        "Convert to addition, then use addition rules"
                    ],
                    mistakes: [
                        { wrong: "3 - (-5) = -2 (subtracting 5 from 3)", why: "Minus negative = plus! 3 - (-5) = 3 + 5 = 8" },
                        { wrong: "3 - (-5) = 3 - 5 = -2", why: "Change BOTH the operation AND the sign: 3 - (-5) = 3 + (+5)" }
                    ],
                    guided: {
                        problem: `What is -4 - (-7)?`,
                        steps: [
                            { label: "Change to addition", value: "-4 + opposite of -7" },
                            { label: "Opposite of -7", value: "+7" },
                            { label: "Add", value: "-4 + 7 = ?" }
                        ],
                        answer: "3",
                        answerLabel: "Difference:",
                        interactiveSteps: [
                            {
                                prompt: "To subtract, we add the opposite. What is the opposite of -7?",
                                hint: "The opposite of a negative is positive...",
                                answer: "7",
                                acceptableAnswers: ["7", "+7", "positive 7"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "-7": "The OPPOSITE of -7 is +7 (on other side of zero)"
                                }
                            },
                            {
                                prompt: "So -4 - (-7) = -4 + 7. Are these the same or different signs?",
                                hint: "-4 is negative, 7 is positive...",
                                answer: "different",
                                acceptableAnswers: ["different", "different signs"],
                                formatHint: "same or different",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Different signs: subtract absolute values. 7 - 4 = ?",
                                hint: "Larger minus smaller...",
                                answer: "3",
                                acceptableAnswers: ["3", "three"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "7 > 4 and 7 is positive. So the answer is positive or negative?",
                                hint: "The sign of the larger absolute value wins...",
                                answer: "positive",
                                acceptableAnswers: ["positive", "+", "plus"],
                                formatHint: "positive or negative",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Final answer: -4 - (-7) = ?",
                                hint: "Positive 3",
                                answer: "3",
                                acceptableAnswers: ["3", "+3"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `What is -2 - 6?`, answer: "-8",
                        options: ["-8", "-4", "4", "8"],
                        mistakeAnalysis: {
                            "-4": "Rewrite: -2 - 6 = -2 + (-6). Same signs, ADD: -8",
                            "4": "Check signs! -2 + (-6) = -8, not +4",
                            "8": "Both negative: -2 + (-6) = -8 (negative 8)"
                        }}
                },

                // Sub-skill 4: Multiplying Integers
                {
                    id: "multiply",
                    name: "Multiplying Integers",
                    goalProblem: `What is (-4) × (-3)?`,
                    teachingSteps: [
                        {
                            title: "Sign rules for multiplication",
                            explanation: "When multiplying integers, the signs determine the answer's sign:<br><strong>Same signs = Positive</strong><br><strong>Different signs = Negative</strong>",
                            visual: "(+)(+) = + | (−)(−) = +<br>(+)(−) = − | (−)(+) = −"
                        },
                        {
                            title: "Positive × Positive = Positive",
                            explanation: "3 × 4 = 12 (positive)<br>This makes sense - you're adding positive groups.",
                            visual: "(+) × (+) = (+)"
                        },
                        {
                            title: "Positive × Negative = Negative",
                            explanation: "3 × (-4) = -12 (negative)<br>Three groups of -4: (-4) + (-4) + (-4) = -12",
                            visual: "(+) × (−) = (−)"
                        },
                        {
                            title: "Negative × Negative = Positive!",
                            explanation: "(-4) × (-3) = +12 (positive!)<br>This is the surprising one! 'Two negatives make a positive.'",
                            visual: "(−) × (−) = (+)"
                        },
                        {
                            title: "Calculate (-4) × (-3)",
                            explanation: "Step 1: Multiply the numbers: 4 × 3 = 12<br>Step 2: Determine sign: negative × negative = <strong>positive</strong><br>Answer: <strong>+12</strong>",
                            visual: "(-4) × (-3) = +12"
                        }
                    ],
                    finalAnswer: "12",
                    answerExplanation: "Multiply absolute values: 4 × 3 = 12. Same signs (both negative) = positive answer. So +12.",
                    example: { problem: `What is (-4) × (-3)?`, steps: [
                        { text: "Check signs", math: "negative × negative = positive" },
                        { text: "Multiply absolute values", math: "4 × 3 = 12" },
                        { text: "Apply sign rule", math: "<strong>+12</strong>" }
                    ]},
                    keyPoints: [
                        "Same signs (++ or −−) = Positive result",
                        "Different signs (+− or −+) = Negative result",
                        "Multiply absolute values first, then determine sign",
                        "Count negatives: even number = positive, odd = negative"
                    ],
                    mistakes: [
                        { wrong: "(-4) × (-3) = -12 (thinking negative × negative = negative)", why: "Negative × Negative = POSITIVE! (-4) × (-3) = +12" },
                        { wrong: "Adding instead of multiplying", why: "(-4) × (-3) means multiply, not -4 + -3" }
                    ],
                    guided: {
                        problem: `What is (-6) × 5?`,
                        steps: [
                            { label: "Check signs", value: "negative × positive = ?" },
                            { label: "Multiply values", value: "6 × 5 = 30" },
                            { label: "Apply sign", value: "?" }
                        ],
                        answer: "-30",
                        answerLabel: "Product:",
                        interactiveSteps: [
                            {
                                prompt: "(-6) × 5 has what signs? Same or different?",
                                hint: "-6 is negative, 5 is positive...",
                                answer: "different",
                                acceptableAnswers: ["different", "different signs"],
                                formatHint: "same or different",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Different signs give what sign in the answer?",
                                hint: "Different signs = ...",
                                answer: "negative",
                                acceptableAnswers: ["negative", "-", "minus"],
                                formatHint: "positive or negative",
                                commonMistakes: {
                                    "positive": "Different signs = NEGATIVE. Same signs = positive."
                                }
                            },
                            {
                                prompt: "Multiply the absolute values: 6 × 5 = ?",
                                hint: "Simple multiplication",
                                answer: "30",
                                acceptableAnswers: ["30", "thirty"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Final answer: (-6) × 5 = ?",
                                hint: "Negative sign + 30",
                                answer: "-30",
                                acceptableAnswers: ["-30", "negative 30"],
                                formatHint: "e.g., -30",
                                commonMistakes: {
                                    "30": "Don't forget the sign! Different signs = negative: -30"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 8 × (-2)?`, answer: "-16",
                        options: ["-16", "16", "-10", "10"],
                        mistakeAnalysis: {
                            "16": "Different signs (+ × −) = negative! Answer: -16",
                            "-10": "Multiply, don't add! 8 × 2 = 16, with negative sign = -16",
                            "10": "8 × 2 = 16 (not 10), and different signs = negative"
                        }}
                }
            ]
        }),
        "Mean Median Mode": () => {
            const data = [rand(2, 5), rand(3, 6), rand(4, 8), rand(5, 9), rand(3, 6)];
            const sorted = [...data].sort((a, b) => a - b);
            const median = sorted[2];
            const sum = data.reduce((a, b) => a + b, 0);
            const mean = sum / data.length;
            return {
                goalProblem: `Find the mean, median, and mode of: 3, 7, 5, 9, 1`,
                teachingSteps: [
                    {
                        title: "Three types of 'average'",
                        explanation: "Mean, median, and mode are all ways to describe the 'center' or typical value of a data set. They each tell us something different!",
                        visual: "Mean = math average | Median = middle | Mode = most common"
                    },
                    {
                        title: "MEAN: Add all, then divide",
                        explanation: "The <strong>mean</strong> is what most people call 'the average'. Add all numbers, then divide by how many there are.",
                        visual: "Mean = (sum of all) ÷ (count)"
                    },
                    {
                        title: "Let's find the mean",
                        explanation: "Add: 3 + 7 + 5 + 9 + 1 = 25. There are 5 numbers, so divide: 25 ÷ 5 = <strong>5</strong>. The mean is 5!",
                        visual: "25 ÷ 5 = 5 (Mean)"
                    },
                    {
                        title: "MEDIAN: Sort first, then find middle",
                        explanation: "The <strong>median</strong> is the middle number when sorted. ALWAYS sort first! 3,7,5,9,1 becomes 1,3,5,7,9",
                        visual: "1, 3, [5], 7, 9 → Median = 5"
                    },
                    {
                        title: "MODE: Most frequent number",
                        explanation: "The <strong>mode</strong> is the number that appears most often. Here, each number appears once, so there's <strong>no mode</strong>.",
                        visual: "No repeats → No mode"
                    }
                ],
                finalAnswer: "Mean = 5, Median = 5, No mode",
                answerExplanation: "Mean: 25÷5=5. Median: middle of 1,3,5,7,9 is 5. Mode: no repeats, so no mode!",
                example: { problem: `Find the mean, median, and mode of: 3, 7, 5, 9, 1`, steps: [
                    { text: "MEAN: Add all numbers", math: "3 + 7 + 5 + 9 + 1 = 25" },
                    { text: "Divide by count (5 numbers)", math: "25 ÷ 5 = <strong>Mean = 5</strong>" },
                    { text: "MEDIAN: First, put in order", math: "1, 3, 5, 7, 9" },
                    { text: "Find the middle number", math: "1, 3, <strong>5</strong>, 7, 9 → <strong>Median = 5</strong>" },
                    { text: "MODE: Which number appears most?", math: "Each number appears once → <strong>No mode</strong>" }
                ]},
                keyPoints: [
                    "Mean = Sum ÷ Count (the 'average')",
                    "Median = SORT first, then find middle (with even count, average the two middle numbers)",
                    "Mode = Most frequent (can have no mode, one mode, or multiple modes)"
                ],
                mistakes: [
                    { wrong: "Finding median without sorting", why: "ALWAYS put in order first! 3, 7, 5, 9, 1 → 1, 3, 5, 7, 9" },
                    { wrong: "Dividing by wrong number for mean", why: "Count ALL numbers. 5 numbers means divide by 5." },
                    { wrong: "Confusing mean and median", why: "Mean = math (add & divide). Median = just find middle." }
                ],
                guided: {
                    problem: `Find the median of: ${data.join(', ')}`,
                    steps: [
                        { label: "First, sort the numbers", value: `${sorted.join(', ')}` },
                        { label: "Count: 5 numbers, so middle is the 3rd", value: `${sorted[0]}, ${sorted[1]}, ?, ${sorted[3]}, ${sorted[4]}` },
                        { label: "Median", value: "?" }
                    ],
                    answer: String(median),
                    answerLabel: "Median = ?",
                    interactiveSteps: [
                        {
                            prompt: "To find the median, what must we do FIRST?",
                            hint: "The numbers might not be in order yet...",
                            answer: "sort",
                            acceptableAnswers: ["sort", "put in order", "order them", "arrange", "sort them"],
                            commonMistakes: {
                                "add": "Adding is for MEAN. For MEDIAN, we first SORT the numbers!",
                                "find middle": "Finding the middle comes AFTER sorting. First, put them in order."
                            }
                        },
                        {
                            prompt: `Sort these numbers from smallest to largest: ${data.join(', ')}`,
                            hint: "Start with the smallest number...",
                            answer: sorted.join(', '),
                            acceptableAnswers: [sorted.join(', '), sorted.join(','), sorted.join(' ')],
                            commonMistakes: {
                                [data.join(', ')]: "Those aren't sorted! Put them in order from smallest to largest."
                            }
                        },
                        {
                            prompt: `Sorted: ${sorted.join(', ')}. We have 5 numbers. Which position is the middle?`,
                            hint: "With 5 items, the middle is position 1, 2, 3, 4, or 5?",
                            answer: "3",
                            acceptableAnswers: ["3", "3rd", "third", "position 3"],
                            commonMistakes: {
                                "2": "With 5 numbers, there are 2 numbers on each side of the middle. Position 3 is the middle!",
                                "5": "5 is the last position. The MIDDLE of 5 items is position 3."
                            }
                        },
                        {
                            prompt: `The 3rd number in ${sorted.join(', ')} is the median. What is it?`,
                            hint: "Count: 1st, 2nd, 3rd...",
                            answer: String(median),
                            acceptableAnswers: [String(median)],
                            commonMistakes: {
                                [String(sorted[0])]: `That's the 1st number. The median is the 3rd: ${median}`,
                                [String(sorted[1])]: `That's the 2nd number. The median is the 3rd: ${median}`,
                                [String(sorted[3])]: `That's the 4th number. The median is the 3rd: ${median}`
                            }
                        }
                    ]
                },
                practice: (() => { const pdata = [4, 8, 2, 6, 10]; const psorted = [2, 4, 6, 8, 10]; return {
                    problem: `Find the median: ${pdata.join(', ')}`, answer: "6",
                    options: ["4", "6", "8", "10"],
                    mistakeAnalysis: {
                        "4": `Sort first: ${psorted.join(', ')}. The MIDDLE (3rd) number is 6, not the 2nd.`,
                        "8": `Close! But with 5 numbers, the middle is the 3rd. Sorted: ${psorted.join(', ')}. Middle = 6`,
                        "10": "That's the last number when sorted. Middle of 2, 4, 6, 8, 10 is 6."
                    }}; })()
            };
        },
        "Unit Conversion": () => {
            const feet = rand(2, 5);
            const inches = feet * 12;
            return {
                concept: `<strong>Unit Conversion</strong> means changing measurements from one unit to another.<br><br>
                <strong>Key conversions to memorize:</strong><br>
                • <strong>Length:</strong> 1 foot = 12 inches, 1 yard = 3 feet, 1 mile = 5,280 feet<br>
                • <strong>Weight:</strong> 1 pound = 16 ounces, 1 ton = 2,000 pounds<br>
                • <strong>Volume:</strong> 1 gallon = 4 quarts, 1 quart = 2 pints, 1 pint = 2 cups<br><br>
                <strong>The Rule:</strong><br>
                • Bigger → Smaller units: <strong>MULTIPLY</strong> (more of the smaller unit)<br>
                • Smaller → Bigger units: <strong>DIVIDE</strong> (fewer of the bigger unit)`,
                example: { problem: `Convert 3 feet to inches`, steps: [
                    { text: "Find the conversion", math: "1 foot = 12 inches" },
                    { text: "Are we going bigger → smaller or smaller → bigger?", math: "Feet → inches = Bigger → Smaller = MULTIPLY" },
                    { text: "Multiply: 3 feet × 12 inches/foot", math: "3 × 12 = 36" },
                    { text: "Add the unit", math: "3 feet = <strong>36 inches</strong>" }
                ]},
                keyPoints: [
                    "Bigger → Smaller = MULTIPLY (feet to inches: more inches)",
                    "Smaller → Bigger = DIVIDE (inches to feet: fewer feet)",
                    "Always check: Does your answer make sense? More inches than feet!"
                ],
                mistakes: [
                    { wrong: "3 feet = 3 + 12 = 15 inches", why: "You MULTIPLY, not add! 3 × 12 = 36" },
                    { wrong: "Dividing when going to smaller units", why: "Smaller units = MORE of them. 3 feet is MANY inches, so multiply." },
                    { wrong: "Forgetting the conversion factor", why: "Memorize key ones: 12 in/ft, 16 oz/lb, 4 qt/gal" }
                ],
                guided: {
                    problem: `Convert ${feet} feet to inches`,
                    steps: [
                        { label: "Conversion factor", value: "1 foot = 12 inches" },
                        { label: "Going bigger → smaller, so", value: "MULTIPLY" },
                        { label: `${feet} feet × 12 =`, value: "?" }
                    ],
                    answer: String(inches),
                    answerLabel: "Inches:",
                    interactiveSteps: [
                        {
                            prompt: "How many inches are in 1 foot?",
                            hint: "Think of a ruler...",
                            answer: "12",
                            acceptableAnswers: ["12", "twelve", "12 inches"],
                            commonMistakes: {
                                "10": "It's 12 inches in a foot, not 10.",
                                "3": "That's feet in a yard. Inches in a foot = 12."
                            }
                        },
                        {
                            prompt: "We're converting from feet (bigger) to inches (smaller). Do we multiply or divide?",
                            hint: "Going to smaller units means we'll have MORE of them...",
                            answer: "multiply",
                            acceptableAnswers: ["multiply", "multiplication", "×", "times"],
                            commonMistakes: {
                                "divide": "Divide for bigger → smaller? No! Smaller units = more of them, so MULTIPLY.",
                                "add": "We need to multiply by the conversion factor, not add."
                            }
                        },
                        {
                            prompt: `Calculate: ${feet} feet × 12 inches/foot = ?`,
                            hint: `${feet} × 12 = ?`,
                            answer: String(inches),
                            acceptableAnswers: [String(inches), `${inches} inches`],
                            commonMistakes: {
                                [String(feet + 12)]: `You added! Multiply: ${feet} × 12 = ${inches}`,
                                [String(feet)]: `Don't forget to convert! ${feet} × 12 = ${inches}`
                            }
                        }
                    ]
                },
                practice: (() => { const lbs = 3; const oz = lbs * 16; return {
                    problem: `How many ounces are in ${lbs} pounds?`, answer: String(oz),
                    options: [String(lbs + 16), String(lbs * 8), String(oz), String(oz + 16)],
                    mistakeAnalysis: {
                        [String(lbs + 16)]: `You added instead of multiplied! ${lbs} × 16 = ${oz}`,
                        [String(lbs * 8)]: `Wrong conversion: 1 pound = 16 ounces (not 8). ${lbs} × 16 = ${oz}`,
                        [String(oz + 16)]: `Close, but check your multiplication: ${lbs} × 16 = ${oz}`
                    }}; })()
            };
        },
        "Basic Graphing": () => {
            const x = rand(1, 5), y = rand(1, 5);
            return {
                concept: `<strong>Coordinate Graphing</strong> uses ordered pairs (x, y) to locate points on a grid.<br><br>
                <strong>The coordinate plane:</strong><br>
                • <strong>x-axis:</strong> horizontal line (left-right) →<br>
                • <strong>y-axis:</strong> vertical line (up-down) ↑<br>
                • <strong>Origin:</strong> (0, 0) - where the axes cross<br><br>
                <strong>Reading coordinates (x, y):</strong><br>
                • <strong>x comes first:</strong> how far LEFT or RIGHT<br>
                • <strong>y comes second:</strong> how far UP or DOWN<br><br>
                <strong>The Four Quadrants:</strong><br>
                • Quadrant I: (+, +) upper right<br>
                • Quadrant II: (-, +) upper left<br>
                • Quadrant III: (-, -) lower left<br>
                • Quadrant IV: (+, -) lower right`,
                example: { problem: `Plot the point (3, 2) and identify its quadrant`, steps: [
                    { text: "Start at the origin (0, 0)", math: "This is where the x and y axes cross" },
                    { text: "x = 3: Move RIGHT 3 units", math: "→ → → (now at x = 3)" },
                    { text: "y = 2: Move UP 2 units", math: "↑ ↑ (now at y = 2)" },
                    { text: "Mark the point (3, 2)", math: "Both coordinates are positive → <strong>Quadrant I</strong>" }
                ]},
                keyPoints: [
                    "Remember: (x, y) - 'x' comes before 'y' in the alphabet!",
                    "x = horizontal (like the horizon), y = vertical",
                    "Positive x = right, Negative x = left, Positive y = up, Negative y = down"
                ],
                mistakes: [
                    { wrong: "Plotting (3, 2) by going up 3, right 2", why: "x comes FIRST! Go right 3, THEN up 2." },
                    { wrong: "Confusing (2, 5) and (5, 2)", why: "These are different points! (2, 5) is right 2, up 5. (5, 2) is right 5, up 2." },
                    { wrong: "Saying (-3, 4) is in Quadrant IV", why: "x is negative (left), y is positive (up) = Quadrant II" }
                ],
                guided: {
                    problem: `What are the coordinates of a point that is ${x} units right and ${y} units up from the origin?`,
                    steps: [
                        { label: "Right means positive x", value: `x = ${x}` },
                        { label: "Up means positive y", value: `y = ${y}` },
                        { label: "Write as (x, y)", value: "?" }
                    ],
                    answer: `(${x}, ${y})`,
                    answerLabel: "Coordinates:",
                    interactiveSteps: [
                        {
                            prompt: "In coordinates (x, y), which direction does x represent?",
                            hint: "x is horizontal, like the horizon...",
                            answer: "horizontal",
                            acceptableAnswers: ["horizontal", "left-right", "left right", "right-left"],
                            commonMistakes: {
                                "vertical": "x is HORIZONTAL (left-right). y is vertical (up-down).",
                                "up-down": "That's y! x is horizontal (left-right)."
                            }
                        },
                        {
                            prompt: `Moving ${x} units RIGHT means x is positive or negative?`,
                            hint: "Right is the positive direction on a number line...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "+", "plus"],
                            commonMistakes: {
                                "negative": "RIGHT is positive. LEFT would be negative."
                            }
                        },
                        {
                            prompt: `Moving ${y} units UP means y is positive or negative?`,
                            hint: "Up is like going higher on a number line...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "+", "plus"],
                            commonMistakes: {
                                "negative": "UP is positive. DOWN would be negative."
                            }
                        },
                        {
                            prompt: `So x = ${x} and y = ${y}. Write the coordinates in (x, y) format:`,
                            hint: "Put x first, then y, in parentheses...",
                            answer: `(${x}, ${y})`,
                            acceptableAnswers: [`(${x}, ${y})`, `(${x},${y})`, `${x}, ${y}`],
                            commonMistakes: {
                                [`(${y}, ${x})`]: "x comes FIRST! It's (x, y), not (y, x)."
                            }
                        }
                    ]
                },
                practice: { problem: `The point (-4, 3) is in which quadrant?`, answer: "II",
                    options: ["I", "II", "III", "IV"],
                    mistakeAnalysis: {
                        "I": "x is negative (-4), so we're on the LEFT side, not right. Left + up = Quadrant II",
                        "III": "y is positive (3), so we're UP, not down. Left + up = Quadrant II",
                        "IV": "Both conditions wrong: x is negative (left) and y is positive (up) = Quadrant II"
                    }}
            };
        },
        "Data Collection": () => ({
            concept: `<strong>Data Collection</strong> means gathering and organizing information.<br><br>
            <strong>Ways to collect data:</strong><br>
            • <strong>Surveys:</strong> Ask people questions<br>
            • <strong>Observations:</strong> Watch and record what happens<br>
            • <strong>Experiments:</strong> Test something and record results<br><br>
            <strong>Ways to organize data:</strong><br>
            • <strong>Tally marks:</strong> |||| = 4, <s>||||</s> = 5 (cross every 5)<br>
            • <strong>Frequency tables:</strong> List items and count them<br>
            • <strong>Bar graphs:</strong> Show amounts with bars<br>
            • <strong>Pictographs:</strong> Use pictures to represent data`,
            example: { problem: `A tally chart shows: Pizza ||||  |||, Burgers ||||  ||, Tacos ||||. What's the total surveyed?`, steps: [
                { text: "Count Pizza", math: "|||| ||| = 5 + 3 = 8" },
                { text: "Count Burgers", math: "|||| || = 5 + 2 = 7" },
                { text: "Count Tacos", math: "|||| = 5" },
                { text: "Add all categories", math: "8 + 7 + 5 = <strong>20 people surveyed</strong>" }
            ]},
            keyPoints: [
                "Tally groups of 5: ||||  means the 5th mark crosses through the first 4",
                "Total = add up ALL categories",
                "Labels are important - what does each tally represent?"
            ],
            mistakes: [
                { wrong: "Counting |||| as 4 instead of 5", why: "When you see 4 marks with a line through, that's 5!" },
                { wrong: "Forgetting to add all categories", why: "Make sure to count EVERY category in the data set" },
                { wrong: "Miscounting the extra marks after 5s", why: "Count groups of 5 first, then add remaining marks: ||||  ||| = 5 + 3 = 8" }
            ],
            guided: {
                problem: `Tally: Red |||| ||||, Blue |||| |||, Green ||||. How many total?`,
                steps: [
                    { label: "Red: |||| |||| =", value: "5 + 5 = 10" },
                    { label: "Blue: |||| ||| =", value: "5 + 3 = 8" },
                    { label: "Green: |||| =", value: "5" },
                    { label: "Total", value: "?" }
                ],
                answer: "23",
                answerLabel: "Total:",
                interactiveSteps: [
                    {
                        prompt: "In tally marks, what does |||| (4 marks with a line through) represent?",
                        hint: "The fifth mark crosses through the first four...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "4": "When a line crosses through 4 marks, it makes 5! |||| = 5"
                        }
                    },
                    {
                        prompt: "Count Red: |||| |||| (two groups of crossed tallies). How many?",
                        hint: "Each |||| = 5, so two groups is...",
                        answer: "10",
                        acceptableAnswers: ["10", "ten"],
                        commonMistakes: {
                            "8": "Each |||| = 5, not 4. So |||| |||| = 5 + 5 = 10",
                            "5": "There are TWO groups of 5: 5 + 5 = 10"
                        }
                    },
                    {
                        prompt: "Count Blue: |||| ||| (one crossed group plus 3 marks). How many?",
                        hint: "|||| = 5, plus ||| = 3 more...",
                        answer: "8",
                        acceptableAnswers: ["8", "eight"],
                        commonMistakes: {
                            "7": "|||| = 5 (not 4), plus 3 = 8",
                            "53": "Add them: 5 + 3 = 8"
                        }
                    },
                    {
                        prompt: "Count Green: |||| (one crossed group). How many?",
                        hint: "One group of crossed tallies...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "4": "|||| (with cross) = 5, not 4!"
                        }
                    },
                    {
                        prompt: "Now add all colors: Red (10) + Blue (8) + Green (5) = ?",
                        hint: "10 + 8 + 5 = ?",
                        answer: "23",
                        acceptableAnswers: ["23", "twenty-three"],
                        commonMistakes: {
                            "18": "Don't forget all three! 10 + 8 + 5 = 23",
                            "13": "You missed one color. 10 + 8 + 5 = 23"
                        }
                    }
                ]
            },
            practice: { problem: `Survey: 5 like pizza, 8 like burgers, 3 like tacos, 4 like salad. Total surveyed?`, answer: "20",
                options: ["16", "18", "20", "22"],
                mistakeAnalysis: {
                    "16": "You missed one category! Add ALL: 5 + 8 + 3 + 4 = 20",
                    "18": "Check your addition: 5 + 8 = 13, 13 + 3 = 16, 16 + 4 = 20",
                    "22": "Double-check: 5 + 8 + 3 + 4 = 20, not 22"
                }}
        }),
        Fractions: () => ({
            // Progressive sub-skills for T3 Fractions - students must master each before moving on
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Finding the LCD
                {
                    id: "lcd",
                    name: "Finding the LCD",
                    goalProblem: `Find the LCD (Least Common Denominator) of 1/3 and 1/4`,
                    teachingSteps: [
                        {
                            title: "Why do we need the LCD?",
                            explanation: "To add or subtract fractions with <strong>different denominators</strong>, we first need to rewrite them with the <strong>same denominator</strong>. The LCD is the smallest number that works for both.",
                            visual: "1/3 + 1/4 = ? (can't add yet - different denominators!)"
                        },
                        {
                            title: "What is the LCD?",
                            explanation: "The <strong>Least Common Denominator</strong> is the smallest number that BOTH denominators divide into evenly. It's the LCM (Least Common Multiple) of the denominators.",
                            visual: "LCD of 3 and 4 = smallest number divisible by BOTH 3 and 4"
                        },
                        {
                            title: "Method 1: List multiples",
                            explanation: "List multiples of each denominator until you find a match:<br>• Multiples of 3: 3, 6, 9, <strong>12</strong>, 15, 18...<br>• Multiples of 4: 4, 8, <strong>12</strong>, 16, 20...<br>The first match is 12!",
                            visual: "3 × 4 = 12 ✓   |   4 × 3 = 12 ✓"
                        },
                        {
                            title: "Method 2: Check if one divides the other",
                            explanation: "If the larger denominator is already a multiple of the smaller, use it!<br>Example: LCD of 2 and 6? → 6 (because 6 ÷ 2 = 3 ✓)",
                            visual: "6 ÷ 2 = 3 (no remainder) → LCD = 6"
                        },
                        {
                            title: "Applying the LCD",
                            explanation: "Once you find the LCD, multiply each fraction's numerator AND denominator by the number needed to reach the LCD:<br>1/3 = 4/12 (multiply by 4)<br>1/4 = 3/12 (multiply by 3)",
                            visual: "1/3 × 4/4 = 4/12   |   1/4 × 3/3 = 3/12"
                        }
                    ],
                    finalAnswer: "12",
                    answerExplanation: "12 is the LCD because it's the smallest number that both 3 and 4 divide into evenly: 12 ÷ 3 = 4 ✓ and 12 ÷ 4 = 3 ✓",
                    example: { problem: `Find the LCD of 1/3 and 1/4`, steps: [
                        { text: "List multiples of 3", math: "3, 6, 9, 12, 15..." },
                        { text: "List multiples of 4", math: "4, 8, 12, 16..." },
                        { text: "Find smallest common multiple", math: "12 appears in both lists → <strong>LCD = 12</strong>" }
                    ]},
                    keyPoints: [
                        "LCD = smallest number divisible by BOTH denominators",
                        "Method 1: List multiples until you find a match",
                        "Method 2: Multiply the denominators (works but may not give smallest)",
                        "If one denominator divides the other, use the larger one"
                    ],
                    mistakes: [
                        { wrong: "Using the product when a smaller LCD exists", why: "2 × 6 = 12, but LCD of 2 and 6 is just 6 (since 6 ÷ 2 = 3)" },
                        { wrong: "Picking a number that only one denominator divides", why: "Check BOTH: LCD must be divisible by BOTH denominators" }
                    ],
                    guided: {
                        problem: `Find the LCD of 2/5 and 3/10`,
                        steps: [
                            { label: "Multiples of 5", value: "5, 10, 15, 20..." },
                            { label: "Multiples of 10", value: "10, 20, 30..." },
                            { label: "LCD is", value: "?" }
                        ],
                        answer: "10",
                        answerLabel: "LCD:",
                        interactiveSteps: [
                            {
                                prompt: "First, let's check: does 10 ÷ 5 divide evenly?",
                                hint: "10 ÷ 5 = ?",
                                answer: "yes",
                                acceptableAnswers: ["yes", "2", "yeah"],
                                formatHint: "yes or no",
                                commonMistakes: {
                                    "no": "10 ÷ 5 = 2 exactly. Yes, it divides evenly!"
                                }
                            },
                            {
                                prompt: "Since 10 is a multiple of 5, what is the LCD?",
                                hint: "When one denominator divides the other evenly, the larger one IS the LCD",
                                answer: "10",
                                acceptableAnswers: ["10", "ten"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "50": "50 works, but 10 is smaller and still works! LCD = 10",
                                    "5": "5 doesn't work because 10 ÷ 5 ≠ whole number going backwards"
                                }
                            },
                            {
                                prompt: "Verify: Does 10 ÷ 5 = whole number AND 10 ÷ 10 = whole number?",
                                hint: "10 ÷ 5 = 2 ✓ and 10 ÷ 10 = 1 ✓",
                                answer: "yes",
                                acceptableAnswers: ["yes", "yeah", "both work"],
                                formatHint: "yes or no",
                                commonMistakes: {
                                    "no": "10 ÷ 5 = 2 and 10 ÷ 10 = 1. Both are whole numbers!"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is the LCD of 1/6 and 1/8?`, answer: "24",
                        options: ["14", "24", "48", "6"],
                        mistakeAnalysis: {
                            "14": "14 is 6 + 8. We need a MULTIPLE of both, not their sum.",
                            "48": "48 works (6 × 8), but 24 is smaller: 24 ÷ 6 = 4 ✓, 24 ÷ 8 = 3 ✓",
                            "6": "8 doesn't divide evenly into 6. We need a number divisible by BOTH."
                        }}
                },

                // Sub-skill 2: Adding Fractions with Different Denominators
                {
                    id: "add_different_denom",
                    name: "Adding Fractions (Different Denominators)",
                    goalProblem: `What is 1/3 + 1/4?`,
                    teachingSteps: [
                        {
                            title: "The problem with different denominators",
                            explanation: "You <strong>cannot add fractions directly</strong> when denominators are different. 1/3 + 1/4 ≠ 2/7! The pieces are different sizes.",
                            visual: "🍕/3 + 🍕/4 ≠ 🍕🍕/7 (wrong!)"
                        },
                        {
                            title: "Step 1: Find the LCD",
                            explanation: "First, find the <strong>Least Common Denominator</strong>. For 3 and 4:<br>Multiples of 3: 3, 6, 9, <strong>12</strong><br>Multiples of 4: 4, 8, <strong>12</strong><br>LCD = 12",
                            visual: "LCD(3, 4) = 12"
                        },
                        {
                            title: "Step 2: Convert each fraction to LCD",
                            explanation: "Multiply numerator AND denominator by the same number to get the LCD:<br>• 1/3: multiply by 4/4 → <strong>4/12</strong><br>• 1/4: multiply by 3/3 → <strong>3/12</strong>",
                            visual: "1/3 = 4/12   |   1/4 = 3/12"
                        },
                        {
                            title: "Step 3: Add the numerators",
                            explanation: "Now that denominators match, just <strong>add the numerators</strong>. Keep the denominator the same!<br>4/12 + 3/12 = <strong>7/12</strong>",
                            visual: "4/12 + 3/12 = 7/12"
                        },
                        {
                            title: "Step 4: Simplify if needed",
                            explanation: "Check if the answer can be simplified. 7/12: GCF of 7 and 12 is 1, so <strong>7/12 is already simplified</strong>!",
                            visual: "7/12 ← already in lowest terms ✓"
                        }
                    ],
                    finalAnswer: "7/12",
                    answerExplanation: "Find LCD (12), convert (1/3 = 4/12, 1/4 = 3/12), add numerators (4 + 3 = 7), keep denominator: 7/12",
                    example: { problem: `What is 1/3 + 1/4?`, steps: [
                        { text: "Find the LCD", math: "LCD of 3 and 4 = 12" },
                        { text: "Convert 1/3", math: "1/3 × 4/4 = 4/12" },
                        { text: "Convert 1/4", math: "1/4 × 3/3 = 3/12" },
                        { text: "Add numerators", math: "4/12 + 3/12 = <strong>7/12</strong>" }
                    ]},
                    keyPoints: [
                        "NEVER add denominators! 1/3 + 1/4 ≠ 2/7",
                        "Find LCD first, then convert both fractions",
                        "Add only the numerators, keep the LCD as denominator",
                        "Always simplify your final answer if possible"
                    ],
                    mistakes: [
                        { wrong: "Adding both numerators AND denominators: 1/3 + 1/4 = 2/7", why: "This is the #1 mistake! You can only add numerators AFTER finding a common denominator." },
                        { wrong: "Forgetting to convert both fractions", why: "Both fractions must have the LCD as their denominator before adding." },
                        { wrong: "Multiplying only numerator, not denominator", why: "Multiply BOTH by the same number to keep the fraction equivalent." }
                    ],
                    guided: {
                        problem: `Calculate: 2/5 + 1/3`,
                        steps: [
                            { label: "LCD of 5 and 3", value: "15" },
                            { label: "Convert 2/5", value: "?/15" },
                            { label: "Convert 1/3", value: "?/15" },
                            { label: "Add", value: "?" }
                        ],
                        answer: "11/15",
                        answerLabel: "Sum:",
                        interactiveSteps: [
                            {
                                prompt: "What is the LCD of 5 and 3?",
                                hint: "Multiples of 5: 5, 10, 15... Multiples of 3: 3, 6, 9, 12, 15...",
                                answer: "15",
                                acceptableAnswers: ["15", "fifteen"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "8": "8 is 5 + 3. We need a number divisible by BOTH.",
                                    "53": "Try listing multiples. 15 is the smallest common multiple."
                                }
                            },
                            {
                                prompt: "To convert 2/5 to fifteenths: 5 × ? = 15",
                                hint: "What do you multiply 5 by to get 15?",
                                answer: "3",
                                acceptableAnswers: ["3", "three"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "10": "5 × 10 = 50, not 15. We need 5 × 3 = 15."
                                }
                            },
                            {
                                prompt: "So 2/5 = ?/15 (multiply top and bottom by 3)",
                                hint: "2 × 3 = ?",
                                answer: "6/15",
                                acceptableAnswers: ["6/15", "6", "6 / 15"],
                                formatHint: "e.g., 6/15",
                                commonMistakes: {
                                    "2/15": "You must multiply the numerator too! 2 × 3 = 6"
                                }
                            },
                            {
                                prompt: "To convert 1/3 to fifteenths: 3 × ? = 15, so 1/3 = ?/15",
                                hint: "3 × 5 = 15, so multiply numerator by 5 too",
                                answer: "5/15",
                                acceptableAnswers: ["5/15", "5", "5 / 15"],
                                formatHint: "e.g., 5/15",
                                commonMistakes: {
                                    "1/15": "Multiply the numerator too! 1 × 5 = 5"
                                }
                            },
                            {
                                prompt: "Now add: 6/15 + 5/15 = ?",
                                hint: "Add numerators, keep denominator: (6 + 5)/15",
                                answer: "11/15",
                                acceptableAnswers: ["11/15", "11 / 15"],
                                formatHint: "e.g., 11/15",
                                commonMistakes: {
                                    "11/30": "Don't add denominators! Keep 15 as the denominator.",
                                    "6/15": "You forgot to add! 6 + 5 = 11"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 1/2 + 2/3?`, answer: "7/6",
                        options: ["3/5", "7/6", "3/6", "1/6"],
                        mistakeAnalysis: {
                            "3/5": "You added numerators AND denominators. Find LCD first!",
                            "3/6": "LCD = 6. 1/2 = 3/6, 2/3 = 4/6. 3/6 + 4/6 = 7/6",
                            "1/6": "Check your conversion. 1/2 = 3/6 and 2/3 = 4/6"
                        }}
                },

                // Sub-skill 3: Subtracting Fractions with Different Denominators
                {
                    id: "subtract_different_denom",
                    name: "Subtracting Fractions (Different Denominators)",
                    goalProblem: `What is 3/4 - 1/3?`,
                    teachingSteps: [
                        {
                            title: "Same process as addition!",
                            explanation: "Subtracting fractions follows the <strong>exact same steps</strong> as adding - just subtract at the end instead of add.",
                            visual: "Add: find LCD, convert, add numerators<br>Subtract: find LCD, convert, subtract numerators"
                        },
                        {
                            title: "Step 1: Find the LCD",
                            explanation: "For 4 and 3:<br>Multiples of 4: 4, 8, <strong>12</strong><br>Multiples of 3: 3, 6, 9, <strong>12</strong><br>LCD = 12",
                            visual: "LCD(4, 3) = 12"
                        },
                        {
                            title: "Step 2: Convert each fraction",
                            explanation: "• 3/4: multiply by 3/3 → <strong>9/12</strong><br>• 1/3: multiply by 4/4 → <strong>4/12</strong>",
                            visual: "3/4 = 9/12   |   1/3 = 4/12"
                        },
                        {
                            title: "Step 3: Subtract the numerators",
                            explanation: "Now subtract: 9/12 - 4/12 = <strong>5/12</strong><br>Keep the denominator!",
                            visual: "9/12 - 4/12 = 5/12"
                        },
                        {
                            title: "Step 4: Simplify if needed",
                            explanation: "5 and 12 share no common factors, so <strong>5/12 is simplified</strong>.",
                            visual: "5/12 ← already in lowest terms ✓"
                        }
                    ],
                    finalAnswer: "5/12",
                    answerExplanation: "LCD = 12. Convert: 3/4 = 9/12, 1/3 = 4/12. Subtract: 9 - 4 = 5. Answer: 5/12",
                    example: { problem: `What is 3/4 - 1/3?`, steps: [
                        { text: "Find the LCD", math: "LCD of 4 and 3 = 12" },
                        { text: "Convert 3/4", math: "3/4 × 3/3 = 9/12" },
                        { text: "Convert 1/3", math: "1/3 × 4/4 = 4/12" },
                        { text: "Subtract numerators", math: "9/12 - 4/12 = <strong>5/12</strong>" }
                    ]},
                    keyPoints: [
                        "Same steps as addition: LCD → Convert → Subtract",
                        "Only subtract numerators, keep denominator the same",
                        "Make sure first fraction converts to larger numerator!",
                        "Simplify your answer"
                    ],
                    mistakes: [
                        { wrong: "Subtracting denominators too: 3/4 - 1/3 = 2/1", why: "NEVER subtract denominators. Convert to LCD first, then subtract only numerators." },
                        { wrong: "Subtracting smaller from larger numerator after conversion", why: "Keep the order! If you're solving a - b, subtract b's new numerator from a's." }
                    ],
                    guided: {
                        problem: `Calculate: 5/6 - 1/4`,
                        steps: [
                            { label: "LCD of 6 and 4", value: "12" },
                            { label: "Convert 5/6", value: "?/12" },
                            { label: "Convert 1/4", value: "?/12" },
                            { label: "Subtract", value: "?" }
                        ],
                        answer: "7/12",
                        answerLabel: "Difference:",
                        interactiveSteps: [
                            {
                                prompt: "What is the LCD of 6 and 4?",
                                hint: "Multiples of 6: 6, 12... Multiples of 4: 4, 8, 12...",
                                answer: "12",
                                acceptableAnswers: ["12", "twelve"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "24": "24 works, but 12 is smaller. 12 ÷ 6 = 2 ✓, 12 ÷ 4 = 3 ✓"
                                }
                            },
                            {
                                prompt: "Convert 5/6 to twelfths: 6 × 2 = 12, so 5/6 = ?/12",
                                hint: "Multiply both parts by 2: 5 × 2 = ?",
                                answer: "10/12",
                                acceptableAnswers: ["10/12", "10", "10 / 12"],
                                formatHint: "e.g., 10/12",
                                commonMistakes: {
                                    "5/12": "Multiply the numerator too! 5 × 2 = 10"
                                }
                            },
                            {
                                prompt: "Convert 1/4 to twelfths: 4 × 3 = 12, so 1/4 = ?/12",
                                hint: "Multiply both parts by 3: 1 × 3 = ?",
                                answer: "3/12",
                                acceptableAnswers: ["3/12", "3", "3 / 12"],
                                formatHint: "e.g., 3/12",
                                commonMistakes: {
                                    "1/12": "Multiply the numerator too! 1 × 3 = 3"
                                }
                            },
                            {
                                prompt: "Now subtract: 10/12 - 3/12 = ?",
                                hint: "Subtract numerators: 10 - 3 = ?",
                                answer: "7/12",
                                acceptableAnswers: ["7/12", "7 / 12"],
                                formatHint: "e.g., 7/12",
                                commonMistakes: {
                                    "7/0": "Keep the denominator 12! Only subtract numerators.",
                                    "13/12": "We're subtracting, not adding! 10 - 3 = 7"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 2/3 - 1/4?`, answer: "5/12",
                        options: ["1/1", "5/12", "1/7", "8/12"],
                        mistakeAnalysis: {
                            "1/1": "You subtracted both parts. Only subtract numerators after finding LCD!",
                            "1/7": "You subtracted numerators AND denominators. Find LCD first!",
                            "8/12": "LCD = 12. 2/3 = 8/12, 1/4 = 3/12. Now SUBTRACT: 8 - 3 = 5"
                        }}
                },

                // Sub-skill 4: Multiplying Fractions
                {
                    id: "multiply",
                    name: "Multiplying Fractions",
                    goalProblem: `What is 2/3 × 3/4?`,
                    teachingSteps: [
                        {
                            title: "Good news: Multiplication is easier!",
                            explanation: "Unlike adding/subtracting, you do <strong>NOT need a common denominator</strong> to multiply fractions. Just multiply straight across!",
                            visual: "No LCD needed! 🎉"
                        },
                        {
                            title: "The simple rule",
                            explanation: "<strong>Multiply numerators together</strong><br><strong>Multiply denominators together</strong><br>That's it!",
                            visual: "a/b × c/d = (a×c)/(b×d)"
                        },
                        {
                            title: "Apply it: 2/3 × 3/4",
                            explanation: "Numerators: 2 × 3 = <strong>6</strong><br>Denominators: 3 × 4 = <strong>12</strong><br>Result: 6/12",
                            visual: "2/3 × 3/4 = (2×3)/(3×4) = 6/12"
                        },
                        {
                            title: "Simplify the answer",
                            explanation: "6/12 can be simplified! GCF of 6 and 12 is 6.<br>6 ÷ 6 = 1, 12 ÷ 6 = 2<br>Answer: <strong>1/2</strong>",
                            visual: "6/12 = 1/2"
                        },
                        {
                            title: "Pro tip: Cross-cancel BEFORE multiplying",
                            explanation: "You can simplify diagonally before multiplying:<br>2/3 × 3/4 → The 3s cancel!<br>2/1 × 1/4 = 2/4 = 1/2",
                            visual: "2/3̶ × 3̶/4 = 2/4 = 1/2 (faster!)"
                        }
                    ],
                    finalAnswer: "1/2",
                    answerExplanation: "2/3 × 3/4 = 6/12 = 1/2. Or cross-cancel: the 3s cancel, leaving 2/4 = 1/2",
                    example: { problem: `What is 2/3 × 3/4?`, steps: [
                        { text: "Multiply numerators", math: "2 × 3 = 6" },
                        { text: "Multiply denominators", math: "3 × 4 = 12" },
                        { text: "Write the fraction", math: "6/12" },
                        { text: "Simplify", math: "6/12 = <strong>1/2</strong>" }
                    ]},
                    keyPoints: [
                        "Multiply straight across: top × top, bottom × bottom",
                        "NO common denominator needed!",
                        "Cross-cancel before multiplying to make numbers smaller",
                        "Always simplify your final answer"
                    ],
                    mistakes: [
                        { wrong: "Finding LCD first", why: "You don't need LCD for multiplication! Just multiply across." },
                        { wrong: "Adding instead of multiplying", why: "× means multiply: 2/3 × 3/4 = 6/12, not 5/7" },
                        { wrong: "Only multiplying numerators or only denominators", why: "Multiply BOTH: numerators AND denominators" }
                    ],
                    guided: {
                        problem: `Calculate: 3/5 × 2/3`,
                        steps: [
                            { label: "Multiply numerators", value: "3 × 2 = ?" },
                            { label: "Multiply denominators", value: "5 × 3 = ?" },
                            { label: "Simplify", value: "?" }
                        ],
                        answer: "2/5",
                        answerLabel: "Product:",
                        interactiveSteps: [
                            {
                                prompt: "Multiply the numerators: 3 × 2 = ?",
                                hint: "Top × top",
                                answer: "6",
                                acceptableAnswers: ["6", "six"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "5": "That's addition. 3 × 2 = 6"
                                }
                            },
                            {
                                prompt: "Multiply the denominators: 5 × 3 = ?",
                                hint: "Bottom × bottom",
                                answer: "15",
                                acceptableAnswers: ["15", "fifteen"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "8": "That's addition. 5 × 3 = 15"
                                }
                            },
                            {
                                prompt: "So 3/5 × 2/3 = 6/15. Can this be simplified?",
                                hint: "What number divides both 6 and 15?",
                                answer: "yes",
                                acceptableAnswers: ["yes", "yeah", "3"],
                                formatHint: "yes or no",
                                commonMistakes: {
                                    "no": "Both 6 and 15 are divisible by 3!"
                                }
                            },
                            {
                                prompt: "Divide both by 3: 6÷3 / 15÷3 = ?",
                                hint: "6 ÷ 3 = 2, 15 ÷ 3 = 5",
                                answer: "2/5",
                                acceptableAnswers: ["2/5", "2 / 5"],
                                formatHint: "e.g., 2/5",
                                commonMistakes: {
                                    "6/15": "That's not simplified! Divide both by 3."
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 4/5 × 5/8?`, answer: "1/2",
                        options: ["20/40", "1/2", "9/13", "4/8"],
                        mistakeAnalysis: {
                            "20/40": "Correct multiplication, but simplify! 20/40 = 1/2",
                            "9/13": "You added instead of multiplied. Multiply across!",
                            "4/8": "You canceled incorrectly. 4×5=20, 5×8=40, then simplify to 1/2"
                        }}
                },

                // Sub-skill 5: Dividing Fractions
                {
                    id: "divide",
                    name: "Dividing Fractions",
                    goalProblem: `What is 3/4 ÷ 2/5?`,
                    teachingSteps: [
                        {
                            title: "The magic trick: Keep-Change-Flip",
                            explanation: "Dividing by a fraction = multiplying by its <strong>reciprocal</strong> (flipped version).<br>Remember: <strong>Keep</strong> the first, <strong>Change</strong> ÷ to ×, <strong>Flip</strong> the second!",
                            visual: "Keep → Change → Flip (KCF)"
                        },
                        {
                            title: "What's a reciprocal?",
                            explanation: "The <strong>reciprocal</strong> of a fraction is when you flip it upside down:<br>• Reciprocal of 2/5 is <strong>5/2</strong><br>• Reciprocal of 3 is <strong>1/3</strong> (think of 3 as 3/1)",
                            visual: "2/5 → flip → 5/2"
                        },
                        {
                            title: "Apply KCF to 3/4 ÷ 2/5",
                            explanation: "<strong>Keep</strong> 3/4<br><strong>Change</strong> ÷ to ×<br><strong>Flip</strong> 2/5 to 5/2<br>Result: 3/4 × 5/2",
                            visual: "3/4 ÷ 2/5 → 3/4 × 5/2"
                        },
                        {
                            title: "Now multiply!",
                            explanation: "3/4 × 5/2:<br>Numerators: 3 × 5 = 15<br>Denominators: 4 × 2 = 8<br>Answer: <strong>15/8</strong>",
                            visual: "3/4 × 5/2 = 15/8"
                        },
                        {
                            title: "Convert if needed",
                            explanation: "15/8 is an improper fraction. As a mixed number:<br>15 ÷ 8 = 1 remainder 7<br>Answer: <strong>1 7/8</strong> or <strong>15/8</strong>",
                            visual: "15/8 = 1 7/8"
                        }
                    ],
                    finalAnswer: "15/8 or 1 7/8",
                    answerExplanation: "Keep 3/4, change ÷ to ×, flip 2/5 to 5/2. Then multiply: 3×5=15, 4×2=8. Answer: 15/8",
                    example: { problem: `What is 3/4 ÷ 2/5?`, steps: [
                        { text: "Keep the first fraction", math: "3/4" },
                        { text: "Change ÷ to ×", math: "3/4 ×" },
                        { text: "Flip the second fraction", math: "3/4 × 5/2" },
                        { text: "Multiply across", math: "15/8 = <strong>1 7/8</strong>" }
                    ]},
                    keyPoints: [
                        "Keep-Change-Flip: Keep first, change ÷ to ×, flip second",
                        "Reciprocal = flip the fraction upside down",
                        "After flipping, it becomes a multiplication problem!",
                        "Simplify or convert to mixed number if needed"
                    ],
                    mistakes: [
                        { wrong: "Flipping the wrong fraction", why: "Keep the FIRST fraction. Flip the SECOND one (the divisor)." },
                        { wrong: "Forgetting to change the operation", why: "After flipping, you MULTIPLY (not divide)!" },
                        { wrong: "Flipping both fractions", why: "Only flip the second fraction (the one you're dividing by)." }
                    ],
                    guided: {
                        problem: `Calculate: 2/3 ÷ 4/5`,
                        steps: [
                            { label: "Keep", value: "2/3" },
                            { label: "Change", value: "÷ → ×" },
                            { label: "Flip", value: "4/5 → ?" },
                            { label: "Multiply", value: "?" }
                        ],
                        answer: "5/6",
                        answerLabel: "Quotient:",
                        interactiveSteps: [
                            {
                                prompt: "In 2/3 ÷ 4/5, which fraction do we KEEP (don't change)?",
                                hint: "We keep the FIRST fraction...",
                                answer: "2/3",
                                acceptableAnswers: ["2/3", "2 / 3", "the first"],
                                formatHint: "Enter the fraction",
                                commonMistakes: {
                                    "4/5": "That's the second fraction. We KEEP the first (2/3) and FLIP the second."
                                }
                            },
                            {
                                prompt: "What is the reciprocal (flip) of 4/5?",
                                hint: "Flip it upside down: numerator becomes denominator",
                                answer: "5/4",
                                acceptableAnswers: ["5/4", "5 / 4"],
                                formatHint: "e.g., 5/4",
                                commonMistakes: {
                                    "4/5": "That's the original. FLIP it: 4/5 → 5/4"
                                }
                            },
                            {
                                prompt: "Now we have 2/3 × 5/4. Multiply the numerators: 2 × 5 = ?",
                                hint: "Top × top",
                                answer: "10",
                                acceptableAnswers: ["10", "ten"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "7": "That's addition. 2 × 5 = 10"
                                }
                            },
                            {
                                prompt: "Multiply the denominators: 3 × 4 = ?",
                                hint: "Bottom × bottom",
                                answer: "12",
                                acceptableAnswers: ["12", "twelve"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "So 2/3 ÷ 4/5 = 10/12. Simplify this fraction.",
                                hint: "Both 10 and 12 are divisible by 2",
                                answer: "5/6",
                                acceptableAnswers: ["5/6", "5 / 6"],
                                formatHint: "e.g., 5/6",
                                commonMistakes: {
                                    "10/12": "Simplify! 10÷2 = 5, 12÷2 = 6 → 5/6"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 1/2 ÷ 3/4?`, answer: "2/3",
                        options: ["3/8", "2/3", "4/6", "1/6"],
                        mistakeAnalysis: {
                            "3/8": "You multiplied without flipping. Flip 3/4 to 4/3, then multiply!",
                            "4/6": "Correct math! But simplify: 4/6 = 2/3",
                            "1/6": "Check your work: 1/2 × 4/3 = 4/6 = 2/3"
                        }}
                },

                // Sub-skill 6: Adding Mixed Numbers
                {
                    id: "mixed_add",
                    name: "Adding Mixed Numbers",
                    goalProblem: `What is 2 1/3 + 1 1/2?`,
                    teachingSteps: [
                        {
                            title: "Two methods for adding mixed numbers",
                            explanation: "You can either:<br>1. Add whole numbers and fractions separately<br>2. Convert to improper fractions, add, convert back<br>Let's learn both!",
                            visual: "Method 1: Parts | Method 2: Improper"
                        },
                        {
                            title: "Method 1: Add parts separately",
                            explanation: "Add the whole numbers: 2 + 1 = <strong>3</strong><br>Add the fractions: 1/3 + 1/2 = ?<br>Find LCD (6): 2/6 + 3/6 = <strong>5/6</strong><br>Combine: <strong>3 5/6</strong>",
                            visual: "(2 + 1) + (1/3 + 1/2) = 3 + 5/6 = 3 5/6"
                        },
                        {
                            title: "What if fractions add to more than 1?",
                            explanation: "If 2 3/4 + 1 1/2:<br>Wholes: 2 + 1 = 3<br>Fractions: 3/4 + 2/4 = 5/4 = 1 1/4<br>Regroup: 3 + 1 1/4 = <strong>4 1/4</strong>",
                            visual: "3 + 5/4 = 3 + 1 1/4 = 4 1/4"
                        },
                        {
                            title: "Method 2: Convert to improper fractions",
                            explanation: "2 1/3 = 7/3 (2×3+1=7)<br>1 1/2 = 3/2 (1×2+1=3)<br>Find LCD (6): 14/6 + 9/6 = 23/6<br>Convert back: 23 ÷ 6 = <strong>3 5/6</strong>",
                            visual: "7/3 + 3/2 = 14/6 + 9/6 = 23/6 = 3 5/6"
                        },
                        {
                            title: "Both methods give the same answer!",
                            explanation: "Use whichever method feels more comfortable. Method 1 is often faster for simpler problems. Method 2 is more reliable when fractions get tricky.",
                            visual: "2 1/3 + 1 1/2 = 3 5/6 ✓"
                        }
                    ],
                    finalAnswer: "3 5/6",
                    answerExplanation: "Wholes: 2+1=3. Fractions: 1/3+1/2 = 2/6+3/6 = 5/6. Combined: 3 5/6",
                    example: { problem: `What is 2 1/3 + 1 1/2?`, steps: [
                        { text: "Add whole numbers", math: "2 + 1 = 3" },
                        { text: "Find LCD for fractions", math: "LCD of 3 and 2 = 6" },
                        { text: "Convert and add fractions", math: "2/6 + 3/6 = 5/6" },
                        { text: "Combine", math: "3 + 5/6 = <strong>3 5/6</strong>" }
                    ]},
                    keyPoints: [
                        "Method 1: Add wholes and fractions separately",
                        "If fraction sum > 1, carry over to whole number",
                        "Method 2: Convert all to improper, add, convert back",
                        "Always simplify and check for regrouping"
                    ],
                    mistakes: [
                        { wrong: "Adding whole numbers to numerators", why: "Whole numbers and fractions are separate! Add wholes to wholes, fractions to fractions." },
                        { wrong: "Forgetting to regroup when fraction sum > 1", why: "5/4 = 1 1/4. Don't leave improper fractions in your answer!" },
                        { wrong: "Forgetting LCD for the fraction parts", why: "You still need LCD when adding the fraction parts!" }
                    ],
                    guided: {
                        problem: `Calculate: 1 2/5 + 2 1/2`,
                        steps: [
                            { label: "Add whole numbers", value: "1 + 2 = 3" },
                            { label: "LCD of 5 and 2", value: "10" },
                            { label: "Add fractions", value: "?/10 + ?/10 = ?" },
                            { label: "Final answer", value: "?" }
                        ],
                        answer: "3 9/10",
                        answerLabel: "Sum:",
                        interactiveSteps: [
                            {
                                prompt: "Add the whole numbers: 1 + 2 = ?",
                                hint: "Simple addition of whole numbers",
                                answer: "3",
                                acceptableAnswers: ["3", "three"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "What is the LCD of 5 and 2?",
                                hint: "Multiples of 5: 5, 10... Multiples of 2: 2, 4, 6, 8, 10...",
                                answer: "10",
                                acceptableAnswers: ["10", "ten"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "7": "That's 5 + 2. We need the smallest number divisible by BOTH."
                                }
                            },
                            {
                                prompt: "Convert 2/5 to tenths: 2/5 = ?/10",
                                hint: "5 × 2 = 10, so multiply numerator by 2 also",
                                answer: "4/10",
                                acceptableAnswers: ["4/10", "4", "4 / 10"],
                                formatHint: "e.g., 4/10",
                                commonMistakes: {
                                    "2/10": "Multiply numerator too! 2 × 2 = 4"
                                }
                            },
                            {
                                prompt: "Convert 1/2 to tenths: 1/2 = ?/10",
                                hint: "2 × 5 = 10, so multiply numerator by 5 also",
                                answer: "5/10",
                                acceptableAnswers: ["5/10", "5", "5 / 10"],
                                formatHint: "e.g., 5/10",
                                commonMistakes: {
                                    "1/10": "Multiply numerator too! 1 × 5 = 5"
                                }
                            },
                            {
                                prompt: "Add the fractions: 4/10 + 5/10 = ?",
                                hint: "Add numerators, keep denominator",
                                answer: "9/10",
                                acceptableAnswers: ["9/10", "9 / 10"],
                                formatHint: "e.g., 9/10",
                                commonMistakes: {
                                    "9/20": "Don't add denominators! Keep 10."
                                }
                            },
                            {
                                prompt: "Combine: 3 + 9/10 = ?",
                                hint: "Put the whole number with the fraction",
                                answer: "3 9/10",
                                acceptableAnswers: ["3 9/10", "3-9/10", "3 and 9/10"],
                                formatHint: "e.g., 3 9/10",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `What is 2 3/4 + 1 1/2?`, answer: "4 1/4",
                        options: ["3 4/6", "4 1/4", "3 5/4", "4 1/2"],
                        mistakeAnalysis: {
                            "3 4/6": "Check LCD and regrouping. 3/4 + 2/4 = 5/4 = 1 1/4. Total: 3 + 1 1/4 = 4 1/4",
                            "3 5/4": "5/4 is improper! Convert: 5/4 = 1 1/4, so 3 + 1 1/4 = 4 1/4",
                            "4 1/2": "Check your fraction addition: 3/4 + 2/4 = 5/4 = 1 1/4"
                        }}
                },

                // Sub-skill 7: Subtracting Mixed Numbers
                {
                    id: "mixed_subtract",
                    name: "Subtracting Mixed Numbers",
                    goalProblem: `What is 3 1/4 - 1 2/3?`,
                    teachingSteps: [
                        {
                            title: "Two methods (same as adding)",
                            explanation: "1. Subtract parts separately (may need borrowing)<br>2. Convert to improper fractions, subtract, convert back<br>Borrowing makes Method 2 often easier!",
                            visual: "Method 1: Parts (borrowing) | Method 2: Improper"
                        },
                        {
                            title: "Method 2 for 3 1/4 - 1 2/3",
                            explanation: "Convert to improper:<br>3 1/4 = 13/4 (3×4+1=13)<br>1 2/3 = 5/3 (1×3+2=5)",
                            visual: "3 1/4 = 13/4, 1 2/3 = 5/3"
                        },
                        {
                            title: "Find LCD and subtract",
                            explanation: "LCD of 4 and 3 = 12<br>13/4 = 39/12 (×3)<br>5/3 = 20/12 (×4)<br>39/12 - 20/12 = <strong>19/12</strong>",
                            visual: "39/12 - 20/12 = 19/12"
                        },
                        {
                            title: "Convert back to mixed number",
                            explanation: "19 ÷ 12 = 1 remainder 7<br>Answer: <strong>1 7/12</strong>",
                            visual: "19/12 = 1 7/12"
                        },
                        {
                            title: "Method 1 with borrowing (alternative)",
                            explanation: "If fraction being subtracted is larger, borrow 1 from whole number:<br>3 1/4 = 2 + 1 + 1/4 = 2 + 4/4 + 1/4 = 2 5/4<br>Now subtract: 2 5/4 - 1 2/3...",
                            visual: "Borrow: 3 1/4 → 2 5/4"
                        }
                    ],
                    finalAnswer: "1 7/12",
                    answerExplanation: "Convert: 13/4 and 5/3. LCD=12: 39/12 - 20/12 = 19/12 = 1 7/12",
                    example: { problem: `What is 3 1/4 - 1 2/3?`, steps: [
                        { text: "Convert to improper", math: "3 1/4 = 13/4, 1 2/3 = 5/3" },
                        { text: "Find LCD", math: "LCD of 4 and 3 = 12" },
                        { text: "Convert and subtract", math: "39/12 - 20/12 = 19/12" },
                        { text: "Convert to mixed", math: "19/12 = <strong>1 7/12</strong>" }
                    ]},
                    keyPoints: [
                        "Method 2 (improper fractions) avoids borrowing complications",
                        "If using Method 1 and need to subtract larger fraction, borrow from whole",
                        "Borrowing: take 1 from whole, add denominator/denominator to fraction",
                        "Always simplify and convert improper fractions in answer"
                    ],
                    mistakes: [
                        { wrong: "Subtracting smaller from larger in wrong order", why: "Keep the order! First number minus second number." },
                        { wrong: "Forgetting to borrow when fraction can't be subtracted", why: "If 1/4 - 2/3, you need to borrow from the whole number" },
                        { wrong: "Borrowing incorrectly", why: "When borrowing, add denominator/denominator (like 4/4) to your fraction, not just 1" }
                    ],
                    guided: {
                        problem: `Calculate: 4 1/3 - 2 1/2`,
                        steps: [
                            { label: "Convert 4 1/3", value: "?/3" },
                            { label: "Convert 2 1/2", value: "?/2" },
                            { label: "Find LCD, subtract", value: "?" },
                            { label: "Convert back", value: "?" }
                        ],
                        answer: "1 5/6",
                        answerLabel: "Difference:",
                        interactiveSteps: [
                            {
                                prompt: "Convert 4 1/3 to improper: 4 × 3 + 1 = ?",
                                hint: "Whole × denominator + numerator",
                                answer: "13",
                                acceptableAnswers: ["13", "thirteen"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "12": "Don't forget to add the 1! 4×3 + 1 = 13"
                                }
                            },
                            {
                                prompt: "So 4 1/3 = ?/3",
                                hint: "Numerator is 13, denominator stays 3",
                                answer: "13/3",
                                acceptableAnswers: ["13/3", "13 / 3"],
                                formatHint: "e.g., 13/3",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Convert 2 1/2 to improper: 2 × 2 + 1 = ?/?",
                                hint: "Whole × denominator + numerator, keep denominator",
                                answer: "5/2",
                                acceptableAnswers: ["5/2", "5 / 2"],
                                formatHint: "e.g., 5/2",
                                commonMistakes: {
                                    "4/2": "Don't forget to add the 1! 2×2 + 1 = 5"
                                }
                            },
                            {
                                prompt: "LCD of 3 and 2 is 6. Convert 13/3 to sixths: 13/3 = ?/6",
                                hint: "3 × 2 = 6, so multiply numerator by 2: 13 × 2 = ?",
                                answer: "26/6",
                                acceptableAnswers: ["26/6", "26 / 6"],
                                formatHint: "e.g., 26/6",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Convert 5/2 to sixths: 5/2 = ?/6",
                                hint: "2 × 3 = 6, so multiply numerator by 3: 5 × 3 = ?",
                                answer: "15/6",
                                acceptableAnswers: ["15/6", "15 / 6"],
                                formatHint: "e.g., 15/6",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Subtract: 26/6 - 15/6 = ?",
                                hint: "Subtract numerators, keep denominator",
                                answer: "11/6",
                                acceptableAnswers: ["11/6", "11 / 6"],
                                formatHint: "e.g., 11/6",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Convert 11/6 to a mixed number: 11 ÷ 6 = ? R ?",
                                hint: "11 ÷ 6 = 1 with remainder 5",
                                answer: "1 5/6",
                                acceptableAnswers: ["1 5/6", "1-5/6", "1 and 5/6"],
                                formatHint: "e.g., 1 5/6",
                                commonMistakes: {
                                    "11/6": "Convert to mixed! 11 ÷ 6 = 1 R 5 → 1 5/6"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 5 1/4 - 2 3/4?`, answer: "2 1/2",
                        options: ["2 2/4", "2 1/2", "3 1/2", "2 2/0"],
                        mistakeAnalysis: {
                            "2 2/4": "Simplify! 2/4 = 1/2",
                            "3 1/2": "Check your subtraction. You need to borrow!",
                            "2 2/0": "Can't have 0 denominator. Review borrowing."
                        }}
                }
            ]
        }),
        Decimals: () => ({
            // Progressive sub-skills for T3 Decimals
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Understanding Decimals
                {
                    id: "understanding",
                    name: "Understanding Decimals",
                    goalProblem: `What is the value of the 7 in 3.75?`,
                    teachingSteps: [
                        {
                            title: "What is a decimal?",
                            explanation: "<strong>Decimals</strong> are another way to write fractions. The decimal point separates whole numbers from parts less than 1.",
                            visual: "3.75 = 3 wholes + 0.75 parts"
                        },
                        {
                            title: "Place value after the decimal",
                            explanation: "Each place to the right of the decimal is 10× smaller:<br>• <strong>Tenths</strong> (0.1) = 1/10 - first place<br>• <strong>Hundredths</strong> (0.01) = 1/100 - second place<br>• <strong>Thousandths</strong> (0.001) = 1/1000 - third place",
                            visual: "ones . tenths hundredths thousandths<br>  3  .   7       5"
                        },
                        {
                            title: "Reading 3.75",
                            explanation: "The 3 is in the <strong>ones</strong> place (worth 3).<br>The 7 is in the <strong>tenths</strong> place (worth 0.7 or 7/10).<br>The 5 is in the <strong>hundredths</strong> place (worth 0.05 or 5/100).",
                            visual: "3.75 = 3 + 7/10 + 5/100"
                        },
                        {
                            title: "Decimals and fractions connection",
                            explanation: "Decimals are just fractions with denominators of 10, 100, 1000, etc.<br>0.7 = 7/10<br>0.75 = 75/100<br>0.125 = 125/1000",
                            visual: "0.5 = 5/10 = 1/2"
                        },
                        {
                            title: "Answer: Value of the 7",
                            explanation: "The 7 is in the tenths place, so it represents <strong>7 tenths</strong> or <strong>0.7</strong>!",
                            visual: "7 in tenths place = 0.7 = 7/10"
                        }
                    ],
                    finalAnswer: "7 tenths (0.7)",
                    answerExplanation: "The 7 is in the tenths place (first place after decimal), so its value is 7 tenths or 0.7",
                    example: { problem: `What is the value of the 7 in 3.75?`, steps: [
                        { text: "Identify place value positions", math: "3 . 7 5 → ones . tenths hundredths" },
                        { text: "Find where 7 is located", math: "7 is in the tenths place" },
                        { text: "Determine its value", math: "7 tenths = <strong>0.7</strong>" }
                    ]},
                    keyPoints: [
                        "Tenths = first place after decimal (÷10)",
                        "Hundredths = second place after decimal (÷100)",
                        "Thousandths = third place after decimal (÷1000)",
                        "Each place is 10× smaller than the one to its left"
                    ],
                    mistakes: [
                        { wrong: "Thinking 0.7 > 0.45 because comparing only first digits", why: "Actually 0.7 = 0.70, and 70 hundredths > 45 hundredths ✓ (but be careful!)" },
                        { wrong: "Confusing tenths and hundredths places", why: "Tenths is FIRST after decimal, hundredths is SECOND" }
                    ],
                    guided: {
                        problem: `In the number 4.362, what is the value of the 6?`,
                        steps: [
                            { label: "Identify places", value: "4 . 3 6 2" },
                            { label: "6 is in which place?", value: "?" },
                            { label: "Value of 6", value: "?" }
                        ],
                        answer: "0.06",
                        answerLabel: "Value:",
                        interactiveSteps: [
                            {
                                prompt: "What place is immediately after the decimal (first place)?",
                                hint: "The first place after the decimal is the ___ths place",
                                answer: "tenths",
                                acceptableAnswers: ["tenths", "tenth"],
                                formatHint: "Enter the place name",
                                commonMistakes: {
                                    "ones": "Ones is BEFORE the decimal. Tenths is after."
                                }
                            },
                            {
                                prompt: "In 4.362, count from the decimal: 3 is in tenths. What place is 6 in?",
                                hint: "The second place after the decimal is...",
                                answer: "hundredths",
                                acceptableAnswers: ["hundredths", "hundredth"],
                                formatHint: "Enter the place name",
                                commonMistakes: {
                                    "tenths": "That's where the 3 is. 6 is in the SECOND place after decimal."
                                }
                            },
                            {
                                prompt: "If 6 is in the hundredths place, what is its value as a decimal?",
                                hint: "Hundredths place means ÷100: 6/100 = ?",
                                answer: "0.06",
                                acceptableAnswers: ["0.06", ".06", "6/100", "6 hundredths"],
                                formatHint: "e.g., 0.06",
                                commonMistakes: {
                                    "0.6": "That's 6 TENTHS. 6 hundredths = 0.06",
                                    "6": "Include the decimal: 6 hundredths = 0.06"
                                }
                            }
                        ]
                    },
                    practice: { problem: `Which is greater: 0.5 or 0.35?`, answer: "0.5",
                        options: ["0.5", "0.35", "They're equal"],
                        mistakeAnalysis: {
                            "0.35": "Compare tenths first: 5 tenths vs 3 tenths. 5 > 3, so 0.5 > 0.35",
                            "They're equal": "0.5 = 0.50, and 50 hundredths > 35 hundredths"
                        }}
                },

                // Sub-skill 2: Adding Decimals
                {
                    id: "add",
                    name: "Adding Decimals",
                    goalProblem: `What is 3.7 + 2.45?`,
                    teachingSteps: [
                        {
                            title: "The key rule: Line up the decimals!",
                            explanation: "When adding decimals, <strong>line up the decimal points</strong> so that same place values are in the same column.",
                            visual: "  3.70<br>+ 2.45<br>------"
                        },
                        {
                            title: "Add zeros if needed",
                            explanation: "3.7 has one decimal place. 2.45 has two. Add a zero to 3.7 to make them match: <strong>3.70</strong>",
                            visual: "3.7 = 3.70 (same value, just clearer)"
                        },
                        {
                            title: "Add like regular numbers",
                            explanation: "Once decimals are lined up, add each column from right to left, just like whole numbers.",
                            visual: "  3.70<br>+ 2.45<br>------<br>  6.15"
                        },
                        {
                            title: "Place the decimal in the answer",
                            explanation: "The decimal point in your answer goes <strong>directly below</strong> the other decimal points.",
                            visual: "  3.70<br>+ 2.45<br>------<br>  6.15 ← decimal lined up!"
                        },
                        {
                            title: "Check your answer",
                            explanation: "Estimate to check: 3.7 ≈ 4, 2.45 ≈ 2.5. 4 + 2.5 = 6.5. Our answer 6.15 is close! ✓",
                            visual: "3.7 + 2.45 = 6.15 ✓"
                        }
                    ],
                    finalAnswer: "6.15",
                    answerExplanation: "Line up decimals (3.70 + 2.45), add columns: 0+5=5, 7+4=11 (carry 1), 3+2+1=6. Answer: 6.15",
                    example: { problem: `What is 3.7 + 2.45?`, steps: [
                        { text: "Write vertically, align decimals", math: "3.70 + 2.45" },
                        { text: "Add each column", math: "0+5=5, 7+4=11, carry 1" },
                        { text: "Continue adding", math: "3+2+1=6" },
                        { text: "Place decimal", math: "<strong>6.15</strong>" }
                    ]},
                    keyPoints: [
                        "ALWAYS line up the decimal points",
                        "Add zeros to make same number of decimal places",
                        "Add just like whole numbers",
                        "Decimal in answer goes below the other decimals"
                    ],
                    mistakes: [
                        { wrong: "3.7 + 2.45 = 5.52 (not lining up)", why: "Line up decimals! 3.70 + 2.45 = 6.15" },
                        { wrong: "Ignoring the decimal: 37 + 245 = 282", why: "You must keep track of decimal places. Line them up!" }
                    ],
                    guided: {
                        problem: `Calculate: 5.6 + 3.28`,
                        steps: [
                            { label: "Line up decimals", value: "5.60 + 3.28" },
                            { label: "Add hundredths", value: "0 + 8 = 8" },
                            { label: "Add tenths", value: "?" },
                            { label: "Add ones", value: "?" }
                        ],
                        answer: "8.88",
                        answerLabel: "Sum:",
                        interactiveSteps: [
                            {
                                prompt: "First, rewrite 5.6 with two decimal places to match 3.28",
                                hint: "Add a zero at the end: 5.6 = ?",
                                answer: "5.60",
                                acceptableAnswers: ["5.60", "5.6"],
                                formatHint: "e.g., 5.60",
                                commonMistakes: {
                                    "5.06": "That changes the value! 5.6 = 5.60 (add zero at END)"
                                }
                            },
                            {
                                prompt: "Add the hundredths column: 0 + 8 = ?",
                                hint: "Simple addition...",
                                answer: "8",
                                acceptableAnswers: ["8", "eight"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Add the tenths column: 6 + 2 = ?",
                                hint: "Simple addition...",
                                answer: "8",
                                acceptableAnswers: ["8", "eight"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Add the ones column: 5 + 3 = ?",
                                hint: "Simple addition...",
                                answer: "8",
                                acceptableAnswers: ["8", "eight"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Put it all together: 5.60 + 3.28 = ?",
                                hint: "Remember to place the decimal!",
                                answer: "8.88",
                                acceptableAnswers: ["8.88"],
                                formatHint: "e.g., 8.88",
                                commonMistakes: {
                                    "888": "Don't forget the decimal point! 8.88"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 4.5 + 2.75?`, answer: "7.25",
                        options: ["6.80", "7.25", "7.20", "6.25"],
                        mistakeAnalysis: {
                            "6.80": "Check your addition: 4.50 + 2.75. Hundredths: 0+5=5. Tenths: 5+7=12.",
                            "7.20": "Check hundredths: 0 + 5 = 5, not 0",
                            "6.25": "5+7=12 in tenths, carry the 1: 4+2+1=7"
                        }}
                },

                // Sub-skill 3: Subtracting Decimals
                {
                    id: "subtract",
                    name: "Subtracting Decimals",
                    goalProblem: `What is 5.2 - 3.45?`,
                    teachingSteps: [
                        {
                            title: "Same rule: Line up the decimals!",
                            explanation: "Just like addition, <strong>line up the decimal points</strong> for subtraction.",
                            visual: "  5.20<br>- 3.45<br>------"
                        },
                        {
                            title: "Add zeros to match decimal places",
                            explanation: "5.2 needs a zero to match 3.45: <strong>5.20</strong>",
                            visual: "5.2 = 5.20"
                        },
                        {
                            title: "Subtract with borrowing if needed",
                            explanation: "Start from the right: 0 - 5 can't be done, so borrow from the 2.<br>2 becomes 1, and 0 becomes 10.<br>10 - 5 = 5",
                            visual: "  5.¹20<br>- 3.45<br>------<br>    .  5"
                        },
                        {
                            title: "Continue subtracting",
                            explanation: "Tenths: 1 - 4 can't be done, borrow from 5.<br>5 becomes 4, 1 becomes 11.<br>11 - 4 = 7",
                            visual: "  ⁴5.¹10<br>- 3.4 5<br>------<br>  1.7 5"
                        },
                        {
                            title: "Finish and check",
                            explanation: "Ones: 4 - 3 = 1<br>Answer: <strong>1.75</strong><br>Check: 1.75 + 3.45 = 5.20 ✓",
                            visual: "5.2 - 3.45 = 1.75 ✓"
                        }
                    ],
                    finalAnswer: "1.75",
                    answerExplanation: "Line up decimals (5.20 - 3.45), subtract with borrowing: 10-5=5, 11-4=7, 4-3=1. Answer: 1.75",
                    example: { problem: `What is 5.2 - 3.45?`, steps: [
                        { text: "Align decimals", math: "5.20 - 3.45" },
                        { text: "Borrow and subtract hundredths", math: "10 - 5 = 5" },
                        { text: "Borrow and subtract tenths", math: "11 - 4 = 7" },
                        { text: "Subtract ones", math: "4 - 3 = 1 → <strong>1.75</strong>" }
                    ]},
                    keyPoints: [
                        "Line up decimal points",
                        "Add zeros to match decimal places",
                        "Borrow just like with whole numbers",
                        "Decimal in answer lines up with the others"
                    ],
                    mistakes: [
                        { wrong: "5.2 - 3.45 = 2.23 (subtraction errors)", why: "Be careful with borrowing! Check: 1.75 + 3.45 = 5.20 ✓" },
                        { wrong: "Subtracting smaller from larger: 3.45 - 5.2", why: "Keep the original order! First number minus second number." }
                    ],
                    guided: {
                        problem: `Calculate: 7.3 - 4.56`,
                        steps: [
                            { label: "Line up decimals", value: "7.30 - 4.56" },
                            { label: "Subtract hundredths (borrow)", value: "?" },
                            { label: "Subtract tenths (borrow)", value: "?" },
                            { label: "Subtract ones", value: "?" }
                        ],
                        answer: "2.74",
                        answerLabel: "Difference:",
                        interactiveSteps: [
                            {
                                prompt: "Rewrite 7.3 with two decimal places",
                                hint: "7.3 = ?",
                                answer: "7.30",
                                acceptableAnswers: ["7.30"],
                                formatHint: "e.g., 7.30",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Hundredths: 0 - 6. We need to borrow. After borrowing from tenths, what is 10 - 6?",
                                hint: "Borrow makes it 10, then subtract 6",
                                answer: "4",
                                acceptableAnswers: ["4", "four"],
                                formatHint: "Enter a number",
                                commonMistakes: {
                                    "6": "We subtracted from the borrowed 10: 10 - 6 = 4"
                                }
                            },
                            {
                                prompt: "Tenths: After lending 1 to hundredths, we have 2. 2 - 5 needs borrowing. 12 - 5 = ?",
                                hint: "3 became 2, then we borrow to make 12. 12 - 5 = ?",
                                answer: "7",
                                acceptableAnswers: ["7", "seven"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Ones: After lending 1 to tenths, we have 6. What is 6 - 4?",
                                hint: "7 became 6 after lending. 6 - 4 = ?",
                                answer: "2",
                                acceptableAnswers: ["2", "two"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Final answer: 7.30 - 4.56 = ?",
                                hint: "Put together: 2 ones, 7 tenths, 4 hundredths",
                                answer: "2.74",
                                acceptableAnswers: ["2.74"],
                                formatHint: "e.g., 2.74",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `What is 8.5 - 2.73?`, answer: "5.77",
                        options: ["5.77", "5.87", "6.23", "5.23"],
                        mistakeAnalysis: {
                            "5.87": "Check tenths borrowing: 4 (after lending) - 7 needs another borrow",
                            "6.23": "You may have added instead of subtracted!",
                            "5.23": "Check your borrowing in the tenths place"
                        }}
                },

                // Sub-skill 4: Multiplying Decimals
                {
                    id: "multiply",
                    name: "Multiplying Decimals",
                    goalProblem: `What is 2.5 × 1.3?`,
                    teachingSteps: [
                        {
                            title: "Multiplying decimals is different!",
                            explanation: "For multiplication, you do <strong>NOT</strong> line up decimal points. Instead, you multiply first, then place the decimal.",
                            visual: "Multiply → Count decimal places → Place decimal"
                        },
                        {
                            title: "Step 1: Ignore the decimals temporarily",
                            explanation: "Multiply as if they were whole numbers:<br>25 × 13 = 325",
                            visual: "2.5 → 25<br>1.3 → 13<br>25 × 13 = 325"
                        },
                        {
                            title: "Step 2: Count total decimal places",
                            explanation: "Count decimal places in BOTH original numbers:<br>2.5 has 1 decimal place<br>1.3 has 1 decimal place<br>Total: <strong>2 decimal places</strong>",
                            visual: "2.5 (1 place) + 1.3 (1 place) = 2 places total"
                        },
                        {
                            title: "Step 3: Place the decimal",
                            explanation: "Starting from the RIGHT of your answer, count left 2 places and put the decimal there:<br>325 → 3.25",
                            visual: "325 → 32.5 → 3.25 (moved 2 places)"
                        },
                        {
                            title: "Final answer",
                            explanation: "<strong>2.5 × 1.3 = 3.25</strong><br>Check: 2.5 × 1 = 2.5, and we're multiplying by a bit more than 1, so 3.25 makes sense!",
                            visual: "2.5 × 1.3 = 3.25 ✓"
                        }
                    ],
                    finalAnswer: "3.25",
                    answerExplanation: "Multiply 25 × 13 = 325. Count decimal places: 1 + 1 = 2. Place decimal: 3.25",
                    example: { problem: `What is 2.5 × 1.3?`, steps: [
                        { text: "Ignore decimals, multiply", math: "25 × 13 = 325" },
                        { text: "Count decimal places", math: "2.5 (1) + 1.3 (1) = 2 total" },
                        { text: "Place decimal from right", math: "325 → 3.25" },
                        { text: "Answer", math: "<strong>3.25</strong>" }
                    ]},
                    keyPoints: [
                        "Multiply as whole numbers first",
                        "Count TOTAL decimal places in both factors",
                        "Place decimal that many places from the RIGHT",
                        "Estimate to check (2.5 × 1.3 ≈ 2.5 × 1 = 2.5, answer should be close)"
                    ],
                    mistakes: [
                        { wrong: "Lining up decimals like addition", why: "For multiplication, don't line up! Multiply first, then place decimal." },
                        { wrong: "Forgetting to count decimal places in both numbers", why: "Count places in BOTH factors: 2.5 has 1, 1.3 has 1, total is 2." }
                    ],
                    guided: {
                        problem: `Calculate: 0.4 × 0.3`,
                        steps: [
                            { label: "Multiply as whole numbers", value: "4 × 3 = 12" },
                            { label: "Count decimal places", value: "1 + 1 = 2" },
                            { label: "Place decimal", value: "?" }
                        ],
                        answer: "0.12",
                        answerLabel: "Product:",
                        interactiveSteps: [
                            {
                                prompt: "Ignore decimals and multiply: 4 × 3 = ?",
                                hint: "Simple multiplication",
                                answer: "12",
                                acceptableAnswers: ["12", "twelve"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "How many decimal places does 0.4 have?",
                                hint: "Count digits after the decimal point",
                                answer: "1",
                                acceptableAnswers: ["1", "one"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "How many decimal places does 0.3 have?",
                                hint: "Count digits after the decimal point",
                                answer: "1",
                                acceptableAnswers: ["1", "one"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Total decimal places needed: 1 + 1 = ?",
                                hint: "Add the decimal places from both numbers",
                                answer: "2",
                                acceptableAnswers: ["2", "two"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Place the decimal 2 places from the right in 12. Answer?",
                                hint: "12 → .12 → 0.12 (add leading zero)",
                                answer: "0.12",
                                acceptableAnswers: ["0.12", ".12"],
                                formatHint: "e.g., 0.12",
                                commonMistakes: {
                                    "1.2": "That's only 1 decimal place. We need 2: 0.12",
                                    "12": "We need 2 decimal places: 0.12"
                                }
                            }
                        ]
                    },
                    practice: { problem: `What is 0.6 × 0.7?`, answer: "0.42",
                        options: ["4.2", "0.42", "0.13", "42"],
                        mistakeAnalysis: {
                            "4.2": "Count decimal places: 0.6 (1) + 0.7 (1) = 2 places. Answer: 0.42",
                            "0.13": "6 × 7 = 42, not 13. Then place 2 decimal places.",
                            "42": "Don't forget the decimal! 2 places from right: 0.42"
                        }}
                }
            ]
        }),
        Ratios: () => {
            const a = rand(2, 5), b = rand(3, 6);
            return {
                concept: `<strong>Ratios</strong> compare two quantities. They can be written three ways:<br><br>
                • <strong>With a colon:</strong> 3:2<br>
                • <strong>As a fraction:</strong> 3/2<br>
                • <strong>With words:</strong> "3 to 2"<br><br>
                <strong>Equivalent ratios:</strong><br>
                Just like equivalent fractions! Multiply or divide both parts by the same number.<br>
                3:2 = 6:4 = 9:6 = 12:8 (all the same ratio!)`,
                example: { problem: `A recipe uses 2 cups flour for every 3 cups sugar. If you use 6 cups flour, how much sugar?`, steps: [
                    { text: "Write the ratio", math: "Flour : Sugar = 2 : 3" },
                    { text: "How did flour change? 2 → 6", math: "2 × 3 = 6 (multiplied by 3)" },
                    { text: "Do the same to sugar", math: "3 × 3 = 9" },
                    { text: "New ratio", math: "6 : 9, so <strong>9 cups sugar</strong>" }
                ]},
                keyPoints: [
                    "Ratios compare two amounts (part to part OR part to whole)",
                    "Equivalent ratios: multiply/divide BOTH parts by the same number",
                    "Order matters! 2:3 is different from 3:2"
                ],
                mistakes: [
                    { wrong: "2:3 is the same as 3:2", why: "Order matters! 2:3 means 2 for every 3, not 3 for every 2" },
                    { wrong: "Only multiplying one part of the ratio", why: "Whatever you do to one part, do to BOTH parts" },
                    { wrong: "Adding instead of multiplying to find equivalent ratios", why: "2:3 → 4:6 (multiply by 2), not 4:5 (add 2)" }
                ],
                guided: {
                    problem: `Write an equivalent ratio: ${a}:${b} = ?:${b * 2}`,
                    steps: [
                        { label: `${b} was multiplied by what to get ${b * 2}?`, value: `${b} × 2 = ${b * 2}` },
                        { label: `Do the same to ${a}`, value: `${a} × 2 = ?` }
                    ],
                    answer: String(a * 2),
                    answerLabel: `${a}:${b} = ?:${b * 2}`,
                    interactiveSteps: [
                        {
                            prompt: `In ${a}:${b} = ?:${b * 2}, the second number changed from ${b} to ${b * 2}. What did we multiply by?`,
                            hint: `${b} × ? = ${b * 2}`,
                            answer: "2",
                            acceptableAnswers: ["2", "two", "× 2", "×2"],
                            commonMistakes: {
                                [String(b)]: `${b} × ${b} = ${b * b}, not ${b * 2}. We multiplied by 2.`,
                                [String(b * 2)]: `That's the result. ${b} × 2 = ${b * 2}, so we multiplied by 2.`
                            }
                        },
                        {
                            prompt: "In equivalent ratios, what you do to one part, you must do to the other. What do we do to the first number?",
                            hint: "We multiplied the second by 2, so...",
                            answer: "multiply by 2",
                            acceptableAnswers: ["multiply by 2", "× 2", "times 2", "multiply it by 2"],
                            commonMistakes: {
                                "add 2": "We MULTIPLY, not add. Whatever we did to ${b}, do to ${a}."
                            }
                        },
                        {
                            prompt: `Calculate: ${a} × 2 = ?`,
                            hint: "Double ${a}...",
                            answer: String(a * 2),
                            acceptableAnswers: [String(a * 2)],
                            commonMistakes: {
                                [String(a + 2)]: `You added 2 instead of multiplying! ${a} × 2 = ${a * 2}`,
                                [String(a)]: `Don't forget to multiply! ${a} × 2 = ${a * 2}`
                            }
                        },
                        {
                            prompt: `So ${a}:${b} = ?:${b * 2}. What is the missing number?`,
                            hint: `We found ${a} × 2 = ${a * 2}`,
                            answer: String(a * 2),
                            acceptableAnswers: [String(a * 2)],
                            commonMistakes: {
                                [String(a)]: `That's the original. The equivalent ratio is ${a * 2}:${b * 2}`
                            }
                        }
                    ]
                },
                practice: { problem: `If the ratio of cats to dogs is 3:5, and there are 15 dogs, how many cats?`, answer: "9",
                    options: ["5", "9", "12", "15"],
                    mistakeAnalysis: {
                        "5": "5 is from the original ratio. We need to scale up: 5 × 3 = 15 dogs, so 3 × 3 = 9 cats",
                        "12": "Check your multiplication: 5 → 15 is ×3, so 3 × 3 = 9, not 12",
                        "15": "15 is the number of dogs. For cats: 5 × 3 = 15, so cats = 3 × 3 = 9"
                    }}
            };
        },
        Proportions: () => {
            const a = rand(2, 5), b = rand(3, 6), mult = rand(2, 4);
            const c = a * mult, d = b * mult;
            return {
                goalProblem: `Solve the proportion: 3/4 = x/12`,
                teachingSteps: [
                    {
                        title: "What is a proportion?",
                        explanation: "A <strong>proportion</strong> is an equation showing two ratios that are equal. If 3/4 = x/12, we need to find what x makes this true.",
                        visual: "3/4 = x/12 (these fractions are equal)"
                    },
                    {
                        title: "Method 1: Scale factor",
                        explanation: "Look at the denominators: 4 and 12. Ask: what times 4 equals 12? The answer is 3!",
                        visual: "4 × 3 = 12"
                    },
                    {
                        title: "Apply the same scale factor",
                        explanation: "Since we multiplied the denominator by 3, we must multiply the numerator by 3 too: 3 × 3 = <strong>9</strong>",
                        visual: "3 × 3 = 9, so x = 9"
                    },
                    {
                        title: "Method 2: Cross multiply",
                        explanation: "Another way: multiply diagonally! 3 × 12 = 4 × x. This gives us: 36 = 4x",
                        visual: "3 × 12 = 36 | 4 × x = 4x | So 36 = 4x"
                    },
                    {
                        title: "Solve for x",
                        explanation: "Divide both sides by 4: 36 ÷ 4 = x, so x = <strong>9</strong>. Same answer!",
                        visual: "36 ÷ 4 = 9 ✓"
                    }
                ],
                finalAnswer: "x = 9",
                answerExplanation: "Using scale factor: 4 × 3 = 12, so 3 × 3 = 9. Or cross multiply: 3 × 12 = 4x, 36 = 4x, x = 9!",
                example: { problem: `Solve: 3/4 = x/12`, steps: [
                    { text: "Find the scale factor", math: "4 → 12 means × 3" },
                    { text: "Apply to numerator", math: "3 × 3 = 9" },
                    { text: "Or cross multiply", math: "3 × 12 = 4x → 36 = 4x → x = 9" },
                    { text: "Answer", math: "<strong>x = 9</strong>" }
                ]},
                keyPoints: [
                    "Two methods: Scale factor OR Cross multiplication",
                    "Cross multiply: multiply diagonals, then solve",
                    "Check your answer: 3/4 = 9/12 → both simplify to 3/4 ✓"
                ],
                mistakes: [
                    { wrong: "Only multiplying one part", why: "If bottom × 3, then top × 3 too!" },
                    { wrong: "Adding instead of multiplying in cross multiplication", why: "It's multiply, not add: 3 × 12 = 36" },
                    { wrong: "Cross multiplying wrong diagonals", why: "3/4 = x/12 → 3×12 = 4×x (numerator times opposite denominator)" }
                ],
                guided: {
                    problem: `Solve: ${a}/${b} = x/${d}`,
                    steps: [
                        { label: `Scale factor: ${b} × ? = ${d}`, value: `${mult}` },
                        { label: `Apply to numerator: ${a} × ${mult}`, value: "?" }
                    ],
                    answer: String(c),
                    answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}/${b} = x/${d}, what number times ${b} equals ${d}?`,
                            hint: `${b} × ? = ${d}`,
                            answer: String(mult),
                            acceptableAnswers: [String(mult)],
                            commonMistakes: {
                                [String(d)]: `That's the result. ${b} × ${mult} = ${d}, so the scale factor is ${mult}`,
                                [String(d - b)]: `You subtracted! We need to multiply: ${b} × ${mult} = ${d}`
                            }
                        },
                        {
                            prompt: `Now apply the same scale factor to the numerator: ${a} × ${mult} = ?`,
                            hint: "Multiply top by the same number...",
                            answer: String(c),
                            acceptableAnswers: [String(c)],
                            commonMistakes: {
                                [String(a + mult)]: `You added! Multiply: ${a} × ${mult} = ${c}`,
                                [String(a)]: `Don't forget to multiply! ${a} × ${mult} = ${c}`
                            }
                        },
                        {
                            prompt: `So in ${a}/${b} = x/${d}, x = ?`,
                            hint: "What value makes the fractions equal?",
                            answer: String(c),
                            acceptableAnswers: [String(c)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pa = rand(2, 4), pb = rand(5, 8), pm = rand(3, 5); return {
                    problem: `Solve: ${pa}/${pb} = ${pa * pm}/x`, answer: String(pb * pm),
                    options: shuffle([String(pb * pm), String(pb + pm), String(pa * pm), String(pb)]),
                    mistakeAnalysis: {
                        [String(pb + pm)]: `You added! Scale factor: ${pa} × ${pm} = ${pa * pm}, so ${pb} × ${pm} = ${pb * pm}`,
                        [String(pa * pm)]: `That's the numerator on the right. We need the denominator: ${pb} × ${pm} = ${pb * pm}`,
                        [String(pb)]: `That's the original denominator. We need to scale: ${pb} × ${pm} = ${pb * pm}`
                    }}; })()
            };
        },
        Statistics: () => {
            const data = [rand(10, 25), rand(15, 30), rand(20, 35), rand(25, 40), rand(30, 45)];
            const sorted = [...data].sort((a, b) => a - b);
            const range = sorted[4] - sorted[0];
            return {
                goalProblem: `Find the range of: 12, 8, 15, 6, 10`,
                teachingSteps: [
                    {
                        title: "What is statistics?",
                        explanation: "<strong>Statistics</strong> is the study of collecting, organizing, and analyzing data. We use it to make sense of numbers and find patterns!",
                        visual: "Data → Organize → Analyze → Understand"
                    },
                    {
                        title: "The Range: Measuring spread",
                        explanation: "The <strong>range</strong> tells us how spread out the data is. It's the difference between the largest and smallest values.",
                        visual: "Range = Maximum - Minimum"
                    },
                    {
                        title: "Step 1: Find the maximum",
                        explanation: "Look at the data: 12, 8, 15, 6, 10. The <strong>maximum</strong> (largest number) is 15.",
                        visual: "Max = 15"
                    },
                    {
                        title: "Step 2: Find the minimum",
                        explanation: "The <strong>minimum</strong> (smallest number) is 6.",
                        visual: "Min = 6"
                    },
                    {
                        title: "Step 3: Subtract",
                        explanation: "Range = Maximum - Minimum = 15 - 6 = <strong>9</strong>. The data spans 9 units!",
                        visual: "15 - 6 = 9"
                    }
                ],
                finalAnswer: "Range = 9",
                answerExplanation: "Maximum is 15, minimum is 6. Range = 15 - 6 = 9. The data is spread across 9 units!",
                example: { problem: `Find the range of: 12, 8, 15, 6, 10`, steps: [
                    { text: "Find maximum", math: "Max = 15" },
                    { text: "Find minimum", math: "Min = 6" },
                    { text: "Calculate range", math: "Range = 15 - 6 = <strong>9</strong>" }
                ]},
                keyPoints: [
                    "Range = Maximum - Minimum (largest minus smallest)",
                    "A larger range means data is more spread out",
                    "Range is affected by outliers (extreme values)"
                ],
                mistakes: [
                    { wrong: "Adding max and min instead of subtracting", why: "Range is the DIFFERENCE: max - min, not max + min" },
                    { wrong: "Subtracting in the wrong order (min - max)", why: "Always max - min for a positive range" },
                    { wrong: "Using the middle value instead of extremes", why: "Range only uses the largest and smallest values" }
                ],
                guided: {
                    problem: `Find the range of: ${data.join(', ')}`,
                    steps: [
                        { label: "Find maximum", value: `${sorted[4]}` },
                        { label: "Find minimum", value: `${sorted[0]}` },
                        { label: "Range = Max - Min", value: "?" }
                    ],
                    answer: String(range),
                    answerLabel: "Range = ?",
                    interactiveSteps: [
                        {
                            prompt: `Look at the data: ${data.join(', ')}. What is the maximum (largest) value?`,
                            hint: "Find the biggest number...",
                            answer: String(sorted[4]),
                            acceptableAnswers: [String(sorted[4])],
                            commonMistakes: {
                                [String(sorted[0])]: `That's the minimum (smallest). The maximum is ${sorted[4]}`,
                                [String(sorted[2])]: `That's somewhere in the middle. Look for the LARGEST number: ${sorted[4]}`
                            }
                        },
                        {
                            prompt: `What is the minimum (smallest) value in: ${data.join(', ')}?`,
                            hint: "Find the smallest number...",
                            answer: String(sorted[0]),
                            acceptableAnswers: [String(sorted[0])],
                            commonMistakes: {
                                [String(sorted[4])]: `That's the maximum (largest). The minimum is ${sorted[0]}`
                            }
                        },
                        {
                            prompt: `Calculate the range: ${sorted[4]} - ${sorted[0]} = ?`,
                            hint: "Subtract minimum from maximum...",
                            answer: String(range),
                            acceptableAnswers: [String(range)],
                            commonMistakes: {
                                [String(sorted[4] + sorted[0])]: `You added! Range = max MINUS min: ${sorted[4]} - ${sorted[0]} = ${range}`
                            }
                        }
                    ]
                },
                practice: (() => { const pd = [5, 12, 8, 20, 3]; return {
                    problem: `Find the range of: ${pd.join(', ')}`, answer: "17",
                    options: ["15", "17", "20", "23"],
                    mistakeAnalysis: {
                        "15": "Check your subtraction: Max = 20, Min = 3, Range = 20 - 3 = 17",
                        "20": "That's just the maximum. Range = Max - Min = 20 - 3 = 17",
                        "23": "You added instead of subtracted! Range = 20 - 3 = 17"
                    }}; })()
            };
        },
        "Absolute Value": () => {
            const n = rand(3, 12);
            const neg = -rand(4, 15);
            return {
                goalProblem: `What is |-7|?`,
                teachingSteps: [
                    {
                        title: "What is absolute value?",
                        explanation: "<strong>Absolute value</strong> measures the <strong>distance</strong> from zero on a number line. Distance is always positive!",
                        visual: "|x| = distance from 0"
                    },
                    {
                        title: "The absolute value bars",
                        explanation: "The bars | | around a number mean 'find the absolute value.' Think of them as 'distance from zero' bars.",
                        visual: "|-7| means 'distance of -7 from 0'"
                    },
                    {
                        title: "Visualize it on a number line",
                        explanation: "-7 is 7 units away from 0 on the number line. It doesn't matter which direction!",
                        visual: "← -7 -6 -5 -4 -3 -2 -1 [0] → (7 steps)"
                    },
                    {
                        title: "The rule for absolute value",
                        explanation: "If the number is positive or zero, keep it. If negative, make it positive (drop the negative sign).",
                        visual: "|positive| = positive | |negative| = positive"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>|-7| = 7</strong>. The distance from -7 to 0 is 7 units.",
                        visual: "|-7| = 7"
                    }
                ],
                finalAnswer: "7",
                answerExplanation: "-7 is 7 units from zero on the number line. Absolute value is always positive!",
                example: { problem: `What is |-7|?`, steps: [
                    { text: "Identify what's inside the bars", math: "-7 (a negative number)" },
                    { text: "Ask: How far is -7 from 0?", math: "Count: 7 units" },
                    { text: "Since distance is positive", math: "<strong>|-7| = 7</strong>" }
                ]},
                keyPoints: [
                    "Absolute value = distance from zero",
                    "Distance is ALWAYS positive (or zero)",
                    "|positive| = positive, |negative| = positive, |0| = 0"
                ],
                mistakes: [
                    { wrong: "|-7| = -7 (keeping the negative)", why: "Absolute value is DISTANCE, which can't be negative! |-7| = 7" },
                    { wrong: "Thinking |7| and |-7| are different", why: "Both are 7 units from zero! |7| = |-7| = 7" },
                    { wrong: "|-7| = -(-7) = 7 by 'double negative'", why: "While the answer is right, the concept is distance, not double negatives" }
                ],
                guided: {
                    problem: `What is |${neg}|?`,
                    steps: [
                        { label: `${neg} is a negative number`, value: "Make it positive" },
                        { label: `Distance from 0`, value: "?" }
                    ],
                    answer: String(Math.abs(neg)),
                    answerLabel: `|${neg}| = ?`,
                    interactiveSteps: [
                        {
                            prompt: "What does absolute value measure?",
                            hint: "Think about how far a number is from zero...",
                            answer: "distance from zero",
                            acceptableAnswers: ["distance from zero", "distance", "distance from 0", "how far from zero", "how far from 0"],
                            commonMistakes: {
                                "the negative": "Absolute value measures DISTANCE from zero, not negativity",
                                "sign": "It's not about the sign - it's about distance from zero"
                            }
                        },
                        {
                            prompt: `How many units is ${neg} from 0 on a number line?`,
                            hint: `Count the spaces from ${neg} to 0...`,
                            answer: String(Math.abs(neg)),
                            acceptableAnswers: [String(Math.abs(neg))],
                            commonMistakes: {
                                [String(neg)]: `Distance can't be negative! ${neg} is ${Math.abs(neg)} units from zero.`
                            }
                        },
                        {
                            prompt: `So |${neg}| = ?`,
                            hint: "Distance is always positive...",
                            answer: String(Math.abs(neg)),
                            acceptableAnswers: [String(Math.abs(neg))],
                            commonMistakes: {
                                [String(neg)]: `Absolute value is always positive! |${neg}| = ${Math.abs(neg)}`
                            }
                        }
                    ]
                },
                practice: { problem: `Evaluate: |-12| + |5|`, answer: "17",
                    options: ["-7", "7", "17", "-17"],
                    mistakeAnalysis: {
                        "-7": "You subtracted and kept a negative. |-12| = 12, |5| = 5, so 12 + 5 = 17",
                        "7": "You subtracted instead of adding. |-12| = 12, |5| = 5, 12 + 5 = 17",
                        "-17": "Absolute values are positive! |-12| = 12, |5| = 5, 12 + 5 = 17"
                    }}
            };
        },
        "Scientific Notation": () => {
            const coef = rand(2, 9);
            const exp = rand(3, 7);
            const num = coef * Math.pow(10, exp);
            return {
                goalProblem: `Write 3,500,000 in scientific notation`,
                teachingSteps: [
                    {
                        title: "Why scientific notation?",
                        explanation: "<strong>Scientific notation</strong> is a way to write very large or very small numbers in a compact form. It's used by scientists, engineers, and mathematicians!",
                        visual: "3,500,000 → shorter form?"
                    },
                    {
                        title: "The format",
                        explanation: "Scientific notation: <strong>a × 10ⁿ</strong>, where 'a' is between 1 and 10, and 'n' is the exponent.",
                        visual: "a × 10ⁿ (1 ≤ a < 10)"
                    },
                    {
                        title: "Step 1: Move the decimal point",
                        explanation: "Start with 3,500,000. Move the decimal point until you have a number between 1 and 10: 3.500000",
                        visual: "3,500,000 → 3.5"
                    },
                    {
                        title: "Step 2: Count the moves",
                        explanation: "We moved the decimal <strong>6 places</strong> to the left. This becomes our exponent!",
                        visual: "3.500000 (moved 6 places) → exponent = 6"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>3,500,000 = 3.5 × 10⁶</strong>. The 6 means 'move decimal 6 places right to get back.'",
                        visual: "3.5 × 10⁶"
                    }
                ],
                finalAnswer: "3.5 × 10⁶",
                answerExplanation: "Move decimal 6 places left to get 3.5 (between 1 and 10). Exponent is 6. Answer: 3.5 × 10⁶",
                example: { problem: `Write 3,500,000 in scientific notation`, steps: [
                    { text: "Move decimal to get 1 ≤ a < 10", math: "3,500,000 → 3.5" },
                    { text: "Count decimal moves", math: "Moved 6 places left" },
                    { text: "Write with 10^n", math: "<strong>3.5 × 10⁶</strong>" }
                ]},
                keyPoints: [
                    "First number must be between 1 and 10 (like 3.5, not 35 or 0.35)",
                    "Positive exponent = big number, Negative exponent = small decimal",
                    "The exponent tells you how many places to move the decimal"
                ],
                mistakes: [
                    { wrong: "35 × 10⁵ (first number > 10)", why: "First number must be between 1 and 10. Use 3.5 × 10⁶" },
                    { wrong: "3.5 × 10⁵ (wrong exponent)", why: "Count carefully: 3,500,000 has 6 zeros after 3.5, so 10⁶" },
                    { wrong: "Using negative exponent for large numbers", why: "Negative exponents are for small decimals like 0.00035" }
                ],
                guided: {
                    problem: `Write ${num.toLocaleString()} in scientific notation`,
                    steps: [
                        { label: "Move decimal to get 1 ≤ a < 10", value: `${coef}.0` },
                        { label: "Count the moves", value: `${exp} places` },
                        { label: "Scientific notation", value: "?" }
                    ],
                    answer: `${coef} × 10^${exp}`,
                    answerLabel: "Scientific notation:",
                    interactiveSteps: [
                        {
                            prompt: "In scientific notation, the first number must be between what values?",
                            hint: "It should be at least 1 but less than 10...",
                            answer: "1 and 10",
                            acceptableAnswers: ["1 and 10", "1-10", "between 1 and 10", "1 to 10"],
                            commonMistakes: {
                                "0 and 10": "Close! It must be at LEAST 1. So between 1 and 10.",
                                "1 and 100": "The range is smaller: between 1 and 10."
                            }
                        },
                        {
                            prompt: `To write ${num.toLocaleString()} in scientific notation, what will 'a' (the first number) be?`,
                            hint: "Move the decimal until you have a number between 1 and 10...",
                            answer: String(coef),
                            acceptableAnswers: [String(coef), `${coef}.0`],
                            commonMistakes: {
                                [String(coef * 10)]: `That's greater than 10! Move the decimal more to get ${coef}`,
                                [String(num)]: "You need to convert it! Move decimal to get a number between 1 and 10."
                            }
                        },
                        {
                            prompt: `How many places did you move the decimal to get from ${num.toLocaleString()} to ${coef}?`,
                            hint: `Count the places from ${coef}.0 to ${num.toLocaleString()}...`,
                            answer: String(exp),
                            acceptableAnswers: [String(exp)],
                            commonMistakes: {
                                [String(exp - 1)]: `Count again! ${num.toLocaleString()} → ${coef}.0 is ${exp} places`,
                                [String(exp + 1)]: `Too many! ${num.toLocaleString()} → ${coef}.0 is ${exp} places`
                            }
                        },
                        {
                            prompt: `So ${num.toLocaleString()} = ? × 10^${exp}`,
                            hint: "Put together a × 10^n...",
                            answer: `${coef} × 10^${exp}`,
                            acceptableAnswers: [`${coef} × 10^${exp}`, `${coef}×10^${exp}`, `${coef} x 10^${exp}`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pc = rand(2, 8), pe = rand(4, 8); return {
                    problem: `Write ${pc} × 10^${pe} in standard form`, answer: String(pc * Math.pow(10, pe)),
                    options: shuffle([String(pc * Math.pow(10, pe)), String(pc * Math.pow(10, pe - 1)), String(pc * Math.pow(10, pe + 1)), String(pc * pe)]),
                    mistakeAnalysis: {
                        [String(pc * Math.pow(10, pe - 1))]: "Check your exponent! 10^" + pe + " has " + pe + " zeros",
                        [String(pc * Math.pow(10, pe + 1))]: "That's one too many zeros. 10^" + pe + " = 1" + "0".repeat(pe),
                        [String(pc * pe)]: "Don't multiply by the exponent! 10^" + pe + " means 1" + "0".repeat(pe)
                    }}; })()
            };
        },
        "Square Roots": () => {
            const perfect = pick([4, 9, 16, 25, 36, 49, 64, 81, 100]);
            const root = Math.sqrt(perfect);
            return {
                goalProblem: `What is √49?`,
                teachingSteps: [
                    {
                        title: "What is a square root?",
                        explanation: "A <strong>square root</strong> is the opposite of squaring. If 7² = 49, then √49 = 7. It asks: 'What number times itself equals 49?'",
                        visual: "√49 = ? → ? × ? = 49"
                    },
                    {
                        title: "The square root symbol",
                        explanation: "The √ symbol is called the <strong>radical sign</strong>. It means 'find the number that, when multiplied by itself, gives this.'",
                        visual: "√ = radical sign"
                    },
                    {
                        title: "Perfect squares",
                        explanation: "Some numbers are <strong>perfect squares</strong> because they come from whole numbers squared: 1, 4, 9, 16, 25, 36, 49, 64, 81, 100...",
                        visual: "1²=1, 2²=4, 3²=9, 4²=16, 5²=25, 6²=36, 7²=49..."
                    },
                    {
                        title: "Finding √49",
                        explanation: "What number times itself equals 49? Let's check: 7 × 7 = 49. Yes! So √49 = <strong>7</strong>.",
                        visual: "7 × 7 = 49, so √49 = 7"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>√49 = 7</strong> because 7² = 49. Squaring and square roots are inverse operations!",
                        visual: "√49 = 7"
                    }
                ],
                finalAnswer: "7",
                answerExplanation: "√49 asks: what × what = 49? Since 7 × 7 = 49, √49 = 7!",
                example: { problem: `What is √49?`, steps: [
                    { text: "Ask: what times itself = 49?", math: "? × ? = 49" },
                    { text: "Check: 7 × 7 = 49 ✓", math: "7² = 49" },
                    { text: "So the square root is", math: "<strong>√49 = 7</strong>" }
                ]},
                keyPoints: [
                    "√n asks 'what number squared equals n?'",
                    "Memorize perfect squares: 1, 4, 9, 16, 25, 36, 49, 64, 81, 100",
                    "Square root and squaring are opposites: √(n²) = n"
                ],
                mistakes: [
                    { wrong: "√49 = 49/2 = 24.5", why: "Square root is NOT dividing by 2! √49 = 7 because 7 × 7 = 49" },
                    { wrong: "√49 = 7 × 7 = 49", why: "That's squaring, not square rooting. √49 = 7, not 49" },
                    { wrong: "Confusing √ with ÷2", why: "Different operations! √4 = 2 (because 2×2=4), but 4÷2 = 2 (coincidence!)" }
                ],
                guided: {
                    problem: `What is √${perfect}?`,
                    steps: [
                        { label: "Find: ? × ? = " + perfect, value: "Think of perfect squares..." },
                        { label: `${root} × ${root} = ${perfect}`, value: "✓" }
                    ],
                    answer: String(root),
                    answerLabel: `√${perfect} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "What does the square root (√) ask us to find?",
                            hint: "What number times ITSELF equals the number under the radical?",
                            answer: "what times itself",
                            acceptableAnswers: ["what times itself", "number times itself", "a number squared", "what squared"],
                            commonMistakes: {
                                "divide by 2": "Square root is NOT dividing by 2! It's finding what times itself gives the number.",
                                "half": "That's division! Square root asks: ? × ? = n"
                            }
                        },
                        {
                            prompt: `What number times itself equals ${perfect}?`,
                            hint: "Think: ? × ? = " + perfect,
                            answer: String(root),
                            acceptableAnswers: [String(root)],
                            commonMistakes: {
                                [String(perfect / 2)]: `${perfect / 2} × 2 = ${perfect}, but we need ? × ? (same number twice). ${root} × ${root} = ${perfect}`,
                                [String(perfect)]: `We need a number that MULTIPLIED BY ITSELF gives ${perfect}. That's ${root}.`
                            }
                        },
                        {
                            prompt: `Verify: ${root} × ${root} = ?`,
                            hint: "Check your answer by squaring...",
                            answer: String(perfect),
                            acceptableAnswers: [String(perfect)],
                            commonMistakes: {
                                [String(root * 2)]: `You added or doubled! ${root} × ${root} = ${perfect}`
                            }
                        },
                        {
                            prompt: `So √${perfect} = ?`,
                            hint: "What number did you find?",
                            answer: String(root),
                            acceptableAnswers: [String(root)],
                            commonMistakes: {
                                [String(perfect)]: `${perfect} is under the radical. The answer is ${root} because ${root}² = ${perfect}`
                            }
                        }
                    ]
                },
                practice: (() => { const pp = pick([16, 25, 64, 81, 100]); const pr = Math.sqrt(pp); return {
                    problem: `What is √${pp}?`, answer: String(pr),
                    options: shuffle([String(pr), String(pr + 1), String(pr - 1), String(pp / 2)]),
                    mistakeAnalysis: {
                        [String(pr + 1)]: `Check: ${pr + 1} × ${pr + 1} = ${(pr + 1) * (pr + 1)}, not ${pp}. √${pp} = ${pr}`,
                        [String(pr - 1)]: `Check: ${pr - 1} × ${pr - 1} = ${(pr - 1) * (pr - 1)}, not ${pp}. √${pp} = ${pr}`,
                        [String(pp / 2)]: `Square root is NOT dividing by 2! √${pp} = ${pr} because ${pr} × ${pr} = ${pp}`
                    }}; })()
            };
        },
        "Order of Operations": () => ({
            goalProblem: `Solve: 3 + 4 × 2`,
            teachingSteps: [
                {
                    title: "What is Order of Operations?",
                    explanation: "In math, we follow a specific order when solving problems with multiple operations. Remember <strong>PEMDAS</strong>!",
                    visual: "P-E-M-D-A-S"
                },
                {
                    title: "PEMDAS breakdown",
                    explanation: "<strong>P</strong>arentheses, <strong>E</strong>xponents, <strong>M</strong>ultiplication & <strong>D</strong>ivision (left to right), <strong>A</strong>ddition & <strong>S</strong>ubtraction (left to right)",
                    visual: "() → x² → ×÷ → +−"
                },
                {
                    title: "Look at our problem: 3 + 4 × 2",
                    explanation: "We have addition (+) and multiplication (×). Which comes first in PEMDAS? Multiplication!",
                    visual: "3 + 4 × 2 → multiply first!"
                },
                {
                    title: "Step 1: Do multiplication first",
                    explanation: "4 × 2 = 8. Now our problem becomes: 3 + 8",
                    visual: "3 + (4 × 2) = 3 + 8"
                },
                {
                    title: "Step 2: Do addition",
                    explanation: "3 + 8 = <strong>11</strong>. That's our answer!",
                    visual: "3 + 8 = 11"
                }
            ],
            finalAnswer: "11",
            answerExplanation: "Multiply first (4×2=8), then add (3+8=11). Don't just go left to right!",
            example: { problem: `3 + 4 × 2`, steps: [
                { text: "Apply PEMDAS - multiplication before addition", math: "3 + (4 × 2)" },
                { text: "Calculate 4 × 2", math: "3 + 8" },
                { text: "Calculate 3 + 8", math: "= <strong>11</strong>" }
            ]},
            keyPoints: [
                "PEMDAS: Parentheses, Exponents, Multiply/Divide, Add/Subtract",
                "Multiply and Divide are equal (go left to right)",
                "Add and Subtract are equal (go left to right)"
            ],
            mistakes: [
                { wrong: "Going left to right without PEMDAS", why: "3+4×2 ≠ 14. Multiply first: 4×2=8, then 3+8=11" },
                { wrong: "Forgetting that × and ÷ are done left to right", why: "For 8÷2×4, go left to right: 8÷2=4, then 4×4=16" }
            ],
            guided: {
                problem: `Solve: (2 + 3) × 4`,
                steps: [
                    { label: "What's inside parentheses?", value: "2 + 3" },
                    { label: "Calculate parentheses first", value: "5" },
                    { label: "Then multiply by 4", value: "?" }
                ],
                answer: "20",
                answerLabel: "(2 + 3) × 4 = ?",
                interactiveSteps: [
                    {
                        prompt: "What do we calculate first according to PEMDAS?",
                        hint: "P stands for...",
                        answer: "parentheses",
                        acceptableAnswers: ["parentheses", "the parentheses", "(2+3)", "2+3"],
                        formatHint: "What's the P in PEMDAS?",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Calculate what's in parentheses: 2 + 3 = ?",
                        hint: "Add 2 and 3",
                        answer: "5",
                        acceptableAnswers: ["5"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Now multiply: 5 × 4 = ?",
                        hint: "5 times 4",
                        answer: "20",
                        acceptableAnswers: ["20"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Solve: 10 - 2 × 3`, answer: "4", options: ["4", "24", "16", "8"],
                mistakeAnalysis: {
                    "24": "You went left to right! Multiply first: 2×3=6, then 10-6=4",
                    "16": "Check your calculation. 2×3=6, then 10-6=4",
                    "8": "Close! Remember: 10 - (2×3) = 10 - 6 = 4"
                }}
        }),
        "Coordinate Plane": () => ({
            goalProblem: `Plot the point (3, 4) on a coordinate plane.`,
            teachingSteps: [
                {
                    title: "What is a coordinate plane?",
                    explanation: "A <strong>coordinate plane</strong> is a grid formed by two number lines: a horizontal x-axis and a vertical y-axis.",
                    visual: "y↑\n  |\n──+──→ x"
                },
                {
                    title: "Understanding ordered pairs",
                    explanation: "Points are written as <strong>(x, y)</strong>. The first number is x (horizontal), the second is y (vertical).",
                    visual: "(x, y) = (right/left, up/down)"
                },
                {
                    title: "Plot (3, 4) - Step 1: Start at origin",
                    explanation: "The <strong>origin</strong> (0, 0) is where the axes cross. All plotting starts here!",
                    visual: "Start at (0, 0)"
                },
                {
                    title: "Step 2: Move right 3 (the x-value)",
                    explanation: "From the origin, move <strong>3 units right</strong> along the x-axis.",
                    visual: "→→→ (3 steps right)"
                },
                {
                    title: "Step 3: Move up 4 (the y-value)",
                    explanation: "From where you are, move <strong>4 units up</strong>. Mark that spot - that's (3, 4)!",
                    visual: "↑↑↑↑ (4 steps up) → ● (3, 4)"
                }
            ],
            finalAnswer: "3 right, 4 up from origin",
            answerExplanation: "For (3, 4): go right 3 on the x-axis, then up 4 on the y-axis.",
            example: { problem: `Plot (3, 4)`, steps: [
                { text: "Start at origin (0, 0)", math: "Center of the grid" },
                { text: "Move right 3 (x = 3)", math: "Along horizontal axis" },
                { text: "Move up 4 (y = 4)", math: "Plot the point ●" }
            ]},
            keyPoints: [
                "(x, y) - x is always first, y is second",
                "Positive x = right, Negative x = left",
                "Positive y = up, Negative y = down",
                "Origin = (0, 0)"
            ],
            mistakes: [
                { wrong: "Mixing up x and y", why: "Remember: (x, y) - x comes first! 'x before y, like in the alphabet'" },
                { wrong: "Moving up/down first", why: "Always move horizontally (x) first, then vertically (y)" }
            ],
            guided: {
                problem: `What is the location of a point that's 2 right and 5 up from the origin?`,
                steps: [
                    { label: "x-coordinate (horizontal)", value: "2" },
                    { label: "y-coordinate (vertical)", value: "5" },
                    { label: "Ordered pair", value: "?" }
                ],
                answer: "(2, 5)",
                answerLabel: "Coordinates",
                interactiveSteps: [
                    {
                        prompt: "Which coordinate comes first in an ordered pair, x or y?",
                        hint: "Like in the alphabet...",
                        answer: "x",
                        acceptableAnswers: ["x", "x-coordinate"],
                        formatHint: "x or y",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Write the ordered pair: right 2, up 5",
                        hint: "(x, y) = (right/left, up/down)",
                        answer: "(2, 5)",
                        acceptableAnswers: ["(2, 5)", "(2,5)", "2, 5"],
                        formatHint: "Write as (x, y)",
                        commonMistakes: {
                            "(5, 2)": "X comes first! Right 2 = x = 2, Up 5 = y = 5. Answer: (2, 5)"
                        }
                    }
                ]
            },
            practice: { problem: `Where is the point (-2, 3)?`, answer: "2 left, 3 up", options: ["2 right, 3 up", "2 left, 3 up", "3 left, 2 up", "2 left, 3 down"],
                mistakeAnalysis: {
                    "2 right, 3 up": "Negative x means LEFT, not right. (-2, 3) = 2 left, 3 up",
                    "3 left, 2 up": "You switched x and y. x=-2 means 2 left, y=3 means 3 up",
                    "2 left, 3 down": "Positive y means UP, not down. (-2, 3) = 2 left, 3 up"
                }}
        }),
        "Expressions with Variables": () => ({
            goalProblem: `Evaluate 2x + 3 when x = 4`,
            teachingSteps: [
                {
                    title: "What is a variable?",
                    explanation: "A <strong>variable</strong> is a letter (like x) that represents a number. We can substitute different values for it!",
                    visual: "x = mystery number"
                },
                {
                    title: "What does 'evaluate' mean?",
                    explanation: "To <strong>evaluate</strong> an expression means to find its value by replacing the variable with a given number.",
                    visual: "Evaluate = plug in and calculate"
                },
                {
                    title: "Substitute x = 4",
                    explanation: "Replace every x with 4: 2x + 3 becomes 2(4) + 3",
                    visual: "2x + 3 → 2(4) + 3"
                },
                {
                    title: "Calculate step by step",
                    explanation: "2(4) means 2 × 4 = 8. Then add 3: 8 + 3 = 11",
                    visual: "2(4) + 3 = 8 + 3 = 11"
                },
                {
                    title: "Answer: 11",
                    explanation: "When x = 4, the expression 2x + 3 equals <strong>11</strong>!",
                    visual: "2(4) + 3 = 11"
                }
            ],
            finalAnswer: "11",
            answerExplanation: "2x + 3 when x = 4: 2(4) + 3 = 8 + 3 = 11",
            example: { problem: `Evaluate 2x + 3 when x = 4`, steps: [
                { text: "Substitute x = 4", math: "2(4) + 3" },
                { text: "Multiply", math: "8 + 3" },
                { text: "Add", math: "= <strong>11</strong>" }
            ]},
            keyPoints: [
                "Substitute means replace the variable with the number",
                "2x means 2 × x (multiplication)",
                "Follow order of operations after substituting"
            ],
            mistakes: [
                { wrong: "Adding instead of multiplying", why: "2x means 2 times x, not 2 plus x!" },
                { wrong: "Forgetting order of operations", why: "Multiply 2x first, then add 3" }
            ],
            guided: {
                problem: `Evaluate 3y - 2 when y = 5`,
                steps: [
                    { label: "Substitute y = 5", value: "3(5) - 2" },
                    { label: "Multiply", value: "15 - 2" },
                    { label: "Subtract", value: "?" }
                ],
                answer: "13",
                answerLabel: "Value when y = 5",
                interactiveSteps: [
                    {
                        prompt: "What does 3y mean when y = 5?",
                        hint: "3 times 5",
                        answer: "15",
                        acceptableAnswers: ["15", "3(5)", "3×5"],
                        formatHint: "Calculate 3 × 5",
                        commonMistakes: {
                            "8": "3y means 3 times y, not 3 plus y! 3 × 5 = 15"
                        }
                    },
                    {
                        prompt: "Now calculate: 15 - 2 = ?",
                        hint: "Subtract 2 from 15",
                        answer: "13",
                        acceptableAnswers: ["13"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Evaluate x² + 1 when x = 3`, answer: "10", options: ["7", "10", "12", "4"],
                mistakeAnalysis: {
                    "7": "x² means x × x, not 2x. 3² = 9, then 9 + 1 = 10",
                    "12": "Check your calculation: 3² = 9, then 9 + 1 = 10",
                    "4": "You need to square first: 3² = 9, then add 1 = 10"
                }}
        }),
        "GCF and LCM": () => ({
            goalProblem: `Find the GCF of 12 and 18`,
            teachingSteps: [
                {
                    title: "What is GCF?",
                    explanation: "<strong>GCF</strong> (Greatest Common Factor) is the largest number that divides evenly into both numbers.",
                    visual: "GCF = biggest shared factor"
                },
                {
                    title: "List factors of 12",
                    explanation: "Factors of 12: 1, 2, 3, 4, 6, 12 (numbers that divide 12 evenly)",
                    visual: "12: 1, 2, 3, 4, 6, 12"
                },
                {
                    title: "List factors of 18",
                    explanation: "Factors of 18: 1, 2, 3, 6, 9, 18",
                    visual: "18: 1, 2, 3, 6, 9, 18"
                },
                {
                    title: "Find COMMON factors",
                    explanation: "Common factors (in both lists): 1, 2, 3, 6",
                    visual: "12 & 18 share: 1, 2, 3, 6"
                },
                {
                    title: "GCF is the GREATEST common factor",
                    explanation: "The largest common factor is <strong>6</strong>. So GCF(12, 18) = 6!",
                    visual: "Greatest: 6"
                }
            ],
            finalAnswer: "6",
            answerExplanation: "12 and 18 both divide evenly by 6, and 6 is the largest such number.",
            example: { problem: `GCF of 12 and 18`, steps: [
                { text: "Factors of 12", math: "1, 2, 3, 4, 6, 12" },
                { text: "Factors of 18", math: "1, 2, 3, 6, 9, 18" },
                { text: "Common factors", math: "1, 2, 3, 6" },
                { text: "Greatest", math: "GCF = <strong>6</strong>" }
            ]},
            keyPoints: [
                "GCF = Greatest Common Factor (largest shared divisor)",
                "LCM = Least Common Multiple (smallest shared multiple)",
                "GCF is used for simplifying fractions",
                "LCM is used for adding fractions with different denominators"
            ],
            mistakes: [
                { wrong: "Finding LCM instead of GCF", why: "GCF = greatest FACTOR (divisor). LCM = least MULTIPLE." },
                { wrong: "Missing common factors", why: "List ALL factors of each number carefully!" }
            ],
            guided: {
                problem: `Find the LCM of 4 and 6`,
                steps: [
                    { label: "Multiples of 4", value: "4, 8, 12, 16, 20..." },
                    { label: "Multiples of 6", value: "6, 12, 18, 24..." },
                    { label: "Least common multiple", value: "?" }
                ],
                answer: "12",
                answerLabel: "LCM of 4 and 6",
                interactiveSteps: [
                    {
                        prompt: "What are the first few multiples of 4?",
                        hint: "4×1, 4×2, 4×3...",
                        answer: "4, 8, 12",
                        acceptableAnswers: ["4, 8, 12", "4,8,12", "4 8 12"],
                        formatHint: "List first 3 multiples",
                        commonMistakes: {}
                    },
                    {
                        prompt: "What's the smallest number in BOTH lists: 4,8,12,16... and 6,12,18...?",
                        hint: "Find the first number that appears in both...",
                        answer: "12",
                        acceptableAnswers: ["12"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "24": "12 is smaller and appears in both lists. LCM = 12"
                        }
                    }
                ]
            },
            practice: { problem: `What is the GCF of 8 and 20?`, answer: "4", options: ["2", "4", "8", "40"],
                mistakeAnalysis: {
                    "2": "2 is common, but 4 is bigger and also divides both. GCF = 4",
                    "8": "8 doesn't divide 20 evenly. GCF = 4",
                    "40": "That's the LCM! GCF = 4 (largest factor in common)"
                }}
        }),
        Volume: () => ({
            goalProblem: `Find the volume of a box: length 4, width 3, height 2`,
            teachingSteps: [
                {
                    title: "What is volume?",
                    explanation: "<strong>Volume</strong> is the amount of space inside a 3D object. We measure it in cubic units!",
                    visual: "Volume = space inside"
                },
                {
                    title: "Volume formula for rectangular prisms",
                    explanation: "Volume = length × width × height (V = l × w × h)",
                    visual: "V = l × w × h"
                },
                {
                    title: "Plug in our values",
                    explanation: "Length = 4, Width = 3, Height = 2. So V = 4 × 3 × 2",
                    visual: "V = 4 × 3 × 2"
                },
                {
                    title: "Calculate step by step",
                    explanation: "4 × 3 = 12, then 12 × 2 = 24",
                    visual: "4 × 3 × 2 = 12 × 2 = 24"
                },
                {
                    title: "Answer: 24 cubic units",
                    explanation: "The volume is <strong>24 cubic units</strong>. This means 24 unit cubes fit inside!",
                    visual: "V = 24 cubic units"
                }
            ],
            finalAnswer: "24 cubic units",
            answerExplanation: "V = 4 × 3 × 2 = 24 cubic units",
            example: { problem: `Volume of a 4×3×2 box`, steps: [
                { text: "Write the formula", math: "V = l × w × h" },
                { text: "Substitute values", math: "V = 4 × 3 × 2" },
                { text: "Calculate", math: "V = <strong>24 cubic units</strong>" }
            ]},
            keyPoints: [
                "Volume = length × width × height",
                "Measured in CUBIC units (like cm³)",
                "For cubes: V = side³"
            ],
            mistakes: [
                { wrong: "Using square units", why: "Volume is 3D - use CUBIC units, not square units!" },
                { wrong: "Adding instead of multiplying", why: "Volume = l × w × h (multiply all three)" }
            ],
            guided: {
                problem: `Find the volume of a cube with side 5 cm`,
                steps: [
                    { label: "For a cube, l = w = h", value: "All equal 5" },
                    { label: "V = 5 × 5 × 5", value: "?" }
                ],
                answer: "125",
                answerLabel: "Volume = ? cm³",
                interactiveSteps: [
                    {
                        prompt: "A cube has all sides equal. What is 5 × 5?",
                        hint: "5 squared",
                        answer: "25",
                        acceptableAnswers: ["25"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Now multiply by the height: 25 × 5 = ?",
                        hint: "25 × 5",
                        answer: "125",
                        acceptableAnswers: ["125", "125 cm³", "125 cubic cm"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Volume of a box: l=6, w=2, h=3?`, answer: "36", options: ["11", "36", "72", "30"],
                mistakeAnalysis: {
                    "11": "You added! Volume = multiply: 6 × 2 × 3 = 36",
                    "72": "Check calculation: 6 × 2 = 12, then 12 × 3 = 36",
                    "30": "Check: 6 × 2 × 3 = 12 × 3 = 36"
                }}
        }),
        "One-Step Equations": () => ({
            goalProblem: `Solve: x + 7 = 12`,
            teachingSteps: [
                {
                    title: "What is an equation?",
                    explanation: "An <strong>equation</strong> has an equals sign. Both sides must have the same value. We're finding what x equals!",
                    visual: "x + 7 = 12"
                },
                {
                    title: "Goal: Get x alone",
                    explanation: "We want x by itself on one side. Currently there's a +7 with x. We need to remove it!",
                    visual: "x + 7 = 12 → x = ?"
                },
                {
                    title: "Use inverse operations",
                    explanation: "The opposite of +7 is -7. Subtract 7 from BOTH sides to keep the equation balanced!",
                    visual: "x + 7 - 7 = 12 - 7"
                },
                {
                    title: "Simplify both sides",
                    explanation: "Left side: x + 7 - 7 = x. Right side: 12 - 7 = 5",
                    visual: "x = 5"
                },
                {
                    title: "Check your answer",
                    explanation: "Plug x = 5 back in: 5 + 7 = 12 ✓ It works!",
                    visual: "5 + 7 = 12 ✓"
                }
            ],
            finalAnswer: "x = 5",
            answerExplanation: "Subtract 7 from both sides: x + 7 - 7 = 12 - 7, so x = 5",
            example: { problem: `x + 7 = 12`, steps: [
                { text: "Subtract 7 from both sides", math: "x + 7 - 7 = 12 - 7" },
                { text: "Simplify", math: "x = 5" },
                { text: "Check: 5 + 7 = 12 ✓", math: "<strong>x = 5</strong>" }
            ]},
            keyPoints: [
                "Do the same thing to BOTH sides",
                "Use opposite operations (+/-, ×/÷)",
                "Always check your answer"
            ],
            mistakes: [
                { wrong: "Only changing one side", why: "Equations must stay balanced - do the same to BOTH sides!" },
                { wrong: "Using the wrong inverse", why: "Opposite of + is -, opposite of × is ÷" }
            ],
            guided: {
                problem: `Solve: y - 4 = 9`,
                steps: [
                    { label: "Operation with y", value: "- 4" },
                    { label: "Inverse operation", value: "+ 4" },
                    { label: "Add 4 to both sides", value: "y = ?" }
                ],
                answer: "13",
                answerLabel: "y = ?",
                interactiveSteps: [
                    {
                        prompt: "What's the opposite of subtracting 4?",
                        hint: "The inverse of -4 is...",
                        answer: "adding 4",
                        acceptableAnswers: ["adding 4", "add 4", "+4", "plus 4"],
                        formatHint: "What operation?",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Add 4 to both sides: 9 + 4 = ?",
                        hint: "Calculate the right side",
                        answer: "13",
                        acceptableAnswers: ["13"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Solve: 3x = 15`, answer: "5", options: ["3", "5", "12", "45"],
                mistakeAnalysis: {
                    "3": "3 is the coefficient. Divide: x = 15 ÷ 3 = 5",
                    "12": "You subtracted instead of dividing. 3x = 15 means x = 15 ÷ 3 = 5",
                    "45": "You multiplied! Divide to undo: x = 15 ÷ 3 = 5"
                }}
        }),
        "Powers of 10": () => ({
            goalProblem: `What is 10³?`,
            teachingSteps: [
                {
                    title: "What are powers of 10?",
                    explanation: "A <strong>power of 10</strong> means 10 multiplied by itself a certain number of times. The exponent tells you how many times!",
                    visual: "10³ = 10 × 10 × 10"
                },
                {
                    title: "The shortcut: count the zeros!",
                    explanation: "10 to a power equals 1 followed by that many zeros. 10³ = 1,000 (1 with 3 zeros!)",
                    visual: "10³ = 1,000 (three zeros)"
                },
                {
                    title: "Calculate 10³",
                    explanation: "10 × 10 = 100, then 100 × 10 = 1,000. Or just write 1 with 3 zeros!",
                    visual: "10 × 10 × 10 = 1,000"
                },
                {
                    title: "Answer: 1,000",
                    explanation: "10³ = <strong>1,000</strong> (one thousand)",
                    visual: "10³ = 1,000"
                }
            ],
            finalAnswer: "1,000",
            answerExplanation: "10³ = 10 × 10 × 10 = 1,000 (or 1 followed by 3 zeros)",
            example: { problem: `10³`, steps: [
                { text: "10³ means 10 used 3 times", math: "10 × 10 × 10" },
                { text: "Calculate", math: "100 × 10 = 1,000" },
                { text: "Or use shortcut: 1 with 3 zeros", math: "<strong>1,000</strong>" }
            ]},
            keyPoints: [
                "10¹ = 10, 10² = 100, 10³ = 1,000",
                "Shortcut: 10ⁿ = 1 followed by n zeros",
                "Multiplying by 10ⁿ moves decimal point n places right"
            ],
            mistakes: [
                { wrong: "Multiplying 10 × 3 = 30", why: "10³ ≠ 10 × 3. It means 10 × 10 × 10 = 1,000" },
                { wrong: "Counting zeros wrong", why: "10³ has 3 zeros (1,000), not 2 or 4" }
            ],
            guided: {
                problem: `What is 10⁵?`,
                steps: [
                    { label: "10⁵ means", value: "10 × 10 × 10 × 10 × 10" },
                    { label: "Or: 1 followed by 5 zeros", value: "?" }
                ],
                answer: "100,000",
                answerLabel: "10⁵ = ?",
                interactiveSteps: [
                    {
                        prompt: "How many zeros does 10⁵ have after the 1?",
                        hint: "The exponent tells you...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Write 1 followed by 5 zeros:",
                        hint: "1 with five zeros after it",
                        answer: "100000",
                        acceptableAnswers: ["100000", "100,000"],
                        formatHint: "Enter the number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `What is 4 × 10²?`, answer: "400", options: ["40", "400", "4,000", "420"],
                mistakeAnalysis: {
                    "40": "10² = 100, not 10. So 4 × 100 = 400",
                    "4,000": "10² = 100, not 1,000. 4 × 100 = 400",
                    "420": "10² = 100, not 105. 4 × 100 = 400"
                }}
        }),
        "Simple Probability": () => ({
            goalProblem: `A bag has 3 red and 2 blue marbles. What's the probability of picking red?`,
            teachingSteps: [
                {
                    title: "What is probability?",
                    explanation: "<strong>Probability</strong> tells us how likely something is to happen. It's a number between 0 (impossible) and 1 (certain).",
                    visual: "0 = never happens, 1 = always happens"
                },
                {
                    title: "The probability formula",
                    explanation: "Probability = (favorable outcomes) ÷ (total outcomes)",
                    visual: "P = favorable / total"
                },
                {
                    title: "Count favorable outcomes",
                    explanation: "We want red marbles. There are 3 red marbles. Favorable = 3",
                    visual: "Favorable = 3 red"
                },
                {
                    title: "Count total outcomes",
                    explanation: "Total marbles = 3 red + 2 blue = 5 marbles",
                    visual: "Total = 3 + 2 = 5"
                },
                {
                    title: "Calculate probability",
                    explanation: "P(red) = 3/5. That means 3 out of 5 chance of picking red!",
                    visual: "P(red) = 3/5"
                }
            ],
            finalAnswer: "3/5",
            answerExplanation: "3 red out of 5 total = 3/5 probability",
            example: { problem: `P(red) = ?`, steps: [
                { text: "Favorable (red marbles)", math: "3" },
                { text: "Total (all marbles)", math: "3 + 2 = 5" },
                { text: "Probability", math: "P = 3/5 = <strong>3/5</strong>" }
            ]},
            keyPoints: [
                "P = favorable / total",
                "Probability is always between 0 and 1 (or 0% to 100%)",
                "Higher probability = more likely"
            ],
            mistakes: [
                { wrong: "Using just favorable or just total", why: "Probability is a fraction: favorable OVER total" },
                { wrong: "Forgetting to count all outcomes", why: "Make sure to count ALL possibilities!" }
            ],
            guided: {
                problem: `A coin is flipped. What's the probability of heads?`,
                steps: [
                    { label: "Favorable (heads)", value: "1" },
                    { label: "Total (heads or tails)", value: "2" },
                    { label: "Probability", value: "?" }
                ],
                answer: "1/2",
                answerLabel: "P(heads) = ?",
                interactiveSteps: [
                    {
                        prompt: "How many ways can you get heads on a coin?",
                        hint: "There's only one 'heads' side",
                        answer: "1",
                        acceptableAnswers: ["1", "one"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "How many total outcomes are possible (heads OR tails)?",
                        hint: "A coin has two sides",
                        answer: "2",
                        acceptableAnswers: ["2", "two"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "So P(heads) = favorable/total = ?",
                        hint: "1 favorable out of 2 total",
                        answer: "1/2",
                        acceptableAnswers: ["1/2", "0.5", "50%"],
                        formatHint: "Enter as a fraction",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Dice roll: P(getting 6)?`, answer: "1/6", options: ["1/2", "1/6", "6", "5/6"],
                mistakeAnalysis: {
                    "1/2": "A dice has 6 sides, not 2. Only one side is 6, so P = 1/6",
                    "6": "Probability is a fraction, not a whole number. P = 1/6",
                    "5/6": "That's P(NOT getting 6). P(getting 6) = 1/6"
                }}
        }),
        "Comparing Distributions": () => ({
            goalProblem: `Compare two data sets: Set A mean = 50, Set B mean = 55. Which has a higher average?`,
            teachingSteps: [
                {
                    title: "What are distributions?",
                    explanation: "A <strong>distribution</strong> shows how data is spread out. We use statistics like mean, median, and range to describe and compare them.",
                    visual: "Distribution = data spread pattern"
                },
                {
                    title: "Comparing means (averages)",
                    explanation: "The <strong>mean</strong> is the average. Higher mean = higher average value.",
                    visual: "Mean = sum ÷ count"
                },
                {
                    title: "Look at our data",
                    explanation: "Set A has mean 50, Set B has mean 55. 55 > 50!",
                    visual: "A: 50 | B: 55"
                },
                {
                    title: "Answer: Set B",
                    explanation: "<strong>Set B</strong> has the higher average (55 > 50).",
                    visual: "B wins: 55 > 50"
                }
            ],
            finalAnswer: "Set B",
            answerExplanation: "55 > 50, so Set B has the higher average.",
            example: { problem: `Which has higher average?`, steps: [
                { text: "Compare the means", math: "A = 50, B = 55" },
                { text: "Which is larger?", math: "55 > 50" },
                { text: "Answer", math: "<strong>Set B</strong>" }
            ]},
            keyPoints: [
                "Mean = average (sum ÷ count)",
                "Median = middle value",
                "Range = spread (max - min)"
            ],
            mistakes: [
                { wrong: "Confusing mean and median", why: "Mean is the average; median is the middle value when sorted" },
                { wrong: "Ignoring spread", why: "Two sets can have same mean but different spreads!" }
            ],
            guided: {
                problem: `Class A: range 20. Class B: range 50. Which has more spread?`,
                steps: [
                    { label: "Range of A", value: "20" },
                    { label: "Range of B", value: "50" },
                    { label: "More spread", value: "?" }
                ],
                answer: "Class B",
                answerLabel: "Which has more spread?",
                interactiveSteps: [
                    {
                        prompt: "What does 'range' measure?",
                        hint: "Range = max - min = the spread",
                        answer: "spread",
                        acceptableAnswers: ["spread", "the spread", "how spread out"],
                        formatHint: "What does range measure?",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Which has more spread: range 20 or range 50?",
                        hint: "Bigger range = more spread",
                        answer: "Class B",
                        acceptableAnswers: ["Class B", "B", "50"],
                        formatHint: "Which class?",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Set X: median 40. Set Y: median 35. Which has a higher middle value?`, answer: "Set X", options: ["Set X", "Set Y", "Same", "Cannot tell"],
                mistakeAnalysis: {
                    "Set Y": "40 > 35, so Set X has the higher median",
                    "Same": "40 ≠ 35, they're different!",
                    "Cannot tell": "We know the medians! 40 > 35, so Set X is higher"
                }}
        }),
        "Nets of 3D Shapes": () => ({
            goalProblem: `What 3D shape does this net make: 6 connected squares?`,
            teachingSteps: [
                {
                    title: "What is a net?",
                    explanation: "A <strong>net</strong> is a 2D pattern that folds up into a 3D shape. It's like unfolding a box!",
                    visual: "Net → fold → 3D shape"
                },
                {
                    title: "How nets work",
                    explanation: "Imagine cutting along the edges of a box and unfolding it flat. That flat pattern is the net!",
                    visual: "📦 unfold → ✚ (net)"
                },
                {
                    title: "6 squares = cube",
                    explanation: "A cube has 6 faces, all squares. A net of 6 connected squares folds into a cube!",
                    visual: "6 squares → cube 🎲"
                },
                {
                    title: "Other common nets",
                    explanation: "Cylinder net: 2 circles + rectangle. Cone net: 1 circle + wedge shape.",
                    visual: "Different shapes = different nets"
                },
                {
                    title: "Answer: Cube",
                    explanation: "6 connected squares fold into a <strong>cube</strong>!",
                    visual: "Answer: Cube"
                }
            ],
            finalAnswer: "cube",
            answerExplanation: "A cube has 6 square faces. A net of 6 squares folds into a cube.",
            example: { problem: `6 squares net = ?`, steps: [
                { text: "Count the faces", math: "6 squares" },
                { text: "What 3D shape has 6 square faces?", math: "A cube!" },
                { text: "Answer", math: "<strong>Cube</strong>" }
            ]},
            keyPoints: [
                "Cube: 6 squares",
                "Rectangular prism: 6 rectangles",
                "Cylinder: 2 circles + 1 rectangle"
            ],
            mistakes: [
                { wrong: "Confusing net with the shape itself", why: "A net is FLAT. It folds into the 3D shape." },
                { wrong: "Miscounting faces", why: "Count carefully! A cube has 6 faces." }
            ],
            guided: {
                problem: `A cylinder net has 2 circles and what other shape?`,
                steps: [
                    { label: "Top and bottom of cylinder", value: "2 circles" },
                    { label: "The curved surface unfolds to", value: "?" }
                ],
                answer: "rectangle",
                answerLabel: "What shape?",
                interactiveSteps: [
                    {
                        prompt: "Picture wrapping paper around a can. If you unrolled the paper, what shape would it be?",
                        hint: "It would be flat and have 4 corners...",
                        answer: "rectangle",
                        acceptableAnswers: ["rectangle", "a rectangle"],
                        formatHint: "Name the shape",
                        commonMistakes: {
                            "circle": "The circles are the top and bottom. The curved side unrolls to a rectangle!"
                        }
                    }
                ]
            },
            practice: { problem: `How many faces in a rectangular prism net?`, answer: "6", options: ["4", "5", "6", "8"],
                mistakeAnalysis: {
                    "4": "That's a tetrahedron. A rectangular prism (box) has 6 faces.",
                    "5": "Count all faces: top, bottom, front, back, left, right = 6",
                    "8": "That's the vertices (corners). Faces = 6"
                }}
        })
    },
    4: {
        Equations: () => ({
            // Progressive sub-skills for T4 Equations
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: One-Step Equations (Addition/Subtraction)
                {
                    id: "one_step_add_sub",
                    name: "One-Step Equations (Add/Subtract)",
                    goalProblem: `Solve: x + 5 = 12`,
                    teachingSteps: [
                        {
                            title: "What does 'solving an equation' mean?",
                            explanation: "We need to find the value of <strong>x</strong> that makes the equation true. Think of x as a mystery number we're trying to discover!",
                            visual: "x + 5 = 12 → What is x?"
                        },
                        {
                            title: "The balance scale rule",
                            explanation: "An equation is like a balance scale. Whatever you do to one side, you <strong>MUST</strong> do to the other side to keep it balanced!",
                            visual: "⚖️ Left side = Right side (always!)"
                        },
                        {
                            title: "Inverse operations",
                            explanation: "To isolate x, use <strong>inverse operations</strong>:<br>• Addition ↔ Subtraction<br>• Multiplication ↔ Division",
                            visual: "+ ↔ − | × ↔ ÷"
                        },
                        {
                            title: "Solve x + 5 = 12",
                            explanation: "5 is being added to x. The inverse is subtract 5.<br>Subtract 5 from <strong>BOTH</strong> sides:<br>x + 5 - 5 = 12 - 5",
                            visual: "x + 5 - 5 = 12 - 5"
                        },
                        {
                            title: "Simplify and check",
                            explanation: "x = 7<br>Check: 7 + 5 = 12 ✓",
                            visual: "x = 7 ✓"
                        }
                    ],
                    finalAnswer: "x = 7",
                    answerExplanation: "Subtract 5 from both sides: x + 5 - 5 = 12 - 5 → x = 7. Check: 7 + 5 = 12 ✓",
                    example: { problem: `Solve: x + 5 = 12`, steps: [
                        { text: "Identify operation on x", math: "5 is ADDED to x" },
                        { text: "Use inverse (subtract) on BOTH sides", math: "x + 5 - 5 = 12 - 5" },
                        { text: "Simplify", math: "x = 7" },
                        { text: "Check", math: "7 + 5 = 12 ✓" }
                    ]},
                    keyPoints: [
                        "Inverse of addition is subtraction",
                        "Inverse of subtraction is addition",
                        "Always do the same thing to BOTH sides",
                        "ALWAYS check your answer!"
                    ],
                    mistakes: [
                        { wrong: "Only operating on one side", why: "Both sides must stay equal!" },
                        { wrong: "x + 5 = 12 → x = 17 (adding instead of subtracting)", why: "UNDO the +5 by subtracting, not adding more!" }
                    ],
                    guided: {
                        problem: `Solve: x - 7 = 15`,
                        steps: [
                            { label: "Operation on x", value: "Subtracting 7" },
                            { label: "Inverse operation", value: "Add 7" },
                            { label: "Apply to both sides", value: "x - 7 + 7 = 15 + 7" }
                        ],
                        answer: "22",
                        answerLabel: "x =",
                        interactiveSteps: [
                            {
                                prompt: "In x - 7 = 15, what operation is being done to x?",
                                hint: "Look at the sign: x - 7",
                                answer: "subtraction",
                                acceptableAnswers: ["subtraction", "subtracting", "subtract", "minus"],
                                formatHint: "Enter the operation",
                                commonMistakes: { "addition": "The sign is minus (-), so it's subtraction" }
                            },
                            {
                                prompt: "What's the inverse of subtraction?",
                                hint: "To undo subtracting, we...",
                                answer: "addition",
                                acceptableAnswers: ["addition", "add", "adding", "plus"],
                                formatHint: "Enter the operation",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Add 7 to both sides: x - 7 + 7 = 15 + 7. What is 15 + 7?",
                                hint: "15 + 7 = ?",
                                answer: "22",
                                acceptableAnswers: ["22"],
                                formatHint: "Enter a number",
                                commonMistakes: { "8": "That's 15 - 7. We need 15 + 7 = 22" }
                            },
                            {
                                prompt: "So x = ?",
                                hint: "We found that x = 22",
                                answer: "22",
                                acceptableAnswers: ["22"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Solve: x + 9 = 21`, answer: "12",
                        options: ["12", "30", "9", "21"],
                        mistakeAnalysis: {
                            "30": "You added instead of subtracting! 21 - 9 = 12",
                            "9": "That's the number being added, not x. Subtract: 21 - 9 = 12",
                            "21": "You need to isolate x by subtracting 9"
                        }}
                },

                // Sub-skill 2: One-Step Equations (Multiplication/Division)
                {
                    id: "one_step_mult_div",
                    name: "One-Step Equations (Multiply/Divide)",
                    goalProblem: `Solve: 4x = 20`,
                    teachingSteps: [
                        {
                            title: "What does 4x mean?",
                            explanation: "<strong>4x</strong> means 4 times x, or 4 · x. The number next to x is multiplying it.",
                            visual: "4x = 4 × x"
                        },
                        {
                            title: "Inverse of multiplication is division",
                            explanation: "Since x is being multiplied by 4, we divide both sides by 4 to isolate x.",
                            visual: "× ↔ ÷"
                        },
                        {
                            title: "Solve 4x = 20",
                            explanation: "Divide BOTH sides by 4:<br>4x ÷ 4 = 20 ÷ 4<br>x = 5",
                            visual: "4x/4 = 20/4 → x = 5"
                        },
                        {
                            title: "Division equations",
                            explanation: "For x/3 = 6, the inverse is multiply:<br>x/3 × 3 = 6 × 3<br>x = 18",
                            visual: "x/3 × 3 = 6 × 3 → x = 18"
                        },
                        {
                            title: "Check your answer",
                            explanation: "For 4x = 20, if x = 5:<br>4(5) = 20 ✓",
                            visual: "4 × 5 = 20 ✓"
                        }
                    ],
                    finalAnswer: "x = 5",
                    answerExplanation: "Divide both sides by 4: 4x ÷ 4 = 20 ÷ 4 → x = 5. Check: 4(5) = 20 ✓",
                    example: { problem: `Solve: 4x = 20`, steps: [
                        { text: "Identify operation", math: "x is multiplied by 4" },
                        { text: "Use inverse (divide) on both sides", math: "4x ÷ 4 = 20 ÷ 4" },
                        { text: "Simplify", math: "x = 5" },
                        { text: "Check", math: "4(5) = 20 ✓" }
                    ]},
                    keyPoints: [
                        "4x means 4 times x",
                        "Inverse of multiplication is division",
                        "Inverse of division is multiplication",
                        "Divide/multiply BOTH sides by the same number"
                    ],
                    mistakes: [
                        { wrong: "4x = 20 → x = 20 - 4 = 16", why: "4x means multiplication, not addition! Divide by 4." },
                        { wrong: "Only dividing one side", why: "4x/4 = 20 → x = 20 is wrong! Divide BOTH sides: x = 20/4 = 5" }
                    ],
                    guided: {
                        problem: `Solve: x/5 = 8`,
                        steps: [
                            { label: "Operation on x", value: "Dividing by 5" },
                            { label: "Inverse operation", value: "Multiply by 5" },
                            { label: "Apply to both sides", value: "x/5 × 5 = 8 × 5" }
                        ],
                        answer: "40",
                        answerLabel: "x =",
                        interactiveSteps: [
                            {
                                prompt: "In x/5 = 8, what operation is being done to x?",
                                hint: "x/5 means x divided by 5",
                                answer: "division",
                                acceptableAnswers: ["division", "dividing", "divide", "divided"],
                                formatHint: "Enter the operation",
                                commonMistakes: {}
                            },
                            {
                                prompt: "What's the inverse of division?",
                                hint: "To undo dividing, we...",
                                answer: "multiplication",
                                acceptableAnswers: ["multiplication", "multiply", "multiplying", "times"],
                                formatHint: "Enter the operation",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Multiply both sides by 5: x/5 × 5 = 8 × 5. What is 8 × 5?",
                                hint: "8 × 5 = ?",
                                answer: "40",
                                acceptableAnswers: ["40"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Solve: 6x = 42`, answer: "7",
                        options: ["7", "36", "48", "252"],
                        mistakeAnalysis: {
                            "36": "You subtracted! 6x means 6 times x. Divide: 42 ÷ 6 = 7",
                            "48": "You added! Divide both sides by 6: 42 ÷ 6 = 7",
                            "252": "You multiplied! To isolate x, DIVIDE by 6"
                        }}
                },

                // Sub-skill 3: Two-Step Equations
                {
                    id: "two_step",
                    name: "Two-Step Equations",
                    goalProblem: `Solve: 2x + 5 = 13`,
                    teachingSteps: [
                        {
                            title: "Two operations = Two steps",
                            explanation: "In 2x + 5 = 13, two things are happening to x:<br>1. Multiplied by 2<br>2. Added 5<br>We undo them in <strong>reverse order</strong>!",
                            visual: "x → ×2 → +5 → result"
                        },
                        {
                            title: "Order of operations (REVERSE)",
                            explanation: "Think of getting dressed: socks then shoes.<br>To undress: shoes first, then socks!<br>For equations: undo +/- first, then ×/÷",
                            visual: "Undo: Addition/Subtraction FIRST, then Multiplication/Division"
                        },
                        {
                            title: "Step 1: Undo the +5",
                            explanation: "Subtract 5 from both sides:<br>2x + 5 - 5 = 13 - 5<br>2x = 8",
                            visual: "2x + 5 - 5 = 13 - 5 → 2x = 8"
                        },
                        {
                            title: "Step 2: Undo the ×2",
                            explanation: "Divide both sides by 2:<br>2x ÷ 2 = 8 ÷ 2<br>x = 4",
                            visual: "2x ÷ 2 = 8 ÷ 2 → x = 4"
                        },
                        {
                            title: "Check your answer",
                            explanation: "Plug x = 4 back in:<br>2(4) + 5 = 8 + 5 = 13 ✓",
                            visual: "2(4) + 5 = 13 ✓"
                        }
                    ],
                    finalAnswer: "x = 4",
                    answerExplanation: "Step 1: Subtract 5 → 2x = 8. Step 2: Divide by 2 → x = 4. Check: 2(4)+5 = 13 ✓",
                    example: { problem: `Solve: 2x + 5 = 13`, steps: [
                        { text: "Step 1: Undo +5 (subtract 5 from both sides)", math: "2x + 5 - 5 = 13 - 5 → 2x = 8" },
                        { text: "Step 2: Undo ×2 (divide both sides by 2)", math: "2x ÷ 2 = 8 ÷ 2 → x = 4" },
                        { text: "Check", math: "2(4) + 5 = 8 + 5 = 13 ✓" }
                    ]},
                    keyPoints: [
                        "Undo operations in REVERSE order",
                        "First undo addition/subtraction",
                        "Then undo multiplication/division",
                        "Always check by substituting back"
                    ],
                    mistakes: [
                        { wrong: "Dividing first: 2x + 5 = 13 → x + 5 = 6.5", why: "Undo +5 FIRST, then divide!" },
                        { wrong: "2x + 5 = 13 → 2x = 18 (adding instead of subtracting)", why: "To undo +5, SUBTRACT 5" }
                    ],
                    guided: {
                        problem: `Solve: 3x - 7 = 14`,
                        steps: [
                            { label: "Step 1: Undo -7", value: "Add 7 to both sides" },
                            { label: "3x = ?", value: "?" },
                            { label: "Step 2: Undo ×3", value: "Divide by 3" }
                        ],
                        answer: "7",
                        answerLabel: "x =",
                        interactiveSteps: [
                            {
                                prompt: "In 3x - 7 = 14, we undo subtraction first. Add 7 to both sides: 14 + 7 = ?",
                                hint: "14 + 7 = ?",
                                answer: "21",
                                acceptableAnswers: ["21"],
                                formatHint: "Enter a number",
                                commonMistakes: { "7": "That's 14 - 7. We need to ADD 7: 14 + 7 = 21" }
                            },
                            {
                                prompt: "Now we have 3x = 21. Divide both sides by 3: 21 ÷ 3 = ?",
                                hint: "21 ÷ 3 = ?",
                                answer: "7",
                                acceptableAnswers: ["7"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Check: Does 3(7) - 7 = 14?",
                                hint: "3 × 7 = 21, then 21 - 7 = ?",
                                answer: "yes",
                                acceptableAnswers: ["yes", "14", "yeah"],
                                formatHint: "yes or no",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Solve: 5x + 3 = 28`, answer: "5",
                        options: ["5", "6.2", "25", "31"],
                        mistakeAnalysis: {
                            "6.2": "Check order: subtract 3 first (28-3=25), then divide by 5 (25÷5=5)",
                            "25": "That's 28 - 3. Don't forget step 2: divide by 5! 25 ÷ 5 = 5",
                            "31": "You added instead of subtracted! 28 - 3 = 25, then 25 ÷ 5 = 5"
                        }}
                },

                // Sub-skill 4: Multi-Step Equations with Variables on Both Sides
                {
                    id: "variables_both_sides",
                    name: "Variables on Both Sides",
                    goalProblem: `Solve: 4x + 3 = 2x + 11`,
                    teachingSteps: [
                        {
                            title: "Variables on BOTH sides!",
                            explanation: "When x appears on both sides, we need to get all the x's on ONE side first.",
                            visual: "4x + 3 = 2x + 11 (x on both sides!)"
                        },
                        {
                            title: "Step 1: Move x terms to one side",
                            explanation: "Subtract 2x from BOTH sides to eliminate x from the right:<br>4x - 2x + 3 = 2x - 2x + 11<br>2x + 3 = 11",
                            visual: "4x - 2x + 3 = 11 → 2x + 3 = 11"
                        },
                        {
                            title: "Step 2: Undo the addition",
                            explanation: "Subtract 3 from both sides:<br>2x + 3 - 3 = 11 - 3<br>2x = 8",
                            visual: "2x = 8"
                        },
                        {
                            title: "Step 3: Undo the multiplication",
                            explanation: "Divide both sides by 2:<br>2x ÷ 2 = 8 ÷ 2<br>x = 4",
                            visual: "x = 4"
                        },
                        {
                            title: "Check your answer",
                            explanation: "Left: 4(4) + 3 = 16 + 3 = 19<br>Right: 2(4) + 11 = 8 + 11 = 19 ✓<br>Both sides equal!",
                            visual: "4(4) + 3 = 2(4) + 11 → 19 = 19 ✓"
                        }
                    ],
                    finalAnswer: "x = 4",
                    answerExplanation: "Get x's together: 2x + 3 = 11. Subtract 3: 2x = 8. Divide by 2: x = 4",
                    example: { problem: `Solve: 4x + 3 = 2x + 11`, steps: [
                        { text: "Move x terms to one side", math: "4x - 2x + 3 = 11 → 2x + 3 = 11" },
                        { text: "Subtract 3", math: "2x = 8" },
                        { text: "Divide by 2", math: "x = 4" },
                        { text: "Check", math: "4(4)+3 = 19, 2(4)+11 = 19 ✓" }
                    ]},
                    keyPoints: [
                        "Get all x terms on ONE side first",
                        "Get all constants on the OTHER side",
                        "Then solve like a two-step equation",
                        "Check in the ORIGINAL equation"
                    ],
                    mistakes: [
                        { wrong: "Trying to solve without combining x terms first", why: "You must get all x's on one side first!" },
                        { wrong: "Subtracting x from only one side", why: "Whatever you do to one side, do to BOTH!" }
                    ],
                    guided: {
                        problem: `Solve: 5x - 2 = 3x + 6`,
                        steps: [
                            { label: "Move x terms to left", value: "Subtract 3x from both sides" },
                            { label: "2x - 2 = 6", value: "Then add 2" },
                            { label: "Solve for x", value: "?" }
                        ],
                        answer: "4",
                        answerLabel: "x =",
                        interactiveSteps: [
                            {
                                prompt: "Subtract 3x from both sides: 5x - 3x - 2 = 6. What is 5x - 3x?",
                                hint: "5x - 3x = ?x",
                                answer: "2x",
                                acceptableAnswers: ["2x", "2"],
                                formatHint: "e.g., 2x",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Now we have 2x - 2 = 6. Add 2 to both sides: 6 + 2 = ?",
                                hint: "6 + 2 = ?",
                                answer: "8",
                                acceptableAnswers: ["8"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Now we have 2x = 8. Divide by 2: x = ?",
                                hint: "8 ÷ 2 = ?",
                                answer: "4",
                                acceptableAnswers: ["4"],
                                formatHint: "Enter a number",
                                commonMistakes: {}
                            },
                            {
                                prompt: "Check: 5(4) - 2 = ? and 3(4) + 6 = ?",
                                hint: "Both should equal the same number",
                                answer: "18",
                                acceptableAnswers: ["18", "yes", "equal"],
                                formatHint: "Enter the value both sides equal",
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Solve: 6x + 1 = 4x + 9`, answer: "4",
                        options: ["4", "5", "8", "2"],
                        mistakeAnalysis: {
                            "5": "Check: 6(5)+1=31, 4(5)+9=29. Not equal! Try x=4",
                            "8": "You found 2x = 8, but forgot to divide by 2! x = 4",
                            "2": "Check your subtraction: 6x - 4x = 2x, then solve 2x + 1 = 9"
                        }}
                }
            ]
        }),
        Exponents: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Understanding Exponents (evaluation)
                (() => {
                    const base = rand(2, 4), exp = rand(2, 3);
                    const ans = Math.pow(base, exp);
                    return {
                        id: "eval",
                        name: "Understanding Exponents",
                        goalProblem: `What is 2³?`,
                        teachingSteps: [
                            {
                                title: "What are exponents?",
                                explanation: "<strong>Exponents</strong> are shorthand for repeated multiplication. Instead of writing 2 × 2 × 2, we can write 2³!",
                                visual: "2 × 2 × 2 = 2³"
                            },
                            {
                                title: "The two parts: base and exponent",
                                explanation: "In 2³, the <strong>2</strong> is the 'base' (the number being multiplied) and the <strong>3</strong> is the 'exponent' (how many times).",
                                visual: "2³ → base=2, exponent=3"
                            },
                            {
                                title: "Read it as: 'multiply base by itself exponent times'",
                                explanation: "2³ means: multiply 2 by itself <strong>3 times</strong>. NOT 2 × 3! The exponent tells us how many 2s to multiply.",
                                visual: "2³ = 2 × 2 × 2 (three 2s)"
                            },
                            {
                                title: "Calculate step by step",
                                explanation: "Start with the first two: 2 × 2 = 4. Then multiply by the next 2: 4 × 2 = 8.",
                                visual: "2 × 2 = 4 → 4 × 2 = 8"
                            },
                            {
                                title: "The answer",
                                explanation: "<strong>2³ = 8</strong>. Remember: the exponent is NOT a multiplier, it's a counter of how many times!",
                                visual: "2³ = 8"
                            }
                        ],
                        finalAnswer: "8",
                        answerExplanation: "2³ means 2 × 2 × 2 = 8. The exponent (3) tells us to multiply the base (2) by itself 3 times!",
                        example: { problem: `What is 2³?`, steps: [
                            { text: "Identify: base = 2, exponent = 3", math: "Multiply 2 by itself 3 times" },
                            { text: "Write out the multiplication", math: "2³ = 2 × 2 × 2" },
                            { text: "Calculate step by step", math: "2 × 2 = 4" },
                            { text: "Then multiply by the next 2", math: "4 × 2 = <strong>8</strong>" }
                        ]},
                        keyPoints: [
                            "The exponent tells you HOW MANY times to multiply the base",
                            "2³ = 2 × 2 × 2 = 8 (NOT 2 × 3 = 6!)",
                            "The bigger the exponent, the faster the number grows: 2¹ = 2, 2² = 4, 2³ = 8, 2⁴ = 16"
                        ],
                        mistakes: [
                            { wrong: "2³ = 2 × 3 = 6", why: "Don't multiply base times exponent! 2³ means 2 × 2 × 2 = 8" },
                            { wrong: "3² = 6", why: "3² means 3 × 3 = 9, not 3 × 2" },
                            { wrong: "5⁰ = 0", why: "Any number (except 0) to the power of 0 equals 1. 5⁰ = 1" }
                        ],
                        guided: { problem: `What is ${base}${['⁰','¹','²','³'][exp]}?`, steps: [
                            { label: "Identify base and exponent", value: `Base = ${base}, Exponent = ${exp}` },
                            { label: "Write as repeated multiplication", value: `${Array(exp).fill(base).join(' × ')}` },
                            { label: "Calculate", value: "?" }
                        ], answer: String(ans), answerLabel: `${base}${['⁰','¹','²','³'][exp]} = ?`,
                            interactiveSteps: [
                                {
                                    prompt: `In ${base}${['⁰','¹','²','³'][exp]}, what is the BASE (the number being multiplied)?`,
                                    hint: "The base is the big number at the bottom...",
                                    answer: String(base),
                                    acceptableAnswers: [String(base)],
                                    commonMistakes: {
                                        [String(exp)]: `${exp} is the exponent (the small number). The base is ${base}.`
                                    }
                                },
                                {
                                    prompt: `In ${base}${['⁰','¹','²','³'][exp]}, what is the EXPONENT (how many times to multiply)?`,
                                    hint: "The exponent is the small raised number...",
                                    answer: String(exp),
                                    acceptableAnswers: [String(exp)],
                                    commonMistakes: {
                                        [String(base)]: `${base} is the base. The exponent is the small raised number: ${exp}`
                                    }
                                },
                                {
                                    prompt: `So ${base}${['⁰','¹','²','³'][exp]} means: multiply ${base} by itself how many times?`,
                                    hint: "The exponent tells us how many times...",
                                    answer: String(exp),
                                    acceptableAnswers: [String(exp), exp === 2 ? "twice" : "three times", exp === 2 ? "two" : "three"],
                                    commonMistakes: {
                                        [String(base * exp)]: `That's ${base} × ${exp}. The exponent tells us HOW MANY times to multiply, which is ${exp}.`
                                    }
                                },
                                {
                                    prompt: `Write it out: ${base}${['⁰','¹','²','³'][exp]} = ${base} × ${base}${exp === 3 ? ` × ${base}` : ''}. What is ${base} × ${base}?`,
                                    hint: `${base} times ${base}...`,
                                    answer: String(base * base),
                                    acceptableAnswers: [String(base * base)],
                                    commonMistakes: {
                                        [String(base + base)]: `You added! ${base} × ${base} = ${base * base}, not ${base} + ${base} = ${base + base}`,
                                        [String(base)]: `${base} × ${base} = ${base * base}`
                                    }
                                },
                                {
                                    prompt: exp === 2 ? `So ${base}² = ?` : `Now: ${base * base} × ${base} = ?`,
                                    hint: exp === 2 ? `${base} × ${base} = ?` : `${base * base} × ${base}...`,
                                    answer: String(ans),
                                    acceptableAnswers: [String(ans)],
                                    commonMistakes: {
                                        [String(base * exp)]: `Remember, we multiply ${base} by itself ${exp} times, not ${base} × ${exp}. The answer is ${ans}.`
                                    }
                                }
                            ]
                        },
                        practice: (() => { const pe = exp === 3 ? 2 : 3; const pa = Math.pow(base, pe); return {
                            problem: `What is ${base}${['⁰','¹','²','³'][pe]}?`, answer: String(pa),
                            options: shuffle([String(pa), String(base * pe), String(Math.pow(base, exp)), String(base + pe)]),
                            mistakeAnalysis: {
                                [String(base * pe)]: `You multiplied ${base} × ${pe} = ${base * pe}. But ${base}${['⁰','¹','²','³'][pe]} means ${Array(pe).fill(base).join(' × ')} = ${pa}`,
                                [String(Math.pow(base, exp))]: `That's ${base}${['⁰','¹','²','³'][exp]}. For ${base}${['⁰','¹','²','³'][pe]}, multiply ${base} by itself ${pe} times.`,
                                [String(base + pe)]: `You added! Exponents mean repeated multiplication: ${Array(pe).fill(base).join(' × ')} = ${pa}`
                            }}; })()
                    };
                })(),

                // Sub-skill 2: Multiplying Powers (same base - ADD exponents)
                (() => {
                    const base = rand(2, 4);
                    const e1 = rand(2, 3), e2 = rand(2, 3);
                    const sum = e1 + e2;
                    const superscripts = ['⁰','¹','²','³','⁴','⁵','⁶','⁷','⁸','⁹'];
                    return {
                        id: "multiply",
                        name: "Multiplying Powers (Same Base)",
                        goalProblem: `Simplify: 3² × 3³`,
                        teachingSteps: [
                            {
                                title: "What happens when we multiply powers with the same base?",
                                explanation: "When multiplying powers that have the <strong>same base</strong>, there's a shortcut! Let's discover it by looking at 3² × 3³.",
                                visual: "3² × 3³ = ?"
                            },
                            {
                                title: "Expand each power",
                                explanation: "Let's write out what each power means:<br>• 3² = 3 × 3 (two 3s)<br>• 3³ = 3 × 3 × 3 (three 3s)",
                                visual: "3² × 3³ = (3 × 3) × (3 × 3 × 3)"
                            },
                            {
                                title: "Count all the 3s",
                                explanation: "When we multiply them together, we're just combining all the 3s: (3 × 3) × (3 × 3 × 3) = 3 × 3 × 3 × 3 × 3",
                                visual: "= 3 × 3 × 3 × 3 × 3 = five 3s!"
                            },
                            {
                                title: "The pattern: ADD the exponents!",
                                explanation: "Two 3s plus three 3s equals <strong>five 3s</strong>. So 3² × 3³ = 3⁵. The rule: <strong>ADD the exponents</strong> when multiplying same bases!",
                                visual: "3² × 3³ = 3²⁺³ = 3⁵"
                            },
                            {
                                title: "The Product Rule",
                                explanation: "<strong>aᵐ × aⁿ = aᵐ⁺ⁿ</strong><br>When multiplying powers with the SAME base, KEEP the base and ADD the exponents!",
                                visual: "3² × 3³ = 3⁵ = 243"
                            }
                        ],
                        finalAnswer: "3⁵",
                        answerExplanation: "3² × 3³ = 3²⁺³ = 3⁵. When multiplying same bases, add the exponents: 2 + 3 = 5.",
                        example: { problem: `Simplify: 3² × 3³`, steps: [
                            { text: "Identify: same base (3) with exponents 2 and 3", math: "Product Rule applies!" },
                            { text: "Keep the base, add the exponents", math: "3² × 3³ = 3²⁺³" },
                            { text: "Add the exponents", math: "2 + 3 = 5" },
                            { text: "Write the answer", math: "= <strong>3⁵</strong>" }
                        ]},
                        keyPoints: [
                            "Product Rule: aᵐ × aⁿ = aᵐ⁺ⁿ (ADD the exponents)",
                            "This ONLY works when the bases are the SAME",
                            "Keep the base, just add the exponents: 2³ × 2⁴ = 2⁷"
                        ],
                        mistakes: [
                            { wrong: "3² × 3³ = 3⁶ (multiplied exponents)", why: "ADD the exponents, don't multiply! 3² × 3³ = 3⁵" },
                            { wrong: "3² × 3³ = 9⁵ (multiplied the bases)", why: "Keep the base the same! Just add the exponents: 3⁵" },
                            { wrong: "2³ × 3² = 6⁵", why: "The product rule only works for SAME bases. 2³ × 3² can't be simplified this way." }
                        ],
                        guided: { problem: `Simplify: ${base}${superscripts[e1]} × ${base}${superscripts[e2]}`, steps: [
                            { label: "Identify the bases", value: `Both bases are ${base} ✓` },
                            { label: "Apply Product Rule (add exponents)", value: `${e1} + ${e2} = ${sum}` },
                            { label: "Write the answer", value: "?" }
                        ], answer: `${base}^${sum}`, answerLabel: `${base}${superscripts[e1]} × ${base}${superscripts[e2]} = ?`,
                            interactiveSteps: [
                                {
                                    prompt: `In ${base}${superscripts[e1]} × ${base}${superscripts[e2]}, are the bases the same?`,
                                    hint: "Look at the big numbers (bases)...",
                                    answer: "yes",
                                    acceptableAnswers: ["yes", "Yeah", "y", "yep", "true", String(base)],
                                    commonMistakes: {
                                        "no": `Both bases are ${base}! So yes, we can use the product rule.`
                                    }
                                },
                                {
                                    prompt: `What rule do we use when multiplying powers with the same base?`,
                                    hint: "aᵐ × aⁿ = a^(m+n)... we ___ the exponents",
                                    answer: "add",
                                    acceptableAnswers: ["add", "add the exponents", "product rule", "add exponents"],
                                    commonMistakes: {
                                        "multiply": "We MULTIPLY when raising a power to a power. For multiplying same bases, we ADD!",
                                        "subtract": "We ADD exponents when multiplying same bases."
                                    }
                                },
                                {
                                    prompt: `So for ${base}${superscripts[e1]} × ${base}${superscripts[e2]}, we add: ${e1} + ${e2} = ?`,
                                    hint: `${e1} plus ${e2}...`,
                                    answer: String(sum),
                                    acceptableAnswers: [String(sum)],
                                    commonMistakes: {
                                        [String(e1 * e2)]: `That's multiplying! We ADD exponents: ${e1} + ${e2} = ${sum}`
                                    }
                                },
                                {
                                    prompt: `Therefore, ${base}${superscripts[e1]} × ${base}${superscripts[e2]} = ${base}^?`,
                                    hint: `The exponent is ${e1} + ${e2}...`,
                                    answer: String(sum),
                                    acceptableAnswers: [String(sum), `${base}^${sum}`, `${base}${superscripts[sum]}`],
                                    commonMistakes: {
                                        [String(e1 * e2)]: `We ADD exponents when multiplying: ${base}^${sum}`,
                                        [String(base * 2)]: `Don't change the base! Keep ${base}, just add the exponents: ${base}^${sum}`
                                    }
                                }
                            ]
                        },
                        practice: (() => {
                            const pb = rand(2, 4);
                            const pe1 = rand(2, 4), pe2 = rand(2, 3);
                            const psum = pe1 + pe2;
                            return {
                                problem: `Simplify: ${pb}${superscripts[pe1]} × ${pb}${superscripts[pe2]}`,
                                answer: `${pb}^${psum}`,
                                options: shuffle([`${pb}^${psum}`, `${pb}^${pe1 * pe2}`, `${pb * 2}^${pe1}`, `${pb}^${pe1}`]),
                                mistakeAnalysis: {
                                    [`${pb}^${pe1 * pe2}`]: `You multiplied the exponents! When multiplying same bases, ADD: ${pe1} + ${pe2} = ${psum}. Answer: ${pb}^${psum}`,
                                    [`${pb * 2}^${pe1}`]: `Don't multiply the bases! Keep the base as ${pb} and add exponents: ${pb}^${psum}`,
                                    [`${pb}^${pe1}`]: `You forgot to add the second exponent! ${pe1} + ${pe2} = ${psum}. Answer: ${pb}^${psum}`
                                }
                            };
                        })()
                    };
                })(),

                // Sub-skill 3: Power of a Power (MULTIPLY exponents)
                (() => {
                    const base = rand(2, 3);
                    const e1 = rand(2, 3), e2 = rand(2, 3);
                    const product = e1 * e2;
                    const superscripts = ['⁰','¹','²','³','⁴','⁵','⁶','⁷','⁸','⁹'];
                    return {
                        id: "power",
                        name: "Power of a Power",
                        goalProblem: `Simplify: (2³)²`,
                        teachingSteps: [
                            {
                                title: "What does 'power of a power' mean?",
                                explanation: "Sometimes we raise a power to another power, like (2³)². This means we're taking 2³ and squaring it!",
                                visual: "(2³)² = 2³ × 2³"
                            },
                            {
                                title: "Expand using what we know",
                                explanation: "(2³)² means 2³ multiplied by itself 2 times.<br>So: (2³)² = 2³ × 2³",
                                visual: "(2³)² = 2³ × 2³"
                            },
                            {
                                title: "Now use the Product Rule",
                                explanation: "We know 2³ × 2³ = 2³⁺³ = 2⁶<br>So (2³)² = 2⁶!",
                                visual: "2³ × 2³ = 2³⁺³ = 2⁶"
                            },
                            {
                                title: "The pattern: MULTIPLY the exponents!",
                                explanation: "Notice: 3 × 2 = 6. When raising a power to a power, <strong>MULTIPLY the exponents</strong>!",
                                visual: "(2³)² = 2³×² = 2⁶"
                            },
                            {
                                title: "The Power Rule",
                                explanation: "<strong>(aᵐ)ⁿ = aᵐ×ⁿ</strong><br>When raising a power to a power, KEEP the base and MULTIPLY the exponents!",
                                visual: "(2³)² = 2⁶ = 64"
                            }
                        ],
                        finalAnswer: "2⁶",
                        answerExplanation: "(2³)² = 2³×² = 2⁶. When raising a power to a power, multiply the exponents: 3 × 2 = 6.",
                        example: { problem: `Simplify: (2³)²`, steps: [
                            { text: "Identify: power of a power - base 2, exponents 3 and 2", math: "Power Rule applies!" },
                            { text: "Keep the base, multiply the exponents", math: "(2³)² = 2³×²" },
                            { text: "Multiply the exponents", math: "3 × 2 = 6" },
                            { text: "Write the answer", math: "= <strong>2⁶</strong>" }
                        ]},
                        keyPoints: [
                            "Power Rule: (aᵐ)ⁿ = aᵐ×ⁿ (MULTIPLY the exponents)",
                            "Product Rule (multiplying): ADD exponents",
                            "Power Rule (power of power): MULTIPLY exponents"
                        ],
                        mistakes: [
                            { wrong: "(2³)² = 2⁵ (added exponents)", why: "MULTIPLY for power of power! (2³)² = 2⁶ because 3 × 2 = 6" },
                            { wrong: "(2³)² = 4³ (squared the base)", why: "Keep the base as 2! Just multiply the exponents: 2⁶" },
                            { wrong: "Confusing with product rule", why: "Multiplying powers: ADD (2³ × 2² = 2⁵). Power of power: MULTIPLY ((2³)² = 2⁶)" }
                        ],
                        guided: { problem: `Simplify: (${base}${superscripts[e1]})${superscripts[e2]}`, steps: [
                            { label: "Identify power of a power", value: `Base ${base}, exponents ${e1} and ${e2}` },
                            { label: "Apply Power Rule (multiply exponents)", value: `${e1} × ${e2} = ${product}` },
                            { label: "Write the answer", value: "?" }
                        ], answer: `${base}^${product}`, answerLabel: `(${base}${superscripts[e1]})${superscripts[e2]} = ?`,
                            interactiveSteps: [
                                {
                                    prompt: `Is (${base}${superscripts[e1]})${superscripts[e2]} a "power of a power" situation?`,
                                    hint: "We're raising a power to another power...",
                                    answer: "yes",
                                    acceptableAnswers: ["yes", "y", "yeah", "yep", "true"],
                                    commonMistakes: {
                                        "no": "Yes it is! We have a power (${base}${superscripts[e1]}) being raised to another power (${e2})."
                                    }
                                },
                                {
                                    prompt: `For power of a power, do we ADD or MULTIPLY the exponents?`,
                                    hint: "Product rule: add. Power rule: ...",
                                    answer: "multiply",
                                    acceptableAnswers: ["multiply", "times", "multiplication"],
                                    commonMistakes: {
                                        "add": "ADD is for multiplying same bases (product rule). For power of power, we MULTIPLY!"
                                    }
                                },
                                {
                                    prompt: `So for (${base}${superscripts[e1]})${superscripts[e2]}, we multiply: ${e1} × ${e2} = ?`,
                                    hint: `${e1} times ${e2}...`,
                                    answer: String(product),
                                    acceptableAnswers: [String(product)],
                                    commonMistakes: {
                                        [String(e1 + e2)]: `That's adding! For power of power, MULTIPLY: ${e1} × ${e2} = ${product}`
                                    }
                                },
                                {
                                    prompt: `Therefore, (${base}${superscripts[e1]})${superscripts[e2]} = ${base}^?`,
                                    hint: `The new exponent is ${e1} × ${e2}...`,
                                    answer: String(product),
                                    acceptableAnswers: [String(product), `${base}^${product}`, `${base}${superscripts[product]}`],
                                    commonMistakes: {
                                        [String(e1 + e2)]: `MULTIPLY exponents for power of power: ${base}^${product}`,
                                        [String(base * base)]: `Don't change the base! Keep ${base}, multiply exponents: ${base}^${product}`
                                    }
                                }
                            ]
                        },
                        practice: (() => {
                            const pb = rand(2, 3);
                            const pe1 = rand(2, 3), pe2 = rand(2, 3);
                            const pprod = pe1 * pe2;
                            return {
                                problem: `Simplify: (${pb}${superscripts[pe1]})${superscripts[pe2]}`,
                                answer: `${pb}^${pprod}`,
                                options: shuffle([`${pb}^${pprod}`, `${pb}^${pe1 + pe2}`, `${pb * pe2}^${pe1}`, `${pb}^${pe1}`]),
                                mistakeAnalysis: {
                                    [`${pb}^${pe1 + pe2}`]: `You added the exponents! For power of power, MULTIPLY: ${pe1} × ${pe2} = ${pprod}. Answer: ${pb}^${pprod}`,
                                    [`${pb * pe2}^${pe1}`]: `Don't multiply the base by the exponent! Keep base as ${pb}, multiply exponents: ${pb}^${pprod}`,
                                    [`${pb}^${pe1}`]: `You forgot to apply the outer exponent! ${pe1} × ${pe2} = ${pprod}. Answer: ${pb}^${pprod}`
                                }
                            };
                        })()
                    };
                })()
            ]
        }),
        "Angles and Lines": () => {
            const angle1 = rand(30, 70);
            const complement = 90 - angle1;
            const supplement = 180 - angle1;
            return {
                concept: `<strong>Angles</strong> are formed when two lines or rays meet at a point.<br><br>
                <strong>Types of angles:</strong><br>
                • <strong>Acute:</strong> less than 90° (sharp angle)<br>
                • <strong>Right:</strong> exactly 90° (square corner)<br>
                • <strong>Obtuse:</strong> between 90° and 180° (wide angle)<br>
                • <strong>Straight:</strong> exactly 180° (a line)<br><br>
                <strong>Special angle pairs:</strong><br>
                • <strong>Complementary:</strong> Two angles that add to 90°<br>
                • <strong>Supplementary:</strong> Two angles that add to 180°<br>
                • <strong>Vertical:</strong> Opposite angles formed by intersecting lines (they're EQUAL!)`,
                example: { problem: `Two angles are supplementary. One is 120°. Find the other.`, steps: [
                    { text: "Recall: supplementary means the angles add to 180°", math: "angle₁ + angle₂ = 180°" },
                    { text: "Substitute the known angle", math: "120° + angle₂ = 180°" },
                    { text: "Subtract 120° from both sides", math: "angle₂ = 180° - 120°" },
                    { text: "Calculate", math: "angle₂ = <strong>60°</strong>" },
                    { text: "Check: 120° + 60° = 180° ✓", math: "" }
                ]},
                keyPoints: [
                    "Complementary = 90° (think: C for Corner, which is 90°)",
                    "Supplementary = 180° (think: S for Straight line, which is 180°)",
                    "Vertical angles are always EQUAL to each other"
                ],
                mistakes: [
                    { wrong: "Confusing complementary (90°) and supplementary (180°)", why: "Remember: Complementary → Corner (90°), Supplementary → Straight (180°)" },
                    { wrong: "Subtracting from the wrong total", why: "Complementary: subtract from 90. Supplementary: subtract from 180." },
                    { wrong: "Thinking a 100° angle is complementary to something", why: "Complementary angles are each LESS than 90°. 100° is already bigger than 90°!" }
                ],
                guided: { problem: `Two complementary angles: one is ${angle1}°. Find the other.`, steps: [
                    { label: "Complementary means they add to", value: "90°" },
                    { label: `${angle1}° + ? = 90°`, value: `? = 90° - ${angle1}°` },
                    { label: "Calculate", value: "?" }
                ], answer: String(complement), answerLabel: "Other angle:",
                    interactiveSteps: [
                        {
                            prompt: "Complementary angles add up to what total?",
                            hint: "Think: C for Complementary = C for Corner (a right angle)...",
                            answer: "90",
                            acceptableAnswers: ["90", "90°", "90 degrees", "ninety"],
                            commonMistakes: {
                                "180": "That's supplementary! Complementary = 90° (think: Corner)",
                                "360": "That's a full circle. Complementary angles add to 90°"
                            }
                        },
                        {
                            prompt: `If the two angles add to 90°, and one is ${angle1}°, what equation can we write?`,
                            hint: `${angle1} + ? = 90`,
                            answer: `${angle1} + ? = 90`,
                            acceptableAnswers: [`${angle1} + ? = 90`, `${angle1}° + ? = 90°`, "90 - " + angle1, `? = 90 - ${angle1}`],
                            commonMistakes: {
                                [`${angle1} + ? = 180`]: "Complementary angles add to 90°, not 180°!"
                            }
                        },
                        {
                            prompt: `To find the missing angle, calculate: 90 - ${angle1} = ?`,
                            hint: `90 minus ${angle1}...`,
                            answer: String(complement),
                            acceptableAnswers: [String(complement), complement + "°"],
                            commonMistakes: {
                                [String(180 - angle1)]: `You subtracted from 180. For complementary, subtract from 90: 90 - ${angle1} = ${complement}`,
                                [String(angle1)]: `You need to subtract! 90 - ${angle1} = ${complement}`
                            }
                        },
                        {
                            prompt: `Check: Does ${angle1}° + ${complement}° = 90°?`,
                            hint: "Add them together...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "90", "90°", "correct", "true"],
                            commonMistakes: {
                                "no": `${angle1} + ${complement} = 90 ✓ It does equal 90°!`
                            }
                        }
                    ]
                },
                practice: { problem: `Find the supplement of ${angle1}°`, answer: String(supplement),
                    options: [String(complement), String(supplement), String(180), String(angle1)],
                    mistakeAnalysis: {
                        [String(complement)]: `That's the COMPLEMENT (adds to 90°). The SUPPLEMENT adds to 180°: 180° - ${angle1}° = ${supplement}°`,
                        [String(180)]: "180° is what supplementary angles add TO, not the missing angle.",
                        [String(angle1)]: `The supplement is 180° - ${angle1}° = ${supplement}°, not the same angle.`
                    }}
            };
        },
        "Algebraic Expressions": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Evaluating Expressions
                (() => {
                    const a = rand(2, 5), b = rand(1, 8), x = rand(2, 6);
                    const result = a * x + b;
                    // For practice use different values
                    const pa = rand(2, 4), pb = rand(2, 7), px = rand(3, 7);
                    const presult = pa * px + pb;
                    return {
                        id: "evaluate",
                        name: "Evaluating Expressions",
                        goalProblem: `Evaluate 3x + 5 when x = 4`,
                        teachingSteps: [
                            {
                                title: "What does 'evaluate' mean?",
                                explanation: "To <strong>evaluate</strong> an expression means to find its value when we know what the variable equals. We replace the variable with the given number!",
                                visual: "Evaluate = Substitute & Calculate"
                            },
                            {
                                title: "Understanding 3x",
                                explanation: "<strong>Important:</strong> 3x means '3 TIMES x', not '3 plus x'!<br>So if x = 4, then 3x = 3 × 4 = 12",
                                visual: "3x means 3 × x"
                            },
                            {
                                title: "Let's evaluate 3x + 5 when x = 4",
                                explanation: "Step 1: Replace every x with 4<br>3x + 5 becomes 3(4) + 5",
                                visual: "3x + 5 → 3(4) + 5"
                            },
                            {
                                title: "Calculate step by step",
                                explanation: "Step 2: Multiply first (PEMDAS!)<br>3 × 4 = 12<br>Step 3: Then add: 12 + 5 = 17",
                                visual: "3(4) + 5 = 12 + 5 = 17"
                            },
                            {
                                title: "The answer",
                                explanation: "When x = 4, the expression 3x + 5 equals <strong>17</strong>!",
                                visual: "3x + 5 = 17 (when x = 4)"
                            }
                        ],
                        finalAnswer: "17",
                        answerExplanation: "3x + 5 when x = 4: Replace x with 4, then 3(4) + 5 = 12 + 5 = 17",
                        example: { problem: `Evaluate 3x + 5 when x = 4`, steps: [
                            { text: "Replace x with 4", math: "3x + 5 → 3(4) + 5" },
                            { text: "Multiply first", math: "3 × 4 = 12" },
                            { text: "Then add", math: "12 + 5 = <strong>17</strong>" }
                        ]},
                        keyPoints: [
                            "3x means 3 TIMES x, not 3 plus x",
                            "Replace the variable with the given value",
                            "Follow PEMDAS: multiply before adding"
                        ],
                        mistakes: [
                            { wrong: "3x + 5 = 3 + 4 + 5 = 12", why: "3x means 3 × x, not 3 + x! Answer: 3 × 4 + 5 = 17" },
                            { wrong: "Adding before multiplying", why: "PEMDAS! Multiply 3 × x first, then add" }
                        ],
                        guided: { problem: `Evaluate ${a}x + ${b} when x = ${x}`, steps: [
                            { label: "Replace x with " + x, value: `${a}(${x}) + ${b}` },
                            { label: "Multiply first", value: `${a} × ${x} = ${a * x}` },
                            { label: "Then add", value: "?" }
                        ], answer: String(result), answerLabel: `${a}x + ${b} = ?`,
                            interactiveSteps: [
                                {
                                    prompt: `In ${a}x + ${b}, the ${a}x means ${a} times what?`,
                                    hint: "What letter is next to the ${a}?",
                                    answer: "x",
                                    acceptableAnswers: ["x", "times x", "${a} times x"],
                                    commonMistakes: {
                                        [String(b)]: "That's the constant. ${a}x means ${a} times x."
                                    }
                                },
                                {
                                    prompt: `If x = ${x}, what is ${a}x (${a} times x)?`,
                                    hint: `${a} × ${x} = ?`,
                                    answer: String(a * x),
                                    acceptableAnswers: [String(a * x)],
                                    commonMistakes: {
                                        [String(a + x)]: `That's ${a} + ${x}. Remember: ${a}x means ${a} × ${x} = ${a * x}`
                                    }
                                },
                                {
                                    prompt: `Now add the constant: ${a * x} + ${b} = ?`,
                                    hint: "Just add these two numbers...",
                                    answer: String(result),
                                    acceptableAnswers: [String(result)],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Evaluate ${pa}x + ${pb} when x = ${px}`,
                            answer: String(presult),
                            options: shuffle([String(presult), String(pa + px + pb), String(pa * px), String(pa + pb)]),
                            mistakeAnalysis: {
                                [String(pa + px + pb)]: `${pa}x means ${pa} × ${px}, not ${pa} + ${px}! So ${pa} × ${px} + ${pb} = ${presult}`,
                                [String(pa * px)]: `Don't forget to add the constant! ${pa} × ${px} + ${pb} = ${presult}`,
                                [String(pa + pb)]: `You forgot to substitute x = ${px}. Do ${pa} × ${px} + ${pb} = ${presult}`
                            }
                        }
                    };
                })(),

                // Sub-skill 2: Simplifying Expressions (combining like terms)
                (() => {
                    const coef1 = rand(2, 5), coef2 = rand(2, 4);
                    const const1 = rand(1, 6), const2 = rand(1, 5);
                    // For practice
                    const pc1 = rand(3, 6), pc2 = rand(2, 5);
                    const pn1 = rand(2, 8), pn2 = rand(1, 6);
                    return {
                        id: "simplify",
                        name: "Simplifying Expressions",
                        goalProblem: `Simplify: 4x + 3 + 2x + 5`,
                        teachingSteps: [
                            {
                                title: "What does 'simplify' mean?",
                                explanation: "To <strong>simplify</strong> an expression, we combine <strong>like terms</strong> to make it shorter and simpler.",
                                visual: "4x + 3 + 2x + 5 → simpler form"
                            },
                            {
                                title: "What are 'like terms'?",
                                explanation: "<strong>Like terms</strong> have the same variable part:<br>• 4x and 2x are like terms (both have x)<br>• 3 and 5 are like terms (both are constants)",
                                visual: "4x + 2x = like | 3 + 5 = like"
                            },
                            {
                                title: "Combine the x terms",
                                explanation: "Add the <strong>coefficients</strong> (numbers in front) of the x terms:<br>4x + 2x = 6x (because 4 + 2 = 6)",
                                visual: "4x + 2x = 6x"
                            },
                            {
                                title: "Combine the constants",
                                explanation: "Add the constant terms (plain numbers):<br>3 + 5 = 8",
                                visual: "3 + 5 = 8"
                            },
                            {
                                title: "Write the simplified expression",
                                explanation: "Put it together: <strong>6x + 8</strong><br>That's our simplified answer!",
                                visual: "4x + 3 + 2x + 5 = 6x + 8"
                            }
                        ],
                        finalAnswer: "6x + 8",
                        answerExplanation: "Combine like terms: (4x + 2x) + (3 + 5) = 6x + 8",
                        example: { problem: `Simplify: 4x + 3 + 2x + 5`, steps: [
                            { text: "Identify like terms", math: "x terms: 4x, 2x | Constants: 3, 5" },
                            { text: "Combine x terms", math: "4x + 2x = 6x" },
                            { text: "Combine constants", math: "3 + 5 = 8" },
                            { text: "Write answer", math: "<strong>6x + 8</strong>" }
                        ]},
                        keyPoints: [
                            "Like terms have the SAME variable part",
                            "Only add the coefficients - variable stays the same",
                            "3x + 5 cannot be simplified (different terms)"
                        ],
                        mistakes: [
                            { wrong: "3x + 5 = 8x", why: "3x and 5 are NOT like terms! 5 has no x." },
                            { wrong: "3x + 2x = 5x²", why: "Adding doesn't change the exponent! 3x + 2x = 5x" }
                        ],
                        guided: { problem: `Simplify: ${coef1}x + ${const1} + ${coef2}x + ${const2}`, steps: [
                            { label: "Combine x terms", value: `${coef1}x + ${coef2}x = ${coef1 + coef2}x` },
                            { label: "Combine constants", value: `${const1} + ${const2} = ${const1 + const2}` },
                            { label: "Final expression", value: "?" }
                        ], answer: `${coef1 + coef2}x + ${const1 + const2}`, answerLabel: "Simplified:",
                            interactiveSteps: [
                                {
                                    prompt: `Which terms have the variable x?`,
                                    hint: "Look for terms with 'x' in them...",
                                    answer: `${coef1}x and ${coef2}x`,
                                    acceptableAnswers: [`${coef1}x and ${coef2}x`, `${coef1}x, ${coef2}x`],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Combine: ${coef1}x + ${coef2}x = ?`,
                                    hint: `Add coefficients: ${coef1} + ${coef2} = ?`,
                                    answer: `${coef1 + coef2}x`,
                                    acceptableAnswers: [`${coef1 + coef2}x`, String(coef1 + coef2) + "x"],
                                    commonMistakes: {
                                        [String(coef1 + coef2)]: `Keep the x! ${coef1}x + ${coef2}x = ${coef1 + coef2}x`
                                    }
                                },
                                {
                                    prompt: `Combine constants: ${const1} + ${const2} = ?`,
                                    hint: "Just add the numbers...",
                                    answer: String(const1 + const2),
                                    acceptableAnswers: [String(const1 + const2)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Final answer: ${coef1 + coef2}x + ?`,
                                    hint: "Combine x terms with constants...",
                                    answer: `${coef1 + coef2}x + ${const1 + const2}`,
                                    acceptableAnswers: [`${coef1 + coef2}x + ${const1 + const2}`],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Simplify: ${pc1}x + ${pn1} + ${pc2}x + ${pn2}`,
                            answer: `${pc1 + pc2}x + ${pn1 + pn2}`,
                            options: shuffle([`${pc1 + pc2}x + ${pn1 + pn2}`, `${pc1 * pc2}x + ${pn1 + pn2}`, `${pc1 + pc2 + pn1 + pn2}x`, `${pc1 + pc2}x`]),
                            mistakeAnalysis: {
                                [`${pc1 * pc2}x + ${pn1 + pn2}`]: `ADD the coefficients, don't multiply! ${pc1} + ${pc2} = ${pc1 + pc2}`,
                                [`${pc1 + pc2 + pn1 + pn2}x`]: `Can't combine x terms with constants! Keep them separate.`,
                                [`${pc1 + pc2}x`]: `Don't forget the constants! ${pn1} + ${pn2} = ${pn1 + pn2}`
                            }
                        }
                    };
                })(),

                // Sub-skill 3: Translating Words to Algebra
                (() => {
                    const num1 = rand(3, 8), num2 = rand(2, 6);
                    return {
                        id: "translate",
                        name: "Translating Words to Algebra",
                        goalProblem: `Write as an expression: "5 more than a number x"`,
                        teachingSteps: [
                            {
                                title: "Algebra is a language!",
                                explanation: "We can translate <strong>word phrases</strong> into <strong>algebraic expressions</strong>. This is super useful for solving real-world problems!",
                                visual: "Words → Algebra"
                            },
                            {
                                title: "Key translation words",
                                explanation: "<strong>Addition (+):</strong> more than, sum, plus, increased by, total<br><strong>Subtraction (−):</strong> less than, minus, decreased by, difference",
                                visual: "more than → + | less than → −"
                            },
                            {
                                title: "More key words",
                                explanation: "<strong>Multiplication (×):</strong> times, product, of, twice (×2), triple (×3)<br><strong>Division (÷):</strong> divided by, quotient, per, ratio",
                                visual: "times → × | divided by → ÷"
                            },
                            {
                                title: "Let's translate: '5 more than a number x'",
                                explanation: "'5 more than' means we ADD 5<br>'a number x' is just x<br>So: x + 5",
                                visual: "5 more than x → x + 5"
                            },
                            {
                                title: "Watch the order!",
                                explanation: "'5 more than x' = x + 5 (either x + 5 or 5 + x)<br>'5 less than x' = x − 5 (NOT 5 − x!)<br>For 'less than', subtract FROM the number!",
                                visual: "x + 5 ✓ | x − 5 ✓"
                            }
                        ],
                        finalAnswer: "x + 5",
                        answerExplanation: "'5 more than a number x' means start with x and add 5, giving us x + 5.",
                        example: { problem: `Write "5 more than a number x" as an expression`, steps: [
                            { text: "Identify the operation", math: "'more than' = addition" },
                            { text: "Identify the variable", math: "'a number' = x" },
                            { text: "Write the expression", math: "<strong>x + 5</strong> (or 5 + x)" }
                        ]},
                        keyPoints: [
                            "'more than' and 'plus' mean addition",
                            "'less than' means subtraction (be careful with order!)",
                            "'times' and 'of' usually mean multiplication"
                        ],
                        mistakes: [
                            { wrong: "'5 less than x' = 5 − x", why: "Order matters! '5 less than x' means x − 5 (subtract 5 FROM x)" },
                            { wrong: "'twice a number' = x + 2", why: "'Twice' means multiply by 2: 2x, not x + 2" }
                        ],
                        guided: { problem: `Write as an expression: "${num1} less than a number x"`, steps: [
                            { label: "'less than' means", value: "subtraction (−)" },
                            { label: "'a number' is", value: "x" },
                            { label: `${num1} less than x =`, value: "?" }
                        ], answer: `x - ${num1}`, answerLabel: "Expression:",
                            interactiveSteps: [
                                {
                                    prompt: `What operation does 'less than' indicate?`,
                                    hint: "If you have 'less' of something, you...",
                                    answer: "subtraction",
                                    acceptableAnswers: ["subtraction", "subtract", "minus", "-"],
                                    commonMistakes: {
                                        "addition": "'Less than' means subtraction! 'More than' means addition."
                                    }
                                },
                                {
                                    prompt: `For '${num1} less than x', do we write ${num1} - x or x - ${num1}?`,
                                    hint: "We're taking ${num1} away FROM x...",
                                    answer: `x - ${num1}`,
                                    acceptableAnswers: [`x - ${num1}`, `x-${num1}`],
                                    commonMistakes: {
                                        [`${num1} - x`]: "Order matters! '${num1} less than x' means start with x, subtract ${num1}: x - ${num1}"
                                    }
                                }
                            ]
                        },
                        practice: {
                            problem: `Write as an expression: "twice a number x, plus ${num2}"`,
                            answer: `2x + ${num2}`,
                            options: shuffle([`2x + ${num2}`, `x + 2 + ${num2}`, `2 + x + ${num2}`, `${num2}x + 2`]),
                            mistakeAnalysis: {
                                [`x + 2 + ${num2}`]: `'Twice' means multiply by 2, not add 2! Twice x = 2x`,
                                [`2 + x + ${num2}`]: `'Twice a number' means 2 × x = 2x, not 2 + x`,
                                [`${num2}x + 2`]: `'Twice x' is 2x, then 'plus ${num2}' adds ${num2}: 2x + ${num2}`
                            }
                        }
                    };
                })()
            ]
        }),
        "Order of Operations": () => {
            const a = rand(2, 5), b = rand(3, 6), c = rand(1, 4);
            return {
                concept: `<strong>Order of Operations</strong> tells us which operations to do first.<br><br>
                <strong>PEMDAS (Please Excuse My Dear Aunt Sally):</strong><br>
                1. <strong>P</strong>arentheses - Do what's inside first<br>
                2. <strong>E</strong>xponents - Powers next<br>
                3. <strong>M</strong>ultiplication & <strong>D</strong>ivision - Left to right<br>
                4. <strong>A</strong>ddition & <strong>S</strong>ubtraction - Left to right<br><br>
                <strong>Important:</strong> Multiplication/Division are done together (left to right), same for Addition/Subtraction`,
                example: { problem: `Evaluate: 3 + 4 × 2`, steps: [
                    { text: "Check for parentheses", math: "None" },
                    { text: "Check for exponents", math: "None" },
                    { text: "Do multiplication BEFORE addition", math: "4 × 2 = 8" },
                    { text: "Then add", math: "3 + 8 = <strong>11</strong>" },
                    { text: "NOT: 3 + 4 = 7, then 7 × 2 = 14", math: "(That's wrong!)" }
                ]},
                keyPoints: [
                    "Multiplication and division come BEFORE addition and subtraction",
                    "When you have × and ÷ together, go left to right",
                    "Parentheses first, always!"
                ],
                mistakes: [
                    { wrong: "3 + 4 × 2 = 14 (adding first)", why: "Multiplication comes before addition! Do 4 × 2 = 8 first, then 3 + 8 = 11" },
                    { wrong: "10 - 3 + 2 = 5 (doing subtraction first always)", why: "Addition and subtraction: go LEFT to RIGHT. 10 - 3 = 7, then 7 + 2 = 9" }
                ],
                guided: { problem: `Evaluate: ${a} + ${b} × ${c}`, steps: [
                    { label: "Which operation first?", value: "Multiplication (PEMDAS)" },
                    { label: `${b} × ${c} =`, value: `${b * c}` },
                    { label: `Then: ${a} + ${b * c} =`, value: "?" }
                ], answer: String(a + b * c), answerLabel: "Answer:",
                    interactiveSteps: [
                        {
                            prompt: `In ${a} + ${b} × ${c}, we have addition and multiplication. Which do we do FIRST according to PEMDAS?`,
                            hint: "PEMDAS: Parentheses, Exponents, Multiplication/Division, Addition/Subtraction",
                            answer: "multiplication",
                            acceptableAnswers: ["multiplication", "multiply", "×", "the multiplication", `${b} × ${c}`],
                            commonMistakes: {
                                "addition": "Multiplication comes BEFORE addition in PEMDAS! Do ${b} × ${c} first."
                            }
                        },
                        {
                            prompt: `Do the multiplication first: ${b} × ${c} = ?`,
                            hint: `${b} times ${c}...`,
                            answer: String(b * c),
                            acceptableAnswers: [String(b * c)],
                            commonMistakes: {
                                [String(b + c)]: `That's ${b} + ${c}. We need ${b} × ${c} = ${b * c}`,
                                [String(a + b)]: `Do ${b} × ${c} first, not add ${a}. ${b} × ${c} = ${b * c}`
                            }
                        },
                        {
                            prompt: `Now we have: ${a} + ${b * c}. Calculate this:`,
                            hint: `${a} + ${b * c} = ?`,
                            answer: String(a + b * c),
                            acceptableAnswers: [String(a + b * c)],
                            commonMistakes: {
                                [String((a + b) * c)]: `That's (${a}+${b})×${c}. We already did the multiplication: ${a} + ${b * c} = ${a + b * c}`
                            }
                        },
                        {
                            prompt: `So ${a} + ${b} × ${c} = ?`,
                            hint: `Multiplication first (${b * c}), then add ${a}`,
                            answer: String(a + b * c),
                            acceptableAnswers: [String(a + b * c)],
                            commonMistakes: {
                                [String((a + b) * c)]: `Remember PEMDAS: multiply first! ${b} × ${c} = ${b * c}, then ${a} + ${b * c} = ${a + b * c}`
                            }
                        }
                    ]
                },
                practice: { problem: `Evaluate: 8 ÷ 2 + 3 × 4`, answer: "16",
                    options: ["16", "20", "7", "28"],
                    mistakeAnalysis: {
                        "20": "Check order: 8÷2=4, 3×4=12, then 4+12=16. Did you do 8÷(2+3)×4?",
                        "7": "Do × and ÷ first (left to right), then add: 8÷2=4, 3×4=12, 4+12=16",
                        "28": "Division and multiplication go left to right BEFORE adding: 4+12=16, not 8÷2×14"
                    }}
            };
        },
        Slope: () => {
            const rise = rand(1, 4), run = rand(2, 5);
            return {
                concept: `<strong>Slope</strong> measures how steep a line is - how much it rises or falls as you move right.<br><br>
                <strong>The formula:</strong><br>
                slope = rise/run = (change in y)/(change in x) = (y₂ - y₁)/(x₂ - x₁)<br><br>
                <strong>Types of slope:</strong><br>
                • <strong>Positive slope:</strong> Line goes UP as you move right ↗<br>
                • <strong>Negative slope:</strong> Line goes DOWN as you move right ↘<br>
                • <strong>Zero slope:</strong> Horizontal line (flat) →<br>
                • <strong>Undefined slope:</strong> Vertical line (straight up) ↑`,
                example: { problem: `Find the slope of the line through (1, 2) and (4, 8)`, steps: [
                    { text: "Identify the points", math: "(x₁, y₁) = (1, 2) and (x₂, y₂) = (4, 8)" },
                    { text: "Find the rise (change in y)", math: "rise = y₂ - y₁ = 8 - 2 = 6" },
                    { text: "Find the run (change in x)", math: "run = x₂ - x₁ = 4 - 1 = 3" },
                    { text: "Calculate slope = rise/run", math: "slope = 6/3 = <strong>2</strong>" },
                    { text: "Interpret: For every 1 unit right, the line goes up 2 units", math: "" }
                ]},
                keyPoints: [
                    "Slope = rise/run = vertical change / horizontal change",
                    "Positive slope: line goes up; Negative slope: line goes down",
                    "Slope of 2 means 'for every 1 right, go up 2'"
                ],
                mistakes: [
                    { wrong: "Putting run over rise (run/rise)", why: "Remember: RISE over RUN. The y-change (vertical) goes on TOP." },
                    { wrong: "Subtracting in different orders: (y₂-y₁)/(x₁-x₂)", why: "Use the SAME order: (y₂-y₁)/(x₂-x₁) OR (y₁-y₂)/(x₁-x₂)" },
                    { wrong: "Confusing which is rise and which is run", why: "Rise = up/down (y-values). Run = left/right (x-values)." }
                ],
                guided: { problem: `Find the slope of the line through (2, 3) and (${2 + run}, ${3 + rise})`, steps: [
                    { label: "Rise (change in y)", value: `${3 + rise} - 3 = ${rise}` },
                    { label: "Run (change in x)", value: `${2 + run} - 2 = ${run}` },
                    { label: "Slope = rise/run", value: "?" }
                ], answer: `${rise}/${run}`, answerLabel: "Slope:",
                    interactiveSteps: [
                        {
                            prompt: "Slope is calculated as rise over run. Which values give us the RISE (change in y)?",
                            hint: "Rise = vertical change = y-values (the second number in each point)",
                            answer: "y values",
                            acceptableAnswers: ["y values", "y", "the y values", "y-values", "3 and " + (3 + rise), (3 + rise) + " and 3"],
                            commonMistakes: {
                                "x values": "X-values give us the RUN (horizontal). Y-values give us the RISE (vertical)."
                            }
                        },
                        {
                            prompt: `Find the rise: y₂ - y₁ = ${3 + rise} - 3 = ?`,
                            hint: `${3 + rise} minus 3...`,
                            answer: String(rise),
                            acceptableAnswers: [String(rise)],
                            commonMistakes: {
                                [String(3 + rise)]: `You need to subtract! ${3 + rise} - 3 = ${rise}`,
                                [String(3 - (3 + rise))]: `Subtract in the right order: y₂ - y₁ = ${3 + rise} - 3 = ${rise}`
                            }
                        },
                        {
                            prompt: `Now find the run: x₂ - x₁ = ${2 + run} - 2 = ?`,
                            hint: `${2 + run} minus 2...`,
                            answer: String(run),
                            acceptableAnswers: [String(run)],
                            commonMistakes: {
                                [String(2 + run)]: `You need to subtract! ${2 + run} - 2 = ${run}`
                            }
                        },
                        {
                            prompt: `Slope = rise/run. With rise = ${rise} and run = ${run}, what is the slope?`,
                            hint: `Put rise over run: ${rise}/${run}`,
                            answer: `${rise}/${run}`,
                            acceptableAnswers: [`${rise}/${run}`, `${rise} / ${run}`, Number.isInteger(rise/run) ? String(rise/run) : `${rise}/${run}`],
                            commonMistakes: {
                                [`${run}/${rise}`]: `You put run over rise! Remember: RISE over RUN. The slope is ${rise}/${run}`
                            }
                        }
                    ]
                },
                practice: { problem: `Find the slope through (0, 0) and (4, 12)`, answer: "3",
                    options: ["1/3", "3", "4", "12"],
                    mistakeAnalysis: {
                        "1/3": "You put run over rise. Slope = rise/run = 12/4 = 3",
                        "4": "That's the x-coordinate. Slope = rise/run = (12-0)/(4-0) = 12/4 = 3",
                        "12": "That's the rise. Divide by the run: 12/4 = 3"
                    }}
            };
        },
        Pythagorean: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Finding the Hypotenuse
                (() => {
                    const a = rand(3, 5), b = rand(4, 8);
                    const c = Math.sqrt(a * a + b * b);
                    const cRounded = Math.round(c * 10) / 10;
                    return {
                        id: "hyp",
                        name: "Finding the Hypotenuse",
                        goalProblem: `A right triangle has legs 3 and 4. Find the hypotenuse.`,
                        teachingSteps: [
                            {
                                title: "What is the Pythagorean Theorem?",
                                explanation: "The <strong>Pythagorean Theorem</strong> is a formula that works for RIGHT triangles (triangles with a 90° angle). It relates the three sides of the triangle.",
                                visual: "Right triangle: a² + b² = c²"
                            },
                            {
                                title: "The three sides",
                                explanation: "• <strong>a</strong> and <strong>b</strong> are the two shorter sides called 'legs'<br>• <strong>c</strong> is the longest side called the 'hypotenuse' - it's ALWAYS opposite the right angle",
                                visual: "Legs: a, b | Hypotenuse: c (longest)"
                            },
                            {
                                title: "Let's find the hypotenuse!",
                                explanation: "Given legs 3 and 4, we use a² + b² = c²<br>Step 1: Square each leg: 3² = 9 and 4² = 16",
                                visual: "3² + 4² = 9 + 16"
                            },
                            {
                                title: "Add the squares",
                                explanation: "Step 2: Add the squares together:<br>9 + 16 = 25<br>So c² = 25",
                                visual: "c² = 25"
                            },
                            {
                                title: "Take the square root",
                                explanation: "Step 3: To find c, take the square root of both sides:<br>c = √25 = <strong>5</strong><br>The hypotenuse is 5!",
                                visual: "c = √25 = 5"
                            }
                        ],
                        finalAnswer: "5",
                        answerExplanation: "Using a² + b² = c²: 3² + 4² = 9 + 16 = 25, so c = √25 = 5. The hypotenuse is 5.",
                        example: { problem: `A right triangle has legs of 3 and 4. Find the hypotenuse.`, steps: [
                            { text: "Write the Pythagorean theorem", math: "a² + b² = c²" },
                            { text: "Substitute the known values", math: "3² + 4² = c²" },
                            { text: "Calculate the squares", math: "9 + 16 = c²" },
                            { text: "Add", math: "25 = c²" },
                            { text: "Take the square root", math: "c = √25 = <strong>5</strong>" }
                        ]},
                        keyPoints: [
                            "a² + b² = c² where c is the LONGEST side (hypotenuse)",
                            "Only works for RIGHT triangles (with a 90° angle)",
                            "Common triples: 3-4-5, 5-12-13, 8-15-17"
                        ],
                        mistakes: [
                            { wrong: "Adding sides instead of squaring: 3 + 4 = 7", why: "You must SQUARE each leg first: 3² + 4² = 9 + 16 = 25, then √25 = 5" },
                            { wrong: "Forgetting to take the square root at the end", why: "c² = 25 means c = √25 = 5, not c = 25" }
                        ],
                        guided: { problem: `A right triangle has legs ${a} and ${b}. Find the hypotenuse.`, steps: [
                            { label: "a² + b² = c²", value: `${a}² + ${b}² = c²` },
                            { label: "Calculate squares", value: `${a*a} + ${b*b} = ${a*a + b*b}` },
                            { label: "c = √" + (a*a + b*b) + " =", value: "?" }
                        ], answer: Number.isInteger(c) ? String(c) : String(cRounded), answerLabel: "Hypotenuse:",
                            interactiveSteps: [
                                {
                                    prompt: "What is the Pythagorean theorem formula?",
                                    hint: "The squares of the two legs equal the square of the hypotenuse...",
                                    answer: "a² + b² = c²",
                                    acceptableAnswers: ["a² + b² = c²", "a^2 + b^2 = c^2", "a2 + b2 = c2", "a^2+b^2=c^2"],
                                    commonMistakes: {
                                        "a + b = c": "You need to SQUARE each side! a² + b² = c²"
                                    }
                                },
                                {
                                    prompt: `Calculate ${a}² (${a} squared):`,
                                    hint: `${a} × ${a} = ?`,
                                    answer: String(a * a),
                                    acceptableAnswers: [String(a * a)],
                                    commonMistakes: {
                                        [String(a * 2)]: `That's ${a} × 2. Squaring means ${a} × ${a} = ${a * a}`
                                    }
                                },
                                {
                                    prompt: `Calculate ${b}² (${b} squared):`,
                                    hint: `${b} × ${b} = ?`,
                                    answer: String(b * b),
                                    acceptableAnswers: [String(b * b)],
                                    commonMistakes: {
                                        [String(b * 2)]: `That's ${b} × 2. Squaring means ${b} × ${b} = ${b * b}`
                                    }
                                },
                                {
                                    prompt: `Add the squares: ${a * a} + ${b * b} = ?`,
                                    hint: `This gives us c²...`,
                                    answer: String(a * a + b * b),
                                    acceptableAnswers: [String(a * a + b * b)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `c² = ${a * a + b * b}. Take the square root: √${a * a + b * b} = ?`,
                                    hint: `What number times itself equals ${a * a + b * b}?`,
                                    answer: Number.isInteger(c) ? String(c) : String(cRounded),
                                    acceptableAnswers: Number.isInteger(c) ? [String(c)] : [String(cRounded), String(Math.round(c)), c.toFixed(1)],
                                    commonMistakes: {
                                        [String(a * a + b * b)]: `That's c². Take the square root to find c.`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `A right triangle has legs 6 and 8. Find the hypotenuse.`, answer: "10",
                            options: shuffle(["10", "14", "48", "100"]),
                            mistakeAnalysis: {
                                "14": "You added 6 + 8 = 14. You must square first: 6² + 8² = 36 + 64 = 100, then √100 = 10",
                                "48": "That's 6 × 8. Use a² + b² = c²: 36 + 64 = 100, c = √100 = 10",
                                "100": "That's c². Take the square root: √100 = 10"
                            }}
                    };
                })(),

                // Sub-skill 2: Finding a Missing Leg
                (() => {
                    // Use Pythagorean triples for clean answers
                    const triples = [[3,4,5], [5,12,13], [6,8,10], [8,15,17]];
                    const [a, b, c] = triples[rand(0, triples.length - 1)];
                    // For practice, use a different triple
                    const [pa, pb, pc] = triples[(rand(0, triples.length - 1) + 1) % triples.length];
                    return {
                        id: "leg",
                        name: "Finding a Missing Leg",
                        goalProblem: `A right triangle has one leg = 3 and hypotenuse = 5. Find the other leg.`,
                        teachingSteps: [
                            {
                                title: "What if we know the hypotenuse?",
                                explanation: "Sometimes we know the <strong>hypotenuse</strong> (c) and <strong>one leg</strong> (a), and need to find the <strong>other leg</strong> (b). We need to rearrange the formula!",
                                visual: "Given: a and c | Find: b"
                            },
                            {
                                title: "Rearranging the formula",
                                explanation: "Start with: a² + b² = c²<br>To find b, we need to <strong>isolate b²</strong>:<br>b² = c² - a²",
                                visual: "a² + b² = c² → b² = c² - a²"
                            },
                            {
                                title: "Let's solve: leg = 3, hypotenuse = 5",
                                explanation: "We have a = 3 and c = 5. Find b.<br>b² = c² - a²<br>b² = 5² - 3²",
                                visual: "b² = 5² - 3²"
                            },
                            {
                                title: "Calculate the squares and subtract",
                                explanation: "5² = 25 and 3² = 9<br>b² = 25 - 9 = 16",
                                visual: "b² = 25 - 9 = 16"
                            },
                            {
                                title: "Take the square root",
                                explanation: "b² = 16<br>b = √16 = <strong>4</strong><br>The missing leg is 4!",
                                visual: "b = √16 = 4"
                            }
                        ],
                        finalAnswer: "4",
                        answerExplanation: "Using b² = c² - a²: b² = 5² - 3² = 25 - 9 = 16, so b = √16 = 4.",
                        example: { problem: `Right triangle: leg = 3, hypotenuse = 5. Find the other leg.`, steps: [
                            { text: "Rearrange: b² = c² - a²", math: "b² = 5² - 3²" },
                            { text: "Calculate squares", math: "b² = 25 - 9" },
                            { text: "Subtract", math: "b² = 16" },
                            { text: "Take square root", math: "b = √16 = <strong>4</strong>" }
                        ]},
                        keyPoints: [
                            "To find a leg: b² = c² - a² (SUBTRACT from hypotenuse squared)",
                            "The hypotenuse (c) is always the LARGEST number",
                            "Remember: hypotenuse² - leg² = other leg²"
                        ],
                        mistakes: [
                            { wrong: "Adding instead of subtracting: 25 + 9 = 34", why: "When finding a leg, SUBTRACT: c² - a² = b²" },
                            { wrong: "Using the wrong formula: a² + b² when you know c", why: "Rearrange to: b² = c² - a² when finding a leg" },
                            { wrong: "Subtracting in wrong order: 9 - 25 = -16", why: "Always subtract the smaller square from the larger (hypotenuse)!" }
                        ],
                        guided: { problem: `Right triangle: leg = ${a}, hypotenuse = ${c}. Find the other leg.`, steps: [
                            { label: "b² = c² - a²", value: `b² = ${c}² - ${a}²` },
                            { label: "Calculate", value: `b² = ${c*c} - ${a*a} = ${b*b}` },
                            { label: "b = √" + (b*b) + " =", value: "?" }
                        ], answer: String(b), answerLabel: "Missing leg:",
                            interactiveSteps: [
                                {
                                    prompt: "To find a missing leg, what formula do we use?",
                                    hint: "Rearrange a² + b² = c² to solve for b²...",
                                    answer: "b² = c² - a²",
                                    acceptableAnswers: ["b² = c² - a²", "b^2 = c^2 - a^2", "b2 = c2 - a2", "c² - a² = b²", "c^2 - a^2 = b^2"],
                                    commonMistakes: {
                                        "a² + b² = c²": "That's the original formula. Rearrange it: b² = c² - a²",
                                        "b² = a² + c²": "Wrong operation! SUBTRACT from hypotenuse: b² = c² - a²"
                                    }
                                },
                                {
                                    prompt: `Calculate ${c}² (hypotenuse squared):`,
                                    hint: `${c} × ${c} = ?`,
                                    answer: String(c * c),
                                    acceptableAnswers: [String(c * c)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Calculate ${a}² (known leg squared):`,
                                    hint: `${a} × ${a} = ?`,
                                    answer: String(a * a),
                                    acceptableAnswers: [String(a * a)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Now subtract: ${c * c} - ${a * a} = ?`,
                                    hint: `This gives us b²...`,
                                    answer: String(b * b),
                                    acceptableAnswers: [String(b * b)],
                                    commonMistakes: {
                                        [String(c * c + a * a)]: `Subtract, don't add! ${c * c} - ${a * a} = ${b * b}`
                                    }
                                },
                                {
                                    prompt: `b² = ${b * b}. Take the square root: √${b * b} = ?`,
                                    hint: `What number times itself equals ${b * b}?`,
                                    answer: String(b),
                                    acceptableAnswers: [String(b)],
                                    commonMistakes: {
                                        [String(b * b)]: `That's b². Take the square root: √${b * b} = ${b}`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Right triangle: leg = ${pa}, hypotenuse = ${pc}. Find the other leg.`, answer: String(pb),
                            options: shuffle([String(pb), String(pa + pc), String(pc - pa), String(Math.round(Math.sqrt(pa * pa + pc * pc)))]),
                            mistakeAnalysis: {
                                [String(pa + pc)]: `You added! Use b² = c² - a²: ${pc}² - ${pa}² = ${pc*pc} - ${pa*pa} = ${pb*pb}, so b = ${pb}`,
                                [String(pc - pa)]: `You subtracted the values, not their squares! ${pc}² - ${pa}² = ${pc*pc} - ${pa*pa} = ${pb*pb}, √${pb*pb} = ${pb}`,
                                [String(Math.round(Math.sqrt(pa * pa + pc * pc)))]: `That would be if you added the squares. For a leg, SUBTRACT: ${pc}² - ${pa}² = ${pb*pb}, so b = ${pb}`
                            }}
                    };
                })()
            ]
        }),
        "Surface Area": () => {
            const l = rand(3, 6), w = rand(2, 5), h = rand(2, 4);
            const sa = 2 * (l * w + l * h + w * h);
            return {
                goalProblem: `Find the surface area of a rectangular prism: length = 4, width = 3, height = 2`,
                teachingSteps: [
                    {
                        title: "What is surface area?",
                        explanation: "<strong>Surface area</strong> is the total area of ALL the faces (outside surfaces) of a 3D shape. Imagine wrapping the shape in paper - how much paper do you need?",
                        visual: "Surface Area = area of all outside faces"
                    },
                    {
                        title: "A rectangular prism has 6 faces",
                        explanation: "A box shape has 6 rectangular faces: <strong>top/bottom</strong>, <strong>front/back</strong>, and <strong>left/right</strong>. Opposite faces are identical!",
                        visual: "6 faces: 2 top/bottom, 2 front/back, 2 left/right"
                    },
                    {
                        title: "Find the area of each pair",
                        explanation: "• Top/Bottom: length × width = 4 × 3 = 12 (×2 = 24)<br>• Front/Back: length × height = 4 × 2 = 8 (×2 = 16)<br>• Left/Right: width × height = 3 × 2 = 6 (×2 = 12)",
                        visual: "2(l×w) + 2(l×h) + 2(w×h)"
                    },
                    {
                        title: "The formula",
                        explanation: "<strong>SA = 2lw + 2lh + 2wh</strong> or SA = 2(lw + lh + wh). Both give the same answer!",
                        visual: "SA = 2(lw + lh + wh)"
                    },
                    {
                        title: "Calculate!",
                        explanation: "SA = 2(4×3 + 4×2 + 3×2) = 2(12 + 8 + 6) = 2(26) = <strong>52 square units</strong>",
                        visual: "SA = 52 square units"
                    }
                ],
                finalAnswer: "52 square units",
                answerExplanation: "SA = 2(lw + lh + wh) = 2(12 + 8 + 6) = 2(26) = 52 square units",
                example: { problem: `Find the surface area: l=4, w=3, h=2`, steps: [
                    { text: "Identify the three different face types", math: "top/bottom, front/back, left/right" },
                    { text: "Calculate each face area", math: "l×w=12, l×h=8, w×h=6" },
                    { text: "Double each (opposite faces)", math: "24 + 16 + 12" },
                    { text: "Add all faces", math: "<strong>SA = 52 sq units</strong>" }
                ]},
                keyPoints: [
                    "Surface area = total area of ALL outside faces",
                    "Rectangular prism: SA = 2lw + 2lh + 2wh",
                    "Cube: SA = 6s² (all faces are identical squares)"
                ],
                mistakes: [
                    { wrong: "Finding volume instead: l × w × h = 24", why: "That's VOLUME (inside space). Surface area is the OUTSIDE area of all faces." },
                    { wrong: "Forgetting to multiply by 2", why: "Each face type appears TWICE (front/back, top/bottom, left/right)." },
                    { wrong: "Only finding one face: 4 × 3 = 12", why: "There are 6 faces total! Add all pairs: 2(12) + 2(8) + 2(6) = 52" }
                ],
                guided: {
                    problem: `Find the surface area of a rectangular prism: l=${l}, w=${w}, h=${h}`,
                    steps: [
                        { label: "Top/Bottom area (l×w)", value: `${l} × ${w} = ${l * w}` },
                        { label: "Front/Back area (l×h)", value: `${l} × ${h} = ${l * h}` },
                        { label: "Left/Right area (w×h)", value: `${w} × ${h} = ${w * h}` },
                        { label: "Total SA = 2(all three)", value: "?" }
                    ],
                    answer: String(sa),
                    answerLabel: "Surface Area:",
                    interactiveSteps: [
                        {
                            prompt: "How many faces does a rectangular prism (box) have?",
                            hint: "Count: top, bottom, front, back, left, right...",
                            answer: "6",
                            acceptableAnswers: ["6", "six"],
                            commonMistakes: {
                                "4": "That's a rectangle! A 3D box has 6 faces.",
                                "8": "That's the number of corners (vertices). Faces = 6."
                            }
                        },
                        {
                            prompt: `Calculate the top/bottom face area: ${l} × ${w} = ?`,
                            hint: "Length times width...",
                            answer: String(l * w),
                            acceptableAnswers: [String(l * w)],
                            commonMistakes: {
                                [String(l + w)]: `Multiply, not add! ${l} × ${w} = ${l * w}`
                            }
                        },
                        {
                            prompt: `Calculate the front/back face area: ${l} × ${h} = ?`,
                            hint: "Length times height...",
                            answer: String(l * h),
                            acceptableAnswers: [String(l * h)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate the left/right face area: ${w} × ${h} = ?`,
                            hint: "Width times height...",
                            answer: String(w * h),
                            acceptableAnswers: [String(w * h)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now find total SA: 2(${l * w} + ${l * h} + ${w * h}) = 2(${l * w + l * h + w * h}) = ?`,
                            hint: "Multiply the sum by 2...",
                            answer: String(sa),
                            acceptableAnswers: [String(sa), sa + " square units"],
                            commonMistakes: {
                                [String(l * w + l * h + w * h)]: `Don't forget to multiply by 2! Each face type appears twice: 2 × ${l * w + l * h + w * h} = ${sa}`,
                                [String(l * w * h)]: `That's volume! Surface area = 2(lw + lh + wh) = ${sa}`
                            }
                        }
                    ]
                },
                practice: (() => { const pl = 5, pw = 4, ph = 3, psa = 2 * (pl * pw + pl * ph + pw * ph); return {
                    problem: `Find the surface area: l=${pl}, w=${pw}, h=${ph}`, answer: String(psa),
                    options: shuffle([String(psa), String(pl * pw * ph), String(pl * pw + pl * ph + pw * ph), String(2 * pl * pw)]),
                    mistakeAnalysis: {
                        [String(pl * pw * ph)]: "That's VOLUME (l×w×h). Surface area = 2(lw + lh + wh)",
                        [String(pl * pw + pl * ph + pw * ph)]: "Close! But you forgot to multiply by 2. Each face appears twice.",
                        [String(2 * pl * pw)]: "That's just the top and bottom. Include all 6 faces!"
                    }}; })()
            };
        },
        "Two-Way Tables": () => {
            const a = rand(10, 20), b = rand(15, 25), c = rand(12, 22), d = rand(8, 18);
            const total = a + b + c + d;
            return {
                goalProblem: `Use the two-way table to find how many students play sports`,
                teachingSteps: [
                    {
                        title: "What is a two-way table?",
                        explanation: "A <strong>two-way table</strong> displays data for TWO categorical variables. It shows how data falls into different combinations of categories.",
                        visual: "Rows = one variable, Columns = another variable"
                    },
                    {
                        title: "Reading a two-way table",
                        explanation: "Example: Students surveyed about sports and music.<br><table border='1' style='border-collapse:collapse;margin:10px 0'><tr><th></th><th>Plays Sports</th><th>No Sports</th></tr><tr><td>Plays Music</td><td>15</td><td>10</td></tr><tr><td>No Music</td><td>20</td><td>5</td></tr></table>",
                        visual: "Each cell shows count for that combination"
                    },
                    {
                        title: "Finding row/column totals",
                        explanation: "Add across for row totals, add down for column totals.<br>• Plays Sports total: 15 + 20 = 35<br>• Plays Music total: 15 + 10 = 25",
                        visual: "Row totals: add across | Column totals: add down"
                    },
                    {
                        title: "Finding the grand total",
                        explanation: "Add ALL cells: 15 + 10 + 20 + 5 = <strong>50 students</strong>. Or add row totals: 25 + 25 = 50.",
                        visual: "Grand Total = 50"
                    },
                    {
                        title: "Answering questions",
                        explanation: "How many play sports? Add the 'Plays Sports' column: 15 + 20 = <strong>35 students</strong>.",
                        visual: "35 students play sports"
                    }
                ],
                finalAnswer: "35 students",
                answerExplanation: "Add the 'Plays Sports' column: 15 + 20 = 35 students play sports.",
                example: { problem: `How many students play sports?`, steps: [
                    { text: "Find the 'Plays Sports' column", math: "Values: 15 and 20" },
                    { text: "Add the column", math: "15 + 20 = 35" },
                    { text: "Answer", math: "<strong>35 students play sports</strong>" }
                ]},
                keyPoints: [
                    "Two-way tables show data for two categorical variables",
                    "Row totals = add across, Column totals = add down",
                    "Grand total = sum of all cells (or sum of all row totals)"
                ],
                mistakes: [
                    { wrong: "Reading the wrong cell", why: "Check both the row AND column headers to find the right cell." },
                    { wrong: "Confusing row and column totals", why: "Row totals are at the END of rows; column totals are at the BOTTOM of columns." },
                    { wrong: "Only counting one cell for a total", why: "Totals require adding ALL cells in that row or column." }
                ],
                guided: {
                    problem: `<table border='1' style='border-collapse:collapse;margin:10px auto;'><tr><th></th><th>Cat</th><th>Dog</th></tr><tr><td>Boy</td><td>${a}</td><td>${b}</td></tr><tr><td>Girl</td><td>${c}</td><td>${d}</td></tr></table><br>How many students have dogs?`,
                    steps: [
                        { label: "Find the 'Dog' column", value: `${b} and ${d}` },
                        { label: "Add them", value: "?" }
                    ],
                    answer: String(b + d),
                    answerLabel: "Students with dogs:",
                    interactiveSteps: [
                        {
                            prompt: "To find how many have dogs, click the column we need to look at:",
                            hint: "Click on the column header that matches what we're looking for...",
                            answer: "Dog",
                            acceptableAnswers: ["Dog", "dog", "the dog column", "dogs"],
                            selectOptions: [
                                { label: "Cat Column", value: "Cat" },
                                { label: "Dog Column", value: "Dog" }
                            ],
                            commonMistakes: {
                                "Cat": "We want dogs, not cats! The question asks about dogs."
                            }
                        },
                        {
                            prompt: `In the Dog column, what are the two values? (Click the values)`,
                            hint: "One for boys, one for girls...",
                            answer: `${b} and ${d}`,
                            acceptableAnswers: [`${b} and ${d}`, `${d} and ${b}`, `${b}, ${d}`, `${b} ${d}`],
                            selectOptions: [
                                { label: `${a} and ${b} (Boy row)`, value: `${a} and ${b}` },
                                { label: `${b} and ${d} (Dog column)`, value: `${b} and ${d}` },
                                { label: `${c} and ${d} (Girl row)`, value: `${c} and ${d}` },
                                { label: `${a} and ${c} (Cat column)`, value: `${a} and ${c}` }
                            ],
                            commonMistakes: {
                                [`${a} and ${b}`]: `That's the Boy row. The Dog column has ${b} and ${d}.`,
                                [`${c} and ${d}`]: `That's the Girl row. The Dog column has ${b} and ${d}.`,
                                [`${a} and ${c}`]: `That's the Cat column. We need the Dog column: ${b} and ${d}.`
                            }
                        },
                        {
                            prompt: `Add the Dog column: ${b} + ${d} = ?`,
                            hint: "Add the two values...",
                            answer: String(b + d),
                            acceptableAnswers: [String(b + d)],
                            commonMistakes: {
                                [String(a + b + c + d)]: `That's the grand total. Just the Dog column: ${b} + ${d} = ${b + d}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = 12, pb = 18, pc = 15, pd = 10; return {
                    problem: `<table border='1' style='border-collapse:collapse'><tr><th></th><th>Pizza</th><th>Tacos</th></tr><tr><td>6th Grade</td><td>${pa}</td><td>${pb}</td></tr><tr><td>7th Grade</td><td>${pc}</td><td>${pd}</td></tr></table><br>How many students prefer pizza?`, answer: String(pa + pc),
                    options: shuffle([String(pa + pc), String(pb + pd), String(pa + pb), String(pa + pb + pc + pd)]),
                    mistakeAnalysis: {
                        [String(pb + pd)]: "That's tacos! Pizza column: " + pa + " + " + pc + " = " + (pa + pc),
                        [String(pa + pb)]: "That's the 6th grade row. Pizza column: " + pa + " + " + pc + " = " + (pa + pc),
                        [String(pa + pb + pc + pd)]: "That's everyone! Just Pizza column: " + pa + " + " + pc + " = " + (pa + pc)
                    }}; })()
            };
        },
        "Scatter Plots": () => {
            return {
                goalProblem: `Describe the correlation shown in a scatter plot`,
                teachingSteps: [
                    {
                        title: "What is a scatter plot?",
                        explanation: "A <strong>scatter plot</strong> shows the relationship between two numerical variables. Each point represents one data pair (x, y).",
                        visual: "Points on a graph showing relationship"
                    },
                    {
                        title: "Types of correlation",
                        explanation: "<strong>Positive correlation:</strong> As x increases, y increases (points go up-right ↗)<br><strong>Negative correlation:</strong> As x increases, y decreases (points go down-right ↘)<br><strong>No correlation:</strong> No clear pattern (scattered randomly)",
                        visual: "↗ positive | ↘ negative | • • scattered = none"
                    },
                    {
                        title: "Strength of correlation",
                        explanation: "<strong>Strong:</strong> Points closely follow a line<br><strong>Weak:</strong> Points loosely follow a pattern<br><strong>None:</strong> No pattern at all",
                        visual: "Close together = strong | Spread out = weak"
                    },
                    {
                        title: "Line of best fit",
                        explanation: "A <strong>line of best fit</strong> is a straight line that comes closest to all the points. It helps us make predictions.",
                        visual: "Line through the 'middle' of the points"
                    },
                    {
                        title: "Making predictions",
                        explanation: "Use the line of best fit to predict y-values for x-values not in your data. But be careful about extrapolating too far!",
                        visual: "Use the line to estimate unknown values"
                    }
                ],
                finalAnswer: "Identify correlation type and strength",
                answerExplanation: "Look at the overall pattern: up-right = positive, down-right = negative, random = none. Closeness to a line = strength.",
                example: { problem: `A scatter plot shows study hours vs test scores. Points trend upward from left to right.`, steps: [
                    { text: "Direction of points?", math: "Upward from left to right ↗" },
                    { text: "This indicates", math: "Positive correlation" },
                    { text: "Interpretation", math: "More study hours → higher scores" },
                    { text: "If points are close together", math: "<strong>Strong positive correlation</strong>" }
                ]},
                keyPoints: [
                    "Positive: both variables increase together",
                    "Negative: one increases as the other decreases",
                    "Correlation does NOT mean causation!"
                ],
                mistakes: [
                    { wrong: "Confusing positive and negative", why: "Positive goes UP (↗) as you move right. Negative goes DOWN (↘)." },
                    { wrong: "Assuming correlation means causation", why: "Just because two things correlate doesn't mean one CAUSES the other!" },
                    { wrong: "Ignoring outliers", why: "Outliers (points far from the pattern) can affect the line of best fit." }
                ],
                guided: {
                    problem: `A scatter plot shows hours of sleep vs energy level. As sleep increases, energy increases. The points are close to a line.`,
                    steps: [
                        { label: "Both variables increase together", value: "Positive correlation" },
                        { label: "Points close to a line", value: "Strong correlation" },
                        { label: "Full description", value: "?" }
                    ],
                    answer: "strong positive correlation",
                    answerLabel: "Correlation type:",
                    interactiveSteps: [
                        {
                            prompt: "If both variables INCREASE together, is this positive or negative correlation?",
                            hint: "Positive means they move in the same direction...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "positive correlation"],
                            commonMistakes: {
                                "negative": "Negative means one goes up while the other goes down. Both increasing = positive!"
                            }
                        },
                        {
                            prompt: "If the points are close to a line (not scattered), is the correlation strong or weak?",
                            hint: "Close together means a clearer pattern...",
                            answer: "strong",
                            acceptableAnswers: ["strong", "strong correlation"],
                            commonMistakes: {
                                "weak": "Weak means points are spread out. Close to a line = strong!"
                            }
                        },
                        {
                            prompt: "Describe the correlation: _____ _____ correlation",
                            hint: "Combine strength and direction...",
                            answer: "strong positive",
                            acceptableAnswers: ["strong positive", "strong positive correlation"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A scatter plot shows age vs shoe size for children. Points trend upward and are fairly close together. What type of correlation?`, answer: "strong positive",
                    options: ["strong positive", "weak positive", "strong negative", "no correlation"],
                    mistakeAnalysis: {
                        "weak positive": "The points are close together, so it's STRONG, not weak.",
                        "strong negative": "Upward trend means POSITIVE. Negative would trend downward.",
                        "no correlation": "There IS a pattern (upward trend). No correlation means random scatter."
                    }}
            };
        },
        "Box Plots": () => {
            const min = rand(10, 20), q1 = min + rand(5, 10), med = q1 + rand(5, 10), q3 = med + rand(5, 10), max = q3 + rand(5, 10);
            const iqr = q3 - q1;
            return {
                goalProblem: `Find the IQR from a box plot with Q1 = 25 and Q3 = 45`,
                teachingSteps: [
                    {
                        title: "What is a box plot?",
                        explanation: "A <strong>box plot</strong> (box-and-whisker plot) shows how data is spread out using 5 key values: minimum, Q1, median, Q3, and maximum.",
                        visual: "Shows spread of data with box and whiskers"
                    },
                    {
                        title: "The five-number summary",
                        explanation: "• <strong>Minimum:</strong> Smallest value<br>• <strong>Q1:</strong> 25th percentile (25% below)<br>• <strong>Median:</strong> Middle value (50%)<br>• <strong>Q3:</strong> 75th percentile (75% below)<br>• <strong>Maximum:</strong> Largest value",
                        visual: "Min---[Q1---Median---Q3]---Max"
                    },
                    {
                        title: "Reading a box plot",
                        explanation: "The <strong>box</strong> contains the middle 50% of data (from Q1 to Q3). The <strong>whiskers</strong> extend to the min and max. The line inside the box is the median.",
                        visual: "Box = middle 50% | Whiskers = rest"
                    },
                    {
                        title: "Interquartile Range (IQR)",
                        explanation: "The <strong>IQR</strong> measures spread of the middle 50%. <strong>IQR = Q3 - Q1</strong>. For Q1=25 and Q3=45: IQR = 45 - 25 = <strong>20</strong>",
                        visual: "IQR = Q3 - Q1 = 45 - 25 = 20"
                    },
                    {
                        title: "Why IQR matters",
                        explanation: "IQR shows how spread out the middle data is. A larger IQR means more variability. IQR is not affected by outliers!",
                        visual: "IQR = 20"
                    }
                ],
                finalAnswer: "IQR = 20",
                answerExplanation: "IQR = Q3 - Q1 = 45 - 25 = 20. The middle 50% of data spans 20 units.",
                example: { problem: `Find the IQR: Q1 = 25, Q3 = 45`, steps: [
                    { text: "Recall the formula", math: "IQR = Q3 - Q1" },
                    { text: "Substitute the values", math: "IQR = 45 - 25" },
                    { text: "Calculate", math: "<strong>IQR = 20</strong>" }
                ]},
                keyPoints: [
                    "Five-number summary: Min, Q1, Median, Q3, Max",
                    "IQR = Q3 - Q1 (measures spread of middle 50%)",
                    "Box = middle 50%, Whiskers = min to Q1 and Q3 to max"
                ],
                mistakes: [
                    { wrong: "IQR = Q1 - Q3 (subtracting wrong way)", why: "Always Q3 - Q1 (larger minus smaller) for a positive IQR." },
                    { wrong: "Using min and max for IQR", why: "That's the RANGE. IQR uses Q1 and Q3 only." },
                    { wrong: "Confusing median with mean", why: "Median is the middle VALUE. Mean is the average (add all, divide by count)." }
                ],
                guided: {
                    problem: `A box plot shows: Min=${min}, Q1=${q1}, Median=${med}, Q3=${q3}, Max=${max}. Find the IQR.`,
                    steps: [
                        { label: "IQR formula", value: "IQR = Q3 - Q1" },
                        { label: "Substitute", value: `IQR = ${q3} - ${q1}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(iqr),
                    answerLabel: "IQR =",
                    interactiveSteps: [
                        {
                            prompt: "What does IQR stand for?",
                            hint: "It's about the range between quartiles...",
                            answer: "interquartile range",
                            acceptableAnswers: ["interquartile range", "inter-quartile range", "iqr", "inter quartile range", "the interquartile range"],
                            formatHint: "e.g., interquartile range",
                            commonMistakes: {
                                "range": "Just 'range' is max - min. IQR is specifically Inter-QUARTILE Range (Q3 - Q1)."
                            }
                        },
                        {
                            prompt: "The IQR formula is: IQR = ___ - ___",
                            hint: "Which two quartiles? (enter like: Q3 - Q1)",
                            answer: "Q3 - Q1",
                            acceptableAnswers: ["Q3 - Q1", "q3 - q1", "Q3-Q1", "q3-q1", "q3 minus q1", "Q3 minus Q1", "third quartile - first quartile", "third quartile minus first quartile"],
                            formatHint: "e.g., Q3 - Q1",
                            commonMistakes: {
                                "Q1 - Q3": "Order matters! It's Q3 - Q1 (larger minus smaller).",
                                "max - min": "That's the full range. IQR = Q3 - Q1."
                            }
                        },
                        {
                            prompt: `Calculate: ${q3} - ${q1} = ?`,
                            hint: "Subtract Q1 from Q3...",
                            answer: String(iqr),
                            acceptableAnswers: [String(iqr)],
                            commonMistakes: {
                                [String(q3 + q1)]: `Subtract, not add! ${q3} - ${q1} = ${iqr}`,
                                [String(max - min)]: `That's the full range. IQR = ${q3} - ${q1} = ${iqr}`
                            }
                        }
                    ]
                },
                practice: (() => { const pq1 = 30, pq3 = 55; return {
                    problem: `A box plot has Q1 = ${pq1} and Q3 = ${pq3}. Find the IQR.`, answer: String(pq3 - pq1),
                    options: shuffle([String(pq3 - pq1), String(pq1 + pq3), String(pq3), String(pq1)]),
                    mistakeAnalysis: {
                        [String(pq1 + pq3)]: `You added! IQR = Q3 - Q1 = ${pq3} - ${pq1} = ${pq3 - pq1}`,
                        [String(pq3)]: `That's just Q3. IQR = Q3 - Q1 = ${pq3} - ${pq1} = ${pq3 - pq1}`,
                        [String(pq1)]: `That's just Q1. IQR = Q3 - Q1 = ${pq3} - ${pq1} = ${pq3 - pq1}`
                    }}; })()
            };
        },
        "Probability Basics": () => {
            const favorable = rand(2, 5), total = rand(8, 12);
            return {
                goalProblem: `A bag has 3 red and 5 blue marbles. What's the probability of picking red?`,
                teachingSteps: [
                    {
                        title: "What is probability?",
                        explanation: "<strong>Probability</strong> measures how likely an event is to happen. It's always between 0 (impossible) and 1 (certain).",
                        visual: "0 = impossible | 1 = certain"
                    },
                    {
                        title: "The probability formula",
                        explanation: "<strong>P(event) = favorable outcomes / total outcomes</strong><br>Favorable = what you WANT to happen<br>Total = ALL possible outcomes",
                        visual: "P = favorable / total"
                    },
                    {
                        title: "Apply to our problem",
                        explanation: "Bag has 3 red + 5 blue = 8 total marbles.<br>Favorable (red) = 3<br>Total = 8",
                        visual: "3 red out of 8 total"
                    },
                    {
                        title: "Calculate the probability",
                        explanation: "P(red) = favorable/total = 3/8. This can also be written as 0.375 or 37.5%",
                        visual: "P(red) = 3/8 = 0.375 = 37.5%"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>P(red) = 3/8</strong>. There's a 3 in 8 chance of picking a red marble.",
                        visual: "P(red) = 3/8"
                    }
                ],
                finalAnswer: "3/8",
                answerExplanation: "P(red) = favorable/total = 3 red / 8 total = 3/8",
                example: { problem: `3 red and 5 blue marbles. P(red)?`, steps: [
                    { text: "Count favorable outcomes", math: "3 red marbles" },
                    { text: "Count total outcomes", math: "3 + 5 = 8 marbles" },
                    { text: "Apply formula", math: "P(red) = 3/8" },
                    { text: "Answer", math: "<strong>P(red) = 3/8</strong>" }
                ]},
                keyPoints: [
                    "P(event) = favorable outcomes / total outcomes",
                    "Probability is always between 0 and 1 (or 0% to 100%)",
                    "P(not A) = 1 - P(A)"
                ],
                mistakes: [
                    { wrong: "P(red) = 3/5 (using other outcome as total)", why: "Total is ALL outcomes: 3 + 5 = 8. P(red) = 3/8" },
                    { wrong: "Probability > 1", why: "Probability can NEVER exceed 1. Check your fraction!" },
                    { wrong: "Confusing favorable and total", why: "Favorable = what you want. Total = everything possible." }
                ],
                guided: {
                    problem: `A spinner has ${favorable} green and ${total - favorable} yellow sections. What's P(green)?`,
                    steps: [
                        { label: "Favorable (green sections)", value: String(favorable) },
                        { label: "Total sections", value: `${favorable} + ${total - favorable} = ${total}` },
                        { label: "P(green) = favorable/total", value: "?" }
                    ],
                    answer: `${favorable}/${total}`,
                    answerLabel: "P(green) =",
                    interactiveSteps: [
                        {
                            prompt: "What is the probability formula?",
                            hint: "P = something / something...",
                            answer: "favorable / total",
                            acceptableAnswers: ["favorable / total", "favorable/total", "favorable outcomes / total outcomes"],
                            commonMistakes: {
                                "total / favorable": "It's FAVORABLE over TOTAL, not the other way around!"
                            }
                        },
                        {
                            prompt: `How many favorable outcomes (green sections)?`,
                            hint: "Count the green sections...",
                            answer: String(favorable),
                            acceptableAnswers: [String(favorable)],
                            commonMistakes: {
                                [String(total - favorable)]: `That's yellow! Green = ${favorable}`
                            }
                        },
                        {
                            prompt: `How many total sections?`,
                            hint: "Add green + yellow...",
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            commonMistakes: {
                                [String(favorable)]: `That's just green. Total = ${favorable} + ${total - favorable} = ${total}`
                            }
                        },
                        {
                            prompt: `Calculate P(green) = ${favorable}/${total}. Express as a fraction.`,
                            hint: "Favorable over total...",
                            answer: `${favorable}/${total}`,
                            acceptableAnswers: [`${favorable}/${total}`, `${favorable} / ${total}`],
                            commonMistakes: {
                                [`${total}/${favorable}`]: `Flip it! P = favorable/total = ${favorable}/${total}`
                            }
                        }
                    ]
                },
                practice: (() => { const pf = 4, pt = 10; return {
                    problem: `A bag has ${pf} red and ${pt - pf} blue marbles. P(red)?`, answer: `${pf}/${pt}`,
                    options: [`${pf}/${pt}`, `${pt - pf}/${pt}`, `${pf}/${pt - pf}`, `${pt}/${pf}`],
                    mistakeAnalysis: {
                        [`${pt - pf}/${pt}`]: `That's P(blue)! P(red) = ${pf}/${pt}`,
                        [`${pf}/${pt - pf}`]: `Total is ${pt}, not ${pt - pf}. P(red) = ${pf}/${pt}`,
                        [`${pt}/${pf}`]: `Flip it! P = favorable/total = ${pf}/${pt}`
                    }}; })()
            };
        },
        "Cube Roots": () => ({
            goalProblem: `What is ∛27?`,
            teachingSteps: [
                {
                    title: "What is a cube root?",
                    explanation: "The <strong>cube root</strong> of a number answers: 'What number times itself THREE times equals this?'",
                    visual: "∛27 means: ? × ? × ? = 27"
                },
                {
                    title: "Think backwards from cubing",
                    explanation: "If n³ = 27, then ∛27 = n. We need to find n!",
                    visual: "n × n × n = 27"
                },
                {
                    title: "Test some numbers",
                    explanation: "2³ = 2×2×2 = 8 (too small). 3³ = 3×3×3 = 27 ✓ Found it!",
                    visual: "3 × 3 × 3 = 27"
                },
                {
                    title: "Answer: 3",
                    explanation: "∛27 = <strong>3</strong> because 3³ = 27",
                    visual: "∛27 = 3"
                }
            ],
            finalAnswer: "3",
            answerExplanation: "3 × 3 × 3 = 27, so ∛27 = 3",
            example: { problem: `∛27`, steps: [
                { text: "What number cubed equals 27?", math: "n³ = 27" },
                { text: "Test: 3³ = 3 × 3 × 3 = 27 ✓", math: "n = 3" },
                { text: "Answer", math: "∛27 = <strong>3</strong>" }
            ]},
            keyPoints: [
                "∛n asks: what × itself × itself = n?",
                "Perfect cubes: 1, 8, 27, 64, 125...",
                "∛8 = 2, ∛27 = 3, ∛64 = 4"
            ],
            mistakes: [
                { wrong: "Dividing by 3", why: "∛27 ≠ 27÷3. Cube root asks what number CUBED equals 27." },
                { wrong: "Confusing with square root", why: "√27 ≈ 5.2. CUBE root ∛27 = 3 because 3³=27" }
            ],
            guided: {
                problem: `What is ∛64?`,
                steps: [
                    { label: "4³ = 4 × 4 × 4 = ?", value: "64" },
                    { label: "So ∛64 = ?", value: "?" }
                ],
                answer: "4",
                answerLabel: "∛64 = ?",
                interactiveSteps: [
                    {
                        prompt: "What is 4 × 4 × 4?",
                        hint: "4 × 4 = 16, then 16 × 4 = ?",
                        answer: "64",
                        acceptableAnswers: ["64"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Since 4³ = 64, what is ∛64?",
                        hint: "Cube root undoes cubing...",
                        answer: "4",
                        acceptableAnswers: ["4"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `What is ∛125?`, answer: "5", options: ["3", "5", "25", "41.67"],
                mistakeAnalysis: {
                    "3": "3³ = 27, not 125. Try 5³ = 125, so ∛125 = 5",
                    "25": "That's √625. ∛125 = 5 because 5³ = 125",
                    "41.67": "That's 125÷3. Cube root asks what³ = 125. Answer: 5"
                }}
        }),
        "Irrational Numbers": () => ({
            goalProblem: `Is √2 rational or irrational?`,
            teachingSteps: [
                {
                    title: "What are rational numbers?",
                    explanation: "<strong>Rational numbers</strong> can be written as a fraction p/q where p and q are integers. Examples: 1/2, 3, -4, 0.5",
                    visual: "Rational = can be a fraction"
                },
                {
                    title: "What are irrational numbers?",
                    explanation: "<strong>Irrational numbers</strong> CANNOT be written as a simple fraction. Their decimals go on forever without repeating!",
                    visual: "Irrational = non-repeating, non-terminating decimal"
                },
                {
                    title: "Is √2 rational?",
                    explanation: "√2 = 1.41421356... The decimals go on forever and never repeat. It can't be written as a fraction!",
                    visual: "√2 = 1.41421356237... (forever)"
                },
                {
                    title: "Answer: Irrational",
                    explanation: "√2 is <strong>irrational</strong>. Most square roots of non-perfect squares are irrational.",
                    visual: "√2 = IRRATIONAL"
                }
            ],
            finalAnswer: "irrational",
            answerExplanation: "√2 cannot be expressed as a fraction; its decimal never terminates or repeats.",
            example: { problem: `Is √2 rational or irrational?`, steps: [
                { text: "Calculate √2", math: "√2 ≈ 1.41421356..." },
                { text: "Does it terminate or repeat?", math: "No - goes forever without pattern" },
                { text: "Answer", math: "<strong>Irrational</strong>" }
            ]},
            keyPoints: [
                "Rational: can be written as fraction (includes terminating/repeating decimals)",
                "Irrational: non-terminating, non-repeating decimals",
                "Famous irrationals: π, √2, √3, e"
            ],
            mistakes: [
                { wrong: "Thinking all decimals are irrational", why: "0.5, 0.333... are rational (1/2, 1/3)" },
                { wrong: "Thinking √4 is irrational", why: "√4 = 2, which IS rational! Only non-perfect squares are irrational." }
            ],
            guided: {
                problem: `Is π rational or irrational?`,
                steps: [
                    { label: "π = ", value: "3.14159265358979..." },
                    { label: "Does it terminate or repeat?", value: "No" },
                    { label: "Therefore π is", value: "?" }
                ],
                answer: "irrational",
                answerLabel: "π is...",
                interactiveSteps: [
                    {
                        prompt: "π = 3.14159265... Does this decimal ever end or repeat?",
                        hint: "π goes on forever with no pattern...",
                        answer: "no",
                        acceptableAnswers: ["no", "n"],
                        formatHint: "yes or no",
                        commonMistakes: {}
                    },
                    {
                        prompt: "Numbers with non-terminating, non-repeating decimals are...",
                        hint: "Not rational, so...",
                        answer: "irrational",
                        acceptableAnswers: ["irrational"],
                        formatHint: "rational or irrational",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Which is irrational?`, answer: "√7", options: ["1/3", "√9", "√7", "0.25"],
                mistakeAnalysis: {
                    "1/3": "1/3 = 0.333... (repeating) - that's rational!",
                    "√9": "√9 = 3, a whole number - rational!",
                    "0.25": "0.25 = 1/4 - terminates, so rational!"
                }}
        }),
        "Compound Probability": () => ({
            goalProblem: `Flip a coin twice. P(heads both times)?`,
            teachingSteps: [
                {
                    title: "What is compound probability?",
                    explanation: "<strong>Compound probability</strong> involves multiple events happening. We often multiply probabilities of independent events!",
                    visual: "Multiple events → multiply"
                },
                {
                    title: "For independent events",
                    explanation: "When events don't affect each other (like coin flips), multiply their probabilities: P(A and B) = P(A) × P(B)",
                    visual: "P(A and B) = P(A) × P(B)"
                },
                {
                    title: "Find P(heads) for one flip",
                    explanation: "P(heads) = 1/2 for a single coin flip",
                    visual: "P(H) = 1/2"
                },
                {
                    title: "Multiply for both flips",
                    explanation: "P(heads AND heads) = 1/2 × 1/2 = 1/4",
                    visual: "1/2 × 1/2 = 1/4"
                },
                {
                    title: "Answer: 1/4",
                    explanation: "P(heads both times) = <strong>1/4</strong> or 25%",
                    visual: "P(HH) = 1/4"
                }
            ],
            finalAnswer: "1/4",
            answerExplanation: "P(heads) × P(heads) = 1/2 × 1/2 = 1/4",
            example: { problem: `P(heads twice)`, steps: [
                { text: "P(heads first flip)", math: "1/2" },
                { text: "P(heads second flip)", math: "1/2" },
                { text: "P(both)", math: "1/2 × 1/2 = <strong>1/4</strong>" }
            ]},
            keyPoints: [
                "Independent events: P(A and B) = P(A) × P(B)",
                "Dependent events: P(A and B) = P(A) × P(B|A)",
                "More events = lower probability"
            ],
            mistakes: [
                { wrong: "Adding instead of multiplying", why: "For 'AND' (both events), MULTIPLY probabilities" },
                { wrong: "Using P(A) + P(B) for 'and'", why: "Addition is for 'OR'. For 'AND', multiply!" }
            ],
            guided: {
                problem: `Roll a die twice. P(6 both times)?`,
                steps: [
                    { label: "P(6 on one roll)", value: "1/6" },
                    { label: "P(6 AND 6)", value: "1/6 × 1/6" },
                    { label: "Answer", value: "?" }
                ],
                answer: "1/36",
                answerLabel: "P(6,6) = ?",
                interactiveSteps: [
                    {
                        prompt: "What's P(rolling a 6) on one die?",
                        hint: "1 favorable out of 6 outcomes",
                        answer: "1/6",
                        acceptableAnswers: ["1/6"],
                        formatHint: "Enter as fraction",
                        commonMistakes: {}
                    },
                    {
                        prompt: "P(6 AND 6) = 1/6 × 1/6 = ?",
                        hint: "Multiply: 1×1 = 1, 6×6 = 36",
                        answer: "1/36",
                        acceptableAnswers: ["1/36"],
                        formatHint: "Enter as fraction",
                        commonMistakes: {
                            "2/6": "Don't add! Multiply: 1/6 × 1/6 = 1/36"
                        }
                    }
                ]
            },
            practice: { problem: `Draw 2 cards with replacement. P(heart then heart)?`, answer: "1/16", options: ["1/4", "1/8", "1/16", "1/2"],
                mistakeAnalysis: {
                    "1/4": "That's P(one heart). For both: 1/4 × 1/4 = 1/16",
                    "1/8": "Check: 1/4 × 1/4 = 1/16, not 1/8",
                    "1/2": "P(heart) = 13/52 = 1/4. For both: 1/4 × 1/4 = 1/16"
                }}
        }),
        "Similar Figures": () => ({
            goalProblem: `Triangles are similar. If one has sides 3,4,5 and another has side 6 corresponding to 3, find the other sides.`,
            teachingSteps: [
                {
                    title: "What are similar figures?",
                    explanation: "<strong>Similar figures</strong> have the same shape but different sizes. Their corresponding angles are equal and sides are proportional!",
                    visual: "Same shape, different size"
                },
                {
                    title: "Find the scale factor",
                    explanation: "Scale factor = new/original. Here: 6/3 = 2. The second triangle is 2× bigger!",
                    visual: "6 ÷ 3 = 2 (scale factor)"
                },
                {
                    title: "Apply scale factor to all sides",
                    explanation: "Multiply each original side by 2: 3→6, 4→8, 5→10",
                    visual: "3×2=6, 4×2=8, 5×2=10"
                },
                {
                    title: "Answer: 6, 8, 10",
                    explanation: "The similar triangle has sides <strong>6, 8, 10</strong>",
                    visual: "New sides: 6, 8, 10"
                }
            ],
            finalAnswer: "6, 8, 10",
            answerExplanation: "Scale factor = 6/3 = 2. All sides × 2: 6, 8, 10",
            example: { problem: `Find similar triangle sides`, steps: [
                { text: "Find scale factor", math: "6/3 = 2" },
                { text: "Multiply all sides by 2", math: "3×2, 4×2, 5×2" },
                { text: "New sides", math: "<strong>6, 8, 10</strong>" }
            ]},
            keyPoints: [
                "Same shape, proportional sides",
                "Scale factor = corresponding sides ratio",
                "All sides multiply by same factor"
            ],
            mistakes: [
                { wrong: "Adding instead of multiplying", why: "Use scale factor to MULTIPLY, not add" },
                { wrong: "Using different scale factors for different sides", why: "Same scale factor for ALL sides!" }
            ],
            guided: {
                problem: `Rectangle 2×4 is similar to one with width 6. Find the length.`,
                steps: [
                    { label: "Scale factor", value: "6/2 = 3" },
                    { label: "Original length", value: "4" },
                    { label: "New length", value: "?" }
                ],
                answer: "12",
                answerLabel: "New length = ?",
                interactiveSteps: [
                    {
                        prompt: "Scale factor = new width / old width = 6/2 = ?",
                        hint: "6 divided by 2",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "New length = old length × scale factor = 4 × 3 = ?",
                        hint: "4 times 3",
                        answer: "12",
                        acceptableAnswers: ["12"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Similar triangles: sides 5,12,13 → 10,?,?`, answer: "24, 26", options: ["17, 18", "24, 26", "7, 8", "15, 16"],
                mistakeAnalysis: {
                    "17, 18": "Use scale factor: 10/5=2. Multiply: 12×2=24, 13×2=26",
                    "7, 8": "You added 5. Multiply by scale factor 2!",
                    "15, 16": "Check: 12×2=24, 13×2=26"
                }}
        }),
        Transformations: () => ({
            goalProblem: `What transformation slides a shape without rotating it?`,
            teachingSteps: [
                {
                    title: "What are transformations?",
                    explanation: "<strong>Transformations</strong> move or change shapes in specific ways. There are four main types!",
                    visual: "Move, flip, turn, or resize"
                },
                {
                    title: "Translation (slide)",
                    explanation: "<strong>Translation</strong> slides a shape in a direction without rotating or flipping. Same shape, new position!",
                    visual: "➡️ Slide left, right, up, down"
                },
                {
                    title: "Rotation (turn)",
                    explanation: "<strong>Rotation</strong> turns a shape around a point. Like spinning a pinwheel!",
                    visual: "🔄 Turn clockwise or counterclockwise"
                },
                {
                    title: "Reflection (flip)",
                    explanation: "<strong>Reflection</strong> flips a shape over a line, like looking in a mirror.",
                    visual: "↔️ Flip over a line (mirror)"
                },
                {
                    title: "Answer: Translation",
                    explanation: "A <strong>translation</strong> slides a shape without rotating or flipping it!",
                    visual: "Slide = Translation"
                }
            ],
            finalAnswer: "translation",
            answerExplanation: "Translation moves a shape without changing its orientation.",
            example: { problem: `Sliding without rotating = ?`, steps: [
                { text: "No rotation = not a rotation", math: "✗ Rotation" },
                { text: "No flipping = not a reflection", math: "✗ Reflection" },
                { text: "Just sliding = translation", math: "<strong>Translation</strong>" }
            ]},
            keyPoints: [
                "Translation = slide (same orientation)",
                "Rotation = turn around a point",
                "Reflection = flip over a line",
                "Dilation = resize (bigger or smaller)"
            ],
            mistakes: [
                { wrong: "Confusing translation and rotation", why: "Translation keeps same orientation; rotation turns the shape" },
                { wrong: "Confusing reflection and rotation", why: "Reflection flips; rotation spins around a point" }
            ],
            guided: {
                problem: `What transformation creates a mirror image?`,
                steps: [
                    { label: "Mirror image means", value: "Flipped" },
                    { label: "Flipping is called", value: "?" }
                ],
                answer: "reflection",
                answerLabel: "What transformation?",
                interactiveSteps: [
                    {
                        prompt: "A mirror shows your image flipped. What transformation flips shapes?",
                        hint: "Think of mirror...",
                        answer: "reflection",
                        acceptableAnswers: ["reflection", "reflect"],
                        formatHint: "Name the transformation",
                        commonMistakes: {
                            "translation": "Translation slides. Flipping (mirror) is reflection!"
                        }
                    }
                ]
            },
            practice: { problem: `Turning a shape 90° around a point is a...?`, answer: "rotation", options: ["translation", "reflection", "rotation", "dilation"],
                mistakeAnalysis: {
                    "translation": "Translation slides. Turning around a point is rotation.",
                    "reflection": "Reflection flips. Turning around a point is rotation.",
                    "dilation": "Dilation resizes. Turning around a point is rotation."
                }}
        }),
        "Parallel Lines and Transversals": () => ({
            goalProblem: `When a transversal crosses parallel lines, what are alternate interior angles?`,
            teachingSteps: [
                {
                    title: "What is a transversal?",
                    explanation: "A <strong>transversal</strong> is a line that crosses two or more other lines. It creates many angle pairs!",
                    visual: "Line crossing parallel lines"
                },
                {
                    title: "Alternate interior angles",
                    explanation: "<strong>Alternate interior angles</strong> are on opposite sides of the transversal, between the parallel lines. They're EQUAL!",
                    visual: "Inside, opposite sides = equal"
                },
                {
                    title: "Corresponding angles",
                    explanation: "<strong>Corresponding angles</strong> are in the same position at each intersection. Also equal!",
                    visual: "Same position = equal"
                },
                {
                    title: "Key relationships",
                    explanation: "With parallel lines: alternate interior = equal, corresponding = equal, co-interior (same side) = 180°",
                    visual: "∠1 = ∠5, ∠3 = ∠6, etc."
                },
                {
                    title: "Answer: They are equal",
                    explanation: "Alternate interior angles are <strong>equal</strong> when formed by parallel lines!",
                    visual: "Alt. interior = EQUAL"
                }
            ],
            finalAnswer: "equal",
            answerExplanation: "Alternate interior angles are equal when formed by a transversal crossing parallel lines.",
            example: { problem: `Alternate interior angles are...`, steps: [
                { text: "Parallel lines + transversal", math: "Creates angle pairs" },
                { text: "Alternate interior angles", math: "Inside, opposite sides" },
                { text: "They are", math: "<strong>Equal</strong>" }
            ]},
            keyPoints: [
                "Alternate interior: equal",
                "Corresponding: equal",
                "Co-interior (same-side interior): sum to 180°"
            ],
            mistakes: [
                { wrong: "Thinking all angles are equal", why: "Only some pairs! Co-interior angles sum to 180°, not equal." },
                { wrong: "Confusing angle types", why: "Memorize positions: alternate (opposite sides), corresponding (same position)" }
            ],
            guided: {
                problem: `Corresponding angles measure 70°. What's the other corresponding angle?`,
                steps: [
                    { label: "Corresponding angles are", value: "Equal" },
                    { label: "So the other angle is", value: "?" }
                ],
                answer: "70°",
                answerLabel: "Other angle = ?",
                interactiveSteps: [
                    {
                        prompt: "Are corresponding angles equal or supplementary?",
                        hint: "Same position at each intersection...",
                        answer: "equal",
                        acceptableAnswers: ["equal"],
                        formatHint: "equal or supplementary",
                        commonMistakes: {}
                    },
                    {
                        prompt: "If they're equal and one is 70°, what's the other?",
                        hint: "Equal means same...",
                        answer: "70",
                        acceptableAnswers: ["70", "70°", "70 degrees"],
                        formatHint: "Enter degrees",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Co-interior angles: one is 110°. Find the other.`, answer: "70°", options: ["70°", "110°", "90°", "180°"],
                mistakeAnalysis: {
                    "110°": "Co-interior angles SUM to 180°, they're not equal! 180-110=70°",
                    "90°": "Co-interior sum to 180°, not 90°! 180-110=70°",
                    "180°": "That's their sum! One angle is 180-110=70°"
                }}
        }),
        "Sampling Methods": () => ({
            goalProblem: `What sampling method picks every 10th person from a list?`,
            teachingSteps: [
                {
                    title: "What is sampling?",
                    explanation: "<strong>Sampling</strong> is selecting a smaller group from a population to study. Different methods give different results!",
                    visual: "Population → Sample"
                },
                {
                    title: "Random sampling",
                    explanation: "<strong>Random sampling</strong>: every person has an equal chance of being selected. Like drawing names from a hat!",
                    visual: "Random = equal chance"
                },
                {
                    title: "Systematic sampling",
                    explanation: "<strong>Systematic sampling</strong>: select every nth item (like every 10th person). Start randomly, then follow the pattern.",
                    visual: "Every 10th: 10, 20, 30, 40..."
                },
                {
                    title: "Stratified sampling",
                    explanation: "<strong>Stratified sampling</strong>: divide population into groups, then sample from each group proportionally.",
                    visual: "Groups → sample from each"
                },
                {
                    title: "Answer: Systematic",
                    explanation: "Picking every 10th person is <strong>systematic sampling</strong>!",
                    visual: "Every nth = Systematic"
                }
            ],
            finalAnswer: "systematic",
            answerExplanation: "Selecting at regular intervals (every 10th) is systematic sampling.",
            example: { problem: `Every 10th person = ?`, steps: [
                { text: "Regular interval (every nth)", math: "10, 20, 30, 40..." },
                { text: "This pattern is called", math: "Systematic sampling" },
                { text: "Answer", math: "<strong>Systematic</strong>" }
            ]},
            keyPoints: [
                "Random: equal chance for all",
                "Systematic: every nth item",
                "Stratified: sample from each subgroup",
                "Convenience: easiest to reach (often biased)"
            ],
            mistakes: [
                { wrong: "Thinking systematic is random", why: "Systematic follows a pattern; random has no pattern" },
                { wrong: "Confusing stratified with cluster", why: "Stratified samples FROM each group; cluster samples whole groups" }
            ],
            guided: {
                problem: `Surveying students by grade level, taking equal numbers from each grade. What method?`,
                steps: [
                    { label: "Dividing by grade", value: "Creating strata (groups)" },
                    { label: "Sampling from each group", value: "?" }
                ],
                answer: "stratified",
                answerLabel: "Sampling method?",
                interactiveSteps: [
                    {
                        prompt: "When you divide a population into groups before sampling, it's called...?",
                        hint: "Starts with 'strat'...",
                        answer: "stratified",
                        acceptableAnswers: ["stratified", "stratified sampling"],
                        formatHint: "Name the method",
                        commonMistakes: {
                            "systematic": "Systematic is every nth. Dividing into groups = stratified."
                        }
                    }
                ]
            },
            practice: { problem: `Asking the first 20 people you see is what type of sampling?`, answer: "convenience", options: ["random", "systematic", "stratified", "convenience"],
                mistakeAnalysis: {
                    "random": "Not everyone has equal chance - just whoever you see first. That's convenience!",
                    "systematic": "Systematic follows a pattern (every nth). This is convenience.",
                    "stratified": "Stratified divides into groups first. This is just convenience."
                }}
        }),
        "Volume of Cylinders Cones Spheres": () => ({
            goalProblem: `Find the volume of a cylinder: radius 3, height 5 (use π ≈ 3.14)`,
            teachingSteps: [
                {
                    title: "Cylinder volume formula",
                    explanation: "<strong>V = πr²h</strong> (π times radius squared times height)",
                    visual: "V = πr²h"
                },
                {
                    title: "Plug in our values",
                    explanation: "r = 3, h = 5, π ≈ 3.14. V = 3.14 × 3² × 5",
                    visual: "V = 3.14 × 9 × 5"
                },
                {
                    title: "Calculate step by step",
                    explanation: "3² = 9. Then 3.14 × 9 = 28.26. Finally 28.26 × 5 = 141.3",
                    visual: "3.14 × 9 × 5 = 141.3"
                },
                {
                    title: "Answer: 141.3 cubic units",
                    explanation: "V ≈ <strong>141.3 cubic units</strong>",
                    visual: "V ≈ 141.3"
                }
            ],
            finalAnswer: "141.3 cubic units",
            answerExplanation: "V = πr²h = 3.14 × 9 × 5 = 141.3 cubic units",
            example: { problem: `Cylinder: r=3, h=5`, steps: [
                { text: "Formula", math: "V = πr²h" },
                { text: "Substitute", math: "V = 3.14 × 3² × 5" },
                { text: "Calculate", math: "V = 3.14 × 9 × 5 = <strong>141.3</strong>" }
            ]},
            keyPoints: [
                "Cylinder: V = πr²h",
                "Cone: V = (1/3)πr²h (1/3 of cylinder)",
                "Sphere: V = (4/3)πr³"
            ],
            mistakes: [
                { wrong: "Forgetting to square the radius", why: "r² means r×r. Don't forget to square!" },
                { wrong: "Using diameter instead of radius", why: "Radius = diameter ÷ 2. Make sure you use radius!" }
            ],
            guided: {
                problem: `Cone volume: radius 2, height 6. (Hint: V = (1/3)πr²h)`,
                steps: [
                    { label: "r² = 2² = ", value: "4" },
                    { label: "πr²h = 3.14 × 4 × 6 = ", value: "75.36" },
                    { label: "(1/3) × 75.36 = ", value: "?" }
                ],
                answer: "25.12",
                answerLabel: "Cone volume ≈ ?",
                interactiveSteps: [
                    {
                        prompt: "First calculate πr²h: 3.14 × 4 × 6 = ?",
                        hint: "3.14 × 4 = 12.56, then × 6",
                        answer: "75.36",
                        acceptableAnswers: ["75.36"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    },
                    {
                        prompt: "A cone is 1/3 of a cylinder. 75.36 ÷ 3 = ?",
                        hint: "Divide by 3",
                        answer: "25.12",
                        acceptableAnswers: ["25.12", "25.1"],
                        formatHint: "Enter a number",
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `Sphere: radius 3. V = (4/3)πr³. Find V (use π=3.14)`, answer: "113.04", options: ["28.26", "56.52", "113.04", "339.12"],
                mistakeAnalysis: {
                    "28.26": "That's πr². For sphere: (4/3) × 3.14 × 27 = 113.04",
                    "56.52": "Check: (4/3) × 3.14 × 27 = 4.187 × 27 = 113.04",
                    "339.12": "You multiplied by 4 instead of 4/3. Answer: 113.04"
                }}
        })
    },
    5: {
        "Linear Equations": () => {
            const x = rand(2, 8), a = rand(2, 5), b = rand(3, 12);
            const c = a * x + b;
            return {
                goalProblem: `Solve: 3x + 7 = 22`,
                teachingSteps: [
                    {
                        title: "This is a two-step equation",
                        explanation: "Two-step equations require <strong>two operations</strong> to isolate x. We need to undo what's being done to x, one step at a time.",
                        visual: "3x + 7 = 22 → need 2 steps to find x"
                    },
                    {
                        title: "Identify operations on x",
                        explanation: "Look at the left side: x is being <strong>multiplied by 3</strong>, then <strong>7 is added</strong>. We'll undo these in reverse order.",
                        visual: "x → ×3 → +7 → result"
                    },
                    {
                        title: "Step 1: Undo the addition first",
                        explanation: "The outer operation is +7. Undo it by <strong>subtracting 7</strong> from both sides: 3x + 7 - 7 = 22 - 7",
                        visual: "3x + 7 - 7 = 22 - 7 → 3x = 15"
                    },
                    {
                        title: "Step 2: Undo the multiplication",
                        explanation: "Now we have 3x = 15. Undo the ×3 by <strong>dividing both sides by 3</strong>: 3x ÷ 3 = 15 ÷ 3",
                        visual: "3x ÷ 3 = 15 ÷ 3 → x = 5"
                    },
                    {
                        title: "Check your answer!",
                        explanation: "Substitute x = 5 back into the original: 3(5) + 7 = 15 + 7 = 22 ✓ It works!",
                        visual: "x = 5"
                    }
                ],
                finalAnswer: "x = 5",
                answerExplanation: "First subtract 7 from both sides (3x = 15), then divide by 3 (x = 5). Always check: 3(5) + 7 = 22 ✓",
                example: { problem: `Solve: 3x + 7 = 22`, steps: [
                    { text: "Identify operations on x", math: "x is multiplied by 3, then 7 is added" },
                    { text: "Step 1: Undo addition (subtract 7 from both sides)", math: "3x + 7 - 7 = 22 - 7" },
                    { text: "Simplify", math: "3x = 15" },
                    { text: "Step 2: Undo multiplication (divide both sides by 3)", math: "3x ÷ 3 = 15 ÷ 3" },
                    { text: "Simplify", math: "x = <strong>5</strong>" },
                    { text: "Check: 3(5) + 7 = 15 + 7 = 22 ✓", math: "" }
                ]},
                keyPoints: [
                    "Undo addition/subtraction FIRST, then multiplication/division",
                    "Whatever you do to one side, you MUST do to the other",
                    "Always check your answer by substituting it back into the original equation"
                ],
                mistakes: [
                    { wrong: "Dividing before subtracting: 3x + 7 = 22 → x + 7 = 22/3", why: "You must undo the outer operation first. Subtract 7, THEN divide by 3." },
                    { wrong: "Only operating on part of a side: 3x + 7 = 22 → 3x = 22 - 7 but forgetting to simplify", why: "Always simplify: 22 - 7 = 15, so 3x = 15" },
                    { wrong: "Dividing only one term: 3x + 7 = 22 → x + 7 = 22/3", why: "When dividing, EVERY term on the left would need to be divided. That's why we subtract first!" }
                ],
                guided: { problem: `Solve: ${a}x + ${b} = ${c}`, steps: [
                    { label: `Step 1: Subtract ${b} from both sides`, value: `${a}x = ${c} - ${b} = ${c - b}` },
                    { label: `Step 2: Divide both sides by ${a}`, value: `x = ${c - b} ÷ ${a} = ?` },
                    { label: "Check your answer", value: `${a}(?) + ${b} should equal ${c}` }
                ], answer: String(x), answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}x + ${b} = ${c}, we need to isolate x. What should we undo FIRST - the multiplication or the addition?`,
                            hint: "Think about order of operations in reverse. Undo the OUTER operation first.",
                            answer: "addition",
                            acceptableAnswers: ["addition", "add", "the addition", "+ " + b, "adding"],
                            commonMistakes: {
                                "multiplication": "Undo operations in REVERSE order. Addition was done last, so undo it first by subtracting."
                            }
                        },
                        {
                            prompt: `Subtract ${b} from both sides. What is ${c} - ${b}?`,
                            hint: `${c} minus ${b}...`,
                            answer: String(c - b),
                            acceptableAnswers: [String(c - b)],
                            commonMistakes: {
                                [String(c + b)]: `Subtract, not add! ${c} - ${b} = ${c - b}`,
                                [String(c)]: `You need to subtract ${b}: ${c} - ${b} = ${c - b}`
                            }
                        },
                        {
                            prompt: `Now we have ${a}x = ${c - b}. To get x alone, we need to undo the multiplication. Divide both sides by what?`,
                            hint: `x is being multiplied by ${a}...`,
                            answer: String(a),
                            acceptableAnswers: [String(a), "by " + a],
                            commonMistakes: {
                                [String(c - b)]: `We divide by the coefficient of x, which is ${a}`,
                                [String(x)]: `We don't know x yet! Divide by ${a} to find it.`
                            }
                        },
                        {
                            prompt: `Calculate: ${c - b} ÷ ${a} = ?`,
                            hint: `${c - b} divided by ${a}...`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String((c - b) * a)]: `Divide, not multiply! ${c - b} ÷ ${a} = ${x}`,
                                [String(c - b)]: `You still need to divide: ${c - b} ÷ ${a} = ${x}`
                            }
                        },
                        {
                            prompt: `Check: Does ${a}(${x}) + ${b} = ${c}?`,
                            hint: `Calculate ${a} × ${x} + ${b}...`,
                            answer: "yes",
                            acceptableAnswers: ["yes", String(c), "correct", "true"],
                            commonMistakes: {
                                "no": `${a} × ${x} = ${a * x}, then ${a * x} + ${b} = ${c} ✓ It works!`
                            }
                        }
                    ]
                },
                practice: (() => { const newB = b + 3; const newC = a * x + newB; return {
                    problem: `Solve: ${a}x + ${newB} = ${newC}`, answer: String(x),
                    options: shuffle([String(x), String(Math.floor(newC / a)), String(newC), String(newC - newB)]),
                    mistakeAnalysis: {
                        [String(Math.floor(newC / a))]: `You divided ${newC} by ${a} without subtracting ${newB} first. Do: ${newC} - ${newB} = ${newC - newB}, then ${newC - newB} ÷ ${a} = ${x}`,
                        [String(newC)]: `That's the right side of the equation, not x. First subtract ${newB}, then divide by ${a}.`,
                        [String(newC - newB)]: `That's ${a}x, not x. You need to divide by ${a}: ${newC - newB} ÷ ${a} = ${x}`
                    }}; })()
            };
        },
        Factoring: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Factoring Trinomials (x² + bx + c)
                (() => {
                    const r1 = rand(1, 5), r2 = rand(1, 5);
                    const sum = r1 + r2, prod = r1 * r2;
                    // For practice
                    const nr1 = r1 + 1, nr2 = r2 + 1;
                    const nsum = nr1 + nr2, nprod = nr1 * nr2;
                    return {
                        id: "trinomial",
                        name: "Factoring Trinomials",
                        goalProblem: `Factor: x² + 7x + 12`,
                        teachingSteps: [
                            {
                                title: "What is factoring?",
                                explanation: "<strong>Factoring</strong> means writing an expression as a product of simpler expressions. We're going 'backwards' from multiplying.",
                                visual: "x² + 7x + 12 = (? + ?)(? + ?)"
                            },
                            {
                                title: "Identify the key numbers",
                                explanation: "In x² + 7x + 12: <strong>b = 7</strong> (coefficient of x) and <strong>c = 12</strong> (constant term). We need two numbers that work with these.",
                                visual: "b = 7, c = 12"
                            },
                            {
                                title: "The magic conditions",
                                explanation: "We need two numbers p and q where: p × q = c (multiply to 12) AND p + q = b (add to 7). Both conditions must be true!",
                                visual: "p × q = 12 AND p + q = 7"
                            },
                            {
                                title: "Find the factor pair",
                                explanation: "List pairs that multiply to 12: 1×12, 2×6, 3×4. Which adds to 7? 1+12=13✗, 2+6=8✗, <strong>3+4=7✓</strong>",
                                visual: "3 × 4 = 12 ✓ AND 3 + 4 = 7 ✓"
                            },
                            {
                                title: "Write the answer and check",
                                explanation: "Use p=3 and q=4: <strong>(x + 3)(x + 4)</strong>. Check with FOIL: x² + 4x + 3x + 12 = x² + 7x + 12 ✓",
                                visual: "(x + 3)(x + 4)"
                            }
                        ],
                        finalAnswer: "(x + 3)(x + 4)",
                        answerExplanation: "We found 3 and 4 because 3×4=12 and 3+4=7. Always verify by FOILing!",
                        example: { problem: `Factor: x² + 7x + 12`, steps: [
                            { text: "Identify b and c", math: "b = 7, c = 12" },
                            { text: "List factor pairs of 12", math: "1×12, 2×6, 3×4" },
                            { text: "Find pair that adds to 7", math: "3+4=7 ✓" },
                            { text: "Write the factors", math: "<strong>(x + 3)(x + 4)</strong>" }
                        ]},
                        keyPoints: [
                            "Two numbers must MULTIPLY to c AND ADD to b",
                            "FOIL = First, Outer, Inner, Last (for checking)",
                            "If signs are both positive, both factors are positive"
                        ],
                        mistakes: [
                            { wrong: "Only checking multiplication", why: "Both conditions must be satisfied: multiply AND add!" },
                            { wrong: "Writing (x + 7)(x + 12)", why: "Use the TWO NUMBERS you find, not b and c directly" }
                        ],
                        guided: { problem: `Factor: x² + ${sum}x + ${prod}`, steps: [
                            { label: "Multiply to", value: `${prod}` },
                            { label: "Add to", value: `${sum}` },
                            { label: "Numbers", value: `${r1} and ${r2}` }
                        ], answer: `(x+${r1})(x+${r2})`, answerLabel: "Factored form:",
                            interactiveSteps: [
                                {
                                    prompt: `We need two numbers that MULTIPLY to what?`,
                                    hint: "The constant term...",
                                    answer: String(prod),
                                    acceptableAnswers: [String(prod)],
                                    commonMistakes: { [String(sum)]: `${sum} is what we ADD to. Multiply to ${prod}.` }
                                },
                                {
                                    prompt: `And ADD to what?`,
                                    hint: "The coefficient of x...",
                                    answer: String(sum),
                                    acceptableAnswers: [String(sum)],
                                    commonMistakes: { [String(prod)]: `${prod} is what we multiply to. Add to ${sum}.` }
                                },
                                {
                                    prompt: `What two numbers multiply to ${prod} AND add to ${sum}?`,
                                    hint: `Factor pairs of ${prod}...`,
                                    answer: `${r1} and ${r2}`,
                                    acceptableAnswers: [`${r1} and ${r2}`, `${r2} and ${r1}`, `${r1}, ${r2}`],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Write the factored form: (x + ___)(x + ___)`,
                                    hint: "Use the two numbers you found...",
                                    answer: `(x+${r1})(x+${r2})`,
                                    acceptableAnswers: [`(x+${r1})(x+${r2})`, `(x+${r2})(x+${r1})`, `(x + ${r1})(x + ${r2})`],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Factor: x² + ${nsum}x + ${nprod}`,
                            answer: `(x+${nr1})(x+${nr2})`,
                            options: shuffle([`(x+${nr1})(x+${nr2})`, `(x+1)(x+${nprod})`, `(x+${nsum})(x+1)`, `(x+${nr1})(x+${nr1})`]),
                            mistakeAnalysis: {
                                [`(x+1)(x+${nprod})`]: `1 + ${nprod} = ${1+nprod}, not ${nsum}. Need ${nr1} and ${nr2}.`,
                                [`(x+${nsum})(x+1)`]: `${nsum} × 1 = ${nsum}, not ${nprod}.`,
                                [`(x+${nr1})(x+${nr1})`]: `${nr1} × ${nr1} = ${nr1*nr1}, not ${nprod}.`
                            }
                        }
                    };
                })(),

                // Sub-skill 2: Difference of Squares
                (() => {
                    const a = rand(2, 6);
                    const aSquared = a * a;
                    // For practice
                    const pa = a + rand(1, 3);
                    const paSquared = pa * pa;
                    return {
                        id: "difference",
                        name: "Difference of Squares",
                        goalProblem: `Factor: x² - 25`,
                        teachingSteps: [
                            {
                                title: "Recognizing a special pattern",
                                explanation: "Some expressions have a special pattern: <strong>a² - b²</strong> (one perfect square MINUS another). This is called a 'difference of squares'.",
                                visual: "x² - 25 = x² - 5²"
                            },
                            {
                                title: "Is this a difference of squares?",
                                explanation: "Check: Is x² a perfect square? Yes! Is 25 a perfect square? Yes (5² = 25)! Is there a MINUS sign? Yes! ✓",
                                visual: "x² = (x)² and 25 = (5)²"
                            },
                            {
                                title: "The pattern formula",
                                explanation: "<strong>a² - b² = (a + b)(a - b)</strong><br>One factor has PLUS, the other has MINUS!",
                                visual: "a² - b² = (a + b)(a - b)"
                            },
                            {
                                title: "Apply the pattern",
                                explanation: "For x² - 25:<br>a = x (since a² = x²)<br>b = 5 (since b² = 25)<br>So: x² - 25 = (x + 5)(x - 5)",
                                visual: "x² - 25 = (x + 5)(x - 5)"
                            },
                            {
                                title: "Verify with FOIL",
                                explanation: "(x + 5)(x - 5) = x² - 5x + 5x - 25 = x² - 25 ✓<br>The middle terms cancel out!",
                                visual: "(x + 5)(x - 5) = x² - 25 ✓"
                            }
                        ],
                        finalAnswer: "(x + 5)(x - 5)",
                        answerExplanation: "x² - 25 = x² - 5² = (x + 5)(x - 5). The difference of squares pattern!",
                        example: { problem: `Factor: x² - 25`, steps: [
                            { text: "Recognize the pattern", math: "x² - 25 = x² - 5²" },
                            { text: "Apply a² - b² = (a+b)(a-b)", math: "a = x, b = 5" },
                            { text: "Write the answer", math: "<strong>(x + 5)(x - 5)</strong>" },
                            { text: "Check with FOIL", math: "x² - 5x + 5x - 25 = x² - 25 ✓" }
                        ]},
                        keyPoints: [
                            "Pattern: a² - b² = (a + b)(a - b)",
                            "Must be SUBTRACTION (not addition)",
                            "Both terms must be PERFECT SQUARES"
                        ],
                        mistakes: [
                            { wrong: "(x - 5)²", why: "(x-5)² = x² - 10x + 25, not x² - 25!" },
                            { wrong: "(x + 5)²", why: "(x+5)² = x² + 10x + 25, not x² - 25!" },
                            { wrong: "Using this pattern for x² + 25", why: "Difference of squares needs MINUS! x² + 25 cannot be factored this way." }
                        ],
                        guided: { problem: `Factor: x² - ${aSquared}`, steps: [
                            { label: "Is x² a perfect square?", value: "Yes, (x)²" },
                            { label: `Is ${aSquared} a perfect square?`, value: `Yes, ${a}² = ${aSquared}` },
                            { label: "Apply (a+b)(a-b)", value: "?" }
                        ], answer: `(x+${a})(x-${a})`, answerLabel: "Factored form:",
                            interactiveSteps: [
                                {
                                    prompt: `In x² - ${aSquared}, what number squared equals ${aSquared}?`,
                                    hint: `What × what = ${aSquared}?`,
                                    answer: String(a),
                                    acceptableAnswers: [String(a)],
                                    commonMistakes: {
                                        [String(aSquared)]: `${aSquared} is the perfect square. We need √${aSquared} = ${a}`
                                    }
                                },
                                {
                                    prompt: `For difference of squares, a² - b² = (a + b)(a - ?). What goes in the second factor?`,
                                    hint: "One plus, one minus...",
                                    answer: "b",
                                    acceptableAnswers: ["b", "minus b", "-b", String(a)],
                                    commonMistakes: {
                                        "plus b": "One factor has + and the other has -"
                                    }
                                },
                                {
                                    prompt: `Write x² - ${aSquared} in factored form:`,
                                    hint: "(x + ?)(x - ?)",
                                    answer: `(x+${a})(x-${a})`,
                                    acceptableAnswers: [`(x+${a})(x-${a})`, `(x-${a})(x+${a})`, `(x + ${a})(x - ${a})`],
                                    commonMistakes: {
                                        [`(x-${a})²`]: `That's (x-${a})(x-${a}) which equals x² - ${2*a}x + ${aSquared}. Need (x+${a})(x-${a}).`,
                                        [`(x+${a})²`]: `That's (x+${a})(x+${a}) which equals x² + ${2*a}x + ${aSquared}. Need (x+${a})(x-${a}).`
                                    }
                                }
                            ]
                        },
                        practice: {
                            problem: `Factor: x² - ${paSquared}`,
                            answer: `(x+${pa})(x-${pa})`,
                            options: shuffle([`(x+${pa})(x-${pa})`, `(x-${pa})²`, `(x+${pa})²`, `(x-${paSquared})(x+1)`]),
                            mistakeAnalysis: {
                                [`(x-${pa})²`]: `(x-${pa})² = x² - ${2*pa}x + ${paSquared}. Difference of squares: (x+${pa})(x-${pa})`,
                                [`(x+${pa})²`]: `(x+${pa})² = x² + ${2*pa}x + ${paSquared}. Difference of squares: (x+${pa})(x-${pa})`,
                                [`(x-${paSquared})(x+1)`]: `Not correct. x² - ${paSquared} = (x+${pa})(x-${pa}) since ${pa}² = ${paSquared}`
                            }
                        }
                    };
                })()
            ]
        }),
        Systems: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Elimination Method
                (() => {
                    const x = rand(2, 5), y = rand(1, 4);
                    const c1 = x + y, c2 = x - y;
                    // For practice
                    const px = rand(3, 6), py = rand(1, 4);
                    const pc1 = px + py, pc2 = px - py;
                    return {
                        id: "elimination",
                        name: "Systems by Elimination",
                        goalProblem: `Solve: x + y = 7 and x - y = 3`,
                        teachingSteps: [
                            {
                                title: "What is a system of equations?",
                                explanation: "A <strong>system</strong> is two or more equations that must both be true at the same time. We find values that work in ALL equations.",
                                visual: "x + y = 7 AND x - y = 3"
                            },
                            {
                                title: "The Elimination Method",
                                explanation: "Notice one equation has +y and the other has -y. If we <strong>add</strong> the equations, the y terms will cancel out!",
                                visual: "+y + (-y) = 0 (they cancel!)"
                            },
                            {
                                title: "Add the equations together",
                                explanation: "Add left sides: (x + y) + (x - y) = 2x<br>Add right sides: 7 + 3 = 10<br>We get: 2x = 10",
                                visual: "(x + y) + (x - y) = 7 + 3 → 2x = 10"
                            },
                            {
                                title: "Solve for x",
                                explanation: "From 2x = 10, divide both sides by 2: <strong>x = 5</strong>. We found x! Now we need y.",
                                visual: "x = 5"
                            },
                            {
                                title: "Find y and check",
                                explanation: "Substitute x=5 into equation 1: 5 + y = 7, so y = 2.<br>Check: 5+2=7✓ and 5-2=3✓ Both work!",
                                visual: "Solution: (5, 2)"
                            }
                        ],
                        finalAnswer: "x = 5, y = 2",
                        answerExplanation: "By adding the equations, y cancelled. Found x=5, then substituted to find y=2.",
                        example: { problem: `Solve: x + y = 7 and x - y = 3`, steps: [
                            { text: "Add the equations", math: "(x+y) + (x-y) = 7 + 3" },
                            { text: "y terms cancel", math: "2x = 10" },
                            { text: "Solve for x", math: "x = 5" },
                            { text: "Find y", math: "5 + y = 7 → y = 2" }
                        ]},
                        keyPoints: [
                            "Solution must satisfy BOTH equations",
                            "Add when coefficients are opposites (+y, -y)",
                            "Always check in both equations"
                        ],
                        mistakes: [
                            { wrong: "Only checking one equation", why: "Must work in BOTH!" },
                            { wrong: "Adding when should subtract", why: "+y and -y: ADD. +y and +y: SUBTRACT" }
                        ],
                        guided: { problem: `Solve: x + y = ${c1} and x - y = ${c2}`, steps: [
                            { label: "Add equations", value: `2x = ${c1 + c2}` },
                            { label: "Solve for x", value: `x = ${x}` },
                            { label: "Find y", value: "?" }
                        ], answer: String(y), answerLabel: "y = ?",
                            interactiveSteps: [
                                {
                                    prompt: "To eliminate y (+y and -y), should we ADD or SUBTRACT?",
                                    hint: "+y + (-y) = 0",
                                    answer: "add",
                                    acceptableAnswers: ["add", "addition"],
                                    commonMistakes: { "subtract": "Adding gives +y + (-y) = 0!" }
                                },
                                {
                                    prompt: `Add: (x+y) + (x-y) = ?`,
                                    hint: "y terms cancel...",
                                    answer: "2x",
                                    acceptableAnswers: ["2x"],
                                    commonMistakes: { "0": "x + x = 2x. Only y cancels." }
                                },
                                {
                                    prompt: `${c1} + ${c2} = ?`,
                                    hint: "Right sides...",
                                    answer: String(c1 + c2),
                                    acceptableAnswers: [String(c1 + c2)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `2x = ${c1 + c2}. x = ?`,
                                    hint: "Divide by 2...",
                                    answer: String(x),
                                    acceptableAnswers: [String(x)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Substitute x=${x} into x + y = ${c1}. y = ?`,
                                    hint: `${c1} - ${x} = ?`,
                                    answer: String(y),
                                    acceptableAnswers: [String(y)],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Solve: x + y = ${pc1} and x - y = ${pc2}. What is x?`,
                            answer: String(px),
                            options: shuffle([String(px), String(py), String(pc1), String(px + 1)]),
                            mistakeAnalysis: {
                                [String(py)]: `That's y. Adding: 2x = ${pc1 + pc2}, x = ${px}.`,
                                [String(pc1)]: `That's x+y. Add equations: 2x = ${pc1 + pc2}, x = ${px}.`,
                                [String(px + 1)]: `Check: 2x = ${pc1 + pc2}, so x = ${px}.`
                            }
                        }
                    };
                })(),

                // Sub-skill 2: Substitution Method
                (() => {
                    const x = rand(2, 5), y = rand(1, 5);
                    const a = rand(2, 4);
                    const c1 = a * x + y;
                    // For practice
                    const px = rand(2, 5), py = rand(1, 4);
                    const pa = rand(2, 3);
                    const pc1 = pa * px + py;
                    return {
                        id: "substitution",
                        name: "Systems by Substitution",
                        goalProblem: `Solve: y = 2x + 1 and 3x + y = 11`,
                        teachingSteps: [
                            {
                                title: "When to use Substitution",
                                explanation: "Use substitution when one equation is already <strong>solved for a variable</strong> (like y = ... or x = ...). We 'substitute' that expression into the other equation!",
                                visual: "y = 2x + 1 ← already solved for y!"
                            },
                            {
                                title: "Replace y in the second equation",
                                explanation: "Since y = 2x + 1, wherever we see 'y' in the second equation, replace it with '2x + 1':<br>3x + y = 11 becomes 3x + (2x + 1) = 11",
                                visual: "3x + (2x + 1) = 11"
                            },
                            {
                                title: "Solve for x",
                                explanation: "Now we have one equation with one variable!<br>3x + 2x + 1 = 11<br>5x + 1 = 11<br>5x = 10<br><strong>x = 2</strong>",
                                visual: "5x = 10 → x = 2"
                            },
                            {
                                title: "Find y using the first equation",
                                explanation: "Substitute x = 2 back into y = 2x + 1:<br>y = 2(2) + 1 = 4 + 1 = <strong>5</strong>",
                                visual: "y = 2(2) + 1 = 5"
                            },
                            {
                                title: "Check in both equations",
                                explanation: "Solution: (2, 5)<br>Check: y = 2(2) + 1 = 5 ✓<br>3(2) + 5 = 6 + 5 = 11 ✓",
                                visual: "Solution: (2, 5)"
                            }
                        ],
                        finalAnswer: "x = 2, y = 5",
                        answerExplanation: "We substituted y = 2x + 1 into 3x + y = 11, solved for x = 2, then found y = 5.",
                        example: { problem: `Solve: y = 2x + 1 and 3x + y = 11`, steps: [
                            { text: "Substitute y = 2x + 1", math: "3x + (2x + 1) = 11" },
                            { text: "Combine like terms", math: "5x + 1 = 11" },
                            { text: "Solve for x", math: "x = 2" },
                            { text: "Find y", math: "y = 2(2) + 1 = 5" }
                        ]},
                        keyPoints: [
                            "Use when one equation is solved for a variable",
                            "Replace the variable in the OTHER equation",
                            "Always check in both original equations"
                        ],
                        mistakes: [
                            { wrong: "Substituting into the same equation", why: "Substitute into the OTHER equation!" },
                            { wrong: "Forgetting parentheses", why: "Write (2x + 1) with parentheses to avoid sign errors" }
                        ],
                        guided: { problem: `Solve: x = ${x} and ${a}x + y = ${c1}. Find y.`, steps: [
                            { label: "x is already known!", value: `x = ${x}` },
                            { label: "Substitute into second equation", value: `${a}(${x}) + y = ${c1}` },
                            { label: "Solve for y", value: "?" }
                        ], answer: String(y), answerLabel: "y = ?",
                            interactiveSteps: [
                                {
                                    prompt: `Substitute x = ${x} into ${a}x + y = ${c1}. What is ${a} × ${x}?`,
                                    hint: `${a} times ${x}...`,
                                    answer: String(a * x),
                                    acceptableAnswers: [String(a * x)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `So we have ${a * x} + y = ${c1}. Solve for y:`,
                                    hint: `${c1} - ${a * x} = ?`,
                                    answer: String(y),
                                    acceptableAnswers: [String(y)],
                                    commonMistakes: {
                                        [String(c1)]: `Subtract ${a * x}: ${c1} - ${a * x} = ${y}`
                                    }
                                }
                            ]
                        },
                        practice: {
                            problem: `Solve: x = ${px} and ${pa}x + y = ${pc1}. Find y.`,
                            answer: String(py),
                            options: shuffle([String(py), String(px), String(pa * px), String(pc1)]),
                            mistakeAnalysis: {
                                [String(px)]: `That's x. For y: ${pa}(${px}) + y = ${pc1}, so ${pa * px} + y = ${pc1}, y = ${py}`,
                                [String(pa * px)]: `That's ${pa} × ${px}. Subtract from ${pc1}: ${pc1} - ${pa * px} = ${py}`,
                                [String(pc1)]: `That's the right side. Solve: ${pa * px} + y = ${pc1}, y = ${py}`
                            }
                        }
                    };
                })()
            ]
        }),
        Functions: () => {
            const a = rand(2, 4), b = rand(1, 5), xVal = rand(2, 5);
            const fx = a * xVal + b;
            return {
                goalProblem: `If f(x) = 3x + 2, find f(5)`,
                teachingSteps: [
                    {
                        title: "What is a function?",
                        explanation: "A <strong>function</strong> is a rule that takes an input and gives exactly one output. Think of it like a machine: put something in, get something out.",
                        visual: "Input → [Function Machine] → Output"
                    },
                    {
                        title: "Understanding function notation",
                        explanation: "f(x) = 3x + 2 means 'the function f takes input x and outputs 3x + 2'. The f(x) is read as 'f of x', NOT 'f times x'!",
                        visual: "f(x) = 3x + 2 ('f of x equals...')"
                    },
                    {
                        title: "What does f(5) mean?",
                        explanation: "f(5) means 'find the output when the input is 5'. We <strong>replace every x with 5</strong> in the function rule.",
                        visual: "f(5) → plug in x = 5"
                    },
                    {
                        title: "Substitute x = 5",
                        explanation: "Take f(x) = 3x + 2 and replace x with 5: f(5) = 3(5) + 2",
                        visual: "f(5) = 3(5) + 2"
                    },
                    {
                        title: "Calculate the answer",
                        explanation: "3(5) = 15, then 15 + 2 = 17. So <strong>f(5) = 17</strong>. When we put in 5, we get out 17!",
                        visual: "f(5) = 17"
                    }
                ],
                finalAnswer: "f(5) = 17",
                answerExplanation: "f(5) means substitute 5 for x: f(5) = 3(5) + 2 = 15 + 2 = 17",
                example: { problem: `If f(x) = 3x + 2, find f(5)`, steps: [
                    { text: "Identify what we're finding", math: "f(5) means 'replace x with 5'" },
                    { text: "Write the function", math: "f(x) = 3x + 2" },
                    { text: "Substitute x = 5", math: "f(5) = 3(5) + 2" },
                    { text: "Calculate", math: "f(5) = 15 + 2 = <strong>17</strong>" }
                ]},
                keyPoints: [
                    "f(x) is 'f of x' - the output when input is x",
                    "f(3) means substitute 3 for every x in the function",
                    "A function gives exactly ONE output for each input"
                ],
                mistakes: [
                    { wrong: "f(x) = f × x (multiplying f and x)", why: "f(x) is function notation, not multiplication! f(5) means 'plug in 5 for x'" },
                    { wrong: "f(5) = 5 (just using the input as output)", why: "You must apply the function rule: f(5) = 3(5) + 2 = 17" },
                    { wrong: "Adding the input to the function: f(5) = 3x + 2 + 5", why: "Replace x WITH 5, don't add 5. f(5) = 3(5) + 2" }
                ],
                guided: { problem: `If f(x) = ${a}x + ${b}, find f(${xVal})`, steps: [
                    { label: "The function rule is", value: `f(x) = ${a}x + ${b}` },
                    { label: `Substitute x = ${xVal}`, value: `f(${xVal}) = ${a}(${xVal}) + ${b}` },
                    { label: "Calculate", value: `f(${xVal}) = ${a * xVal} + ${b} = ?` }
                ], answer: String(fx), answerLabel: `f(${xVal}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `f(${xVal}) means we plug in what value for x?`,
                            hint: "The number inside the parentheses is what we substitute...",
                            answer: String(xVal),
                            acceptableAnswers: [String(xVal), "x = " + xVal],
                            commonMistakes: {
                                [String(a)]: `${a} is the coefficient in the function. We're substituting x = ${xVal}.`,
                                [String(b)]: `${b} is the constant. The ${xVal} in f(${xVal}) is what we plug in for x.`
                            }
                        },
                        {
                            prompt: `Replace x with ${xVal} in f(x) = ${a}x + ${b}. What is ${a} × ${xVal}?`,
                            hint: `${a} times ${xVal}...`,
                            answer: String(a * xVal),
                            acceptableAnswers: [String(a * xVal)],
                            commonMistakes: {
                                [String(a + xVal)]: `Multiply, not add! ${a} × ${xVal} = ${a * xVal}`,
                                [String(xVal)]: `Don't forget to multiply by ${a}! ${a} × ${xVal} = ${a * xVal}`
                            }
                        },
                        {
                            prompt: `Now add the constant: ${a * xVal} + ${b} = ?`,
                            hint: `${a * xVal} plus ${b}...`,
                            answer: String(fx),
                            acceptableAnswers: [String(fx)],
                            commonMistakes: {
                                [String(a * xVal)]: `Don't forget to add ${b}! ${a * xVal} + ${b} = ${fx}`
                            }
                        },
                        {
                            prompt: `So f(${xVal}) = ?`,
                            hint: `We calculated ${a}(${xVal}) + ${b}...`,
                            answer: String(fx),
                            acceptableAnswers: [String(fx), "f(" + xVal + ") = " + fx],
                            commonMistakes: {
                                [String(xVal)]: `That's the input. The output is f(${xVal}) = ${fx}`
                            }
                        }
                    ]
                },
                practice: (() => { const newX = xVal + 1; const newFx = a * newX + b; return {
                    problem: `If f(x) = ${a}x + ${b}, find f(${newX})`, answer: String(newFx),
                    options: shuffle([String(newFx), String(a + newX + b), String(a * newX), String(newX)]),
                    mistakeAnalysis: {
                        [String(a + newX + b)]: `You added instead of multiplied. f(${newX}) = ${a} × ${newX} + ${b} = ${a * newX} + ${b} = ${newFx}`,
                        [String(a * newX)]: `You forgot to add ${b}. f(${newX}) = ${a}(${newX}) + ${b} = ${a * newX} + ${b} = ${newFx}`,
                        [String(newX)]: `${newX} is the INPUT. Apply the function: f(${newX}) = ${a}(${newX}) + ${b} = ${newFx}`
                    }}; })()
            };
        },
        Inequalities: () => {
            const a = rand(2, 4), b = rand(3, 8);
            const threshold = rand(10, 20);
            const solution = Math.ceil((threshold - b) / a);
            return {
                goalProblem: `Solve: 2x + 3 < 11`,
                teachingSteps: [
                    {
                        title: "What is an inequality?",
                        explanation: "An <strong>inequality</strong> compares two expressions using <, >, ≤, or ≥ instead of =. The solution is a range of values, not just one number!",
                        visual: "< less than | > greater than | ≤ at most | ≥ at least"
                    },
                    {
                        title: "Solving is like equations... mostly",
                        explanation: "We solve inequalities the same way as equations - isolate the variable. But there's ONE big difference we'll learn!",
                        visual: "2x + 3 < 11 → isolate x"
                    },
                    {
                        title: "Step 1: Subtract 3 from both sides",
                        explanation: "Undo the +3 by subtracting 3 from both sides: 2x + 3 - 3 < 11 - 3, which gives us 2x < 8",
                        visual: "2x + 3 - 3 < 11 - 3 → 2x < 8"
                    },
                    {
                        title: "Step 2: Divide both sides by 2",
                        explanation: "Divide both sides by 2 to get x alone: 2x ÷ 2 < 8 ÷ 2, which gives us <strong>x < 4</strong>",
                        visual: "2x ÷ 2 < 8 ÷ 2 → x < 4"
                    },
                    {
                        title: "The critical rule!",
                        explanation: "When dividing/multiplying by a <strong>NEGATIVE</strong> number, FLIP the inequality sign! (Here we divided by +2, so no flip needed.)",
                        visual: "x < 4 means x can be 3, 2, 1, 0, -1, ..."
                    }
                ],
                finalAnswer: "x < 4",
                answerExplanation: "x < 4 means any number less than 4 works. Remember: flip the sign when multiplying/dividing by negatives!",
                example: { problem: `Solve: 2x + 3 < 11`, steps: [
                    { text: "Subtract 3 from both sides", math: "2x + 3 - 3 < 11 - 3" },
                    { text: "Simplify", math: "2x < 8" },
                    { text: "Divide both sides by 2", math: "2x ÷ 2 < 8 ÷ 2" },
                    { text: "Solution", math: "<strong>x < 4</strong>" },
                    { text: "This means x can be any number less than 4", math: "Like 3, 2, 1, 0, -1, ..." }
                ]},
                keyPoints: [
                    "Solve like an equation - isolate the variable",
                    "FLIP the sign when multiplying/dividing by a NEGATIVE",
                    "< or > means 'not including' (open circle), ≤ or ≥ means 'including' (closed circle)"
                ],
                mistakes: [
                    { wrong: "Forgetting to flip the sign when dividing by a negative", why: "-2x > 6 becomes x < -3 (flip the >). Test: -2(-4) = 8 > 6 ✓" },
                    { wrong: "Writing the solution as a single number", why: "Inequalities have MANY solutions. x < 4 means ALL numbers less than 4." },
                    { wrong: "Confusing open and closed circles", why: "< or > = open (not including). ≤ or ≥ = closed (including)." }
                ],
                guided: { problem: `Solve: ${a}x + ${b} ≥ ${threshold}`, steps: [
                    { label: `Subtract ${b} from both sides`, value: `${a}x ≥ ${threshold - b}` },
                    { label: `Divide both sides by ${a}`, value: `x ≥ ${(threshold - b) / a}` },
                    { label: "What is x greater than or equal to?", value: "?" }
                ], answer: String(solution), answerLabel: "x ≥ ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}x + ${b} ≥ ${threshold}, what should we do first to isolate x?`,
                            hint: "Undo the outer operation first (the addition)...",
                            answer: `subtract ${b}`,
                            acceptableAnswers: [`subtract ${b}`, "subtract", `- ${b}`, "subtraction"],
                            commonMistakes: {
                                [`divide by ${a}`]: "Undo addition/subtraction first, then multiplication/division. Subtract ${b} first."
                            }
                        },
                        {
                            prompt: `Subtract ${b} from both sides: ${threshold} - ${b} = ?`,
                            hint: `${threshold} minus ${b}...`,
                            answer: String(threshold - b),
                            acceptableAnswers: [String(threshold - b)],
                            commonMistakes: {
                                [String(threshold + b)]: `Subtract, not add! ${threshold} - ${b} = ${threshold - b}`,
                                [String(threshold)]: `You need to subtract ${b}: ${threshold} - ${b} = ${threshold - b}`
                            }
                        },
                        {
                            prompt: `Now we have ${a}x ≥ ${threshold - b}. We need to divide by ${a}. When we divide by a POSITIVE number, does the inequality sign flip?`,
                            hint: "The sign only flips when dividing by a negative...",
                            answer: "no",
                            acceptableAnswers: ["no", "it doesn't", "doesn't flip", "stays same"],
                            commonMistakes: {
                                "yes": "Only flip when dividing by a NEGATIVE. ${a} is positive, so the sign stays ≥."
                            }
                        },
                        {
                            prompt: `Calculate: ${threshold - b} ÷ ${a} = ?`,
                            hint: `${threshold - b} divided by ${a}...`,
                            answer: String((threshold - b) / a),
                            acceptableAnswers: [String((threshold - b) / a), String(solution)],
                            commonMistakes: {
                                [String((threshold - b) * a)]: `Divide, not multiply! ${threshold - b} ÷ ${a} = ${(threshold - b) / a}`
                            }
                        },
                        {
                            prompt: `So x ≥ ?`,
                            hint: `We found ${threshold - b} ÷ ${a}...`,
                            answer: String(solution),
                            acceptableAnswers: [String(solution), "x ≥ " + solution],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: 3x - 4 > 11. What values can x be?`, answer: "x > 5",
                    options: ["x > 5", "x < 5", "x > 7", "x = 5"],
                    mistakeAnalysis: {
                        "x < 5": "The inequality sign doesn't flip here (we divided by positive 3). 3x > 15, so x > 5.",
                        "x > 7": "Check your arithmetic: 3x > 11 + 4 = 15, so x > 15/3 = 5",
                        "x = 5": "This is an inequality (>) not an equation. x can be any number GREATER than 5."
                    }}
            };
        },
        Radicals: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Simplifying Radicals
                (() => {
                    const outside = rand(2, 5), inside = rand(2, 7);
                    const radicand = outside * outside * inside;
                    // For practice
                    const po = 3, pi = 5, pr = po * po * pi;
                    return {
                        id: "simplify",
                        name: "Simplifying Radicals",
                        goalProblem: `Simplify: √72`,
                        teachingSteps: [
                            {
                                title: "What is a radical?",
                                explanation: "A <strong>radical</strong> is a root expression, like √ (square root). Simplifying means rewriting it in its simplest form.",
                                visual: "√72 → simplest form?"
                            },
                            {
                                title: "Find perfect square factors",
                                explanation: "To simplify √72, find a <strong>perfect square</strong> that divides 72 evenly. Perfect squares: 4, 9, 16, 25, 36...",
                                visual: "72 = 36 × 2 (36 is a perfect square!)"
                            },
                            {
                                title: "Split the radical",
                                explanation: "Use the rule √(a×b) = √a × √b. So √72 = √(36 × 2) = √36 × √2",
                                visual: "√72 = √36 × √2"
                            },
                            {
                                title: "Simplify the perfect square",
                                explanation: "√36 = 6 (because 6 × 6 = 36). So √72 = 6 × √2 = <strong>6√2</strong>",
                                visual: "√36 = 6, so √72 = 6√2"
                            },
                            {
                                title: "The simplified form!",
                                explanation: "<strong>√72 = 6√2</strong>. The 6 'comes out' and √2 stays inside because 2 has no perfect square factors.",
                                visual: "√72 = 6√2"
                            }
                        ],
                        finalAnswer: "6√2",
                        answerExplanation: "72 = 36 × 2, √36 = 6, so √72 = 6√2.",
                        example: { problem: `Simplify: √72`, steps: [
                            { text: "Find perfect square factor", math: "72 = 36 × 2" },
                            { text: "Split the radical", math: "√72 = √36 × √2" },
                            { text: "Simplify", math: "√36 = 6, so √72 = <strong>6√2</strong>" }
                        ]},
                        keyPoints: [
                            "√(a×b) = √a × √b (product rule)",
                            "Look for the LARGEST perfect square factor",
                            "Perfect squares: 4, 9, 16, 25, 36, 49, 64, 81..."
                        ],
                        mistakes: [
                            { wrong: "Leaving as decimal", why: "Keep in radical form: 6√2, not 8.485" },
                            { wrong: "Using smaller perfect square", why: "Use the LARGEST: √72 = 6√2, not 2√18" }
                        ],
                        guided: { problem: `Simplify: √${radicand}`, steps: [
                            { label: "Perfect square factor", value: `${outside * outside}` },
                            { label: `${radicand} = ${outside * outside} × ${inside}`, value: `√${outside * outside} = ${outside}` }
                        ], answer: `${outside}√${inside}`, answerLabel: `√${radicand} = ?`,
                            interactiveSteps: [
                                {
                                    prompt: `What is ${outside}²?`,
                                    hint: `${outside} × ${outside}`,
                                    answer: String(outside * outside),
                                    acceptableAnswers: [String(outside * outside)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `${radicand} ÷ ${outside * outside} = ?`,
                                    hint: "What's left inside...",
                                    answer: String(inside),
                                    acceptableAnswers: [String(inside)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `√${outside * outside} = ?`,
                                    hint: "Square root...",
                                    answer: String(outside),
                                    acceptableAnswers: [String(outside)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `So √${radicand} = ?`,
                                    hint: `${outside}√${inside}`,
                                    answer: `${outside}√${inside}`,
                                    acceptableAnswers: [`${outside}√${inside}`, `${outside} √${inside}`],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Simplify: √${pr}`,
                            answer: `${po}√${pi}`,
                            options: shuffle([`${po}√${pi}`, `${pi}√${po}`, `√${pr}`, `${po * pi}`]),
                            mistakeAnalysis: {
                                [`${pi}√${po}`]: `Swapped! ${pr} = 9 × ${pi}, so √${pr} = ${po}√${pi}`,
                                [`√${pr}`]: `Can be simplified! √${pr} = ${po}√${pi}`,
                                [`${po * pi}`]: `Not a multiplication. √${pr} = ${po}√${pi}`
                            }
                        }
                    };
                })(),

                // Sub-skill 2: Adding Like Radicals
                (() => {
                    const c1 = rand(2, 5), c2 = rand(2, 4), inside = rand(2, 7);
                    const sum = c1 + c2;
                    // For practice
                    const pc1 = rand(3, 6), pc2 = rand(2, 5), pInside = rand(2, 5);
                    const pSum = pc1 + pc2;
                    return {
                        id: "add",
                        name: "Adding Like Radicals",
                        goalProblem: `Simplify: 3√5 + 4√5`,
                        teachingSteps: [
                            {
                                title: "What are 'like radicals'?",
                                explanation: "<strong>Like radicals</strong> have the same number under the radical sign. 3√5 and 4√5 are like radicals because both have √5.",
                                visual: "3√5 and 4√5 (both have √5)"
                            },
                            {
                                title: "Like radicals = like terms!",
                                explanation: "Adding like radicals is just like adding like terms! Just add the coefficients (numbers in front) and keep the radical.",
                                visual: "3x + 4x = 7x → 3√5 + 4√5 = 7√5"
                            },
                            {
                                title: "Add the coefficients",
                                explanation: "3√5 + 4√5 = (3 + 4)√5 = <strong>7√5</strong>",
                                visual: "3 + 4 = 7, so 3√5 + 4√5 = 7√5"
                            },
                            {
                                title: "Important: Only add LIKE radicals!",
                                explanation: "3√5 + 4√3 CANNOT be simplified because √5 ≠ √3. They're not like radicals!",
                                visual: "3√5 + 4√3 ≠ combined"
                            },
                            {
                                title: "Summary",
                                explanation: "Add coefficients when radicals match. The radicand (number inside) stays the same!",
                                visual: "3√5 + 4√5 = 7√5"
                            }
                        ],
                        finalAnswer: "7√5",
                        answerExplanation: "Like radicals: add coefficients (3 + 4 = 7), keep √5. Answer: 7√5",
                        example: { problem: `Simplify: 3√5 + 4√5`, steps: [
                            { text: "Identify like radicals", math: "Both have √5 ✓" },
                            { text: "Add the coefficients", math: "3 + 4 = 7" },
                            { text: "Keep the radical", math: "<strong>7√5</strong>" }
                        ]},
                        keyPoints: [
                            "Like radicals have the same radicand",
                            "Add coefficients, keep the radical",
                            "Can't add √5 + √3 (different radicands)"
                        ],
                        mistakes: [
                            { wrong: "3√5 + 4√5 = 7√10", why: "Don't add the radicands! Keep √5: 7√5" },
                            { wrong: "Adding unlike radicals", why: "3√5 + 4√3 cannot be combined!" }
                        ],
                        guided: { problem: `Simplify: ${c1}√${inside} + ${c2}√${inside}`, steps: [
                            { label: "Same radicand?", value: `Both √${inside} ✓` },
                            { label: "Add coefficients", value: `${c1} + ${c2} = ${sum}` }
                        ], answer: `${sum}√${inside}`, answerLabel: "Simplified:",
                            interactiveSteps: [
                                {
                                    prompt: `Are ${c1}√${inside} and ${c2}√${inside} like radicals?`,
                                    hint: "Do they have the same number under √?",
                                    answer: "yes",
                                    acceptableAnswers: ["yes", "y", "yeah"],
                                    commonMistakes: { "no": `Both have √${inside}, so yes!` }
                                },
                                {
                                    prompt: `Add the coefficients: ${c1} + ${c2} = ?`,
                                    hint: "Add the numbers in front...",
                                    answer: String(sum),
                                    acceptableAnswers: [String(sum)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `So ${c1}√${inside} + ${c2}√${inside} = ?`,
                                    hint: `${sum}√${inside}`,
                                    answer: `${sum}√${inside}`,
                                    acceptableAnswers: [`${sum}√${inside}`, `${sum} √${inside}`],
                                    commonMistakes: {
                                        [`${sum}√${inside * 2}`]: `Don't add radicands! Keep √${inside}: ${sum}√${inside}`
                                    }
                                }
                            ]
                        },
                        practice: {
                            problem: `Simplify: ${pc1}√${pInside} + ${pc2}√${pInside}`,
                            answer: `${pSum}√${pInside}`,
                            options: shuffle([`${pSum}√${pInside}`, `${pc1 * pc2}√${pInside}`, `${pSum}√${pInside * 2}`, `√${pSum * pInside}`]),
                            mistakeAnalysis: {
                                [`${pc1 * pc2}√${pInside}`]: `Add, don't multiply! ${pc1} + ${pc2} = ${pSum}`,
                                [`${pSum}√${pInside * 2}`]: `Don't add radicands! Keep √${pInside}: ${pSum}√${pInside}`,
                                [`√${pSum * pInside}`]: `Add the coefficients only: ${pSum}√${pInside}`
                            }
                        }
                    };
                })(),

                // Sub-skill 3: Multiplying Radicals
                (() => {
                    const a = rand(2, 6), b = rand(2, 6);
                    const product = a * b;
                    // For practice
                    const pa = rand(2, 5), pb = rand(2, 7);
                    const pProd = pa * pb;
                    return {
                        id: "multiply",
                        name: "Multiplying Radicals",
                        goalProblem: `Simplify: √3 × √5`,
                        teachingSteps: [
                            {
                                title: "Multiplying square roots",
                                explanation: "When multiplying square roots, we can combine them under one radical! This is called the <strong>product rule</strong> for radicals.",
                                visual: "√a × √b = √(a × b)"
                            },
                            {
                                title: "Apply the product rule",
                                explanation: "√3 × √5 = √(3 × 5) = √15. We multiply the numbers inside and put them under one √.",
                                visual: "√3 × √5 = √15"
                            },
                            {
                                title: "Check if you can simplify",
                                explanation: "√15 = √15 (15 = 3 × 5, no perfect square factors). Sometimes you can simplify further: √4 × √3 = √12 = 2√3",
                                visual: "√15 is already simplified"
                            },
                            {
                                title: "With coefficients",
                                explanation: "If there are coefficients, multiply them separately:<br>2√3 × 4√5 = (2×4)√(3×5) = 8√15",
                                visual: "2√3 × 4√5 = 8√15"
                            },
                            {
                                title: "Summary",
                                explanation: "<strong>√a × √b = √(a×b)</strong><br>Multiply radicands together, then simplify if possible!",
                                visual: "√3 × √5 = √15"
                            }
                        ],
                        finalAnswer: "√15",
                        answerExplanation: "√3 × √5 = √(3×5) = √15. Product rule: multiply radicands!",
                        example: { problem: `Simplify: √3 × √5`, steps: [
                            { text: "Apply product rule", math: "√3 × √5 = √(3 × 5)" },
                            { text: "Multiply radicands", math: "= √15" },
                            { text: "Check for simplification", math: "√15 is simplified" }
                        ]},
                        keyPoints: [
                            "Product rule: √a × √b = √(a×b)",
                            "Multiply radicands together",
                            "Always simplify the result if possible"
                        ],
                        mistakes: [
                            { wrong: "√3 × √5 = √8", why: "Multiply, don't add! 3 × 5 = 15, so √15" },
                            { wrong: "√3 × √5 = 15", why: "Keep the radical! √(3×5) = √15, not 15" }
                        ],
                        guided: { problem: `Simplify: √${a} × √${b}`, steps: [
                            { label: "Product rule", value: `√${a} × √${b} = √(${a} × ${b})` },
                            { label: "Multiply", value: `${a} × ${b} = ${product}` }
                        ], answer: `√${product}`, answerLabel: "Simplified:",
                            interactiveSteps: [
                                {
                                    prompt: `√${a} × √${b} = √(?). What goes inside?`,
                                    hint: `${a} × ${b} = ?`,
                                    answer: String(product),
                                    acceptableAnswers: [String(product), `${a} × ${b}`],
                                    commonMistakes: {
                                        [String(a + b)]: `Multiply, don't add! ${a} × ${b} = ${product}`
                                    }
                                },
                                {
                                    prompt: `So √${a} × √${b} = ?`,
                                    hint: `√${product}`,
                                    answer: `√${product}`,
                                    acceptableAnswers: [`√${product}`, `sqrt(${product})`],
                                    commonMistakes: {
                                        [String(product)]: `Keep the radical! √${product}, not ${product}`
                                    }
                                }
                            ]
                        },
                        practice: {
                            problem: `Simplify: √${pa} × √${pb}`,
                            answer: `√${pProd}`,
                            options: shuffle([`√${pProd}`, `√${pa + pb}`, `${pa}√${pb}`, `${pProd}`]),
                            mistakeAnalysis: {
                                [`√${pa + pb}`]: `Multiply, don't add! ${pa} × ${pb} = ${pProd}. Answer: √${pProd}`,
                                [`${pa}√${pb}`]: `That's coefficient × radical. √${pa} × √${pb} = √${pProd}`,
                                [`${pProd}`]: `Keep the √! Answer is √${pProd}, not ${pProd}`
                            }
                        }
                    };
                })()
            ]
        }),
        "Exponential Functions": () => {
            const base = rand(2, 4), x = rand(2, 4);
            const result = Math.pow(base, x);
            return {
                goalProblem: `If f(x) = 2^x, find f(5)`,
                teachingSteps: [
                    {
                        title: "What is an exponential function?",
                        explanation: "An <strong>exponential function</strong> has the variable in the exponent: f(x) = b^x. The base 'b' is a constant, and x is the exponent.",
                        visual: "f(x) = 2^x (2 is the base, x is the exponent)"
                    },
                    {
                        title: "Growth vs Decay",
                        explanation: "If base > 1, the function shows <strong>growth</strong> (gets bigger fast). If 0 < base < 1, it shows <strong>decay</strong> (gets smaller).",
                        visual: "b > 1 → growth | 0 < b < 1 → decay"
                    },
                    {
                        title: "Evaluating f(5)",
                        explanation: "f(5) means substitute x = 5: f(5) = 2^5. We need to calculate 2 to the 5th power.",
                        visual: "f(5) = 2^5 = 2 × 2 × 2 × 2 × 2"
                    },
                    {
                        title: "Calculate the power",
                        explanation: "2^5 = 2 × 2 × 2 × 2 × 2 = 4 × 4 × 2 = 16 × 2 = <strong>32</strong>",
                        visual: "2^5 = 32"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>f(5) = 32</strong>. Exponential functions grow very quickly - 2^10 would be 1024!",
                        visual: "f(5) = 32"
                    }
                ],
                finalAnswer: "f(5) = 32",
                answerExplanation: "f(5) = 2^5 = 2×2×2×2×2 = 32. Exponential functions grow rapidly!",
                example: { problem: `If f(x) = 2^x, find f(5)`, steps: [
                    { text: "Substitute x = 5", math: "f(5) = 2^5" },
                    { text: "Calculate the power", math: "2^5 = 2 × 2 × 2 × 2 × 2" },
                    { text: "Multiply step by step", math: "= 4 × 4 × 2 = 32" },
                    { text: "Final answer", math: "<strong>f(5) = 32</strong>" }
                ]},
                keyPoints: [
                    "Exponential: variable is in the exponent (2^x not x^2)",
                    "Base > 1 means growth, 0 < base < 1 means decay",
                    "These functions grow/decay VERY fast"
                ],
                mistakes: [
                    { wrong: "2^5 = 10 (multiplying base × exponent)", why: "2^5 means 2×2×2×2×2, not 2×5. Answer is 32." },
                    { wrong: "Confusing 2^5 with 5^2", why: "2^5 = 32 but 5^2 = 25. The position matters!" },
                    { wrong: "f(5) = 2 × 5 = 10", why: "The x is an exponent, not a multiplier. f(5) = 2^5 = 32" }
                ],
                guided: {
                    problem: `If f(x) = ${base}^x, find f(${x})`,
                    steps: [
                        { label: `Substitute x = ${x}`, value: `f(${x}) = ${base}^${x}` },
                        { label: `Calculate ${base}^${x}`, value: "?" }
                    ],
                    answer: String(result),
                    answerLabel: `f(${x}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `In an exponential function like ${base}^x, where is the variable located?`,
                            hint: "Look at where x appears in the expression...",
                            answer: "exponent",
                            acceptableAnswers: ["exponent", "the exponent", "in the exponent", "power"],
                            commonMistakes: {
                                "base": "The base is ${base} (a constant). The variable x is in the exponent position."
                            }
                        },
                        {
                            prompt: `f(${x}) means we substitute ${x} for x. What is ${base}^${x}?`,
                            hint: `${base} multiplied by itself ${x} times...`,
                            answer: String(result),
                            acceptableAnswers: [String(result)],
                            commonMistakes: {
                                [String(base * x)]: `You multiplied ${base} × ${x}. We need ${base}^${x} = ${base} × ${base}... (${x} times) = ${result}`,
                                [String(base + x)]: `You added! ${base}^${x} means ${base} multiplied by itself ${x} times = ${result}`
                            }
                        },
                        {
                            prompt: `Is f(x) = ${base}^x a growth or decay function?`,
                            hint: `The base ${base} is greater than 1...`,
                            answer: "growth",
                            acceptableAnswers: ["growth", "exponential growth"],
                            commonMistakes: {
                                "decay": `Base ${base} > 1, so this is GROWTH. Decay happens when 0 < base < 1.`
                            }
                        }
                    ]
                },
                practice: (() => { const pb = 3, px = 4, pr = Math.pow(pb, px); return {
                    problem: `If f(x) = ${pb}^x, find f(${px})`, answer: String(pr),
                    options: shuffle([String(pr), String(pb * px), String(Math.pow(px, pb)), String(pb + px)]),
                    mistakeAnalysis: {
                        [String(pb * px)]: `You multiplied base × exponent. ${pb}^${px} means ${pb}×${pb}×${pb}×${pb} = ${pr}`,
                        [String(Math.pow(px, pb))]: `You swapped them! ${pb}^${px} = ${pr}, not ${px}^${pb} = ${Math.pow(px, pb)}`,
                        [String(pb + px)]: `You added! ${pb}^${px} = ${pr}`
                    }}; })()
            };
        },
        "Arithmetic Sequences": () => {
            const a1 = rand(2, 10), d = rand(2, 6), n = rand(5, 8);
            const an = a1 + (n - 1) * d;
            return {
                goalProblem: `Find the 10th term: 3, 7, 11, 15, ...`,
                teachingSteps: [
                    {
                        title: "What is an arithmetic sequence?",
                        explanation: "An <strong>arithmetic sequence</strong> adds the same number each time. This number is called the <strong>common difference (d)</strong>.",
                        visual: "3, 7, 11, 15... (+4 each time)"
                    },
                    {
                        title: "Find the common difference",
                        explanation: "Subtract consecutive terms: 7 - 3 = 4, 11 - 7 = 4, 15 - 11 = 4. The common difference d = <strong>4</strong>.",
                        visual: "d = 7 - 3 = 4"
                    },
                    {
                        title: "The formula for any term",
                        explanation: "The nth term formula is: <strong>aₙ = a₁ + (n-1)d</strong>. a₁ is the first term, d is the common difference, n is which term.",
                        visual: "aₙ = a₁ + (n-1)d"
                    },
                    {
                        title: "Find the 10th term",
                        explanation: "Plug in: a₁ = 3, d = 4, n = 10. a₁₀ = 3 + (10-1)(4) = 3 + 9(4) = 3 + 36 = <strong>39</strong>",
                        visual: "a₁₀ = 3 + 9(4) = 39"
                    },
                    {
                        title: "The answer!",
                        explanation: "The 10th term is <strong>39</strong>. We can verify: 3, 7, 11, 15, 19, 23, 27, 31, 35, 39 ✓",
                        visual: "a₁₀ = 39"
                    }
                ],
                finalAnswer: "39",
                answerExplanation: "Using aₙ = a₁ + (n-1)d: a₁₀ = 3 + (10-1)(4) = 3 + 36 = 39",
                example: { problem: `Find the 10th term: 3, 7, 11, 15, ...`, steps: [
                    { text: "Identify a₁ and find d", math: "a₁ = 3, d = 7 - 3 = 4" },
                    { text: "Use the formula aₙ = a₁ + (n-1)d", math: "a₁₀ = 3 + (10-1)(4)" },
                    { text: "Simplify", math: "a₁₀ = 3 + 9(4) = 3 + 36" },
                    { text: "Final answer", math: "<strong>a₁₀ = 39</strong>" }
                ]},
                keyPoints: [
                    "Arithmetic = adding the SAME amount each time",
                    "d = any term minus the previous term",
                    "Formula: aₙ = a₁ + (n-1)d"
                ],
                mistakes: [
                    { wrong: "Using n instead of (n-1): a₁₀ = 3 + 10(4) = 43", why: "The formula has (n-1) because we ADD to the first term. a₁₀ = 3 + 9(4) = 39" },
                    { wrong: "Multiplying a₁ by d: 3 × 4 = 12", why: "We ADD (n-1)d to a₁, not multiply. a₁₀ = 3 + 36 = 39" },
                    { wrong: "Forgetting to subtract 1 from n", why: "(n-1) accounts for the first term. For the 10th term, we add d nine times." }
                ],
                guided: {
                    problem: `Find the ${n}th term of the arithmetic sequence where a₁ = ${a1} and d = ${d}`,
                    steps: [
                        { label: "Formula", value: "aₙ = a₁ + (n-1)d" },
                        { label: `Substitute: a₁ = ${a1}, d = ${d}, n = ${n}`, value: `a${n} = ${a1} + (${n}-1)(${d})` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(an),
                    answerLabel: `a${n} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "In an arithmetic sequence, what do we call the constant added each time?",
                            hint: "It's the 'common ___'",
                            answer: "common difference",
                            acceptableAnswers: ["common difference", "difference", "d"],
                            commonMistakes: {
                                "common ratio": "That's for GEOMETRIC sequences! Arithmetic sequences have a common DIFFERENCE."
                            }
                        },
                        {
                            prompt: `Using aₙ = a₁ + (n-1)d, what is (${n} - 1)?`,
                            hint: "Subtract 1 from n...",
                            answer: String(n - 1),
                            acceptableAnswers: [String(n - 1)],
                            commonMistakes: {
                                [String(n)]: `Subtract 1! ${n} - 1 = ${n - 1}`
                            }
                        },
                        {
                            prompt: `Now multiply: ${n - 1} × ${d} = ?`,
                            hint: `${n - 1} times ${d}...`,
                            answer: String((n - 1) * d),
                            acceptableAnswers: [String((n - 1) * d)],
                            commonMistakes: {
                                [String(n * d)]: `Use (n-1), not n! ${n - 1} × ${d} = ${(n - 1) * d}`
                            }
                        },
                        {
                            prompt: `Finally, add a₁: ${a1} + ${(n - 1) * d} = ?`,
                            hint: "Add the first term to your result...",
                            answer: String(an),
                            acceptableAnswers: [String(an)],
                            commonMistakes: {
                                [String((n - 1) * d)]: `Don't forget to add a₁! ${a1} + ${(n - 1) * d} = ${an}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = 5, pd = 3, pn = 8, pan = pa + (pn - 1) * pd; return {
                    problem: `Find the ${pn}th term: ${pa}, ${pa + pd}, ${pa + 2*pd}, ...`, answer: String(pan),
                    options: shuffle([String(pan), String(pa + pn * pd), String(pa * pn), String(pan - pd)]),
                    mistakeAnalysis: {
                        [String(pa + pn * pd)]: `Use (n-1), not n! a${pn} = ${pa} + (${pn}-1)(${pd}) = ${pa} + ${(pn-1)*pd} = ${pan}`,
                        [String(pa * pn)]: `Arithmetic sequences ADD, not multiply. a${pn} = ${pa} + ${(pn-1)*pd} = ${pan}`,
                        [String(pan - pd)]: `That's the ${pn - 1}th term. The ${pn}th term is ${pan}.`
                    }}; })()
            };
        },
        "Geometric Sequences": () => {
            const a1 = rand(2, 5), r = rand(2, 3), n = rand(4, 5);
            const an = a1 * Math.pow(r, n - 1);
            return {
                goalProblem: `Find the 5th term: 2, 6, 18, 54, ...`,
                teachingSteps: [
                    {
                        title: "What is a geometric sequence?",
                        explanation: "A <strong>geometric sequence</strong> multiplies by the same number each time. This number is called the <strong>common ratio (r)</strong>.",
                        visual: "2, 6, 18, 54... (×3 each time)"
                    },
                    {
                        title: "Find the common ratio",
                        explanation: "Divide consecutive terms: 6 ÷ 2 = 3, 18 ÷ 6 = 3, 54 ÷ 18 = 3. The common ratio r = <strong>3</strong>.",
                        visual: "r = 6 ÷ 2 = 3"
                    },
                    {
                        title: "The formula for any term",
                        explanation: "The nth term formula is: <strong>aₙ = a₁ × r^(n-1)</strong>. a₁ is the first term, r is the common ratio.",
                        visual: "aₙ = a₁ × r^(n-1)"
                    },
                    {
                        title: "Find the 5th term",
                        explanation: "Plug in: a₁ = 2, r = 3, n = 5. a₅ = 2 × 3^(5-1) = 2 × 3^4 = 2 × 81 = <strong>162</strong>",
                        visual: "a₅ = 2 × 3^4 = 2 × 81 = 162"
                    },
                    {
                        title: "The answer!",
                        explanation: "The 5th term is <strong>162</strong>. Sequence: 2, 6, 18, 54, 162 ✓",
                        visual: "a₅ = 162"
                    }
                ],
                finalAnswer: "162",
                answerExplanation: "Using aₙ = a₁ × r^(n-1): a₅ = 2 × 3^4 = 2 × 81 = 162",
                example: { problem: `Find the 5th term: 2, 6, 18, 54, ...`, steps: [
                    { text: "Identify a₁ and find r", math: "a₁ = 2, r = 6 ÷ 2 = 3" },
                    { text: "Use the formula aₙ = a₁ × r^(n-1)", math: "a₅ = 2 × 3^(5-1)" },
                    { text: "Simplify the exponent", math: "a₅ = 2 × 3^4 = 2 × 81" },
                    { text: "Final answer", math: "<strong>a₅ = 162</strong>" }
                ]},
                keyPoints: [
                    "Geometric = MULTIPLYING by the same amount each time",
                    "r = any term DIVIDED BY the previous term",
                    "Formula: aₙ = a₁ × r^(n-1)"
                ],
                mistakes: [
                    { wrong: "Using n instead of (n-1) in exponent: 2 × 3^5 = 486", why: "The formula uses r^(n-1). For the 5th term: 3^4, not 3^5." },
                    { wrong: "Adding instead of multiplying: 2 + 3(4) = 14", why: "Geometric sequences MULTIPLY. a₅ = 2 × 3^4 = 162" },
                    { wrong: "Confusing with arithmetic: 2 + 4(3) = 14", why: "This is geometric (multiply), not arithmetic (add)." }
                ],
                guided: {
                    problem: `Find the ${n}th term of the geometric sequence where a₁ = ${a1} and r = ${r}`,
                    steps: [
                        { label: "Formula", value: "aₙ = a₁ × r^(n-1)" },
                        { label: `Substitute: a₁ = ${a1}, r = ${r}, n = ${n}`, value: `a${n} = ${a1} × ${r}^(${n}-1)` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(an),
                    answerLabel: `a${n} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "In a geometric sequence, what do we call the constant we multiply by each time?",
                            hint: "It's the 'common ___'",
                            answer: "common ratio",
                            acceptableAnswers: ["common ratio", "ratio", "r"],
                            commonMistakes: {
                                "common difference": "That's for ARITHMETIC sequences! Geometric sequences have a common RATIO."
                            }
                        },
                        {
                            prompt: `Using aₙ = a₁ × r^(n-1), what is the exponent when n = ${n}?`,
                            hint: "Calculate n - 1...",
                            answer: String(n - 1),
                            acceptableAnswers: [String(n - 1)],
                            commonMistakes: {
                                [String(n)]: `The exponent is (n-1), not n! ${n} - 1 = ${n - 1}`
                            }
                        },
                        {
                            prompt: `Calculate ${r}^${n - 1} = ?`,
                            hint: `${r} multiplied by itself ${n - 1} times...`,
                            answer: String(Math.pow(r, n - 1)),
                            acceptableAnswers: [String(Math.pow(r, n - 1))],
                            commonMistakes: {
                                [String(r * (n - 1))]: `That's ${r} × ${n - 1}. We need ${r}^${n - 1} = ${Math.pow(r, n - 1)}`
                            }
                        },
                        {
                            prompt: `Finally, multiply by a₁: ${a1} × ${Math.pow(r, n - 1)} = ?`,
                            hint: "Multiply the first term by your result...",
                            answer: String(an),
                            acceptableAnswers: [String(an)],
                            commonMistakes: {
                                [String(Math.pow(r, n - 1))]: `Don't forget to multiply by a₁! ${a1} × ${Math.pow(r, n - 1)} = ${an}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = 3, pr = 2, pn = 5, pan = pa * Math.pow(pr, pn - 1); return {
                    problem: `Find the ${pn}th term: ${pa}, ${pa * pr}, ${pa * pr * pr}, ...`, answer: String(pan),
                    options: shuffle([String(pan), String(pa * Math.pow(pr, pn)), String(pa + (pn - 1) * pr), String(pa * pn * pr)]),
                    mistakeAnalysis: {
                        [String(pa * Math.pow(pr, pn))]: `Exponent is (n-1), not n! a${pn} = ${pa} × ${pr}^${pn - 1} = ${pan}`,
                        [String(pa + (pn - 1) * pr)]: `That's arithmetic formula! Geometric uses aₙ = a₁ × r^(n-1) = ${pan}`,
                        [String(pa * pn * pr)]: `Use the formula: a${pn} = ${pa} × ${pr}^${pn - 1} = ${pan}`
                    }}; })()
            };
        },
        "Compound Interest": () => {
            const P = pick([100, 200, 500, 1000]);
            const r = pick([5, 6, 8, 10]);
            const t = rand(2, 3);
            const A = Math.round(P * Math.pow(1 + r/100, t));
            return {
                goalProblem: `$1000 at 5% interest compounded annually for 3 years. Find the final amount.`,
                teachingSteps: [
                    {
                        title: "What is compound interest?",
                        explanation: "<strong>Compound interest</strong> means you earn interest on your interest! Each year, the interest is added to your balance, and next year you earn interest on the bigger amount.",
                        visual: "Interest on principal AND previous interest"
                    },
                    {
                        title: "The compound interest formula",
                        explanation: "A = P(1 + r)^t where: A = final amount, P = principal (starting amount), r = rate (as decimal), t = time (years)",
                        visual: "A = P(1 + r)^t"
                    },
                    {
                        title: "Identify the values",
                        explanation: "P = $1000 (starting amount), r = 5% = 0.05 (as decimal), t = 3 years",
                        visual: "P = 1000, r = 0.05, t = 3"
                    },
                    {
                        title: "Plug into the formula",
                        explanation: "A = 1000(1 + 0.05)^3 = 1000(1.05)^3 = 1000 × 1.157625 ≈ <strong>$1157.63</strong>",
                        visual: "A = 1000(1.05)^3 ≈ $1157.63"
                    },
                    {
                        title: "Compare to simple interest",
                        explanation: "Simple interest would give: 1000 + (1000 × 0.05 × 3) = $1150. Compound interest gives $1157.63 - that's $7.63 more!",
                        visual: "Compound: $1157.63 > Simple: $1150"
                    }
                ],
                finalAnswer: "$1157.63",
                answerExplanation: "A = P(1+r)^t = 1000(1.05)^3 = 1000 × 1.157625 ≈ $1157.63. Compound interest earns more than simple interest!",
                example: { problem: `$1000 at 5% compounded annually for 3 years`, steps: [
                    { text: "Identify values", math: "P = 1000, r = 0.05, t = 3" },
                    { text: "Use formula A = P(1+r)^t", math: "A = 1000(1 + 0.05)^3" },
                    { text: "Simplify inside parentheses", math: "A = 1000(1.05)^3" },
                    { text: "Calculate 1.05^3", math: "1.05^3 ≈ 1.1576" },
                    { text: "Multiply", math: "<strong>A ≈ $1157.63</strong>" }
                ]},
                keyPoints: [
                    "Convert percent to decimal: 5% = 0.05",
                    "Formula: A = P(1 + r)^t for annual compounding",
                    "Compound interest > Simple interest (earns interest on interest)"
                ],
                mistakes: [
                    { wrong: "Using r = 5 instead of r = 0.05", why: "Must convert percent to decimal! 5% = 5/100 = 0.05" },
                    { wrong: "Adding instead of using exponent: P + Prt = simple interest", why: "That's simple interest. Compound uses (1+r)^t with an exponent." },
                    { wrong: "Forgetting to add 1 to r: 1000(0.05)^3", why: "It's (1 + r)^t, not r^t. The 1 represents keeping your principal!" }
                ],
                guided: {
                    problem: `$${P} at ${r}% interest compounded annually for ${t} years. Find the final amount.`,
                    steps: [
                        { label: "Convert rate to decimal", value: `${r}% = ${r/100}` },
                        { label: "Use A = P(1+r)^t", value: `A = ${P}(1 + ${r/100})^${t}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(A),
                    answerLabel: "A = $?",
                    interactiveSteps: [
                        {
                            prompt: `First, convert ${r}% to a decimal. What is ${r} ÷ 100?`,
                            hint: "Move the decimal point two places left...",
                            answer: String(r/100),
                            acceptableAnswers: [String(r/100), "0." + (r < 10 ? "0" + r : r)],
                            commonMistakes: {
                                [String(r)]: `${r} is the percent. As a decimal: ${r} ÷ 100 = ${r/100}`,
                                [String(r/10)]: `Divide by 100, not 10! ${r} ÷ 100 = ${r/100}`
                            }
                        },
                        {
                            prompt: `What is 1 + ${r/100}?`,
                            hint: "Add 1 to the decimal rate...",
                            answer: String(1 + r/100),
                            acceptableAnswers: [String(1 + r/100)],
                            commonMistakes: {
                                [String(r/100)]: `Don't forget the 1! 1 + ${r/100} = ${1 + r/100}`
                            }
                        },
                        {
                            prompt: `Now calculate (${1 + r/100})^${t} ≈ ?`,
                            hint: `${1 + r/100} multiplied by itself ${t} times...`,
                            answer: String(Math.pow(1 + r/100, t).toFixed(4)),
                            acceptableAnswers: [String(Math.pow(1 + r/100, t).toFixed(4)), String(Math.pow(1 + r/100, t).toFixed(2)), String(Math.pow(1 + r/100, t).toFixed(3))],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Finally, multiply: ${P} × ${Math.pow(1 + r/100, t).toFixed(4)} ≈ $?`,
                            hint: "Round to the nearest dollar...",
                            answer: String(A),
                            acceptableAnswers: [String(A), String(Math.round(P * Math.pow(1 + r/100, t)))],
                            commonMistakes: {
                                [String(P)]: `You need to multiply! ${P} × ${Math.pow(1 + r/100, t).toFixed(2)} ≈ $${A}`
                            }
                        }
                    ]
                },
                practice: (() => { const pp = 500, pr = 10, pt = 2, pa = Math.round(pp * Math.pow(1 + pr/100, pt)); return {
                    problem: `$${pp} at ${pr}% compounded annually for ${pt} years`, answer: String(pa),
                    options: shuffle([String(pa), String(pp + pp * pr/100 * pt), String(pp * pr/100 * pt), String(Math.round(pp * Math.pow(pr/100, pt)))]),
                    mistakeAnalysis: {
                        [String(pp + pp * pr/100 * pt)]: `That's simple interest! Compound: A = ${pp}(1.${pr})^${pt} = $${pa}`,
                        [String(pp * pr/100 * pt)]: `That's just the interest from simple interest. Compound gives $${pa}`,
                        [String(Math.round(pp * Math.pow(pr/100, pt)))]: `You forgot the 1! Use (1 + r)^t, not r^t. Answer is $${pa}`
                    }}; })()
            };
        },
        "Domain and Range": () => {
            const a = rand(2, 5);
            const vertex = rand(-3, 3);
            return {
                goalProblem: `Find the domain and range of f(x) = x²`,
                teachingSteps: [
                    {
                        title: "What are domain and range?",
                        explanation: "<strong>Domain</strong> = all possible INPUT values (x). <strong>Range</strong> = all possible OUTPUT values (y or f(x)).",
                        visual: "Domain: What can go IN? | Range: What can come OUT?"
                    },
                    {
                        title: "Finding the domain",
                        explanation: "Ask: 'What x-values can I plug in?' For f(x) = x², we can square ANY real number. No restrictions!",
                        visual: "Domain of x² = all real numbers"
                    },
                    {
                        title: "Finding the range",
                        explanation: "Ask: 'What y-values can come out?' When we square any number, the result is always 0 or positive. Can't get negative outputs!",
                        visual: "(-3)² = 9, (0)² = 0, (3)² = 9... all ≥ 0"
                    },
                    {
                        title: "Visualize the parabola",
                        explanation: "f(x) = x² is a U-shaped parabola opening UP with vertex at (0,0). It never goes below the x-axis.",
                        visual: "Parabola: lowest point at y = 0"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>Domain: all real numbers (or ℝ or (-∞, ∞))</strong><br><strong>Range: y ≥ 0 (or [0, ∞))</strong>",
                        visual: "Domain: all reals | Range: y ≥ 0"
                    }
                ],
                finalAnswer: "Domain: all real numbers, Range: y ≥ 0",
                answerExplanation: "Any number can be squared (domain = all reals), but squares are never negative (range = y ≥ 0).",
                example: { problem: `Find the domain and range of f(x) = x²`, steps: [
                    { text: "Domain: What x-values work?", math: "Any real number can be squared" },
                    { text: "Domain answer", math: "<strong>All real numbers</strong>" },
                    { text: "Range: What y-values come out?", math: "Squares are always ≥ 0" },
                    { text: "Range answer", math: "<strong>y ≥ 0</strong>" }
                ]},
                keyPoints: [
                    "Domain = inputs (x), Range = outputs (y)",
                    "Look for restrictions: square roots need ≥ 0 inside, fractions can't have 0 in denominator",
                    "For parabolas: domain is usually all reals, range depends on vertex and direction"
                ],
                mistakes: [
                    { wrong: "Confusing domain and range", why: "Domain = inputs (x-values), Range = outputs (y-values). Don't mix them!" },
                    { wrong: "Range of x² is 'all real numbers'", why: "x² can never output a negative! The range is y ≥ 0." },
                    { wrong: "Domain of √x is all real numbers", why: "Can't take √ of negatives (in reals). Domain of √x is x ≥ 0." }
                ],
                guided: {
                    problem: `Find the domain of f(x) = 1/(x - ${a})`,
                    steps: [
                        { label: "What restriction exists?", value: "Can't divide by zero" },
                        { label: `When does x - ${a} = 0?`, value: `x = ${a}` },
                        { label: "Domain", value: "?" }
                    ],
                    answer: `x ≠ ${a}`,
                    answerLabel: "Domain:",
                    interactiveSteps: [
                        {
                            prompt: "For a fraction like 1/(x-a), what value CAN'T the denominator be?",
                            hint: "Division by this number is undefined...",
                            answer: "0",
                            acceptableAnswers: ["0", "zero"],
                            commonMistakes: {
                                "1": "We can divide by 1. We CAN'T divide by 0!"
                            }
                        },
                        {
                            prompt: `For 1/(x - ${a}), when does the denominator equal 0? Solve: x - ${a} = 0`,
                            hint: `Add ${a} to both sides...`,
                            answer: String(a),
                            acceptableAnswers: [String(a), "x = " + a],
                            commonMistakes: {
                                [String(-a)]: `If x - ${a} = 0, then x = ${a} (add ${a} to both sides)`,
                                "0": `Solve x - ${a} = 0: x = ${a}`
                            }
                        },
                        {
                            prompt: `Since x = ${a} makes the denominator 0, what is the domain?`,
                            hint: "x can be anything EXCEPT...",
                            answer: `x ≠ ${a}`,
                            acceptableAnswers: [`x ≠ ${a}`, `all real numbers except ${a}`, `x not equal to ${a}`],
                            commonMistakes: {
                                "all real numbers": `Not quite! x = ${a} would make the denominator 0. Domain: x ≠ ${a}`,
                                [`x = ${a}`]: `That's the EXCLUDED value. Domain is x ≠ ${a} (all reals except ${a})`
                            }
                        }
                    ]
                },
                practice: { problem: `What is the domain of f(x) = √(x - 3)?`, answer: "x ≥ 3",
                    options: ["x ≥ 3", "x > 3", "x ≤ 3", "all real numbers"],
                    mistakeAnalysis: {
                        "x > 3": "Close! But x = 3 works too: √(3-3) = √0 = 0. So x ≥ 3.",
                        "x ≤ 3": "That would give negative values inside √, which isn't allowed. Need x ≥ 3.",
                        "all real numbers": "Can't take √ of negatives! Need x - 3 ≥ 0, so x ≥ 3."
                    }}
            };
        },
        "Multi-Step Equations": () => {
            const x = rand(2, 6), a = rand(2, 4), b = rand(3, 7), c = rand(2, 5);
            const result = a * x + b - c;
            return {
                goalProblem: `Solve: 2(x + 3) - 4 = 10`,
                teachingSteps: [
                    {
                        title: "Multi-step equations require multiple operations",
                        explanation: "<strong>Multi-step equations</strong> need three or more steps to solve. We'll combine like terms, distribute, and isolate the variable.",
                        visual: "2(x + 3) - 4 = 10"
                    },
                    {
                        title: "Step 1: Distribute",
                        explanation: "Multiply 2 by everything inside the parentheses: 2 × x = 2x and 2 × 3 = 6",
                        visual: "2(x + 3) - 4 = 10 → 2x + 6 - 4 = 10"
                    },
                    {
                        title: "Step 2: Combine like terms",
                        explanation: "Combine the constants on the left: 6 - 4 = 2",
                        visual: "2x + 6 - 4 = 10 → 2x + 2 = 10"
                    },
                    {
                        title: "Step 3: Isolate the variable term",
                        explanation: "Subtract 2 from both sides to get the variable term alone",
                        visual: "2x + 2 - 2 = 10 - 2 → 2x = 8"
                    },
                    {
                        title: "Step 4: Solve for x",
                        explanation: "Divide both sides by 2 to find x",
                        visual: "2x ÷ 2 = 8 ÷ 2 → x = 4"
                    }
                ],
                finalAnswer: "x = 4",
                answerExplanation: "Distribute: 2x + 6 - 4 = 10. Combine: 2x + 2 = 10. Subtract 2: 2x = 8. Divide by 2: x = 4. Check: 2(4+3) - 4 = 14 - 4 = 10 ✓",
                example: { problem: `Solve: 2(x + 3) - 4 = 10`, steps: [
                    { text: "Distribute the 2", math: "2x + 6 - 4 = 10" },
                    { text: "Combine like terms", math: "2x + 2 = 10" },
                    { text: "Subtract 2 from both sides", math: "2x = 8" },
                    { text: "Divide by 2", math: "<strong>x = 4</strong>" }
                ]},
                keyPoints: [
                    "Distribute first, then combine like terms",
                    "Undo addition/subtraction before multiplication/division",
                    "Always check your answer in the original equation"
                ],
                mistakes: [
                    { wrong: "Forgetting to distribute to all terms inside parentheses", why: "2(x + 3) = 2x + 6, not 2x + 3. Multiply BOTH terms!" },
                    { wrong: "Combining unlike terms", why: "Can only combine constants with constants, x-terms with x-terms" },
                    { wrong: "Dividing before combining like terms", why: "Simplify each side first by combining like terms" }
                ],
                guided: {
                    problem: `Solve: ${a}(x + ${b}) - ${c} = ${result}`,
                    steps: [
                        { label: "Distribute", value: `${a}x + ${a*b} - ${c} = ${result}` },
                        { label: "Combine like terms", value: `${a}x + ${a*b - c} = ${result}` },
                        { label: "Isolate variable term", value: `${a}x = ${result - (a*b - c)}` },
                        { label: "Solve for x", value: "?" }
                    ],
                    answer: String(x),
                    answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `Distribute ${a} to both terms in (x + ${b}): ${a}(x + ${b}) = ?`,
                            hint: `${a} × x = ${a}x, and ${a} × ${b} = ?`,
                            answer: `${a}x + ${a*b}`,
                            acceptableAnswers: [`${a}x + ${a*b}`, `${a}x+${a*b}`],
                            commonMistakes: {
                                [`${a}x + ${b}`]: `Distribute to BOTH terms: ${a} × ${b} = ${a*b}`
                            }
                        },
                        {
                            prompt: `Now combine like terms: ${a*b} - ${c} = ?`,
                            hint: "Subtract the constants...",
                            answer: String(a*b - c),
                            acceptableAnswers: [String(a*b - c)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Solve: ${a}x + ${a*b - c} = ${result}. Subtract ${a*b - c} from both sides: ${a}x = ?`,
                            hint: `${result} - ${a*b - c} = ?`,
                            answer: String(result - (a*b - c)),
                            acceptableAnswers: [String(result - (a*b - c))],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Finally, divide: ${result - (a*b - c)} ÷ ${a} = ?`,
                            hint: "Divide to find x...",
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: 3(x - 2) + 5 = 14`, answer: "5",
                    options: ["3", "5", "7", "11"],
                    mistakeAnalysis: {
                        "3": "Check: 3(3-2) + 5 = 3 + 5 = 8, not 14. Try x = 5.",
                        "7": "Check: 3(7-2) + 5 = 15 + 5 = 20, not 14. Try x = 5.",
                        "11": "You may have added wrong. 3(5-2) + 5 = 9 + 5 = 14 ✓"
                    }}
            };
        },
        "Literal Equations": () => {
            return {
                goalProblem: `Solve for h: A = bh`,
                teachingSteps: [
                    {
                        title: "What are literal equations?",
                        explanation: "<strong>Literal equations</strong> have multiple variables. We solve for ONE variable in terms of the others. Common in science and geometry!",
                        visual: "A = bh (solve for h)"
                    },
                    {
                        title: "Treat other variables as numbers",
                        explanation: "Pretend 'b' is just a number like 5. What would you do? You'd divide both sides by it!",
                        visual: "If A = 5h, then h = A/5"
                    },
                    {
                        title: "Apply the same operation",
                        explanation: "Divide both sides by b to isolate h: A ÷ b = bh ÷ b",
                        visual: "A/b = h"
                    },
                    {
                        title: "Write the answer",
                        explanation: "We get <strong>h = A/b</strong>. The variable h is now isolated and expressed in terms of A and b.",
                        visual: "h = A/b"
                    }
                ],
                finalAnswer: "h = A/b",
                answerExplanation: "A = bh → divide both sides by b → h = A/b. We isolated h by treating b as a number.",
                example: { problem: `Solve for h: A = bh`, steps: [
                    { text: "Identify the variable to solve for", math: "Solve for h" },
                    { text: "h is being multiplied by b", math: "A = b × h" },
                    { text: "Undo multiplication by dividing both sides by b", math: "A/b = bh/b" },
                    { text: "Simplify", math: "<strong>h = A/b</strong>" }
                ]},
                keyPoints: [
                    "Treat other variables like constants/numbers",
                    "Use inverse operations to isolate the target variable",
                    "Answer will be in terms of other variables"
                ],
                mistakes: [
                    { wrong: "Dividing by the variable you're solving for", why: "Divide by the coefficient (b), not the variable (h)" },
                    { wrong: "h = Ab (multiplying instead of dividing)", why: "To undo bh, DIVIDE by b: h = A/b" },
                    { wrong: "Leaving answer as A = bh", why: "Must isolate h on one side: h = A/b" }
                ],
                guided: {
                    problem: `Solve for r: C = 2πr`,
                    steps: [
                        { label: "C = 2πr, solve for r", value: "r is multiplied by 2π" },
                        { label: "Divide both sides by 2π", value: "C/(2π) = r" },
                        { label: "Final answer", value: "?" }
                    ],
                    answer: "r = C/(2π)",
                    answerLabel: "r = ?",
                    interactiveSteps: [
                        {
                            prompt: "In C = 2πr, what is r being multiplied by?",
                            hint: "Everything on the right side except r...",
                            answer: "2π",
                            acceptableAnswers: ["2π", "2pi", "2*pi"],
                            commonMistakes: {
                                "C": "C is on the other side. r is multiplied by 2π."
                            }
                        },
                        {
                            prompt: "To isolate r, divide both sides by 2π. What is C divided by 2π?",
                            hint: "Write C divided by 2π...",
                            answer: "C/(2π)",
                            acceptableAnswers: ["C/(2π)", "C/2π", "C/(2pi)", "C/2pi"],
                            commonMistakes: {
                                "2πC": "Divide, don't multiply! C ÷ 2π = C/(2π)"
                            }
                        }
                    ]
                },
                practice: { problem: `Solve for t: d = rt`, answer: "t = d/r",
                    options: ["t = d/r", "t = dr", "t = r/d", "t = d - r"],
                    mistakeAnalysis: {
                        "t = dr": "Divide, not multiply! d = rt → t = d/r",
                        "t = r/d": "Flip it! d/r, not r/d",
                        "t = d - r": "t is multiplied by r, so divide: t = d/r"
                    }}
            };
        },
        "Absolute Value Equations": () => {
            const a = rand(2, 5), result = rand(3, 8);
            const sol1 = result, sol2 = -result;
            return {
                goalProblem: `Solve: |x| = 5`,
                teachingSteps: [
                    {
                        title: "What is absolute value?",
                        explanation: "<strong>Absolute value</strong> measures distance from zero. It's ALWAYS positive or zero. |5| = 5 and |-5| = 5 because both are 5 units from zero!",
                        visual: "|x| = distance from 0"
                    },
                    {
                        title: "Two solutions!",
                        explanation: "If |x| = 5, then x could be 5 (which is 5 away from 0) OR -5 (also 5 away from 0). TWO answers!",
                        visual: "x = 5 OR x = -5"
                    },
                    {
                        title: "The general rule",
                        explanation: "For |x| = a (where a ≥ 0): x = a OR x = -a. Always split into TWO equations!",
                        visual: "|x| = a → x = a or x = -a"
                    },
                    {
                        title: "Check both solutions",
                        explanation: "|5| = 5 ✓ and |-5| = 5 ✓. Both check out! The solution is x = 5 or x = -5.",
                        visual: "x = 5 or x = -5"
                    }
                ],
                finalAnswer: "x = 5 or x = -5",
                answerExplanation: "|x| = 5 means x is 5 units from zero. Both 5 and -5 are 5 units from zero.",
                example: { problem: `Solve: |x| = 5`, steps: [
                    { text: "Absolute value = distance from 0", math: "|x| = 5" },
                    { text: "What numbers are 5 away from 0?", math: "5 and -5" },
                    { text: "Write both solutions", math: "<strong>x = 5 or x = -5</strong>" }
                ]},
                keyPoints: [
                    "Absolute value equations usually have TWO solutions",
                    "|x| = a means x = a OR x = -a",
                    "If |x| = negative number, there's NO solution"
                ],
                mistakes: [
                    { wrong: "Only finding one solution: x = 5", why: "Don't forget the negative! x = 5 OR x = -5" },
                    { wrong: "|x| = -5 has solutions", why: "Absolute value is NEVER negative. No solution!" },
                    { wrong: "x = ±5 written as x = 5", why: "Write BOTH: x = 5 or x = -5" }
                ],
                guided: {
                    problem: `Solve: |x| = ${result}`,
                    steps: [
                        { label: "What numbers are " + result + " units from 0?", value: result + " and -" + result },
                        { label: "Solutions", value: "?" }
                    ],
                    answer: `x = ${result} or x = -${result}`,
                    answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `|x| = ${result}. What positive number is ${result} units from 0?`,
                            hint: "It's just the number itself...",
                            answer: String(result),
                            acceptableAnswers: [String(result)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `What negative number is also ${result} units from 0?`,
                            hint: "The negative version...",
                            answer: String(-result),
                            acceptableAnswers: [String(-result)],
                            commonMistakes: {
                                [String(result)]: `That's the positive. We need -${result}`
                            }
                        },
                        {
                            prompt: `Write both solutions: x = ? or x = ?`,
                            hint: "List both values...",
                            answer: `${result} or -${result}`,
                            acceptableAnswers: [`${result} or -${result}`, `x = ${result} or x = -${result}`, `${result}, -${result}`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: |x + 2| = 7`, answer: "x = 5 or x = -9",
                    options: ["x = 5 or x = -9", "x = 5", "x = 9 or x = -9", "x = 5 or x = -5"],
                    mistakeAnalysis: {
                        "x = 5": "There are TWO solutions! x + 2 = 7 gives x = 5, AND x + 2 = -7 gives x = -9",
                        "x = 9 or x = -9": "Solve x + 2 = 7 → x = 5 (not 9). And x + 2 = -7 → x = -9.",
                        "x = 5 or x = -5": "For the second: x + 2 = -7 → x = -9, not x = -5"
                    }}
            };
        },
        "Graphing Linear Inequalities": () => {
            const m = rand(1, 3), b = rand(-3, 3);
            return {
                goalProblem: `Graph: y > 2x - 1`,
                teachingSteps: [
                    {
                        title: "What is a linear inequality?",
                        explanation: "A <strong>linear inequality</strong> uses <, >, ≤, or ≥ instead of =. The solution is a REGION, not just a line!",
                        visual: "y > 2x - 1 (a region, not a line)"
                    },
                    {
                        title: "Step 1: Graph the boundary line",
                        explanation: "First, graph y = 2x - 1 as if it were an equation. Start at y-intercept (0, -1), then use slope 2 (up 2, right 1).",
                        visual: "y = 2x - 1: b = -1, m = 2"
                    },
                    {
                        title: "Step 2: Solid or dashed line?",
                        explanation: "For < or >: use a DASHED line (boundary NOT included). For ≤ or ≥: use a SOLID line (boundary IS included). Here it's >, so DASHED.",
                        visual: "> or < → dashed | ≥ or ≤ → solid"
                    },
                    {
                        title: "Step 3: Shade the correct region",
                        explanation: "Test point (0, 0): Is 0 > 2(0) - 1? Is 0 > -1? YES! So shade the region containing (0, 0) - ABOVE the line.",
                        visual: "Shade ABOVE for y > (and BELOW for y <)"
                    },
                    {
                        title: "The solution",
                        explanation: "Every point in the shaded region (above the dashed line) satisfies y > 2x - 1.",
                        visual: "Dashed line, shade above"
                    }
                ],
                finalAnswer: "Dashed line at y = 2x - 1, shade above",
                answerExplanation: "Graph y = 2x - 1 with a dashed line (strict inequality), then shade above (y > means y values greater than the line).",
                example: { problem: `Graph: y > 2x - 1`, steps: [
                    { text: "Graph the boundary line", math: "y = 2x - 1 (slope 2, y-int -1)" },
                    { text: "Determine line type", math: "> means DASHED" },
                    { text: "Test (0,0)", math: "0 > -1 ✓ True, so include this region" },
                    { text: "Shade", math: "<strong>Shade ABOVE the dashed line</strong>" }
                ]},
                keyPoints: [
                    "< or > → dashed line (boundary not included)",
                    "≤ or ≥ → solid line (boundary included)",
                    "Test a point to determine which side to shade"
                ],
                mistakes: [
                    { wrong: "Using solid line for >", why: "Strict inequalities (> or <) use DASHED lines!" },
                    { wrong: "Shading below for y >", why: "y > means y values ABOVE the line. Shade above!" },
                    { wrong: "Not testing a point", why: "Always test (0,0) or another easy point to verify shading direction" }
                ],
                guided: {
                    problem: `Graph: y ≤ ${m}x + ${b}`,
                    steps: [
                        { label: "Boundary line", value: `y = ${m}x + ${b}` },
                        { label: "Line type (≤)", value: "?" },
                        { label: "Shade direction", value: "?" }
                    ],
                    answer: "solid line, shade below",
                    answerLabel: "Graph has...",
                    interactiveSteps: [
                        {
                            prompt: "For ≤, should the boundary line be solid or dashed?",
                            hint: "≤ includes the boundary...",
                            answer: "solid",
                            acceptableAnswers: ["solid", "solid line"],
                            commonMistakes: {
                                "dashed": "Dashed is for < or >. For ≤ or ≥, use SOLID (boundary included)."
                            }
                        },
                        {
                            prompt: "For y ≤ ..., should you shade above or below the line?",
                            hint: "y ≤ means y values are less than or equal...",
                            answer: "below",
                            acceptableAnswers: ["below", "below the line", "shade below"],
                            commonMistakes: {
                                "above": "y ≤ means y is LESS than, so shade BELOW the line."
                            }
                        },
                        {
                            prompt: `Test (0, 0): Is 0 ≤ ${m}(0) + ${b}? Is 0 ≤ ${b}?`,
                            hint: `Compare 0 to ${b}...`,
                            answer: b >= 0 ? "yes" : "no",
                            acceptableAnswers: b >= 0 ? ["yes", "true"] : ["no", "false"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `For y < 3x + 2, what type of line and shading?`, answer: "dashed, below",
                    options: ["dashed, below", "solid, below", "dashed, above", "solid, above"],
                    mistakeAnalysis: {
                        "solid, below": "< means NOT equal, so use DASHED line.",
                        "dashed, above": "y < means y is LESS than, so shade BELOW.",
                        "solid, above": "< uses dashed, and shade below for y <."
                    }}
            };
        },
        "Systems by Graphing": () => {
            const x = rand(1, 4), y = rand(1, 4);
            return {
                goalProblem: `Solve by graphing: y = x + 1 and y = -x + 5`,
                teachingSteps: [
                    {
                        title: "What is solving by graphing?",
                        explanation: "When we graph two lines, the <strong>intersection point</strong> is where both equations are true - that's our solution!",
                        visual: "Two lines crossing = solution point"
                    },
                    {
                        title: "Graph the first line: y = x + 1",
                        explanation: "Slope = 1 (up 1, right 1), y-intercept = 1. Plot (0, 1), then go up 1 right 1 to get (1, 2).",
                        visual: "Line 1: m = 1, b = 1"
                    },
                    {
                        title: "Graph the second line: y = -x + 5",
                        explanation: "Slope = -1 (down 1, right 1), y-intercept = 5. Plot (0, 5), then go down 1 right 1 to get (1, 4).",
                        visual: "Line 2: m = -1, b = 5"
                    },
                    {
                        title: "Find the intersection",
                        explanation: "The lines cross at <strong>(2, 3)</strong>. This point satisfies BOTH equations!",
                        visual: "Intersection: (2, 3)"
                    },
                    {
                        title: "Verify the solution",
                        explanation: "Check (2, 3) in both: y = x + 1 → 3 = 2 + 1 ✓ and y = -x + 5 → 3 = -2 + 5 ✓",
                        visual: "x = 2, y = 3"
                    }
                ],
                finalAnswer: "(2, 3)",
                answerExplanation: "Graph both lines and find where they intersect: (2, 3). Verify: 3 = 2+1 ✓ and 3 = -2+5 ✓",
                example: { problem: `Solve by graphing: y = x + 1 and y = -x + 5`, steps: [
                    { text: "Graph line 1", math: "y = x + 1 (slope 1, y-int 1)" },
                    { text: "Graph line 2", math: "y = -x + 5 (slope -1, y-int 5)" },
                    { text: "Find intersection", math: "Lines cross at (2, 3)" },
                    { text: "Verify", math: "<strong>(2, 3)</strong> works in both!" }
                ]},
                keyPoints: [
                    "The intersection point is the solution to the system",
                    "Always verify by substituting into BOTH equations",
                    "Parallel lines have NO solution; same line has infinitely many"
                ],
                mistakes: [
                    { wrong: "Reading the wrong intersection point", why: "Count carefully on the graph. Double-check by substituting." },
                    { wrong: "Only checking one equation", why: "Must work in BOTH equations to be a valid solution." },
                    { wrong: "Confusing slope direction", why: "Positive slope goes up-right; negative goes down-right." }
                ],
                guided: {
                    problem: `Solve by graphing: y = 2x - 1 and y = -x + 5`,
                    steps: [
                        { label: "Line 1: y = 2x - 1", value: "slope 2, y-int -1" },
                        { label: "Line 2: y = -x + 5", value: "slope -1, y-int 5" },
                        { label: "Intersection point", value: "?" }
                    ],
                    answer: "(2, 3)",
                    answerLabel: "Solution: ",
                    interactiveSteps: [
                        {
                            prompt: "For y = 2x - 1, what is the y-intercept?",
                            hint: "The constant term...",
                            answer: "-1",
                            acceptableAnswers: ["-1", "(0, -1)"],
                            commonMistakes: {
                                "2": "That's the slope. y-intercept is -1."
                            }
                        },
                        {
                            prompt: "Set the equations equal: 2x - 1 = -x + 5. Solve for x.",
                            hint: "Add x to both sides, then add 1...",
                            answer: "2",
                            acceptableAnswers: ["2", "x = 2"],
                            commonMistakes: {
                                "4": "2x + x = 3x. 3x = 6, so x = 2."
                            }
                        },
                        {
                            prompt: "Plug x = 2 into y = 2x - 1: y = 2(2) - 1 = ?",
                            hint: "4 - 1 = ?",
                            answer: "3",
                            acceptableAnswers: ["3", "y = 3"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "What is the solution (intersection point)?",
                            hint: "Write as (x, y)...",
                            answer: "(2, 3)",
                            acceptableAnswers: ["(2, 3)", "(2,3)", "2, 3"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve by graphing: y = x + 2 and y = 3x`, answer: "(1, 3)",
                    options: ["(1, 3)", "(2, 4)", "(3, 1)", "(0, 2)"],
                    mistakeAnalysis: {
                        "(2, 4)": "Check: y = x + 2 → 4 = 2 + 2 ✓, but y = 3x → 4 ≠ 6. Try (1, 3).",
                        "(3, 1)": "Check: y = x + 2 → 1 ≠ 5. Not correct. Answer: (1, 3)",
                        "(0, 2)": "Check: y = 3x → 2 ≠ 0. Not correct. Answer: (1, 3)"
                    }}
            };
        },
        "Systems by Substitution": () => {
            const x = rand(2, 5), y = rand(1, 4);
            const sum = x + y, diff = x - y;
            return {
                goalProblem: `Solve: y = 2x - 1 and 3x + y = 9`,
                teachingSteps: [
                    {
                        title: "What is the substitution method?",
                        explanation: "<strong>Substitution</strong> means replacing a variable with an equivalent expression. If y = 2x - 1, we can put '2x - 1' wherever we see 'y'!",
                        visual: "y = 2x - 1 → substitute for y"
                    },
                    {
                        title: "Substitute into the second equation",
                        explanation: "Replace y in '3x + y = 9' with '2x - 1': 3x + (2x - 1) = 9",
                        visual: "3x + (2x - 1) = 9"
                    },
                    {
                        title: "Solve for x",
                        explanation: "Combine like terms: 5x - 1 = 9. Add 1: 5x = 10. Divide by 5: <strong>x = 2</strong>",
                        visual: "5x - 1 = 9 → 5x = 10 → x = 2"
                    },
                    {
                        title: "Find y using the first equation",
                        explanation: "Substitute x = 2 back into y = 2x - 1: y = 2(2) - 1 = 4 - 1 = <strong>3</strong>",
                        visual: "y = 2(2) - 1 = 3"
                    },
                    {
                        title: "Verify in both equations",
                        explanation: "Check: y = 2x - 1 → 3 = 2(2) - 1 ✓ and 3x + y = 9 → 6 + 3 = 9 ✓. Solution: (2, 3)",
                        visual: "(2, 3) ✓"
                    }
                ],
                finalAnswer: "x = 2, y = 3 or (2, 3)",
                answerExplanation: "Substitute y = 2x-1 into 3x + y = 9: 5x - 1 = 9, so x = 2. Then y = 2(2) - 1 = 3.",
                example: { problem: `Solve: y = 2x - 1 and 3x + y = 9`, steps: [
                    { text: "Substitute y = 2x - 1 into equation 2", math: "3x + (2x - 1) = 9" },
                    { text: "Combine like terms", math: "5x - 1 = 9" },
                    { text: "Solve for x", math: "5x = 10, x = 2" },
                    { text: "Find y", math: "y = 2(2) - 1 = 3" },
                    { text: "Solution", math: "<strong>(2, 3)</strong>" }
                ]},
                keyPoints: [
                    "Use substitution when one variable is already isolated",
                    "Replace the variable with its equivalent expression",
                    "Always verify in BOTH original equations"
                ],
                mistakes: [
                    { wrong: "Forgetting parentheses when substituting", why: "3x + 2x - 1 is wrong! Use 3x + (2x - 1) = 9" },
                    { wrong: "Only finding x and forgetting y", why: "You need BOTH values for the complete solution" },
                    { wrong: "Substituting into the same equation", why: "Substitute into the OTHER equation to eliminate a variable" }
                ],
                guided: {
                    problem: `Solve: y = x + ${diff} and x + y = ${sum + diff}`,
                    steps: [
                        { label: "Substitute y = x + " + diff + " into x + y", value: `x + (x + ${diff}) = ${sum + diff}` },
                        { label: "Simplify", value: `2x + ${diff} = ${sum + diff}` },
                        { label: "Solve for x, then y", value: "?" }
                    ],
                    answer: `(${x}, ${x + diff})`,
                    answerLabel: "Solution: ",
                    interactiveSteps: [
                        {
                            prompt: `Substitute y = x + ${diff} into x + y = ${sum + diff}: x + (x + ${diff}) = ${sum + diff}. Combine like terms: ? = ${sum + diff}`,
                            hint: "x + x = 2x...",
                            answer: `2x + ${diff}`,
                            acceptableAnswers: [`2x + ${diff}`, `2x+${diff}`],
                            commonMistakes: {}
                        },
                        {
                            prompt: `2x + ${diff} = ${sum + diff}. Subtract ${diff}: 2x = ?`,
                            hint: `${sum + diff} - ${diff} = ?`,
                            answer: String(sum),
                            acceptableAnswers: [String(sum)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `2x = ${sum}. Divide by 2: x = ?`,
                            hint: `${sum} ÷ 2 = ?`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now find y: y = ${x} + ${diff} = ?`,
                            hint: "Add...",
                            answer: String(x + diff),
                            acceptableAnswers: [String(x + diff)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: x = y + 3 and 2x + y = 12`, answer: "(5, 2)",
                    options: ["(5, 2)", "(3, 6)", "(6, 0)", "(4, 4)"],
                    mistakeAnalysis: {
                        "(3, 6)": "Check: x = y + 3 → 3 = 6 + 3? No. Answer: (5, 2)",
                        "(6, 0)": "Check: x = y + 3 → 6 = 0 + 3? No. Answer: (5, 2)",
                        "(4, 4)": "Check: x = y + 3 → 4 = 4 + 3? No. Answer: (5, 2)"
                    }}
            };
        },
        "Systems by Elimination": () => {
            const x = rand(2, 5), y = rand(1, 4);
            return {
                goalProblem: `Solve: 2x + y = 7 and x - y = 2`,
                teachingSteps: [
                    {
                        title: "What is the elimination method?",
                        explanation: "<strong>Elimination</strong> adds or subtracts equations to eliminate one variable. Look for coefficients that are opposites or the same!",
                        visual: "+y and -y are opposites → they eliminate!"
                    },
                    {
                        title: "Add the equations",
                        explanation: "Adding: (2x + y) + (x - y) = 7 + 2. The y terms cancel: 2x + y + x - y = 9 → 3x = 9",
                        visual: "2x + y = 7\n+ x - y = 2\n---------\n3x = 9"
                    },
                    {
                        title: "Solve for x",
                        explanation: "3x = 9, so divide by 3: <strong>x = 3</strong>",
                        visual: "3x = 9 → x = 3"
                    },
                    {
                        title: "Substitute to find y",
                        explanation: "Put x = 3 into either equation. Using x - y = 2: 3 - y = 2, so -y = -1, thus <strong>y = 1</strong>",
                        visual: "3 - y = 2 → y = 1"
                    },
                    {
                        title: "Verify the solution",
                        explanation: "Check in both: 2(3) + 1 = 7 ✓ and 3 - 1 = 2 ✓. Solution: (3, 1)",
                        visual: "(3, 1) ✓"
                    }
                ],
                finalAnswer: "x = 3, y = 1 or (3, 1)",
                answerExplanation: "Adding the equations eliminates y: 3x = 9, so x = 3. Then 3 - y = 2 gives y = 1.",
                example: { problem: `Solve: 2x + y = 7 and x - y = 2`, steps: [
                    { text: "Notice y and -y are opposites", math: "Add equations to eliminate y" },
                    { text: "Add: (2x + y) + (x - y)", math: "3x = 9" },
                    { text: "Solve for x", math: "x = 3" },
                    { text: "Substitute into x - y = 2", math: "3 - y = 2, so y = 1" },
                    { text: "Solution", math: "<strong>(3, 1)</strong>" }
                ]},
                keyPoints: [
                    "Add equations when coefficients are opposites (+y and -y)",
                    "Subtract equations when coefficients are the same",
                    "May need to multiply one equation to create opposite coefficients"
                ],
                mistakes: [
                    { wrong: "Adding when you should subtract", why: "If both have +y, SUBTRACT to eliminate. If one has +y and other has -y, ADD." },
                    { wrong: "Forgetting to add/subtract the right sides too", why: "7 + 2 = 9 on the right side!" },
                    { wrong: "Sign errors when combining", why: "+y + (-y) = 0, not 2y. Be careful with signs!" }
                ],
                guided: {
                    problem: `Solve: x + y = ${x + y} and x - y = ${x - y}`,
                    steps: [
                        { label: "Add the equations", value: `2x = ${2*x}` },
                        { label: "Solve for x", value: `x = ${x}` },
                        { label: "Find y", value: "?" }
                    ],
                    answer: `(${x}, ${y})`,
                    answerLabel: "Solution: ",
                    interactiveSteps: [
                        {
                            prompt: `Add the equations: (x + y) + (x - y) = ${x+y} + ${x-y}. The y terms cancel! What's left?`,
                            hint: "x + x = 2x, and y + (-y) = 0...",
                            answer: `2x = ${2*x}`,
                            acceptableAnswers: [`2x = ${2*x}`, `2x=${2*x}`],
                            commonMistakes: {
                                [`2x + 2y = ${2*(x+y)}`]: "y + (-y) = 0, so y is eliminated! Just 2x = " + (2*x)
                            }
                        },
                        {
                            prompt: `2x = ${2*x}. Divide by 2: x = ?`,
                            hint: `${2*x} ÷ 2 = ?`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Substitute x = ${x} into x + y = ${x+y}: ${x} + y = ${x+y}. Solve for y.`,
                            hint: `y = ${x+y} - ${x} = ?`,
                            answer: String(y),
                            acceptableAnswers: [String(y)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `What is the solution as a point (x, y)?`,
                            hint: "Write as (x, y)...",
                            answer: `(${x}, ${y})`,
                            acceptableAnswers: [`(${x}, ${y})`, `(${x},${y})`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: 3x + 2y = 11 and 3x - 2y = 1`, answer: "(2, 2.5)",
                    options: ["(2, 2.5)", "(3, 1)", "(1, 4)", "(4, -0.5)"],
                    mistakeAnalysis: {
                        "(3, 1)": "Check: 3(3) + 2(1) = 11 ✓, but 3(3) - 2(1) = 7 ≠ 1. Answer: (2, 2.5)",
                        "(1, 4)": "Check: 3(1) + 2(4) = 11 ✓, but 3(1) - 2(4) = -5 ≠ 1. Answer: (2, 2.5)",
                        "(4, -0.5)": "Check: 3(4) + 2(-0.5) = 11 ✓, but 3(4) - 2(-0.5) = 13 ≠ 1. Answer: (2, 2.5)"
                    }}
            };
        },
        "Correlation and Trend Lines": () => {
            return {
                goalProblem: `A scatter plot shows: as study hours increase, test scores increase. What type of correlation?`,
                teachingSteps: [
                    {
                        title: "What is correlation?",
                        explanation: "<strong>Correlation</strong> describes the relationship between two variables. Do they move together, opposite, or randomly?",
                        visual: "Correlation = relationship between variables"
                    },
                    {
                        title: "Types of correlation",
                        explanation: "• <strong>Positive:</strong> both increase together (↗)<br>• <strong>Negative:</strong> one increases, other decreases (↘)<br>• <strong>None:</strong> no pattern",
                        visual: "Positive ↗ | Negative ↘ | None ?"
                    },
                    {
                        title: "Analyze the data",
                        explanation: "Study hours ↑ and test scores ↑ = they increase TOGETHER. This is <strong>positive correlation</strong>!",
                        visual: "Both ↑ = Positive correlation"
                    },
                    {
                        title: "Trend lines",
                        explanation: "A <strong>trend line</strong> (line of best fit) shows the general direction. For positive correlation, it slopes upward left to right.",
                        visual: "Trend line: shows the pattern"
                    }
                ],
                finalAnswer: "Positive correlation",
                answerExplanation: "When both variables increase together, it's positive correlation. More study hours → higher scores shows a positive relationship.",
                example: { problem: `Study hours vs test scores: both increase`, steps: [
                    { text: "Identify what happens to each variable", math: "Study hours ↑, Scores ↑" },
                    { text: "Both increase together", math: "Same direction = positive" },
                    { text: "Answer", math: "<strong>Positive correlation</strong>" }
                ]},
                keyPoints: [
                    "Positive: both increase OR both decrease together",
                    "Negative: one up, one down (opposite directions)",
                    "Trend line summarizes the pattern; its slope shows correlation type"
                ],
                mistakes: [
                    { wrong: "Confusing positive/negative based on good/bad", why: "Positive/negative refers to DIRECTION, not whether it's good or bad!" },
                    { wrong: "Thinking 'no pattern' means negative", why: "No pattern = no correlation. Negative means they move in OPPOSITE directions." },
                    { wrong: "Reading trend line direction wrong", why: "Upward slope (/) = positive. Downward slope (\\) = negative." }
                ],
                guided: {
                    problem: `A scatter plot shows: as temperature increases, hot chocolate sales decrease. What type of correlation?`,
                    steps: [
                        { label: "Temperature direction", value: "increases ↑" },
                        { label: "Sales direction", value: "decreases ↓" },
                        { label: "Correlation type", value: "?" }
                    ],
                    answer: "negative",
                    answerLabel: "Correlation: ",
                    interactiveSteps: [
                        {
                            prompt: "As temperature increases (↑), sales decrease (↓). Are they moving in the same or opposite directions?",
                            hint: "One goes up, one goes down...",
                            answer: "opposite",
                            acceptableAnswers: ["opposite", "opposite directions", "different"],
                            commonMistakes: {
                                "same": "Temperature ↑ but sales ↓ - that's OPPOSITE directions!"
                            }
                        },
                        {
                            prompt: "When variables move in opposite directions, is the correlation positive or negative?",
                            hint: "Think: opposite = ...",
                            answer: "negative",
                            acceptableAnswers: ["negative", "negative correlation"],
                            commonMistakes: {
                                "positive": "Positive is when both go the SAME direction. Opposite = negative."
                            }
                        },
                        {
                            prompt: "Would the trend line slope upward or downward?",
                            hint: "Negative correlation means...",
                            answer: "downward",
                            acceptableAnswers: ["downward", "down", "slopes down"],
                            commonMistakes: {
                                "upward": "Negative correlation = downward slope (\\)"
                            }
                        }
                    ]
                },
                practice: { problem: `Shoe size vs IQ shows no clear pattern. What type of correlation?`, answer: "no correlation",
                    options: ["no correlation", "positive correlation", "negative correlation", "strong correlation"],
                    mistakeAnalysis: {
                        "positive correlation": "Positive would show both increasing together. No pattern = no correlation.",
                        "negative correlation": "Negative would show opposite movement. No pattern = no correlation.",
                        "strong correlation": "Strong could be + or -. No PATTERN means NO correlation."
                    }}
            };
        }
    },
    6: {
        Area: () => {
            const l = rand(4, 10), w = rand(3, 8);
            const area = l * w;
            return {
                goalProblem: `Find the area of a rectangle with length 8 ft and width 5 ft`,
                teachingSteps: [
                    {
                        title: "What is Area?",
                        explanation: "<strong>Area</strong> measures how much <strong>space is inside</strong> a flat (2D) shape.<br><br>Think of it like: <em>\"How many square tiles would fit inside this shape?\"</em>",
                        visual: "📐 Area = Inside space of a shape"
                    },
                    {
                        title: "Common Area Formulas",
                        explanation: "Different shapes have different formulas:<br><br>• <strong>Rectangle:</strong> A = length × width<br>• <strong>Square:</strong> A = side × side = s²<br>• <strong>Triangle:</strong> A = ½ × base × height<br>• <strong>Circle:</strong> A = π × radius²",
                        visual: "Rectangle: l × w | Square: s² | Triangle: ½bh | Circle: πr²"
                    },
                    {
                        title: "Step 1: Identify the Shape and Formula",
                        explanation: "We have a <strong>rectangle</strong>, so we use:<br><br><strong>Area = length × width</strong>",
                        visual: "Rectangle → A = l × w"
                    },
                    {
                        title: "Step 2: Plug in the Numbers",
                        explanation: "Our length is <strong>8 ft</strong> and width is <strong>5 ft</strong>:<br><br>A = 8 × 5",
                        visual: "A = 8 ft × 5 ft"
                    },
                    {
                        title: "Step 3: Calculate and Add Units",
                        explanation: "Multiply: 8 × 5 = <strong>40</strong><br><br>Area is always in <strong>SQUARE units</strong> (because we're measuring 2D space):<br><br><strong>A = 40 ft²</strong>",
                        visual: "8 × 5 = 40 → 40 ft² (square feet)"
                    }
                ],
                finalAnswer: "40 ft²",
                answerExplanation: "We multiplied length × width (8 × 5 = 40) and used square units because area measures 2D space.",
                example: { problem: `Find the area of a rectangle with length 8 ft and width 5 ft`, steps: [
                    { text: "Identify the formula", math: "Area = length × width" },
                    { text: "Substitute the values", math: "A = 8 × 5" },
                    { text: "Calculate", math: "A = 40" },
                    { text: "Add square units", math: "<strong>A = 40 ft²</strong>" }
                ]},
                keyPoints: [
                    "Area = space INSIDE a shape",
                    "Always use SQUARE units (ft², in², cm²)",
                    "For triangles, don't forget the ½!"
                ],
                mistakes: [
                    { wrong: "Confusing area and perimeter", why: "Area = inside space (square units). Perimeter = distance around (regular units)." },
                    { wrong: "Forgetting ½ for triangles", why: "Triangle area = ½ × base × height. The ½ is essential!" },
                    { wrong: "Using diameter instead of radius for circles", why: "A = πr², where r is RADIUS (half the diameter)." }
                ],
                guided: {
                    problem: `Find the area of a rectangle: length = ${l} cm, width = ${w} cm`,
                    steps: [
                        { label: "Formula", value: "A = l × w" },
                        { label: "Substitute", value: `A = ${l} × ${w}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(area),
                    answerLabel: "Area in cm²:",
                    interactiveSteps: [
                        {
                            prompt: "What formula do we use for the area of a rectangle?",
                            hint: "Area equals what times what?",
                            answer: "l × w",
                            acceptableAnswers: ["l × w", "l*w", "lxw", "length × width", "length * width", "length x width", "l x w", "A = l × w", "A=l×w"],
                            commonMistakes: {
                                "l + w": "That's for perimeter! Area uses multiplication (×), not addition (+).",
                                "2l + 2w": "That's the perimeter formula. For area, we multiply length × width.",
                                "l × w × h": "That's for volume (3D). Area only needs length × width (2D)."
                            }
                        },
                        {
                            prompt: `Now plug in the numbers: ${l} × ${w} = ?`,
                            hint: `Multiply ${l} times ${w}`,
                            answer: String(area),
                            acceptableAnswers: [String(area), `${area} cm²`, `${area}cm²`],
                            commonMistakes: {
                                [String(l + w)]: `You added instead of multiplied! ${l} × ${w} = ${area}, not ${l} + ${w} = ${l + w}`,
                                [String(l * w * 2)]: "You multiplied by 2 - that's not needed for area. Just multiply length × width.",
                                [String(2 * l + 2 * w)]: "That's the perimeter! For area, just multiply: length × width."
                            }
                        }
                    ]
                },
                practice: { problem: `A triangle has base 10 in and height 6 in. What is its area?`, answer: "30",
                    options: ["30", "60", "16", "32"],
                    mistakeAnalysis: {
                        "60": "You forgot the ½! Triangle area = ½ × 10 × 6 = 30 in²",
                        "16": "That's 10 + 6 (perimeter pieces). Area = ½ × base × height = 30",
                        "32": "Check your calculation: ½ × 10 × 6 = 5 × 6 = 30"
                    }}
            };
        },
        Volume: () => {
            const l = rand(3, 7), w = rand(2, 5), h = rand(2, 6);
            const vol = l * w * h;
            return {
                goalProblem: `Find the volume of a box: 4 cm × 3 cm × 5 cm`,
                teachingSteps: [
                    {
                        title: "What is Volume?",
                        explanation: "<strong>Volume</strong> measures how much <strong>space is inside</strong> a 3D (three-dimensional) shape.<br><br>Think of it like: <em>\"How many little cubes would fit inside this shape?\"</em>",
                        visual: "📦 Volume = Space inside a 3D shape"
                    },
                    {
                        title: "Area vs. Volume",
                        explanation: "<strong>Area</strong> is 2D (flat): length × width → square units (cm²)<br><br><strong>Volume</strong> is 3D (solid): length × width × height → cubic units (cm³)<br><br>Volume adds that third dimension!",
                        visual: "2D: □ → cm² | 3D: 📦 → cm³"
                    },
                    {
                        title: "Common Volume Formulas",
                        explanation: "• <strong>Box (rectangular prism):</strong> V = l × w × h<br>• <strong>Cube:</strong> V = s³ (side × side × side)<br>• <strong>Cylinder:</strong> V = πr²h<br>• <strong>Sphere:</strong> V = (4/3)πr³",
                        visual: "Box: lwh | Cube: s³ | Cylinder: πr²h | Sphere: (4/3)πr³"
                    },
                    {
                        title: "Step 1: Identify the Formula",
                        explanation: "We have a <strong>box (rectangular prism)</strong>, so we use:<br><br><strong>Volume = length × width × height</strong>",
                        visual: "Box → V = l × w × h"
                    },
                    {
                        title: "Step 2: Plug in the Numbers",
                        explanation: "Our dimensions are: length = <strong>4 cm</strong>, width = <strong>3 cm</strong>, height = <strong>5 cm</strong><br><br>V = 4 × 3 × 5",
                        visual: "V = 4 cm × 3 cm × 5 cm"
                    },
                    {
                        title: "Step 3: Calculate Step by Step",
                        explanation: "Work left to right:<br><br>First: 4 × 3 = <strong>12</strong><br>Then: 12 × 5 = <strong>60</strong><br><br>Volume = 60, and we use <strong>CUBIC units</strong>: <strong>60 cm³</strong>",
                        visual: "4 × 3 = 12 → 12 × 5 = 60 → 60 cm³"
                    }
                ],
                finalAnswer: "60 cm³",
                answerExplanation: "We multiplied all three dimensions (4 × 3 × 5 = 60) and used cubic units because volume measures 3D space.",
                example: { problem: `Find the volume of a box: 4 cm × 3 cm × 5 cm`, steps: [
                    { text: "Identify the formula", math: "Volume = l × w × h" },
                    { text: "Substitute the values", math: "V = 4 × 3 × 5" },
                    { text: "Calculate step by step", math: "V = 12 × 5 = 60" },
                    { text: "Add cubic units", math: "<strong>V = 60 cm³</strong>" }
                ]},
                keyPoints: [
                    "Volume = space INSIDE a 3D shape",
                    "Always use CUBIC units (ft³, in³, cm³)",
                    "Think: how many unit cubes fit inside?"
                ],
                mistakes: [
                    { wrong: "Using square units instead of cubic", why: "Volume needs CUBIC units because it's 3D (length × width × height)" },
                    { wrong: "Finding area instead of volume", why: "Area is 2D (l × w). Volume is 3D (l × w × h)." },
                    { wrong: "Forgetting to cube the radius for spheres", why: "Sphere volume = (4/3)πr³, not (4/3)πr" }
                ],
                guided: {
                    problem: `Find the volume of a box: ${l} × ${w} × ${h} inches`,
                    steps: [
                        { label: "Formula", value: "V = l × w × h" },
                        { label: "Substitute", value: `V = ${l} × ${w} × ${h}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(vol),
                    answerLabel: "Volume in in³:",
                    interactiveSteps: [
                        {
                            prompt: "What formula do we use for the volume of a rectangular box?",
                            hint: "Volume equals length times width times... what?",
                            answer: "l × w × h",
                            acceptableAnswers: ["l × w × h", "l*w*h", "lwh", "l x w x h", "length × width × height", "V = l × w × h", "V=lwh"],
                            commonMistakes: {
                                "l × w": "That's the formula for AREA (2D). Volume needs all THREE dimensions: l × w × h",
                                "l + w + h": "That's adding the dimensions. Volume MULTIPLIES them: l × w × h",
                                "2(l + w + h)": "That's related to perimeter/surface area. Volume = l × w × h"
                            }
                        },
                        {
                            prompt: `First, multiply the first two dimensions: ${l} × ${w} = ?`,
                            hint: `What's ${l} times ${w}?`,
                            answer: String(l * w),
                            acceptableAnswers: [String(l * w)],
                            commonMistakes: {
                                [String(l + w)]: `You added instead of multiplied! ${l} × ${w} = ${l * w}`,
                                [String(l * w * h)]: `That's the final answer! We're just doing the first step: ${l} × ${w} = ${l * w}`
                            }
                        },
                        {
                            prompt: `Now multiply that result by the height: ${l * w} × ${h} = ?`,
                            hint: `What's ${l * w} times ${h}?`,
                            answer: String(vol),
                            acceptableAnswers: [String(vol), `${vol} in³`, `${vol}in³`, `${vol} cubic inches`],
                            commonMistakes: {
                                [String(l * w + h)]: `You added the height instead of multiplying! ${l * w} × ${h} = ${vol}`,
                                [String(l * w)]: `Don't forget to multiply by the height! ${l * w} × ${h} = ${vol}`
                            }
                        }
                    ]
                },
                practice: { problem: `A cube has sides of 4 cm. What is its volume?`, answer: "64",
                    options: ["12", "16", "64", "256"],
                    mistakeAnalysis: {
                        "12": "That's 4 + 4 + 4 (adding). Volume of cube = 4 × 4 × 4 = 64",
                        "16": "That's 4 × 4 (area of one face). Volume = 4 × 4 × 4 = 64",
                        "256": "That's 4⁴, but cube volume is s³ = 4³ = 64"
                    }}
            };
        },
        Triangles: () => {
            const a = rand(30, 60), b = rand(40, 70);
            const c = 180 - a - b;
            return {
                goalProblem: `A triangle has angles 50° and 70°. Find the third angle.`,
                teachingSteps: [
                    {
                        title: "The Most Important Triangle Rule",
                        explanation: "The <strong>most important fact</strong> about triangles:<br><br>📐 <strong>All three angles ALWAYS add up to 180°</strong><br><br>This works for EVERY triangle, no matter what shape!",
                        visual: "Angle 1 + Angle 2 + Angle 3 = 180° (always!)"
                    },
                    {
                        title: "Types of Triangles by Angles",
                        explanation: "• <strong>Acute:</strong> All angles less than 90°<br>• <strong>Right:</strong> One angle equals exactly 90°<br>• <strong>Obtuse:</strong> One angle greater than 90°",
                        visual: "Acute: all < 90° | Right: one = 90° | Obtuse: one > 90°"
                    },
                    {
                        title: "Types of Triangles by Sides",
                        explanation: "• <strong>Equilateral:</strong> All 3 sides equal → all angles are 60°<br>• <strong>Isosceles:</strong> 2 sides equal → 2 angles equal<br>• <strong>Scalene:</strong> No sides equal → no angles equal",
                        visual: "Equilateral: 60°-60°-60° | Isosceles: 2 equal | Scalene: all different"
                    },
                    {
                        title: "Step 1: What Do We Know?",
                        explanation: "We're given two angles: <strong>50°</strong> and <strong>70°</strong><br><br>We need to find the third angle using our rule.",
                        visual: "Known: 50° and 70° | Unknown: third angle"
                    },
                    {
                        title: "Step 2: Add the Known Angles",
                        explanation: "First, add the two angles we know:<br><br><strong>50° + 70° = 120°</strong><br><br>So the two known angles use up 120° of our 180° total.",
                        visual: "50° + 70° = 120°"
                    },
                    {
                        title: "Step 3: Subtract from 180°",
                        explanation: "The third angle is whatever's left to reach 180°:<br><br><strong>180° - 120° = 60°</strong><br><br>The third angle is <strong>60°</strong>!",
                        visual: "180° - 120° = 60°"
                    }
                ],
                finalAnswer: "60°",
                answerExplanation: "We added the two known angles (50° + 70° = 120°), then subtracted from 180° to find the third angle (180° - 120° = 60°).",
                example: { problem: `Triangle has angles 50° and 70°. Find the third angle.`, steps: [
                    { text: "Use the angle sum property", math: "All angles sum to 180°" },
                    { text: "Add known angles", math: "50° + 70° = 120°" },
                    { text: "Subtract from 180°", math: "180° - 120° = 60°" },
                    { text: "The third angle is", math: "<strong>60°</strong>" }
                ]},
                keyPoints: [
                    "Triangle angle sum = 180° (always!)",
                    "Third angle = 180° - (first angle + second angle)",
                    "Equilateral triangles have all 60° angles"
                ],
                mistakes: [
                    { wrong: "Forgetting that angles sum to 180°", why: "This is the fundamental triangle property: a + b + c = 180°" },
                    { wrong: "Thinking angles sum to 360°", why: "360° is for quadrilaterals. Triangles = 180°." }
                ],
                guided: {
                    problem: `A triangle has angles ${a}° and ${b}°. Find the third angle.`,
                    steps: [
                        { label: "Sum of first two angles", value: `${a}° + ${b}° = ${a + b}°` },
                        { label: "Third angle = 180° - sum", value: `180° - ${a + b}° = ?` }
                    ],
                    answer: String(c),
                    answerLabel: "Third angle:",
                    interactiveSteps: [
                        {
                            prompt: "What do all angles in a triangle add up to?",
                            hint: "This is the fundamental triangle rule...",
                            answer: "180",
                            acceptableAnswers: ["180", "180°", "180 degrees"],
                            commonMistakes: {
                                "360": "360° is for quadrilaterals (4 sides). Triangles only have 180°!",
                                "90": "90° is a right angle. All THREE angles together = 180°.",
                                "100": "Not quite. The sum of all angles in a triangle is always 180°."
                            }
                        },
                        {
                            prompt: `Add the two known angles: ${a}° + ${b}° = ?`,
                            hint: `Add ${a} and ${b} together`,
                            answer: String(a + b),
                            acceptableAnswers: [String(a + b), `${a + b}°`],
                            commonMistakes: {
                                [String(a * b)]: `You multiplied! We need to ADD: ${a} + ${b} = ${a + b}`,
                                [String(Math.abs(a - b))]: `You subtracted. We need to ADD the angles: ${a} + ${b} = ${a + b}`
                            }
                        },
                        {
                            prompt: `Now subtract from 180°: 180° - ${a + b}° = ?`,
                            hint: `What's left when you subtract ${a + b} from 180?`,
                            answer: String(c),
                            acceptableAnswers: [String(c), `${c}°`],
                            commonMistakes: {
                                [String(180 + (a + b))]: "You added instead of subtracted! 180 - sum, not 180 + sum.",
                                [String(a + b)]: `That's the sum of the two angles. We need 180 - ${a + b} = ${c}`
                            }
                        }
                    ]
                },
                practice: { problem: `One angle of an isosceles triangle is 40°. If this is one of the equal angles, what are the other angles?`, answer: "40° and 100°",
                    options: ["40° and 100°", "70° and 70°", "40° and 40°", "60° and 80°"],
                    mistakeAnalysis: {
                        "70° and 70°": "If 40° is one of the equal angles, the other equal angle is also 40°. Third = 180° - 80° = 100°",
                        "40° and 40°": "That would give 120° total. The third angle = 180° - 80° = 100°",
                        "60° and 80°": "In isosceles, two angles are equal. If one equal angle is 40°, so is the other."
                    }}
            };
        },
        Circles: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Area of a Circle (πr²)
                (() => {
                    const r = rand(3, 8);
                    const area = r * r;
                    // Practice values
                    const pr = rand(2, 6);
                    const parea = pr * pr;
                    return {
                        id: "area",
                        name: "Circle Area (πr²)",
                        goalProblem: `Find the area of a circle with radius 4 in terms of π`,
                        teachingSteps: [
                            {
                                title: "Circle Vocabulary",
                                explanation: "Key parts of a circle:<br><br>• <strong>Radius (r):</strong> Distance from <em>center</em> to the <em>edge</em><br>• <strong>Diameter (d):</strong> Distance <em>across</em> the circle through the center<br><br><strong>Diameter = 2 × Radius</strong>",
                                visual: "r = center to edge | d = across = 2r"
                            },
                            {
                                title: "What is Area?",
                                explanation: "<strong>Area</strong> measures the <strong>space INSIDE</strong> the circle.<br><br>Think: How many square units fit inside?",
                                visual: "📐 Area = inside space"
                            },
                            {
                                title: "The Area Formula",
                                explanation: "<strong>A = πr²</strong><br><br>This means: π times (radius squared)<br><br>Remember: Square the radius FIRST, then multiply by π!",
                                visual: "A = π × r × r = πr²"
                            },
                            {
                                title: "Step 1: Identify the Radius",
                                explanation: "Our circle has radius = <strong>4</strong>",
                                visual: "r = 4"
                            },
                            {
                                title: "Step 2: Square the Radius",
                                explanation: "r² = 4² = 4 × 4 = <strong>16</strong>",
                                visual: "4² = 16"
                            },
                            {
                                title: "Step 3: Multiply by π",
                                explanation: "A = π × 16 = <strong>16π</strong><br><br>When asked for \"in terms of π\", leave π in the answer!",
                                visual: "A = 16π"
                            }
                        ],
                        finalAnswer: "16π",
                        answerExplanation: "Area = πr² = π(4)² = π(16) = 16π",
                        example: { problem: `Circle with radius 4. Find area in terms of π.`, steps: [
                            { text: "Write the formula", math: "A = πr²" },
                            { text: "Square the radius", math: "r² = 4² = 16" },
                            { text: "Write the answer", math: "A = 16π" }
                        ]},
                        keyPoints: [
                            "Area = πr² (square the radius, then multiply by π)",
                            "Always square the radius FIRST, not π × r × r separately",
                            "'In terms of π' means leave π in your answer (like 16π)"
                        ],
                        mistakes: [
                            { wrong: "Using 2πr instead of πr²", why: "2πr is for CIRCUMFERENCE (around). Area uses πr² (inside)." },
                            { wrong: "Forgetting to square the radius", why: "A = πr² means r×r. If r=4, that's 4×4=16, not just 4." },
                            { wrong: "Squaring both π and r", why: "Only the radius gets squared! A = π × r², not π² × r²" }
                        ],
                        guided: {
                            problem: `Find the area of a circle with radius ${r} in terms of π`,
                            steps: [
                                { label: "Formula", value: "A = πr²" },
                                { label: "Radius", value: `r = ${r}` },
                                { label: "r² =", value: `${r}² = ?` }
                            ],
                            answer: `${area}π`,
                            answerLabel: "Area:",
                            interactiveSteps: [
                                {
                                    prompt: "What formula do we use for the area of a circle?",
                                    hint: "It involves π and the radius squared...",
                                    answer: "πr²",
                                    acceptableAnswers: ["πr²", "A = πr²", "pi r squared", "pi*r^2", "πr^2", "A=πr²"],
                                    commonMistakes: {
                                        "2πr": "That's CIRCUMFERENCE (distance around). Area = πr²",
                                        "πr": "Close, but the radius must be SQUARED: πr²",
                                        "πd": "πd is another circumference formula. Area = πr²"
                                    }
                                },
                                {
                                    prompt: `Square the radius: ${r}² = ?`,
                                    hint: `What is ${r} × ${r}?`,
                                    answer: String(area),
                                    acceptableAnswers: [String(area)],
                                    commonMistakes: {
                                        [String(r * 2)]: `That's ${r} × 2, not ${r}². Squaring means ${r} × ${r} = ${area}`,
                                        [String(r)]: `You need to square it: ${r}² = ${r} × ${r} = ${area}`
                                    }
                                },
                                {
                                    prompt: `Now write the final area: π × ${area} = ?`,
                                    hint: "Keep π in your answer!",
                                    answer: `${area}π`,
                                    acceptableAnswers: [`${area}π`, `${area}pi`, `${area} π`, `${area} pi`],
                                    commonMistakes: {
                                        [String(area)]: "Don't forget the π! The answer is " + area + "π",
                                        [String(Math.round(area * 3.14))]: `You calculated ${area} × 3.14. When asked 'in terms of π', write ${area}π`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Circle with radius ${pr}. Find area in terms of π.`, answer: `${parea}π`,
                            options: shuffle([`${parea}π`, `${2*pr}π`, `${pr}π`, `${2*parea}π`]),
                            mistakeAnalysis: {
                                [`${2*pr}π`]: `That's circumference (2πr)! Area = πr² = π(${pr})² = ${parea}π`,
                                [`${pr}π`]: `You forgot to square the radius! ${pr}² = ${parea}, so area = ${parea}π`,
                                [`${2*parea}π`]: `Check your calculation: ${pr}² = ${parea}, so area = ${parea}π`
                            }}
                    };
                })(),

                // Sub-skill 2: Circumference of a Circle (2πr)
                (() => {
                    const r = rand(3, 8);
                    const circValue = 2 * r;
                    // Practice values
                    const pr = rand(2, 7);
                    const pcircValue = 2 * pr;
                    return {
                        id: "circumference",
                        name: "Circumference (2πr)",
                        goalProblem: `Find the circumference of a circle with radius 5 in terms of π`,
                        teachingSteps: [
                            {
                                title: "What is Circumference?",
                                explanation: "<strong>Circumference</strong> is the <strong>distance AROUND</strong> a circle.<br><br>Think: If you walked around the edge of a circular pool, how far would you walk?",
                                visual: "Circumference = distance around ⭕"
                            },
                            {
                                title: "The Circumference Formula",
                                explanation: "<strong>C = 2πr</strong><br><br>This means: 2 times π times the radius<br><br>Alternative: <strong>C = πd</strong> (π times diameter)",
                                visual: "C = 2πr or C = πd"
                            },
                            {
                                title: "Why Two Formulas?",
                                explanation: "Since diameter = 2 × radius, both formulas give the same answer!<br><br>2πr = π(2r) = πd",
                                visual: "d = 2r, so 2πr = πd"
                            },
                            {
                                title: "Step 1: Identify the Radius",
                                explanation: "Our circle has radius = <strong>5</strong>",
                                visual: "r = 5"
                            },
                            {
                                title: "Step 2: Apply the Formula",
                                explanation: "C = 2πr = 2 × π × 5 = <strong>10π</strong>",
                                visual: "C = 2 × 5 × π = 10π"
                            }
                        ],
                        finalAnswer: "10π",
                        answerExplanation: "Circumference = 2πr = 2 × π × 5 = 10π",
                        example: { problem: `Circle with radius 5. Find circumference in terms of π.`, steps: [
                            { text: "Write the formula", math: "C = 2πr" },
                            { text: "Multiply 2 × r", math: "2 × 5 = 10" },
                            { text: "Write the answer", math: "C = 10π" }
                        ]},
                        keyPoints: [
                            "Circumference = 2πr (distance AROUND the circle)",
                            "Can also use C = πd where d = diameter",
                            "Don't confuse with Area (πr²) - that's the space INSIDE"
                        ],
                        mistakes: [
                            { wrong: "Using πr² instead of 2πr", why: "πr² is for AREA (inside). Circumference uses 2πr (around)." },
                            { wrong: "Using just πr", why: "Circumference needs the 2! It's 2πr, not πr." },
                            { wrong: "Confusing radius and diameter", why: "If given diameter, use C = πd. If given radius, use C = 2πr." }
                        ],
                        guided: {
                            problem: `Find the circumference of a circle with radius ${r} in terms of π`,
                            steps: [
                                { label: "Formula", value: "C = 2πr" },
                                { label: "Radius", value: `r = ${r}` },
                                { label: "2 × r =", value: `2 × ${r} = ?` }
                            ],
                            answer: `${circValue}π`,
                            answerLabel: "Circumference:",
                            interactiveSteps: [
                                {
                                    prompt: "What formula do we use for circumference of a circle?",
                                    hint: "It involves 2, π, and the radius...",
                                    answer: "2πr",
                                    acceptableAnswers: ["2πr", "C = 2πr", "2*pi*r", "2pir", "C=2πr", "πd", "C = πd"],
                                    commonMistakes: {
                                        "πr²": "That's the AREA formula! Circumference = 2πr (around), Area = πr² (inside)",
                                        "πr": "Close! But circumference needs 2πr, not just πr",
                                        "2r": "You forgot π! The formula is 2πr"
                                    }
                                },
                                {
                                    prompt: `Calculate: 2 × ${r} = ?`,
                                    hint: "Multiply 2 times the radius",
                                    answer: String(circValue),
                                    acceptableAnswers: [String(circValue)],
                                    commonMistakes: {
                                        [String(r * r)]: `That's ${r}² (squaring). We need 2 × ${r} = ${circValue}`,
                                        [String(r)]: `Don't forget the 2! 2 × ${r} = ${circValue}`
                                    }
                                },
                                {
                                    prompt: `Now write the final circumference: ${circValue} × π = ?`,
                                    hint: "Keep π in your answer!",
                                    answer: `${circValue}π`,
                                    acceptableAnswers: [`${circValue}π`, `${circValue}pi`, `${circValue} π`, `${circValue} pi`],
                                    commonMistakes: {
                                        [String(circValue)]: "Don't forget the π! The answer is " + circValue + "π",
                                        [String(Math.round(circValue * 3.14))]: `You calculated ${circValue} × 3.14. When asked 'in terms of π', write ${circValue}π`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Circle with radius ${pr}. Find circumference in terms of π.`, answer: `${pcircValue}π`,
                            options: shuffle([`${pcircValue}π`, `${pr*pr}π`, `${pr}π`, `${4*pr}π`]),
                            mistakeAnalysis: {
                                [`${pr*pr}π`]: `That's area (πr²)! Circumference = 2πr = 2(${pr})π = ${pcircValue}π`,
                                [`${pr}π`]: `You forgot the 2! Circumference = 2πr = ${pcircValue}π`,
                                [`${4*pr}π`]: `Check your calculation: 2 × ${pr} = ${pcircValue}, so C = ${pcircValue}π`
                            }}
                    };
                })()
            ]
        }),
        Trigonometry: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Sine (SOH)
                (() => {
                    const triples = [[3,4,5], [5,12,13], [8,15,17]];
                    const [opp, adj, hyp] = triples[rand(0, triples.length - 1)];
                    const sinVal = (opp / hyp).toFixed(2);
                    // For practice
                    const [popp, padj, phyp] = triples[(rand(0, triples.length - 1) + 1) % triples.length];
                    const psinVal = (popp / phyp).toFixed(2);
                    return {
                        id: "sin",
                        name: "Sine (SOH)",
                        goalProblem: `In a right triangle, opposite = 3, hypotenuse = 5. Find sin(θ).`,
                        teachingSteps: [
                            {
                                title: "What is Trigonometry?",
                                explanation: "<strong>Trigonometry</strong> connects <strong>angles</strong> to <strong>side lengths</strong> in right triangles using special ratios!",
                                visual: "Angles ↔ Side Lengths"
                            },
                            {
                                title: "The Three Sides",
                                explanation: "For angle θ:<br>• <strong>Opposite:</strong> Side ACROSS from the angle<br>• <strong>Adjacent:</strong> Side NEXT TO the angle<br>• <strong>Hypotenuse:</strong> LONGEST side (opposite 90°)",
                                visual: "O = across | A = next to | H = longest"
                            },
                            {
                                title: "SOH - Sine Formula",
                                explanation: "<strong>SOH:</strong> sin(θ) = Opposite / Hypotenuse<br><br>The 'S' in SOH stands for Sine, 'O' for Opposite, 'H' for Hypotenuse.",
                                visual: "sin(θ) = O/H"
                            },
                            {
                                title: "Apply to our problem",
                                explanation: "Given: opposite = 3, hypotenuse = 5<br>sin(θ) = O/H = 3/5 = <strong>0.6</strong>",
                                visual: "sin(θ) = 3/5 = 0.6"
                            }
                        ],
                        finalAnswer: "0.6",
                        answerExplanation: "sin(θ) = O/H = 3/5 = 0.6",
                        example: { problem: `Find sin(θ) when opposite = 3, hypotenuse = 5`, steps: [
                            { text: "Recall SOH: sin = O/H", math: "sin(θ) = Opposite/Hypotenuse" },
                            { text: "Substitute", math: "sin(θ) = 3/5" },
                            { text: "Calculate", math: "<strong>sin(θ) = 0.6</strong>" }
                        ]},
                        keyPoints: [
                            "SOH: Sin = Opposite / Hypotenuse",
                            "Opposite is ACROSS from the angle",
                            "Hypotenuse is ALWAYS the longest side"
                        ],
                        mistakes: [
                            { wrong: "Using adjacent instead", why: "Sine uses OPPOSITE, not adjacent!" },
                            { wrong: "Dividing hypotenuse by opposite", why: "It's O/H, not H/O!" }
                        ],
                        guided: { problem: `Find sin(θ) when opposite = ${opp}, hypotenuse = ${hyp}`, steps: [
                            { label: "Formula", value: "sin = O/H" },
                            { label: "Substitute", value: `${opp}/${hyp}` }
                        ], answer: sinVal, answerLabel: "sin(θ) = ?",
                            interactiveSteps: [
                                {
                                    prompt: `For sine (SOH), what's on top of the fraction?`,
                                    hint: "S-O-H: O is for...",
                                    answer: "opposite",
                                    acceptableAnswers: ["opposite", "O", "opp"],
                                    commonMistakes: { "adjacent": "That's for cosine! Sine uses Opposite." }
                                },
                                {
                                    prompt: `What's on the bottom?`,
                                    hint: "S-O-H: H is for...",
                                    answer: "hypotenuse",
                                    acceptableAnswers: ["hypotenuse", "H", "hyp"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Calculate: ${opp}/${hyp} = ?`,
                                    hint: "Divide...",
                                    answer: sinVal,
                                    acceptableAnswers: [sinVal, `${opp}/${hyp}`],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Find sin(θ) when opposite = ${popp}, hypotenuse = ${phyp}`,
                            answer: psinVal,
                            options: shuffle([psinVal, (padj/phyp).toFixed(2), (popp/padj).toFixed(2), (phyp/popp).toFixed(2)]),
                            mistakeAnalysis: {
                                [(padj/phyp).toFixed(2)]: `That's cosine (A/H)! Sine = O/H = ${popp}/${phyp} = ${psinVal}`,
                                [(popp/padj).toFixed(2)]: `That's tangent (O/A)! Sine = O/H = ${popp}/${phyp} = ${psinVal}`,
                                [(phyp/popp).toFixed(2)]: `You divided backwards! sin = O/H, not H/O`
                            }
                        }
                    };
                })(),

                // Sub-skill 2: Cosine (CAH)
                (() => {
                    const triples = [[3,4,5], [5,12,13], [8,15,17]];
                    const [opp, adj, hyp] = triples[rand(0, triples.length - 1)];
                    const cosVal = (adj / hyp).toFixed(2);
                    // For practice
                    const [popp, padj, phyp] = triples[(rand(0, triples.length - 1) + 1) % triples.length];
                    const pcosVal = (padj / phyp).toFixed(2);
                    return {
                        id: "cos",
                        name: "Cosine (CAH)",
                        goalProblem: `In a right triangle, adjacent = 4, hypotenuse = 5. Find cos(θ).`,
                        teachingSteps: [
                            {
                                title: "Review: SOH CAH TOA",
                                explanation: "We learned sin uses O/H. Now let's learn <strong>CAH</strong>:<br>• C = Cosine<br>• A = Adjacent<br>• H = Hypotenuse",
                                visual: "SOH | CAH | TOA"
                            },
                            {
                                title: "CAH - Cosine Formula",
                                explanation: "<strong>CAH:</strong> cos(θ) = Adjacent / Hypotenuse<br><br>Cosine uses the side NEXT TO the angle (adjacent) divided by the longest side (hypotenuse).",
                                visual: "cos(θ) = A/H"
                            },
                            {
                                title: "Which side is adjacent?",
                                explanation: "Adjacent = the side that TOUCHES the angle (but isn't the hypotenuse).<br>It's 'next to' or 'beside' the angle.",
                                visual: "Adjacent = next to angle θ"
                            },
                            {
                                title: "Apply to our problem",
                                explanation: "Given: adjacent = 4, hypotenuse = 5<br>cos(θ) = A/H = 4/5 = <strong>0.8</strong>",
                                visual: "cos(θ) = 4/5 = 0.8"
                            }
                        ],
                        finalAnswer: "0.8",
                        answerExplanation: "cos(θ) = A/H = 4/5 = 0.8",
                        example: { problem: `Find cos(θ) when adjacent = 4, hypotenuse = 5`, steps: [
                            { text: "Recall CAH: cos = A/H", math: "cos(θ) = Adjacent/Hypotenuse" },
                            { text: "Substitute", math: "cos(θ) = 4/5" },
                            { text: "Calculate", math: "<strong>cos(θ) = 0.8</strong>" }
                        ]},
                        keyPoints: [
                            "CAH: Cos = Adjacent / Hypotenuse",
                            "Adjacent is NEXT TO the angle",
                            "Don't confuse with sine (which uses opposite)"
                        ],
                        mistakes: [
                            { wrong: "Using opposite instead", why: "Cosine uses ADJACENT, not opposite!" },
                            { wrong: "Confusing sin and cos", why: "Sin = O/H, Cos = A/H. Different top!" }
                        ],
                        guided: { problem: `Find cos(θ) when adjacent = ${adj}, hypotenuse = ${hyp}`, steps: [
                            { label: "Formula", value: "cos = A/H" },
                            { label: "Substitute", value: `${adj}/${hyp}` }
                        ], answer: cosVal, answerLabel: "cos(θ) = ?",
                            interactiveSteps: [
                                {
                                    prompt: `For cosine (CAH), what's on top?`,
                                    hint: "C-A-H: A is for...",
                                    answer: "adjacent",
                                    acceptableAnswers: ["adjacent", "A", "adj"],
                                    commonMistakes: { "opposite": "That's for sine! Cosine uses Adjacent." }
                                },
                                {
                                    prompt: `Calculate: ${adj}/${hyp} = ?`,
                                    hint: "Divide...",
                                    answer: cosVal,
                                    acceptableAnswers: [cosVal, `${adj}/${hyp}`],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Find cos(θ) when adjacent = ${padj}, hypotenuse = ${phyp}`,
                            answer: pcosVal,
                            options: shuffle([pcosVal, (popp/phyp).toFixed(2), (popp/padj).toFixed(2), (phyp/padj).toFixed(2)]),
                            mistakeAnalysis: {
                                [(popp/phyp).toFixed(2)]: `That's sine (O/H)! Cosine = A/H = ${padj}/${phyp} = ${pcosVal}`,
                                [(popp/padj).toFixed(2)]: `That's tangent (O/A)! Cosine = A/H = ${padj}/${phyp} = ${pcosVal}`,
                                [(phyp/padj).toFixed(2)]: `You divided backwards! cos = A/H, not H/A`
                            }
                        }
                    };
                })(),

                // Sub-skill 3: Tangent (TOA)
                (() => {
                    const triples = [[3,4,5], [5,12,13], [8,15,17]];
                    const [opp, adj, hyp] = triples[rand(0, triples.length - 1)];
                    const tanVal = (opp / adj).toFixed(2);
                    // For practice
                    const [popp, padj, phyp] = triples[(rand(0, triples.length - 1) + 1) % triples.length];
                    const ptanVal = (popp / padj).toFixed(2);
                    return {
                        id: "tan",
                        name: "Tangent (TOA)",
                        goalProblem: `In a right triangle, opposite = 3, adjacent = 4. Find tan(θ).`,
                        teachingSteps: [
                            {
                                title: "The last ratio: TOA",
                                explanation: "We've learned SOH and CAH. Now let's complete with <strong>TOA</strong>:<br>• T = Tangent<br>• O = Opposite<br>• A = Adjacent",
                                visual: "SOH | CAH | TOA"
                            },
                            {
                                title: "TOA - Tangent Formula",
                                explanation: "<strong>TOA:</strong> tan(θ) = Opposite / Adjacent<br><br>Notice: tangent doesn't use hypotenuse at all! It's just the ratio of the two legs.",
                                visual: "tan(θ) = O/A"
                            },
                            {
                                title: "Think of it this way",
                                explanation: "Tangent = how 'steep' the angle is. A bigger opposite means a steeper angle, giving a larger tangent value.",
                                visual: "Steep → Big tangent | Shallow → Small tangent"
                            },
                            {
                                title: "Apply to our problem",
                                explanation: "Given: opposite = 3, adjacent = 4<br>tan(θ) = O/A = 3/4 = <strong>0.75</strong>",
                                visual: "tan(θ) = 3/4 = 0.75"
                            }
                        ],
                        finalAnswer: "0.75",
                        answerExplanation: "tan(θ) = O/A = 3/4 = 0.75",
                        example: { problem: `Find tan(θ) when opposite = 3, adjacent = 4`, steps: [
                            { text: "Recall TOA: tan = O/A", math: "tan(θ) = Opposite/Adjacent" },
                            { text: "Substitute", math: "tan(θ) = 3/4" },
                            { text: "Calculate", math: "<strong>tan(θ) = 0.75</strong>" }
                        ]},
                        keyPoints: [
                            "TOA: Tan = Opposite / Adjacent",
                            "Tangent doesn't use hypotenuse!",
                            "tan(45°) = 1 (when opposite = adjacent)"
                        ],
                        mistakes: [
                            { wrong: "Using hypotenuse", why: "Tangent is O/A - no hypotenuse needed!" },
                            { wrong: "Dividing adjacent by opposite", why: "It's O/A, not A/O!" }
                        ],
                        guided: { problem: `Find tan(θ) when opposite = ${opp}, adjacent = ${adj}`, steps: [
                            { label: "Formula", value: "tan = O/A" },
                            { label: "Substitute", value: `${opp}/${adj}` }
                        ], answer: tanVal, answerLabel: "tan(θ) = ?",
                            interactiveSteps: [
                                {
                                    prompt: `For tangent (TOA), what goes on top?`,
                                    hint: "T-O-A: O is for...",
                                    answer: "opposite",
                                    acceptableAnswers: ["opposite", "O", "opp"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `What goes on the bottom?`,
                                    hint: "T-O-A: A is for...",
                                    answer: "adjacent",
                                    acceptableAnswers: ["adjacent", "A", "adj"],
                                    commonMistakes: { "hypotenuse": "Tangent doesn't use hypotenuse! It's O/A." }
                                },
                                {
                                    prompt: `Calculate: ${opp}/${adj} = ?`,
                                    hint: "Divide...",
                                    answer: tanVal,
                                    acceptableAnswers: [tanVal, `${opp}/${adj}`],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: {
                            problem: `Find tan(θ) when opposite = ${popp}, adjacent = ${padj}`,
                            answer: ptanVal,
                            options: shuffle([ptanVal, (popp/phyp).toFixed(2), (padj/phyp).toFixed(2), (padj/popp).toFixed(2)]),
                            mistakeAnalysis: {
                                [(popp/phyp).toFixed(2)]: `That's sine (O/H)! Tangent = O/A = ${popp}/${padj} = ${ptanVal}`,
                                [(padj/phyp).toFixed(2)]: `That's cosine (A/H)! Tangent = O/A = ${popp}/${padj} = ${ptanVal}`,
                                [(padj/popp).toFixed(2)]: `You divided backwards! tan = O/A, not A/O`
                            }
                        }
                    };
                })()
            ]
        }),
        Transformations: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Translation (Sliding)
                (() => {
                    const x = rand(2, 6), y = rand(2, 5);
                    const dx = rand(3, 6), dy = rand(2, 5);
                    const px = rand(3, 7), py = rand(2, 6);
                    const pdx = rand(2, 5), pdy = rand(2, 4);
                    return {
                        id: "translate",
                        name: "Translation (Sliding)",
                        goalProblem: `Point A(3, 2) is translated 4 units right and 3 units up. New coordinates?`,
                        teachingSteps: [
                            {
                                title: "What is Translation?",
                                explanation: "<strong>Translation</strong> slides every point the SAME distance in the SAME direction. The shape stays exactly the same, just in a new location!",
                                visual: "Slide → Same shape, new location"
                            },
                            {
                                title: "The Rules",
                                explanation: "• <strong>Right:</strong> ADD to x<br>• <strong>Left:</strong> SUBTRACT from x<br>• <strong>Up:</strong> ADD to y<br>• <strong>Down:</strong> SUBTRACT from y",
                                visual: "Right +x | Left -x | Up +y | Down -y"
                            },
                            {
                                title: "Apply to (3, 2)",
                                explanation: "Right 4: x = 3 + 4 = 7<br>Up 3: y = 2 + 3 = 5<br>New point: <strong>(7, 5)</strong>",
                                visual: "(3, 2) → (7, 5)"
                            }
                        ],
                        finalAnswer: "(7, 5)",
                        answerExplanation: "(3+4, 2+3) = (7, 5)",
                        example: { problem: `Translate (3, 2) right 4, up 3`, steps: [
                            { text: "Right 4", math: "x: 3 + 4 = 7" },
                            { text: "Up 3", math: "y: 2 + 3 = 5" },
                            { text: "Answer", math: "<strong>(7, 5)</strong>" }
                        ]},
                        keyPoints: ["Right/Up = ADD", "Left/Down = SUBTRACT", "Shape stays the same"],
                        mistakes: [{ wrong: "Subtracting for right", why: "Right = ADD to x!" }],
                        guided: { problem: `Translate (${x}, ${y}) right ${dx}, up ${dy}`, steps: [
                            { label: "New x", value: `${x} + ${dx} = ${x + dx}` },
                            { label: "New y", value: `${y} + ${dy} = ${y + dy}` }
                        ], answer: `(${x + dx}, ${y + dy})`, answerLabel: "New point:",
                            interactiveSteps: [
                                { prompt: `New x: ${x} + ${dx} = ?`, hint: "Add...", answer: String(x + dx), acceptableAnswers: [String(x + dx)], commonMistakes: {} },
                                { prompt: `New y: ${y} + ${dy} = ?`, hint: "Add...", answer: String(y + dy), acceptableAnswers: [String(y + dy)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Translate (${px}, ${py}) right ${pdx}, up ${pdy}`, answer: `(${px + pdx}, ${py + pdy})`,
                            options: shuffle([`(${px + pdx}, ${py + pdy})`, `(${px - pdx}, ${py + pdy})`, `(${px + pdx}, ${py - pdy})`, `(${px + pdy}, ${py + pdx})`]),
                            mistakeAnalysis: {
                                [`(${px - pdx}, ${py + pdy})`]: `Right means ADD to x! ${px} + ${pdx} = ${px + pdx}`,
                                [`(${px + pdx}, ${py - pdy})`]: `Up means ADD to y! ${py} + ${pdy} = ${py + pdy}`,
                                [`(${px + pdy}, ${py + pdx})`]: `You swapped the translations! Right affects x, up affects y.`
                            }}
                    };
                })(),

                // Sub-skill 2: Reflection (Flipping)
                (() => {
                    const x = rand(2, 7), y = rand(2, 6);
                    const px = rand(3, 8), py = rand(2, 7);
                    return {
                        id: "reflect",
                        name: "Reflection (Flipping)",
                        goalProblem: `Reflect point (4, 3) over the x-axis. New coordinates?`,
                        teachingSteps: [
                            {
                                title: "What is Reflection?",
                                explanation: "<strong>Reflection</strong> creates a mirror image across a line (like looking in a mirror!).",
                                visual: "Mirror image across a line"
                            },
                            {
                                title: "The Rules",
                                explanation: "• <strong>Over x-axis:</strong> (x, y) → (x, <strong>-y</strong>) [flip y]<br>• <strong>Over y-axis:</strong> (x, y) → (<strong>-x</strong>, y) [flip x]<br>• <strong>Over y = x:</strong> (x, y) → (y, x) [swap]",
                                visual: "x-axis: flip y | y-axis: flip x"
                            },
                            {
                                title: "Apply to (4, 3) over x-axis",
                                explanation: "Over x-axis means flip the y-coordinate:<br>(4, 3) → (4, <strong>-3</strong>)",
                                visual: "(4, 3) → (4, -3)"
                            }
                        ],
                        finalAnswer: "(4, -3)",
                        answerExplanation: "Over x-axis: keep x, negate y → (4, -3)",
                        example: { problem: `Reflect (4, 3) over x-axis`, steps: [
                            { text: "Over x-axis = flip y", math: "y becomes -y" },
                            { text: "Keep x, negate y", math: "(4, 3) → (4, -3)" }
                        ]},
                        keyPoints: ["x-axis: flip y", "y-axis: flip x", "y=x: swap x and y"],
                        mistakes: [{ wrong: "Flipping both coordinates", why: "Only flip ONE coordinate depending on the axis!" }],
                        guided: { problem: `Reflect (${x}, ${y}) over the y-axis`, steps: [
                            { label: "Over y-axis", value: "flip x" },
                            { label: "New point", value: "?" }
                        ], answer: `(${-x}, ${y})`, answerLabel: "New point:",
                            interactiveSteps: [
                                { prompt: `Over y-axis, what happens to x?`, hint: "Flip it...", answer: "negate", acceptableAnswers: ["negate", "flip", "negative", "-x"], commonMistakes: {} },
                                { prompt: `So (${x}, ${y}) becomes?`, hint: `(-${x}, ${y})`, answer: `(${-x}, ${y})`, acceptableAnswers: [`(${-x}, ${y})`, `(-${x}, ${y})`], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Reflect (${px}, ${py}) over the x-axis`, answer: `(${px}, ${-py})`,
                            options: shuffle([`(${px}, ${-py})`, `(${-px}, ${py})`, `(${-px}, ${-py})`, `(${py}, ${px})`]),
                            mistakeAnalysis: {
                                [`(${-px}, ${py})`]: `That's over the y-axis! Over x-axis: flip y, keep x.`,
                                [`(${-px}, ${-py})`]: `That's 180° rotation! Over x-axis only flips y.`,
                                [`(${py}, ${px})`]: `That's over y=x! Over x-axis: (${px}, ${py}) → (${px}, ${-py})`
                            }}
                    };
                })(),

                // Sub-skill 3: Rotation (Turning)
                (() => {
                    const x = rand(2, 5), y = rand(2, 5);
                    const px = rand(1, 4), py = rand(1, 4);
                    return {
                        id: "rotate",
                        name: "Rotation (Turning)",
                        goalProblem: `Rotate point (3, 2) by 180° about the origin. New coordinates?`,
                        teachingSteps: [
                            {
                                title: "What is Rotation?",
                                explanation: "<strong>Rotation</strong> turns a shape around a fixed point (usually the origin). Think of spinning a wheel!",
                                visual: "Turn around a center point"
                            },
                            {
                                title: "Common Rotations (counterclockwise)",
                                explanation: "• <strong>90°:</strong> (x, y) → (-y, x)<br>• <strong>180°:</strong> (x, y) → (-x, -y)<br>• <strong>270°:</strong> (x, y) → (y, -x)",
                                visual: "90°: (-y,x) | 180°: (-x,-y) | 270°: (y,-x)"
                            },
                            {
                                title: "Apply 180° to (3, 2)",
                                explanation: "180° rotation: negate BOTH coordinates<br>(3, 2) → (<strong>-3, -2</strong>)",
                                visual: "(3, 2) → (-3, -2)"
                            }
                        ],
                        finalAnswer: "(-3, -2)",
                        answerExplanation: "180° rotation: negate both → (-3, -2)",
                        example: { problem: `Rotate (3, 2) by 180°`, steps: [
                            { text: "180° rule", math: "(x, y) → (-x, -y)" },
                            { text: "Apply", math: "(3, 2) → (-3, -2)" }
                        ]},
                        keyPoints: ["180°: negate both", "90°: (-y, x)", "270°: (y, -x)"],
                        mistakes: [{ wrong: "Only negating one coordinate", why: "180° negates BOTH x and y!" }],
                        guided: { problem: `Rotate (${x}, ${y}) by 180° about the origin`, steps: [
                            { label: "180° rule", value: "(-x, -y)" },
                            { label: "New point", value: "?" }
                        ], answer: `(${-x}, ${-y})`, answerLabel: "New point:",
                            interactiveSteps: [
                                { prompt: `For 180° rotation, what happens to (x, y)?`, hint: "Both coordinates...", answer: "negate both", acceptableAnswers: ["negate both", "-x -y", "(-x, -y)"], commonMistakes: {} },
                                { prompt: `So (${x}, ${y}) becomes?`, hint: `(${-x}, ${-y})`, answer: `(${-x}, ${-y})`, acceptableAnswers: [`(${-x}, ${-y})`, `(-${x}, -${y})`], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Rotate (${px}, ${py}) by 180° about origin`, answer: `(${-px}, ${-py})`,
                            options: shuffle([`(${-px}, ${-py})`, `(${px}, ${-py})`, `(${-px}, ${py})`, `(${-py}, ${px})`]),
                            mistakeAnalysis: {
                                [`(${px}, ${-py})`]: `That's x-axis reflection! 180° negates BOTH.`,
                                [`(${-px}, ${py})`]: `That's y-axis reflection! 180° negates BOTH.`,
                                [`(${-py}, ${px})`]: `That's 90° rotation! 180°: (${px}, ${py}) → (${-px}, ${-py})`
                            }}
                    };
                })(),

                // Sub-skill 4: Dilation (Resizing)
                (() => {
                    const x = rand(1, 4), y = rand(1, 4);
                    const scale = rand(2, 3);
                    const px = rand(2, 5), py = rand(1, 4);
                    const pscale = rand(2, 4);
                    return {
                        id: "dilate",
                        name: "Dilation (Resizing)",
                        goalProblem: `Dilate point (2, 3) by scale factor 3 from the origin. New coordinates?`,
                        teachingSteps: [
                            {
                                title: "What is Dilation?",
                                explanation: "<strong>Dilation</strong> resizes a shape by a scale factor. It makes shapes bigger or smaller while keeping the same proportions.",
                                visual: "Resize by multiplying"
                            },
                            {
                                title: "The Rule",
                                explanation: "Multiply BOTH coordinates by the scale factor:<br>(x, y) → (x × k, y × k)<br><br>• k > 1: enlargement<br>• 0 < k < 1: reduction",
                                visual: "(x, y) → (kx, ky)"
                            },
                            {
                                title: "Apply to (2, 3) with k=3",
                                explanation: "Scale factor 3: multiply both by 3<br>x: 2 × 3 = 6<br>y: 3 × 3 = 9<br>New point: <strong>(6, 9)</strong>",
                                visual: "(2, 3) → (6, 9)"
                            }
                        ],
                        finalAnswer: "(6, 9)",
                        answerExplanation: "Multiply both by 3: (2×3, 3×3) = (6, 9)",
                        example: { problem: `Dilate (2, 3) by factor 3`, steps: [
                            { text: "Multiply x by 3", math: "2 × 3 = 6" },
                            { text: "Multiply y by 3", math: "3 × 3 = 9" },
                            { text: "New point", math: "<strong>(6, 9)</strong>" }
                        ]},
                        keyPoints: ["Multiply BOTH coordinates", "k > 1 = bigger", "0 < k < 1 = smaller"],
                        mistakes: [{ wrong: "Adding the scale factor", why: "Dilation uses MULTIPLICATION, not addition!" }],
                        guided: { problem: `Dilate (${x}, ${y}) by factor ${scale} from origin`, steps: [
                            { label: "Multiply x", value: `${x} × ${scale} = ${x * scale}` },
                            { label: "Multiply y", value: `${y} × ${scale} = ${y * scale}` }
                        ], answer: `(${x * scale}, ${y * scale})`, answerLabel: "New point:",
                            interactiveSteps: [
                                { prompt: `${x} × ${scale} = ?`, hint: "Multiply...", answer: String(x * scale), acceptableAnswers: [String(x * scale)], commonMistakes: {} },
                                { prompt: `${y} × ${scale} = ?`, hint: "Multiply...", answer: String(y * scale), acceptableAnswers: [String(y * scale)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Dilate (${px}, ${py}) by factor ${pscale}`, answer: `(${px * pscale}, ${py * pscale})`,
                            options: shuffle([`(${px * pscale}, ${py * pscale})`, `(${px + pscale}, ${py + pscale})`, `(${px * pscale}, ${py})`, `(${px}, ${py * pscale})`]),
                            mistakeAnalysis: {
                                [`(${px + pscale}, ${py + pscale})`]: `You added! Dilation MULTIPLIES: (${px}×${pscale}, ${py}×${pscale})`,
                                [`(${px * pscale}, ${py})`]: `Dilate BOTH coordinates, not just x!`,
                                [`(${px}, ${py * pscale})`]: `Dilate BOTH coordinates, not just y!`
                            }}
                    };
                })()
            ]
        }),
        Similarity: () => {
            const side1 = rand(4, 8), side2 = rand(6, 12);
            const scale = rand(2, 4);
            const newSide1 = side1 * scale;
            return {
                goalProblem: `Two triangles are similar. Triangle A has sides 3, 4, 5. Triangle B has a shortest side of 6. Find the longest side of Triangle B.`,
                teachingSteps: [
                    {
                        title: "What Does Similar Mean?",
                        explanation: "<strong>Similar shapes</strong> have the same SHAPE but different SIZES.<br><br>• All corresponding <strong>angles are equal</strong><br>• All corresponding <strong>sides are proportional</strong> (same ratio)<br><br>Think of similar shapes like a photo and its enlarged copy!",
                        visual: "Same shape + Same angles + Proportional sides = SIMILAR"
                    },
                    {
                        title: "The Scale Factor",
                        explanation: "The <strong>scale factor</strong> tells us how much bigger or smaller the similar shape is.<br><br>Scale factor = (side of new shape) ÷ (corresponding side of original)<br><br>Every side is multiplied by the SAME scale factor!",
                        visual: "Scale factor = new side ÷ original side"
                    },
                    {
                        title: "Using Proportions",
                        explanation: "Since all sides have the same ratio, we can set up proportions:<br><br>side₁(A) / side₁(B) = side₂(A) / side₂(B)<br><br>Cross-multiply to solve for unknowns!",
                        visual: "a₁/b₁ = a₂/b₂ → Cross multiply!"
                    },
                    {
                        title: "Step 1: Find the Scale Factor",
                        explanation: "Triangle A's shortest side: <strong>3</strong><br>Triangle B's shortest side: <strong>6</strong><br><br>Scale factor = 6 ÷ 3 = <strong>2</strong><br><br>Triangle B is 2 times bigger!",
                        visual: "6 ÷ 3 = 2 (scale factor)"
                    },
                    {
                        title: "Step 2: Apply to the Longest Side",
                        explanation: "Triangle A's longest side: <strong>5</strong><br><br>Triangle B's longest side = 5 × scale factor<br>= 5 × 2 = <strong>10</strong>",
                        visual: "5 × 2 = 10"
                    }
                ],
                finalAnswer: "10",
                answerExplanation: "The scale factor is 6÷3=2. Multiplying the longest side (5) by 2 gives 10.",
                example: { problem: `Similar triangles A (3,4,5) and B (6,?,?). Find longest side of B.`, steps: [
                    { text: "Find scale factor", math: "6 ÷ 3 = 2" },
                    { text: "Identify longest side of A", math: "5" },
                    { text: "Multiply by scale factor", math: "5 × 2 = 10" },
                    { text: "Longest side of B", math: "<strong>10</strong>" }
                ]},
                keyPoints: [
                    "Similar = same shape, different size",
                    "Corresponding angles are equal",
                    "Corresponding sides have the same ratio (scale factor)"
                ],
                mistakes: [
                    { wrong: "Adding instead of multiplying by scale factor", why: "Scale factor MULTIPLIES all sides, doesn't add to them" },
                    { wrong: "Finding different scale factors for different sides", why: "ALL sides use the SAME scale factor in similar shapes" }
                ],
                guided: {
                    problem: `Two similar rectangles: Rectangle A has sides ${side1} and ${side2}. Rectangle B has its shorter side equal to ${newSide1}. Find the longer side of B.`,
                    steps: [
                        { label: "Scale factor", value: `${newSide1} ÷ ${side1} = ${scale}` },
                        { label: "Longer side of B", value: `${side2} × ${scale} = ?` }
                    ],
                    answer: String(side2 * scale),
                    answerLabel: "Longer side:",
                    interactiveSteps: [
                        {
                            prompt: `What is the scale factor? ${newSide1} ÷ ${side1} = ?`,
                            hint: `Divide ${newSide1} by ${side1}`,
                            answer: String(scale),
                            acceptableAnswers: [String(scale)],
                            commonMistakes: {
                                [String(newSide1 - side1)]: `You subtracted! Scale factor = ${newSide1} ÷ ${side1} = ${scale}`,
                                [String(newSide1 + side1)]: "You added! Scale factor is found by DIVIDING corresponding sides."
                            }
                        },
                        {
                            prompt: `Now multiply the longer side by the scale factor: ${side2} × ${scale} = ?`,
                            hint: `What's ${side2} times ${scale}?`,
                            answer: String(side2 * scale),
                            acceptableAnswers: [String(side2 * scale)],
                            commonMistakes: {
                                [String(side2 + scale)]: `You added! Multiply: ${side2} × ${scale} = ${side2 * scale}`,
                                [String(side2)]: `Don't forget to apply the scale factor! ${side2} × ${scale} = ${side2 * scale}`
                            }
                        }
                    ]
                },
                practice: { problem: `A 3-inch photo is enlarged with scale factor 4. What is the new width?`, answer: "12",
                    options: ["7", "12", "16", "1"],
                    mistakeAnalysis: {
                        "7": "You added 3 + 4. Scale factor MULTIPLIES: 3 × 4 = 12",
                        "16": "You might have used 4² = 16. Just multiply: 3 × 4 = 12",
                        "1": "You divided 4 ÷ 4 or something similar. Multiply: 3 × 4 = 12"
                    }}
            };
        },
        Congruence: () => {
            const side = rand(5, 10);
            return {
                goalProblem: `Triangle ABC ≅ Triangle DEF. If AB = 7 cm, what is DE?`,
                teachingSteps: [
                    {
                        title: "What Does Congruent Mean?",
                        explanation: "<strong>Congruent</strong> shapes are EXACTLY the same - same shape AND same size!<br><br>The symbol <strong>≅</strong> means 'is congruent to'<br><br>If two shapes are congruent:<br>• All corresponding sides are EQUAL<br>• All corresponding angles are EQUAL",
                        visual: "Congruent (≅) = Same shape AND same size"
                    },
                    {
                        title: "Congruent vs. Similar",
                        explanation: "<strong>Similar:</strong> Same shape, different size (proportional sides)<br><br><strong>Congruent:</strong> Same shape, SAME size (equal sides)<br><br>Congruent shapes are like identical twins - exactly the same!",
                        visual: "Similar: same shape | Congruent: exact copies"
                    },
                    {
                        title: "Congruence Statements",
                        explanation: "When we write △ABC ≅ △DEF, the ORDER matters!<br><br>• A corresponds to D<br>• B corresponds to E<br>• C corresponds to F<br><br>AB corresponds to DE, BC to EF, AC to DF",
                        visual: "ABC ≅ DEF → A↔D, B↔E, C↔F"
                    },
                    {
                        title: "Triangle Congruence Rules",
                        explanation: "To prove triangles are congruent, use:<br><br>• <strong>SSS:</strong> Side-Side-Side (all 3 sides equal)<br>• <strong>SAS:</strong> Side-Angle-Side (2 sides + included angle)<br>• <strong>ASA:</strong> Angle-Side-Angle (2 angles + included side)<br>• <strong>AAS:</strong> Angle-Angle-Side<br>• <strong>HL:</strong> Hypotenuse-Leg (right triangles only)",
                        visual: "SSS | SAS | ASA | AAS | HL"
                    },
                    {
                        title: "Solving Our Problem",
                        explanation: "△ABC ≅ △DEF<br><br>AB corresponds to DE (same position in each triangle name).<br><br>Since congruent shapes have <strong>equal</strong> corresponding parts:<br><br><strong>DE = AB = 7 cm</strong>",
                        visual: "AB ↔ DE → DE = 7 cm"
                    }
                ],
                finalAnswer: "7 cm",
                answerExplanation: "In congruent triangles, corresponding sides are equal. Since AB corresponds to DE and AB = 7 cm, DE = 7 cm.",
                example: { problem: `△ABC ≅ △DEF. If AB = 7 cm, find DE.`, steps: [
                    { text: "Identify corresponding sides", math: "AB corresponds to DE" },
                    { text: "Apply congruence property", math: "Corresponding sides are equal" },
                    { text: "Therefore", math: "<strong>DE = 7 cm</strong>" }
                ]},
                keyPoints: [
                    "Congruent = same shape AND same size",
                    "Corresponding parts of congruent triangles are equal (CPCTC)",
                    "Order of letters in congruence statement shows correspondence"
                ],
                mistakes: [
                    { wrong: "Matching wrong letters", why: "Match letters by POSITION: 1st↔1st, 2nd↔2nd, 3rd↔3rd" },
                    { wrong: "Confusing similar and congruent", why: "Similar = proportional, Congruent = EQUAL" }
                ],
                guided: {
                    problem: `△PQR ≅ △XYZ. If PQ = ${side} cm and QR = ${side + 3} cm, what is XY?`,
                    steps: [
                        { label: "PQ corresponds to", value: "XY" },
                        { label: "Congruent sides are", value: "equal" },
                        { label: "XY =", value: "?" }
                    ],
                    answer: String(side),
                    answerLabel: "XY =",
                    interactiveSteps: [
                        {
                            prompt: "In △PQR ≅ △XYZ, which side corresponds to PQ?",
                            hint: "Match by position: P↔X, Q↔Y, R↔Z. So PQ↔...",
                            answer: "XY",
                            acceptableAnswers: ["XY", "xy"],
                            commonMistakes: {
                                "YZ": "YZ corresponds to QR, not PQ. P↔X and Q↔Y, so PQ↔XY",
                                "XZ": "XZ corresponds to PR. PQ corresponds to XY"
                            }
                        },
                        {
                            prompt: `Since congruent sides are equal, and PQ = ${side}, what is XY?`,
                            hint: "Congruent means equal in length...",
                            answer: String(side),
                            acceptableAnswers: [String(side), `${side} cm`, `${side}cm`],
                            commonMistakes: {
                                [String(side + 3)]: `That's the length of QR, not PQ. XY = PQ = ${side}`,
                                [String(side * 2)]: `No need to multiply! Congruent means EQUAL: XY = ${side}`
                            }
                        }
                    ]
                },
                practice: { problem: `△ABC ≅ △DEF. Angle B = 45°. What is angle E?`, answer: "45°",
                    options: ["45°", "90°", "135°", "Cannot determine"],
                    mistakeAnalysis: {
                        "90°": "Corresponding angles in congruent triangles are EQUAL, not complementary. E = B = 45°",
                        "135°": "Corresponding angles are equal, not supplementary. E = B = 45°",
                        "Cannot determine": "We CAN determine! B corresponds to E (2nd letter), and congruent means equal."
                    }}
            };
        },
        Proofs: () => ({
            goalProblem: `Given: Lines AB and CD are parallel, cut by transversal EF. Prove: Alternate interior angles are equal.`,
            teachingSteps: [
                {
                    title: "What is a Geometric Proof?",
                    explanation: "A <strong>proof</strong> is a logical argument that uses:<br><br>• <strong>Given information</strong> (what we start with)<br>• <strong>Definitions and properties</strong> (things we know are true)<br>• <strong>Logical steps</strong> (connecting ideas)<br><br>...to <strong>prove a conclusion</strong> must be true.",
                    visual: "Given → Logical Steps → Conclusion"
                },
                {
                    title: "Two-Column Proofs",
                    explanation: "The most common format:<br><br><strong>Statement | Reason</strong><br>1. What you know | Why you know it<br>2. Next fact | Why it's true<br>...<br>Final: Conclusion | Final reason<br><br>Every statement needs a reason!",
                    visual: "Statement | Reason (every step justified)"
                },
                {
                    title: "Common Reasons in Proofs",
                    explanation: "• <strong>Given</strong> - stated in the problem<br>• <strong>Definition</strong> - what a term means<br>• <strong>Postulate/Axiom</strong> - accepted without proof<br>• <strong>Theorem</strong> - previously proven<br>• <strong>Substitution</strong> - replacing equals<br>• <strong>Transitive property</strong> - if a=b and b=c, then a=c",
                    visual: "Given | Definition | Postulate | Theorem | Substitution | Transitive"
                },
                {
                    title: "Parallel Line Angle Relationships",
                    explanation: "When a transversal crosses parallel lines:<br><br>• <strong>Corresponding angles</strong> are equal (same position)<br>• <strong>Alternate interior angles</strong> are equal (opposite sides, between lines)<br>• <strong>Co-interior (same-side)</strong> angles sum to 180°",
                    visual: "Corresponding: = | Alt. interior: = | Co-interior: sum to 180°"
                },
                {
                    title: "Our Proof Strategy",
                    explanation: "We'll use these facts:<br><br>1. Corresponding angles are equal (postulate)<br>2. Vertical angles are equal (theorem)<br>3. Use transitive property to connect alternate interior angles<br><br>This shows WHY alternate interior angles must be equal!",
                    visual: "Corresponding → Vertical → Alternate Interior"
                },
                {
                    title: "The Two-Column Proof",
                    explanation: "<strong>1.</strong> AB ∥ CD | Given<br><strong>2.</strong> ∠1 ≅ ∠3 | Corresponding angles (parallel lines)<br><strong>3.</strong> ∠3 ≅ ∠2 | Vertical angles are equal<br><strong>4.</strong> ∠1 ≅ ∠2 | Transitive property<br><br>∠1 and ∠2 are alternate interior angles ✓",
                    visual: "Corresponding = Vertical → Alternate Interior equal!"
                }
            ],
            finalAnswer: "Alternate interior angles are equal (proven via corresponding and vertical angles)",
            answerExplanation: "Using the transitive property, we connected corresponding angles (equal by postulate) and vertical angles (equal by theorem) to prove alternate interior angles must be equal.",
            example: { problem: `Prove: Alternate interior angles are equal`, steps: [
                { text: "Corresponding angles are equal", math: "∠1 = ∠3 (postulate)" },
                { text: "Vertical angles are equal", math: "∠3 = ∠2 (theorem)" },
                { text: "By transitive property", math: "∠1 = ∠2" },
                { text: "Conclusion", math: "<strong>Alternate interior angles are equal</strong>" }
            ]},
            keyPoints: [
                "Every statement in a proof needs a reason",
                "Use given info, definitions, postulates, and theorems",
                "Transitive property connects equal quantities"
            ],
            mistakes: [
                { wrong: "Skipping steps or reasons", why: "Every statement must be justified - no jumping to conclusions!" },
                { wrong: "Using what you're trying to prove", why: "That's circular reasoning! Use known facts to reach the conclusion." }
            ],
            guided: {
                problem: `Given: ∠A and ∠B are supplementary. ∠B and ∠C are supplementary. Prove: ∠A = ∠C`,
                steps: [
                    { label: "Supplementary means", value: "angles sum to 180°" },
                    { label: "∠A + ∠B =", value: "180°" },
                    { label: "∠B + ∠C =", value: "180°" },
                    { label: "Therefore ∠A =", value: "?" }
                ],
                answer: "∠C",
                answerLabel: "∠A equals:",
                interactiveSteps: [
                    {
                        prompt: "What does 'supplementary' mean?",
                        hint: "Supplementary angles add up to...",
                        answer: "180",
                        acceptableAnswers: ["180", "180°", "180 degrees", "add to 180", "sum to 180"],
                        commonMistakes: {
                            "90": "That's COMPLEMENTARY (add to 90°). Supplementary = 180°",
                            "360": "That's angles in a circle. Supplementary angles sum to 180°"
                        }
                    },
                    {
                        prompt: "If ∠A + ∠B = 180° and ∠B + ∠C = 180°, then ∠A + ∠B = ∠B + ∠C. What property lets us say ∠A = ∠C?",
                        hint: "When we subtract the same thing from both sides...",
                        answer: "subtraction property",
                        acceptableAnswers: ["subtraction property", "subtraction", "subtract ∠B", "subtracting ∠B from both sides"],
                        commonMistakes: {
                            "addition": "We're removing ∠B from both sides, so it's SUBTRACTION property",
                            "transitive": "Transitive is for a=b, b=c → a=c. Here we subtract ∠B from both sides."
                        }
                    }
                ]
            },
            practice: { problem: `In a proof, what is the reason for "∠A = ∠A"?`, answer: "Reflexive property",
                options: ["Reflexive property", "Transitive property", "Given", "Substitution"],
                mistakeAnalysis: {
                    "Transitive property": "Transitive is for a=b and b=c → a=c. 'A thing equals itself' is reflexive.",
                    "Given": "'Given' is for info stated in the problem. A=A is always true (reflexive property).",
                    "Substitution": "Substitution is replacing one thing with an equal thing. A=A is reflexive."
                }}
        }),
        "Law of Sines": () => {
            const A = rand(35, 55), B = rand(45, 65);
            const C = 180 - A - B;
            const a = rand(8, 15);
            const b = Math.round(a * Math.sin(B * Math.PI / 180) / Math.sin(A * Math.PI / 180) * 10) / 10;
            return {
                goalProblem: `In triangle ABC: A = 40°, B = 60°, a = 10. Find side b.`,
                teachingSteps: [
                    {
                        title: "What is the Law of Sines?",
                        explanation: "The <strong>Law of Sines</strong> relates sides and angles in ANY triangle:<br><br><strong>a/sin(A) = b/sin(B) = c/sin(C)</strong><br><br>Side 'a' is opposite angle A, side 'b' is opposite angle B, etc.",
                        visual: "a/sin(A) = b/sin(B) = c/sin(C)"
                    },
                    {
                        title: "When to Use Law of Sines",
                        explanation: "Use Law of Sines when you know:<br><br>• <strong>AAS</strong> - Two angles and a non-included side<br>• <strong>ASA</strong> - Two angles and the included side<br>• <strong>SSA</strong> - Two sides and an angle opposite one of them<br><br>It's for angle-side pairs!",
                        visual: "AAS, ASA, or SSA → Law of Sines"
                    },
                    {
                        title: "Setting Up the Proportion",
                        explanation: "We know: A = 40°, B = 60°, a = 10, and need b.<br><br>Use the pairs with known info:<br><br><strong>a/sin(A) = b/sin(B)</strong><br>10/sin(40°) = b/sin(60°)",
                        visual: "10/sin(40°) = b/sin(60°)"
                    },
                    {
                        title: "Step 1: Find the Sine Values",
                        explanation: "Using a calculator (or table):<br><br>sin(40°) ≈ <strong>0.643</strong><br>sin(60°) ≈ <strong>0.866</strong>",
                        visual: "sin(40°) ≈ 0.643 | sin(60°) ≈ 0.866"
                    },
                    {
                        title: "Step 2: Cross-Multiply and Solve",
                        explanation: "10/0.643 = b/0.866<br><br>Cross-multiply:<br>10 × 0.866 = b × 0.643<br>8.66 = 0.643b<br><br>b = 8.66 / 0.643 ≈ <strong>13.5</strong>",
                        visual: "b = (10 × 0.866) / 0.643 ≈ 13.5"
                    }
                ],
                finalAnswer: "b ≈ 13.5",
                answerExplanation: "Using Law of Sines: b = a × sin(B)/sin(A) = 10 × sin(60°)/sin(40°) ≈ 13.5",
                example: { problem: `A = 40°, B = 60°, a = 10. Find b.`, steps: [
                    { text: "Write Law of Sines", math: "a/sin(A) = b/sin(B)" },
                    { text: "Substitute known values", math: "10/sin(40°) = b/sin(60°)" },
                    { text: "Solve for b", math: "b = 10 × sin(60°)/sin(40°)" },
                    { text: "Calculate", math: "<strong>b ≈ 13.5</strong>" }
                ]},
                keyPoints: [
                    "Law of Sines: a/sin(A) = b/sin(B) = c/sin(C)",
                    "Side 'a' is OPPOSITE angle A",
                    "Use when you have angle-side pairs"
                ],
                mistakes: [
                    { wrong: "Matching side to wrong angle", why: "Each side is opposite its corresponding angle (a opposite A)" },
                    { wrong: "Using degrees in calculator set to radians", why: "Make sure calculator is in DEGREE mode for degree problems!" }
                ],
                guided: {
                    problem: `In triangle ABC: A = ${A}°, B = ${B}°, a = ${a}. Find side b (round to 1 decimal).`,
                    steps: [
                        { label: "Law of Sines setup", value: `${a}/sin(${A}°) = b/sin(${B}°)` },
                        { label: "sin(${A}°) ≈", value: String(Math.round(Math.sin(A * Math.PI / 180) * 1000) / 1000) },
                        { label: "sin(${B}°) ≈", value: String(Math.round(Math.sin(B * Math.PI / 180) * 1000) / 1000) }
                    ],
                    answer: String(b),
                    answerLabel: "b ≈",
                    interactiveSteps: [
                        {
                            prompt: "What is the Law of Sines formula?",
                            hint: "It relates sides a, b, c to angles A, B, C using sine...",
                            answer: "a/sin(A) = b/sin(B)",
                            acceptableAnswers: ["a/sin(A) = b/sin(B)", "a/sinA = b/sinB", "a/sin(A)=b/sin(B)=c/sin(C)", "a/sin A = b/sin B = c/sin C"],
                            commonMistakes: {
                                "a² + b² = c²": "That's the Pythagorean theorem (right triangles only). Law of Sines works for ALL triangles.",
                                "sin = opp/hyp": "That's SOH CAH TOA for right triangles. Law of Sines is a/sin(A) = b/sin(B)"
                            }
                        },
                        {
                            prompt: `To find b, we rearrange to: b = a × sin(B)/sin(A). Plug in: b = ${a} × sin(${B}°)/sin(${A}°). Calculate b (round to 1 decimal).`,
                            hint: `Use sin(${A}°) ≈ ${Math.round(Math.sin(A * Math.PI / 180) * 1000) / 1000} and sin(${B}°) ≈ ${Math.round(Math.sin(B * Math.PI / 180) * 1000) / 1000}`,
                            answer: String(b),
                            acceptableAnswers: [String(b), String(Math.round(b)), String(Math.round(b * 10) / 10)],
                            commonMistakes: {
                                [String(a)]: `You need to multiply ${a} by sin(${B}°)/sin(${A}°), not just use ${a}`
                            }
                        }
                    ]
                },
                practice: { problem: `In Law of Sines, side 'b' is opposite which angle?`, answer: "Angle B",
                    options: ["Angle A", "Angle B", "Angle C", "The largest angle"],
                    mistakeAnalysis: {
                        "Angle A": "Side a is opposite angle A. Side b is opposite angle B.",
                        "Angle C": "Side c is opposite angle C. Each side is opposite its matching letter.",
                        "The largest angle": "Not necessarily! b is always opposite B, regardless of size."
                    }}
            };
        },
        "Law of Cosines": () => {
            const a = rand(5, 9), b = rand(6, 10), C = rand(40, 80);
            const cSquared = a*a + b*b - 2*a*b*Math.cos(C * Math.PI / 180);
            const c = Math.round(Math.sqrt(cSquared) * 10) / 10;
            return {
                goalProblem: `Find side c: a = 8, b = 6, C = 60°`,
                teachingSteps: [
                    {
                        title: "What is the Law of Cosines?",
                        explanation: "The <strong>Law of Cosines</strong> is like an upgraded Pythagorean theorem that works for ALL triangles:<br><br><strong>c² = a² + b² - 2ab·cos(C)</strong><br><br>It connects two sides and the angle BETWEEN them to the third side.",
                        visual: "c² = a² + b² - 2ab·cos(C)"
                    },
                    {
                        title: "When to Use Law of Cosines",
                        explanation: "Use Law of Cosines when you know:<br><br>• <strong>SAS</strong> - Two sides and the INCLUDED angle (the angle between them)<br>• <strong>SSS</strong> - All three sides (to find an angle)<br><br>It's for when you have the angle BETWEEN two known sides!",
                        visual: "SAS or SSS → Law of Cosines"
                    },
                    {
                        title: "Law of Cosines vs. Pythagorean Theorem",
                        explanation: "Notice: if C = 90°, then cos(90°) = 0<br><br>c² = a² + b² - 2ab(0)<br>c² = a² + b²<br><br>The Pythagorean theorem is a SPECIAL CASE of Law of Cosines!",
                        visual: "When C = 90°: c² = a² + b² (Pythagorean!)"
                    },
                    {
                        title: "Step 1: Identify the Known Values",
                        explanation: "We have: a = 8, b = 6, C = 60°<br><br>We're looking for side c (opposite angle C).<br><br>Since we have SAS (two sides and included angle), use Law of Cosines!",
                        visual: "a = 8, b = 6, C = 60° → Find c"
                    },
                    {
                        title: "Step 2: Plug into the Formula",
                        explanation: "c² = a² + b² - 2ab·cos(C)<br>c² = 8² + 6² - 2(8)(6)·cos(60°)<br>c² = 64 + 36 - 96·(0.5)<br>c² = 100 - 48<br>c² = 52",
                        visual: "c² = 64 + 36 - 96(0.5) = 52"
                    },
                    {
                        title: "Step 3: Take the Square Root",
                        explanation: "c² = 52<br>c = √52<br>c ≈ <strong>7.2</strong>",
                        visual: "c = √52 ≈ 7.2"
                    }
                ],
                finalAnswer: "c ≈ 7.2",
                answerExplanation: "Using c² = a² + b² - 2ab·cos(C) with a=8, b=6, C=60°, we get c² = 52, so c ≈ 7.2",
                example: { problem: `a = 8, b = 6, C = 60°. Find c.`, steps: [
                    { text: "Write Law of Cosines", math: "c² = a² + b² - 2ab·cos(C)" },
                    { text: "Substitute values", math: "c² = 64 + 36 - 96·cos(60°)" },
                    { text: "Calculate (cos 60° = 0.5)", math: "c² = 100 - 48 = 52" },
                    { text: "Take square root", math: "<strong>c ≈ 7.2</strong>" }
                ]},
                keyPoints: [
                    "c² = a² + b² - 2ab·cos(C)",
                    "Use when you know SAS (two sides + included angle) or SSS",
                    "The angle in the formula is BETWEEN the two known sides"
                ],
                mistakes: [
                    { wrong: "Using the wrong angle", why: "The angle C must be BETWEEN sides a and b (the included angle)" },
                    { wrong: "Forgetting to take the square root", why: "The formula gives c², so you must take √ to get c" }
                ],
                guided: {
                    problem: `Find side c: a = ${a}, b = ${b}, C = ${C}°`,
                    steps: [
                        { label: "Formula", value: "c² = a² + b² - 2ab·cos(C)" },
                        { label: "a² + b²", value: `${a*a} + ${b*b} = ${a*a + b*b}` },
                        { label: "cos(${C}°)", value: String(Math.round(Math.cos(C * Math.PI / 180) * 1000) / 1000) }
                    ],
                    answer: String(c),
                    answerLabel: "c ≈",
                    interactiveSteps: [
                        {
                            prompt: `First, calculate a² + b² = ${a}² + ${b}² = ?`,
                            hint: `Square each number and add: ${a}×${a} + ${b}×${b}`,
                            answer: String(a*a + b*b),
                            acceptableAnswers: [String(a*a + b*b)],
                            commonMistakes: {
                                [String(a + b)]: `You just added! We need squares: ${a}² + ${b}² = ${a*a} + ${b*b} = ${a*a+b*b}`,
                                [String((a + b) * (a + b))]: `That's (a+b)². We need a² + b² = ${a*a + b*b}`
                            }
                        },
                        {
                            prompt: `Now calculate 2ab = 2 × ${a} × ${b} = ?`,
                            hint: `Multiply 2 × ${a} × ${b}`,
                            answer: String(2*a*b),
                            acceptableAnswers: [String(2*a*b)],
                            commonMistakes: {
                                [String(a*b)]: `Don't forget the 2! 2 × ${a} × ${b} = ${2*a*b}`,
                                [String(2+a+b)]: `You added instead of multiplied! 2 × ${a} × ${b} = ${2*a*b}`
                            }
                        },
                        {
                            prompt: `Finally, c = √c². If c² = ${Math.round(cSquared)}, what is c (round to 1 decimal)?`,
                            hint: `Take the square root of ${Math.round(cSquared)}`,
                            answer: String(c),
                            acceptableAnswers: [String(c), String(Math.round(c))],
                            commonMistakes: {
                                [String(Math.round(cSquared))]: `That's c². Take the SQUARE ROOT to get c ≈ ${c}`,
                                [String(Math.round(cSquared / 2))]: `Don't divide by 2! Take √${Math.round(cSquared)} ≈ ${c}`
                            }
                        }
                    ]
                },
                practice: { problem: `Which situation requires Law of Cosines instead of Law of Sines?`, answer: "SAS - two sides and included angle",
                    options: ["SAS - two sides and included angle", "AAS - two angles and a side", "ASA - two angles and included side", "AAA - three angles"],
                    mistakeAnalysis: {
                        "AAS - two angles and a side": "AAS gives angle-side pairs, so use Law of SINES for this",
                        "ASA - two angles and included side": "ASA involves angle pairs, so Law of SINES works here",
                        "AAA - three angles": "AAA doesn't uniquely determine a triangle (infinite similar triangles possible)"
                    }}
            };
        },
        "Coordinate Geometry": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Midpoint Formula
                (() => {
                    const x1 = rand(2, 8), y1 = rand(2, 8);
                    const x2 = rand(2, 8), y2 = rand(2, 8);
                    const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
                    // Practice values
                    const px1 = rand(0, 6), py1 = rand(0, 6);
                    const px2 = rand(4, 10), py2 = rand(4, 10);
                    const pmx = (px1 + px2) / 2, pmy = (py1 + py2) / 2;
                    return {
                        id: "midpoint",
                        name: "Midpoint Formula",
                        goalProblem: `Find the midpoint of (2, 4) and (6, 8)`,
                        teachingSteps: [
                            {
                                title: "What is a Midpoint?",
                                explanation: "The <strong>midpoint</strong> is the point exactly <strong>HALFWAY</strong> between two other points.<br><br>It's like finding the middle of a line segment!",
                                visual: "A ----•---- B (• is the midpoint)"
                            },
                            {
                                title: "The Midpoint Formula",
                                explanation: "<strong>Midpoint = ((x₁+x₂)/2, (y₁+y₂)/2)</strong><br><br>Just <strong>average the x-coordinates</strong> and <strong>average the y-coordinates</strong>!",
                                visual: "Midpoint = (average of x's, average of y's)"
                            },
                            {
                                title: "Step 1: Identify the Coordinates",
                                explanation: "Point 1: (2, 4) → x₁ = 2, y₁ = 4<br>Point 2: (6, 8) → x₂ = 6, y₂ = 8",
                                visual: "(2, 4) and (6, 8)"
                            },
                            {
                                title: "Step 2: Average the x-coordinates",
                                explanation: "(x₁ + x₂) / 2 = (2 + 6) / 2 = 8 / 2 = <strong>4</strong>",
                                visual: "(2 + 6) / 2 = 4"
                            },
                            {
                                title: "Step 3: Average the y-coordinates",
                                explanation: "(y₁ + y₂) / 2 = (4 + 8) / 2 = 12 / 2 = <strong>6</strong>",
                                visual: "(4 + 8) / 2 = 6"
                            },
                            {
                                title: "Answer",
                                explanation: "The midpoint is <strong>(4, 6)</strong>",
                                visual: "Midpoint = (4, 6)"
                            }
                        ],
                        finalAnswer: "(4, 6)",
                        answerExplanation: "Midpoint = ((2+6)/2, (4+8)/2) = (4, 6)",
                        example: { problem: `Midpoint of (2, 4) and (6, 8)`, steps: [
                            { text: "Average x-coordinates", math: "(2 + 6) / 2 = 4" },
                            { text: "Average y-coordinates", math: "(4 + 8) / 2 = 6" },
                            { text: "Write the midpoint", math: "<strong>(4, 6)</strong>" }
                        ]},
                        keyPoints: [
                            "Midpoint = ((x₁+x₂)/2, (y₁+y₂)/2)",
                            "Just average the x's and average the y's",
                            "The midpoint is equidistant from both original points"
                        ],
                        mistakes: [
                            { wrong: "Subtracting instead of adding", why: "Midpoint ADDS the coordinates, then divides: (x₁+x₂)/2" },
                            { wrong: "Forgetting to divide by 2", why: "You must divide by 2 to get the average!" },
                            { wrong: "Mixing up x and y", why: "Keep x's with x's and y's with y's" }
                        ],
                        guided: {
                            problem: `Find the midpoint of (${x1}, ${y1}) and (${x2}, ${y2})`,
                            steps: [
                                { label: "Add x's", value: `${x1} + ${x2} = ${x1 + x2}` },
                                { label: "Add y's", value: `${y1} + ${y2} = ${y1 + y2}` },
                                { label: "Midpoint", value: "?" }
                            ],
                            answer: `(${mx}, ${my})`,
                            answerLabel: "Midpoint:",
                            interactiveSteps: [
                                {
                                    prompt: `Average the x-coordinates: (${x1} + ${x2}) / 2 = ?`,
                                    hint: `Add ${x1} + ${x2}, then divide by 2`,
                                    answer: String(mx),
                                    acceptableAnswers: [String(mx)],
                                    commonMistakes: {
                                        [String(x1 + x2)]: `You forgot to divide by 2! (${x1} + ${x2}) / 2 = ${mx}`,
                                        [String(x2 - x1)]: `You subtracted! Midpoint uses addition: (${x1} + ${x2}) / 2 = ${mx}`
                                    }
                                },
                                {
                                    prompt: `Average the y-coordinates: (${y1} + ${y2}) / 2 = ?`,
                                    hint: `Add ${y1} + ${y2}, then divide by 2`,
                                    answer: String(my),
                                    acceptableAnswers: [String(my)],
                                    commonMistakes: {
                                        [String(y1 + y2)]: `You forgot to divide by 2! (${y1} + ${y2}) / 2 = ${my}`,
                                        [String(y2 - y1)]: `You subtracted! Midpoint uses addition: (${y1} + ${y2}) / 2 = ${my}`
                                    }
                                },
                                {
                                    prompt: `Write the midpoint as an ordered pair:`,
                                    hint: `Put the x-average and y-average together`,
                                    answer: `(${mx}, ${my})`,
                                    acceptableAnswers: [`(${mx}, ${my})`, `(${mx},${my})`, `${mx}, ${my}`],
                                    commonMistakes: {
                                        [`(${my}, ${mx})`]: `You swapped x and y! The x-coordinate (${mx}) comes first: (${mx}, ${my})`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Midpoint of (${px1}, ${py1}) and (${px2}, ${py2})?`, answer: `(${pmx}, ${pmy})`,
                            options: shuffle([`(${pmx}, ${pmy})`, `(${px1 + px2}, ${py1 + py2})`, `(${px2 - px1}, ${py2 - py1})`, `(${pmy}, ${pmx})`]),
                            mistakeAnalysis: {
                                [`(${px1 + px2}, ${py1 + py2})`]: `You forgot to divide by 2! Midpoint = (${pmx}, ${pmy})`,
                                [`(${px2 - px1}, ${py2 - py1})`]: `You subtracted instead of averaging! Midpoint = ((${px1}+${px2})/2, (${py1}+${py2})/2) = (${pmx}, ${pmy})`,
                                [`(${pmy}, ${pmx})`]: `You swapped x and y! The correct midpoint is (${pmx}, ${pmy})`
                            }}
                    };
                })(),

                // Sub-skill 2: Distance Formula
                (() => {
                    // Use Pythagorean triples for clean answers
                    const triples = [[3,4,5], [5,12,13], [6,8,10], [8,15,17]];
                    const [dx, dy, dist] = triples[rand(0, triples.length - 1)];
                    const x1 = rand(1, 5), y1 = rand(1, 5);
                    const x2 = x1 + dx, y2 = y1 + dy;
                    // Practice with different triple
                    const [pdx, pdy, pdist] = triples[(rand(0, triples.length - 1) + 1) % triples.length];
                    const px1 = rand(0, 4), py1 = rand(0, 4);
                    const px2 = px1 + pdx, py2 = py1 + pdy;
                    return {
                        id: "distance",
                        name: "Distance Formula",
                        goalProblem: `Find the distance between A(1, 2) and B(4, 6)`,
                        teachingSteps: [
                            {
                                title: "What is the Distance Formula?",
                                explanation: "The <strong>distance formula</strong> finds the straight-line distance between two points on a coordinate plane.",
                                visual: "How far apart are two points?"
                            },
                            {
                                title: "The Formula (Pythagorean Theorem!)",
                                explanation: "<strong>d = √[(x₂-x₁)² + (y₂-y₁)²]</strong><br><br>This IS the Pythagorean theorem! The distance is the hypotenuse of a right triangle.",
                                visual: "d = √[(x₂-x₁)² + (y₂-y₁)²]"
                            },
                            {
                                title: "Step 1: Find the Differences",
                                explanation: "For A(1, 2) and B(4, 6):<br><br>x₂ - x₁ = 4 - 1 = <strong>3</strong><br>y₂ - y₁ = 6 - 2 = <strong>4</strong>",
                                visual: "Δx = 3, Δy = 4"
                            },
                            {
                                title: "Step 2: Square the Differences",
                                explanation: "3² = <strong>9</strong><br>4² = <strong>16</strong>",
                                visual: "3² = 9, 4² = 16"
                            },
                            {
                                title: "Step 3: Add and Take Square Root",
                                explanation: "d = √(9 + 16) = √25 = <strong>5</strong>",
                                visual: "√(9 + 16) = √25 = 5"
                            }
                        ],
                        finalAnswer: "5",
                        answerExplanation: "d = √[(4-1)² + (6-2)²] = √[9 + 16] = √25 = 5",
                        example: { problem: `Distance from A(1, 2) to B(4, 6)`, steps: [
                            { text: "Find differences", math: "Δx = 3, Δy = 4" },
                            { text: "Square them", math: "9 + 16 = 25" },
                            { text: "Take square root", math: "<strong>d = √25 = 5</strong>" }
                        ]},
                        keyPoints: [
                            "d = √[(x₂-x₁)² + (y₂-y₁)²]",
                            "It's the Pythagorean theorem on a coordinate plane",
                            "Order of subtraction doesn't matter (we square the result)"
                        ],
                        mistakes: [
                            { wrong: "Forgetting to square", why: "Must square the differences before adding: (x₂-x₁)²" },
                            { wrong: "Forgetting the square root", why: "After adding squares, take the square root!" },
                            { wrong: "Adding instead of subtracting", why: "Distance uses subtraction (x₂-x₁), not addition" }
                        ],
                        guided: {
                            problem: `Find the distance from (${x1}, ${y1}) to (${x2}, ${y2})`,
                            steps: [
                                { label: "Δx", value: `${x2} - ${x1} = ${dx}` },
                                { label: "Δy", value: `${y2} - ${y1} = ${dy}` },
                                { label: "Distance", value: "?" }
                            ],
                            answer: String(dist),
                            answerLabel: "Distance:",
                            interactiveSteps: [
                                {
                                    prompt: `Calculate x₂ - x₁ = ${x2} - ${x1} = ?`,
                                    hint: `Subtract the x-coordinates`,
                                    answer: String(dx),
                                    acceptableAnswers: [String(dx)],
                                    commonMistakes: {
                                        [String(x1 + x2)]: `You added! Distance uses subtraction: ${x2} - ${x1} = ${dx}`
                                    }
                                },
                                {
                                    prompt: `Calculate y₂ - y₁ = ${y2} - ${y1} = ?`,
                                    hint: `Subtract the y-coordinates`,
                                    answer: String(dy),
                                    acceptableAnswers: [String(dy)],
                                    commonMistakes: {
                                        [String(y1 + y2)]: `You added! Distance uses subtraction: ${y2} - ${y1} = ${dy}`
                                    }
                                },
                                {
                                    prompt: `Now calculate: ${dx}² + ${dy}² = ?`,
                                    hint: `Square each difference, then add`,
                                    answer: String(dx*dx + dy*dy),
                                    acceptableAnswers: [String(dx*dx + dy*dy)],
                                    commonMistakes: {
                                        [String(dx + dy)]: `You need to SQUARE each number first! ${dx}² + ${dy}² = ${dx*dx} + ${dy*dy} = ${dx*dx + dy*dy}`
                                    }
                                },
                                {
                                    prompt: `Finally, take the square root: √${dx*dx + dy*dy} = ?`,
                                    hint: `What number times itself equals ${dx*dx + dy*dy}?`,
                                    answer: String(dist),
                                    acceptableAnswers: [String(dist)],
                                    commonMistakes: {
                                        [String(dx*dx + dy*dy)]: `Don't forget the square root! √${dx*dx + dy*dy} = ${dist}`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Distance from (${px1}, ${py1}) to (${px2}, ${py2})?`, answer: String(pdist),
                            options: shuffle([String(pdist), String(pdx + pdy), String(pdx*pdx + pdy*pdy), String(Math.abs(pdx - pdy))]),
                            mistakeAnalysis: {
                                [String(pdx + pdy)]: `You added the differences without squaring! Distance = √(${pdx}² + ${pdy}²) = ${pdist}`,
                                [String(pdx*pdx + pdy*pdy)]: `You forgot the square root! √${pdx*pdx + pdy*pdy} = ${pdist}`,
                                [String(Math.abs(pdx - pdy))]: `That's not how distance works. Use d = √[(Δx)² + (Δy)²] = ${pdist}`
                            }}
                    };
                })(),

                // Sub-skill 3: Slope Formula
                (() => {
                    const x1 = rand(1, 4), y1 = rand(1, 5);
                    const run = rand(2, 4);
                    const rise = rand(2, 6);
                    const x2 = x1 + run, y2 = y1 + rise;
                    const slope = rise / run;
                    const slopeStr = Number.isInteger(slope) ? String(slope) : `${rise}/${run}`;
                    // Practice
                    const prun = rand(2, 5);
                    const prise = rand(2, 8);
                    const px1 = rand(0, 3), py1 = rand(0, 4);
                    const px2 = px1 + prun, py2 = py1 + prise;
                    const pslope = prise / prun;
                    const pslopeStr = Number.isInteger(pslope) ? String(pslope) : `${prise}/${prun}`;
                    return {
                        id: "slope",
                        name: "Slope Formula",
                        goalProblem: `Find the slope of the line through (1, 2) and (3, 8)`,
                        teachingSteps: [
                            {
                                title: "What is Slope?",
                                explanation: "<strong>Slope</strong> measures the <strong>steepness</strong> of a line.<br><br>It tells you: for each step right, how much do you go up (or down)?",
                                visual: "Slope = steepness of a line"
                            },
                            {
                                title: "Rise Over Run",
                                explanation: "<strong>Slope = rise/run</strong><br><br>• <strong>Rise:</strong> vertical change (up/down)<br>• <strong>Run:</strong> horizontal change (left/right)",
                                visual: "m = rise/run = (change in y)/(change in x)"
                            },
                            {
                                title: "The Slope Formula",
                                explanation: "<strong>m = (y₂ - y₁)/(x₂ - x₁)</strong><br><br>Subtract the y's, divide by the difference in x's.",
                                visual: "m = (y₂ - y₁)/(x₂ - x₁)"
                            },
                            {
                                title: "Step 1: Find the Rise (Δy)",
                                explanation: "For (1, 2) and (3, 8):<br><br>y₂ - y₁ = 8 - 2 = <strong>6</strong>",
                                visual: "Rise = 8 - 2 = 6"
                            },
                            {
                                title: "Step 2: Find the Run (Δx)",
                                explanation: "x₂ - x₁ = 3 - 1 = <strong>2</strong>",
                                visual: "Run = 3 - 1 = 2"
                            },
                            {
                                title: "Step 3: Divide",
                                explanation: "Slope = rise/run = 6/2 = <strong>3</strong><br><br>The line goes up 3 units for every 1 unit right.",
                                visual: "m = 6/2 = 3"
                            }
                        ],
                        finalAnswer: "3",
                        answerExplanation: "m = (8-2)/(3-1) = 6/2 = 3",
                        example: { problem: `Slope through (1, 2) and (3, 8)`, steps: [
                            { text: "Find rise (Δy)", math: "8 - 2 = 6" },
                            { text: "Find run (Δx)", math: "3 - 1 = 2" },
                            { text: "Divide", math: "<strong>m = 6/2 = 3</strong>" }
                        ]},
                        keyPoints: [
                            "Slope = rise/run = (y₂-y₁)/(x₂-x₁)",
                            "Positive slope: line goes UP to the right",
                            "Negative slope: line goes DOWN to the right"
                        ],
                        mistakes: [
                            { wrong: "Dividing x by y instead of y by x", why: "Slope = rise/run = Δy/Δx (y on top!)" },
                            { wrong: "Inconsistent subtraction order", why: "If you use y₂-y₁ on top, use x₂-x₁ on bottom" },
                            { wrong: "Mixing up which point is which", why: "Just be consistent - same point for all ₁ values, same for ₂" }
                        ],
                        guided: {
                            problem: `Find the slope through (${x1}, ${y1}) and (${x2}, ${y2})`,
                            steps: [
                                { label: "Rise (Δy)", value: `${y2} - ${y1} = ${rise}` },
                                { label: "Run (Δx)", value: `${x2} - ${x1} = ${run}` },
                                { label: "Slope", value: "?" }
                            ],
                            answer: slopeStr,
                            answerLabel: "Slope:",
                            interactiveSteps: [
                                {
                                    prompt: `Calculate the rise: y₂ - y₁ = ${y2} - ${y1} = ?`,
                                    hint: `Subtract the y-coordinates`,
                                    answer: String(rise),
                                    acceptableAnswers: [String(rise)],
                                    commonMistakes: {
                                        [String(y1 + y2)]: `You added! Rise = ${y2} - ${y1} = ${rise}`
                                    }
                                },
                                {
                                    prompt: `Calculate the run: x₂ - x₁ = ${x2} - ${x1} = ?`,
                                    hint: `Subtract the x-coordinates`,
                                    answer: String(run),
                                    acceptableAnswers: [String(run)],
                                    commonMistakes: {
                                        [String(x1 + x2)]: `You added! Run = ${x2} - ${x1} = ${run}`
                                    }
                                },
                                {
                                    prompt: `Calculate slope = rise/run = ${rise}/${run} = ?`,
                                    hint: `Divide ${rise} by ${run}`,
                                    answer: slopeStr,
                                    acceptableAnswers: [slopeStr, String(slope), `${rise}/${run}`],
                                    commonMistakes: {
                                        [String(run/rise)]: `You divided run by rise! Slope = rise/run = ${rise}/${run} = ${slopeStr}`,
                                        [`${run}/${rise}`]: `You have it upside down! Slope = rise/run = ${rise}/${run}`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Slope through (${px1}, ${py1}) and (${px2}, ${py2})?`, answer: pslopeStr,
                            options: shuffle([pslopeStr, `${prun}/${prise}`, String(prise + prun), String(prise - prun)]),
                            mistakeAnalysis: {
                                [`${prun}/${prise}`]: `You divided run by rise! Slope = rise/run = ${prise}/${prun} = ${pslopeStr}`,
                                [String(prise + prun)]: `You added instead of dividing! Slope = rise/run = ${pslopeStr}`,
                                [String(prise - prun)]: `You subtracted instead of dividing! Slope = rise/run = ${pslopeStr}`
                            }}
                    };
                })()
            ]
        }),
        "Angle Bisectors": () => {
            const angle = rand(40, 80) * 2;
            const half = angle / 2;
            return {
                goalProblem: `An angle bisector divides a 70° angle. What is each resulting angle?`,
                teachingSteps: [
                    {
                        title: "What is an angle bisector?",
                        explanation: "An <strong>angle bisector</strong> is a ray that divides an angle into two EQUAL parts. 'Bi' means two, 'sector' means cut!",
                        visual: "Bisector = divides into 2 equal angles"
                    },
                    {
                        title: "The bisector divides equally",
                        explanation: "If the original angle is 70°, the bisector creates two angles of 70° ÷ 2 = <strong>35° each</strong>.",
                        visual: "70° ÷ 2 = 35° + 35°"
                    },
                    {
                        title: "Angle Bisector Theorem",
                        explanation: "In a triangle, the angle bisector also divides the opposite side in the ratio of the adjacent sides.",
                        visual: "BD/DC = AB/AC"
                    },
                    {
                        title: "The answer",
                        explanation: "Each angle formed by the bisector is <strong>35°</strong>.",
                        visual: "Each angle = 35°"
                    }
                ],
                finalAnswer: "35°",
                answerExplanation: "An angle bisector divides an angle into two equal parts. 70° ÷ 2 = 35° for each resulting angle.",
                example: { problem: `Bisect a 70° angle`, steps: [
                    { text: "Bisector divides equally", math: "70° ÷ 2" },
                    { text: "Each angle", math: "<strong>35°</strong>" }
                ]},
                keyPoints: [
                    "Angle bisector divides an angle into two EQUAL parts",
                    "Each resulting angle = original angle ÷ 2",
                    "Angle Bisector Theorem: divides opposite side proportionally"
                ],
                mistakes: [
                    { wrong: "Forgetting to divide by 2", why: "Bisect means divide by 2! 70° → 35° each." },
                    { wrong: "Confusing with perpendicular bisector", why: "Angle bisector divides ANGLES. Perpendicular bisector divides SEGMENTS." }
                ],
                guided: {
                    problem: `An angle bisector divides a ${angle}° angle. What is each resulting angle?`,
                    steps: [
                        { label: "Original angle", value: angle + "°" },
                        { label: "Divide by 2", value: "?" }
                    ],
                    answer: half + "°",
                    answerLabel: "Each angle = ",
                    interactiveSteps: [
                        {
                            prompt: "A bisector divides an angle into how many equal parts?",
                            hint: "'Bi' means...",
                            answer: "2",
                            acceptableAnswers: ["2", "two"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `${angle}° ÷ 2 = ?`,
                            hint: "Divide the angle by 2...",
                            answer: String(half),
                            acceptableAnswers: [String(half), half + "°"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A bisector divides a 120° angle. What is each part?`, answer: "60°",
                    options: ["60°", "30°", "90°", "120°"],
                    mistakeAnalysis: {
                        "30°": "120 ÷ 2 = 60, not 30. Each angle is 60°.",
                        "90°": "Not a right angle! 120 ÷ 2 = 60°",
                        "120°": "That's the original. Bisector divides: 120 ÷ 2 = 60°"
                    }}
            };
        },
        "Perpendicular Bisectors": () => {
            const len = rand(8, 16);
            const half = len / 2;
            return {
                goalProblem: `A perpendicular bisector divides a 12 cm segment. What is each part?`,
                teachingSteps: [
                    {
                        title: "What is a perpendicular bisector?",
                        explanation: "A <strong>perpendicular bisector</strong> is a line that: 1) Passes through the MIDPOINT of a segment, and 2) Is PERPENDICULAR (90°) to it.",
                        visual: "⊥ bisector: 90° AND at midpoint"
                    },
                    {
                        title: "It divides the segment equally",
                        explanation: "A 12 cm segment is divided into two equal parts: 12 ÷ 2 = <strong>6 cm each</strong>.",
                        visual: "12 cm ÷ 2 = 6 cm + 6 cm"
                    },
                    {
                        title: "Special property",
                        explanation: "Any point ON the perpendicular bisector is EQUIDISTANT from both endpoints of the segment!",
                        visual: "Point P on ⊥ bis → PA = PB"
                    },
                    {
                        title: "The answer",
                        explanation: "Each part is <strong>6 cm</strong>.",
                        visual: "Each part = 6 cm"
                    }
                ],
                finalAnswer: "6 cm",
                answerExplanation: "A perpendicular bisector divides a segment into two equal parts. 12 cm ÷ 2 = 6 cm each.",
                example: { problem: `Perpendicular bisector of 12 cm segment`, steps: [
                    { text: "Bisector divides equally", math: "12 ÷ 2" },
                    { text: "Each part", math: "<strong>6 cm</strong>" }
                ]},
                keyPoints: [
                    "Perpendicular bisector is ⊥ (90°) to segment at midpoint",
                    "Points on ⊥ bisector are equidistant from endpoints",
                    "Used to find circumcenter of a triangle"
                ],
                mistakes: [
                    { wrong: "Thinking it just cuts at any angle", why: "Must be PERPENDICULAR (90°), not just any cut!" },
                    { wrong: "Confusing with angle bisector", why: "Perpendicular bisector divides SEGMENTS. Angle bisector divides ANGLES." }
                ],
                guided: {
                    problem: `A perpendicular bisector divides a ${len} cm segment. What is each part?`,
                    steps: [
                        { label: "Original length", value: len + " cm" },
                        { label: "Divide by 2", value: "?" }
                    ],
                    answer: half + " cm",
                    answerLabel: "Each part = ",
                    interactiveSteps: [
                        {
                            prompt: "At what angle does a perpendicular bisector cross the segment?",
                            hint: "Perpendicular means...",
                            answer: "90°",
                            acceptableAnswers: ["90°", "90", "right angle"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `${len} cm ÷ 2 = ?`,
                            hint: "Divide the length by 2...",
                            answer: String(half),
                            acceptableAnswers: [String(half), half + " cm"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Point P is on the ⊥ bisector of AB. If PA = 8 cm, what is PB?`, answer: "8 cm",
                    options: ["8 cm", "4 cm", "16 cm", "Cannot tell"],
                    mistakeAnalysis: {
                        "4 cm": "Points on ⊥ bisector are EQUIDISTANT. PB = PA = 8 cm.",
                        "16 cm": "Points on ⊥ bisector are EQUIDISTANT, not double. PB = 8 cm.",
                        "Cannot tell": "We CAN tell! ⊥ bisector property: PA = PB = 8 cm."
                    }}
            };
        },
        "Triangle Inequality": () => {
            const a = rand(3, 8), b = rand(4, 9);
            const minC = Math.abs(a - b) + 1;
            const maxC = a + b - 1;
            return {
                goalProblem: `Can a triangle have sides 3, 4, and 8?`,
                teachingSteps: [
                    {
                        title: "The Triangle Inequality Theorem",
                        explanation: "The sum of any two sides must be <strong>GREATER THAN</strong> the third side. This must be true for ALL three combinations!",
                        visual: "a + b > c, a + c > b, b + c > a"
                    },
                    {
                        title: "Test all combinations",
                        explanation: "3 + 4 = 7. Is 7 > 8? <strong>NO!</strong> 7 is NOT greater than 8.",
                        visual: "3 + 4 = 7 ≯ 8 ✗"
                    },
                    {
                        title: "One failure means no triangle",
                        explanation: "Since 3 + 4 is NOT greater than 8, these sides <strong>cannot</strong> form a triangle.",
                        visual: "Cannot form a triangle!"
                    },
                    {
                        title: "Why it fails",
                        explanation: "The two shorter sides (3 and 4) would be too short to 'reach' across and connect when the longest side is 8.",
                        visual: "3 + 4 < 8 → sides don't connect"
                    }
                ],
                finalAnswer: "No, cannot form a triangle",
                answerExplanation: "3 + 4 = 7, which is NOT greater than 8. The Triangle Inequality fails.",
                example: { problem: `Can sides 3, 4, 8 form a triangle?`, steps: [
                    { text: "Test: 3 + 4 > 8?", math: "7 > 8? NO ✗" },
                    { text: "One failure = no triangle", math: "<strong>Not a valid triangle</strong>" }
                ]},
                keyPoints: [
                    "Sum of two sides MUST be greater than the third",
                    "Test ALL three combinations (but one failure = no triangle)",
                    "Equal (=) doesn't count; must be GREATER THAN (>)"
                ],
                mistakes: [
                    { wrong: "Only testing one combination", why: "Must test all three, though one failure is enough to disqualify." },
                    { wrong: "Using ≥ instead of >", why: "Must be STRICTLY greater, not equal. 3+4=7 is NOT > 7." },
                    { wrong: "Adding all three sides", why: "Test pairs: a+b>c, a+c>b, b+c>a, not a+b+c." }
                ],
                guided: {
                    problem: `Can a triangle have sides ${a}, ${b}, and 2?`,
                    steps: [
                        { label: a + " + " + b + " > 2?", value: (a+b) + " > 2? Yes ✓" },
                        { label: a + " + 2 > " + b + "?", value: (a+2) + " > " + b + "? " + ((a+2 > b) ? "Yes ✓" : "No ✗") },
                        { label: b + " + 2 > " + a + "?", value: (b+2) + " > " + a + "? " + ((b+2 > a) ? "Yes ✓" : "No ✗") }
                    ],
                    answer: (a+b > 2 && a+2 > b && b+2 > a) ? "yes" : "no",
                    answerLabel: "Valid triangle? ",
                    interactiveSteps: [
                        {
                            prompt: `Is ${a} + ${b} = ${a+b} greater than 2?`,
                            hint: "Compare " + (a+b) + " to 2...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "true"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Is ${a} + 2 = ${a+2} greater than ${b}?`,
                            hint: "Compare " + (a+2) + " to " + b + "...",
                            answer: (a+2 > b) ? "yes" : "no",
                            acceptableAnswers: [(a+2 > b) ? "yes" : "no"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Do all three inequalities pass?`,
                            hint: "If any fails, no triangle...",
                            answer: (a+b > 2 && a+2 > b && b+2 > a) ? "yes" : "no",
                            acceptableAnswers: [(a+b > 2 && a+2 > b && b+2 > a) ? "yes" : "no"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Can a triangle have sides 5, 5, and 10?`, answer: "No",
                    options: ["No", "Yes", "Maybe", "Only if equilateral"],
                    mistakeAnalysis: {
                        "Yes": "5 + 5 = 10, not GREATER than 10. Must be strictly greater!",
                        "Maybe": "We can determine this! 5 + 5 = 10 ≯ 10. No triangle.",
                        "Only if equilateral": "5, 5, 10 isn't equilateral. And 5+5=10 isn't >10."
                    }}
            };
        },
        "Triangle Centers": () => {
            return {
                goalProblem: `What triangle center is equidistant from all three vertices?`,
                teachingSteps: [
                    {
                        title: "Four main triangle centers",
                        explanation: "Triangles have four important centers: <strong>Centroid</strong>, <strong>Circumcenter</strong>, <strong>Incenter</strong>, and <strong>Orthocenter</strong>.",
                        visual: "4 centers: Centroid, Circumcenter, Incenter, Orthocenter"
                    },
                    {
                        title: "Circumcenter",
                        explanation: "The <strong>circumcenter</strong> is where the three perpendicular bisectors meet. It's equidistant from all three VERTICES!",
                        visual: "Circumcenter = equidistant from vertices"
                    },
                    {
                        title: "Other centers",
                        explanation: "• <strong>Centroid</strong>: medians meet (2:1 ratio)<br>• <strong>Incenter</strong>: angle bisectors meet (equidistant from SIDES)<br>• <strong>Orthocenter</strong>: altitudes meet",
                        visual: "Centroid, Incenter, Orthocenter"
                    },
                    {
                        title: "The answer",
                        explanation: "The <strong>circumcenter</strong> is equidistant from all three vertices.",
                        visual: "Circumcenter"
                    }
                ],
                finalAnswer: "Circumcenter",
                answerExplanation: "The circumcenter, where perpendicular bisectors meet, is equidistant from all three vertices.",
                example: { problem: `Which center is equidistant from vertices?`, steps: [
                    { text: "Perpendicular bisectors → circumcenter", math: "Equidistant from vertices" },
                    { text: "Answer", math: "<strong>Circumcenter</strong>" }
                ]},
                keyPoints: [
                    "Circumcenter: equidistant from VERTICES (⊥ bisectors)",
                    "Incenter: equidistant from SIDES (angle bisectors)",
                    "Centroid: center of mass (medians, 2:1 ratio)"
                ],
                mistakes: [
                    { wrong: "Confusing incenter and circumcenter", why: "Incenter is equidistant from SIDES. Circumcenter from VERTICES." },
                    { wrong: "Thinking centroid is equidistant", why: "Centroid is the 'balance point', not equidistant from vertices." }
                ],
                guided: {
                    problem: `What triangle center is equidistant from all three sides?`,
                    steps: [
                        { label: "Equidistant from sides", value: "This is where angle bisectors meet" },
                        { label: "The center is called", value: "?" }
                    ],
                    answer: "incenter",
                    answerLabel: "Center: ",
                    interactiveSteps: [
                        {
                            prompt: "Angle bisectors meet at which triangle center?",
                            hint: "'In' refers to the inscribed circle...",
                            answer: "incenter",
                            acceptableAnswers: ["incenter", "in center", "the incenter"],
                            commonMistakes: {
                                "circumcenter": "Circumcenter is ⊥ bisectors. Angle bisectors meet at the INCENTER."
                            }
                        },
                        {
                            prompt: "The incenter is equidistant from what - the vertices or the sides?",
                            hint: "It's the center of the inscribed circle that touches all sides...",
                            answer: "sides",
                            acceptableAnswers: ["sides", "the sides"],
                            commonMistakes: {
                                "vertices": "That's the circumcenter! Incenter is equidistant from SIDES."
                            }
                        }
                    ]
                },
                practice: { problem: `Where do medians of a triangle meet?`, answer: "Centroid",
                    options: ["Centroid", "Circumcenter", "Incenter", "Orthocenter"],
                    mistakeAnalysis: {
                        "Circumcenter": "⊥ bisectors meet at circumcenter. Medians meet at CENTROID.",
                        "Incenter": "Angle bisectors meet at incenter. Medians meet at CENTROID.",
                        "Orthocenter": "Altitudes meet at orthocenter. Medians meet at CENTROID."
                    }}
            };
        },
        "Midsegments": () => {
            const base = rand(8, 16);
            const mid = base / 2;
            return {
                goalProblem: `A triangle has a base of 14 cm. What is the length of the midsegment parallel to it?`,
                teachingSteps: [
                    {
                        title: "What is a midsegment?",
                        explanation: "A <strong>midsegment</strong> connects the midpoints of two sides of a triangle.",
                        visual: "Midsegment = connects midpoints"
                    },
                    {
                        title: "Midsegment Theorem",
                        explanation: "A midsegment is: 1) <strong>Parallel</strong> to the third side, and 2) <strong>Half the length</strong> of the third side!",
                        visual: "Midsegment = ½ × third side"
                    },
                    {
                        title: "Apply the theorem",
                        explanation: "If the base is 14 cm, the midsegment parallel to it is 14 ÷ 2 = <strong>7 cm</strong>.",
                        visual: "14 ÷ 2 = 7 cm"
                    },
                    {
                        title: "The answer",
                        explanation: "The midsegment is <strong>7 cm</strong>.",
                        visual: "Midsegment = 7 cm"
                    }
                ],
                finalAnswer: "7 cm",
                answerExplanation: "By the Midsegment Theorem, the midsegment is half the length of the parallel side. 14 ÷ 2 = 7 cm.",
                example: { problem: `Midsegment parallel to 14 cm base`, steps: [
                    { text: "Midsegment = ½ × base", math: "14 ÷ 2" },
                    { text: "Answer", math: "<strong>7 cm</strong>" }
                ]},
                keyPoints: [
                    "Midsegment connects midpoints of two sides",
                    "Midsegment is parallel to the third side",
                    "Midsegment = ½ × (third side length)"
                ],
                mistakes: [
                    { wrong: "Doubling instead of halving", why: "Midsegment is HALF, not double. 14 ÷ 2 = 7 cm." },
                    { wrong: "Thinking midsegment equals the base", why: "Midsegment is exactly HALF the base length." }
                ],
                guided: {
                    problem: `A triangle has a base of ${base} cm. What is the midsegment parallel to it?`,
                    steps: [
                        { label: "Base length", value: base + " cm" },
                        { label: "Midsegment = ½ × base", value: "?" }
                    ],
                    answer: mid + " cm",
                    answerLabel: "Midsegment = ",
                    interactiveSteps: [
                        {
                            prompt: "A midsegment is what fraction of the parallel side?",
                            hint: "Half of the...",
                            answer: "half",
                            acceptableAnswers: ["half", "1/2", "½"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `${base} cm ÷ 2 = ?`,
                            hint: "Divide by 2...",
                            answer: String(mid),
                            acceptableAnswers: [String(mid), mid + " cm"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `The midsegment of a triangle is 9 cm. What is the length of the parallel base?`, answer: "18 cm",
                    options: ["18 cm", "4.5 cm", "9 cm", "27 cm"],
                    mistakeAnalysis: {
                        "4.5 cm": "That's half again! Base = 2 × midsegment = 18 cm.",
                        "9 cm": "Midsegment is half, so base = 2 × 9 = 18 cm.",
                        "27 cm": "Base = 2 × midsegment, not 3×. 2 × 9 = 18 cm."
                    }}
            };
        },
        "Inscribed Angles": () => {
            const arc = rand(40, 140);
            const inscribed = arc / 2;
            return {
                goalProblem: `An inscribed angle intercepts an arc of 80°. What is the inscribed angle?`,
                teachingSteps: [
                    {
                        title: "What is an inscribed angle?",
                        explanation: "An <strong>inscribed angle</strong> has its vertex ON the circle and its sides are chords.",
                        visual: "Vertex on circle, sides are chords"
                    },
                    {
                        title: "Inscribed Angle Theorem",
                        explanation: "An inscribed angle is <strong>HALF</strong> the measure of its intercepted arc.",
                        visual: "Inscribed angle = ½ × arc"
                    },
                    {
                        title: "Apply the theorem",
                        explanation: "If the arc is 80°, the inscribed angle is 80° ÷ 2 = <strong>40°</strong>.",
                        visual: "80° ÷ 2 = 40°"
                    },
                    {
                        title: "Compare to central angle",
                        explanation: "A central angle equals its arc. An inscribed angle is HALF its arc. So inscribed = ½ × central!",
                        visual: "Inscribed = 40°"
                    }
                ],
                finalAnswer: "40°",
                answerExplanation: "By the Inscribed Angle Theorem, the inscribed angle is half the intercepted arc. 80° ÷ 2 = 40°.",
                example: { problem: `Inscribed angle with 80° arc`, steps: [
                    { text: "Inscribed = ½ × arc", math: "80° ÷ 2" },
                    { text: "Answer", math: "<strong>40°</strong>" }
                ]},
                keyPoints: [
                    "Inscribed angle = ½ × intercepted arc",
                    "Central angle = intercepted arc",
                    "Inscribed angle = ½ × central angle (same arc)"
                ],
                mistakes: [
                    { wrong: "Doubling instead of halving", why: "Inscribed is HALF the arc, not double. 80° ÷ 2 = 40°" },
                    { wrong: "Confusing with central angle", why: "Central = arc. INSCRIBED = ½ arc." }
                ],
                guided: {
                    problem: `An inscribed angle intercepts an arc of ${arc}°. What is the inscribed angle?`,
                    steps: [
                        { label: "Arc measure", value: arc + "°" },
                        { label: "Inscribed = ½ × arc", value: "?" }
                    ],
                    answer: inscribed + "°",
                    answerLabel: "Inscribed angle = ",
                    interactiveSteps: [
                        {
                            prompt: "An inscribed angle is what fraction of its intercepted arc?",
                            hint: "Half of the...",
                            answer: "half",
                            acceptableAnswers: ["half", "1/2", "½"],
                            commonMistakes: {
                                "equal": "That's a CENTRAL angle! Inscribed = ½ × arc."
                            }
                        },
                        {
                            prompt: `${arc}° ÷ 2 = ?`,
                            hint: "Divide by 2...",
                            answer: String(inscribed),
                            acceptableAnswers: [String(inscribed), inscribed + "°"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `An inscribed angle is 35°. What is its intercepted arc?`, answer: "70°",
                    options: ["70°", "17.5°", "35°", "105°"],
                    mistakeAnalysis: {
                        "17.5°": "That's half again! Arc = 2 × inscribed = 70°",
                        "35°": "Arc = 2 × inscribed angle = 2 × 35 = 70°",
                        "105°": "Arc = 2 × inscribed, not 3×. 2 × 35 = 70°"
                    }}
            };
        },
        "Arc Length": () => {
            const r = rand(5, 10), angle = rand(60, 120);
            const arcLength = Math.round(2 * Math.PI * r * (angle / 360) * 100) / 100;
            return {
                goalProblem: `Find the arc length: radius = 6 cm, central angle = 90°`,
                teachingSteps: [
                    {
                        title: "What is arc length?",
                        explanation: "<strong>Arc length</strong> is the distance along a curved portion of a circle.",
                        visual: "Arc length = 'unrolled' piece of circle"
                    },
                    {
                        title: "The formula",
                        explanation: "Arc length = <strong>(θ/360°) × 2πr</strong> where θ is the central angle and r is the radius.",
                        visual: "L = (θ/360) × 2πr"
                    },
                    {
                        title: "Plug in values",
                        explanation: "L = (90/360) × 2π(6) = (1/4) × 12π = <strong>3π</strong> ≈ <strong>9.42 cm</strong>",
                        visual: "(90/360) × 12π = 3π ≈ 9.42 cm"
                    },
                    {
                        title: "The answer",
                        explanation: "Arc length = <strong>3π cm</strong> or approximately <strong>9.42 cm</strong>.",
                        visual: "L = 3π ≈ 9.42 cm"
                    }
                ],
                finalAnswer: "3π cm or 9.42 cm",
                answerExplanation: "Arc length = (θ/360) × 2πr = (90/360) × 2π(6) = ¼ × 12π = 3π ≈ 9.42 cm",
                example: { problem: `r = 6 cm, θ = 90°`, steps: [
                    { text: "Formula: L = (θ/360) × 2πr", math: "(90/360) × 2π(6)" },
                    { text: "Simplify", math: "(1/4) × 12π = 3π" },
                    { text: "Calculate", math: "<strong>≈ 9.42 cm</strong>" }
                ]},
                keyPoints: [
                    "Arc length = (θ/360) × 2πr",
                    "θ/360 gives the fraction of the circle",
                    "2πr is the full circumference"
                ],
                mistakes: [
                    { wrong: "Using diameter instead of radius", why: "Use RADIUS in the formula. If given diameter, divide by 2." },
                    { wrong: "Forgetting to multiply by 2πr", why: "Arc length = (θ/360) × 2πr. Don't forget the circumference part!" },
                    { wrong: "Using θ without dividing by 360", why: "Must use θ/360 to get the fraction of the circle." }
                ],
                guided: {
                    problem: `Find the arc length: radius = ${r} cm, central angle = ${angle}°`,
                    steps: [
                        { label: "Formula", value: "L = (θ/360) × 2πr" },
                        { label: "Fraction of circle", value: angle + "/360" },
                        { label: "Arc length", value: "?" }
                    ],
                    answer: String(arcLength) + " cm",
                    answerLabel: "Arc length ≈ ",
                    interactiveSteps: [
                        {
                            prompt: `What fraction of the circle is ${angle}°? Express as a simplified fraction or decimal.`,
                            hint: angle + "/360 = ?",
                            answer: String(Math.round(angle/360 * 100) / 100),
                            acceptableAnswers: [String(Math.round(angle/360 * 100) / 100), angle + "/360"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `What is the full circumference? C = 2π(${r}) = ?`,
                            hint: "2 × π × " + r,
                            answer: String(2 * r) + "π",
                            acceptableAnswers: [String(2 * r) + "π", String(2 * r) + "pi", String(Math.round(2 * Math.PI * r * 100) / 100)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Arc length with r = 10 cm and θ = 36°. What is L?`, answer: "2π cm",
                    options: ["2π cm", "π cm", "10π cm", "20π cm"],
                    mistakeAnalysis: {
                        "π cm": "(36/360) × 20π = (1/10) × 20π = 2π, not π",
                        "10π cm": "That's half the circumference (180°). 36° is 1/10 of 360°.",
                        "20π cm": "That's the full circumference. Arc = (36/360) × 20π = 2π"
                    }}
            };
        },
        "Sector Area": () => {
            const r = rand(4, 8), angle = rand(60, 120);
            const area = Math.round(Math.PI * r * r * (angle / 360) * 100) / 100;
            return {
                goalProblem: `Find the sector area: radius = 6 cm, central angle = 90°`,
                teachingSteps: [
                    {
                        title: "What is a sector?",
                        explanation: "A <strong>sector</strong> is a 'pie slice' of a circle - the region between two radii and an arc.",
                        visual: "Sector = pie slice of circle"
                    },
                    {
                        title: "The formula",
                        explanation: "Sector area = <strong>(θ/360°) × πr²</strong> where θ is the central angle.",
                        visual: "A = (θ/360) × πr²"
                    },
                    {
                        title: "Plug in values",
                        explanation: "A = (90/360) × π(6)² = (1/4) × 36π = <strong>9π</strong> ≈ <strong>28.27 cm²</strong>",
                        visual: "(1/4) × 36π = 9π ≈ 28.27 cm²"
                    },
                    {
                        title: "The answer",
                        explanation: "Sector area = <strong>9π cm²</strong> or approximately <strong>28.27 cm²</strong>.",
                        visual: "A = 9π ≈ 28.27 cm²"
                    }
                ],
                finalAnswer: "9π cm² or 28.27 cm²",
                answerExplanation: "Sector area = (θ/360) × πr² = (90/360) × 36π = ¼ × 36π = 9π ≈ 28.27 cm²",
                example: { problem: `r = 6 cm, θ = 90°`, steps: [
                    { text: "Formula: A = (θ/360) × πr²", math: "(90/360) × π(6)²" },
                    { text: "Simplify", math: "(1/4) × 36π = 9π" },
                    { text: "Calculate", math: "<strong>≈ 28.27 cm²</strong>" }
                ]},
                keyPoints: [
                    "Sector area = (θ/360) × πr²",
                    "θ/360 gives the fraction of the circle",
                    "πr² is the total circle area"
                ],
                mistakes: [
                    { wrong: "Using circumference formula instead of area", why: "Area uses πr², not 2πr (that's circumference)." },
                    { wrong: "Forgetting to square the radius", why: "It's πr², not πr. Square the radius!" },
                    { wrong: "Using diameter instead of radius", why: "Use RADIUS. If given diameter, divide by 2 first." }
                ],
                guided: {
                    problem: `Find the sector area: radius = ${r} cm, central angle = ${angle}°`,
                    steps: [
                        { label: "Formula", value: "A = (θ/360) × πr²" },
                        { label: "Circle area πr²", value: "π(" + r + ")² = " + (r*r) + "π" },
                        { label: "Sector area", value: "?" }
                    ],
                    answer: String(area) + " cm²",
                    answerLabel: "Sector area ≈ ",
                    interactiveSteps: [
                        {
                            prompt: `What is the full circle area? πr² = π(${r})² = ?`,
                            hint: r + "² = " + (r*r),
                            answer: String(r*r) + "π",
                            acceptableAnswers: [String(r*r) + "π", String(r*r) + "pi", String(Math.round(Math.PI * r * r * 100) / 100)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `The sector is ${angle}/360 of the circle. Multiply: (${angle}/360) × ${r*r}π = ?`,
                            hint: "Find the fraction and multiply...",
                            answer: String(Math.round(r*r * angle / 360 * 100) / 100) + "π",
                            acceptableAnswers: [String(Math.round(r*r * angle / 360 * 100) / 100) + "π", String(area)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Sector area with r = 10 cm and θ = 36°. What is A?`, answer: "10π cm²",
                    options: ["10π cm²", "100π cm²", "36π cm²", "π cm²"],
                    mistakeAnalysis: {
                        "100π cm²": "That's the full circle area. Sector = (36/360) × 100π = 10π",
                        "36π cm²": "You used the angle as area. A = (36/360) × 100π = 10π",
                        "π cm²": "(36/360) × 100π = 10π, not π"
                    }}
            };
        },
        "Tangent Lines": () => {
            const r = rand(4, 10);
            return {
                goalProblem: `A tangent line touches a circle at point P. What is the angle between the tangent and the radius to P?`,
                teachingSteps: [
                    {
                        title: "What is a tangent line?",
                        explanation: "A <strong>tangent line</strong> touches a circle at exactly ONE point, called the point of tangency.",
                        visual: "Tangent = touches at exactly 1 point"
                    },
                    {
                        title: "The key property",
                        explanation: "A tangent is always <strong>PERPENDICULAR</strong> (90°) to the radius at the point of tangency!",
                        visual: "Tangent ⊥ radius at point of tangency"
                    },
                    {
                        title: "Why 90°?",
                        explanation: "The radius to the point of tangency is the shortest distance from center to line - and shortest distance is always perpendicular.",
                        visual: "90° angle always!"
                    },
                    {
                        title: "The answer",
                        explanation: "The angle between the tangent and radius is always <strong>90°</strong>.",
                        visual: "Angle = 90°"
                    }
                ],
                finalAnswer: "90°",
                answerExplanation: "A tangent line is always perpendicular to the radius at the point of tangency. The angle is 90°.",
                example: { problem: `Angle between tangent and radius`, steps: [
                    { text: "Key property", math: "Tangent ⊥ radius" },
                    { text: "Therefore", math: "<strong>Angle = 90°</strong>" }
                ]},
                keyPoints: [
                    "Tangent touches circle at exactly ONE point",
                    "Tangent is PERPENDICULAR to radius at point of tangency",
                    "Two tangents from external point are equal in length"
                ],
                mistakes: [
                    { wrong: "Thinking the angle varies", why: "It's ALWAYS 90°, regardless of where on the circle." },
                    { wrong: "Confusing tangent with secant", why: "Tangent touches at 1 point. Secant crosses at 2 points." }
                ],
                guided: {
                    problem: `A radius of length ${r} meets a tangent at point T. What angle do they form?`,
                    steps: [
                        { label: "Tangent-radius relationship", value: "Always perpendicular" },
                        { label: "Angle", value: "?" }
                    ],
                    answer: "90°",
                    answerLabel: "Angle = ",
                    interactiveSteps: [
                        {
                            prompt: "A tangent and radius at the point of tangency are always what?",
                            hint: "They form a specific angle...",
                            answer: "perpendicular",
                            acceptableAnswers: ["perpendicular", "90°", "90 degrees"],
                            commonMistakes: {
                                "parallel": "Tangent and radius are PERPENDICULAR (90°), not parallel!"
                            }
                        },
                        {
                            prompt: "What is the measure of this angle?",
                            hint: "Perpendicular means...",
                            answer: "90°",
                            acceptableAnswers: ["90°", "90", "90 degrees"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Two tangent segments from point P to a circle are drawn. If one is 8 cm, what is the other?`, answer: "8 cm",
                    options: ["8 cm", "16 cm", "4 cm", "Cannot tell"],
                    mistakeAnalysis: {
                        "16 cm": "Two tangents from an external point are EQUAL, not double.",
                        "4 cm": "Two tangents from an external point are EQUAL, not half.",
                        "Cannot tell": "We can tell! Two tangents from external point are always equal: 8 cm."
                    }}
            };
        },
        "Dilations": () => {
            const scale = rand(2, 4);
            const orig = rand(3, 6);
            const dilated = orig * scale;
            return {
                goalProblem: `A segment of 5 cm is dilated with scale factor 3. What is the new length?`,
                teachingSteps: [
                    {
                        title: "What is a dilation?",
                        explanation: "A <strong>dilation</strong> is a transformation that enlarges or shrinks a figure by a <strong>scale factor</strong> from a center point.",
                        visual: "Dilation = resize by scale factor"
                    },
                    {
                        title: "Scale factor effects",
                        explanation: "• Scale factor > 1: <strong>enlargement</strong><br>• Scale factor < 1: <strong>reduction</strong><br>• Scale factor = 1: same size",
                        visual: "k > 1: bigger | k < 1: smaller"
                    },
                    {
                        title: "Apply the scale factor",
                        explanation: "New length = original × scale factor. 5 cm × 3 = <strong>15 cm</strong>",
                        visual: "5 × 3 = 15 cm"
                    },
                    {
                        title: "Important: angles stay the same!",
                        explanation: "Dilations change SIZE but preserve SHAPE. All angles remain the same; sides are proportional.",
                        visual: "15 cm (angles unchanged)"
                    }
                ],
                finalAnswer: "15 cm",
                answerExplanation: "Dilation multiplies lengths by the scale factor. 5 cm × 3 = 15 cm.",
                example: { problem: `5 cm dilated by factor of 3`, steps: [
                    { text: "New length = original × scale factor", math: "5 × 3" },
                    { text: "Answer", math: "<strong>15 cm</strong>" }
                ]},
                keyPoints: [
                    "New length = original × scale factor",
                    "Dilations preserve shape (angles same, sides proportional)",
                    "k > 1 enlarges, k < 1 reduces"
                ],
                mistakes: [
                    { wrong: "Dividing instead of multiplying (for enlargement)", why: "Scale factor 3 means MULTIPLY by 3. 5 × 3 = 15 cm." },
                    { wrong: "Thinking angles change", why: "Dilations preserve all angles! Only lengths change." },
                    { wrong: "Adding the scale factor", why: "MULTIPLY by scale factor, don't add. 5 × 3 = 15, not 5 + 3 = 8." }
                ],
                guided: {
                    problem: `A segment of ${orig} cm is dilated with scale factor ${scale}. What is the new length?`,
                    steps: [
                        { label: "Original length", value: orig + " cm" },
                        { label: "Scale factor", value: scale },
                        { label: "New length = original × scale", value: "?" }
                    ],
                    answer: dilated + " cm",
                    answerLabel: "New length = ",
                    interactiveSteps: [
                        {
                            prompt: `Scale factor ${scale} is greater than 1. Is this an enlargement or reduction?`,
                            hint: "k > 1 means...",
                            answer: "enlargement",
                            acceptableAnswers: ["enlargement", "enlarge", "bigger"],
                            commonMistakes: {
                                "reduction": "Scale factor > 1 means ENLARGEMENT (bigger)."
                            }
                        },
                        {
                            prompt: `${orig} cm × ${scale} = ?`,
                            hint: "Multiply...",
                            answer: String(dilated),
                            acceptableAnswers: [String(dilated), dilated + " cm"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A triangle is dilated by scale factor 0.5. If one side was 12 cm, what is it now?`, answer: "6 cm",
                    options: ["6 cm", "24 cm", "12 cm", "0.5 cm"],
                    mistakeAnalysis: {
                        "24 cm": "Scale factor 0.5 means divide by 2 (or multiply by 0.5). 12 × 0.5 = 6 cm",
                        "12 cm": "Must multiply by scale factor. 12 × 0.5 = 6 cm",
                        "0.5 cm": "Multiply, not replace! 12 × 0.5 = 6 cm"
                    }}
            };
        }
    },
    7: {
        Quadratics: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Solving by Factoring
                (() => {
                    // Create factorable quadratics with positive roots
                    const r1 = rand(1, 5), r2 = rand(1, 5);
                    const b = r1 + r2, c = r1 * r2;
                    // Practice with different roots
                    const pr1 = rand(2, 6), pr2 = rand(1, 4);
                    const pb = pr1 + pr2, pc = pr1 * pr2;
                    return {
                        id: "solve",
                        name: "Solve by Factoring",
                        goalProblem: `Solve: x² + 5x + 6 = 0`,
                        teachingSteps: [
                            {
                                title: "What is a Quadratic Equation?",
                                explanation: "A <strong>quadratic equation</strong> has the form:<br><br><strong>ax² + bx + c = 0</strong><br><br>The highest power of x is 2 (that's what makes it quadratic!).",
                                visual: "ax² + bx + c = 0"
                            },
                            {
                                title: "The Factoring Strategy",
                                explanation: "For x² + bx + c = 0, find two numbers that:<br><br>• <strong>MULTIPLY</strong> to give c<br>• <strong>ADD</strong> to give b<br><br>Then write: (x + p)(x + q) = 0",
                                visual: "p × q = c AND p + q = b"
                            },
                            {
                                title: "Step 1: Identify b and c",
                                explanation: "In <strong>x² + 5x + 6 = 0</strong>:<br><br>b = 5 (coefficient of x)<br>c = 6 (constant term)",
                                visual: "b = 5, c = 6"
                            },
                            {
                                title: "Step 2: Find the Numbers",
                                explanation: "What multiplies to 6 AND adds to 5?<br><br>2 × 3 = 6 ✓<br>2 + 3 = 5 ✓<br><br>Numbers: <strong>2 and 3</strong>",
                                visual: "2 × 3 = 6, 2 + 3 = 5 → Use 2 and 3"
                            },
                            {
                                title: "Step 3: Factor",
                                explanation: "x² + 5x + 6 = <strong>(x + 2)(x + 3) = 0</strong>",
                                visual: "(x + 2)(x + 3) = 0"
                            },
                            {
                                title: "Step 4: Zero Product Property",
                                explanation: "If AB = 0, then A = 0 or B = 0<br><br>x + 2 = 0 → <strong>x = -2</strong><br>x + 3 = 0 → <strong>x = -3</strong>",
                                visual: "x = -2 or x = -3"
                            }
                        ],
                        finalAnswer: "x = -2 or x = -3",
                        answerExplanation: "Factor to (x + 2)(x + 3) = 0, then solve each factor.",
                        example: { problem: `Solve: x² + 5x + 6 = 0`, steps: [
                            { text: "Find numbers: multiply to 6, add to 5", math: "2 and 3" },
                            { text: "Factor", math: "(x + 2)(x + 3) = 0" },
                            { text: "Solve each factor", math: "<strong>x = -2 or x = -3</strong>" }
                        ]},
                        keyPoints: [
                            "Find two numbers that multiply to c and add to b",
                            "Zero Product Property: if AB = 0, then A = 0 or B = 0",
                            "Watch signs carefully when solving!"
                        ],
                        mistakes: [
                            { wrong: "(x + 2)(x + 3) = 0 → x = 2, 3", why: "Wrong signs! x + 2 = 0 means x = -2" },
                            { wrong: "Adding instead of multiplying", why: "The numbers must MULTIPLY to c and ADD to b" }
                        ],
                        guided: {
                            problem: `Solve: x² + ${b}x + ${c} = 0`,
                            steps: [
                                { label: "Numbers that multiply to " + c, value: `${r1} × ${r2} = ${c}` },
                                { label: "...and add to " + b, value: `${r1} + ${r2} = ${b}` },
                                { label: "Solutions", value: "?" }
                            ],
                            answer: `x = -${r1}, x = -${r2}`,
                            answerLabel: "x = ?",
                            interactiveSteps: [
                                {
                                    prompt: `Find two numbers that multiply to ${c} and add to ${b}:`,
                                    hint: `Think of factor pairs of ${c}...`,
                                    answer: `${r1} and ${r2}`,
                                    acceptableAnswers: [`${r1} and ${r2}`, `${r2} and ${r1}`, `${r1}, ${r2}`, `${r2}, ${r1}`],
                                    commonMistakes: {
                                        [`${r1} and ${b}`]: `${r1} × ${b} ≠ ${c}. Try ${r1} × ${r2} = ${c}`
                                    }
                                },
                                {
                                    prompt: `Write in factored form: (x + ?)(x + ?) = 0`,
                                    hint: `Use the numbers ${r1} and ${r2}`,
                                    answer: `(x + ${r1})(x + ${r2})`,
                                    acceptableAnswers: [`(x + ${r1})(x + ${r2})`, `(x+${r1})(x+${r2})`, `(x + ${r2})(x + ${r1})`],
                                    commonMistakes: {
                                        [`(x - ${r1})(x - ${r2})`]: `Use + signs: (x + ${r1})(x + ${r2})`
                                    }
                                },
                                {
                                    prompt: `If x + ${r1} = 0, what is x?`,
                                    hint: `Subtract ${r1} from both sides`,
                                    answer: `-${r1}`,
                                    acceptableAnswers: [`-${r1}`, `x = -${r1}`],
                                    commonMistakes: {
                                        [String(r1)]: `Subtract! x + ${r1} = 0 → x = -${r1}`
                                    }
                                },
                                {
                                    prompt: `If x + ${r2} = 0, what is x?`,
                                    hint: `Subtract ${r2} from both sides`,
                                    answer: `-${r2}`,
                                    acceptableAnswers: [`-${r2}`, `x = -${r2}`],
                                    commonMistakes: {
                                        [String(r2)]: `Subtract! x + ${r2} = 0 → x = -${r2}`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Solve: (x - ${pr1})(x + ${pr2}) = 0`, answer: `x = ${pr1}, x = -${pr2}`,
                            options: shuffle([`x = ${pr1}, x = -${pr2}`, `x = -${pr1}, x = ${pr2}`, `x = ${pr1}, x = ${pr2}`, `x = -${pr1}, x = -${pr2}`]),
                            mistakeAnalysis: {
                                [`x = -${pr1}, x = ${pr2}`]: `Signs flipped! x - ${pr1} = 0 → x = ${pr1}; x + ${pr2} = 0 → x = -${pr2}`,
                                [`x = ${pr1}, x = ${pr2}`]: `x + ${pr2} = 0 means x = -${pr2}, not x = ${pr2}`,
                                [`x = -${pr1}, x = -${pr2}`]: `x - ${pr1} = 0 means x = ${pr1}, not x = -${pr1}`
                            }}
                    };
                })(),

                // Sub-skill 2: Finding the Vertex
                (() => {
                    const h = rand(1, 5), k = rand(-4, 4);
                    // Practice vertex
                    const ph = rand(2, 6), pk = rand(-3, 5);
                    return {
                        id: "vertex",
                        name: "Finding the Vertex",
                        goalProblem: `Find the vertex of the parabola y = (x - 3)² + 2`,
                        teachingSteps: [
                            {
                                title: "What is the Vertex?",
                                explanation: "The <strong>vertex</strong> is the <strong>highest or lowest point</strong> on a parabola.<br><br>It's the turning point where the curve changes direction!",
                                visual: "Vertex = turning point (minimum or maximum)"
                            },
                            {
                                title: "Vertex Form",
                                explanation: "When a parabola is in <strong>vertex form</strong>:<br><br><strong>y = a(x - h)² + k</strong><br><br>The vertex is at <strong>(h, k)</strong>!",
                                visual: "y = a(x - h)² + k → Vertex at (h, k)"
                            },
                            {
                                title: "The Sign Trick",
                                explanation: "Notice: y = (x - h)² has a <strong>MINUS</strong> sign!<br><br>So if you see y = (x - 3)²:<br>h = 3 (the opposite of -3)<br><br>If you see y = (x + 3)²:<br>h = -3 (because x + 3 = x - (-3))",
                                visual: "(x - 3) → h = 3 | (x + 3) → h = -3"
                            },
                            {
                                title: "Finding h",
                                explanation: "In y = (x - 3)² + 2:<br><br>We have (x - 3), so <strong>h = 3</strong>",
                                visual: "(x - 3)² → h = 3"
                            },
                            {
                                title: "Finding k",
                                explanation: "The k value is just the number added at the end:<br><br>y = (x - 3)² + 2<br><br><strong>k = 2</strong>",
                                visual: "+ 2 → k = 2"
                            },
                            {
                                title: "The Vertex",
                                explanation: "Vertex = (h, k) = <strong>(3, 2)</strong>",
                                visual: "Vertex: (3, 2)"
                            }
                        ],
                        finalAnswer: "(3, 2)",
                        answerExplanation: "From vertex form y = (x - 3)² + 2, vertex is (h, k) = (3, 2)",
                        example: { problem: `Vertex of y = (x - 3)² + 2`, steps: [
                            { text: "Identify form", math: "y = (x - h)² + k" },
                            { text: "Find h from (x - 3)", math: "h = 3" },
                            { text: "Find k", math: "k = 2" },
                            { text: "Write vertex", math: "<strong>(3, 2)</strong>" }
                        ]},
                        keyPoints: [
                            "Vertex form: y = a(x - h)² + k → vertex at (h, k)",
                            "h is OPPOSITE the sign in (x ± h)",
                            "k is the constant term at the end"
                        ],
                        mistakes: [
                            { wrong: "y = (x - 3)² → vertex at (-3, k)", why: "It's the OPPOSITE! (x - 3) means h = +3" },
                            { wrong: "Confusing (h, k) order", why: "Vertex is always (h, k) - x-coordinate first!" }
                        ],
                        guided: {
                            problem: `Find the vertex of y = (x - ${h})² + ${k}`,
                            steps: [
                                { label: "From (x - " + h + ")", value: "h = ?" },
                                { label: "From + " + k, value: "k = ?" },
                                { label: "Vertex", value: "?" }
                            ],
                            answer: `(${h}, ${k})`,
                            answerLabel: "Vertex:",
                            interactiveSteps: [
                                {
                                    prompt: `In (x - ${h})², what is h?`,
                                    hint: `h is the opposite of what's after the minus sign`,
                                    answer: String(h),
                                    acceptableAnswers: [String(h), `h = ${h}`],
                                    commonMistakes: {
                                        [String(-h)]: `The sign flips! (x - ${h}) means h = +${h}`
                                    }
                                },
                                {
                                    prompt: `The equation ends with + ${k}. What is k?`,
                                    hint: `k is just the constant at the end`,
                                    answer: String(k),
                                    acceptableAnswers: [String(k), `k = ${k}`],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Write the vertex as (h, k):`,
                                    hint: `Put h and k together as an ordered pair`,
                                    answer: `(${h}, ${k})`,
                                    acceptableAnswers: [`(${h}, ${k})`, `(${h},${k})`],
                                    commonMistakes: {
                                        [`(${k}, ${h})`]: `x-coordinate (h) comes first! Vertex = (${h}, ${k})`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Vertex of y = (x + ${ph})² - ${pk}?`, answer: `(-${ph}, -${pk})`,
                            options: shuffle([`(-${ph}, -${pk})`, `(${ph}, -${pk})`, `(-${ph}, ${pk})`, `(${ph}, ${pk})`]),
                            mistakeAnalysis: {
                                [`(${ph}, -${pk})`]: `(x + ${ph}) = (x - (-${ph})), so h = -${ph}. Vertex = (-${ph}, -${pk})`,
                                [`(-${ph}, ${pk})`]: `It says -${pk}, so k = -${pk}, not +${pk}`,
                                [`(${ph}, ${pk})`]: `Both signs are wrong! h = -${ph} and k = -${pk}`
                            }}
                    };
                })(),

                // Sub-skill 3: Parabola Direction
                (() => {
                    const aPos = rand(1, 3);
                    const aNeg = -rand(1, 3);
                    return {
                        id: "graph",
                        name: "Parabola Direction",
                        goalProblem: `Does y = -2x² + 3x - 1 open up or down?`,
                        teachingSteps: [
                            {
                                title: "Parabola Shape",
                                explanation: "A <strong>parabola</strong> is a U-shaped curve.<br><br>It can open <strong>UP</strong> (like a smile) or <strong>DOWN</strong> (like a frown).",
                                visual: "∪ opens up | ∩ opens down"
                            },
                            {
                                title: "Standard Form",
                                explanation: "The standard form is: <strong>y = ax² + bx + c</strong><br><br>The coefficient <strong>a</strong> (in front of x²) tells us the direction!",
                                visual: "y = ax² + bx + c"
                            },
                            {
                                title: "The Rule",
                                explanation: "<strong>If a > 0</strong> (positive): Opens <strong>UP</strong> ∪<br><br><strong>If a < 0</strong> (negative): Opens <strong>DOWN</strong> ∩",
                                visual: "a > 0 → UP ∪ | a < 0 → DOWN ∩"
                            },
                            {
                                title: "Find a in Our Problem",
                                explanation: "In y = <strong>-2</strong>x² + 3x - 1:<br><br>a = <strong>-2</strong>",
                                visual: "a = -2"
                            },
                            {
                                title: "Apply the Rule",
                                explanation: "Since a = -2 is <strong>NEGATIVE</strong>:<br><br>The parabola opens <strong>DOWN</strong> ∩",
                                visual: "-2 < 0 → Opens DOWN ∩"
                            }
                        ],
                        finalAnswer: "down",
                        answerExplanation: "a = -2 is negative, so the parabola opens down.",
                        example: { problem: `Direction of y = -2x² + 3x - 1`, steps: [
                            { text: "Find a (coefficient of x²)", math: "a = -2" },
                            { text: "Check if positive or negative", math: "-2 < 0 (negative)" },
                            { text: "Apply rule", math: "<strong>Opens DOWN</strong>" }
                        ]},
                        keyPoints: [
                            "a > 0 (positive) → opens UP",
                            "a < 0 (negative) → opens DOWN",
                            "Only the x² coefficient matters for direction!"
                        ],
                        mistakes: [
                            { wrong: "Looking at b or c instead of a", why: "Only the coefficient of x² (a) determines direction" },
                            { wrong: "Confusing positive/negative with up/down", why: "Positive a = UP, Negative a = DOWN" }
                        ],
                        guided: {
                            problem: `Does y = ${aPos}x² - 4x + 5 open up or down?`,
                            steps: [
                                { label: "Coefficient of x²", value: `a = ${aPos}` },
                                { label: "Positive or negative?", value: "positive" },
                                { label: "Direction", value: "?" }
                            ],
                            answer: "up",
                            answerLabel: "Opens:",
                            interactiveSteps: [
                                {
                                    prompt: `What is the coefficient of x² in ${aPos}x² - 4x + 5?`,
                                    hint: `The number in front of x²`,
                                    answer: String(aPos),
                                    acceptableAnswers: [String(aPos), `a = ${aPos}`],
                                    commonMistakes: {
                                        "-4": "That's the coefficient of x (b). We need the x² coefficient (a).",
                                        "5": "That's c (the constant). We need a (the x² coefficient)."
                                    }
                                },
                                {
                                    prompt: `Is ${aPos} positive or negative?`,
                                    hint: `Is it greater than or less than 0?`,
                                    answer: "positive",
                                    acceptableAnswers: ["positive", "pos", "+", "> 0"],
                                    commonMistakes: {
                                        "negative": `${aPos} > 0, so it's positive!`
                                    }
                                },
                                {
                                    prompt: `Since a is positive, does the parabola open up or down?`,
                                    hint: `Positive a means...`,
                                    answer: "up",
                                    acceptableAnswers: ["up", "opens up", "upward", "upwards"],
                                    commonMistakes: {
                                        "down": "Positive a = UP! (Think: positive = happy = smile shape ∪)"
                                    }
                                }
                            ]
                        },
                        practice: { problem: `Does y = ${aNeg}x² + x + 3 open up or down?`, answer: "down",
                            options: ["down", "up", "left", "right"],
                            mistakeAnalysis: {
                                "up": `a = ${aNeg} is NEGATIVE, so it opens DOWN, not up!`,
                                "left": "Parabolas open up or down (vertical), not left or right.",
                                "right": "Parabolas open up or down (vertical), not left or right."
                            }}
                    };
                })()
            ]
        }),
        "Completing the Square": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Rewriting in Vertex Form
                (() => {
                    const h = rand(2, 5), k = rand(1, 8), b = 2 * h, c = h * h + k;
                    return {
                        id: "rewrite", name: "Rewrite in Vertex Form",
                        goalProblem: `Rewrite x² + 6x + 5 in vertex form by completing the square`,
                        teachingSteps: [
                            { title: "What is Completing the Square?", explanation: "<strong>Completing the square</strong> rewrites a quadratic in <strong>vertex form</strong>:<br><br>x² + bx + c → <strong>(x + h)² + k</strong>", visual: "Standard → Vertex form" },
                            { title: "The Key Formula", explanation: "For x² + bx:<br>1. Take half of b: b/2<br>2. Square it: (b/2)²<br>3. Add and subtract this value", visual: "x² + bx + (b/2)² = (x + b/2)²" },
                            { title: "Example: x² + 6x + 5", explanation: "b = 6, so (b/2)² = 3² = 9<br>x² + 6x + 9 - 9 + 5<br>= (x + 3)² - 4", visual: "(x + 3)² - 4" }
                        ],
                        finalAnswer: "(x + 3)² - 4",
                        example: { problem: `Rewrite x² + 6x + 5`, steps: [{ text: "b/2", math: "6/2 = 3" }, { text: "Square", math: "3² = 9" }, { text: "Result", math: "(x + 3)² - 4" }]},
                        keyPoints: ["Take half of b and square it", "Add and subtract to keep expression equal"],
                        mistakes: [{ wrong: "Forgetting to subtract", why: "Must subtract what you added!" }, { wrong: "Using b instead of b/2", why: "Take HALF first!" }],
                        guided: { problem: `Rewrite x² + ${b}x + ${c} in vertex form`, steps: [{ label: "Half of " + b, value: String(h) }, { label: "Squared", value: String(h*h) }], answer: `(x + ${h})² + ${k}`, answerLabel: "Vertex form:",
                            interactiveSteps: [
                                { prompt: `What is b (coefficient of x)?`, hint: "Number in front of x", answer: String(b), acceptableAnswers: [String(b)], commonMistakes: {} },
                                { prompt: `What is half of ${b}?`, hint: `${b} ÷ 2`, answer: String(h), acceptableAnswers: [String(h)], commonMistakes: { [String(b)]: `Half of ${b} is ${h}` } },
                                { prompt: `What is ${h}²?`, hint: `${h} × ${h}`, answer: String(h*h), acceptableAnswers: [String(h*h)], commonMistakes: {} },
                                { prompt: `What is ${c} - ${h*h}? (the k value)`, hint: "Subtract", answer: String(k), acceptableAnswers: [String(k)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Complete the square: x² + 8x + 10`, answer: "(x + 4)² - 6", options: ["(x + 4)² - 6", "(x + 8)² + 10", "(x + 4)² + 10", "(x + 4)² + 6"],
                            mistakeAnalysis: { "(x + 8)² + 10": "Use b/2 = 4, not b = 8", "(x + 4)² + 10": "Need to subtract 16: 10 - 16 = -6", "(x + 4)² + 6": "10 - 16 = -6, not +6" }}
                    };
                })(),
                // Sub-skill 2: Solving by Completing the Square
                (() => {
                    const r = rand(2, 6), b = 2 * r, c = r * r;
                    const pr = rand(1, 5), pb = 2 * pr, pc = pr * pr;
                    return {
                        id: "solve", name: "Solve by Completing Square",
                        goalProblem: `Solve x² - 6x + 9 = 0 by completing the square`,
                        teachingSteps: [
                            { title: "Why Solve This Way?", explanation: "Completing the square works for ANY quadratic, even ones that don't factor nicely!", visual: "Universal solving method" },
                            { title: "Recognize Perfect Squares", explanation: "x² - 6x + 9 = (x - 3)²<br>Check: (x - 3)² = x² - 6x + 9 ✓", visual: "(x - 3)² = 0" },
                            { title: "Solve", explanation: "(x - 3)² = 0<br>x - 3 = 0<br>x = 3", visual: "x = 3" }
                        ],
                        finalAnswer: "x = 3",
                        example: { problem: `Solve x² - 6x + 9 = 0`, steps: [{ text: "Factor", math: "(x - 3)² = 0" }, { text: "Take root", math: "x - 3 = 0" }, { text: "Solve", math: "x = 3" }]},
                        keyPoints: ["Rewrite as (x - r)² = k", "Take square root of both sides", "Remember ± when k > 0"],
                        mistakes: [{ wrong: "Forgetting ±", why: "√k gives both + and - solutions (unless k = 0)" }],
                        guided: { problem: `Solve x² - ${b}x + ${c} = 0`, steps: [{ label: "Factor", value: `(x - ${r})² = 0` }, { label: "Solution", value: "?" }], answer: String(r), answerLabel: "x =",
                            interactiveSteps: [
                                { prompt: `x² - ${b}x + ${c} is a perfect square. It equals (x - ?)²`, hint: `Half of ${b} is ${r}`, answer: String(r), acceptableAnswers: [String(r), `(x - ${r})`, `(x-${r})`], commonMistakes: {} },
                                { prompt: `(x - ${r})² = 0. What is x?`, hint: "If (x - r)² = 0, then x - r = 0", answer: String(r), acceptableAnswers: [String(r), `x = ${r}`, `x=${r}`], commonMistakes: { [String(-r)]: `(x - ${r})² = 0 means x = ${r}` } }
                            ]
                        },
                        practice: { problem: `Solve x² - ${pb}x + ${pc} = 0 by completing the square`, answer: String(pr), options: [String(pr), String(-pr), String(pr*2), "0"],
                            mistakeAnalysis: { [String(-pr)]: `(x - ${pr})² = 0, so x = ${pr}`, [String(pr*2)]: `Half of ${pb} is ${pr}, not ${pb}`, "0": "The solution is where x - r = 0" }}
                    };
                })(),
                // Sub-skill 3: Finding Vertex from Vertex Form
                (() => {
                    const h = rand(1, 6), k = rand(-5, 5);
                    const ph = rand(1, 5), pk = rand(-4, 4);
                    return {
                        id: "vertex", name: "Find Vertex from Form",
                        goalProblem: `Find the vertex of y = (x - 3)² + 2`,
                        teachingSteps: [
                            { title: "Vertex Form", explanation: "y = (x - h)² + k<br><br>The vertex is at <strong>(h, k)</strong>", visual: "Vertex form → Vertex at (h, k)" },
                            { title: "Reading the Vertex", explanation: "y = (x - 3)² + 2<br><br>Compare: y = (x - h)² + k<br>h = 3, k = 2<br>Vertex: <strong>(3, 2)</strong>", visual: "(3, 2)" },
                            { title: "Watch the Signs!", explanation: "(x - 3) means h = 3 (positive)<br>(x + 3) means h = -3 (negative)<br><br>The sign inside is OPPOSITE of h", visual: "(x - h) → h is positive" }
                        ],
                        finalAnswer: "(3, 2)",
                        example: { problem: `Vertex of y = (x - 3)² + 2`, steps: [{ text: "Identify", math: "h = 3, k = 2" }, { text: "Vertex", math: "(3, 2)" }]},
                        keyPoints: ["Vertex form: y = (x - h)² + k", "Vertex is at (h, k)", "Watch sign: (x - h) means positive h"],
                        mistakes: [{ wrong: "Wrong sign for h", why: "(x - 3) means h = +3, not -3" }, { wrong: "Swapping h and k", why: "Vertex is (h, k), not (k, h)" }],
                        guided: { problem: `Find the vertex of y = (x - ${h})² + ${k}`, steps: [{ label: "h", value: String(h) }, { label: "k", value: String(k) }], answer: `(${h}, ${k})`, answerLabel: "Vertex:",
                            interactiveSteps: [
                                { prompt: `In (x - ${h})², what is h?`, hint: "The number being subtracted from x", answer: String(h), acceptableAnswers: [String(h)], commonMistakes: { [String(-h)]: `(x - ${h}) means h = ${h} (positive)` } },
                                { prompt: `What is k?`, hint: "The constant added at the end", answer: String(k), acceptableAnswers: [String(k)], commonMistakes: {} },
                                { prompt: `What is the vertex?`, hint: "(h, k)", answer: `(${h}, ${k})`, acceptableAnswers: [`(${h}, ${k})`, `(${h},${k})`], commonMistakes: { [`(${k}, ${h})`]: "Vertex is (h, k), not (k, h)" } }
                            ]
                        },
                        practice: { problem: `What is the vertex of y = (x + ${ph})² - ${Math.abs(pk)}?`, answer: `(${-ph}, ${-Math.abs(pk)})`, options: [`(${-ph}, ${-Math.abs(pk)})`, `(${ph}, ${-Math.abs(pk)})`, `(${-ph}, ${Math.abs(pk)})`, `(${ph}, ${Math.abs(pk)})`],
                            mistakeAnalysis: { [`(${ph}, ${-Math.abs(pk)})`]: `(x + ${ph}) means h = -${ph}`, [`(${-ph}, ${Math.abs(pk)})`]: `- ${Math.abs(pk)} means k = ${-Math.abs(pk)}`, [`(${ph}, ${Math.abs(pk)})`]: "Both signs need attention" }}
                    };
                })()
            ]
        }),
        Logarithms: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Evaluating Logarithms
                (() => {
                    const bases = [[2, 8, 3], [2, 16, 4], [2, 32, 5], [3, 9, 2], [3, 27, 3], [10, 100, 2], [10, 1000, 3]];
                    const [base, result, exp] = bases[rand(0, bases.length - 1)];
                    // Practice with different values
                    const pBases = [[2, 4, 2], [2, 64, 6], [3, 81, 4], [5, 25, 2], [10, 10000, 4]];
                    const [pbase, presult, pexp] = pBases[rand(0, pBases.length - 1)];
                    return {
                        id: "eval",
                        name: "Evaluating Logarithms",
                        goalProblem: `Find log₂(32)`,
                        teachingSteps: [
                            {
                                title: "What is a Logarithm?",
                                explanation: "A <strong>logarithm</strong> answers the question:<br><br><em>\"What EXPONENT do I need?\"</em><br><br>log₂(8) asks: \"2 to WHAT POWER gives me 8?\"",
                                visual: "log = \"What exponent?\""
                            },
                            {
                                title: "The Definition",
                                explanation: "<strong>log_b(x) = y</strong> means <strong>b^y = x</strong><br><br>The LOG form and EXPONENT form say the same thing!",
                                visual: "log_b(x) = y ↔ b^y = x"
                            },
                            {
                                title: "Example",
                                explanation: "log₂(8) = ?<br><br>Ask: 2 to what power = 8?<br>2³ = 8 ✓<br><br>So log₂(8) = <strong>3</strong>",
                                visual: "2³ = 8, so log₂(8) = 3"
                            },
                            {
                                title: "Step 1: Read the Problem",
                                explanation: "log₂(32) asks: \"<strong>2 to what power = 32?</strong>\"",
                                visual: "2^? = 32"
                            },
                            {
                                title: "Step 2: Find the Exponent",
                                explanation: "Powers of 2:<br>2¹=2, 2²=4, 2³=8, 2⁴=16, <strong>2⁵=32</strong> ✓<br><br>The exponent is <strong>5</strong>",
                                visual: "2⁵ = 32"
                            },
                            {
                                title: "Step 3: Answer",
                                explanation: "<strong>log₂(32) = 5</strong>",
                                visual: "log₂(32) = 5"
                            }
                        ],
                        finalAnswer: "5",
                        answerExplanation: "2⁵ = 32, so log₂(32) = 5",
                        example: { problem: `Find log₂(32)`, steps: [
                            { text: "Ask: 2 to what power = 32?", math: "2^? = 32" },
                            { text: "2⁵ = 32", math: "Exponent is 5" },
                            { text: "Answer", math: "<strong>log₂(32) = 5</strong>" }
                        ]},
                        keyPoints: [
                            "log_b(x) asks: 'b to what power equals x?'",
                            "log_b(b) = 1 always (b¹ = b)",
                            "log_b(1) = 0 always (b⁰ = 1)"
                        ],
                        mistakes: [
                            { wrong: "Thinking log₂(8) = 8 ÷ 2 = 4", why: "Logs aren't division! Ask: 2^? = 8. Answer: 3" },
                            { wrong: "Confusing base and result", why: "In log₂(8) = 3, base=2, input=8, answer=3" }
                        ],
                        guided: {
                            problem: `Find log_${base}(${result})`,
                            steps: [
                                { label: "Ask", value: `${base}^? = ${result}` },
                                { label: `${base}^${exp} =`, value: String(result) },
                                { label: "Answer", value: "?" }
                            ],
                            answer: String(exp),
                            answerLabel: `log_${base}(${result}) =`,
                            interactiveSteps: [
                                {
                                    prompt: `log_${base}(${result}) asks: ${base} to what power equals ${result}?`,
                                    hint: "Think: what exponent turns the base into the result?",
                                    answer: String(exp),
                                    acceptableAnswers: [String(exp)],
                                    commonMistakes: {
                                        [String(result)]: `${result} is the input, not the answer. ${base}^${exp} = ${result}, so log = ${exp}`,
                                        [String(base)]: `${base} is the base. We need the exponent: ${exp}`,
                                        [String(Math.round(result/base))]: `That's division. Logs find exponents: ${base}^${exp} = ${result}`
                                    }
                                }
                            ]
                        },
                        practice: { problem: `log_${pbase}(${presult}) = ?`, answer: String(pexp),
                            options: shuffle([String(pexp), String(pexp - 1), String(pexp + 1), String(Math.round(presult/pbase))]),
                            mistakeAnalysis: {
                                [String(pexp - 1)]: `${pbase}^${pexp-1} = ${Math.pow(pbase, pexp-1)}, not ${presult}. Try ${pbase}^${pexp} = ${presult}`,
                                [String(pexp + 1)]: `${pbase}^${pexp+1} = ${Math.pow(pbase, pexp+1)}, not ${presult}. Try ${pbase}^${pexp} = ${presult}`,
                                [String(Math.round(presult/pbase))]: `Logs aren't division! ${pbase}^${pexp} = ${presult}, so log = ${pexp}`
                            }}
                    };
                })(),

                // Sub-skill 2: Logarithm Properties
                (() => {
                    const a = rand(2, 5), b = rand(2, 5);
                    const product = a * b;
                    // Practice
                    const pa = rand(3, 7), pb = rand(2, 6);
                    const pproduct = pa * pb;
                    return {
                        id: "property",
                        name: "Log Properties (Product Rule)",
                        goalProblem: `Simplify: log(12) using log(3) and log(4)`,
                        teachingSteps: [
                            {
                                title: "The Product Rule",
                                explanation: "One of the most important log rules:<br><br><strong>log(ab) = log(a) + log(b)</strong><br><br>Multiplying INSIDE becomes ADDING outside!",
                                visual: "log(ab) = log(a) + log(b)"
                            },
                            {
                                title: "Why Does This Work?",
                                explanation: "If we have exponents: x^m × x^n = x^(m+n)<br><br>Since logs ARE exponents, multiplication of inputs becomes addition of logs!",
                                visual: "Multiplying → Adding (for logs)"
                            },
                            {
                                title: "Example",
                                explanation: "log(6) = log(2 × 3) = log(2) + log(3)<br><br>We split the product into a sum!",
                                visual: "log(6) = log(2) + log(3)"
                            },
                            {
                                title: "Step 1: Identify the Product",
                                explanation: "We want to simplify log(12).<br><br>Notice: 12 = 3 × 4",
                                visual: "12 = 3 × 4"
                            },
                            {
                                title: "Step 2: Apply the Product Rule",
                                explanation: "log(12) = log(3 × 4)<br><br>Using log(ab) = log(a) + log(b):<br><br><strong>log(12) = log(3) + log(4)</strong>",
                                visual: "log(12) = log(3) + log(4)"
                            }
                        ],
                        finalAnswer: "log(3) + log(4)",
                        answerExplanation: "Using the product rule: log(12) = log(3 × 4) = log(3) + log(4)",
                        example: { problem: `Simplify log(12) using log(3) and log(4)`, steps: [
                            { text: "Factor the input", math: "12 = 3 × 4" },
                            { text: "Apply product rule", math: "log(3 × 4) = log(3) + log(4)" },
                            { text: "Answer", math: "<strong>log(3) + log(4)</strong>" }
                        ]},
                        keyPoints: [
                            "Product rule: log(ab) = log(a) + log(b)",
                            "Quotient rule: log(a/b) = log(a) - log(b)",
                            "Power rule: log(a^n) = n × log(a)"
                        ],
                        mistakes: [
                            { wrong: "log(a + b) = log(a) + log(b)", why: "NO! The rule only works for PRODUCTS: log(a×b), not sums" },
                            { wrong: "log(ab) = log(a) × log(b)", why: "Product inside → SUM outside, not product" }
                        ],
                        guided: {
                            problem: `Simplify log(${product}) using log(${a}) and log(${b})`,
                            steps: [
                                { label: "Factor", value: `${product} = ${a} × ${b}` },
                                { label: "Rule", value: "log(ab) = log(a) + log(b)" },
                                { label: "Answer", value: "?" }
                            ],
                            answer: `log(${a}) + log(${b})`,
                            answerLabel: `log(${product}) =`,
                            interactiveSteps: [
                                {
                                    prompt: `What is ${a} × ${b}?`,
                                    hint: `Multiply ${a} times ${b}`,
                                    answer: String(product),
                                    acceptableAnswers: [String(product)],
                                    commonMistakes: {
                                        [String(a + b)]: `That's ${a} + ${b}. We need ${a} × ${b} = ${product}`
                                    }
                                },
                                {
                                    prompt: `Using log(ab) = log(a) + log(b), what is log(${a} × ${b})?`,
                                    hint: `Split the product into a sum of logs`,
                                    answer: `log(${a}) + log(${b})`,
                                    acceptableAnswers: [`log(${a}) + log(${b})`, `log(${b}) + log(${a})`, `log${a} + log${b}`],
                                    commonMistakes: {
                                        [`log(${a}) × log(${b})`]: "Multiply inside → ADD outside! log(ab) = log(a) + log(b)",
                                        [`log(${a + b})`]: "You can't just add the numbers! log(${product}) = log(${a}) + log(${b})"
                                    }
                                }
                            ]
                        },
                        practice: { problem: `log(${pproduct}) = log(${pa}) + log(?)`, answer: String(pb),
                            options: shuffle([String(pb), String(pa + pb), String(pproduct - pa), String(Math.round(pproduct / 2))]),
                            mistakeAnalysis: {
                                [String(pa + pb)]: `We need ${pa} × ? = ${pproduct}. So ? = ${pproduct}/${pa} = ${pb}`,
                                [String(pproduct - pa)]: `This isn't subtraction! ${pa} × ? = ${pproduct}, so ? = ${pb}`,
                                [String(Math.round(pproduct / 2))]: `We need ${pa} × ? = ${pproduct}. Divide: ${pproduct}/${pa} = ${pb}`
                            }}
                    };
                })()
            ]
        }),
        Polynomials: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Finding Degree
                (() => {
                    const deg = rand(2, 5);
                    const coef = rand(2, 8);
                    const terms = [`${coef}x^${deg}`, `${rand(1,5)}x^${deg-1}`, `${rand(1,9)}`].join(" + ");
                    // Practice
                    const pdeg = rand(3, 6);
                    const pterms = [`${rand(1,7)}x^${pdeg}`, `${rand(1,5)}x^${pdeg-2}`, `${rand(1,9)}`].join(" - ");
                    return {
                        id: "degree",
                        name: "Polynomial Degree",
                        goalProblem: `What is the degree of 4x³ + 2x² - 5x + 7?`,
                        teachingSteps: [
                            {
                                title: "What is a Polynomial?",
                                explanation: "A <strong>polynomial</strong> is an expression with variables raised to whole-number powers.<br><br>Examples: 3x², x³ + 2x - 5, 4x⁴ - x + 1",
                                visual: "Polynomial = sum of terms with whole-number exponents"
                            },
                            {
                                title: "What is Degree?",
                                explanation: "The <strong>degree</strong> of a polynomial is the <strong>highest exponent</strong> on the variable.<br><br>It tells you how \"powerful\" the polynomial is!",
                                visual: "Degree = highest power"
                            },
                            {
                                title: "Finding the Degree",
                                explanation: "Look at each term's exponent:<br><br>4x<strong>³</strong> → exponent 3<br>2x<strong>²</strong> → exponent 2<br>-5x<strong>¹</strong> → exponent 1<br>7 → exponent 0 (it's 7x⁰)<br><br>Highest: <strong>3</strong>",
                                visual: "4x³ + 2x² - 5x + 7 → degree 3"
                            },
                            {
                                title: "The Answer",
                                explanation: "The degree is <strong>3</strong> (from the x³ term).",
                                visual: "Degree = 3"
                            }
                        ],
                        finalAnswer: "3",
                        answerExplanation: "The highest exponent is 3 (from 4x³), so the degree is 3.",
                        example: { problem: `Degree of 4x³ + 2x² - 5x + 7`, steps: [
                            { text: "List exponents", math: "3, 2, 1, 0" },
                            { text: "Find highest", math: "max(3, 2, 1, 0) = 3" },
                            { text: "Answer", math: "<strong>Degree = 3</strong>" }
                        ]},
                        keyPoints: [
                            "Degree = highest exponent on the variable",
                            "Constants have degree 0 (e.g., 5 = 5x⁰)",
                            "x by itself has degree 1 (x = x¹)"
                        ],
                        mistakes: [
                            { wrong: "Using the coefficient as the degree", why: "In 5x³, the degree is 3 (exponent), not 5 (coefficient)." },
                            { wrong: "Adding all the exponents", why: "Just find the HIGHEST exponent, don't add them." }
                        ],
                        guided: {
                            problem: `What is the degree of ${terms}?`,
                            steps: [
                                { label: "Highest term", value: `${coef}x^${deg}` },
                                { label: "Its exponent", value: String(deg) }
                            ],
                            answer: String(deg),
                            answerLabel: "Degree:",
                            interactiveSteps: [
                                {
                                    prompt: `What is the exponent on the first term ${coef}x^${deg}?`,
                                    hint: "The exponent is the superscript number",
                                    answer: String(deg),
                                    acceptableAnswers: [String(deg)],
                                    commonMistakes: {
                                        [String(coef)]: `${coef} is the coefficient. The exponent (degree) is ${deg}.`
                                    }
                                },
                                {
                                    prompt: `Is ${deg} the highest exponent in the polynomial?`,
                                    hint: "Compare to the other terms' exponents",
                                    answer: "yes",
                                    acceptableAnswers: ["yes", "y", "Yes", "YES"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `Degree of ${pterms}?`, answer: String(pdeg),
                            options: shuffle([String(pdeg), String(pdeg-1), String(pdeg-2), String(pdeg+1)]),
                            mistakeAnalysis: {
                                [String(pdeg-1)]: `Look for the HIGHEST exponent. x^${pdeg} has the highest power.`,
                                [String(pdeg-2)]: `That's not the highest. The x^${pdeg} term has degree ${pdeg}.`,
                                [String(pdeg+1)]: `Check again - the highest power is ${pdeg}, not ${pdeg+1}.`
                            }}
                    };
                })(),

                // Sub-skill 2: Adding Polynomials
                (() => {
                    const a1 = rand(2, 5), a2 = rand(1, 4);
                    const b1 = rand(2, 6), b2 = rand(1, 5);
                    const c1 = rand(1, 8), c2 = rand(1, 7);
                    // Practice
                    const pa1 = rand(3, 6), pa2 = rand(2, 5);
                    const pb1 = rand(2, 7), pb2 = rand(3, 6);
                    return {
                        id: "add",
                        name: "Adding Polynomials",
                        goalProblem: `Add: (3x² + 5x + 2) + (2x² - 3x + 4)`,
                        teachingSteps: [
                            {
                                title: "What are Like Terms?",
                                explanation: "<strong>Like terms</strong> have the same variable raised to the same power.<br><br>3x² and 5x² are like terms (both x²)<br>3x² and 5x are NOT (different powers)",
                                visual: "Like terms = same variable AND same exponent"
                            },
                            {
                                title: "The Rule",
                                explanation: "To add polynomials: <strong>Combine like terms</strong><br><br>Add the coefficients, keep the same variable and exponent.",
                                visual: "3x² + 5x² = (3+5)x² = 8x²"
                            },
                            {
                                title: "Step 1: Group Like Terms",
                                explanation: "(3x² + 5x + 2) + (2x² - 3x + 4)<br><br>x² terms: 3x² and 2x²<br>x terms: 5x and -3x<br>Constants: 2 and 4",
                                visual: "Group by power: x², x, constants"
                            },
                            {
                                title: "Step 2: Add Each Group",
                                explanation: "x² terms: 3x² + 2x² = <strong>5x²</strong><br>x terms: 5x + (-3x) = <strong>2x</strong><br>Constants: 2 + 4 = <strong>6</strong>",
                                visual: "3+2=5 | 5+(-3)=2 | 2+4=6"
                            },
                            {
                                title: "Answer",
                                explanation: "Combine: <strong>5x² + 2x + 6</strong>",
                                visual: "5x² + 2x + 6"
                            }
                        ],
                        finalAnswer: "5x² + 2x + 6",
                        answerExplanation: "Combine like terms: (3+2)x² + (5-3)x + (2+4) = 5x² + 2x + 6",
                        example: { problem: `(3x² + 5x + 2) + (2x² - 3x + 4)`, steps: [
                            { text: "Combine x² terms", math: "3x² + 2x² = 5x²" },
                            { text: "Combine x terms", math: "5x + (-3x) = 2x" },
                            { text: "Combine constants", math: "2 + 4 = 6" },
                            { text: "Answer", math: "<strong>5x² + 2x + 6</strong>" }
                        ]},
                        keyPoints: [
                            "Only combine terms with same variable AND same exponent",
                            "Add the coefficients, keep the variable part the same",
                            "Don't change exponents when adding!"
                        ],
                        mistakes: [
                            { wrong: "3x² + 2x² = 5x⁴", why: "DON'T add exponents! Just add coefficients: 3x² + 2x² = 5x²" },
                            { wrong: "3x² + 2x = 5x³", why: "Can't combine different powers! 3x² and 2x are NOT like terms." }
                        ],
                        guided: {
                            problem: `Add: (${a1}x² + ${b1}x + ${c1}) + (${a2}x² + ${b2}x + ${c2})`,
                            steps: [
                                { label: "x² terms", value: `${a1}x² + ${a2}x² = ${a1+a2}x²` },
                                { label: "x terms", value: `${b1}x + ${b2}x = ${b1+b2}x` },
                                { label: "constants", value: `${c1} + ${c2} = ${c1+c2}` }
                            ],
                            answer: `${a1+a2}x² + ${b1+b2}x + ${c1+c2}`,
                            answerLabel: "Sum:",
                            interactiveSteps: [
                                {
                                    prompt: `Add the x² coefficients: ${a1} + ${a2} = ?`,
                                    hint: "Just add the numbers in front of x²",
                                    answer: String(a1 + a2),
                                    acceptableAnswers: [String(a1+a2)],
                                    commonMistakes: {
                                        [String(a1*a2)]: `Multiply is for multiplication. For addition: ${a1} + ${a2} = ${a1+a2}`
                                    }
                                },
                                {
                                    prompt: `Add the x coefficients: ${b1} + ${b2} = ?`,
                                    hint: "Add the numbers in front of x",
                                    answer: String(b1 + b2),
                                    acceptableAnswers: [String(b1+b2)],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `Add the constants: ${c1} + ${c2} = ?`,
                                    hint: "Just add the numbers",
                                    answer: String(c1 + c2),
                                    acceptableAnswers: [String(c1+c2)],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `(${pa1}x² + ${pb1}x) + (${pa2}x² + ${pb2}x) = ?`, answer: `${pa1+pa2}x² + ${pb1+pb2}x`,
                            options: shuffle([`${pa1+pa2}x² + ${pb1+pb2}x`, `${pa1*pa2}x² + ${pb1*pb2}x`, `${pa1+pa2}x⁴ + ${pb1+pb2}x²`, `${pa1+pb1}x² + ${pa2+pb2}x`]),
                            mistakeAnalysis: {
                                [`${pa1*pa2}x² + ${pb1*pb2}x`]: "You multiplied instead of added! Add coefficients: " + (pa1+pa2) + "x² + " + (pb1+pb2) + "x",
                                [`${pa1+pa2}x⁴ + ${pb1+pb2}x²`]: "Don't change the exponents! Adding polynomials keeps the same powers.",
                                [`${pa1+pb1}x² + ${pa2+pb2}x`]: "Combine LIKE terms - add x² with x², not x² with x."
                            }}
                    };
                })()
            ]
        }),
        Probability: () => {
            const favorable = rand(2, 5);
            const total = rand(favorable + 2, 12);
            return {
                goalProblem: `A bag has 3 red and 5 blue marbles. What is P(red)?`,
                teachingSteps: [
                    {
                        title: "What is Probability?",
                        explanation: "<strong>Probability</strong> measures how <strong>likely</strong> something is to happen.<br><br>It answers: \"What are the chances?\"",
                        visual: "Probability = How likely is this event?"
                    },
                    {
                        title: "The Probability Scale",
                        explanation: "Probability is always between <strong>0 and 1</strong>:<br><br>• <strong>0</strong> = Impossible (will never happen)<br>• <strong>0.5</strong> = Equally likely (50/50)<br>• <strong>1</strong> = Certain (will definitely happen)<br><br>You can also use percentages: 0% to 100%",
                        visual: "0 (impossible) ←——————→ 1 (certain)"
                    },
                    {
                        title: "The Basic Probability Formula",
                        explanation: "The probability formula is:<br><br><strong>P(event) = Favorable outcomes / Total outcomes</strong><br><br>Favorable = outcomes you WANT<br>Total = ALL possible outcomes",
                        visual: "P = Favorable / Total"
                    },
                    {
                        title: "Step 1: Count Favorable Outcomes",
                        explanation: "We want to pick a <strong>red</strong> marble.<br><br>How many red marbles are there? <strong>3</strong><br><br>Favorable outcomes = 3",
                        visual: "Favorable (red marbles) = 3"
                    },
                    {
                        title: "Step 2: Count Total Outcomes",
                        explanation: "How many marbles are there in total?<br><br>Red + Blue = 3 + 5 = <strong>8</strong> marbles<br><br>Total outcomes = 8",
                        visual: "Total = 3 + 5 = 8 marbles"
                    },
                    {
                        title: "Step 3: Apply the Formula",
                        explanation: "P(red) = Favorable / Total<br><br>P(red) = 3/8<br><br>As a decimal: 3 ÷ 8 = <strong>0.375</strong><br>As a percent: <strong>37.5%</strong>",
                        visual: "P(red) = 3/8 = 0.375 = 37.5%"
                    }
                ],
                finalAnswer: "3/8 or 0.375 or 37.5%",
                answerExplanation: "3 favorable outcomes (red) divided by 8 total outcomes gives us 3/8 = 0.375 = 37.5%.",
                example: { problem: `A bag has 3 red and 5 blue marbles. What is P(red)?`, steps: [
                    { text: "Count favorable outcomes", math: "Red marbles = 3" },
                    { text: "Count total outcomes", math: "Total = 3 + 5 = 8" },
                    { text: "Apply formula", math: "P(red) = 3/8" },
                    { text: "As decimal or percent", math: "<strong>P(red) = 0.375 = 37.5%</strong>" }
                ]},
                keyPoints: [
                    "P(event) = favorable / total",
                    "All probabilities are between 0 and 1 (or 0% and 100%)",
                    "P(not A) = 1 - P(A)"
                ],
                mistakes: [
                    { wrong: "P > 1 or P < 0", why: "Probability is ALWAYS between 0 and 1 (inclusive)." },
                    { wrong: "Using wrong total: P(red) = 3/5", why: "Denominator is ALL outcomes (red + blue = 8), not just one color." }
                ],
                guided: {
                    problem: `A bag has ${favorable} green and ${total - favorable} yellow marbles. What is P(green)?`,
                    steps: [
                        { label: "Favorable outcomes (green)", value: `${favorable}` },
                        { label: "Total outcomes", value: `${favorable} + ${total - favorable} = ${total}` },
                        { label: "P(green) = favorable/total", value: "?" }
                    ],
                    answer: `${favorable}/${total}`,
                    answerLabel: "P(green) = ?",
                    interactiveSteps: [
                        {
                            prompt: "What is the basic probability formula?",
                            hint: "P(event) = something / something else",
                            answer: "favorable/total",
                            acceptableAnswers: ["favorable/total", "favorable / total", "favorable outcomes / total outcomes", "wanted/total"],
                            commonMistakes: {
                                "total/favorable": "It's the other way around! Favorable goes on TOP: favorable / total",
                                "favorable - total": "Probability is a RATIO (division), not subtraction",
                                "favorable + total": "Probability is a RATIO (division), not addition"
                            }
                        },
                        {
                            prompt: `How many favorable outcomes (green marbles) are there?`,
                            hint: "Look at the number of green marbles",
                            answer: String(favorable),
                            acceptableAnswers: [String(favorable)],
                            commonMistakes: {
                                [String(total - favorable)]: `That's the yellow marbles. Green marbles = ${favorable}`,
                                [String(total)]: `That's the total. Favorable (green) = ${favorable}`
                            }
                        },
                        {
                            prompt: `How many TOTAL marbles are in the bag?`,
                            hint: `Add green + yellow: ${favorable} + ${total - favorable} = ?`,
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            commonMistakes: {
                                [String(favorable)]: `That's just the green. Total = green + yellow = ${favorable} + ${total - favorable} = ${total}`,
                                [String(total - favorable)]: `That's just the yellow. Add both: ${favorable} + ${total - favorable} = ${total}`
                            }
                        },
                        {
                            prompt: `Now calculate P(green) = favorable/total = ?`,
                            hint: `${favorable} / ${total} as a fraction`,
                            answer: `${favorable}/${total}`,
                            acceptableAnswers: [`${favorable}/${total}`, `${favorable} / ${total}`],
                            commonMistakes: {
                                [`${total}/${favorable}`]: "Numerator should be favorable, not total. P(green) = favorable/total",
                                [`${total - favorable}/${total}`]: `That's P(yellow)! For green: ${favorable}/${total}`
                            }
                        }
                    ]
                },
                practice: { problem: `You flip a fair coin. What is P(heads)?`, answer: "1/2 or 0.5",
                    options: ["1/2 or 0.5", "1/4", "1", "2"],
                    mistakeAnalysis: {
                        "1/4": "A coin has 2 outcomes (heads, tails), not 4. P(heads) = 1/2",
                        "1": "P = 1 means certain. Heads isn't guaranteed; it's 1 of 2 outcomes.",
                        "2": "Probability is a fraction ≤ 1. P(heads) = 1 favorable / 2 total = 1/2"
                    }}
            };
        },
        Sequences: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Arithmetic Sequences
                (() => {
                    const a1 = rand(2, 8), d = rand(2, 5), n = rand(6, 10);
                    const an = a1 + (n - 1) * d;
                    // Practice
                    const pa1 = rand(3, 7), pd = rand(3, 6), pn = rand(7, 12);
                    const pan = pa1 + (pn - 1) * pd;
                    return {
                        id: "arithmetic",
                        name: "Arithmetic Sequences",
                        goalProblem: `Find the 10th term of: 3, 7, 11, 15, ...`,
                        teachingSteps: [
                            {
                                title: "What is an Arithmetic Sequence?",
                                explanation: "An <strong>arithmetic sequence</strong> adds the same number each time.<br><br>3, 7, 11, 15, ... adds 4 each time<br>The number we add is called the <strong>common difference (d)</strong>",
                                visual: "Arithmetic: ADD the same each time"
                            },
                            {
                                title: "The Formula",
                                explanation: "<strong>aₙ = a₁ + (n - 1)d</strong><br><br>• aₙ = nth term<br>• a₁ = first term<br>• d = common difference<br>• n = which term",
                                visual: "aₙ = a₁ + (n-1)d"
                            },
                            {
                                title: "Find d",
                                explanation: "3, 7, 11, 15...<br>7 - 3 = 4<br>d = <strong>4</strong>",
                                visual: "d = 4"
                            },
                            {
                                title: "Apply Formula",
                                explanation: "a₁₀ = 3 + (10-1)(4)<br>= 3 + 9(4)<br>= 3 + 36 = <strong>39</strong>",
                                visual: "a₁₀ = 39"
                            }
                        ],
                        finalAnswer: "39",
                        answerExplanation: "a₁₀ = 3 + (10-1)(4) = 3 + 36 = 39",
                        example: { problem: `10th term of 3, 7, 11, 15, ...`, steps: [
                            { text: "Find d", math: "d = 7 - 3 = 4" },
                            { text: "Apply formula", math: "a₁₀ = 3 + 9(4) = 39" }
                        ]},
                        keyPoints: ["Arithmetic = ADD same number each time", "Formula: aₙ = a₁ + (n-1)d", "d = difference between consecutive terms"],
                        mistakes: [{ wrong: "Using n instead of (n-1)", why: "We add d starting from term 2, so use (n-1)" }],
                        guided: {
                            problem: `Find term ${n} of: ${a1}, ${a1+d}, ${a1+2*d}, ...`,
                            steps: [{ label: "a₁", value: String(a1) }, { label: "d", value: String(d) }],
                            answer: String(an),
                            answerLabel: `a${n} =`,
                            interactiveSteps: [
                                { prompt: `What is d? (${a1+d} - ${a1})`, hint: "Subtract consecutive terms", answer: String(d), acceptableAnswers: [String(d)], commonMistakes: {} },
                                { prompt: `Calculate: ${a1} + ${n-1} × ${d} = ?`, hint: "Multiply first, then add", answer: String(an), acceptableAnswers: [String(an)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Term ${pn} of: ${pa1}, ${pa1+pd}, ${pa1+2*pd}, ...?`, answer: String(pan),
                            options: shuffle([String(pan), String(pa1 + pn*pd), String(pan - pd), String(pan + pd)]),
                            mistakeAnalysis: { [String(pa1 + pn*pd)]: `Use (n-1), not n. Answer: ${pa1} + ${pn-1}×${pd} = ${pan}` }}
                    };
                })(),

                // Sub-skill 2: Geometric Sequences
                (() => {
                    const a1 = rand(2, 4), r = rand(2, 3), n = rand(4, 6);
                    const an = a1 * Math.pow(r, n - 1);
                    // Practice
                    const pa1 = rand(2, 5), pr = rand(2, 3), pn = rand(5, 7);
                    const pan = pa1 * Math.pow(pr, pn - 1);
                    return {
                        id: "geometric",
                        name: "Geometric Sequences",
                        goalProblem: `Find the 5th term of: 2, 6, 18, 54, ...`,
                        teachingSteps: [
                            {
                                title: "What is a Geometric Sequence?",
                                explanation: "A <strong>geometric sequence</strong> multiplies by the same number each time.<br><br>2, 6, 18, 54, ... multiplies by 3 each time<br>The multiplier is called the <strong>common ratio (r)</strong>",
                                visual: "Geometric: MULTIPLY the same each time"
                            },
                            {
                                title: "The Formula",
                                explanation: "<strong>aₙ = a₁ × r^(n-1)</strong><br><br>• aₙ = nth term<br>• a₁ = first term<br>• r = common ratio<br>• n = which term",
                                visual: "aₙ = a₁ × r^(n-1)"
                            },
                            {
                                title: "Find r",
                                explanation: "2, 6, 18, 54...<br>6 ÷ 2 = 3<br>r = <strong>3</strong>",
                                visual: "r = 3"
                            },
                            {
                                title: "Apply Formula",
                                explanation: "a₅ = 2 × 3^(5-1)<br>= 2 × 3⁴<br>= 2 × 81 = <strong>162</strong>",
                                visual: "a₅ = 162"
                            }
                        ],
                        finalAnswer: "162",
                        answerExplanation: "a₅ = 2 × 3⁴ = 2 × 81 = 162",
                        example: { problem: `5th term of 2, 6, 18, 54, ...`, steps: [
                            { text: "Find r", math: "r = 6 ÷ 2 = 3" },
                            { text: "Apply formula", math: "a₅ = 2 × 3⁴ = 162" }
                        ]},
                        keyPoints: ["Geometric = MULTIPLY same number each time", "Formula: aₙ = a₁ × r^(n-1)", "r = ratio between consecutive terms"],
                        mistakes: [{ wrong: "Adding instead of multiplying", why: "Geometric uses multiplication! Check if terms are multiplied." }],
                        guided: {
                            problem: `Find term ${n} of: ${a1}, ${a1*r}, ${a1*r*r}, ...`,
                            steps: [{ label: "a₁", value: String(a1) }, { label: "r", value: String(r) }],
                            answer: String(an),
                            answerLabel: `a${n} =`,
                            interactiveSteps: [
                                { prompt: `What is r? (${a1*r} ÷ ${a1})`, hint: "Divide consecutive terms", answer: String(r), acceptableAnswers: [String(r)], commonMistakes: {} },
                                { prompt: `Calculate: ${a1} × ${r}^${n-1} = ?`, hint: `${r}^${n-1} = ${Math.pow(r, n-1)}`, answer: String(an), acceptableAnswers: [String(an)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Term ${pn} of: ${pa1}, ${pa1*pr}, ${pa1*pr*pr}, ...?`, answer: String(pan),
                            options: shuffle([String(pan), String(pa1 * Math.pow(pr, pn)), String(pan / pr), String(pan * pr)]),
                            mistakeAnalysis: { [String(pa1 * Math.pow(pr, pn))]: `Use (n-1) as exponent, not n. Answer: ${pan}` }}
                    };
                })(),

                // Sub-skill 3: Sum of First n Natural Numbers
                (() => {
                    const n = rand(10, 20);
                    const sum = (n * (n + 1)) / 2;
                    // Practice
                    const pn = rand(15, 25);
                    const psum = (pn * (pn + 1)) / 2;
                    return {
                        id: "sum",
                        name: "Sum of 1 to n",
                        goalProblem: `Find: 1 + 2 + 3 + ... + 15`,
                        teachingSteps: [
                            {
                                title: "The Problem",
                                explanation: "How do we add 1 + 2 + 3 + ... + 15 quickly?<br><br>Adding one by one is slow. There's a formula!",
                                visual: "1 + 2 + 3 + ... + n = ?"
                            },
                            {
                                title: "The Formula",
                                explanation: "<strong>Sum = n(n+1)/2</strong><br><br>This adds all numbers from 1 to n instantly!",
                                visual: "Sum = n(n+1)/2"
                            },
                            {
                                title: "Why It Works (Gauss's Trick)",
                                explanation: "Pair numbers from opposite ends:<br>1 + 15 = 16<br>2 + 14 = 16<br>...<br>7.5 pairs of 16 = 15×16/2 = <strong>120</strong>",
                                visual: "Pairs add to same sum!"
                            },
                            {
                                title: "Apply Formula",
                                explanation: "Sum = 15(15+1)/2<br>= 15 × 16 / 2<br>= 240 / 2 = <strong>120</strong>",
                                visual: "15 × 16 / 2 = 120"
                            }
                        ],
                        finalAnswer: "120",
                        answerExplanation: "Sum = 15(16)/2 = 240/2 = 120",
                        example: { problem: `1 + 2 + 3 + ... + 15`, steps: [
                            { text: "Use formula", math: "Sum = n(n+1)/2" },
                            { text: "Plug in n=15", math: "= 15(16)/2 = 120" }
                        ]},
                        keyPoints: ["Sum from 1 to n = n(n+1)/2", "Multiply n by (n+1), then divide by 2", "Works for any positive integer n"],
                        mistakes: [{ wrong: "Forgetting to divide by 2", why: "The formula is n(n+1)/2, not n(n+1)" }],
                        guided: {
                            problem: `Find: 1 + 2 + 3 + ... + ${n}`,
                            steps: [{ label: "n", value: String(n) }, { label: "n+1", value: String(n+1) }],
                            answer: String(sum),
                            answerLabel: "Sum =",
                            interactiveSteps: [
                                { prompt: `Calculate n × (n+1) = ${n} × ${n+1} = ?`, hint: "Multiply first", answer: String(n*(n+1)), acceptableAnswers: [String(n*(n+1))], commonMistakes: {} },
                                { prompt: `Now divide by 2: ${n*(n+1)} ÷ 2 = ?`, hint: "Divide to get the final answer", answer: String(sum), acceptableAnswers: [String(sum)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `1 + 2 + 3 + ... + ${pn} = ?`, answer: String(psum),
                            options: shuffle([String(psum), String(pn*(pn+1)), String(pn*pn), String(Math.floor(psum/2))]),
                            mistakeAnalysis: { [String(pn*(pn+1))]: `Don't forget to divide by 2! ${pn}×${pn+1}/2 = ${psum}` }}
                    };
                })()
            ]
        }),
        "Conic Sections": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Identifying Conics
                (() => {
                    return {
                        id: "identify",
                        name: "Identifying Conics",
                        goalProblem: `Identify the conic: x² + y² = 25`,
                        teachingSteps: [
                            { title: "The Four Conics", explanation: "<strong>Circle:</strong> x² + y² (same coefficients)<br><strong>Ellipse:</strong> x²/a² + y²/b² = 1 (different denominators)<br><strong>Parabola:</strong> Only ONE variable squared<br><strong>Hyperbola:</strong> x²/a² - y²/b² = 1 (subtraction)", visual: "Circle, Ellipse, Parabola, Hyperbola" },
                            { title: "Quick ID Guide", explanation: "• Both x² and y² with SAME coefficient → <strong>Circle</strong><br>• Both squared with DIFFERENT denominators, + → <strong>Ellipse</strong><br>• Only ONE variable squared → <strong>Parabola</strong><br>• Subtraction between squared terms → <strong>Hyperbola</strong>", visual: "Look at the structure!" },
                            { title: "Our Example", explanation: "x² + y² = 25<br><br>Both x² and y² present with coefficient 1 (same)<br>This is a <strong>Circle</strong>!", visual: "x² + y² = 25 → Circle" }
                        ],
                        finalAnswer: "circle",
                        answerExplanation: "x² + y² = 25 has both variables squared with same coefficient → circle",
                        example: { problem: `x² + y² = 25`, steps: [{ text: "Both squared, same coef", math: "Circle" }]},
                        keyPoints: ["Same coefficients on x² and y² = circle", "Different denominators with + = ellipse", "Subtraction = hyperbola"],
                        mistakes: [{ wrong: "Confusing ellipse and circle", why: "Circle: same coefficients. Ellipse: different denominators." }],
                        guided: { problem: `Identify: x²/9 + y²/4 = 1`, steps: [{ label: "Both squared?", value: "Yes" }, { label: "Same denominators?", value: "No (9≠4)" }], answer: "ellipse", answerLabel: "Type:", interactiveSteps: [{ prompt: "Different denominators with +. What conic?", hint: "Not circle (different denoms), not hyperbola (no minus)", answer: "ellipse", acceptableAnswers: ["ellipse"], commonMistakes: {} }] },
                        practice: { problem: `Identify: y = x²`, answer: "parabola", options: ["circle", "ellipse", "parabola", "hyperbola"], mistakeAnalysis: { "circle": "Only y has no square. One variable squared = parabola" }}
                    };
                })(),

                // Sub-skill 2: Circle Properties
                (() => {
                    const r = rand(2, 6);
                    const pr = rand(3, 7);
                    return {
                        id: "circle",
                        name: "Circle: Finding Radius",
                        goalProblem: `Circle x² + y² = 36. What is the radius?`,
                        teachingSteps: [
                            { title: "Circle Equation", explanation: "Standard form: <strong>x² + y² = r²</strong><br><br>The right side is r SQUARED!", visual: "x² + y² = r²" },
                            { title: "Finding Radius", explanation: "x² + y² = 36<br><br>So r² = 36<br>r = √36 = <strong>6</strong>", visual: "r² = 36 → r = 6" }
                        ],
                        finalAnswer: "6",
                        answerExplanation: "r² = 36, so r = √36 = 6",
                        example: { problem: `x² + y² = 36`, steps: [{ text: "r² = 36", math: "r = √36 = 6" }]},
                        keyPoints: ["Equation gives r², take square root for r", "x² + y² = r² centered at origin"],
                        mistakes: [{ wrong: "Saying r = 36", why: "36 is r². Take the square root: r = 6" }],
                        guided: { problem: `x² + y² = ${r*r}. Radius?`, steps: [{ label: "r² =", value: String(r*r) }], answer: String(r), answerLabel: "r =", interactiveSteps: [{ prompt: `√${r*r} = ?`, hint: "What times itself = " + (r*r), answer: String(r), acceptableAnswers: [String(r)], commonMistakes: {} }] },
                        practice: { problem: `x² + y² = ${pr*pr}. Radius?`, answer: String(pr), options: shuffle([String(pr), String(pr*pr), String(pr*2), String(pr-1)]), mistakeAnalysis: { [String(pr*pr)]: `That's r². Take √${pr*pr} = ${pr}` }}
                    };
                })(),

                // Sub-skill 3: Parabola Direction
                (() => {
                    return {
                        id: "parabola",
                        name: "Parabola Direction",
                        goalProblem: `Does y = -2x² open up or down?`,
                        teachingSteps: [
                            { title: "Parabola Form", explanation: "Vertical parabola: y = ax²<br><br>The sign of <strong>a</strong> determines direction!", visual: "y = ax²" },
                            { title: "The Rule", explanation: "a > 0 (positive) → Opens <strong>UP</strong> ∪<br>a < 0 (negative) → Opens <strong>DOWN</strong> ∩", visual: "Positive = up, Negative = down" },
                            { title: "Our Example", explanation: "y = -2x²<br><br>a = -2 (negative)<br>Opens <strong>DOWN</strong>", visual: "-2 < 0 → Down" }
                        ],
                        finalAnswer: "down",
                        answerExplanation: "a = -2 is negative, so parabola opens down",
                        example: { problem: `y = -2x²`, steps: [{ text: "a = -2 < 0", math: "Opens down" }]},
                        keyPoints: ["a > 0 → up", "a < 0 → down", "Only look at coefficient of x²"],
                        mistakes: [{ wrong: "Looking at wrong coefficient", why: "Only the x² coefficient matters for direction" }],
                        guided: { problem: `Does y = 3x² open up or down?`, steps: [{ label: "a =", value: "3" }], answer: "up", answerLabel: "Direction:", interactiveSteps: [{ prompt: "Is 3 positive or negative?", hint: "3 > 0", answer: "positive", acceptableAnswers: ["positive", "pos", "+"], commonMistakes: {} }, { prompt: "Positive a means opens...?", answer: "up", acceptableAnswers: ["up", "upward"], commonMistakes: {} }] },
                        practice: { problem: `y = -x² + 5x opens...?`, answer: "down", options: ["up", "down", "left", "right"], mistakeAnalysis: { "up": "Coefficient of x² is -1 (negative) → opens down" }}
                    };
                })(),

                // Sub-skill 4: Ellipse Major Axis
                (() => {
                    let a = rand(2, 5), b = rand(2, 5);
                    while (a === b) b = rand(2, 5);
                    const major = a > b ? "horizontal" : "vertical";
                    return {
                        id: "ellipse",
                        name: "Ellipse Major Axis",
                        goalProblem: `x²/25 + y²/9 = 1. Is major axis horizontal or vertical?`,
                        teachingSteps: [
                            { title: "Ellipse Form", explanation: "Standard: x²/a² + y²/b² = 1<br><br>The LARGER denominator shows the longer axis!", visual: "x²/a² + y²/b² = 1" },
                            { title: "The Rule", explanation: "Larger denominator under x² → <strong>Horizontal</strong> major axis<br>Larger denominator under y² → <strong>Vertical</strong> major axis", visual: "Bigger denom = that direction" },
                            { title: "Our Example", explanation: "x²/25 + y²/9 = 1<br><br>25 > 9, and 25 is under x²<br>Major axis is <strong>horizontal</strong>", visual: "25 > 9 under x² → Horizontal" }
                        ],
                        finalAnswer: "horizontal",
                        answerExplanation: "25 > 9 and 25 is under x², so major axis is horizontal",
                        example: { problem: `x²/25 + y²/9 = 1`, steps: [{ text: "25 > 9, under x²", math: "Horizontal" }]},
                        keyPoints: ["Compare denominators", "Larger denominator = direction of major axis"],
                        mistakes: [{ wrong: "Confusing a and b", why: "Just compare which denominator is larger" }],
                        guided: { problem: `x²/${a*a} + y²/${b*b} = 1. Major axis?`, steps: [{ label: "Compare", value: `${a*a} vs ${b*b}` }], answer: major, answerLabel: "Major axis:", interactiveSteps: [{ prompt: `Which is larger: ${a*a} or ${b*b}?`, answer: String(Math.max(a*a, b*b)), acceptableAnswers: [String(Math.max(a*a, b*b))], commonMistakes: {} }] },
                        practice: { problem: `x²/4 + y²/16 = 1. Major axis?`, answer: "vertical", options: ["horizontal", "vertical"], mistakeAnalysis: { "horizontal": "16 > 4 and 16 is under y² → vertical" }}
                    };
                })()
            ]
        }),
        "Rational Functions": () => {
            const a = rand(2, 5);
            return {
                goalProblem: `Find the vertical asymptote of f(x) = 1/(x - 3)`,
                teachingSteps: [
                    {
                        title: "What is a Rational Function?",
                        explanation: "A <strong>rational function</strong> is a ratio of two polynomials:<br><br><strong>f(x) = P(x) / Q(x)</strong><br><br>Example: f(x) = (x + 1)/(x - 2)",
                        visual: "Rational = Polynomial / Polynomial"
                    },
                    {
                        title: "Domain Restrictions",
                        explanation: "Since we can't divide by zero, rational functions are <strong>undefined</strong> where the denominator equals zero.<br><br>These restrictions affect the domain!",
                        visual: "If Q(x) = 0, the function is undefined"
                    },
                    {
                        title: "Vertical Asymptotes",
                        explanation: "A <strong>vertical asymptote</strong> occurs where the denominator = 0 (and numerator ≠ 0).<br><br>The graph approaches but never touches/crosses a vertical asymptote.",
                        visual: "Denominator = 0 → Vertical Asymptote"
                    },
                    {
                        title: "Horizontal Asymptotes",
                        explanation: "A <strong>horizontal asymptote</strong> shows the function's behavior as x → ±∞:<br><br>• If degree(top) < degree(bottom): y = 0<br>• If degrees equal: y = leading coefficients ratio<br>• If degree(top) > degree(bottom): no horizontal asymptote",
                        visual: "Horizontal asymptote = end behavior"
                    },
                    {
                        title: "Step 1: Find Where Denominator = 0",
                        explanation: "For f(x) = 1/(x - 3):<br><br>Set denominator = 0:<br>x - 3 = 0<br>x = <strong>3</strong>",
                        visual: "x - 3 = 0 → x = 3"
                    },
                    {
                        title: "Step 2: Verify It's an Asymptote",
                        explanation: "At x = 3:<br>• Denominator = 0 ✓<br>• Numerator = 1 ≠ 0 ✓<br><br>Since the numerator isn't also 0, we have a vertical asymptote at <strong>x = 3</strong>",
                        visual: "Vertical asymptote: x = 3"
                    }
                ],
                finalAnswer: "x = 3",
                answerExplanation: "Set the denominator equal to zero: x - 3 = 0 → x = 3. The vertical asymptote is x = 3.",
                example: { problem: `Find vertical asymptote of f(x) = 1/(x - 3)`, steps: [
                    { text: "Set denominator = 0", math: "x - 3 = 0" },
                    { text: "Solve for x", math: "x = 3" },
                    { text: "Check numerator ≠ 0 at x = 3", math: "Numerator = 1 ≠ 0 ✓" },
                    { text: "Vertical asymptote", math: "<strong>x = 3</strong>" }
                ]},
                keyPoints: [
                    "Vertical asymptote: where denominator = 0 (and numerator ≠ 0)",
                    "The function is undefined at vertical asymptotes",
                    "Compare degrees for horizontal asymptotes"
                ],
                mistakes: [
                    { wrong: "Setting numerator = 0 for vertical asymptote", why: "Vertical asymptotes come from DENOMINATOR = 0, not numerator." },
                    { wrong: "Including holes as asymptotes", why: "If both num and denom = 0 at same point, it's a HOLE, not an asymptote." }
                ],
                guided: {
                    problem: `Find the vertical asymptote of f(x) = ${a}/(x + 2)`,
                    steps: [
                        { label: "Set denominator = 0", value: "x + 2 = 0" },
                        { label: "Solve for x", value: "?" }
                    ],
                    answer: "x = -2",
                    answerLabel: "Vertical asymptote:",
                    interactiveSteps: [
                        {
                            prompt: "To find vertical asymptotes, what do we set equal to zero?",
                            hint: "It's the bottom part of the fraction...",
                            answer: "denominator",
                            acceptableAnswers: ["denominator", "the denominator", "bottom", "x + 2"],
                            commonMistakes: {
                                "numerator": "Numerator = 0 gives x-intercepts. For vertical asymptotes, set DENOMINATOR = 0",
                                [String(a)]: `${a} is the numerator. Set the DENOMINATOR (x + 2) = 0`
                            }
                        },
                        {
                            prompt: "Solve: x + 2 = 0. What is x?",
                            hint: "Subtract 2 from both sides",
                            answer: "-2",
                            acceptableAnswers: ["-2", "x = -2", "x=-2"],
                            commonMistakes: {
                                "2": "If x + 2 = 0, then x = -2 (subtract 2, don't keep it positive)",
                                "-4": "x + 2 = 0 means x = 0 - 2 = -2"
                            }
                        },
                        {
                            prompt: "So the vertical asymptote is at x = ?",
                            hint: "We found x = -2",
                            answer: "-2",
                            acceptableAnswers: ["-2", "x = -2", "x=-2"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `What is the horizontal asymptote of f(x) = 2/(x + 1)?`, answer: "y = 0",
                    options: ["y = 0", "y = 2", "x = -1", "No horizontal asymptote"],
                    mistakeAnalysis: {
                        "y = 2": "2 is the numerator. Since degree(top) < degree(bottom), y = 0",
                        "x = -1": "That's the VERTICAL asymptote. The HORIZONTAL asymptote is y = 0",
                        "No horizontal asymptote": "Since degree(numerator) < degree(denominator), there IS one: y = 0"
                    }}
            };
        },
        "Piecewise Functions": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Evaluating Piecewise Functions
                (() => {
                    const a = rand(2, 5), b = rand(1, 4);
                    return {
                        id: "evaluate", name: "Evaluate Piecewise",
                        goalProblem: `Evaluate f(5) if f(x) = { x² if x < 3; 2x + 1 if x ≥ 3 }`,
                        teachingSteps: [
                            { title: "What is a Piecewise Function?", explanation: "A <strong>piecewise function</strong> uses different formulas for different parts of its domain.", visual: "Different rules for different x-values" },
                            { title: "How to Evaluate", explanation: "1. Check which condition the input satisfies<br>2. Use that formula<br>3. Calculate", visual: "Which piece? → Use that formula" },
                            { title: "Example", explanation: "f(5): Is 5 < 3 or ≥ 3?<br>5 ≥ 3, so use 2x + 1<br>f(5) = 2(5) + 1 = 11", visual: "f(5) = 11" }
                        ],
                        finalAnswer: "11",
                        example: { problem: `f(5) where f(x) = { x² if x < 3; 2x + 1 if x ≥ 3 }`, steps: [{ text: "Check", math: "5 ≥ 3 → use 2x + 1" }, { text: "Calculate", math: "2(5) + 1 = 11" }]},
                        keyPoints: ["Check which condition first", "Only ONE piece applies"],
                        mistakes: [{ wrong: "Using wrong piece", why: "Check condition first!" }],
                        guided: { problem: `Evaluate f(${a}) if f(x) = { ${b}x if x ≤ 4; x + 10 if x > 4 }`, steps: [{ label: "Check", value: a <= 4 ? "≤ 4" : "> 4" }], answer: String(a <= 4 ? b * a : a + 10), answerLabel: `f(${a}) =`,
                            interactiveSteps: [
                                { prompt: `Is ${a} ≤ 4 or > 4?`, hint: `Compare ${a} to 4`, answer: a <= 4 ? `≤ 4` : `> 4`, acceptableAnswers: a <= 4 ? [`${a} ≤ 4`, "≤ 4", "<= 4"] : [`${a} > 4`, "> 4"], commonMistakes: {} },
                                { prompt: `Which formula?`, hint: a <= 4 ? "First formula" : "Second formula", answer: a <= 4 ? `${b}x` : "x + 10", acceptableAnswers: a <= 4 ? [`${b}x`] : ["x + 10"], commonMistakes: {} },
                                { prompt: `Calculate the answer`, hint: a <= 4 ? `${b} × ${a}` : `${a} + 10`, answer: String(a <= 4 ? b * a : a + 10), acceptableAnswers: [String(a <= 4 ? b * a : a + 10)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `For f(x) = { x² if x < 0; x if x ≥ 0 }, f(-3) = ?`, answer: "9", options: ["9", "-3", "-9", "3"],
                            mistakeAnalysis: { "-3": "-3 < 0, so use x². (-3)² = 9", "-9": "Squaring gives positive: 9", "3": "(-3)² = 9, not 3" }}
                    };
                })(),
                // Sub-skill 2: Understanding Piecewise Concept
                (() => {
                    return {
                        id: "identify", name: "Understand Piecewise",
                        goalProblem: `A piecewise function has different rules for different ___`,
                        teachingSteps: [
                            { title: "Definition", explanation: "A piecewise function is defined by <strong>multiple sub-functions</strong>, each applying to a specific interval.", visual: "Multiple formulas, one function" },
                            { title: "Domain Pieces", explanation: "The domain is split into <strong>intervals of x</strong>. Each interval gets its own formula.", visual: "x < 2: use f₁ | x ≥ 2: use f₂" },
                            { title: "Reading Notation", explanation: "f(x) = { formula₁ if condition₁; formula₂ if condition₂ }<br>The conditions define the intervals.", visual: "{ } means piecewise" }
                        ],
                        finalAnswer: "intervals of x",
                        example: { problem: `What varies in a piecewise function?`, steps: [{ text: "Key", math: "Different rules for different x-intervals" }]},
                        keyPoints: ["Different formulas for different x-intervals", "Conditions determine which formula"],
                        mistakes: [{ wrong: "Thinking all pieces apply", why: "Only ONE piece per x-value!" }],
                        guided: { problem: `What does the condition in piecewise notation define?`, steps: [{ label: "Purpose", value: "Which x-values use that formula" }], answer: "intervals of x", answerLabel: "Piecewise defines:",
                            interactiveSteps: [
                                { prompt: `Piecewise functions have different rules for different ___ of x`, hint: "Parts or sections of the domain", answer: "intervals", acceptableAnswers: ["intervals", "intervals of x", "parts", "sections", "regions"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `A piecewise function has different rules for different:`, answer: "intervals of x", options: ["intervals of x", "values of y", "slopes", "intercepts"],
                            mistakeAnalysis: { "values of y": "We're splitting the domain (x), not range (y)", "slopes": "Piecewise can have different slopes, but that's not what defines it", "intercepts": "Not about intercepts" }}
                    };
                })(),
                // Sub-skill 3: Checking Continuity
                (() => {
                    const b = rand(1, 4);
                    return {
                        id: "graph", name: "Check Continuity",
                        goalProblem: `At x = 2, f(x) = { x² if x < 2; 2x if x ≥ 2 }. Is f continuous?`,
                        teachingSteps: [
                            { title: "What is Continuity?", explanation: "A function is <strong>continuous</strong> at a point if there's no gap or jump.", visual: "No breaks in the graph" },
                            { title: "Checking at Boundary", explanation: "At boundary x = 2:<br>• Left side: lim as x→2⁻ of x² = 4<br>• Right side: lim as x→2⁺ of 2x = 4<br>Both equal!", visual: "Left = Right = 4 ✓" },
                            { title: "Conclusion", explanation: "Since both sides equal 4, the function IS continuous at x = 2.", visual: "Continuous: Yes!" }
                        ],
                        finalAnswer: "Yes",
                        example: { problem: `Is f continuous at x = 2?`, steps: [{ text: "Left", math: "2² = 4" }, { text: "Right", math: "2(2) = 4" }, { text: "Equal?", math: "Yes, continuous" }]},
                        keyPoints: ["Check both sides at boundary", "Equal values = continuous"],
                        mistakes: [{ wrong: "Only checking one side", why: "Must check BOTH sides at boundary" }],
                        guided: { problem: `Is f(x) = { x + ${b} if x < 3; ${b+3} if x ≥ 3 } continuous at x = 3?`, steps: [{ label: "Left", value: String(3 + b) }, { label: "Right", value: String(b + 3) }], answer: "Yes", answerLabel: "Continuous?",
                            interactiveSteps: [
                                { prompt: `What is the left-side value? Evaluate x + ${b} at x = 3`, hint: `3 + ${b}`, answer: String(3 + b), acceptableAnswers: [String(3 + b)], commonMistakes: {} },
                                { prompt: `What is the right-side value?`, hint: "The constant value for x ≥ 3", answer: String(b + 3), acceptableAnswers: [String(b + 3)], commonMistakes: {} },
                                { prompt: `Are they equal? Is f continuous?`, hint: "Compare the values", answer: "Yes", acceptableAnswers: ["Yes", "yes", "Y", "y", "true"], commonMistakes: { "No": "Both sides equal " + (3 + b) } }
                            ]
                        },
                        practice: { problem: `At x = 2: f(x) = { x² if x < 2; 2x if x ≥ 2 }. Continuous?`, answer: "Yes", options: ["Yes", "No", "Cannot determine"],
                            mistakeAnalysis: { "No": "Left: 2² = 4, Right: 2(2) = 4. Equal = continuous!", "Cannot determine": "We can check: 4 = 4, so yes!" }}
                    };
                })()
            ]
        }),
        Asymptotes: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Vertical Asymptotes
                (() => {
                    const a = rand(1, 6);
                    return {
                        id: "vertical", name: "Find Vertical Asymptotes",
                        goalProblem: `Find the vertical asymptote of f(x) = 1/(x - 4)`,
                        teachingSteps: [
                            { title: "What is a Vertical Asymptote?", explanation: "A <strong>vertical asymptote</strong> is a vertical line where the function goes to infinity.<br>Written as x = a.", visual: "Graph shoots up/down" },
                            { title: "How to Find", explanation: "Set the <strong>denominator = 0</strong> and solve for x.", visual: "Denominator = 0 → VA" },
                            { title: "Example", explanation: "f(x) = 1/(x - 4)<br>x - 4 = 0<br>x = 4<br>VA: <strong>x = 4</strong>", visual: "x = 4" }
                        ],
                        finalAnswer: "x = 4",
                        example: { problem: `VA of 1/(x - 4)`, steps: [{ text: "Set denom = 0", math: "x - 4 = 0" }, { text: "Solve", math: "x = 4" }]},
                        keyPoints: ["VA: denominator = 0", "Graph cannot cross vertical asymptote"],
                        mistakes: [{ wrong: "Using numerator", why: "VA comes from DENOMINATOR = 0" }],
                        guided: { problem: `Find VA of f(x) = 1/(x - ${a})`, steps: [{ label: "Denom = 0", value: `x - ${a} = 0` }], answer: String(a), answerLabel: "x =",
                            interactiveSteps: [
                                { prompt: `Set denominator = 0: x - ${a} = 0. Solve for x.`, hint: `Add ${a} to both sides`, answer: String(a), acceptableAnswers: [String(a), `x = ${a}`], commonMistakes: { [String(-a)]: `x - ${a} = 0 means x = ${a} (positive)` } }
                            ]
                        },
                        practice: { problem: `VA of f(x) = 2/(x + 3)?`, answer: "x = -3", options: ["x = -3", "x = 3", "x = 2", "y = 0"],
                            mistakeAnalysis: { "x = 3": "x + 3 = 0 means x = -3", "x = 2": "2 is numerator, not related to VA", "y = 0": "That's horizontal, not vertical" }}
                    };
                })(),
                // Sub-skill 2: Horizontal Asymptotes
                (() => {
                    const num = rand(2, 5), denom = rand(2, 5);
                    return {
                        id: "horizontal", name: "Find Horizontal Asymptotes",
                        goalProblem: `Find the horizontal asymptote of f(x) = 3x/(2x + 1)`,
                        teachingSteps: [
                            { title: "What is a Horizontal Asymptote?", explanation: "A <strong>horizontal asymptote</strong> shows what y approaches as x → ±∞.", visual: "Graph levels off at y = ?" },
                            { title: "Compare Degrees", explanation: "deg(top) < deg(bottom): y = 0<br>deg(top) = deg(bottom): y = ratio of leading coeffs<br>deg(top) > deg(bottom): no HA", visual: "Degree comparison" },
                            { title: "Example", explanation: "3x/(2x+1): Both degree 1<br>HA = 3/2", visual: "y = 3/2" }
                        ],
                        finalAnswer: "y = 3/2",
                        example: { problem: `HA of 3x/(2x+1)`, steps: [{ text: "Degrees", math: "Both = 1" }, { text: "HA", math: "y = 3/2" }]},
                        keyPoints: ["Same degree → ratio of leading coeffs", "Lower top degree → y = 0"],
                        mistakes: [{ wrong: "Ignoring degrees", why: "Degree comparison is essential!" }],
                        guided: { problem: `Find HA of f(x) = ${num}x/(${denom}x + 1)`, steps: [{ label: "Degrees", value: "Both 1" }], answer: `y = ${num}/${denom}`, answerLabel: "HA:",
                            interactiveSteps: [
                                { prompt: `What is the degree of numerator ${num}x?`, hint: "Power of x", answer: "1", acceptableAnswers: ["1", "degree 1"], commonMistakes: {} },
                                { prompt: `Degrees equal, so HA = ${num}/${denom} = ?`, hint: "Leading coefficients ratio", answer: String(num/denom), acceptableAnswers: [String(num/denom), `${num}/${denom}`, `y = ${num/denom}`], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `HA of f(x) = 5/(x² + 1)?`, answer: "y = 0", options: ["y = 0", "y = 5", "y = 1", "No HA"],
                            mistakeAnalysis: { "y = 5": "deg(top) < deg(bottom), so y = 0", "y = 1": "Coefficient doesn't matter here, y = 0", "No HA": "deg(top) < deg(bottom) means HA exists: y = 0" }}
                    };
                })(),
                // Sub-skill 3: Finding Both Asymptotes
                (() => {
                    const a = rand(1, 4), b = rand(1, 4);
                    return {
                        id: "both", name: "Find Both Asymptotes",
                        goalProblem: `Find both asymptotes of f(x) = (x + 2)/(x - 3)`,
                        teachingSteps: [
                            { title: "Finding VA", explanation: "Set denominator = 0:<br>x - 3 = 0 → x = 3<br>VA: <strong>x = 3</strong>", visual: "VA: x = 3" },
                            { title: "Finding HA", explanation: "Both numerator and denominator are degree 1.<br>HA = 1/1 = 1<br>HA: <strong>y = 1</strong>", visual: "HA: y = 1" },
                            { title: "Final Answer", explanation: "VA: x = 3, HA: y = 1", visual: "x = 3, y = 1" }
                        ],
                        finalAnswer: "x = 3, y = 1",
                        example: { problem: `Both asymptotes of (x+2)/(x-3)`, steps: [{ text: "VA", math: "x = 3" }, { text: "HA", math: "y = 1" }]},
                        keyPoints: ["VA from denominator = 0", "HA from degree comparison"],
                        mistakes: [{ wrong: "Mixing up VA/HA", why: "VA is x = ?, HA is y = ?" }],
                        guided: { problem: `Find both asymptotes of (x + ${a})/(x - ${b})`, steps: [{ label: "VA", value: `x = ${b}` }, { label: "HA", value: "y = 1" }], answer: `x = ${b}, y = 1`, answerLabel: "Asymptotes:",
                            interactiveSteps: [
                                { prompt: `VA: x - ${b} = 0. x = ?`, hint: "Solve for x", answer: String(b), acceptableAnswers: [String(b), `x = ${b}`], commonMistakes: {} },
                                { prompt: `HA: Same degrees. Leading coeffs are 1 and 1. y = ?`, hint: "1/1", answer: "1", acceptableAnswers: ["1", "y = 1"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Asymptotes of (x + 1)/(x - 2)?`, answer: "x = 2, y = 1", options: ["x = 2, y = 1", "x = -2, y = 1", "x = 2, y = 0", "x = 1, y = 2"],
                            mistakeAnalysis: { "x = -2, y = 1": "x - 2 = 0 gives x = 2 (positive)", "x = 2, y = 0": "Same degrees means HA = 1/1 = 1", "x = 1, y = 2": "VA from denom, HA from coeffs" }}
                    };
                })()
            ]
        }),
        Permutations: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Formula Knowledge
                (() => {
                    return {
                        id: "formula", name: "Permutation Formula",
                        goalProblem: `The permutation formula P(n,r) equals what?`,
                        teachingSteps: [
                            { title: "What is a Permutation?", explanation: "A <strong>permutation</strong> counts arrangements where <strong>order matters</strong>.", visual: "Order matters!" },
                            { title: "The Formula", explanation: "P(n,r) = n!/(n-r)!<br>Or: multiply n × (n-1) × ... for r factors", visual: "P(n,r) = n!/(n-r)!" },
                            { title: "Why This Formula?", explanation: "n choices for 1st, (n-1) for 2nd, etc.<br>Stop after r positions.", visual: "Counting positions" }
                        ],
                        finalAnswer: "n!/(n-r)!",
                        example: { problem: `P(n,r) formula`, steps: [{ text: "Formula", math: "P(n,r) = n!/(n-r)!" }]},
                        keyPoints: ["P(n,r) = n!/(n-r)!", "Order matters in permutations"],
                        mistakes: [{ wrong: "Confusing with C(n,r)", why: "C(n,r) has an extra r! in denominator" }],
                        guided: { problem: `What is the permutation formula?`, steps: [{ label: "Numerator", value: "n!" }], answer: "n!/(n-r)!", answerLabel: "P(n,r) =",
                            interactiveSteps: [
                                { prompt: `P(n,r) = n!/(?). What goes in the denominator?`, hint: "(n minus r) factorial", answer: "(n-r)!", acceptableAnswers: ["(n-r)!", "(n - r)!", "n-r!"], commonMistakes: { "r!": "That would be combination. P uses (n-r)!" } }
                            ]
                        },
                        practice: { problem: `P(n,r) = ?`, answer: "n!/(n-r)!", options: ["n!/(n-r)!", "n!/r!", "n!/(n-r)!r!", "(n-r)!"],
                            mistakeAnalysis: { "n!/r!": "That's not permutation formula", "n!/(n-r)!r!": "That's C(n,r) - combination!", "(n-r)!": "That's just part of it" }}
                    };
                })(),
                // Sub-skill 2: Calculate Permutations
                (() => {
                    const n = rand(4, 7), r = rand(2, 3);
                    let result = 1; for (let i = 0; i < r; i++) result *= (n - i);
                    const pn = rand(5, 7), pr = 2;
                    let pResult = 1; for (let i = 0; i < pr; i++) pResult *= (pn - i);
                    return {
                        id: "calculate", name: "Calculate P(n,r)",
                        goalProblem: `Calculate P(5, 3)`,
                        teachingSteps: [
                            { title: "Quick Method", explanation: "P(5,3): Start at 5, multiply 3 numbers going down<br>5 × 4 × 3 = 60", visual: "5 × 4 × 3 = 60" },
                            { title: "Using Formula", explanation: "P(5,3) = 5!/(5-3)! = 5!/2!<br>= 120/2 = 60", visual: "5!/2! = 60" }
                        ],
                        finalAnswer: "60",
                        example: { problem: `P(5,3)`, steps: [{ text: "Calculate", math: "5 × 4 × 3 = 60" }]},
                        keyPoints: ["Multiply r consecutive numbers starting from n", "P(n,r) = n × (n-1) × ... (r factors)"],
                        mistakes: [{ wrong: "Using addition", why: "Multiply, don't add!" }],
                        guided: { problem: `Calculate P(${n}, ${r})`, steps: [{ label: "First factor", value: String(n) }], answer: String(result), answerLabel: `P(${n},${r}) =`,
                            interactiveSteps: [
                                { prompt: `P(${n},${r}): Multiply ${r} numbers starting from ${n}. What is ${n} × ${n-1}${r > 2 ? ` × ${n-2}` : ''}?`, hint: "Multiply them together", answer: String(result), acceptableAnswers: [String(result)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Calculate P(${pn}, ${pr})`, answer: String(pResult), options: [String(pResult), String(pn * pr), String(pn + pn - 1), String(pResult / 2)],
                            mistakeAnalysis: { [String(pn * pr)]: `Don't multiply n × r. P(${pn},${pr}) = ${pn} × ${pn-1} = ${pResult}`, [String(pn + pn - 1)]: "Multiply, don't add!" }}
                    };
                })(),
                // Sub-skill 3: Word Problems
                (() => {
                    const n = rand(4, 6);
                    let factorial = 1; for (let i = 2; i <= n; i++) factorial *= i;
                    return {
                        id: "word", name: "Permutation Word Problems",
                        goalProblem: `How many ways can 5 books be arranged on a shelf?`,
                        teachingSteps: [
                            { title: "Recognize Permutation", explanation: "Key words: arrange, order, positions, sequence<br>These mean ORDER MATTERS → Permutation", visual: "Arrange = Permutation" },
                            { title: "Arranging All Items", explanation: "Arranging n items in n positions = n!<br>5 books: 5! = 120", visual: "5! = 120" }
                        ],
                        finalAnswer: "120",
                        example: { problem: `Arrange 5 books`, steps: [{ text: "All positions", math: "5! = 120" }]},
                        keyPoints: ["'Arrange' means order matters", "All items in all positions = n!"],
                        mistakes: [{ wrong: "Using combination", why: "Arrangement implies ORDER" }],
                        guided: { problem: `How many ways to arrange ${n} different books?`, steps: [{ label: "n", value: String(n) }], answer: String(factorial), answerLabel: "Arrangements:",
                            interactiveSteps: [
                                { prompt: `Does arranging books mean order matters?`, hint: "Book A first vs Book B first...", answer: "yes", acceptableAnswers: ["yes", "Yes"], commonMistakes: {} },
                                { prompt: `Calculate ${n}! = ${n} × ${n-1} × ... × 1`, hint: "Multiply all numbers from ${n} down to 1", answer: String(factorial), acceptableAnswers: [String(factorial)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Arrange ${n} trophies on a shelf. How many ways?`, answer: String(factorial), options: [String(factorial), String(n * n), String(n * 2), String(n)],
                            mistakeAnalysis: { [String(n * n)]: `That's n². We need n! = ${factorial}`, [String(n * 2)]: "Multiply all numbers: n!", [String(n)]: `${n} is just n. We need ${n}! = ${factorial}` }}
                    };
                })()
            ]
        }),
        Combinations: () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Formula Knowledge
                (() => {
                    return {
                        id: "formula", name: "Combination Formula",
                        goalProblem: `The combination formula C(n,r) equals what?`,
                        teachingSteps: [
                            { title: "What is a Combination?", explanation: "A <strong>combination</strong> counts selections where <strong>order doesn't matter</strong>.", visual: "Order doesn't matter!" },
                            { title: "The Formula", explanation: "C(n,r) = n!/[r!(n-r)!]<br>Or: P(n,r)/r!", visual: "C(n,r) = n!/[r!(n-r)!]" },
                            { title: "Why Divide by r!?", explanation: "We remove duplicate orderings.<br>ABC, ACB, BAC... are all the same combo.", visual: "Remove duplicates" }
                        ],
                        finalAnswer: "n!/(r!(n-r)!)",
                        example: { problem: `C(n,r) formula`, steps: [{ text: "Formula", math: "C(n,r) = n!/[r!(n-r)!]" }]},
                        keyPoints: ["C(n,r) = n!/[r!(n-r)!]", "Order doesn't matter"],
                        mistakes: [{ wrong: "Confusing with P(n,r)", why: "C divides by r! because order doesn't matter" }],
                        guided: { problem: `What is the combination formula?`, steps: [{ label: "Numerator", value: "n!" }], answer: "n!/(r!(n-r)!)", answerLabel: "C(n,r) =",
                            interactiveSteps: [
                                { prompt: `C(n,r) = n!/(?). What's in the denominator?`, hint: "Two factorials multiplied", answer: "r!(n-r)!", acceptableAnswers: ["r!(n-r)!", "(n-r)!r!", "r! × (n-r)!"], commonMistakes: { "(n-r)!": "Need r! too!" } }
                            ]
                        },
                        practice: { problem: `C(n,r) = ?`, answer: "n!/(r!(n-r)!)", options: ["n!/(r!(n-r)!)", "n!/(n-r)!", "n!/r!", "r!(n-r)!"],
                            mistakeAnalysis: { "n!/(n-r)!": "That's P(n,r) - permutation!", "n!/r!": "Missing (n-r)!", "r!(n-r)!": "That's the denominator only" }}
                    };
                })(),
                // Sub-skill 2: Calculate Combinations
                (() => {
                    const n = rand(5, 8), r = rand(2, 3);
                    let num = 1, den = 1; for (let i = 0; i < r; i++) { num *= (n - i); den *= (i + 1); }
                    const result = num / den;
                    const pn = rand(6, 8), pr = 2;
                    let pNum = 1, pDen = 1; for (let i = 0; i < pr; i++) { pNum *= (pn - i); pDen *= (i + 1); }
                    const pResult = pNum / pDen;
                    return {
                        id: "calculate", name: "Calculate C(n,r)",
                        goalProblem: `Calculate C(8, 3)`,
                        teachingSteps: [
                            { title: "Method", explanation: "C(8,3) = (8×7×6)/(3×2×1)<br>= 336/6 = 56", visual: "(8×7×6)/(3!) = 56" },
                            { title: "Steps", explanation: "1. Numerator: 8×7×6 = 336<br>2. Denominator: 3! = 6<br>3. Divide: 336/6 = 56", visual: "56" }
                        ],
                        finalAnswer: "56",
                        example: { problem: `C(8,3)`, steps: [{ text: "Num", math: "8×7×6 = 336" }, { text: "Den", math: "3! = 6" }, { text: "Divide", math: "56" }]},
                        keyPoints: ["Top: r factors starting from n", "Bottom: r!"],
                        mistakes: [{ wrong: "Forgetting to divide", why: "Must divide by r!" }],
                        guided: { problem: `Calculate C(${n}, ${r})`, steps: [{ label: "Numerator", value: String(num) }], answer: String(result), answerLabel: `C(${n},${r}) =`,
                            interactiveSteps: [
                                { prompt: `Numerator: ${n} × ${n-1}${r > 2 ? ` × ${n-2}` : ''} = ?`, hint: "Multiply", answer: String(num), acceptableAnswers: [String(num)], commonMistakes: {} },
                                { prompt: `Denominator: ${r}! = ?`, hint: `${r} × ${r-1}${r > 2 ? ` × 1` : ''}`, answer: String(den), acceptableAnswers: [String(den)], commonMistakes: {} },
                                { prompt: `Divide: ${num} ÷ ${den} = ?`, hint: "Divide", answer: String(result), acceptableAnswers: [String(result)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Calculate C(${pn}, ${pr})`, answer: String(pResult), options: [String(pResult), String(pNum), String(pn * pr), String(pResult * 2)],
                            mistakeAnalysis: { [String(pNum)]: `Don't forget to divide by ${pr}!`, [String(pn * pr)]: "Use the formula, not simple multiplication" }}
                    };
                })(),
                // Sub-skill 3: Word Problems
                (() => {
                    const n = rand(8, 12), r = rand(3, 4);
                    let num = 1, den = 1; for (let i = 0; i < r; i++) { num *= (n - i); den *= (i + 1); }
                    const result = num / den;
                    return {
                        id: "word", name: "Combination Word Problems",
                        goalProblem: `How many ways to choose 3 people for a committee from 10?`,
                        teachingSteps: [
                            { title: "Recognize Combination", explanation: "Key words: choose, select, committee, group, team<br>These mean ORDER DOESN'T MATTER → Combination", visual: "Select/Choose = Combination" },
                            { title: "Calculate", explanation: "C(10,3) = (10×9×8)/(3×2×1) = 720/6 = 120", visual: "120 ways" }
                        ],
                        finalAnswer: "120",
                        example: { problem: `Committee of 3 from 10`, steps: [{ text: "No order", math: "Combination" }, { text: "Calculate", math: "C(10,3) = 120" }]},
                        keyPoints: ["'Choose', 'select', 'committee' = order doesn't matter", "Use combination"],
                        mistakes: [{ wrong: "Using permutation", why: "Committees have no order!" }],
                        guided: { problem: `How many ways to choose ${r} from ${n} for a team?`, steps: [{ label: "n,r", value: `${n},${r}` }], answer: String(result), answerLabel: "Ways:",
                            interactiveSteps: [
                                { prompt: `Does order matter for a 'team'?`, hint: "Just a group", answer: "no", acceptableAnswers: ["no", "No"], commonMistakes: {} },
                                { prompt: `Calculate C(${n},${r})`, hint: "Use the formula", answer: String(result), acceptableAnswers: [String(result)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Choose ${r} students from ${n} for a committee`, answer: String(result), options: [String(result), String(num), String(n * r), String(result / 2)],
                            mistakeAnalysis: { [String(num)]: `Divide by ${r}! = ${den}`, [String(n * r)]: "Use combination formula" }}
                    };
                })()
            ]
        }),
        "Expected Value": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Dice Expected Value
                (() => {
                    return {
                        id: "dice", name: "Dice Expected Value",
                        goalProblem: `Roll a fair die. What is the expected value?`,
                        teachingSteps: [
                            { title: "What is Expected Value?", explanation: "<strong>Expected value</strong> is the average outcome over many trials.", visual: "Long-run average" },
                            { title: "Fair Die", explanation: "6 faces, each with P = 1/6.<br>E(X) = 1(1/6) + 2(1/6) + ... + 6(1/6)", visual: "Sum × probability" },
                            { title: "Calculate", explanation: "E(X) = (1+2+3+4+5+6)/6 = 21/6 = <strong>3.5</strong>", visual: "3.5" }
                        ],
                        finalAnswer: "3.5",
                        example: { problem: `E(X) for fair die`, steps: [{ text: "Sum 1-6", math: "21" }, { text: "Divide by 6", math: "3.5" }]},
                        keyPoints: ["E(X) = Σ(value × probability)", "Fair die: each face has P = 1/6"],
                        mistakes: [{ wrong: "Using 3 or 4", why: "It's the average: 3.5" }],
                        guided: { problem: `Expected value of fair die roll?`, steps: [{ label: "Sum", value: "21" }], answer: "3.5", answerLabel: "E(X) =",
                            interactiveSteps: [
                                { prompt: `Sum of 1+2+3+4+5+6 = ?`, hint: "Add all faces", answer: "21", acceptableAnswers: ["21"], commonMistakes: {} },
                                { prompt: `21 ÷ 6 = ?`, hint: "Average", answer: "3.5", acceptableAnswers: ["3.5", "21/6"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `E(X) for fair die?`, answer: "3.5", options: ["3.5", "3", "4", "6"],
                            mistakeAnalysis: { "3": "It's 21/6 = 3.5", "4": "21/6 = 3.5", "6": "That's the max, not average" }}
                    };
                })(),
                // Sub-skill 2: Coin Flip Games
                (() => {
                    const win = rand(5, 10), lose = rand(2, 4);
                    const ev = (0.5 * win - 0.5 * lose).toFixed(2);
                    return {
                        id: "coins", name: "Coin Flip Expected Value",
                        goalProblem: `Flip coin: win $8 for heads, lose $4 for tails. Expected value?`,
                        teachingSteps: [
                            { title: "Setup", explanation: "Heads: +$8 (P = 0.5)<br>Tails: -$4 (P = 0.5)", visual: "Win or lose" },
                            { title: "Calculate", explanation: "E(X) = 0.5(8) + 0.5(-4) = 4 - 2 = <strong>$2</strong>", visual: "$2" }
                        ],
                        finalAnswer: "$2",
                        example: { problem: `Win $8, lose $4`, steps: [{ text: "Calculate", math: "0.5(8) + 0.5(-4) = $2" }]},
                        keyPoints: ["Each coin side has P = 0.5", "Losses are negative"],
                        mistakes: [{ wrong: "Forgetting negative for loss", why: "Losing $4 means -4" }],
                        guided: { problem: `Win $${win} heads, lose $${lose} tails. E(X)?`, steps: [{ label: "Win term", value: String(0.5 * win) }], answer: `$${ev}`, answerLabel: "E(X) =",
                            interactiveSteps: [
                                { prompt: `0.5 × ${win} = ?`, hint: "Half of win amount", answer: String(0.5 * win), acceptableAnswers: [String(0.5 * win)], commonMistakes: {} },
                                { prompt: `0.5 × (-${lose}) = ?`, hint: "Loss is negative", answer: String(-0.5 * lose), acceptableAnswers: [String(-0.5 * lose)], commonMistakes: {} },
                                { prompt: `${0.5 * win} + ${-0.5 * lose} = ?`, hint: "Add them", answer: ev, acceptableAnswers: [ev, `$${ev}`], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Win $10 (heads), lose $6 (tails). E(X)?`, answer: "$2", options: ["$2", "$4", "$8", "-$2"],
                            mistakeAnalysis: { "$4": "0.5(10) + 0.5(-6) = 5 - 3 = $2", "$8": "That's just the win amount", "-$2": "Check signs: 5 - 3 = +2" }}
                    };
                })(),
                // Sub-skill 3: Custom Probability Games
                (() => {
                    const p1 = 0.3, v1 = rand(10, 20), p2 = 0.7, v2 = rand(2, 8);
                    const ev = (p1 * v1 + p2 * v2).toFixed(2);
                    return {
                        id: "custom", name: "Custom Probability E(X)",
                        goalProblem: `30% chance win $15, 70% chance win $5. Expected value?`,
                        teachingSteps: [
                            { title: "Formula", explanation: "E(X) = value₁ × prob₁ + value₂ × prob₂", visual: "Weighted average" },
                            { title: "Calculate", explanation: "E(X) = 15(0.3) + 5(0.7) = 4.5 + 3.5 = <strong>$8</strong>", visual: "$8" }
                        ],
                        finalAnswer: "$8",
                        example: { problem: `30% for $15, 70% for $5`, steps: [{ text: "Calculate", math: "15(0.3) + 5(0.7) = $8" }]},
                        keyPoints: ["Multiply value × probability for each outcome", "Add all products"],
                        mistakes: [{ wrong: "Adding probabilities", why: "Multiply value BY probability, then add" }],
                        guided: { problem: `30% win $${v1}, 70% win $${v2}. E(X)?`, steps: [{ label: "Term 1", value: String((p1 * v1).toFixed(1)) }], answer: `$${ev}`, answerLabel: "E(X) =",
                            interactiveSteps: [
                                { prompt: `0.3 × ${v1} = ?`, hint: "30% of ${v1}", answer: String((p1 * v1).toFixed(1)), acceptableAnswers: [String(p1 * v1), String((p1 * v1).toFixed(1))], commonMistakes: {} },
                                { prompt: `0.7 × ${v2} = ?`, hint: "70% of ${v2}", answer: String((p2 * v2).toFixed(1)), acceptableAnswers: [String(p2 * v2), String((p2 * v2).toFixed(1))], commonMistakes: {} },
                                { prompt: `Add them together`, hint: "Sum the products", answer: ev, acceptableAnswers: [ev, `$${ev}`], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `40% win $20, 60% win $5. E(X)?`, answer: "$11", options: ["$11", "$12.50", "$25", "$8"],
                            mistakeAnalysis: { "$12.50": "0.4(20) + 0.6(5) = 8 + 3 = $11", "$25": "That's 20+5, not E(X)", "$8": "That's just the first term" }}
                    };
                })()
            ]
        }),
        "Synthetic Division": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Setup
                (() => {
                    const a = rand(1, 4);
                    return {
                        id: "setup", name: "Setup Synthetic Division",
                        goalProblem: `To divide by (x - 3) using synthetic division, use which number?`,
                        teachingSteps: [
                            { title: "What is Synthetic Division?", explanation: "A shortcut for dividing polynomials by (x - c).", visual: "Fast polynomial division" },
                            { title: "Finding c", explanation: "For (x - c), use +c in the box.<br>For (x - 3), use c = 3.<br>For (x + 2), use c = -2.", visual: "x - 3 → use 3" }
                        ],
                        finalAnswer: "3",
                        example: { problem: `Divide by (x - 3)`, steps: [{ text: "c value", math: "3 (opposite sign)" }]},
                        keyPoints: ["x - c → use +c", "x + c → use -c"],
                        mistakes: [{ wrong: "Wrong sign", why: "(x - 3) means use +3, not -3" }],
                        guided: { problem: `For (x - ${a}), what c value?`, steps: [{ label: "Divisor", value: `x - ${a}` }], answer: String(a), answerLabel: "c =",
                            interactiveSteps: [
                                { prompt: `(x - ${a}): what number do we use?`, hint: "Opposite of the sign in divisor", answer: String(a), acceptableAnswers: [String(a)], commonMistakes: { [String(-a)]: `(x - ${a}) means c = +${a}` } }
                            ]
                        },
                        practice: { problem: `For (x - 5), use c = ?`, answer: "5", options: ["5", "-5", "0", "1"],
                            mistakeAnalysis: { "-5": "(x - 5) means use +5", "0": "We use the number from the divisor", "1": "Use the actual number: 5" }}
                    };
                })(),
                // Sub-skill 2: Perform Division
                (() => {
                    const a = rand(1, 3), other = rand(-3, 3);
                    return {
                        id: "divide", name: "Perform Synthetic Division",
                        goalProblem: `Divide (x² - 4x + 3) by (x - 1). Quotient?`,
                        teachingSteps: [
                            { title: "Setup", explanation: "c = 1, coefficients: 1, -4, 3<br>1 | 1  -4  3", visual: "Setup the box" },
                            { title: "Process", explanation: "Bring down 1<br>1×1=1, -4+1=-3<br>1×(-3)=-3, 3+(-3)=0", visual: "1, -3, 0" },
                            { title: "Answer", explanation: "Quotient: x - 3, R = 0", visual: "x - 3" }
                        ],
                        finalAnswer: "x - 3",
                        example: { problem: `(x² - 4x + 3) ÷ (x - 1)`, steps: [{ text: "Result", math: "x - 3" }]},
                        keyPoints: ["Multiply, then add", "Last number is remainder"],
                        mistakes: [{ wrong: "Adding before multiplying", why: "MULTIPLY first, then ADD" }],
                        guided: { problem: `(x² + ${-(a+other)}x + ${a*other}) ÷ (x - ${a}). Quotient?`, steps: [{ label: "c", value: String(a) }], answer: `x + ${-other}`, answerLabel: "Quotient:",
                            interactiveSteps: [
                                { prompt: `Coefficients are 1, ${-(a+other)}, ${a*other}. First: bring down 1. Multiply 1 × ${a} = ${a}. Add: ${-(a+other)} + ${a} = ?`, hint: "Add them", answer: String(-other), acceptableAnswers: [String(-other)], commonMistakes: {} },
                                { prompt: `Multiply ${-other} × ${a} = ${-other * a}. Add: ${a*other} + ${-other * a} = ?`, hint: "This is the remainder", answer: "0", acceptableAnswers: ["0"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `(x² + 2x - 15) ÷ (x - 3). Quotient?`, answer: "x + 5", options: ["x + 5", "x - 5", "x + 3", "x² - 5"],
                            mistakeAnalysis: { "x - 5": "Check your signs", "x + 3": "That's the divisor value", "x² - 5": "Quotient is one degree less" }}
                    };
                })(),
                // Sub-skill 3: Remainder Theorem
                (() => {
                    const a = rand(1, 3), b = rand(-5, 5), c = rand(-10, 10);
                    const remainder = a * a + b * a + c;
                    return {
                        id: "remainder", name: "Remainder Theorem",
                        goalProblem: `Find f(2) for f(x) = x² + 3x - 5 using remainder theorem`,
                        teachingSteps: [
                            { title: "Remainder Theorem", explanation: "f(c) = remainder when f(x) is divided by (x - c).", visual: "f(c) = remainder" },
                            { title: "Calculate", explanation: "f(2) = 2² + 3(2) - 5 = 4 + 6 - 5 = <strong>5</strong>", visual: "f(2) = 5" }
                        ],
                        finalAnswer: "5",
                        example: { problem: `f(2) for x² + 3x - 5`, steps: [{ text: "Substitute", math: "4 + 6 - 5 = 5" }]},
                        keyPoints: ["f(c) equals the remainder", "Can use direct substitution"],
                        mistakes: [{ wrong: "Incorrect substitution", why: "Replace ALL x's with c" }],
                        guided: { problem: `f(${a}) for f(x) = x² + ${b}x + ${c}`, steps: [{ label: "x²", value: String(a*a) }], answer: String(remainder), answerLabel: `f(${a}) =`,
                            interactiveSteps: [
                                { prompt: `Calculate ${a}²`, hint: `${a} × ${a}`, answer: String(a*a), acceptableAnswers: [String(a*a)], commonMistakes: {} },
                                { prompt: `Calculate ${b} × ${a}`, hint: "Multiply", answer: String(b*a), acceptableAnswers: [String(b*a)], commonMistakes: {} },
                                { prompt: `Add: ${a*a} + ${b*a} + ${c} = ?`, hint: "Sum all terms", answer: String(remainder), acceptableAnswers: [String(remainder)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `f(3) for f(x) = x² - 2x + 1`, answer: "4", options: ["4", "3", "10", "1"],
                            mistakeAnalysis: { "3": "f(3) = 9 - 6 + 1 = 4", "10": "Check calculation: 9 - 6 + 1 = 4", "1": "Substitute 3 for x" }}
                    };
                })()
            ]
        }),
        "Binomial Theorem": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Pascal's Triangle
                (() => {
                    const row = rand(3, 5);
                    const pascalRows = { 3: "1 3 3 1", 4: "1 4 6 4 1", 5: "1 5 10 10 5 1" };
                    return {
                        id: "pascal", name: "Pascal's Triangle",
                        goalProblem: `What is row 4 of Pascal's Triangle?`,
                        teachingSteps: [
                            { title: "Pascal's Triangle", explanation: "Each number is the sum of the two above it.<br>Row 0: 1<br>Row 1: 1 1<br>Row 2: 1 2 1<br>Row 3: 1 3 3 1<br>Row 4: 1 4 6 4 1", visual: "Add adjacent numbers" },
                            { title: "Use for Binomial", explanation: "Row n gives coefficients for (a+b)ⁿ", visual: "Row 3 → (a+b)³" }
                        ],
                        finalAnswer: "1 4 6 4 1",
                        example: { problem: `Row 4 of Pascal's`, steps: [{ text: "Pattern", math: "1 4 6 4 1" }]},
                        keyPoints: ["Each row adds adjacent numbers", "Row n for (a+b)ⁿ"],
                        mistakes: [{ wrong: "Forgetting 1s on ends", why: "Each row starts and ends with 1" }],
                        guided: { problem: `What is row ${row} of Pascal's Triangle?`, steps: [{ label: "Previous row", value: row === 3 ? "1 2 1" : row === 4 ? "1 3 3 1" : "1 4 6 4 1" }], answer: pascalRows[row], answerLabel: `Row ${row}:`,
                            interactiveSteps: [
                                { prompt: `Row ${row} of Pascal's Triangle?`, hint: "Add adjacent numbers from row " + (row - 1), answer: pascalRows[row], acceptableAnswers: [pascalRows[row], pascalRows[row].replace(/ /g, ", ")], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Row ${row === 3 ? 4 : 3} of Pascal's Triangle?`, answer: row === 3 ? "1 4 6 4 1" : "1 3 3 1", options: ["1 3 3 1", "1 4 6 4 1", "1 2 1", "1 5 10 10 5 1"],
                            mistakeAnalysis: { "1 2 1": "That's row 2", "1 5 10 10 5 1": "That's row 5" }}
                    };
                })(),
                // Sub-skill 2: Finding Coefficients
                (() => {
                    const n = 4, k = rand(1, 3);
                    const coef = { 1: 4, 2: 6, 3: 4 };
                    return {
                        id: "coefficient", name: "Find Coefficients",
                        goalProblem: `In (a + b)⁴, what is the coefficient of a²b²?`,
                        teachingSteps: [
                            { title: "Finding Coefficients", explanation: "Use Pascal's Triangle or C(n,k).<br>Row 4: 1, 4, 6, 4, 1<br>Middle term (k=2) has coefficient 6.", visual: "C(4,2) = 6" },
                            { title: "Position", explanation: "Term with aⁿ⁻ᵏbᵏ has coefficient C(n,k)", visual: "a²b² → C(4,2) = 6" }
                        ],
                        finalAnswer: "6",
                        example: { problem: `Coefficient of a²b² in (a+b)⁴`, steps: [{ text: "From Pascal's", math: "6" }]},
                        keyPoints: ["Use C(n,k) for aⁿ⁻ᵏbᵏ term", "Or use Pascal's Triangle"],
                        mistakes: [{ wrong: "Wrong position", why: "Count from k=0" }],
                        guided: { problem: `In (a+b)⁴, coefficient of a^${4-k}b^${k}?`, steps: [{ label: "k value", value: String(k) }], answer: String(coef[k]), answerLabel: "Coefficient:",
                            interactiveSteps: [
                                { prompt: `Row 4 is 1,4,6,4,1. Position ${k} (starting from 0) gives coefficient?`, hint: "Count: 0→1, 1→4, 2→6...", answer: String(coef[k]), acceptableAnswers: [String(coef[k])], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `In (a+b)⁴, coefficient of a³b?`, answer: "4", options: ["4", "6", "3", "1"],
                            mistakeAnalysis: { "6": "That's for a²b². a³b has coefficient 4", "3": "Use Pascal's row 4: 1,4,6,4,1", "1": "1 is for a⁴ or b⁴" }}
                    };
                })(),
                // Sub-skill 3: Simple Expansion
                (() => {
                    return {
                        id: "expand_simple", name: "Expand (x+1)²",
                        goalProblem: `Expand (x + 1)²`,
                        teachingSteps: [
                            { title: "FOIL or Pascal", explanation: "(x+1)² = (x+1)(x+1)<br>= x² + x + x + 1<br>= x² + 2x + 1", visual: "x² + 2x + 1" },
                            { title: "Using Pascal", explanation: "Row 2: 1, 2, 1<br>1·x² + 2·x¹·1¹ + 1·1² = x² + 2x + 1", visual: "Same result!" }
                        ],
                        finalAnswer: "x² + 2x + 1",
                        example: { problem: `(x+1)²`, steps: [{ text: "Expand", math: "x² + 2x + 1" }]},
                        keyPoints: ["(x+1)² = x² + 2x + 1", "Middle term is 2x, not just x"],
                        mistakes: [{ wrong: "Forgetting middle term", why: "(x+1)² ≠ x² + 1" }],
                        guided: { problem: `Expand (x + 1)²`, steps: [{ label: "Row 2", value: "1, 2, 1" }], answer: "x² + 2x + 1", answerLabel: "Expansion:",
                            interactiveSteps: [
                                { prompt: `(x+1)² = x² + ?x + 1. What is the missing coefficient?`, hint: "Row 2 of Pascal: 1, 2, 1", answer: "2", acceptableAnswers: ["2"], commonMistakes: { "1": "Middle term is 2x, not x" } }
                            ]
                        },
                        practice: { problem: `(x + 1)² = ?`, answer: "x² + 2x + 1", options: ["x² + 2x + 1", "x² + x + 1", "x² + 1", "2x² + 2x"],
                            mistakeAnalysis: { "x² + x + 1": "Coefficient is 2, not 1", "x² + 1": "Missing the 2x term!", "2x² + 2x": "Check the formula" }}
                    };
                })()
            ]
        }),
        "Matrices Intro": () => ({
            hasSubSkills: true,
            subSkills: [
                // Sub-skill 1: Matrix Dimensions
                (() => {
                    const rows = rand(2, 4), cols = rand(2, 4);
                    return {
                        id: "dimensions", name: "Matrix Dimensions",
                        goalProblem: `A matrix with 3 rows and 2 columns has dimensions?`,
                        teachingSteps: [
                            { title: "What is a Matrix?", explanation: "A <strong>matrix</strong> is a rectangular array of numbers in rows and columns.", visual: "Like a spreadsheet" },
                            { title: "Dimensions", explanation: "Written as <strong>rows × columns</strong>.<br>3 rows, 2 columns = 3×2 matrix", visual: "rows × columns" }
                        ],
                        finalAnswer: "3 × 2",
                        example: { problem: `3 rows, 2 columns`, steps: [{ text: "Format", math: "3 × 2" }]},
                        keyPoints: ["Rows first, then columns", "Written as m × n"],
                        mistakes: [{ wrong: "Reversing order", why: "Rows × Columns, not Columns × Rows" }],
                        guided: { problem: `${rows} rows, ${cols} columns = ?`, steps: [{ label: "Format", value: "rows × cols" }], answer: `${rows} × ${cols}`, answerLabel: "Dimensions:",
                            interactiveSteps: [
                                { prompt: `${rows} rows and ${cols} columns. Dimensions?`, hint: "Rows × Columns", answer: `${rows} × ${cols}`, acceptableAnswers: [`${rows} × ${cols}`, `${rows}x${cols}`, `${rows} x ${cols}`], commonMistakes: { [`${cols} × ${rows}`]: "Rows first! " + rows + " × " + cols } }
                            ]
                        },
                        practice: { problem: `2 rows, 4 columns = ?`, answer: "2 × 4", options: ["2 × 4", "4 × 2", "8", "6"],
                            mistakeAnalysis: { "4 × 2": "Rows × Columns: 2 × 4", "8": "That's 2×4 multiplied, not dimensions", "6": "That's 2+4" }}
                    };
                })(),
                // Sub-skill 2: Matrix Addition
                (() => {
                    const a = rand(1, 5), b = rand(1, 5), c = rand(1, 5), d = rand(1, 5);
                    const e = rand(1, 5), f = rand(1, 5), g = rand(1, 5), h = rand(1, 5);
                    return {
                        id: "add", name: "Matrix Addition",
                        goalProblem: `Add: [2 3; 1 4] + [5 1; 2 0]`,
                        teachingSteps: [
                            { title: "Addition Rule", explanation: "Add <strong>corresponding elements</strong>.<br>Top-left + Top-left, etc.", visual: "Element by element" },
                            { title: "Example", explanation: "[2+5  3+1; 1+2  4+0] = [7 4; 3 4]", visual: "[7 4; 3 4]" }
                        ],
                        finalAnswer: "[7 4; 3 4]",
                        example: { problem: `Matrix addition`, steps: [{ text: "Add each", math: "2+5=7, 3+1=4, 1+2=3, 4+0=4" }]},
                        keyPoints: ["Must be same dimensions", "Add corresponding elements"],
                        mistakes: [{ wrong: "Adding different sizes", why: "Dimensions must match!" }],
                        guided: { problem: `[${a} ${b}; ${c} ${d}] + [${e} ${f}; ${g} ${h}]. Top-left?`, steps: [{ label: `${a}+${e}`, value: String(a+e) }], answer: String(a + e), answerLabel: "Top-left:",
                            interactiveSteps: [
                                { prompt: `Top-left: ${a} + ${e} = ?`, hint: "Add", answer: String(a+e), acceptableAnswers: [String(a+e)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `[1 2] + [3 4] = ?`, answer: "[4 6]", options: ["[4 6]", "[3 8]", "[1 2 3 4]", "10"],
                            mistakeAnalysis: { "[3 8]": "Add positions: 1+3=4, 2+4=6", "[1 2 3 4]": "Add, don't concatenate", "10": "Keep matrix form" }}
                    };
                })(),
                // Sub-skill 3: Scalar Multiplication
                (() => {
                    const k = rand(2, 5), a = rand(1, 5), b = rand(1, 5);
                    return {
                        id: "scalar_mult", name: "Scalar Multiplication",
                        goalProblem: `3 × [2 4] = ?`,
                        teachingSteps: [
                            { title: "Scalar Multiplication", explanation: "Multiply <strong>every element</strong> by the scalar (single number).", visual: "k × [a b] = [ka kb]" },
                            { title: "Example", explanation: "3 × [2 4] = [3×2  3×4] = [6 12]", visual: "[6 12]" }
                        ],
                        finalAnswer: "[6 12]",
                        example: { problem: `3 × [2 4]`, steps: [{ text: "Multiply each", math: "[6 12]" }]},
                        keyPoints: ["Multiply every element", "Scalar = single number"],
                        mistakes: [{ wrong: "Only multiplying first element", why: "Multiply ALL elements" }],
                        guided: { problem: `${k} × [${a} ${b}] = ?`, steps: [{ label: `${k}×${a}`, value: String(k*a) }], answer: `[${k*a} ${k*b}]`, answerLabel: "Result:",
                            interactiveSteps: [
                                { prompt: `${k} × ${a} = ?`, hint: "Multiply", answer: String(k*a), acceptableAnswers: [String(k*a)], commonMistakes: {} },
                                { prompt: `${k} × ${b} = ?`, hint: "Multiply", answer: String(k*b), acceptableAnswers: [String(k*b)], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `4 × [1 3] = ?`, answer: "[4 12]", options: ["[4 12]", "[4 3]", "[5 7]", "16"],
                            mistakeAnalysis: { "[4 3]": "Multiply BOTH: 4×3=12", "[5 7]": "Multiply, don't add", "16": "Keep matrix form" }}
                    };
                })(),
                // Sub-skill 4: Finding Elements
                (() => {
                    const matrix = [[rand(1, 9), rand(1, 9)], [rand(1, 9), rand(1, 9)]];
                    const row = rand(1, 2), col = rand(1, 2);
                    return {
                        id: "element", name: "Find Matrix Elements",
                        goalProblem: `Matrix [3 5; 7 2]. Element at row 2, column 1?`,
                        teachingSteps: [
                            { title: "Matrix Elements", explanation: "Elements identified by <strong>row, column</strong> position.", visual: "a₂₁ = row 2, col 1" },
                            { title: "Example", explanation: "[3 5; 7 2]<br>Row 2, Col 1 = <strong>7</strong>", visual: "7" }
                        ],
                        finalAnswer: "7",
                        example: { problem: `Row 2, Col 1 of [3 5; 7 2]`, steps: [{ text: "Find", math: "7" }]},
                        keyPoints: ["Row first, then column", "Count from 1, not 0"],
                        mistakes: [{ wrong: "Reversing row/column", why: "Row is horizontal, column is vertical" }],
                        guided: { problem: `[${matrix[0][0]} ${matrix[0][1]}; ${matrix[1][0]} ${matrix[1][1]}]. Row ${row}, Col ${col}?`, steps: [{ label: "Position", value: `r${row}c${col}` }], answer: String(matrix[row-1][col-1]), answerLabel: "Element:",
                            interactiveSteps: [
                                { prompt: `Row ${row}, Column ${col} = ?`, hint: "Count rows down, columns across", answer: String(matrix[row-1][col-1]), acceptableAnswers: [String(matrix[row-1][col-1])], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `[1 2; 3 4]. Row 1, Col 2?`, answer: "2", options: ["2", "3", "1", "4"],
                            mistakeAnalysis: { "3": "Row 1 is [1 2]. Col 2 = 2", "1": "Col 2, not Col 1", "4": "That's row 2, col 2" }}
                    };
                })()
            ]
        })
    },
    8: {
        "Trig Functions": () => ({
            goalProblem: `Find sin(180°) and cos(180°)`,
            teachingSteps: [
                {
                    title: "Trig Functions Beyond Triangles",
                    explanation: "In Pre-Calc, we extend trig functions beyond right triangles using the <strong>Unit Circle</strong>.<br><br>This lets us find sin/cos for ANY angle (even negative or greater than 90°)!",
                    visual: "Unit Circle → Trig for ALL angles"
                },
                {
                    title: "The Unit Circle",
                    explanation: "The <strong>Unit Circle</strong> is:<br><br>• A circle with <strong>radius = 1</strong><br>• Centered at the <strong>origin (0,0)</strong><br>• Angles measured from the positive x-axis<br>• Going counter-clockwise = positive angles",
                    visual: "Radius = 1, centered at (0,0)"
                },
                {
                    title: "The Key Insight: Coordinates = sin and cos",
                    explanation: "For any point on the unit circle at angle θ:<br><br>• <strong>x-coordinate = cos(θ)</strong><br>• <strong>y-coordinate = sin(θ)</strong><br><br>The point is (cos θ, sin θ)!",
                    visual: "Point = (cos θ, sin θ) → cos = x, sin = y"
                },
                {
                    title: "Key Angles to Memorize",
                    explanation: "• 0°: (1, 0) → cos=1, sin=0<br>• 90°: (0, 1) → cos=0, sin=1<br>• 180°: (-1, 0) → cos=-1, sin=0<br>• 270°: (0, -1) → cos=0, sin=-1<br>• 360°: (1, 0) → same as 0°",
                    visual: "0°→(1,0) | 90°→(0,1) | 180°→(-1,0) | 270°→(0,-1)"
                },
                {
                    title: "Step 1: Locate 180° on the Unit Circle",
                    explanation: "180° is halfway around the circle.<br><br>Starting from the positive x-axis and going counter-clockwise 180°, we land on the <strong>negative x-axis</strong>.",
                    visual: "180° = negative x-axis"
                },
                {
                    title: "Step 2: Find the Point",
                    explanation: "At 180°, the point on the unit circle is:<br><br><strong>(-1, 0)</strong><br><br>(one unit left of center, no units up/down)",
                    visual: "Point at 180° = (-1, 0)"
                },
                {
                    title: "Step 3: Read sin and cos",
                    explanation: "Point = (cos θ, sin θ) = (-1, 0)<br><br>• <strong>cos(180°) = -1</strong> (x-coordinate)<br>• <strong>sin(180°) = 0</strong> (y-coordinate)",
                    visual: "cos(180°) = -1, sin(180°) = 0"
                }
            ],
            finalAnswer: "sin(180°) = 0, cos(180°) = -1",
            answerExplanation: "At 180° on the unit circle, the point is (-1, 0), so cos = -1 (x-coord) and sin = 0 (y-coord).",
            example: { problem: `Find sin(180°) and cos(180°)`, steps: [
                { text: "Locate 180° on the unit circle", math: "180° is on the negative x-axis" },
                { text: "The point is (-1, 0)", math: "(cos 180°, sin 180°) = (-1, 0)" },
                { text: "Read off the values", math: "<strong>sin(180°) = 0, cos(180°) = -1</strong>" }
            ]},
            keyPoints: [
                "sin = y-coordinate, cos = x-coordinate on unit circle",
                "sin and cos repeat every 360° (they're periodic)",
                "tan θ = sin θ / cos θ"
            ],
            mistakes: [
                { wrong: "Confusing sin and cos coordinates", why: "cos = x (horizontal), sin = y (vertical). Think: cos sounds like 'cross' (horizontal)" },
                { wrong: "Forgetting signs in different quadrants", why: "In quadrant II: sin positive, cos negative. Use 'All Students Take Calculus'" }
            ],
            guided: { problem: `What is cos(0°)?`, steps: [
                { label: "0° is on the positive x-axis", value: "Point: (1, 0)" },
                { label: "cos = x-coordinate", value: "?" }
            ], answer: "1", answerLabel: "cos(0°) = ?",
                interactiveSteps: [
                    {
                        prompt: "Where is 0° located on the unit circle?",
                        hint: "0° is the starting point, pointing right...",
                        answer: "positive x-axis",
                        acceptableAnswers: ["positive x-axis", "right", "x-axis", "(1, 0)", "1, 0"],
                        commonMistakes: {
                            "y-axis": "0° is on the positive x-axis (pointing right). 90° is on the y-axis.",
                            "origin": "The origin is the center. 0° is at point (1, 0) on the circle."
                        }
                    },
                    {
                        prompt: "At 0° on the unit circle, what is the coordinate point (x, y)?",
                        hint: "On the positive x-axis, on a circle with radius 1...",
                        answer: "(1, 0)",
                        acceptableAnswers: ["(1, 0)", "1, 0", "(1,0)"],
                        commonMistakes: {
                            "(0, 1)": "That's 90°. At 0°, we're on the positive x-axis: (1, 0)",
                            "(0, 0)": "That's the center. The point on the circle at 0° is (1, 0)."
                        }
                    },
                    {
                        prompt: "Cosine equals which coordinate: x or y?",
                        hint: "cos = horizontal, sin = vertical...",
                        answer: "x",
                        acceptableAnswers: ["x", "x-coordinate", "x coordinate"],
                        commonMistakes: {
                            "y": "y is for sine. Cosine = x-coordinate (horizontal)."
                        }
                    },
                    {
                        prompt: "At (1, 0), the x-coordinate is 1. So cos(0°) = ?",
                        hint: "Read the x-coordinate...",
                        answer: "1",
                        acceptableAnswers: ["1"],
                        commonMistakes: {
                            "0": "0 is the y-coordinate (which is sin). cos(0°) = x-coordinate = 1"
                        }
                    }
                ]
            },
            practice: { problem: `What is sin(90°)?`, answer: "1",
                options: ["0", "1", "-1", "√2/2"],
                mistakeAnalysis: {
                    "0": "sin(90°) = 1. You might be thinking of cos(90°) = 0",
                    "-1": "sin(90°) = 1, not -1. sin is negative at 270°.",
                    "√2/2": "That's sin(45°). At 90°, sin = 1."
                }}
        }),
        "Radian Measure": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const deg = pick([30, 45, 60, 90]);
                    const rad = deg === 30 ? "π/6" : deg === 45 ? "π/4" : deg === 60 ? "π/3" : "π/2";
                    return {
                        id: "convert_to_rad", name: "Degrees to Radians",
                        goalProblem: `Convert ${deg}° to radians`,
                        teachingSteps: [
                            { title: "The Key Relationship", explanation: "<strong>180° = π radians</strong><br><br>This is the foundation for all conversions!", visual: "180° = π" },
                            { title: "Conversion Formula", explanation: "To convert degrees to radians:<br><br><strong>radians = degrees × (π/180)</strong>", visual: "deg × (π/180) = rad" },
                            { title: "Apply to Our Problem", explanation: `${deg}° × (π/180) = ${deg}π/180 = <strong>${rad}</strong>`, visual: `${deg}° = ${rad}` }
                        ],
                        finalAnswer: rad,
                        example: { problem: `Convert ${deg}° to radians`, steps: [
                            { text: "Use formula", math: `${deg} × (π/180)` },
                            { text: "Simplify", math: `<strong>${rad}</strong>` }
                        ]},
                        keyPoints: ["Multiply degrees by π/180", "180° = π radians", "Common: 30°=π/6, 45°=π/4, 60°=π/3, 90°=π/2"],
                        mistakes: [{ wrong: "Using 180/π", why: "That's for radians→degrees! Degrees→radians uses π/180" }],
                        guided: { problem: `Convert 60° to radians`, steps: [{ label: "60 × (π/180)", value: "?" }], answer: "π/3", answerLabel: "60° =",
                            interactiveSteps: [
                                { prompt: "What do we multiply degrees by to get radians?", hint: "π over...", answer: "π/180", acceptableAnswers: ["π/180", "pi/180"], commonMistakes: { "180/π": "That's backwards! Use π/180 for deg→rad" } },
                                { prompt: "60 × (π/180) = 60π/180. Simplify 60/180:", hint: "60÷60=1, 180÷60=3", answer: "1/3", acceptableAnswers: ["1/3"], commonMistakes: {} },
                                { prompt: "So 60° = ? radians", hint: "(1/3)π = π/3", answer: "π/3", acceptableAnswers: ["π/3", "pi/3"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Convert 45° to radians`, answer: "π/4", options: ["π/6", "π/4", "π/3", "π/2"], mistakeAnalysis: { "π/6": "π/6 = 30°. 45° = π/4", "π/3": "π/3 = 60°. 45° = π/4" }}
                    };
                })(),
                (() => {
                    const rad = pick(["π/6", "π/4", "π/3", "π/2"]);
                    const deg = rad === "π/6" ? "30" : rad === "π/4" ? "45" : rad === "π/3" ? "60" : "90";
                    return {
                        id: "convert_to_deg", name: "Radians to Degrees",
                        goalProblem: `Convert ${rad} radians to degrees`,
                        teachingSteps: [
                            { title: "The Key Relationship", explanation: "<strong>π radians = 180°</strong><br><br>To undo π, multiply by 180!", visual: "π = 180°" },
                            { title: "Conversion Formula", explanation: "To convert radians to degrees:<br><br><strong>degrees = radians × (180/π)</strong>", visual: "rad × (180/π) = deg" },
                            { title: "Apply to Our Problem", explanation: `${rad} × (180/π) = <strong>${deg}°</strong>`, visual: `${rad} = ${deg}°` }
                        ],
                        finalAnswer: `${deg}°`,
                        example: { problem: `Convert ${rad} to degrees`, steps: [
                            { text: "Use formula", math: `${rad} × (180/π)` },
                            { text: "Simplify", math: `<strong>${deg}°</strong>` }
                        ]},
                        keyPoints: ["Multiply radians by 180/π", "π radians = 180°", "Common: π/6=30°, π/4=45°, π/3=60°, π/2=90°"],
                        mistakes: [{ wrong: "Using π/180", why: "That's for degrees→radians! Radians→degrees uses 180/π" }],
                        guided: { problem: `Convert π/3 to degrees`, steps: [{ label: "π/3 × (180/π)", value: "?" }], answer: "60°", answerLabel: "π/3 =",
                            interactiveSteps: [
                                { prompt: "What do we multiply radians by to get degrees?", hint: "180 over...", answer: "180/π", acceptableAnswers: ["180/π", "180/pi"], commonMistakes: { "π/180": "That's backwards! Use 180/π for rad→deg" } },
                                { prompt: "(π/3) × (180/π). The π's cancel! What's left?", hint: "180/3 = ?", answer: "60", acceptableAnswers: ["60", "60°"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Convert π/2 to degrees`, answer: "90°", options: ["45°", "60°", "90°", "180°"], mistakeAnalysis: { "180°": "π = 180°. π/2 = half = 90°" }}
                    };
                })(),
                (() => {
                    const r = rand(2, 5);
                    const theta = pick([30, 45, 60]);
                    const thetaRad = theta === 30 ? "π/6" : theta === 45 ? "π/4" : "π/3";
                    const arcLen = theta === 30 ? `${r}π/6` : theta === 45 ? `${r}π/4` : `${r}π/3`;
                    return {
                        id: "arc_length", name: "Arc Length",
                        goalProblem: `Find the arc length for a circle with radius ${r} and central angle ${theta}°`,
                        teachingSteps: [
                            { title: "Arc Length Formula", explanation: "For a circle with radius r and central angle θ (in radians):<br><br><strong>Arc Length = r × θ</strong>", visual: "s = rθ" },
                            { title: "Step 1: Convert to Radians", explanation: `First convert ${theta}° to radians: ${theta}° = ${thetaRad}`, visual: `${theta}° = ${thetaRad}` },
                            { title: "Step 2: Apply Formula", explanation: `s = r × θ = ${r} × ${thetaRad} = <strong>${arcLen}</strong>`, visual: `s = ${arcLen}` }
                        ],
                        finalAnswer: arcLen,
                        example: { problem: `Arc length: r = ${r}, θ = ${theta}°`, steps: [
                            { text: "Convert to radians", math: `${theta}° = ${thetaRad}` },
                            { text: "Apply s = rθ", math: `s = ${r} × ${thetaRad} = <strong>${arcLen}</strong>` }
                        ]},
                        keyPoints: ["Arc length s = rθ (θ must be in radians!)", "Always convert degrees to radians first", "Arc length has same units as radius"],
                        mistakes: [{ wrong: "Using degrees in the formula", why: "s = rθ only works when θ is in RADIANS" }],
                        guided: { problem: `Arc length: r = 4, θ = 45°`, steps: [{ label: "Convert 45° to radians", value: "π/4" }, { label: "s = 4 × π/4", value: "?" }], answer: "π", answerLabel: "Arc length =",
                            interactiveSteps: [
                                { prompt: "First convert 45° to radians:", hint: "45° = π/?", answer: "π/4", acceptableAnswers: ["π/4", "pi/4"], commonMistakes: {} },
                                { prompt: "Now use s = rθ. s = 4 × (π/4) = ?", hint: "4/4 = 1, so 4 × π/4 = ?", answer: "π", acceptableAnswers: ["π", "pi", "1π"], commonMistakes: { "4π/4": "Simplify! 4π/4 = π" } }
                            ]
                        },
                        practice: { problem: `Arc length formula is s = rθ. What must θ be measured in?`, answer: "radians", options: ["degrees", "radians", "either", "revolutions"], mistakeAnalysis: { "degrees": "The formula s = rθ only works with radians!" }}
                    };
                })()
            ]
        }),
        "Inverse Trig": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const funcs = [
                        { func: "arcsin", val: "1/2", ans: "30°", sin: true },
                        { func: "arcsin", val: "√2/2", ans: "45°", sin: true },
                        { func: "arccos", val: "1/2", ans: "60°", sin: false },
                        { func: "arccos", val: "0", ans: "90°", sin: false },
                        { func: "arctan", val: "1", ans: "45°", sin: false }
                    ];
                    const f = pick(funcs);
                    return {
                        id: "evaluate", name: "Evaluating Inverse Trig",
                        goalProblem: `Find ${f.func}(${f.val})`,
                        teachingSteps: [
                            { title: "What are Inverse Trig?", explanation: "Inverse trig functions find the <strong>angle</strong> from a ratio:<br>• arcsin: what angle has this sine?<br>• arccos: what angle has this cosine?<br>• arctan: what angle has this tangent?", visual: "ratio → angle" },
                            { title: "Think Unit Circle", explanation: `${f.func}(${f.val}) asks: what angle has ${f.func.slice(3)} = ${f.val}?<br>From unit circle: the answer is ${f.ans}`, visual: `${f.func}(${f.val}) = ${f.ans}` },
                            { title: "Key Values", explanation: "sin(30°)=1/2, sin(45°)=√2/2, sin(60°)=√3/2<br>cos(30°)=√3/2, cos(45°)=√2/2, cos(60°)=1/2<br>tan(45°)=1", visual: "Memorize special angles" }
                        ],
                        finalAnswer: f.ans,
                        example: { problem: `${f.func}(${f.val})`, steps: [{ text: "Find angle with " + f.func.slice(3) + " = " + f.val, math: `<strong>${f.ans}</strong>` }]},
                        keyPoints: ["arcsin asks: sin(?) = value", "arccos asks: cos(?) = value", "Use unit circle values"],
                        mistakes: [{ wrong: "sin⁻¹ = 1/sin", why: "sin⁻¹ is arcsin (inverse), NOT reciprocal. 1/sin = csc" }],
                        guided: { problem: `arcsin(1/2) = ?`, steps: [{ label: "sin(?) = 1/2", value: "From unit circle" }], answer: "30°", answerLabel: "Answer:",
                            interactiveSteps: [
                                { prompt: "What angle has sin = 1/2?", hint: "Think 30-60-90 triangle", answer: "30°", acceptableAnswers: ["30°", "30", "30 degrees"], commonMistakes: { "60°": "sin(60°) = √3/2. sin(30°) = 1/2" } }
                            ]
                        },
                        practice: { problem: `arccos(√2/2) = ?`, answer: "45°", options: ["30°", "45°", "60°", "90°"], mistakeAnalysis: { "30°": "cos(30°) = √3/2. cos(45°) = √2/2" }}
                    };
                })(),
                {
                    id: "domain", name: "Domain of Inverse Trig",
                    goalProblem: `What is the domain of arcsin(x)?`,
                    teachingSteps: [
                        { title: "Why Restricted Domain?", explanation: "sin(θ) only outputs values from -1 to 1.<br>So arcsin can only accept inputs from -1 to 1!", visual: "sin outputs [-1, 1]" },
                        { title: "Domains", explanation: "<strong>arcsin: [-1, 1]</strong><br><strong>arccos: [-1, 1]</strong><br><strong>arctan: all real numbers</strong>", visual: "arcsin/arccos: [-1,1] | arctan: ℝ" },
                        { title: "arcsin Domain", explanation: "arcsin(x) is defined for <strong>-1 ≤ x ≤ 1</strong><br>arcsin(2) is undefined! (no angle has sin = 2)", visual: "Domain: [-1, 1]" }
                    ],
                    finalAnswer: "[-1, 1]",
                    example: { problem: `Domain of arcsin(x)`, steps: [{ text: "sin outputs [-1, 1]", math: "So arcsin accepts <strong>[-1, 1]</strong>" }]},
                    keyPoints: ["arcsin domain: [-1, 1]", "arccos domain: [-1, 1]", "arctan domain: all reals"],
                    mistakes: [{ wrong: "arcsin(2) exists", why: "No angle has sin = 2! arcsin only works for [-1, 1]" }],
                    guided: { problem: `Is arcsin(0.5) defined?`, steps: [{ label: "0.5 in [-1, 1]?", value: "Yes" }], answer: "Yes", answerLabel: "Defined?",
                        interactiveSteps: [
                            { prompt: "Is 0.5 between -1 and 1?", hint: "-1 ≤ 0.5 ≤ 1?", answer: "yes", acceptableAnswers: ["yes", "true"], commonMistakes: {} },
                            { prompt: "So arcsin(0.5) is defined or undefined?", hint: "It's in the domain", answer: "defined", acceptableAnswers: ["defined", "yes"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `Is arccos(1.5) defined?`, answer: "No", options: ["Yes", "No"], mistakeAnalysis: { "Yes": "1.5 > 1, outside domain [-1, 1]. Undefined!" }}
                },
                {
                    id: "range", name: "Range of Inverse Trig",
                    goalProblem: `What is the range of arcsin(x)?`,
                    teachingSteps: [
                        { title: "Why Restricted Range?", explanation: "Since sin repeats, arcsin is restricted to give ONE unique answer.<br>We pick the <strong>principal value</strong>.", visual: "Need unique answer" },
                        { title: "Ranges (Principal Values)", explanation: "<strong>arcsin: [-π/2, π/2] or [-90°, 90°]</strong><br><strong>arccos: [0, π] or [0°, 180°]</strong><br><strong>arctan: (-π/2, π/2) or (-90°, 90°)</strong>", visual: "Different ranges!" },
                        { title: "arcsin Range", explanation: "arcsin(x) returns angles in <strong>[-90°, 90°]</strong><br>That's Q4, Q1 (right side of unit circle)", visual: "Range: [-90°, 90°]" }
                    ],
                    finalAnswer: "[-90°, 90°] or [-π/2, π/2]",
                    example: { problem: `Range of arcsin(x)`, steps: [{ text: "Principal values", math: "<strong>[-90°, 90°]</strong>" }]},
                    keyPoints: ["arcsin range: [-90°, 90°]", "arccos range: [0°, 180°]", "arctan range: (-90°, 90°)"],
                    mistakes: [{ wrong: "arcsin can give 150°", why: "arcsin only returns [-90°, 90°]. Use arccos for [0°, 180°]" }],
                    guided: { problem: `arccos range includes 180°?`, steps: [{ label: "arccos: [0°, 180°]", value: "Check endpoints" }], answer: "Yes", answerLabel: "Includes 180°?",
                        interactiveSteps: [
                            { prompt: "What is the range of arccos?", hint: "[0°, ?°]", answer: "[0°, 180°]", acceptableAnswers: ["[0°, 180°]", "0 to 180", "[0, 180]"], commonMistakes: {} },
                            { prompt: "Is 180° in [0°, 180°]?", hint: "At the endpoint", answer: "yes", acceptableAnswers: ["yes", "true"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `arctan range includes 90°?`, answer: "No", options: ["Yes", "No"], mistakeAnalysis: { "Yes": "arctan range is (-90°, 90°) OPEN interval. 90° not included!" }}
                }
            ]
        }),
        Vectors: () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const ax = rand(2, 5), ay = rand(2, 5), bx = rand(1, 4), by = rand(1, 4);
                    return {
                        id: "add", name: "Adding Vectors",
                        goalProblem: `Add vectors: a = (${ax}, ${ay}) and b = (${bx}, ${by})`,
                        teachingSteps: [
                            { title: "What is a Vector?", explanation: "A <strong>vector</strong> has both <strong>magnitude</strong> (size) and <strong>direction</strong>.<br><br>Notation: (x, y) or ⟨x, y⟩", visual: "Vector = magnitude + direction" },
                            { title: "Adding Vectors", explanation: "To add vectors, add corresponding components:<br><br><strong>(a₁, a₂) + (b₁, b₂) = (a₁+b₁, a₂+b₂)</strong>", visual: "(a₁, a₂) + (b₁, b₂) = (a₁+b₁, a₂+b₂)" },
                            { title: "Apply", explanation: `(${ax}, ${ay}) + (${bx}, ${by})<br>= (${ax}+${bx}, ${ay}+${by})<br>= <strong>(${ax+bx}, ${ay+by})</strong>`, visual: `= (${ax+bx}, ${ay+by})` }
                        ],
                        finalAnswer: `(${ax+bx}, ${ay+by})`,
                        example: { problem: `(${ax}, ${ay}) + (${bx}, ${by})`, steps: [
                            { text: "Add x-components", math: `${ax} + ${bx} = ${ax+bx}` },
                            { text: "Add y-components", math: `${ay} + ${by} = ${ay+by}` },
                            { text: "Result", math: `<strong>(${ax+bx}, ${ay+by})</strong>` }
                        ]},
                        keyPoints: ["Add x-components together", "Add y-components together", "Keep components separate"],
                        mistakes: [{ wrong: "Adding all numbers together", why: "Add x's with x's, y's with y's separately" }],
                        guided: { problem: `Add (3, 5) + (2, 4)`, steps: [{ label: "x: 3+2", value: "5" }, { label: "y: 5+4", value: "9" }], answer: "(5, 9)", answerLabel: "Sum =",
                            interactiveSteps: [
                                { prompt: "Add x-components: 3 + 2 = ?", hint: "Add the first numbers", answer: "5", acceptableAnswers: ["5"], commonMistakes: {} },
                                { prompt: "Add y-components: 5 + 4 = ?", hint: "Add the second numbers", answer: "9", acceptableAnswers: ["9"], commonMistakes: {} },
                                { prompt: "Write the result vector (x, y):", hint: "(5, 9)", answer: "(5, 9)", acceptableAnswers: ["(5, 9)", "(5,9)", "5, 9"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Add (1, 2) + (3, 4)`, answer: "(4, 6)", options: ["(4, 6)", "(3, 8)", "(10)", "(2, 6)"], mistakeAnalysis: { "(3, 8)": "Check x: 1+3=4, y: 2+4=6" }}
                    };
                })(),
                (() => {
                    const x = pick([3, 5, 8, 6]), y = pick([4, 12, 6, 8]);
                    const mag = Math.sqrt(x*x + y*y);
                    const magStr = Number.isInteger(mag) ? String(mag) : `√${x*x + y*y}`;
                    return {
                        id: "magnitude", name: "Vector Magnitude",
                        goalProblem: `Find the magnitude of vector (${x}, ${y})`,
                        teachingSteps: [
                            { title: "What is Magnitude?", explanation: "The <strong>magnitude</strong> (length) of a vector is how long it is.<br><br>Think of it as the distance from origin to the point.", visual: "Magnitude = length of arrow" },
                            { title: "The Formula", explanation: "For vector (x, y):<br><br><strong>|v| = √(x² + y²)</strong><br><br>This is the Pythagorean theorem!", visual: "|v| = √(x² + y²)" },
                            { title: "Apply", explanation: `|(${x}, ${y})| = √(${x}² + ${y}²)<br>= √(${x*x} + ${y*y})<br>= √${x*x + y*y}<br>= <strong>${magStr}</strong>`, visual: `|v| = ${magStr}` }
                        ],
                        finalAnswer: magStr,
                        example: { problem: `|(${x}, ${y})|`, steps: [
                            { text: "Apply formula", math: `√(${x}² + ${y}²)` },
                            { text: "Calculate squares", math: `√(${x*x} + ${y*y}) = √${x*x+y*y}` },
                            { text: "Result", math: `<strong>${magStr}</strong>` }
                        ]},
                        keyPoints: ["Magnitude = √(x² + y²)", "It's the Pythagorean theorem", "Magnitude is always positive"],
                        mistakes: [{ wrong: "Adding instead of squaring", why: "|v| ≠ x + y. Use √(x² + y²)" }],
                        guided: { problem: `Find |(3, 4)|`, steps: [{ label: "3² + 4²", value: "9 + 16 = 25" }, { label: "√25", value: "?" }], answer: "5", answerLabel: "Magnitude =",
                            interactiveSteps: [
                                { prompt: "Calculate 3² + 4² = ?", hint: "9 + 16 = ?", answer: "25", acceptableAnswers: ["25"], commonMistakes: { "7": "Square first! 3²=9, 4²=16, sum=25" } },
                                { prompt: "Now take √25 = ?", hint: "What squared is 25?", answer: "5", acceptableAnswers: ["5"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `|(5, 12)| = ?`, answer: "13", options: ["13", "17", "169", "√17"], mistakeAnalysis: { "17": "5+12=17 is wrong. Use √(25+144)=√169=13", "169": "Don't forget √! √169=13" }}
                    };
                })(),
                (() => {
                    const k = rand(2, 4), x = rand(1, 4), y = rand(1, 4);
                    return {
                        id: "scalar", name: "Scalar Multiplication",
                        goalProblem: `Calculate ${k}(${x}, ${y})`,
                        teachingSteps: [
                            { title: "What is Scalar Multiplication?", explanation: "A <strong>scalar</strong> is just a number. Multiplying a vector by a scalar scales (stretches/shrinks) it.", visual: "Scalar × vector = scaled vector" },
                            { title: "The Formula", explanation: "To multiply vector (x, y) by scalar k:<br><br><strong>k(x, y) = (kx, ky)</strong><br><br>Multiply EACH component by k.", visual: "k(x, y) = (kx, ky)" },
                            { title: "Apply", explanation: `${k}(${x}, ${y}) = (${k}×${x}, ${k}×${y})<br>= <strong>(${k*x}, ${k*y})</strong>`, visual: `= (${k*x}, ${k*y})` }
                        ],
                        finalAnswer: `(${k*x}, ${k*y})`,
                        example: { problem: `${k}(${x}, ${y})`, steps: [
                            { text: "Multiply each component by " + k, math: `(${k}×${x}, ${k}×${y})` },
                            { text: "Result", math: `<strong>(${k*x}, ${k*y})</strong>` }
                        ]},
                        keyPoints: ["Multiply EACH component by the scalar", "Scalar multiplication scales the vector", "Direction stays same (unless k is negative)"],
                        mistakes: [{ wrong: "Only multiplying one component", why: "Both x AND y must be multiplied by k" }],
                        guided: { problem: `Calculate 3(2, 5)`, steps: [{ label: "3×2", value: "6" }, { label: "3×5", value: "15" }], answer: "(6, 15)", answerLabel: "Result =",
                            interactiveSteps: [
                                { prompt: "Multiply x-component: 3 × 2 = ?", hint: "3 times 2", answer: "6", acceptableAnswers: ["6"], commonMistakes: {} },
                                { prompt: "Multiply y-component: 3 × 5 = ?", hint: "3 times 5", answer: "15", acceptableAnswers: ["15"], commonMistakes: {} },
                                { prompt: "Write the result vector:", hint: "(6, 15)", answer: "(6, 15)", acceptableAnswers: ["(6, 15)", "(6,15)", "6, 15"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `2(4, 3) = ?`, answer: "(8, 6)", options: ["(8, 6)", "(6, 5)", "(8, 3)", "(4, 6)"], mistakeAnalysis: { "(8, 3)": "Multiply BOTH components! 2×3=6", "(4, 6)": "Multiply BOTH! 2×4=8" }}
                    };
                })()
            ]
        }),
        "Advanced Functions": () => ({
            goalProblem: `Find the inverse of f(x) = 2x + 3`,
            teachingSteps: [
                {
                    title: "What is an Inverse Function?",
                    explanation: "An <strong>inverse function</strong> \"undoes\" what the original function does.<br><br>If f(a) = b, then f⁻¹(b) = a.<br><br>It's like playing a video in reverse!",
                    visual: "f(x) does something → f⁻¹(x) undoes it"
                },
                {
                    title: "The Key Property",
                    explanation: "For a function and its inverse:<br><br><strong>f(f⁻¹(x)) = x</strong> and <strong>f⁻¹(f(x)) = x</strong><br><br>They cancel each other out!",
                    visual: "f and f⁻¹ cancel: f(f⁻¹(x)) = x"
                },
                {
                    title: "How to Find an Inverse",
                    explanation: "1. Replace f(x) with y<br>2. <strong>Swap x and y</strong><br>3. Solve for y<br>4. Replace y with f⁻¹(x)",
                    visual: "Steps: y = f(x) → swap x,y → solve for y"
                },
                {
                    title: "Step 1: Write with y",
                    explanation: "f(x) = 2x + 3<br><br>Replace f(x) with y:<br><strong>y = 2x + 3</strong>",
                    visual: "y = 2x + 3"
                },
                {
                    title: "Step 2: Swap x and y",
                    explanation: "Switch x and y positions:<br><br><strong>x = 2y + 3</strong>",
                    visual: "x = 2y + 3"
                },
                {
                    title: "Step 3: Solve for y",
                    explanation: "x = 2y + 3<br>x - 3 = 2y<br>y = (x - 3)/2<br><br><strong>f⁻¹(x) = (x - 3)/2</strong>",
                    visual: "f⁻¹(x) = (x - 3)/2"
                },
                {
                    title: "Verify: Check Your Answer",
                    explanation: "Let's verify: f(f⁻¹(x)) should equal x.<br><br>f(f⁻¹(x)) = f((x-3)/2)<br>= 2 × (x-3)/2 + 3<br>= (x-3) + 3<br>= x ✓",
                    visual: "f(f⁻¹(x)) = x ✓"
                }
            ],
            finalAnswer: "f⁻¹(x) = (x - 3)/2",
            answerExplanation: "Swap x and y, then solve: x = 2y + 3 → y = (x-3)/2.",
            example: { problem: `Find the inverse of f(x) = 2x + 3`, steps: [
                { text: "Write as y = 2x + 3", math: "y = 2x + 3" },
                { text: "Swap x and y", math: "x = 2y + 3" },
                { text: "Solve for y", math: "y = (x - 3)/2" },
                { text: "Write inverse", math: "<strong>f⁻¹(x) = (x - 3)/2</strong>" }
            ]},
            keyPoints: [
                "Inverse undoes the original function",
                "Find inverse: swap x and y, then solve for y",
                "Verify: f(f⁻¹(x)) = x"
            ],
            mistakes: [
                { wrong: "Just flipping the fraction: inverse of 2x = x/2", why: "You must swap x and y first, then solve algebraically." },
                { wrong: "Forgetting to swap x and y", why: "This is the key step! Swap first, then solve for y." }
            ],
            guided: { problem: `Find the inverse of f(x) = 3x - 6`, steps: [
                { label: "Write y = 3x - 6", value: "y = 3x - 6" },
                { label: "Swap x and y", value: "x = 3y - 6" },
                { label: "Solve for y", value: "?" }
            ], answer: "f⁻¹(x) = (x + 6)/3", answerLabel: "f⁻¹(x) =",
                interactiveSteps: [
                    {
                        prompt: "After swapping x and y in y = 3x - 6, what do we get?",
                        hint: "Just exchange the letters...",
                        answer: "x = 3y - 6",
                        acceptableAnswers: ["x = 3y - 6", "x=3y-6"],
                        commonMistakes: {
                            "y = 3x - 6": "That's the original! After swapping: x = 3y - 6"
                        }
                    },
                    {
                        prompt: "From x = 3y - 6, add 6 to both sides. What do you get?",
                        hint: "x + 6 = 3y - 6 + 6",
                        answer: "x + 6 = 3y",
                        acceptableAnswers: ["x + 6 = 3y", "x+6=3y", "x + 6 = 3y"],
                        commonMistakes: {
                            "x - 6 = 3y": "Add 6 (to undo -6). x + 6 = 3y"
                        }
                    },
                    {
                        prompt: "Now divide both sides by 3 to solve for y:",
                        hint: "(x + 6)/3 = y",
                        answer: "y = (x + 6)/3",
                        acceptableAnswers: ["y = (x + 6)/3", "y=(x+6)/3", "(x + 6)/3", "(x+6)/3"],
                        commonMistakes: {
                            "y = x/3 + 6": "Divide the ENTIRE left side by 3: (x + 6)/3"
                        }
                    }
                ]
            },
            practice: { problem: `If f(2) = 7, what is f⁻¹(7)?`, answer: "2",
                options: ["2", "7", "1/7", "14"],
                mistakeAnalysis: {
                    "7": "f⁻¹ UNDOES f. Since f(2) = 7, then f⁻¹(7) = 2.",
                    "1/7": "Inverse function ≠ reciprocal. f(2) = 7 means f⁻¹(7) = 2.",
                    "14": "The inverse undoes the original. f(2) = 7 → f⁻¹(7) = 2."
                }}
        }),
        "Parametric Equations": () => {
            const t = rand(1, 3);
            return {
                goalProblem: `For x = 2t and y = t², find the point when t = 3`,
                teachingSteps: [
                    {
                        title: "What are Parametric Equations?",
                        explanation: "<strong>Parametric equations</strong> express x and y separately in terms of a third variable (usually <strong>t</strong>).<br><br>Instead of y = f(x), we have:<br>• x = f(t)<br>• y = g(t)",
                        visual: "x = f(t), y = g(t) → both depend on t"
                    },
                    {
                        title: "Why Use Parametric Equations?",
                        explanation: "Parametric equations let us:<br><br>• Describe motion over time (t = time)<br>• Graph curves that aren't functions (like circles)<br>• Control direction and speed along a path",
                        visual: "Great for motion, circles, and complex curves"
                    },
                    {
                        title: "Finding Points",
                        explanation: "To find a point on a parametric curve:<br><br>1. Choose a value for t<br>2. Plug t into the x equation<br>3. Plug t into the y equation<br>4. The point is (x, y)",
                        visual: "Pick t → Calculate x → Calculate y → Point (x, y)"
                    },
                    {
                        title: "Step 1: Identify the Equations",
                        explanation: "We have:<br>• x = 2t<br>• y = t²<br><br>And we want the point when t = 3.",
                        visual: "x = 2t, y = t², find point at t = 3"
                    },
                    {
                        title: "Step 2: Calculate x",
                        explanation: "x = 2t<br>x = 2(3)<br>x = <strong>6</strong>",
                        visual: "x = 2(3) = 6"
                    },
                    {
                        title: "Step 3: Calculate y",
                        explanation: "y = t²<br>y = 3²<br>y = <strong>9</strong>",
                        visual: "y = 3² = 9"
                    },
                    {
                        title: "Step 4: Write the Point",
                        explanation: "The point is <strong>(6, 9)</strong>",
                        visual: "Point: (6, 9)"
                    }
                ],
                finalAnswer: "(6, 9)",
                answerExplanation: "At t = 3: x = 2(3) = 6 and y = 3² = 9, so the point is (6, 9).",
                example: { problem: `Find point when t = 3 for x = 2t, y = t²`, steps: [
                    { text: "Calculate x", math: "x = 2(3) = 6" },
                    { text: "Calculate y", math: "y = 3² = 9" },
                    { text: "Write point", math: "<strong>(6, 9)</strong>" }
                ]},
                keyPoints: [
                    "Plug t into both equations separately",
                    "x and y each depend on the parameter t",
                    "You can eliminate t to get a Cartesian equation"
                ],
                mistakes: [
                    { wrong: "Using t as the y-coordinate", why: "Calculate y from the y equation. t is a parameter, not a coordinate." },
                    { wrong: "Plugging t into only one equation", why: "You need BOTH x and y values to get a point." }
                ],
                guided: { problem: `For x = t + 1 and y = 2t, find the point when t = ${t}`, steps: [
                    { label: "x = t + 1 with t = " + t, value: `x = ${t} + 1 = ${t + 1}` },
                    { label: "y = 2t with t = " + t, value: `y = 2(${t}) = ${2 * t}` },
                    { label: "Point", value: "?" }
                ], answer: `(${t + 1}, ${2 * t})`, answerLabel: "Point:",
                    interactiveSteps: [
                        {
                            prompt: `Calculate x when t = ${t}: x = t + 1 = ?`,
                            hint: `${t} + 1 = ?`,
                            answer: String(t + 1),
                            acceptableAnswers: [String(t + 1)],
                            commonMistakes: {
                                [String(t)]: `Don't forget to add 1! ${t} + 1 = ${t + 1}`
                            }
                        },
                        {
                            prompt: `Calculate y when t = ${t}: y = 2t = ?`,
                            hint: `2 × ${t} = ?`,
                            answer: String(2 * t),
                            acceptableAnswers: [String(2 * t)],
                            commonMistakes: {
                                [String(t + 2)]: `Multiply! 2 × ${t} = ${2 * t}`
                            }
                        },
                        {
                            prompt: `Write the point (x, y):`,
                            hint: `x = ${t + 1}, y = ${2 * t}`,
                            answer: `(${t + 1}, ${2 * t})`,
                            acceptableAnswers: [`(${t + 1}, ${2 * t})`, `(${t+1},${2*t})`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A circle has parametric form x = cos(t), y = sin(t). What curve is traced?`, answer: "Unit circle",
                    options: ["Unit circle", "Parabola", "Line", "Ellipse"],
                    mistakeAnalysis: {
                        "Parabola": "x = cos(t), y = sin(t) traces a circle. x² + y² = cos²t + sin²t = 1.",
                        "Line": "This traces a circle. cos and sin oscillate, creating a curved path.",
                        "Ellipse": "Since both use the same parameter without scaling, it's a circle (equal radii)."
                    }}
            };
        },
        "Polar Coordinates": () => {
            const r = rand(2, 5);
            const theta = pick([0, 30, 45, 60, 90]);
            const x = theta === 0 ? r : theta === 90 ? 0 : Math.round(r * Math.cos(theta * Math.PI / 180) * 100) / 100;
            const y = theta === 0 ? 0 : theta === 90 ? r : Math.round(r * Math.sin(theta * Math.PI / 180) * 100) / 100;
            return {
                goalProblem: `Convert polar coordinates (4, 60°) to Cartesian coordinates`,
                teachingSteps: [
                    {
                        title: "What are Polar Coordinates?",
                        explanation: "Instead of (x, y), <strong>polar coordinates</strong> use (r, θ):<br><br>• <strong>r</strong> = distance from origin<br>• <strong>θ</strong> = angle from positive x-axis<br><br>It's like giving directions: \"go r units at angle θ\"",
                        visual: "(r, θ) → distance r at angle θ"
                    },
                    {
                        title: "Cartesian vs. Polar",
                        explanation: "<strong>Cartesian:</strong> (x, y) - how far right and up<br><br><strong>Polar:</strong> (r, θ) - how far and which direction<br><br>Same point, different descriptions!",
                        visual: "Cartesian: (x, y) | Polar: (r, θ)"
                    },
                    {
                        title: "Conversion Formulas",
                        explanation: "<strong>Polar to Cartesian:</strong><br>• x = r cos(θ)<br>• y = r sin(θ)<br><br><strong>Cartesian to Polar:</strong><br>• r = √(x² + y²)<br>• θ = arctan(y/x)",
                        visual: "x = r cos θ, y = r sin θ | r = √(x²+y²)"
                    },
                    {
                        title: "Step 1: Identify r and θ",
                        explanation: "We have polar coordinates (4, 60°):<br><br>• r = 4<br>• θ = 60°",
                        visual: "r = 4, θ = 60°"
                    },
                    {
                        title: "Step 2: Calculate x",
                        explanation: "x = r cos(θ)<br>x = 4 cos(60°)<br>x = 4 × (1/2)<br>x = <strong>2</strong>",
                        visual: "x = 4 × cos(60°) = 4 × 0.5 = 2"
                    },
                    {
                        title: "Step 3: Calculate y",
                        explanation: "y = r sin(θ)<br>y = 4 sin(60°)<br>y = 4 × (√3/2)<br>y = <strong>2√3</strong> ≈ 3.46",
                        visual: "y = 4 × sin(60°) = 4 × (√3/2) = 2√3"
                    },
                    {
                        title: "Final Answer",
                        explanation: "The Cartesian coordinates are:<br><br><strong>(2, 2√3)</strong> or approximately (2, 3.46)",
                        visual: "(4, 60°) → (2, 2√3)"
                    }
                ],
                finalAnswer: "(2, 2√3) ≈ (2, 3.46)",
                answerExplanation: "Using x = r cos θ = 4(1/2) = 2 and y = r sin θ = 4(√3/2) = 2√3.",
                example: { problem: `Convert (4, 60°) to Cartesian`, steps: [
                    { text: "x = r cos θ", math: "x = 4 cos(60°) = 4(1/2) = 2" },
                    { text: "y = r sin θ", math: "y = 4 sin(60°) = 4(√3/2) = 2√3" },
                    { text: "Cartesian point", math: "<strong>(2, 2√3)</strong>" }
                ]},
                keyPoints: [
                    "Polar to Cartesian: x = r cos θ, y = r sin θ",
                    "Cartesian to Polar: r = √(x² + y²), θ = arctan(y/x)",
                    "r is always the distance from origin"
                ],
                mistakes: [
                    { wrong: "Mixing up sin and cos", why: "x uses cos (horizontal), y uses sin (vertical)" },
                    { wrong: "Using degrees in calculator set to radians", why: "Make sure calculator mode matches your angle measure!" }
                ],
                guided: { problem: `Convert polar (${r}, ${theta}°) to Cartesian`, steps: [
                    { label: "x = r cos θ", value: `${r} × cos(${theta}°) = ?` },
                    { label: "y = r sin θ", value: `${r} × sin(${theta}°) = ?` }
                ], answer: `(${x}, ${y})`, answerLabel: "Cartesian:",
                    interactiveSteps: [
                        {
                            prompt: `What is cos(${theta}°)?`,
                            hint: theta === 0 ? "cos(0°) = 1" : theta === 90 ? "cos(90°) = 0" : theta === 60 ? "cos(60°) = 1/2" : theta === 30 ? "cos(30°) = √3/2" : "cos(45°) = √2/2",
                            answer: theta === 0 ? "1" : theta === 90 ? "0" : theta === 60 ? "0.5" : theta === 30 ? "0.866" : "0.707",
                            acceptableAnswers: theta === 0 ? ["1"] : theta === 90 ? ["0"] : theta === 60 ? ["0.5", "1/2", "0.50"] : theta === 30 ? ["√3/2", "0.866", "0.87"] : ["√2/2", "0.707", "0.71"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate x = ${r} × cos(${theta}°) = ?`,
                            hint: `Multiply ${r} by your cos value`,
                            answer: String(x),
                            acceptableAnswers: [String(x), String(Math.round(x))],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate y = ${r} × sin(${theta}°) = ?`,
                            hint: theta === 0 ? "sin(0°) = 0" : theta === 90 ? "sin(90°) = 1" : theta === 60 ? "sin(60°) = √3/2 ≈ 0.866" : theta === 30 ? "sin(30°) = 0.5" : "sin(45°) = √2/2",
                            answer: String(y),
                            acceptableAnswers: [String(y), String(Math.round(y))],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Convert Cartesian (3, 4) to polar. What is r?`, answer: "5",
                    options: ["5", "7", "12", "1"],
                    mistakeAnalysis: {
                        "7": "r = √(x² + y²) = √(9 + 16) = √25 = 5, not 3 + 4",
                        "12": "r = √(9 + 16) = √25 = 5, not 3 × 4",
                        "1": "r = √(3² + 4²) = √25 = 5"
                    }}
            };
        },
        "Normal Distribution": () => {
            const mean = rand(60, 80);
            const sd = rand(5, 10);
            return {
                goalProblem: `A test has mean 70 and standard deviation 10. What percentage of scores fall within one standard deviation of the mean?`,
                teachingSteps: [
                    {
                        title: "What is the Normal Distribution?",
                        explanation: "The <strong>normal distribution</strong> (bell curve) is the most important distribution in statistics.<br><br>Many natural phenomena follow this pattern: heights, test scores, measurement errors, etc.",
                        visual: "Normal = Bell-shaped, symmetric curve"
                    },
                    {
                        title: "Key Properties",
                        explanation: "• <strong>Symmetric</strong> around the mean<br>• <strong>Mean = Median = Mode</strong> (all at center)<br>• Most data is near the middle, less at extremes<br>• Total area under curve = 1 (100%)",
                        visual: "Symmetric, centered at mean"
                    },
                    {
                        title: "The 68-95-99.7 Rule (Empirical Rule)",
                        explanation: "For normal distributions:<br><br>• <strong>68%</strong> of data falls within 1 SD of mean<br>• <strong>95%</strong> of data falls within 2 SD of mean<br>• <strong>99.7%</strong> of data falls within 3 SD of mean",
                        visual: "68% (1 SD) | 95% (2 SD) | 99.7% (3 SD)"
                    },
                    {
                        title: "Understanding Standard Deviation",
                        explanation: "<strong>Standard deviation (σ)</strong> measures how spread out the data is.<br><br>• Small SD = data tightly clustered around mean<br>• Large SD = data spread out widely",
                        visual: "SD = measure of spread"
                    },
                    {
                        title: "Step 1: Identify the Question",
                        explanation: "We want the percentage within <strong>one standard deviation</strong> of the mean.<br><br>This means between (mean - SD) and (mean + SD).",
                        visual: "Within 1 SD → 70 - 10 to 70 + 10 → 60 to 80"
                    },
                    {
                        title: "Step 2: Apply the Empirical Rule",
                        explanation: "By the 68-95-99.7 rule:<br><br>Within 1 standard deviation = <strong>68%</strong><br><br>So 68% of scores fall between 60 and 80.",
                        visual: "Within 1 SD = 68%"
                    }
                ],
                finalAnswer: "68%",
                answerExplanation: "By the empirical (68-95-99.7) rule, 68% of data falls within one standard deviation of the mean.",
                example: { problem: `Percentage within 1 SD of mean`, steps: [
                    { text: "Recall the empirical rule", math: "68-95-99.7" },
                    { text: "Within 1 SD", math: "68%" },
                    { text: "Answer", math: "<strong>68%</strong>" }
                ]},
                keyPoints: [
                    "68% within 1 SD, 95% within 2 SD, 99.7% within 3 SD",
                    "Normal curves are symmetric around the mean",
                    "Z-score: z = (x - mean)/SD"
                ],
                mistakes: [
                    { wrong: "Confusing SD percentages: 95% for 1 SD", why: "1 SD = 68%, 2 SD = 95%, 3 SD = 99.7%. Memorize 68-95-99.7!" },
                    { wrong: "Thinking SD is a percentage", why: "SD is a measure of spread (same units as data). The percentages come from the empirical rule." }
                ],
                guided: { problem: `Test scores: mean = ${mean}, SD = ${sd}. What range contains 95% of scores?`, steps: [
                    { label: "95% is within how many SDs?", value: "2 SD" },
                    { label: "Lower bound: mean - 2×SD", value: `${mean} - 2(${sd}) = ${mean - 2*sd}` },
                    { label: "Upper bound: mean + 2×SD", value: `${mean} + 2(${sd}) = ${mean + 2*sd}` }
                ], answer: `${mean - 2*sd} to ${mean + 2*sd}`, answerLabel: "95% range:",
                    interactiveSteps: [
                        {
                            prompt: "According to the empirical rule, 95% of data is within how many standard deviations of the mean?",
                            hint: "68-95-99.7 rule...",
                            answer: "2",
                            acceptableAnswers: ["2", "2 SD", "2 standard deviations", "two"],
                            commonMistakes: {
                                "1": "1 SD captures 68%. 95% needs 2 SD.",
                                "3": "3 SD captures 99.7%. 95% needs 2 SD."
                            }
                        },
                        {
                            prompt: `Calculate the lower bound: ${mean} - 2(${sd}) = ?`,
                            hint: `${mean} - ${2 * sd} = ?`,
                            answer: String(mean - 2 * sd),
                            acceptableAnswers: [String(mean - 2 * sd)],
                            commonMistakes: {
                                [String(mean - sd)]: `That's only 1 SD below. We need 2 SD: ${mean} - ${2*sd} = ${mean - 2*sd}`
                            }
                        },
                        {
                            prompt: `Calculate the upper bound: ${mean} + 2(${sd}) = ?`,
                            hint: `${mean} + ${2 * sd} = ?`,
                            answer: String(mean + 2 * sd),
                            acceptableAnswers: [String(mean + 2 * sd)],
                            commonMistakes: {
                                [String(mean + sd)]: `That's only 1 SD above. We need 2 SD: ${mean} + ${2*sd} = ${mean + 2*sd}`
                            }
                        }
                    ]
                },
                practice: { problem: `What percentage of data is MORE than 2 SD from the mean?`, answer: "5%",
                    options: ["5%", "32%", "95%", "2.5%"],
                    mistakeAnalysis: {
                        "32%": "32% is OUTSIDE 1 SD. Outside 2 SD is 100% - 95% = 5%",
                        "95%": "95% is WITHIN 2 SD. OUTSIDE 2 SD is 100% - 95% = 5%",
                        "2.5%": "2.5% is on one tail only. Total outside 2 SD (both tails) = 5%"
                    }}
            };
        },
        Limits: () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const a = rand(2, 5), b = rand(1, 4), c = rand(1, 3);
                    const answer = a * c + b;
                    return {
                        id: "direct", name: "Direct Substitution",
                        goalProblem: `Find: lim (x→${c}) (${a}x + ${b})`,
                        teachingSteps: [
                            { title: "What is a Limit?", explanation: "A limit describes what value f(x) <strong>approaches</strong> as x gets close to a number.", visual: "lim = what f(x) approaches" },
                            { title: "Direct Substitution", explanation: "The simplest method: just <strong>plug in the value</strong>!<br>If you get a normal number, that's the limit.", visual: "Try substituting first" },
                            { title: "Apply", explanation: `lim (x→${c}) (${a}x + ${b})<br>= ${a}(${c}) + ${b}<br>= ${a*c} + ${b}<br>= <strong>${answer}</strong>`, visual: `Limit = ${answer}` }
                        ],
                        finalAnswer: String(answer),
                        example: { problem: `lim (x→${c}) (${a}x + ${b})`, steps: [{ text: "Substitute x = " + c, math: `${a}(${c}) + ${b} = <strong>${answer}</strong>` }]},
                        keyPoints: ["Try substitution first", "If you get a number, that's the answer", "0/0 or ∞/∞ needs more work"],
                        mistakes: [{ wrong: "Overthinking simple limits", why: "If substitution works, you're done!" }],
                        guided: { problem: `lim (x→2) (3x + 1)`, steps: [{ label: "3(2) + 1", value: "?" }], answer: "7", answerLabel: "Limit =",
                            interactiveSteps: [
                                { prompt: "Substitute x = 2: 3(2) + 1 = ?", hint: "6 + 1", answer: "7", acceptableAnswers: ["7"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `lim (x→5) x² = ?`, answer: "25", options: ["25", "10", "5", "∞"], mistakeAnalysis: { "10": "5² = 25, not 2×5" }}
                    };
                })(),
                {
                    id: "factor", name: "Factor and Cancel",
                    goalProblem: `Find: lim (x→2) (x² - 4)/(x - 2)`,
                    teachingSteps: [
                        { title: "Why Factor?", explanation: "When substitution gives <strong>0/0</strong>, try factoring!<br>The 0/0 often means common factors cancel.", visual: "0/0 → factor and cancel" },
                        { title: "Factor the Numerator", explanation: "x² - 4 = (x+2)(x-2) (difference of squares)<br>Now: (x+2)(x-2)/(x-2)", visual: "x² - 4 = (x+2)(x-2)" },
                        { title: "Cancel and Substitute", explanation: "(x+2)(x-2)/(x-2) = x + 2<br>lim (x→2) (x+2) = 2 + 2 = <strong>4</strong>", visual: "Cancel (x-2), get x+2 → 4" }
                    ],
                    finalAnswer: "4",
                    example: { problem: `lim (x→2) (x²-4)/(x-2)`, steps: [
                        { text: "Direct gives 0/0", math: "Factor instead" },
                        { text: "x²-4 = (x+2)(x-2)", math: "Cancel (x-2)" },
                        { text: "lim (x→2) (x+2)", math: "<strong>= 4</strong>" }
                    ]},
                    keyPoints: ["0/0 means factor and cancel", "Difference of squares: a²-b² = (a+b)(a-b)", "After canceling, substitute again"],
                    mistakes: [{ wrong: "0/0 = 0 or undefined", why: "0/0 is INDETERMINATE - factor first!" }],
                    guided: { problem: `lim (x→3) (x²-9)/(x-3)`, steps: [{ label: "x²-9 = (x+3)(x-3)", value: "Cancel (x-3)" }], answer: "6", answerLabel: "Limit =",
                        interactiveSteps: [
                            { prompt: "Factor x² - 9 (difference of squares):", hint: "(x+?)(x-?)", answer: "(x+3)(x-3)", acceptableAnswers: ["(x+3)(x-3)", "(x-3)(x+3)"], commonMistakes: {} },
                            { prompt: "After canceling (x-3), what's left?", hint: "Just the other factor", answer: "x+3", acceptableAnswers: ["x+3", "x + 3"], commonMistakes: {} },
                            { prompt: "Now substitute x=3: (3)+3 = ?", hint: "3 + 3", answer: "6", acceptableAnswers: ["6"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `lim (x→1) (x²-1)/(x-1) = ?`, answer: "2", options: ["2", "0", "1", "undefined"], mistakeAnalysis: { "undefined": "Factor! (x²-1)=(x+1)(x-1). Cancel, get x+1→2" }}
                },
                {
                    id: "infinity", name: "Limits at Infinity",
                    goalProblem: `Find: lim (x→∞) (2x² + 1)/(x² - 3)`,
                    teachingSteps: [
                        { title: "Limits at Infinity", explanation: "As x → ∞, we ask: what happens when x gets very large?<br>Focus on the <strong>highest degree terms</strong>.", visual: "x → ∞: highest power dominates" },
                        { title: "Same Degree Rule", explanation: "If top and bottom have same degree:<br>Limit = <strong>ratio of leading coefficients</strong>", visual: "Same degree → leading coeff ratio" },
                        { title: "Apply", explanation: "Both have degree 2.<br>Top leading: 2, Bottom leading: 1<br>Limit = <strong>2/1 = 2</strong>", visual: "2x²/x² → 2" }
                    ],
                    finalAnswer: "2",
                    example: { problem: `lim (x→∞) (2x²+1)/(x²-3)`, steps: [
                        { text: "Same degree (2)", math: "Use leading coefficients" },
                        { text: "2/1", math: "<strong>= 2</strong>" }
                    ]},
                    keyPoints: ["Same degree: ratio of leading coeffs", "Higher on top: ±∞", "Higher on bottom: 0"],
                    mistakes: [{ wrong: "Including all terms", why: "At infinity, only highest degree matters!" }],
                    guided: { problem: `lim (x→∞) (3x + 1)/(x + 5)`, steps: [{ label: "Both degree 1", value: "3/1 = ?" }], answer: "3", answerLabel: "Limit =",
                        interactiveSteps: [
                            { prompt: "What is the degree of both top and bottom?", hint: "Highest power of x", answer: "1", acceptableAnswers: ["1", "degree 1"], commonMistakes: {} },
                            { prompt: "Leading coefficient on top? On bottom?", hint: "3x and x", answer: "3 and 1", acceptableAnswers: ["3 and 1", "3, 1", "3/1"], commonMistakes: {} },
                            { prompt: "Ratio of leading coefficients: 3/1 = ?", hint: "3 divided by 1", answer: "3", acceptableAnswers: ["3"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `lim (x→∞) 5/x = ?`, answer: "0", options: ["0", "5", "∞", "undefined"], mistakeAnalysis: { "5": "As x→∞, 5/x→0 (shrinks to nothing)", "∞": "5/∞ → 0, not ∞" }}
                }
            ]
        }),
        "Complex Numbers": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const power = pick([5, 6, 7, 9, 10, 11]);
                    const remainder = power % 4;
                    const answer = remainder === 0 ? "1" : remainder === 1 ? "i" : remainder === 2 ? "-1" : "-i";
                    return {
                        id: "i_power", name: "Powers of i",
                        goalProblem: `Simplify: i^${power}`,
                        teachingSteps: [
                            { title: "The Key: i² = -1", explanation: "i = √(-1), so <strong>i² = -1</strong>. This is the foundation!", visual: "i² = -1" },
                            { title: "Powers of i Cycle", explanation: "• i¹ = i<br>• i² = -1<br>• i³ = -i<br>• i⁴ = 1<br>• i⁵ = i (cycle repeats!)", visual: "i → -1 → -i → 1 → repeat" },
                            { title: "Method: Divide by 4", explanation: `i^${power}: ${power} ÷ 4 = ${Math.floor(power/4)} remainder ${remainder}<br><br>Remainder ${remainder} means i^${power} = <strong>${answer}</strong>`, visual: `Remainder ${remainder} → ${answer}` }
                        ],
                        finalAnswer: answer,
                        example: { problem: `i^${power}`, steps: [
                            { text: `${power} ÷ 4 = ${Math.floor(power/4)} R ${remainder}`, math: `Remainder = ${remainder}` },
                            { text: "Use the cycle", math: `<strong>i^${power} = ${answer}</strong>` }
                        ]},
                        keyPoints: ["Powers of i repeat every 4", "Divide exponent by 4, use remainder", "Remainder: 0→1, 1→i, 2→-1, 3→-i"],
                        mistakes: [{ wrong: "Forgetting i² = -1", why: "This is the definition! i² = -1, always" }],
                        guided: { problem: `Simplify i^6`, steps: [{ label: "6 ÷ 4 = 1 R 2", value: "Remainder 2" }], answer: "-1", answerLabel: "i^6 =",
                            interactiveSteps: [
                                { prompt: "What is 6 ÷ 4? Give the remainder:", hint: "6 = 4(1) + ?", answer: "2", acceptableAnswers: ["2", "remainder 2"], commonMistakes: {} },
                                { prompt: "Remainder 2 corresponds to i² which equals:", hint: "i² = ?", answer: "-1", acceptableAnswers: ["-1"], commonMistakes: { "1": "i⁴ = 1, but i² = -1" } }
                            ]
                        },
                        practice: { problem: `i^4 = ?`, answer: "1", options: ["1", "-1", "i", "-i"], mistakeAnalysis: { "-1": "i² = -1, but i⁴ = (i²)² = (-1)² = 1" }}
                    };
                })(),
                (() => {
                    const a = rand(2, 4), b = rand(1, 3);
                    // (a + bi)(2 + i) = 2a + ai + 2bi + bi² = 2a + ai + 2bi - b = (2a-b) + (a+2b)i
                    const realResult = 2*a - b;
                    const imagResult = a + 2*b;
                    return {
                        id: "multiply", name: "Multiplying Complex Numbers",
                        goalProblem: `Multiply: (${a} + ${b}i)(2 + i)`,
                        teachingSteps: [
                            { title: "FOIL Method", explanation: "Multiply complex numbers using FOIL:<br>First, Outer, Inner, Last", visual: "FOIL: (a+bi)(c+di)" },
                            { title: "Remember: i² = -1", explanation: "When you get i², replace it with -1!", visual: "i² → -1" },
                            { title: "Apply FOIL", explanation: `(${a} + ${b}i)(2 + i)<br>= ${a}×2 + ${a}×i + ${b}i×2 + ${b}i×i<br>= ${2*a} + ${a}i + ${2*b}i + ${b}i²<br>= ${2*a} + ${a}i + ${2*b}i + ${b}(-1)<br>= ${2*a} - ${b} + ${a+2*b}i<br>= <strong>${realResult} + ${imagResult}i</strong>`, visual: `= ${realResult} + ${imagResult}i` }
                        ],
                        finalAnswer: `${realResult} + ${imagResult}i`,
                        example: { problem: `(${a} + ${b}i)(2 + i)`, steps: [
                            { text: "FOIL", math: `${2*a} + ${a}i + ${2*b}i + ${b}i²` },
                            { text: "Use i² = -1", math: `${2*a} + ${a}i + ${2*b}i - ${b}` },
                            { text: "Combine", math: `<strong>${realResult} + ${imagResult}i</strong>` }
                        ]},
                        keyPoints: ["Use FOIL like regular binomials", "Replace i² with -1", "Combine real parts and imaginary parts"],
                        mistakes: [{ wrong: "Forgetting i² = -1", why: "The i² term becomes a real number!" }],
                        guided: { problem: `(2 + i)(3 + i)`, steps: [{ label: "FOIL", value: "6 + 2i + 3i + i²" }], answer: "5 + 5i", answerLabel: "Result =",
                            interactiveSteps: [
                                { prompt: "First × First: 2 × 3 = ?", hint: "2 times 3", answer: "6", acceptableAnswers: ["6"], commonMistakes: {} },
                                { prompt: "Now add Outer + Inner: 2i + 3i = ?", hint: "Combine like terms", answer: "5i", acceptableAnswers: ["5i"], commonMistakes: {} },
                                { prompt: "Last × Last: i × i = i² = ?", hint: "i² = ?", answer: "-1", acceptableAnswers: ["-1"], commonMistakes: {} },
                                { prompt: "Combine: 6 + 5i + (-1) = ?", hint: "6 - 1 + 5i", answer: "5 + 5i", acceptableAnswers: ["5 + 5i", "5+5i"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `(1 + i)(1 - i) = ?`, answer: "2", options: ["2", "0", "2i", "1 - i²"], mistakeAnalysis: { "0": "1 - i² = 1 - (-1) = 1 + 1 = 2", "2i": "The i terms cancel: i - i = 0, leaving 1 - i² = 2" }}
                    };
                })(),
                (() => {
                    const a1 = rand(2, 5), b1 = rand(2, 5), a2 = rand(1, 4), b2 = rand(1, 4);
                    return {
                        id: "add", name: "Adding Complex Numbers",
                        goalProblem: `Add: (${a1} + ${b1}i) + (${a2} + ${b2}i)`,
                        teachingSteps: [
                            { title: "Complex Number Form", explanation: "A complex number is <strong>a + bi</strong><br>• a = real part<br>• b = imaginary part", visual: "a + bi" },
                            { title: "Adding: Combine Like Terms", explanation: "Add real parts together, add imaginary parts together:<br><strong>(a+bi) + (c+di) = (a+c) + (b+d)i</strong>", visual: "Real with real, imag with imag" },
                            { title: "Apply", explanation: `(${a1} + ${b1}i) + (${a2} + ${b2}i)<br>= (${a1}+${a2}) + (${b1}+${b2})i<br>= <strong>${a1+a2} + ${b1+b2}i</strong>`, visual: `= ${a1+a2} + ${b1+b2}i` }
                        ],
                        finalAnswer: `${a1+a2} + ${b1+b2}i`,
                        example: { problem: `(${a1} + ${b1}i) + (${a2} + ${b2}i)`, steps: [
                            { text: "Add real parts", math: `${a1} + ${a2} = ${a1+a2}` },
                            { text: "Add imaginary parts", math: `${b1}i + ${b2}i = ${b1+b2}i` },
                            { text: "Combine", math: `<strong>${a1+a2} + ${b1+b2}i</strong>` }
                        ]},
                        keyPoints: ["Add real parts separately", "Add imaginary parts separately", "Keep the i on imaginary part"],
                        mistakes: [{ wrong: "Adding all numbers together", why: "Keep real and imaginary parts separate!" }],
                        guided: { problem: `(3 + 2i) + (1 + 4i)`, steps: [{ label: "3 + 1", value: "4" }, { label: "2i + 4i", value: "6i" }], answer: "4 + 6i", answerLabel: "Sum =",
                            interactiveSteps: [
                                { prompt: "Add the real parts: 3 + 1 = ?", hint: "Just add the numbers without i", answer: "4", acceptableAnswers: ["4"], commonMistakes: {} },
                                { prompt: "Add the imaginary parts: 2i + 4i = ?", hint: "Add coefficients of i", answer: "6i", acceptableAnswers: ["6i"], commonMistakes: { "6": "Don't forget the i! 2i + 4i = 6i" } },
                                { prompt: "Write the final answer:", hint: "4 + 6i", answer: "4 + 6i", acceptableAnswers: ["4 + 6i", "4+6i"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `(5 + 3i) - (2 + i) = ?`, answer: "3 + 2i", options: ["3 + 2i", "7 + 4i", "3 + 4i", "7 + 2i"], mistakeAnalysis: { "7 + 4i": "Subtract! 5-2=3, 3i-i=2i" }}
                    };
                })()
            ]
        }),
        "Unit Circle": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "coordinates", name: "Coordinates as Trig Values",
                    goalProblem: `On the unit circle at angle θ, the point is (x, y). What is x in terms of trig?`,
                    teachingSteps: [
                        { title: "The Unit Circle", explanation: "A circle with <strong>radius 1</strong> centered at origin.<br>Any point on it is distance 1 from (0,0).", visual: "r = 1, center (0,0)" },
                        { title: "The Key Insight", explanation: "For any point at angle θ on the unit circle:<br><br><strong>x = cos(θ)</strong><br><strong>y = sin(θ)</strong>", visual: "Point = (cos θ, sin θ)" },
                        { title: "Answer", explanation: "The x-coordinate = <strong>cos(θ)</strong><br>The y-coordinate = sin(θ)", visual: "x = cos θ" }
                    ],
                    finalAnswer: "cos(θ)",
                    example: { problem: `x-coordinate on unit circle`, steps: [{ text: "Point is (cos θ, sin θ)", math: "<strong>x = cos(θ)</strong>" }]},
                    keyPoints: ["x = cos(θ)", "y = sin(θ)", "Remember: cosine is 'horizontal'"],
                    mistakes: [{ wrong: "x = sin(θ)", why: "sin = y (vertical). cos = x (horizontal)" }],
                    guided: { problem: `At angle θ, y = ?`, steps: [{ label: "y-coordinate on unit circle", value: "?" }], answer: "sin(θ)", answerLabel: "y =",
                        interactiveSteps: [
                            { prompt: "On the unit circle, the y-coordinate equals which trig function?", hint: "sin or cos?", answer: "sin", acceptableAnswers: ["sin", "sin(θ)", "sine"], commonMistakes: { "cos": "cos = x. sin = y!" } }
                        ]
                    },
                    practice: { problem: `Point on unit circle: (cos θ, ?)?`, answer: "sin θ", options: ["sin θ", "tan θ", "1", "cos θ"], mistakeAnalysis: { "cos θ": "x = cos θ, but y = sin θ" }}
                },
                (() => {
                    const quadrant = pick([1, 2, 3, 4]);
                    const sinSign = quadrant <= 2 ? "positive" : "negative";
                    const cosSign = (quadrant === 1 || quadrant === 4) ? "positive" : "negative";
                    return {
                        id: "quadrant", name: "Signs by Quadrant",
                        goalProblem: `In Quadrant ${quadrant}, is sin positive or negative?`,
                        teachingSteps: [
                            { title: "ASTC Rule", explanation: "<strong>A</strong>ll <strong>S</strong>tudents <strong>T</strong>ake <strong>C</strong>alculus<br><br>Q1: All positive<br>Q2: Sin positive<br>Q3: Tan positive<br>Q4: Cos positive", visual: "Q1:All | Q2:Sin | Q3:Tan | Q4:Cos" },
                            { title: "Another Way", explanation: "sin = y-coordinate → positive above x-axis (Q1, Q2)<br>cos = x-coordinate → positive right of y-axis (Q1, Q4)", visual: "sin + when y>0, cos + when x>0" },
                            { title: "For Quadrant " + quadrant, explanation: `In Q${quadrant}:<br>sin is <strong>${sinSign}</strong><br>cos is <strong>${cosSign}</strong>`, visual: `Q${quadrant}: sin ${sinSign}` }
                        ],
                        finalAnswer: sinSign,
                        example: { problem: `sin in Q${quadrant}`, steps: [{ text: "Check y-coordinate sign", math: `<strong>${sinSign}</strong>` }]},
                        keyPoints: ["ASTC: All, Sin, Tan, Cos", "sin = y → positive in Q1, Q2", "cos = x → positive in Q1, Q4"],
                        mistakes: [{ wrong: "Forgetting the quadrant rule", why: "Use ASTC or think about which axis is positive" }],
                        guided: { problem: `Is cos negative in Q3?`, steps: [{ label: "Q3 is left of y-axis", value: "x < 0" }], answer: "yes", answerLabel: "cos in Q3:",
                            interactiveSteps: [
                                { prompt: "In Q3, is the x-coordinate positive or negative?", hint: "Q3 is left of y-axis", answer: "negative", acceptableAnswers: ["negative", "neg", "-"], commonMistakes: {} },
                                { prompt: "Since cos = x, and x is negative in Q3, cos is...", hint: "negative", answer: "negative", acceptableAnswers: ["negative", "neg", "-"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `In Q2, cos is:`, answer: "negative", options: ["positive", "negative", "zero", "undefined"], mistakeAnalysis: { "positive": "Q2 is left of y-axis, so x<0, so cos<0" }}
                    };
                })(),
                (() => {
                    const angle = pick([120, 150, 210, 240, 300, 330]);
                    const ref = angle <= 180 ? 180 - angle : angle <= 270 ? angle - 180 : 360 - angle;
                    return {
                        id: "reference", name: "Reference Angles",
                        goalProblem: `Find the reference angle for ${angle}°`,
                        teachingSteps: [
                            { title: "What is a Reference Angle?", explanation: "The <strong>reference angle</strong> is the acute angle (0-90°) formed with the x-axis.<br>It helps find trig values of any angle!", visual: "Always between 0° and 90°" },
                            { title: "Finding Reference Angles", explanation: "Q1: ref = θ<br>Q2: ref = 180° - θ<br>Q3: ref = θ - 180°<br>Q4: ref = 360° - θ", visual: "Subtract from nearest x-axis multiple" },
                            { title: `For ${angle}°`, explanation: `${angle}° is in Q${angle <= 180 ? 2 : angle <= 270 ? 3 : 4}<br>Reference angle = <strong>${ref}°</strong>`, visual: `ref = ${ref}°` }
                        ],
                        finalAnswer: `${ref}°`,
                        example: { problem: `Reference angle of ${angle}°`, steps: [{ text: "Find quadrant, subtract from axis", math: `<strong>${ref}°</strong>` }]},
                        keyPoints: ["Reference angles are always 0-90°", "Measure to the nearest x-axis", "Use ASTC for signs, reference for values"],
                        mistakes: [{ wrong: "Using the angle itself", why: "Reference angle is the ACUTE angle to the x-axis" }],
                        guided: { problem: `Reference angle for 225°`, steps: [{ label: "225° is in Q3", value: "225 - 180" }], answer: "45°", answerLabel: "Reference =",
                            interactiveSteps: [
                                { prompt: "225° is in which quadrant?", hint: "Between 180° and 270°", answer: "Q3", acceptableAnswers: ["Q3", "3", "quadrant 3"], commonMistakes: { "Q2": "Q2 is 90-180°. 225° is in Q3" } },
                                { prompt: "For Q3, reference = θ - 180. Calculate 225 - 180:", hint: "Subtract", answer: "45", acceptableAnswers: ["45", "45°"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Reference angle for 150°?`, answer: "30°", options: ["30°", "60°", "150°", "210°"], mistakeAnalysis: { "150°": "Reference is acute! 180-150=30°" }}
                    };
                })(),
                (() => {
                    const angles = [{ rad: "π/6", deg: 30, sin: "1/2", cos: "√3/2" }, { rad: "π/4", deg: 45, sin: "√2/2", cos: "√2/2" }, { rad: "π/3", deg: 60, sin: "√3/2", cos: "1/2" }];
                    const angle = pick(angles);
                    const func = pick(["sin", "cos"]);
                    const answer = func === "sin" ? angle.sin : angle.cos;
                    return {
                        id: "special", name: "Special Angle Values",
                        goalProblem: `${func}(${angle.rad}) = ?`,
                        teachingSteps: [
                            { title: "Special Angles", explanation: "Memorize these key angles:<br>• π/6 = 30°<br>• π/4 = 45°<br>• π/3 = 60°", visual: "30-60-90 and 45-45-90 triangles" },
                            { title: "Values to Know", explanation: "π/6 (30°): (√3/2, 1/2)<br>π/4 (45°): (√2/2, √2/2)<br>π/3 (60°): (1/2, √3/2)", visual: "Memorize the pattern" },
                            { title: `${func}(${angle.rad})`, explanation: `At ${angle.rad} = ${angle.deg}°:<br>Point is (${angle.cos}, ${angle.sin})<br>${func}(${angle.rad}) = <strong>${answer}</strong>`, visual: `${func}(${angle.rad}) = ${answer}` }
                        ],
                        finalAnswer: answer,
                        example: { problem: `${func}(${angle.rad})`, steps: [{ text: `${angle.rad} = ${angle.deg}°`, math: `<strong>${answer}</strong>` }]},
                        keyPoints: ["30°: (√3/2, 1/2)", "45°: (√2/2, √2/2)", "60°: (1/2, √3/2)"],
                        mistakes: [{ wrong: "Mixing up sin and cos", why: "cos = x (first), sin = y (second)" }],
                        guided: { problem: `sin(π/3) = ?`, steps: [{ label: "π/3 = 60°", value: "Point: (1/2, √3/2)" }], answer: "√3/2", answerLabel: "sin(π/3) =",
                            interactiveSteps: [
                                { prompt: "π/3 equals how many degrees?", hint: "π/3 = 60°", answer: "60", acceptableAnswers: ["60", "60°"], commonMistakes: { "30": "π/6 = 30°. π/3 = 60°" } },
                                { prompt: "At 60°, the y-coordinate is √3/2. So sin(π/3) = ?", hint: "sin = y", answer: "√3/2", acceptableAnswers: ["√3/2", "sqrt(3)/2"], commonMistakes: { "1/2": "1/2 is the x-coord (cos). sin = √3/2" } }
                            ]
                        },
                        practice: { problem: `cos(π/6) = ?`, answer: "√3/2", options: ["√3/2", "1/2", "√2/2", "1"], mistakeAnalysis: { "1/2": "1/2 is sin(π/6). cos(π/6) = √3/2" }}
                    };
                })()
            ]
        }),
        "Trig Identities": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "pythagorean", name: "Pythagorean Identity",
                    goalProblem: `Simplify: sin²x + cos²x`,
                    teachingSteps: [
                        { title: "The Pythagorean Identity", explanation: "The most fundamental trig identity:<br><br><strong>sin²x + cos²x = 1</strong>", visual: "sin²x + cos²x = 1" },
                        { title: "Why It Works", explanation: "On unit circle: x² + y² = 1<br>Since x = cos θ, y = sin θ:<br>cos²θ + sin²θ = 1", visual: "From Pythagorean theorem!" },
                        { title: "Related Forms", explanation: "1 - sin²x = cos²x<br>1 - cos²x = sin²x<br>Also: 1 + tan²x = sec²x", visual: "Rearrange as needed" }
                    ],
                    finalAnswer: "1",
                    example: { problem: `sin²x + cos²x`, steps: [{ text: "Apply Pythagorean Identity", math: "<strong>= 1</strong>" }]},
                    keyPoints: ["sin²x + cos²x = 1 always", "Can rearrange: sin²x = 1 - cos²x", "Related: 1 + tan²x = sec²x"],
                    mistakes: [{ wrong: "sin²x + cos²x = 2", why: "It equals 1, not 2!" }],
                    guided: { problem: `If sin²x = 0.36, what is cos²x?`, steps: [{ label: "sin²x + cos²x = 1", value: "0.36 + cos²x = 1" }], answer: "0.64", answerLabel: "cos²x =",
                        interactiveSteps: [
                            { prompt: "sin²x + cos²x = 1. If sin²x = 0.36, then cos²x = ?", hint: "1 - 0.36 = ?", answer: "0.64", acceptableAnswers: ["0.64", "16/25"], commonMistakes: { "1.36": "Subtract! 1 - 0.36 = 0.64" } }
                        ]
                    },
                    practice: { problem: `1 - sin²x = ?`, answer: "cos²x", options: ["cos²x", "sin²x", "tan²x", "1"], mistakeAnalysis: { "sin²x": "Rearranging sin²x + cos²x = 1 gives 1 - sin²x = cos²x" }}
                },
                {
                    id: "double_angle", name: "Double Angle Formulas",
                    goalProblem: `What is sin(2x) in terms of sin x and cos x?`,
                    teachingSteps: [
                        { title: "Double Angle Formulas", explanation: "<strong>sin(2x) = 2 sin x cos x</strong><br><br>cos(2x) has THREE forms:<br>• cos²x - sin²x<br>• 2cos²x - 1<br>• 1 - 2sin²x", visual: "sin(2x) = 2 sin x cos x" },
                        { title: "Why Useful?", explanation: "Converts double angles to single angles.<br>Essential for integration and simplification.", visual: "2x → x" },
                        { title: "The Answer", explanation: "sin(2x) = <strong>2 sin x cos x</strong>", visual: "2 sin x cos x" }
                    ],
                    finalAnswer: "2 sin x cos x",
                    example: { problem: `sin(2x)`, steps: [{ text: "Apply double angle formula", math: "<strong>2 sin x cos x</strong>" }]},
                    keyPoints: ["sin(2x) = 2 sin x cos x", "cos(2x) = cos²x - sin²x (or 2cos²x - 1)", "tan(2x) = 2tan x/(1 - tan²x)"],
                    mistakes: [{ wrong: "sin(2x) = 2 sin(x)", why: "Not just doubling! sin(2x) = 2 sin x COS x" }],
                    guided: { problem: `Express cos(2x) using only cos x`, steps: [{ label: "Use cos(2x) = 2cos²x - 1", value: "?" }], answer: "2cos²x - 1", answerLabel: "cos(2x) =",
                        interactiveSteps: [
                            { prompt: "cos(2x) = cos²x - sin²x. To write with only cos x, use sin²x = ?", hint: "Pythagorean identity", answer: "1 - cos²x", acceptableAnswers: ["1 - cos²x", "1-cos²x"], commonMistakes: {} },
                            { prompt: "So cos(2x) = cos²x - (1 - cos²x) = ?", hint: "Simplify", answer: "2cos²x - 1", acceptableAnswers: ["2cos²x - 1", "2cos²x-1"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `sin(2x) = ?`, answer: "2 sin x cos x", options: ["2 sin x cos x", "sin²x", "2 sin x", "sin x + cos x"], mistakeAnalysis: { "2 sin x": "Don't forget cos x! sin(2x) = 2 sin x cos x" }}
                },
                {
                    id: "sum_diff", name: "Sum and Difference Formulas",
                    goalProblem: `What is sin(A + B)?`,
                    teachingSteps: [
                        { title: "Sum Formulas", explanation: "<strong>sin(A + B) = sin A cos B + cos A sin B</strong><br><strong>cos(A + B) = cos A cos B - sin A sin B</strong>", visual: "SSCCS pattern" },
                        { title: "Difference Formulas", explanation: "sin(A - B) = sin A cos B - cos A sin B<br>cos(A - B) = cos A cos B + sin A sin B<br>(Just flip the middle sign!)", visual: "Flip middle sign for difference" },
                        { title: "The Answer", explanation: "sin(A + B) = <strong>sin A cos B + cos A sin B</strong>", visual: "sin cos + cos sin" }
                    ],
                    finalAnswer: "sin A cos B + cos A sin B",
                    example: { problem: `sin(A + B)`, steps: [{ text: "Sum formula for sine", math: "<strong>sin A cos B + cos A sin B</strong>" }]},
                    keyPoints: ["sin(A±B) = sinAcosB ± cosAsinB", "cos(A±B) = cosAcosB ∓ sinAsinB", "Note the sign changes!"],
                    mistakes: [{ wrong: "sin(A + B) = sin A + sin B", why: "NOT that simple! Use the full formula" }],
                    guided: { problem: `Find sin(75°) using sin(45° + 30°)`, steps: [{ label: "sin 45 cos 30 + cos 45 sin 30", value: "?" }], answer: "(√6 + √2)/4", answerLabel: "sin(75°) =",
                        interactiveSteps: [
                            { prompt: "sin(45° + 30°) = sin45 cos30 + cos45 sin30. What is sin 45°?", hint: "45° on unit circle", answer: "√2/2", acceptableAnswers: ["√2/2", "sqrt(2)/2"], commonMistakes: {} },
                            { prompt: "What is cos 30°?", hint: "30° on unit circle", answer: "√3/2", acceptableAnswers: ["√3/2", "sqrt(3)/2"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `cos(A - B) = ?`, answer: "cos A cos B + sin A sin B", options: ["cos A cos B + sin A sin B", "cos A cos B - sin A sin B", "sin A sin B + cos A cos B", "cos A - cos B"], mistakeAnalysis: { "cos A cos B - sin A sin B": "That's cos(A+B). For difference, PLUS in the middle!" }}
                },
                {
                    id: "verify", name: "Verifying Identities",
                    goalProblem: `Verify: tan x = sin x / cos x`,
                    teachingSteps: [
                        { title: "What is Verification?", explanation: "Proving that two expressions are equal for ALL values.<br>Usually work with ONE side to transform it into the other.", visual: "Transform one side → other side" },
                        { title: "Strategy", explanation: "1. Work with the more complex side<br>2. Convert everything to sin and cos<br>3. Use known identities<br>4. Simplify!", visual: "Convert to sin/cos" },
                        { title: "This Identity", explanation: "tan x = sin x / cos x is the <strong>quotient identity</strong>.<br>It's the definition of tangent!", visual: "tan = sin/cos by definition" }
                    ],
                    finalAnswer: "True (quotient identity)",
                    example: { problem: `tan x = sin x / cos x`, steps: [{ text: "This is the quotient identity", math: "<strong>tan x = sin x / cos x ✓</strong>" }]},
                    keyPoints: ["Work with one side only", "Convert to sin and cos", "Use Pythagorean identity often"],
                    mistakes: [{ wrong: "Working with both sides", why: "Generally work with one side only to transform it" }],
                    guided: { problem: `Verify: sec x = 1/cos x`, steps: [{ label: "sec x is the reciprocal of cos x", value: "By definition" }], answer: "True", answerLabel: "Verified?",
                        interactiveSteps: [
                            { prompt: "What is the relationship between sec x and cos x?", hint: "sec = 1/...", answer: "reciprocal", acceptableAnswers: ["reciprocal", "sec x = 1/cos x", "1/cos x"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `cot x = ?`, answer: "cos x / sin x", options: ["cos x / sin x", "sin x / cos x", "1/tan x", "Both A and C"], mistakeAnalysis: { "sin x / cos x": "That's tan x. cot x = cos x / sin x = 1/tan x", "1/tan x": "True! But in terms of sin/cos, it's cos x / sin x" }}
                }
            ]
        }),
        "Graphing Trig Functions": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const a = pick([2, 3, 4, 5]);
                    return {
                        id: "amplitude", name: "Finding Amplitude",
                        goalProblem: `What is the amplitude of y = ${a}sin(x)?`,
                        teachingSteps: [
                            { title: "What is Amplitude?", explanation: "<strong>Amplitude</strong> = height from the middle to the peak.<br>For y = A sin(x), amplitude = |A|.", visual: "Amplitude = |A|" },
                            { title: "The General Form", explanation: "y = <strong>A</strong> sin(Bx - C) + D<br>A is the coefficient in FRONT of sin/cos.", visual: "A is outside the trig" },
                            { title: "For This Problem", explanation: `y = ${a}sin(x)<br>A = ${a}<br>Amplitude = |${a}| = <strong>${a}</strong>`, visual: `Amplitude = ${a}` }
                        ],
                        finalAnswer: String(a),
                        example: { problem: `y = ${a}sin(x)`, steps: [{ text: "A = " + a, math: `<strong>Amplitude = ${a}</strong>` }]},
                        keyPoints: ["Amplitude = |A|", "A is the coefficient in front", "Negative A flips graph but amplitude is still positive"],
                        mistakes: [{ wrong: "Confusing A and B", why: "A (outside) = amplitude. B (inside) affects period" }],
                        guided: { problem: `Amplitude of y = -4cos(x)?`, steps: [{ label: "A = -4", value: "|A| = ?" }], answer: "4", answerLabel: "Amplitude =",
                            interactiveSteps: [
                                { prompt: "What is the coefficient A in y = -4cos(x)?", hint: "Number in front of cos", answer: "-4", acceptableAnswers: ["-4"], commonMistakes: {} },
                                { prompt: "Amplitude = |A| = |-4| = ?", hint: "Absolute value", answer: "4", acceptableAnswers: ["4"], commonMistakes: { "-4": "Amplitude is always positive! |-4| = 4" } }
                            ]
                        },
                        practice: { problem: `Amplitude of y = 2sin(3x)?`, answer: "2", options: ["2", "3", "6", "2/3"], mistakeAnalysis: { "3": "3 is B (affects period). Amplitude = A = 2" }}
                    };
                })(),
                (() => {
                    const b = pick([2, 3, 4]);
                    const period = b === 2 ? "π" : b === 3 ? "2π/3" : "π/2";
                    return {
                        id: "period", name: "Finding Period",
                        goalProblem: `What is the period of y = sin(${b}x)?`,
                        teachingSteps: [
                            { title: "What is Period?", explanation: "<strong>Period</strong> = horizontal length of one complete cycle.<br>Base period of sin/cos is 2π.", visual: "One cycle = period" },
                            { title: "Period Formula", explanation: "For y = sin(Bx):<br><strong>Period = 2π/|B|</strong><br>Larger B = shorter period", visual: "Period = 2π/|B|" },
                            { title: "For This Problem", explanation: `y = sin(${b}x)<br>B = ${b}<br>Period = 2π/${b} = <strong>${period}</strong>`, visual: `Period = ${period}` }
                        ],
                        finalAnswer: period,
                        example: { problem: `y = sin(${b}x)`, steps: [{ text: "B = " + b, math: `Period = 2π/${b} = <strong>${period}</strong>` }]},
                        keyPoints: ["Period = 2π/|B|", "Larger B = shorter period (faster)", "B is the coefficient of x INSIDE"],
                        mistakes: [{ wrong: "Period = B × 2π", why: "DIVIDE by B, don't multiply!" }],
                        guided: { problem: `Period of y = cos(4x)?`, steps: [{ label: "B = 4", value: "2π/4 = ?" }], answer: "π/2", answerLabel: "Period =",
                            interactiveSteps: [
                                { prompt: "What is B in y = cos(4x)?", hint: "Coefficient of x", answer: "4", acceptableAnswers: ["4"], commonMistakes: {} },
                                { prompt: "Period = 2π/B = 2π/4 = ?", hint: "Simplify", answer: "π/2", acceptableAnswers: ["π/2", "pi/2"], commonMistakes: { "8π": "DIVIDE 2π by B, don't multiply!" } }
                            ]
                        },
                        practice: { problem: `Period of y = sin(x/2)?`, answer: "4π", options: ["4π", "π", "π/2", "2π"], mistakeAnalysis: { "π": "B = 1/2. Period = 2π/(1/2) = 4π", "2π": "That's when B=1. Here B=1/2, so period = 4π" }}
                    };
                })(),
                {
                    id: "phase_shift", name: "Phase Shift",
                    goalProblem: `What is the phase shift of y = sin(x - π/4)?`,
                    teachingSteps: [
                        { title: "What is Phase Shift?", explanation: "<strong>Phase shift</strong> = horizontal shift of the graph.<br>Moves the entire wave left or right.", visual: "Slides graph left/right" },
                        { title: "The Formula", explanation: "y = sin(x - C) shifts <strong>RIGHT by C</strong><br>y = sin(x + C) shifts <strong>LEFT by C</strong><br>(Opposite of what you'd expect!)", visual: "x - C → right, x + C → left" },
                        { title: "For This Problem", explanation: "y = sin(x - π/4)<br>C = π/4<br>Phase shift = <strong>π/4 right</strong>", visual: "Shift right π/4" }
                    ],
                    finalAnswer: "π/4 right",
                    example: { problem: `y = sin(x - π/4)`, steps: [{ text: "Form: x - C → right C", math: "<strong>Right π/4</strong>" }]},
                    keyPoints: ["x - C → shift right", "x + C → shift left", "Opposite direction of sign!"],
                    mistakes: [{ wrong: "x - π/4 shifts left", why: "It shifts RIGHT! Opposite of what you'd expect." }],
                    guided: { problem: `Phase shift of y = cos(x + π/2)?`, steps: [{ label: "x + π/2 means", value: "?" }], answer: "π/2 left", answerLabel: "Phase shift =",
                        interactiveSteps: [
                            { prompt: "In x + C form, does the graph shift left or right?", hint: "+ C goes the opposite way...", answer: "left", acceptableAnswers: ["left"], commonMistakes: { "right": "x + C shifts LEFT (opposite of +)" } },
                            { prompt: "So x + π/2 shifts how much?", hint: "π/2 to the...", answer: "π/2 left", acceptableAnswers: ["π/2 left", "left π/2", "π/2"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `y = sin(x - π) shifts:`, answer: "right π", options: ["right π", "left π", "up π", "down π"], mistakeAnalysis: { "left π": "x - π shifts RIGHT! Opposite of minus sign." }}
                },
                (() => {
                    const type = pick(["sine", "cosine"]);
                    return {
                        id: "identify", name: "Identifying Graphs",
                        goalProblem: `Which function starts at (0, 0): y = sin(x) or y = cos(x)?`,
                        teachingSteps: [
                            { title: "Sine Graph", explanation: "<strong>y = sin(x)</strong> starts at origin (0, 0).<br>Goes: up → 0 → down → 0 → up", visual: "sin(0) = 0" },
                            { title: "Cosine Graph", explanation: "<strong>y = cos(x)</strong> starts at (0, 1).<br>Goes: down → 0 → up → 0 → down", visual: "cos(0) = 1" },
                            { title: "Key Difference", explanation: "Sine starts at 0 (middle)<br>Cosine starts at max (1)<br>cos(x) = sin(x + π/2)", visual: "sin starts at 0, cos starts at 1" }
                        ],
                        finalAnswer: "y = sin(x)",
                        example: { problem: `Which starts at (0,0)?`, steps: [{ text: "sin(0) = 0, cos(0) = 1", math: "<strong>y = sin(x)</strong>" }]},
                        keyPoints: ["sin(0) = 0 (starts at middle)", "cos(0) = 1 (starts at max)", "Cosine is sine shifted left by π/2"],
                        mistakes: [{ wrong: "Confusing sine and cosine", why: "sin starts at 0. cos starts at 1." }],
                        guided: { problem: `At x = 0, what is cos(0)?`, steps: [{ label: "cos at 0 on unit circle", value: "x-coordinate at 0°" }], answer: "1", answerLabel: "cos(0) =",
                            interactiveSteps: [
                                { prompt: "On the unit circle at 0°, what is the point?", hint: "On positive x-axis", answer: "(1, 0)", acceptableAnswers: ["(1, 0)", "(1,0)", "1, 0"], commonMistakes: {} },
                                { prompt: "cos = x-coordinate. So cos(0) = ?", hint: "From (1, 0)", answer: "1", acceptableAnswers: ["1"], commonMistakes: { "0": "0 is the y-coordinate (sin). cos(0) = x = 1" } }
                            ]
                        },
                        practice: { problem: `Which graph has a maximum at x = 0?`, answer: "y = cos(x)", options: ["y = cos(x)", "y = sin(x)", "Both", "Neither"], mistakeAnalysis: { "y = sin(x)": "sin(0) = 0, not maximum. cos(0) = 1 = max!" }}
                    };
                })()
            ]
        }),
        "Series Convergence": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const r = pick(["1/2", "1/3", "1/4", "2/3"]);
                    const rVal = r === "1/2" ? 0.5 : r === "1/3" ? 1/3 : r === "1/4" ? 0.25 : 2/3;
                    const sum = 1 / (1 - rVal);
                    return {
                        id: "geometric", name: "Geometric Series",
                        goalProblem: `Does Σ(${r})ⁿ from n=0 to ∞ converge? If so, find the sum.`,
                        teachingSteps: [
                            { title: "Geometric Series Test", explanation: "A geometric series Σarⁿ <strong>converges if |r| < 1</strong><br>Sum = a/(1-r) when convergent", visual: "Converges iff |r| < 1" },
                            { title: "Check This Series", explanation: `r = ${r}<br>|r| = ${rVal} < 1 ✓<br>The series <strong>converges</strong>!`, visual: `|${r}| < 1 → converges` },
                            { title: "Find the Sum", explanation: `Sum = a/(1-r) = 1/(1-${r})<br>= 1/(${(1-rVal).toFixed(4)})<br>= <strong>${sum.toFixed(2)}</strong>`, visual: `Sum = ${sum.toFixed(2)}` }
                        ],
                        finalAnswer: `Converges to ${sum.toFixed(2)}`,
                        example: { problem: `Σ(${r})ⁿ`, steps: [{ text: `|r| = ${rVal} < 1`, math: "Converges" }, { text: "Sum = 1/(1-r)", math: `<strong>${sum.toFixed(2)}</strong>` }]},
                        keyPoints: ["Geometric converges if |r| < 1", "Sum = a/(1-r)", "If |r| ≥ 1, diverges"],
                        mistakes: [{ wrong: "Checking r < 1 not |r| < 1", why: "r = -2 is < 1 but |r| = 2 > 1 → diverges" }],
                        guided: { problem: `Does Σ(1/2)ⁿ converge?`, steps: [{ label: "|1/2| = 0.5", value: "< 1?" }], answer: "Yes, to 2", answerLabel: "Converges?",
                            interactiveSteps: [
                                { prompt: "Is |1/2| < 1?", hint: "0.5 vs 1", answer: "yes", acceptableAnswers: ["yes", "true"], commonMistakes: {} },
                                { prompt: "Sum = 1/(1 - 1/2) = 1/(1/2) = ?", hint: "1 ÷ 0.5", answer: "2", acceptableAnswers: ["2"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Σ(2)ⁿ converges or diverges?`, answer: "diverges", options: ["converges", "diverges"], mistakeAnalysis: { "converges": "|r| = 2 > 1, so it DIVERGES" }}
                    };
                })(),
                {
                    id: "harmonic", name: "Harmonic Series",
                    goalProblem: `Does the harmonic series Σ(1/n) converge or diverge?`,
                    teachingSteps: [
                        { title: "The Harmonic Series", explanation: "1 + 1/2 + 1/3 + 1/4 + 1/5 + ...<br>This is the <strong>harmonic series</strong>.", visual: "Σ 1/n from n=1 to ∞" },
                        { title: "A Surprising Result", explanation: "Even though terms → 0, the harmonic series <strong>DIVERGES</strong>!<br>It grows slowly but without bound.", visual: "Terms → 0, but sum → ∞" },
                        { title: "Why It Diverges", explanation: "Grouping terms: 1 + 1/2 + (1/3+1/4) + (1/5+...+1/8) + ...<br>Each group > 1/2, infinitely many groups → ∞", visual: "Diverges (very slowly)" }
                    ],
                    finalAnswer: "Diverges",
                    example: { problem: `Σ 1/n`, steps: [{ text: "Harmonic series", math: "Always diverges" }, { text: "Result", math: "<strong>DIVERGES</strong>" }]},
                    keyPoints: ["Harmonic series ALWAYS diverges", "Terms → 0 is NOT enough for convergence", "This is a famous counterexample"],
                    mistakes: [{ wrong: "Thinking small terms means convergence", why: "Harmonic terms → 0 but series still diverges!" }],
                    guided: { problem: `Does Σ(1/n) from n=1 to ∞ have a finite sum?`, steps: [{ label: "Harmonic series", value: "Famous result" }], answer: "No", answerLabel: "Finite sum?",
                        interactiveSteps: [
                            { prompt: "The harmonic series Σ(1/n) is famous for what behavior?", hint: "Converge or diverge?", answer: "diverges", acceptableAnswers: ["diverges", "diverge", "it diverges"], commonMistakes: { "converges": "It DIVERGES despite terms → 0" } }
                        ]
                    },
                    practice: { problem: `1 + 1/2 + 1/3 + 1/4 + ... = ?`, answer: "∞ (diverges)", options: ["∞ (diverges)", "2", "1", "e"], mistakeAnalysis: { "2": "That's the geometric Σ(1/2)ⁿ. Harmonic diverges!" }}
                },
                (() => {
                    const p = pick([2, 3, 0.5]);
                    const converges = p > 1;
                    return {
                        id: "p_series", name: "p-Series Test",
                        goalProblem: `Does Σ(1/n^${p}) converge or diverge?`,
                        teachingSteps: [
                            { title: "p-Series", explanation: "A <strong>p-series</strong> has the form Σ(1/nᵖ).<br>Special case: p=1 is harmonic.", visual: "Σ 1/nᵖ" },
                            { title: "p-Series Test", explanation: "<strong>p > 1: CONVERGES</strong><br>p ≤ 1: DIVERGES<br>(p = 1 is harmonic → diverges)", visual: "p > 1 → converges" },
                            { title: "For p = " + p, explanation: `p = ${p}<br>${p} ${p > 1 ? '>' : '≤'} 1<br>Series <strong>${converges ? 'CONVERGES' : 'DIVERGES'}</strong>`, visual: `p = ${p} → ${converges ? 'converges' : 'diverges'}` }
                        ],
                        finalAnswer: converges ? "Converges" : "Diverges",
                        example: { problem: `Σ(1/n^${p})`, steps: [{ text: `p = ${p}`, math: `${p} ${p > 1 ? '>' : '≤'} 1` }, { text: "Result", math: `<strong>${converges ? 'CONVERGES' : 'DIVERGES'}</strong>` }]},
                        keyPoints: ["p > 1: converges", "p ≤ 1: diverges", "p = 1 is harmonic (diverges)"],
                        mistakes: [{ wrong: "p = 1 converges", why: "p = 1 is harmonic → DIVERGES" }],
                        guided: { problem: `Does Σ(1/n²) converge?`, steps: [{ label: "p = 2", value: "2 > 1?" }], answer: "Yes", answerLabel: "Converges?",
                            interactiveSteps: [
                                { prompt: "For Σ(1/n²), what is p?", hint: "The exponent on n", answer: "2", acceptableAnswers: ["2"], commonMistakes: {} },
                                { prompt: "Is 2 > 1?", hint: "Compare", answer: "yes", acceptableAnswers: ["yes", "true"], commonMistakes: {} },
                                { prompt: "Since p > 1, the series...", hint: "p > 1 means...", answer: "converges", acceptableAnswers: ["converges"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `Σ(1/√n) = Σ(1/n^0.5). Converges?`, answer: "diverges", options: ["converges", "diverges"], mistakeAnalysis: { "converges": "p = 0.5 < 1, so it DIVERGES" }}
                    };
                })(),
                {
                    id: "comparison", name: "Comparison Test",
                    goalProblem: `Use comparison: Does Σ(1/(n²+1)) converge?`,
                    teachingSteps: [
                        { title: "Comparison Test", explanation: "Compare unknown series to a known one:<br>• If aₙ ≤ bₙ and Σbₙ converges → Σaₙ converges<br>• If aₙ ≥ bₙ and Σbₙ diverges → Σaₙ diverges", visual: "Compare to known series" },
                        { title: "Find a Comparison", explanation: "1/(n²+1) < 1/n² for all n ≥ 1<br>We know Σ(1/n²) converges (p=2>1)", visual: "1/(n²+1) < 1/n²" },
                        { title: "Apply the Test", explanation: "Since 1/(n²+1) < 1/n² and Σ(1/n²) converges,<br>by comparison, <strong>Σ(1/(n²+1)) converges</strong>.", visual: "Smaller than convergent → converges" }
                    ],
                    finalAnswer: "Converges",
                    example: { problem: `Σ(1/(n²+1))`, steps: [{ text: "1/(n²+1) < 1/n²", math: "Compare to p-series p=2" }, { text: "Σ(1/n²) converges", math: "<strong>Σ(1/(n²+1)) converges</strong>" }]},
                    keyPoints: ["Compare to known series", "Smaller than convergent → converges", "Larger than divergent → diverges"],
                    mistakes: [{ wrong: "Comparing the wrong direction", why: "Must be smaller for convergence, larger for divergence" }],
                    guided: { problem: `Does Σ(1/(n+1)) converge?`, steps: [{ label: "Compare to 1/n", value: "Similar to harmonic" }], answer: "Diverges", answerLabel: "Result:",
                        interactiveSteps: [
                            { prompt: "1/(n+1) is similar to 1/n (harmonic). Does 1/n converge or diverge?", hint: "Harmonic series", answer: "diverge", acceptableAnswers: ["diverge", "diverges"], commonMistakes: {} },
                            { prompt: "Since Σ(1/(n+1)) behaves like harmonic, it also...", hint: "Same behavior", answer: "diverges", acceptableAnswers: ["diverges", "diverge"], commonMistakes: {} }
                        ]
                    },
                    practice: { problem: `1/(n³+5) vs 1/n³. Which is larger?`, answer: "1/n³", options: ["1/n³", "1/(n³+5)", "equal", "depends on n"], mistakeAnalysis: { "1/(n³+5)": "Larger denominator = smaller fraction. 1/n³ > 1/(n³+5)" }}
                }
            ]
        })
    },
    9: {
        Derivatives: () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const coef = rand(2, 5), exp = rand(2, 4);
                    const ansCoef = coef * exp;
                    return {
                        id: "power", name: "Power Rule",
                        goalProblem: `Find d/dx[${coef}x^${exp}]`,
                        teachingSteps: [
                            { title: "The Power Rule", explanation: "<strong>d/dx[xⁿ] = n · xⁿ⁻¹</strong><br>Bring down exponent, subtract 1", visual: "d/dx[xⁿ] = n·xⁿ⁻¹" },
                            { title: "With Coefficients", explanation: "Constants stay: d/dx[c·f(x)] = c·f'(x)", visual: "Coefficient stays in front" },
                            { title: "Apply", explanation: `d/dx[${coef}x^${exp}] = ${coef} · ${exp}x^${exp-1}<br>= <strong>${ansCoef}x^${exp-1}</strong>`, visual: `= ${ansCoef}x^${exp-1}` }
                        ],
                        finalAnswer: `${ansCoef}x^${exp-1}`,
                        example: { problem: `d/dx[${coef}x^${exp}]`, steps: [{ text: "Power rule", math: `${coef} · ${exp}x^${exp-1} = <strong>${ansCoef}x^${exp-1}</strong>` }]},
                        keyPoints: ["Bring down exponent as coefficient", "Subtract 1 from exponent", "Constants multiply through"],
                        mistakes: [{ wrong: "Forgetting to bring down exponent", why: "d/dx[x²] = 2x, not x" }],
                        guided: { problem: `d/dx[4x³] = ?`, steps: [{ label: "4 × 3 = 12", value: "12x²" }], answer: "12x²", answerLabel: "Derivative:",
                            interactiveSteps: [
                                { prompt: "Bring down exponent 3, multiply by 4: 4 × 3 = ?", hint: "Multiply", answer: "12", acceptableAnswers: ["12"], commonMistakes: {} },
                                { prompt: "Reduce exponent: 3 - 1 = ?", hint: "Subtract 1", answer: "2", acceptableAnswers: ["2"], commonMistakes: {} },
                                { prompt: "Final answer: coefficient × x^(new power)", hint: "12x²", answer: "12x²", acceptableAnswers: ["12x²", "12x^2"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `d/dx[x⁵] = ?`, answer: "5x⁴", options: ["5x⁴", "x⁴", "5x⁵", "4x⁵"], mistakeAnalysis: { "x⁴": "Don't forget coefficient! 5x⁴" }}
                    };
                })(),
                {
                    id: "trig", name: "Trig Derivatives",
                    goalProblem: `Find d/dx[sin(x)]`,
                    teachingSteps: [
                        { title: "Trig Derivatives", explanation: "<strong>d/dx[sin(x)] = cos(x)</strong><br><strong>d/dx[cos(x)] = -sin(x)</strong><br>Note the negative!", visual: "sin → cos, cos → -sin" },
                        { title: "More Trig", explanation: "d/dx[tan(x)] = sec²(x)<br>d/dx[cot(x)] = -csc²(x)<br>d/dx[sec(x)] = sec(x)tan(x)", visual: "tan → sec², sec → sec·tan" },
                        { title: "Apply", explanation: "d/dx[sin(x)] = <strong>cos(x)</strong>", visual: "sin → cos" }
                    ],
                    finalAnswer: "cos(x)",
                    example: { problem: `d/dx[sin(x)]`, steps: [{ text: "Standard trig derivative", math: "<strong>cos(x)</strong>" }]},
                    keyPoints: ["sin → cos", "cos → -sin (negative!)", "tan → sec²"],
                    mistakes: [{ wrong: "d/dx[cos(x)] = sin(x)", why: "It's NEGATIVE! d/dx[cos(x)] = -sin(x)" }],
                    guided: { problem: `d/dx[cos(x)] = ?`, steps: [{ label: "cos derivative", value: "negative sin" }], answer: "-sin(x)", answerLabel: "Derivative:",
                        interactiveSteps: [
                            { prompt: "The derivative of cos(x) is what function?", hint: "Related to sin...", answer: "sin(x)", acceptableAnswers: ["sin(x)", "sin x", "-sin(x)"], commonMistakes: {} },
                            { prompt: "But what's the sign? d/dx[cos(x)] = ?", hint: "Negative!", answer: "-sin(x)", acceptableAnswers: ["-sin(x)", "-sinx"], commonMistakes: { "sin(x)": "Don't forget the negative!" } }
                        ]
                    },
                    practice: { problem: `d/dx[tan(x)] = ?`, answer: "sec²(x)", options: ["sec²(x)", "cot(x)", "cos²(x)", "-sec²(x)"], mistakeAnalysis: { "cot(x)": "d/dx[tan(x)] = sec²(x), not cot" }}
                },
                (() => {
                    const inner = pick(["2x", "3x", "x²"]);
                    const innerDeriv = inner === "2x" ? "2" : inner === "3x" ? "3" : "2x";
                    return {
                        id: "chain", name: "Chain Rule Derivatives",
                        goalProblem: `Find d/dx[sin(${inner})]`,
                        teachingSteps: [
                            { title: "Chain Rule", explanation: "For composite functions:<br><strong>d/dx[f(g(x))] = f'(g(x)) · g'(x)</strong><br>\"Derivative of outside × derivative of inside\"", visual: "outer' × inner'" },
                            { title: "Identify Parts", explanation: `outer: sin(u), inner: ${inner}<br>outer': cos(u), inner': ${innerDeriv}`, visual: "sin(u) → cos(u)" },
                            { title: "Apply", explanation: `d/dx[sin(${inner})] = cos(${inner}) · ${innerDeriv}<br>= <strong>${innerDeriv}cos(${inner})</strong>`, visual: `= ${innerDeriv}cos(${inner})` }
                        ],
                        finalAnswer: `${innerDeriv}cos(${inner})`,
                        example: { problem: `d/dx[sin(${inner})]`, steps: [{ text: "Chain rule", math: `cos(${inner}) × ${innerDeriv} = <strong>${innerDeriv}cos(${inner})</strong>` }]},
                        keyPoints: ["Chain rule: outer' × inner'", "Don't forget inner derivative!", "Common: d/dx[sin(ax)] = a·cos(ax)"],
                        mistakes: [{ wrong: "Forgetting inner derivative", why: "Must multiply by derivative of inside!" }],
                        guided: { problem: `d/dx[(2x+1)³] = ?`, steps: [{ label: "Outer: u³ → 3u²", value: "3(2x+1)²" }, { label: "Inner: 2x+1 → 2", value: "×2" }], answer: "6(2x+1)²", answerLabel: "Result:",
                            interactiveSteps: [
                                { prompt: "Derivative of outer u³ is:", hint: "Power rule on u³", answer: "3u²", acceptableAnswers: ["3u²", "3u^2"], commonMistakes: {} },
                                { prompt: "Keep inner inside: 3(2x+1)². Now multiply by inner derivative: 2x+1 → ?", hint: "d/dx[2x+1]", answer: "2", acceptableAnswers: ["2"], commonMistakes: {} },
                                { prompt: "Final: 3(2x+1)² × 2 = ?", hint: "3 × 2 = 6", answer: "6(2x+1)²", acceptableAnswers: ["6(2x+1)²", "6(2x+1)^2"], commonMistakes: {} }
                            ]
                        },
                        practice: { problem: `d/dx[cos(3x)] = ?`, answer: "-3sin(3x)", options: ["-3sin(3x)", "sin(3x)", "-sin(3x)", "3cos(3x)"], mistakeAnalysis: { "-sin(3x)": "Don't forget inner derivative! × 3" }}
                    };
                })()
            ]
        }),
        Integrals: () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const n = rand(2, 4);
                    const newExp = n + 1;
                    return {
                        id: "power", name: "Power Rule Integration",
                        goalProblem: `Find ∫x${['⁰','¹','²','³','⁴'][n]} dx`,
                        teachingSteps: [
                            { title: "What is an Integral?", explanation: "An <strong>integral</strong> (antiderivative) is the <strong>reverse of a derivative</strong>.<br><br>If derivative = \"what's the slope?\", integral = \"what function has this slope?\"", visual: "Integral = Antiderivative" },
                            { title: "Power Rule for Integration", explanation: "The reverse of derivative power rule:<br><br><strong>∫xⁿ dx = xⁿ⁺¹/(n+1) + C</strong><br><br>Steps: 1) Add 1 to exponent, 2) Divide by new exponent, 3) Add +C", visual: "∫xⁿ dx = xⁿ⁺¹/(n+1) + C" },
                            { title: "What is +C?", explanation: "The <strong>+C</strong> is the \"constant of integration\".<br><br>Why? The derivative of ANY constant is 0! So x² + 5 and x² + 100 both have derivative 2x.", visual: "+C accounts for unknown constant" },
                            { title: "Apply to x" + ['⁰','¹','²','³','⁴'][n], explanation: `Add 1 to exponent: ${n} + 1 = ${newExp}<br>Divide by new exponent: x${['⁰','¹','²','³','⁴','⁵'][newExp]}/${newExp}<br>Add +C: <strong>x${['⁰','¹','²','³','⁴','⁵'][newExp]}/${newExp} + C</strong>`, visual: `x${['⁰','¹','²','³','⁴','⁵'][newExp]}/${newExp} + C` }
                        ],
                        finalAnswer: `x${['⁰','¹','²','³','⁴','⁵'][newExp]}/${newExp} + C`,
                        example: { problem: `∫x² dx`, steps: [{ text: "Add 1 to exponent", math: "2 + 1 = 3" }, { text: "Divide by new exponent", math: "x³/3" }, { text: "Add +C", math: "x³/3 + C" }]},
                        keyPoints: ["Add 1 to exponent, divide by new exponent", "Always include +C for indefinite integrals", "Integration reverses differentiation"],
                        mistakes: [{ wrong: "Forgetting +C", why: "Indefinite integrals always need +C" }, { wrong: "Subtracting from exponent", why: "That's derivatives! Integrals ADD to exponent." }],
                        guided: {
                            problem: `Find ∫x³ dx`, steps: [{ label: "Add 1 to exponent", value: "4" }, { label: "Divide by new exponent", value: "x⁴/4" }], answer: "x⁴/4 + C", answerLabel: "∫x³ dx =",
                            interactiveSteps: [
                                { prompt: "What do we do to the exponent first for integrals?", hint: "Opposite of derivatives", answer: "add 1", acceptableAnswers: ["add 1", "add one", "+1"], commonMistakes: { "subtract 1": "That's derivatives! Integrals ADD 1." }},
                                { prompt: "3 + 1 = ?", hint: "New exponent", answer: "4", acceptableAnswers: ["4"], commonMistakes: { "2": "You subtracted! ADD: 3 + 1 = 4" }},
                                { prompt: "Final answer: x⁴/4 + ?", hint: "Constant of integration", answer: "C", acceptableAnswers: ["C", "+C", "+ C"], commonMistakes: { "0": "We add +C, the constant of integration" }}
                            ]
                        },
                        practice: { problem: `∫x⁵ dx = ?`, answer: "x⁶/6 + C", options: ["x⁶/6 + C", "5x⁴ + C", "x⁵/5 + C", "x⁶ + C"], mistakeAnalysis: { "5x⁴ + C": "That's the derivative! Integral adds to exponent.", "x⁵/5 + C": "Divide by NEW exponent (6), not old (5)" }}
                    };
                })(),
                (() => {
                    const funcs = [{ f: "cos(x)", ans: "sin(x) + C", d: "sin" }, { f: "sin(x)", ans: "-cos(x) + C", d: "cos" }];
                    const func = funcs[rand(0, 1)];
                    return {
                        id: "trig", name: "Trig Integrals",
                        goalProblem: `Find ∫${func.f} dx`,
                        teachingSteps: [
                            { title: "Trig Integral Rules", explanation: "Key trig integrals to memorize:<br><br>• <strong>∫cos(x) dx = sin(x) + C</strong><br>• <strong>∫sin(x) dx = -cos(x) + C</strong><br><br>Note: ∫sin gives NEGATIVE cos!", visual: "∫cos = sin | ∫sin = -cos" },
                            { title: "Why the negative?", explanation: "Check: d/dx[-cos(x)] = -(-sin(x)) = sin(x) ✓<br><br>The negative is needed because derivative of cos is -sin, so antiderivative of sin must be -cos.", visual: "d/dx[-cos(x)] = sin(x)" },
                            { title: "Apply to our problem", explanation: `∫${func.f} dx = <strong>${func.ans}</strong>`, visual: func.ans }
                        ],
                        finalAnswer: func.ans,
                        example: { problem: `∫cos(x) dx`, steps: [{ text: "Recall: ∫cos = sin", math: "∫cos(x) dx = sin(x) + C" }]},
                        keyPoints: ["∫cos(x) dx = sin(x) + C", "∫sin(x) dx = -cos(x) + C (note the negative!)", "Always verify by differentiating"],
                        mistakes: [{ wrong: "∫sin(x) = cos(x)", why: "Missing negative! ∫sin(x) = -cos(x) + C" }],
                        guided: {
                            problem: `Find ∫sin(x) dx`, steps: [{ label: "Recall trig rule", value: "-cos(x)" }], answer: "-cos(x) + C", answerLabel: "∫sin(x) dx =",
                            interactiveSteps: [
                                { prompt: "∫sin(x) dx = ? (don't forget the sign!)", hint: "It's -cos, not +cos", answer: "-cos(x) + C", acceptableAnswers: ["-cos(x) + C", "-cos(x)+C", "-cosx + C"], commonMistakes: { "cos(x) + C": "Missing negative! ∫sin = -cos" }}
                            ]
                        },
                        practice: { problem: `∫cos(x) dx = ?`, answer: "sin(x) + C", options: ["sin(x) + C", "-sin(x) + C", "cos(x) + C", "-cos(x) + C"], mistakeAnalysis: { "-sin(x) + C": "No negative for ∫cos! That's ∫sin that needs -." }}
                    };
                })(),
                (() => {
                    const b = rand(2, 4);
                    const answer = (b * b) / 2;
                    return {
                        id: "definite", name: "Definite Integrals",
                        goalProblem: `Evaluate ∫₀${['⁰','¹','²','³','⁴'][b]} x dx`,
                        teachingSteps: [
                            { title: "Definite vs Indefinite", explanation: "<strong>Indefinite</strong>: ∫f(x)dx = F(x) + C (no bounds)<br><strong>Definite</strong>: ∫ₐᵇf(x)dx = F(b) - F(a) (has bounds, gives a NUMBER)", visual: "Definite integral = number" },
                            { title: "Fundamental Theorem", explanation: "∫ₐᵇ f(x) dx = F(b) - F(a)<br><br>Where F is the antiderivative of f. Evaluate F at upper bound, subtract F at lower bound.", visual: "[F(x)]ₐᵇ = F(b) - F(a)" },
                            { title: "Step 1: Find antiderivative", explanation: "∫x dx = x²/2<br>(No +C needed for definite integrals!)", visual: "F(x) = x²/2" },
                            { title: "Step 2: Evaluate at bounds", explanation: `[x²/2]₀${['⁰','¹','²','³','⁴'][b]} = (${b})²/2 - (0)²/2 = ${b*b}/2 - 0 = <strong>${answer}</strong>`, visual: `${b*b}/2 = ${answer}` }
                        ],
                        finalAnswer: `${answer}`,
                        example: { problem: `∫₀² x dx`, steps: [{ text: "Antiderivative", math: "x²/2" }, { text: "Evaluate [x²/2]₀²", math: "4/2 - 0 = 2" }]},
                        keyPoints: ["Definite integrals give a NUMBER", "Use F(b) - F(a)", "No +C needed for definite integrals"],
                        mistakes: [{ wrong: "Adding +C to definite integral", why: "C cancels out! F(b)+C - (F(a)+C) = F(b)-F(a)" }],
                        guided: {
                            problem: `Evaluate ∫₀³ x dx`, steps: [{ label: "Antiderivative of x", value: "x²/2" }, { label: "[x²/2]₀³", value: "?" }], answer: "9/2", answerLabel: "∫₀³ x dx =",
                            interactiveSteps: [
                                { prompt: "What's the antiderivative of x?", hint: "Power rule: add 1 to exponent, divide", answer: "x²/2", acceptableAnswers: ["x²/2", "x^2/2", "(1/2)x²"], commonMistakes: { "x²": "Don't forget to divide by new exponent: x²/2" }},
                                { prompt: "Evaluate at upper bound: (3)²/2 = ?", hint: "9/2", answer: "9/2", acceptableAnswers: ["9/2", "4.5"], commonMistakes: {}},
                                { prompt: "Subtract lower bound (0)²/2: Final answer?", hint: "9/2 - 0", answer: "9/2", acceptableAnswers: ["9/2", "4.5"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `∫₀² 2x dx = ?`, answer: "4", options: ["4", "2", "8", "x² + C"], mistakeAnalysis: { "x² + C": "Definite integrals give numbers! Evaluate at bounds.", "2": "Antiderivative is x², then [x²]₀² = 4 - 0 = 4" }}
                    };
                })()
            ]
        }),
        Applications: () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "critical", name: "Finding Critical Points",
                        goalProblem: `Find the critical point of f(x) = x² - ${2*a}x`,
                        teachingSteps: [
                            { title: "What Are Critical Points?", explanation: "<strong>Critical points</strong> are where a function might have a max or min.<br><br>They occur where:<br>• <strong>f'(x) = 0</strong> (slope is flat)<br>• <strong>f'(x) is undefined</strong>", visual: "Critical points: f'(x) = 0 or undefined" },
                            { title: "Process", explanation: "Steps to find critical points:<br>1. Find the derivative f'(x)<br>2. Set f'(x) = 0<br>3. Solve for x", visual: "f'(x) → set = 0 → solve" },
                            { title: "Step 1: Find Derivative", explanation: `f(x) = x² - ${2*a}x<br>f'(x) = 2x - ${2*a}`, visual: `f'(x) = 2x - ${2*a}` },
                            { title: "Step 2: Set = 0 and Solve", explanation: `2x - ${2*a} = 0<br>2x = ${2*a}<br>x = <strong>${a}</strong>`, visual: `x = ${a}` }
                        ],
                        finalAnswer: `x = ${a}`,
                        example: { problem: `Find critical points of f(x) = x² - 6x`, steps: [{ text: "Derivative", math: "f'(x) = 2x - 6" }, { text: "Set = 0", math: "2x - 6 = 0 → x = 3" }]},
                        keyPoints: ["Critical points occur where f'(x) = 0", "Take derivative first, then set equal to zero", "Solve the resulting equation"],
                        mistakes: [{ wrong: "Forgetting to take derivative first", why: "Must find f'(x) before setting = 0" }],
                        guided: {
                            problem: `Find critical point of f(x) = x² - 8x`, steps: [{ label: "f'(x)", value: "2x - 8" }], answer: "x = 4", answerLabel: "Critical point:",
                            interactiveSteps: [
                                { prompt: "What is f'(x) for f(x) = x² - 8x?", hint: "Power rule on each term", answer: "2x - 8", acceptableAnswers: ["2x - 8", "2x-8"], commonMistakes: { "2x": "Don't forget the -8x term! Its derivative is -8" }},
                                { prompt: "Set 2x - 8 = 0. Solve for x.", hint: "2x = 8", answer: "4", acceptableAnswers: ["4", "x = 4", "x=4"], commonMistakes: { "8": "Divide by 2: x = 8/2 = 4" }}
                            ]
                        },
                        practice: { problem: `Critical point of f(x) = x² - 10x?`, answer: "x = 5", options: ["x = 5", "x = 10", "x = -5", "x = 0"], mistakeAnalysis: { "x = 10": "f'(x) = 2x - 10 = 0 → x = 5, not 10" }}
                    };
                })(),
                {
                    id: "maxmin", name: "Max/Min Classification",
                    goalProblem: `If f'(c) = 0 and f''(c) > 0, is x = c a max or min?`,
                    teachingSteps: [
                        { title: "Second Derivative Test", explanation: "To classify a critical point:<br><br>• <strong>f''(c) > 0</strong> → Local Minimum (concave UP ∪)<br>• <strong>f''(c) < 0</strong> → Local Maximum (concave DOWN ∩)", visual: "f'' > 0: min | f'' < 0: max" },
                        { title: "Memory Trick", explanation: "Think of the sign of f'':<br>• Positive (+) = smiley face ∪ = minimum at bottom<br>• Negative (-) = frowny face ∩ = maximum at top", visual: "+ = ∪ = min | - = ∩ = max" },
                        { title: "Our Problem", explanation: "f''(c) > 0 means positive second derivative<br><br>Positive = concave UP = <strong>local minimum</strong>", visual: "f''(c) > 0 → minimum" }
                    ],
                    finalAnswer: "local minimum",
                    example: { problem: `f(x) = x², f'(0) = 0, f''(0) = 2 > 0`, steps: [{ text: "f'' > 0", math: "concave up → minimum" }]},
                    keyPoints: ["f''(c) > 0 → minimum (concave up)", "f''(c) < 0 → maximum (concave down)", "f''(c) = 0 → test inconclusive"],
                    mistakes: [{ wrong: "Mixing up signs", why: "Positive f'' = smile = MIN, Negative f'' = frown = MAX" }],
                    guided: {
                        problem: `f'(2) = 0 and f''(2) = -3. Max or min?`, steps: [{ label: "f''(2) = -3", value: "negative" }], answer: "local maximum", answerLabel: "Classification:",
                        interactiveSteps: [
                            { prompt: "Is f''(2) = -3 positive or negative?", hint: "-3 < 0", answer: "negative", acceptableAnswers: ["negative", "neg", "-", "less than 0"], commonMistakes: {}},
                            { prompt: "Negative f'' means concave... (up or down)?", hint: "Like a frown ∩", answer: "down", acceptableAnswers: ["down", "concave down"], commonMistakes: { "up": "Negative = frown = concave DOWN" }},
                            { prompt: "So x = 2 is a local... (max or min)?", hint: "Top of a frown", answer: "maximum", acceptableAnswers: ["maximum", "max", "local maximum", "local max"], commonMistakes: { "minimum": "Concave down = frown = peak = MAXIMUM" }}
                        ]
                    },
                    practice: { problem: `f''(c) < 0 at critical point. This is a...`, answer: "local maximum", options: ["local maximum", "local minimum", "inflection point", "saddle point"], mistakeAnalysis: { "local minimum": "f'' < 0 means concave DOWN = maximum, not minimum" }}
                }
            ]
        }),
        "Chain Rule": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const a = rand(2, 4), n = rand(2, 4);
                    return {
                        id: "basic", name: "Basic Chain Rule",
                        goalProblem: `Find d/dx of (${a}x + 1)${['⁰','¹','²','³','⁴'][n]}`,
                        teachingSteps: [
                            { title: "Chain Rule Formula", explanation: "For composite functions f(g(x)):<br><strong>d/dx[f(g(x))] = f'(g(x)) · g'(x)</strong><br><br>\"Derivative of outer × Derivative of inner\"", visual: "f'(g(x)) · g'(x)" },
                            { title: "Identify Parts", explanation: `Outer: u${['⁰','¹','²','³','⁴'][n]} → derivative: ${n}u${['⁰','¹','²','³'][n-1]}<br>Inner: ${a}x + 1 → derivative: ${a}`, visual: `Outer: u${['⁰','¹','²','³','⁴'][n]}, Inner: ${a}x + 1` },
                            { title: "Apply Chain Rule", explanation: `${n}(${a}x + 1)${['⁰','¹','²','³'][n-1]} × ${a} = <strong>${a*n}(${a}x + 1)${['⁰','¹','²','³'][n-1]}</strong>`, visual: `${a*n}(${a}x + 1)${['⁰','¹','²','³'][n-1]}` }
                        ],
                        finalAnswer: `${a*n}(${a}x + 1)${['⁰','¹','²','³'][n-1]}`,
                        example: { problem: `d/dx[(3x+1)²]`, steps: [{ text: "Outer deriv × Inner deriv", math: "2(3x+1)¹ × 3 = 6(3x+1)" }]},
                        keyPoints: ["Chain rule: outer' × inner'", "Don't forget to multiply by inner derivative", "Power comes down, exponent reduces by 1"],
                        mistakes: [{ wrong: "Forgetting inner derivative", why: "Must multiply by derivative of inside function!" }],
                        guided: {
                            problem: `d/dx[(2x+5)³]`, steps: [{ label: "Outer derivative", value: "3(2x+5)²" }], answer: "6(2x+5)²", answerLabel: "d/dx =",
                            interactiveSteps: [
                                { prompt: "Derivative of outer u³ is?", hint: "Power rule", answer: "3u²", acceptableAnswers: ["3u²", "3u^2"], commonMistakes: {}},
                                { prompt: "Derivative of inner (2x+5) is?", hint: "d/dx of 2x+5", answer: "2", acceptableAnswers: ["2"], commonMistakes: {}},
                                { prompt: "Multiply: 3(2x+5)² × 2 = ?", hint: "3 × 2 = 6", answer: "6(2x+5)²", acceptableAnswers: ["6(2x+5)²", "6(2x+5)^2"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `d/dx[(4x+1)²] = ?`, answer: "8(4x+1)", options: ["8(4x+1)", "2(4x+1)", "4(4x+1)", "8x"], mistakeAnalysis: { "2(4x+1)": "Multiply by inner derivative 4!" }}
                    };
                })(),
                (() => {
                    const a = rand(2, 5);
                    return {
                        id: "trig", name: "Chain Rule with Trig",
                        goalProblem: `Find d/dx[sin(${a}x)]`,
                        teachingSteps: [
                            { title: "Trig Chain Rule", explanation: "When differentiating trig(u), use chain rule:<br><br>d/dx[sin(u)] = cos(u) · u'<br>d/dx[cos(u)] = -sin(u) · u'", visual: "sin(u)' = cos(u)·u'" },
                            { title: "Apply to sin(${a}x)", explanation: `Outer: sin → cos<br>Inner: ${a}x → ${a}<br><br>cos(${a}x) × ${a} = <strong>${a}cos(${a}x)</strong>`, visual: `${a}cos(${a}x)` }
                        ],
                        finalAnswer: `${a}cos(${a}x)`,
                        example: { problem: `d/dx[cos(3x)]`, steps: [{ text: "Chain rule", math: "-sin(3x) × 3 = -3sin(3x)" }]},
                        keyPoints: ["d/dx[sin(u)] = cos(u)·u'", "d/dx[cos(u)] = -sin(u)·u'", "Always multiply by inner derivative"],
                        mistakes: [{ wrong: "d/dx[sin(3x)] = cos(3x)", why: "Missing inner derivative! Must multiply by 3." }],
                        guided: {
                            problem: `d/dx[cos(4x)]`, steps: [{ label: "Outer derivative", value: "-sin(4x)" }], answer: "-4sin(4x)", answerLabel: "d/dx =",
                            interactiveSteps: [
                                { prompt: "Derivative of cos is?", hint: "Negative sin", answer: "-sin", acceptableAnswers: ["-sin", "-sin(u)", "-sinx"], commonMistakes: { "sin": "It's NEGATIVE sin!" }},
                                { prompt: "Multiply by inner derivative: -sin(4x) × 4 = ?", hint: "", answer: "-4sin(4x)", acceptableAnswers: ["-4sin(4x)", "-4sin4x"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `d/dx[sin(5x)] = ?`, answer: "5cos(5x)", options: ["5cos(5x)", "cos(5x)", "-5cos(5x)", "5sin(5x)"], mistakeAnalysis: { "cos(5x)": "Don't forget × 5!" }}
                    };
                })(),
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "exponential", name: "Chain Rule with Exponentials",
                        goalProblem: `Find d/dx[e^(${a}x)]`,
                        teachingSteps: [
                            { title: "Exponential Chain Rule", explanation: "d/dx[e^u] = e^u · u'<br><br>The e^u stays the same, just multiply by derivative of exponent!", visual: "d/dx[e^u] = e^u · u'" },
                            { title: "Apply", explanation: `d/dx[e^(${a}x)] = e^(${a}x) × ${a} = <strong>${a}e^(${a}x)</strong>`, visual: `${a}e^(${a}x)` }
                        ],
                        finalAnswer: `${a}e^(${a}x)`,
                        example: { problem: `d/dx[e^(2x)]`, steps: [{ text: "e^u stays, multiply by u'", math: "e^(2x) × 2 = 2e^(2x)" }]},
                        keyPoints: ["d/dx[e^x] = e^x (special!)", "d/dx[e^u] = e^u · u'", "Exponential never changes, just multiply by inner derivative"],
                        mistakes: [{ wrong: "d/dx[e^(3x)] = e^(3x)", why: "Need × 3 from chain rule!" }],
                        guided: {
                            problem: `d/dx[e^(5x)]`, steps: [{ label: "e stays", value: "e^(5x)" }], answer: "5e^(5x)", answerLabel: "d/dx =",
                            interactiveSteps: [
                                { prompt: "d/dx[e^(5x)]: The e^(5x) stays. What do we multiply by?", hint: "Inner derivative", answer: "5", acceptableAnswers: ["5"], commonMistakes: {}},
                                { prompt: "Final answer?", hint: "5 × e^(5x)", answer: "5e^(5x)", acceptableAnswers: ["5e^(5x)", "5e^5x"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `d/dx[e^(−2x)] = ?`, answer: "-2e^(-2x)", options: ["-2e^(-2x)", "e^(-2x)", "2e^(-2x)", "-2e^(2x)"], mistakeAnalysis: { "e^(-2x)": "Multiply by -2!" }}
                    };
                })()
            ]
        }),
        "Product Rule": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "basic", name: "Product Rule Basics",
                        goalProblem: `Find d/dx[x · e^(${a}x)]`,
                        teachingSteps: [
                            { title: "Product Rule Formula", explanation: "<strong>(f · g)' = f'g + fg'</strong><br><br>\"Derivative of first × second + First × derivative of second\"", visual: "(fg)' = f'g + fg'" },
                            { title: "Identify Parts", explanation: `f = x → f' = 1<br>g = e^(${a}x) → g' = ${a}e^(${a}x) (chain rule!)`, visual: "f = x, g = e^(${a}x)" },
                            { title: "Apply", explanation: `f'g + fg' = 1·e^(${a}x) + x·${a}e^(${a}x)<br>= <strong>e^(${a}x) + ${a}xe^(${a}x)</strong>`, visual: `e^(${a}x) + ${a}xe^(${a}x)` }
                        ],
                        finalAnswer: `e^(${a}x) + ${a}xe^(${a}x)`,
                        example: { problem: `d/dx[x·e^x]`, steps: [{ text: "f'g + fg'", math: "1·e^x + x·e^x = e^x + xe^x" }]},
                        keyPoints: ["Product rule: f'g + fg'", "Two terms in the answer", "Don't multiply derivatives together"],
                        mistakes: [{ wrong: "f'·g' = 1·e^x = e^x", why: "Product rule has TWO terms: f'g + fg'" }],
                        guided: {
                            problem: `d/dx[x²·e^x]`, steps: [{ label: "f = x², f' = 2x", value: "" }], answer: "2xe^x + x²e^x", answerLabel: "d/dx =",
                            interactiveSteps: [
                                { prompt: "f = x². What is f'?", hint: "Power rule", answer: "2x", acceptableAnswers: ["2x"], commonMistakes: {}},
                                { prompt: "g = e^x. What is g'?", hint: "e^x is special", answer: "e^x", acceptableAnswers: ["e^x", "e^(x)", "eˣ"], commonMistakes: {}},
                                { prompt: "f'g + fg' = 2x·e^x + x²·e^x = ?", hint: "Just write it out", answer: "2xe^x + x²e^x", acceptableAnswers: ["2xe^x + x²e^x", "2x·e^x + x²·e^x"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `d/dx[3x·e^x] = ?`, answer: "3e^x + 3xe^x", options: ["3e^x + 3xe^x", "3e^x", "3xe^x", "3x·e^x"], mistakeAnalysis: { "3e^x": "That's f'g. Need + fg' = 3xe^x too!" }}
                    };
                })(),
                {
                    id: "trig", name: "Product Rule with Trig",
                    goalProblem: `Find d/dx[x·sin(x)]`,
                    teachingSteps: [
                        { title: "Product Rule", explanation: "(fg)' = f'g + fg'<br><br>f = x → f' = 1<br>g = sin(x) → g' = cos(x)", visual: "f = x, g = sin(x)" },
                        { title: "Apply", explanation: "f'g + fg' = 1·sin(x) + x·cos(x)<br>= <strong>sin(x) + x·cos(x)</strong>", visual: "sin(x) + x·cos(x)" }
                    ],
                    finalAnswer: "sin(x) + x·cos(x)",
                    example: { problem: `d/dx[x·cos(x)]`, steps: [{ text: "f'g + fg'", math: "1·cos(x) + x·(-sin(x)) = cos(x) - x·sin(x)" }]},
                    keyPoints: ["d/dx[sin] = cos", "d/dx[cos] = -sin", "Don't forget both terms"],
                    mistakes: [{ wrong: "x·cos(x)", why: "That's only fg'. Need f'g too: sin(x) + x·cos(x)" }],
                    guided: {
                        problem: `d/dx[x²·sin(x)]`, steps: [{ label: "f = x², g = sin(x)", value: "" }], answer: "2x·sin(x) + x²·cos(x)", answerLabel: "d/dx =",
                        interactiveSteps: [
                            { prompt: "f' for f = x²?", hint: "Power rule", answer: "2x", acceptableAnswers: ["2x"], commonMistakes: {}},
                            { prompt: "g' for g = sin(x)?", hint: "Trig derivative", answer: "cos(x)", acceptableAnswers: ["cos(x)", "cosx"], commonMistakes: { "-sin(x)": "That's for cos. sin' = cos (positive)" }},
                            { prompt: "f'g + fg' = ?", hint: "2x·sin(x) + x²·cos(x)", answer: "2x·sin(x) + x²·cos(x)", acceptableAnswers: ["2x·sin(x) + x²·cos(x)", "2xsin(x) + x²cos(x)"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `d/dx[x·cos(x)] = ?`, answer: "cos(x) - x·sin(x)", options: ["cos(x) - x·sin(x)", "cos(x) + x·sin(x)", "-x·sin(x)", "x·cos(x)"], mistakeAnalysis: { "cos(x) + x·sin(x)": "g' = -sin, so fg' = -x·sin(x)" }}
                }
            ]
        }),
        "Integration Techniques": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "substitution", name: "U-Substitution",
                        goalProblem: `∫${a}x·e^(x²) dx. What substitution should we use?`,
                        teachingSteps: [
                            { title: "When to Use Substitution", explanation: "Use <strong>u-substitution</strong> when you see a function and its derivative together.<br><br>Look for: inner function g(x) whose derivative g'(x) appears as a factor.", visual: "∫f(g(x))·g'(x) dx → ∫f(u) du" },
                            { title: "Our Problem", explanation: `∫${a}x·e^(x²) dx<br><br>Notice: d/dx(x²) = 2x. The 'x' is almost the derivative of x²!<br>Let <strong>u = x²</strong>, then du = 2x dx`, visual: "u = x², du = 2x dx" },
                            { title: "Substitute", explanation: `∫${a}x·e^(x²) dx = (${a}/2)∫e^u du = (${a}/2)e^u + C<br><br>Substitute back: <strong>(${a}/2)e^(x²) + C</strong>`, visual: `(${a}/2)e^(x²) + C` }
                        ],
                        finalAnswer: "u = x²",
                        example: { problem: `∫2x·cos(x²) dx`, steps: [{ text: "Let u = x²", math: "du = 2x dx" }, { text: "= ∫cos(u) du = sin(u) + C", math: "= sin(x²) + C" }]},
                        keyPoints: ["Look for function and its derivative together", "u = inner function", "Don't forget to substitute back!"],
                        mistakes: [{ wrong: "u = e^(x²)", why: "Pick the inner function (x²), not the whole expression" }],
                        guided: {
                            problem: `∫6x²·(x³+1)⁴ dx. What is u?`, steps: [{ label: "Inner function", value: "x³ + 1" }], answer: "u = x³ + 1", answerLabel: "u =",
                            interactiveSteps: [
                                { prompt: "What's inside the parentheses being raised to a power?", hint: "The inner function", answer: "x³ + 1", acceptableAnswers: ["x³ + 1", "x³+1", "x^3 + 1"], commonMistakes: {}},
                                { prompt: "If u = x³ + 1, what is du?", hint: "Differentiate", answer: "3x² dx", acceptableAnswers: ["3x² dx", "3x^2 dx", "3x²dx"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `∫cos(x)·e^(sin x) dx. What is u?`, answer: "u = sin(x)", options: ["u = sin(x)", "u = cos(x)", "u = e^(sin x)", "u = x"], mistakeAnalysis: { "u = cos(x)": "cos(x) is the derivative of sin(x). u should be sin(x), the inner function." }}
                    };
                })(),
                {
                    id: "parts", name: "Integration by Parts",
                    goalProblem: `∫x·e^x dx uses integration by parts. What should u be?`,
                    teachingSteps: [
                        { title: "Integration by Parts Formula", explanation: "<strong>∫u dv = uv - ∫v du</strong><br><br>Choose u (to differentiate) and dv (to integrate).", visual: "∫u dv = uv - ∫v du" },
                        { title: "LIATE Rule", explanation: "Choose u in this priority order:<br><strong>L</strong>ogarithms > <strong>I</strong>nverse trig > <strong>A</strong>lgebraic > <strong>T</strong>rig > <strong>E</strong>xponential<br><br>For x·e^x: x is Algebraic, e^x is Exponential. So u = x.", visual: "LIATE: pick u from earlier in list" },
                        { title: "Apply", explanation: "u = x → du = dx<br>dv = e^x dx → v = e^x<br><br>∫x·e^x dx = x·e^x - ∫e^x dx = <strong>x·e^x - e^x + C</strong>", visual: "x·e^x - e^x + C" }
                    ],
                    finalAnswer: "u = x",
                    example: { problem: `∫x·sin(x) dx`, steps: [{ text: "u = x, dv = sin(x)dx", math: "du = dx, v = -cos(x)" }, { text: "= -x·cos(x) + ∫cos(x)dx", math: "= -x·cos(x) + sin(x) + C" }]},
                    keyPoints: ["LIATE helps choose u", "u = part to differentiate", "dv = part to integrate"],
                    mistakes: [{ wrong: "u = e^x", why: "LIATE: Algebraic (x) comes before Exponential (e^x). Choose u = x." }],
                    guided: {
                        problem: `∫x·cos(x) dx. What is u?`, steps: [{ label: "LIATE priority", value: "A > T" }], answer: "u = x", answerLabel: "u =",
                        interactiveSteps: [
                            { prompt: "In LIATE, what type is x?", hint: "L-I-A-T-E", answer: "Algebraic", acceptableAnswers: ["Algebraic", "A", "algebraic"], commonMistakes: {}},
                            { prompt: "What type is cos(x)?", hint: "L-I-A-T-E", answer: "Trig", acceptableAnswers: ["Trig", "T", "trig", "trigonometric"], commonMistakes: {}},
                            { prompt: "A comes before T, so u = ?", hint: "Pick the earlier one", answer: "x", acceptableAnswers: ["x", "u = x"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `∫ln(x) dx. What is u?`, answer: "u = ln(x)", options: ["u = ln(x)", "u = 1", "u = x", "u = 1/x"], mistakeAnalysis: { "u = 1": "LIATE: L (logarithms) comes first. u = ln(x)" }}
                },
                {
                    id: "trig", name: "Trig Identities in Integration",
                    goalProblem: `∫sin²(x) dx uses which identity?`,
                    teachingSteps: [
                        { title: "Power-Reducing Identities", explanation: "For sin² and cos² integrals, use:<br><br><strong>sin²(x) = (1 - cos(2x))/2</strong><br><strong>cos²(x) = (1 + cos(2x))/2</strong>", visual: "sin² = (1 - cos2x)/2" },
                        { title: "Why?", explanation: "sin²(x) is hard to integrate directly.<br>But (1 - cos(2x))/2 is easy!<br><br>∫(1 - cos(2x))/2 dx = x/2 - sin(2x)/4 + C", visual: "∫sin²dx = x/2 - sin(2x)/4 + C" }
                    ],
                    finalAnswer: "sin²(x) = (1 - cos(2x))/2",
                    example: { problem: `∫cos²(x) dx`, steps: [{ text: "Use cos² = (1+cos2x)/2", math: "= ∫(1+cos2x)/2 dx = x/2 + sin(2x)/4 + C" }]},
                    keyPoints: ["sin²x = (1-cos2x)/2", "cos²x = (1+cos2x)/2", "These make integration possible"],
                    mistakes: [{ wrong: "sin² + cos² = 1", why: "That's Pythagorean identity, not power-reducing. Use (1 - cos2x)/2." }],
                    guided: {
                        problem: `What identity for ∫cos²(x) dx?`, steps: [{ label: "Power-reducing", value: "" }], answer: "cos²(x) = (1 + cos(2x))/2", answerLabel: "Identity:",
                        interactiveSteps: [
                            { prompt: "cos²(x) = (1 + __)/2", hint: "cos(2x) or -cos(2x)?", answer: "cos(2x)", acceptableAnswers: ["cos(2x)", "cos2x"], commonMistakes: { "-cos(2x)": "That's for sin². cos² uses + cos(2x)" }}
                        ]
                    },
                    practice: { problem: `Which identity helps integrate sin²(x)?`, answer: "sin²(x) = (1 - cos(2x))/2", options: ["sin²(x) = (1 - cos(2x))/2", "sin²(x) + cos²(x) = 1", "sin(2x) = 2sin(x)cos(x)", "cos²(x) = (1 + cos(2x))/2"], mistakeAnalysis: { "sin²(x) + cos²(x) = 1": "Need power-reducing identity to integrate sin²" }}
                }
            ]
        }),
        "Differential Equations": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "identify", name: "Identify DE Order",
                    goalProblem: `What order is the differential equation: dy/dx = 2x?`,
                    teachingSteps: [
                        { title: "What is Order?", explanation: "The <strong>order</strong> of a differential equation is the <strong>highest derivative</strong> that appears.<br><br>• dy/dx (first derivative) → <strong>first-order</strong><br>• d²y/dx² (second derivative) → <strong>second-order</strong>", visual: "Order = highest derivative" },
                        { title: "Examples", explanation: "• dy/dx = x → first-order<br>• d²y/dx² + y = 0 → second-order<br>• d³y/dx³ = x² → third-order", visual: "dy/dx: 1st | d²y/dx²: 2nd | d³y/dx³: 3rd" },
                        { title: "Our Problem", explanation: "dy/dx = 2x<br><br>Highest derivative is dy/dx (first derivative).<br>This is <strong>first-order</strong>.", visual: "First-order" }
                    ],
                    finalAnswer: "first-order",
                    example: { problem: `Order of d²y/dx² + 3y = 0?`, steps: [{ text: "Highest derivative", math: "d²y/dx² → second-order" }]},
                    keyPoints: ["Order = highest derivative present", "dy/dx → 1st order", "d²y/dx² → 2nd order"],
                    mistakes: [{ wrong: "Counting the degree instead of order", why: "Order is about which derivative, not the power of terms" }],
                    guided: {
                        problem: `What order is d²y/dx² + dy/dx = 0?`, steps: [{ label: "Find highest derivative", value: "d²y/dx²" }], answer: "second-order", answerLabel: "Order:",
                        interactiveSteps: [
                            { prompt: "What's the highest derivative in d²y/dx² + dy/dx = 0?", hint: "2nd or 1st?", answer: "d²y/dx²", acceptableAnswers: ["d²y/dx²", "d^2y/dx^2", "second derivative"], commonMistakes: {}},
                            { prompt: "So the order is?", hint: "2nd derivative means...", answer: "second-order", acceptableAnswers: ["second-order", "second order", "2nd order", "2"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `Order of dy/dx = y?`, answer: "first-order", options: ["first-order", "second-order", "zero-order", "third-order"], mistakeAnalysis: { "second-order": "dy/dx is first derivative, so first-order" }}
                },
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "verify", name: "Verify Solutions",
                        goalProblem: `Verify: Is y = e^(${a}x) a solution to dy/dx = ${a}y?`,
                        teachingSteps: [
                            { title: "How to Verify", explanation: "To verify a solution:<br>1. Substitute y into the equation<br>2. Check if both sides are equal", visual: "Plug in y, check if equation holds" },
                            { title: "Find dy/dx", explanation: `y = e^(${a}x)<br>dy/dx = ${a}e^(${a}x) (chain rule)`, visual: `dy/dx = ${a}e^(${a}x)` },
                            { title: "Check RHS", explanation: `RHS = ${a}y = ${a}·e^(${a}x) = ${a}e^(${a}x)<br><br>LHS = dy/dx = ${a}e^(${a}x)<br><br>LHS = RHS ✓`, visual: `${a}e^(${a}x) = ${a}e^(${a}x) ✓` }
                        ],
                        finalAnswer: "Yes, it is a solution",
                        example: { problem: `Is y = e^x a solution to dy/dx = y?`, steps: [{ text: "dy/dx = e^x, and y = e^x", math: "e^x = e^x ✓" }]},
                        keyPoints: ["Substitute proposed solution", "Calculate derivatives needed", "Check if equation is satisfied"],
                        mistakes: [{ wrong: "Not differentiating correctly", why: "Must use chain rule for e^(ax)" }],
                        guided: {
                            problem: `Is y = x² a solution to dy/dx = 2x?`, steps: [{ label: "Find dy/dx", value: "2x" }], answer: "Yes", answerLabel: "Is it a solution?",
                            interactiveSteps: [
                                { prompt: "If y = x², what is dy/dx?", hint: "Power rule", answer: "2x", acceptableAnswers: ["2x"], commonMistakes: {}},
                                { prompt: "Does dy/dx = 2x match the equation dy/dx = 2x?", hint: "Compare", answer: "Yes", acceptableAnswers: ["Yes", "yes", "y", "true"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `Is y = sin(x) a solution to dy/dx = cos(x)?`, answer: "Yes", options: ["Yes", "No", "Only for x > 0", "Need more info"], mistakeAnalysis: { "No": "d/dx[sin(x)] = cos(x), so yes it works!" }}
                    };
                })(),
                (() => {
                    const k = rand(2, 4);
                    return {
                        id: "separate", name: "Separable Equations",
                        goalProblem: `Solve dy/dx = ${k}x with y(0) = 1`,
                        teachingSteps: [
                            { title: "Separable Equations", explanation: "A <strong>separable</strong> DE can be written as:<br>dy/dx = f(x)·g(y)<br><br>Strategy: Get all y's on one side, all x's on other.", visual: "Separate x and y, then integrate" },
                            { title: "Integrate", explanation: `dy/dx = ${k}x<br>∫dy = ∫${k}x dx<br>y = ${k}x²/2 + C`, visual: `y = ${k}x²/2 + C` },
                            { title: "Use Initial Condition", explanation: `y(0) = 1: 1 = ${k}(0)²/2 + C<br>C = 1<br><br><strong>y = ${k}x²/2 + 1</strong>`, visual: `y = ${k}x²/2 + 1` }
                        ],
                        finalAnswer: `y = ${k}x²/2 + 1`,
                        example: { problem: `Solve dy/dx = 4x, y(0) = 3`, steps: [{ text: "Integrate", math: "y = 2x² + C" }, { text: "y(0) = 3 → C = 3", math: "y = 2x² + 3" }]},
                        keyPoints: ["Separate variables", "Integrate both sides", "Use initial condition for C"],
                        mistakes: [{ wrong: "Forgetting +C", why: "Always add constant, then use initial condition" }],
                        guided: {
                            problem: `Solve dy/dx = 6x, y(0) = 2`, steps: [{ label: "Integrate", value: "y = 3x² + C" }], answer: "y = 3x² + 2", answerLabel: "Solution:",
                            interactiveSteps: [
                                { prompt: "∫6x dx = ?", hint: "Power rule", answer: "3x² + C", acceptableAnswers: ["3x² + C", "3x²+C", "3x^2 + C"], commonMistakes: { "6x²": "Divide by 2: 6x²/2 = 3x²" }},
                                { prompt: "If y(0) = 2 and y = 3x² + C, find C", hint: "Plug in x = 0", answer: "2", acceptableAnswers: ["2", "C = 2"], commonMistakes: {}},
                                { prompt: "Final solution?", hint: "y = 3x² + ?", answer: "y = 3x² + 2", acceptableAnswers: ["y = 3x² + 2", "3x² + 2"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `Solve dy/dx = 2, y(0) = 5. What is y?`, answer: "y = 2x + 5", options: ["y = 2x + 5", "y = x² + 5", "y = 2x", "y = 5"], mistakeAnalysis: { "y = x² + 5": "∫2 dx = 2x, not x²" }}
                    };
                })()
            ]
        }),
        "Calculus Limits": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "fundamental", name: "Fundamental Limits",
                    goalProblem: `Find lim(x→0) sin(x)/x`,
                    teachingSteps: [
                        { title: "Fundamental Limits", explanation: "Some limits are so important, you should memorize them:<br><br><strong>lim(x→0) sin(x)/x = 1</strong><br><strong>lim(x→0) (1-cos(x))/x = 0</strong><br><strong>lim(x→0) (e^x - 1)/x = 1</strong>", visual: "sin(x)/x → 1 as x → 0" },
                        { title: "Why sin(x)/x = 1?", explanation: "As x gets very small, sin(x) ≈ x (in radians).<br><br>So sin(x)/x ≈ x/x = 1<br><br>This is called the <strong>small angle approximation</strong>.", visual: "sin(x) ≈ x for small x" },
                        { title: "The Squeeze Theorem", explanation: "Formally: cos(x) ≤ sin(x)/x ≤ 1 for small x.<br><br>As x→0: cos(0) = 1 and 1 = 1.<br>So sin(x)/x is \"squeezed\" to <strong>1</strong>.", visual: "Squeeze: lim = 1" }
                    ],
                    finalAnswer: "1",
                    example: { problem: `lim(x→0) sin(3x)/(3x)`, steps: [{ text: "Same form as sin(u)/u", math: "Let u = 3x. As x→0, u→0. So limit = 1" }]},
                    keyPoints: ["lim(x→0) sin(x)/x = 1", "lim(x→0) (e^x-1)/x = 1", "These are fundamental - memorize them!"],
                    mistakes: [{ wrong: "0/0 = 0", why: "0/0 is indeterminate. sin(x)/x → 1, not 0." }],
                    guided: {
                        problem: `lim(x→0) sin(2x)/(2x) = ?`, steps: [{ label: "Same form as sin(u)/u", value: "u = 2x" }], answer: "1", answerLabel: "Limit =",
                        interactiveSteps: [
                            { prompt: "Is sin(2x)/(2x) in the form sin(u)/u?", hint: "Let u = 2x", answer: "yes", acceptableAnswers: ["yes", "Yes", "y", "true"], commonMistakes: {}},
                            { prompt: "So the limit equals?", hint: "Fundamental limit", answer: "1", acceptableAnswers: ["1"], commonMistakes: { "0": "sin(u)/u → 1, not 0" }}
                        ]
                    },
                    practice: { problem: `lim(x→0) sin(x)/x = ?`, answer: "1", options: ["1", "0", "∞", "DNE"], mistakeAnalysis: { "0": "This fundamental limit equals 1, not 0" }}
                },
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "lhopital", name: "L'Hôpital's Rule",
                        goalProblem: `Use L'Hôpital's Rule: lim(x→0) (e^(${a}x) - 1)/(${a}x) = ?`,
                        teachingSteps: [
                            { title: "L'Hôpital's Rule", explanation: "When you get <strong>0/0</strong> or <strong>∞/∞</strong>:<br><br>lim f(x)/g(x) = lim f'(x)/g'(x)<br><br>Take derivative of top AND bottom separately!", visual: "0/0 → f'/g'" },
                            { title: "Check Conditions", explanation: `At x = 0: (e⁰ - 1)/(${a}·0) = (1-1)/0 = 0/0 ✓<br><br>We can apply L'Hôpital's Rule!`, visual: "0/0: Apply L'Hôpital's" },
                            { title: "Apply", explanation: `f(x) = e^(${a}x) - 1 → f'(x) = ${a}e^(${a}x)<br>g(x) = ${a}x → g'(x) = ${a}<br><br>lim = ${a}e^(${a}·0)/${a} = ${a}·1/${a} = <strong>1</strong>`, visual: `${a}e⁰/${a} = 1` }
                        ],
                        finalAnswer: "1",
                        example: { problem: `lim(x→0) (e^x - 1)/x`, steps: [{ text: "0/0, so L'Hôpital's", math: "= lim e^x / 1 = e⁰ = 1" }]},
                        keyPoints: ["Only use for 0/0 or ∞/∞", "Differentiate top and bottom SEPARATELY", "Check result - may need to apply again"],
                        mistakes: [{ wrong: "Applying quotient rule", why: "L'Hôpital's = separate derivatives, not quotient rule" }],
                        guided: {
                            problem: `lim(x→0) sin(x)/x using L'Hôpital's`, steps: [{ label: "f' = cos(x), g' = 1", value: "" }], answer: "1", answerLabel: "Limit =",
                            interactiveSteps: [
                                { prompt: "Is sin(0)/0 = 0/0?", hint: "Check", answer: "yes", acceptableAnswers: ["yes", "Yes", "y"], commonMistakes: {}},
                                { prompt: "d/dx[sin(x)] = ?", hint: "Trig derivative", answer: "cos(x)", acceptableAnswers: ["cos(x)", "cosx"], commonMistakes: {}},
                                { prompt: "So lim cos(x)/1 as x→0 = ?", hint: "cos(0) = ?", answer: "1", acceptableAnswers: ["1"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `When can you use L'Hôpital's Rule?`, answer: "When limit gives 0/0 or ∞/∞", options: ["When limit gives 0/0 or ∞/∞", "Any fraction", "Only 0/0", "Never"], mistakeAnalysis: { "Any fraction": "Only for indeterminate forms 0/0 or ∞/∞" }}
                    };
                })()
            ]
        }),
        "Quotient Rule": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "formula", name: "Quotient Rule Formula",
                    goalProblem: `What is the quotient rule: d/dx[f/g] = ?`,
                    teachingSteps: [
                        { title: "The Quotient Rule", explanation: "For f(x) = g(x)/h(x):<br><br><strong>f'(x) = (g'h - gh')/h²</strong><br><br>\"Low d-High minus High d-Low, over Low squared\"", visual: "(g'h - gh')/h²" },
                        { title: "Memory Trick", explanation: "\"Lo d-Hi minus Hi d-Lo, square the bottom and away we go!\"<br><br>Lo = h (bottom), Hi = g (top)<br>d-Hi = g', d-Lo = h'", visual: "lo·d(hi) - hi·d(lo) / lo²" }
                    ],
                    finalAnswer: "(g'h - gh')/h²",
                    example: { problem: `d/dx[x/sinx]`, steps: [{ text: "(g'h - gh')/h²", math: "(1·sinx - x·cosx)/sin²x" }]},
                    keyPoints: ["Formula: (g'h - gh')/h²", "Order: g'h MINUS gh' (not reversed)", "Denominator is squared"],
                    mistakes: [{ wrong: "(gh' - g'h)/h²", why: "Wrong order! It's g'h - gh', not gh' - g'h" }],
                    guided: {
                        problem: `Complete: d/dx[f/g] = (f'g - fg')/...`, steps: [{ label: "Denominator", value: "?" }], answer: "g²", answerLabel: "d/dx[f/g] = (f'g - fg')/",
                        interactiveSteps: [
                            { prompt: "In quotient rule, what goes in the denominator?", hint: "The bottom, squared", answer: "g²", acceptableAnswers: ["g²", "g^2", "g squared"], commonMistakes: { "g": "Must square the bottom: g²" }}
                        ]
                    },
                    practice: { problem: `Quotient rule: d/dx[f/g] = ?`, answer: "(f'g - fg')/g²", options: ["(f'g - fg')/g²", "(fg' - f'g)/g²", "(f'g + fg')/g²", "f'/g'"], mistakeAnalysis: { "(fg' - f'g)/g²": "Wrong order! f'g comes first." }}
                },
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "apply", name: "Apply Quotient Rule",
                        goalProblem: `Find d/dx[x/(x + ${a})]`,
                        teachingSteps: [
                            { title: "Identify Parts", explanation: `g = x → g' = 1<br>h = x + ${a} → h' = 1`, visual: "g = x, h = x + " + a },
                            { title: "Apply Formula", explanation: `(g'h - gh')/h²<br>= (1·(x+${a}) - x·1)/(x+${a})²<br>= (x + ${a} - x)/(x+${a})²<br>= <strong>${a}/(x+${a})²</strong>`, visual: `${a}/(x+${a})²` }
                        ],
                        finalAnswer: `${a}/(x+${a})²`,
                        example: { problem: `d/dx[x/(x+2)]`, steps: [{ text: "(1(x+2) - x(1))/(x+2)²", math: "2/(x+2)²" }]},
                        keyPoints: ["Identify g, h and their derivatives", "Apply formula carefully", "Simplify the numerator"],
                        mistakes: [{ wrong: "1/(x+a)", why: "Must apply full quotient rule, not just differentiate top" }],
                        guided: {
                            problem: `d/dx[x/(x+3)]`, steps: [{ label: "g' = 1, h' = 1", value: "" }], answer: "3/(x+3)²", answerLabel: "d/dx =",
                            interactiveSteps: [
                                { prompt: "g'h = 1·(x+3) = ?", hint: "", answer: "x+3", acceptableAnswers: ["x+3", "x + 3"], commonMistakes: {}},
                                { prompt: "gh' = x·1 = ?", hint: "", answer: "x", acceptableAnswers: ["x"], commonMistakes: {}},
                                { prompt: "(x+3) - x = ?", hint: "Simplify", answer: "3", acceptableAnswers: ["3"], commonMistakes: {}},
                                { prompt: "So the answer is 3/...?", hint: "h²", answer: "(x+3)²", acceptableAnswers: ["(x+3)²", "(x+3)^2"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `d/dx[x/(x+5)] = ?`, answer: "5/(x+5)²", options: ["5/(x+5)²", "1/(x+5)", "-5/(x+5)²", "1/(x+5)²"], mistakeAnalysis: { "1/(x+5)": "Use quotient rule properly!" }}
                    };
                })(),
                {
                    id: "simplify", name: "Simplify Quotient Derivatives",
                    goalProblem: `Simplify: d/dx[sin(x)/x] at x = π/2`,
                    teachingSteps: [
                        { title: "First Apply Quotient Rule", explanation: "g = sinx, g' = cosx<br>h = x, h' = 1<br><br>(cosx·x - sinx·1)/x² = (x·cosx - sinx)/x²", visual: "(x·cosx - sinx)/x²" },
                        { title: "Evaluate at x = π/2", explanation: "At x = π/2:<br>cos(π/2) = 0, sin(π/2) = 1<br><br>((π/2)·0 - 1)/(π/2)² = -1/(π²/4) = <strong>-4/π²</strong>", visual: "-4/π² ≈ -0.405" }
                    ],
                    finalAnswer: "-4/π² ≈ -0.41",
                    example: { problem: `d/dx[cosx/x] at x = π`, steps: [{ text: "(-sinx·x - cosx)/x²", math: "At π: (0 - (-1))/π² = 1/π²" }]},
                    keyPoints: ["Apply quotient rule first", "Then substitute the value", "Know trig values: sin(π/2)=1, cos(π/2)=0"],
                    mistakes: [{ wrong: "Evaluating before differentiating", why: "Differentiate first, THEN plug in x value" }],
                    guided: {
                        problem: `d/dx[x/cosx] at x = 0`, steps: [{ label: "(cosx·1 - x·(-sinx))/cos²x", value: "" }], answer: "1", answerLabel: "Value:",
                        interactiveSteps: [
                            { prompt: "At x = 0: cos(0) = ?", hint: "Cosine of 0", answer: "1", acceptableAnswers: ["1"], commonMistakes: {}},
                            { prompt: "At x = 0: sin(0) = ?", hint: "Sine of 0", answer: "0", acceptableAnswers: ["0"], commonMistakes: {}},
                            { prompt: "(1·1 - 0·0)/1² = ?", hint: "Simplify", answer: "1", acceptableAnswers: ["1"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `d/dx[x²/x] simplifies to?`, answer: "1", options: ["1", "2x/x²", "x", "2"], mistakeAnalysis: { "2x/x²": "Simplify x²/x = x first, then d/dx[x] = 1" }}
                }
            ]
        }),
        "Implicit Differentiation": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const r = rand(3, 6);
                    return {
                        id: "circle", name: "Circle Equations",
                        goalProblem: `Find dy/dx for x² + y² = ${r*r}`,
                        teachingSteps: [
                            { title: "Implicit Differentiation", explanation: "Use when y isn't solved for. Differentiate both sides, treating y as a function of x.", visual: "d/dx[yⁿ] = n·yⁿ⁻¹ · dy/dx" },
                            { title: "Differentiate", explanation: `d/dx[x² + y²] = d/dx[${r*r}]<br>2x + 2y(dy/dx) = 0`, visual: "2x + 2y(dy/dx) = 0" },
                            { title: "Solve for dy/dx", explanation: "2y(dy/dx) = -2x<br>dy/dx = <strong>-x/y</strong>", visual: "dy/dx = -x/y" }
                        ],
                        finalAnswer: "-x/y",
                        example: { problem: `x² + y² = 25`, steps: [{ text: "Diff. both sides", math: "2x + 2y(dy/dx) = 0 → dy/dx = -x/y" }]},
                        keyPoints: ["d/dx[y²] = 2y(dy/dx)", "Chain rule for y terms", "Solve for dy/dx last"],
                        mistakes: [{ wrong: "d/dx[y²] = 2y", why: "Missing dy/dx! Must include chain rule." }],
                        guided: {
                            problem: `dy/dx for x² + y² = 16?`, steps: [{ label: "Differentiate", value: "2x + 2y(dy/dx) = 0" }], answer: "-x/y", answerLabel: "dy/dx =",
                            interactiveSteps: [
                                { prompt: "d/dx[y²] = ?", hint: "Chain rule", answer: "2y(dy/dx)", acceptableAnswers: ["2y(dy/dx)", "2y·dy/dx", "2y dy/dx"], commonMistakes: { "2y": "Need (dy/dx)!" }},
                                { prompt: "2y(dy/dx) = -2x. So dy/dx = ?", hint: "Divide", answer: "-x/y", acceptableAnswers: ["-x/y", "-(x/y)"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `x² + y² = 49. dy/dx = ?`, answer: "-x/y", options: ["-x/y", "x/y", "-y/x", "-2x"], mistakeAnalysis: { "x/y": "Check signs! -2x means negative" }}
                    };
                })(),
                {
                    id: "product", name: "Product Terms",
                    goalProblem: `Find dy/dx for xy = 10`,
                    teachingSteps: [
                        { title: "Product Rule Needed", explanation: "For xy, use product rule:<br>d/dx[xy] = x·(dy/dx) + y·1", visual: "d/dx[xy] = x(dy/dx) + y" },
                        { title: "Differentiate", explanation: "x(dy/dx) + y = 0<br>(the right side d/dx[10] = 0)", visual: "x(dy/dx) + y = 0" },
                        { title: "Solve", explanation: "x(dy/dx) = -y<br>dy/dx = <strong>-y/x</strong>", visual: "dy/dx = -y/x" }
                    ],
                    finalAnswer: "-y/x",
                    example: { problem: `xy = 5`, steps: [{ text: "Product rule", math: "x(dy/dx) + y = 0 → dy/dx = -y/x" }]},
                    keyPoints: ["Use product rule for xy", "d/dx[y] = dy/dx", "x(dy/dx) term appears"],
                    mistakes: [{ wrong: "d/dx[xy] = y", why: "Need product rule: x(dy/dx) + y" }],
                    guided: {
                        problem: `dy/dx for xy = 8`, steps: [{ label: "Product rule", value: "x(dy/dx) + y = 0" }], answer: "-y/x", answerLabel: "dy/dx =",
                        interactiveSteps: [
                            { prompt: "d/dx[xy] = x·(?) + y·1", hint: "d/dx[y] = ?", answer: "dy/dx", acceptableAnswers: ["dy/dx", "y'"], commonMistakes: {}},
                            { prompt: "x(dy/dx) + y = 0. Solve for dy/dx", hint: "Move y, divide by x", answer: "-y/x", acceptableAnswers: ["-y/x"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `xy = 12. dy/dx = ?`, answer: "-y/x", options: ["-y/x", "y/x", "-x/y", "12/x²"], mistakeAnalysis: { "y/x": "Negative! x(dy/dx) = -y" }}
                },
                {
                    id: "concept", name: "When to Use Implicit Diff",
                    goalProblem: `When should you use implicit differentiation?`,
                    teachingSteps: [
                        { title: "When to Use", explanation: "Use implicit differentiation when:<br>• y is not solved for explicitly<br>• Equation has mixed x and y terms<br>• Can't easily isolate y", visual: "Can't solve for y? Use implicit diff!" },
                        { title: "Examples", explanation: "x² + y² = 25 ← Use implicit<br>y = x² + 3 ← Explicit (just differentiate)", visual: "Mixed terms → implicit" }
                    ],
                    finalAnswer: "When y is not explicitly solved for",
                    example: { problem: `x² + y³ = 8`, steps: [{ text: "y not isolated", math: "Use implicit differentiation" }]},
                    keyPoints: ["y not explicitly solved", "Mixed x,y terms", "Can't easily isolate y"],
                    mistakes: [{ wrong: "Using implicit when y is already isolated", why: "If y = f(x), just differentiate normally" }],
                    guided: {
                        problem: `Which needs implicit diff: y = x² or x²y = 1?`, steps: [{ label: "Check if y isolated", value: "" }], answer: "x²y = 1", answerLabel: "Needs implicit:",
                        interactiveSteps: [
                            { prompt: "Is y isolated in y = x²?", hint: "y = something", answer: "yes", acceptableAnswers: ["yes", "Yes"], commonMistakes: {}},
                            { prompt: "Is y isolated in x²y = 1?", hint: "y is multiplied by x²", answer: "no", acceptableAnswers: ["no", "No"], commonMistakes: {}},
                            { prompt: "Which needs implicit differentiation?", hint: "The one where y isn't isolated", answer: "x²y = 1", acceptableAnswers: ["x²y = 1", "x²y=1", "second"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `Which requires implicit diff?`, answer: "x³ + y³ = 27", options: ["x³ + y³ = 27", "y = 3x", "y = x² + 1", "y = sin(x)"], mistakeAnalysis: { "y = 3x": "y is already isolated here!" }}
                }
            ]
        }),
        "Related Rates": () => ({
            hasSubSkills: true,
            subSkills: [
                (() => {
                    const r = rand(2, 4), rate = rand(2, 4);
                    return {
                        id: "sphere", name: "Sphere Problems",
                        goalProblem: `A sphere's radius grows at ${rate} cm/s. Find dV/dt when r = ${r} cm.`,
                        teachingSteps: [
                            { title: "Formula", explanation: "V = (4/3)πr³<br>Differentiate w.r.t. time:", visual: "dV/dt = 4πr²(dr/dt)" },
                            { title: "Substitute", explanation: `r = ${r}, dr/dt = ${rate}<br>dV/dt = 4π(${r})²(${rate}) = 4π(${r*r})(${rate}) = <strong>${4*r*r*rate}π cm³/s</strong>`, visual: `${4*r*r*rate}π cm³/s` }
                        ],
                        finalAnswer: `${4*r*r*rate}π cm³/s`,
                        example: { problem: `dr/dt = 2, r = 3`, steps: [{ text: "dV/dt = 4πr²(dr/dt)", math: "= 4π(9)(2) = 72π cm³/s" }]},
                        keyPoints: ["V = (4/3)πr³", "dV/dt = 4πr²(dr/dt)", "Chain rule for dr/dt"],
                        mistakes: [{ wrong: "Forgetting dr/dt", why: "Chain rule: d/dt[r³] = 3r²(dr/dt)" }],
                        guided: {
                            problem: `Sphere: dr/dt = 3, r = 2. Find dV/dt`, steps: [{ label: "dV/dt = 4πr²(dr/dt)", value: "" }], answer: "48π cm³/s", answerLabel: "dV/dt =",
                            interactiveSteps: [
                                { prompt: "4π(2)² = 4π × ?", hint: "2² = 4", answer: "4", acceptableAnswers: ["4"], commonMistakes: {}},
                                { prompt: "4π(4)(3) = ?", hint: "4×4×3 = 48", answer: "48π", acceptableAnswers: ["48π", "48pi"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `Sphere: dr/dt = 2, r = 3. dV/dt = ?`, answer: "72π cm³/s", options: ["72π cm³/s", "36π cm³/s", "24π cm³/s", "18π cm³/s"], mistakeAnalysis: { "36π cm³/s": "Check: 4π(9)(2) = 72π" }}
                    };
                })(),
                (() => {
                    const r = rand(3, 6), rate = rand(2, 4);
                    return {
                        id: "circle", name: "Circle Area Problems",
                        goalProblem: `Circle radius grows at ${rate} cm/s. Find dA/dt when r = ${r} cm.`,
                        teachingSteps: [
                            { title: "Formula", explanation: "A = πr²<br>Differentiate: dA/dt = 2πr(dr/dt)", visual: "dA/dt = 2πr(dr/dt)" },
                            { title: "Substitute", explanation: `r = ${r}, dr/dt = ${rate}<br>dA/dt = 2π(${r})(${rate}) = <strong>${2*r*rate}π cm²/s</strong>`, visual: `${2*r*rate}π cm²/s` }
                        ],
                        finalAnswer: `${2*r*rate}π cm²/s`,
                        example: { problem: `dr/dt = 2, r = 5`, steps: [{ text: "dA/dt = 2πr(dr/dt)", math: "= 2π(5)(2) = 20π cm²/s" }]},
                        keyPoints: ["A = πr²", "dA/dt = 2πr(dr/dt)", "Differentiate before substituting"],
                        mistakes: [{ wrong: "dA/dt = 2πr", why: "Missing (dr/dt) from chain rule!" }],
                        guided: {
                            problem: `Circle: dr/dt = 3, r = 4. Find dA/dt`, steps: [{ label: "dA/dt = 2πr(dr/dt)", value: "" }], answer: "24π cm²/s", answerLabel: "dA/dt =",
                            interactiveSteps: [
                                { prompt: "2π(4)(3) = ?", hint: "2×4×3 = 24", answer: "24π", acceptableAnswers: ["24π", "24pi"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `Circle: dr/dt = 2, r = 6. dA/dt = ?`, answer: "24π cm²/s", options: ["24π cm²/s", "12π cm²/s", "36π cm²/s", "6π cm²/s"], mistakeAnalysis: { "12π cm²/s": "2π(6)(2) = 24π, not 12π" }}
                    };
                })(),
                {
                    id: "concept", name: "Related Rates Concept",
                    goalProblem: `In related rates, we differentiate with respect to what variable?`,
                    teachingSteps: [
                        { title: "Key Concept", explanation: "In related rates, all quantities change with <strong>time</strong>.<br><br>We differentiate with respect to <strong>t</strong>.", visual: "Differentiate w.r.t. t" },
                        { title: "The Process", explanation: "1. Write equation relating quantities<br>2. Differentiate both sides w.r.t. t<br>3. Substitute known values<br>4. Solve for unknown rate", visual: "Equation → d/dt → Substitute → Solve" }
                    ],
                    finalAnswer: "time (t)",
                    example: { problem: `Related rates process`, steps: [{ text: "All quantities depend on time", math: "d/dt[...] = ..." }]},
                    keyPoints: ["Differentiate w.r.t. time t", "Use chain rule for dependent variables", "Substitute AFTER differentiating"],
                    mistakes: [{ wrong: "Substituting before differentiating", why: "Differentiate first, then plug in values!" }],
                    guided: {
                        problem: `When do we substitute values?`, steps: [{ label: "Order", value: "Differentiate first" }], answer: "After differentiating", answerLabel: "Substitute:",
                        interactiveSteps: [
                            { prompt: "Do we differentiate or substitute first?", hint: "Variables before numbers", answer: "differentiate", acceptableAnswers: ["differentiate", "diff", "derivative"], commonMistakes: { "substitute": "Differentiate FIRST, then substitute!" }}
                        ]
                    },
                    practice: { problem: `Related rates: differentiate w.r.t.?`, answer: "time (t)", options: ["time (t)", "x", "r", "the rate"], mistakeAnalysis: { "x": "Time is the independent variable in related rates" }}
                }
            ]
        }),
        "U-Substitution": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "identify", name: "Identify u",
                    goalProblem: `∫ 2x·e^(x²) dx. What is u?`,
                    teachingSteps: [
                        { title: "How to Choose u", explanation: "Look for a function whose derivative also appears.<br><br>Here: d/dx[x²] = 2x, and 2x is in the integral!<br>So <strong>u = x²</strong>", visual: "u = inside function whose derivative appears" },
                        { title: "Then du", explanation: "If u = x², then du = 2x dx<br>This matches exactly!", visual: "u = x², du = 2x dx" }
                    ],
                    finalAnswer: "u = x²",
                    example: { problem: `∫cos(x)·sin²(x) dx`, steps: [{ text: "d/dx[sin x] = cos x appears", math: "u = sin(x)" }]},
                    keyPoints: ["u = inner function", "du should appear in integral", "Look for function and its derivative"],
                    mistakes: [{ wrong: "u = e^(x²)", why: "That's the outer function. u should be x² (inside)" }],
                    guided: {
                        problem: `∫ 3x²·(x³+1)⁴ dx. What is u?`, steps: [{ label: "d/dx[x³+1] = 3x²", value: "" }], answer: "u = x³ + 1", answerLabel: "u =",
                        interactiveSteps: [
                            { prompt: "What's inside the parentheses?", hint: "The inner function", answer: "x³ + 1", acceptableAnswers: ["x³ + 1", "x³+1", "x^3+1"], commonMistakes: {}},
                            { prompt: "d/dx[x³+1] = ?", hint: "Power rule", answer: "3x²", acceptableAnswers: ["3x²", "3x^2"], commonMistakes: {}},
                            { prompt: "Does 3x² appear in the integral?", hint: "Yes!", answer: "yes", acceptableAnswers: ["yes", "Yes", "y"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `∫sin(x)·cos³(x) dx. u = ?`, answer: "cos(x)", options: ["cos(x)", "sin(x)", "cos³(x)", "x"], mistakeAnalysis: { "sin(x)": "d/dx[cos x] = -sin x. The -sin x (almost) appears!" }}
                },
                (() => {
                    const n = rand(2, 4);
                    return {
                        id: "solve", name: "Solve with Substitution",
                        goalProblem: `Evaluate ∫ 2x(x² + 1)${['⁰','¹','²','³','⁴'][n]} dx`,
                        teachingSteps: [
                            { title: "Substitute", explanation: `u = x² + 1, du = 2x dx<br>∫ 2x(x²+1)${['⁰','¹','²','³','⁴'][n]} dx = ∫ u${['⁰','¹','²','³','⁴'][n]} du`, visual: `∫ u${['⁰','¹','²','³','⁴'][n]} du` },
                            { title: "Integrate", explanation: `∫ u${['⁰','¹','²','³','⁴'][n]} du = u${['¹','²','³','⁴','⁵'][n]}/${n+1} + C`, visual: `u${['¹','²','³','⁴','⁵'][n]}/${n+1} + C` },
                            { title: "Back-substitute", explanation: `= <strong>(x²+1)${['¹','²','³','⁴','⁵'][n]}/${n+1} + C</strong>`, visual: `(x²+1)${['¹','²','³','⁴','⁵'][n]}/${n+1} + C` }
                        ],
                        finalAnswer: `(x²+1)${['¹','²','³','⁴','⁵'][n]}/${n+1} + C`,
                        example: { problem: `∫ 2x(x²+1)² dx`, steps: [{ text: "u = x²+1", math: "∫u² du = u³/3 + C = (x²+1)³/3 + C" }]},
                        keyPoints: ["Replace ALL x with u", "Integrate in u", "Substitute back to x"],
                        mistakes: [{ wrong: "Forgetting to back-substitute", why: "Answer must be in x, not u!" }],
                        guided: {
                            problem: `∫ 2x(x²+1)³ dx`, steps: [{ label: "u = x²+1", value: "∫u³ du" }], answer: "(x²+1)⁴/4 + C", answerLabel: "∫ =",
                            interactiveSteps: [
                                { prompt: "∫u³ du = ?", hint: "Power rule", answer: "u⁴/4 + C", acceptableAnswers: ["u⁴/4 + C", "u^4/4 + C"], commonMistakes: {}},
                                { prompt: "Back-substitute u = x²+1", hint: "Replace u", answer: "(x²+1)⁴/4 + C", acceptableAnswers: ["(x²+1)⁴/4 + C", "(x²+1)^4/4 + C"], commonMistakes: {}}
                            ]
                        },
                        practice: { problem: `∫ 2x(x²+1)⁵ dx = ?`, answer: "(x²+1)⁶/6 + C", options: ["(x²+1)⁶/6 + C", "(x²+1)⁵/5 + C", "u⁶/6 + C", "2x(x²+1)⁶"], mistakeAnalysis: { "u⁶/6 + C": "Must substitute back to x!" }}
                    };
                })(),
                {
                    id: "reverse", name: "Reverse Substitution",
                    goalProblem: `If ∫f(x)dx = u³/3 + C where u = sin(x), what's the answer in x?`,
                    teachingSteps: [
                        { title: "Back-Substitution", explanation: "After integrating in u, replace u with the original expression in x.", visual: "u = sin(x) → u³/3 = sin³(x)/3" },
                        { title: "Apply", explanation: "u³/3 + C becomes <strong>sin³(x)/3 + C</strong>", visual: "sin³(x)/3 + C" }
                    ],
                    finalAnswer: "sin³(x)/3 + C",
                    example: { problem: `u = x², answer in u: u⁴/4 + C`, steps: [{ text: "Replace u", math: "(x²)⁴/4 = x⁸/4 + C" }]},
                    keyPoints: ["Final answer must be in x", "Replace every u", "Simplify if possible"],
                    mistakes: [{ wrong: "Leaving answer in u", why: "Must convert back to original variable x" }],
                    guided: {
                        problem: `u = cos(x), answer u²/2 + C. Convert to x.`, steps: [{ label: "Replace u", value: "" }], answer: "cos²(x)/2 + C", answerLabel: "In x:",
                        interactiveSteps: [
                            { prompt: "Replace u with cos(x) in u²/2 + C", hint: "u = cos(x)", answer: "cos²(x)/2 + C", acceptableAnswers: ["cos²(x)/2 + C", "cos^2(x)/2 + C"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `u = eˣ, answer ln|u| + C. In x?`, answer: "x + C", options: ["x + C", "ln|eˣ| + C", "eˣ + C", "ln(x) + C"], mistakeAnalysis: { "ln|eˣ| + C": "Simplify! ln(eˣ) = x" }}
                }
            ]
        }),
        "Integration by Parts": () => ({
            hasSubSkills: true,
            subSkills: [
                {
                    id: "formula", name: "Integration by Parts Formula",
                    goalProblem: `What is the integration by parts formula?`,
                    teachingSteps: [
                        { title: "The Formula", explanation: "<strong>∫ u dv = uv - ∫ v du</strong><br><br>You choose u (to differentiate) and dv (to integrate).", visual: "∫ u dv = uv - ∫ v du" },
                        { title: "Memory Trick", explanation: "\"Ultraviolet Voodoo\"<br>uv - ∫v du<br><br>Or: \"u dv = uv minus v du\"", visual: "UV - ∫VDU" }
                    ],
                    finalAnswer: "∫ u dv = uv - ∫ v du",
                    example: { problem: `Parts formula`, steps: [{ text: "∫ u dv = uv - ∫ v du", math: "" }]},
                    keyPoints: ["∫ u dv = uv - ∫ v du", "u = function to differentiate", "dv = function to integrate"],
                    mistakes: [{ wrong: "∫ u dv = uv + ∫ v du", why: "It's MINUS, not plus!" }],
                    guided: {
                        problem: `Complete: ∫ u dv = uv - ?`, steps: [{ label: "Formula", value: "" }], answer: "∫ v du", answerLabel: "∫ u dv = uv -",
                        interactiveSteps: [
                            { prompt: "∫ u dv = uv - ∫ ? du", hint: "v comes from dv", answer: "v", acceptableAnswers: ["v", "∫ v du"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `Integration by parts: ∫ u dv = ?`, answer: "uv - ∫ v du", options: ["uv - ∫ v du", "uv + ∫ v du", "u'v + uv'", "∫ u · ∫ v"], mistakeAnalysis: { "uv + ∫ v du": "Minus, not plus!" }}
                },
                {
                    id: "choose_u", name: "Choosing u (LIATE)",
                    goalProblem: `∫ x·eˣ dx. What should u be?`,
                    teachingSteps: [
                        { title: "LIATE Rule", explanation: "Priority for choosing u:<br><strong>L</strong>ogs > <strong>I</strong>nverse trig > <strong>A</strong>lgebraic > <strong>T</strong>rig > <strong>E</strong>xponential<br><br>Pick u from earlier in the list!", visual: "L-I-A-T-E (earlier = u)" },
                        { title: "Our Problem", explanation: "∫ x·eˣ dx<br>x is Algebraic (A)<br>eˣ is Exponential (E)<br><br>A comes before E, so <strong>u = x</strong>", visual: "u = x (Algebraic)" }
                    ],
                    finalAnswer: "u = x",
                    example: { problem: `∫ ln(x)·x dx`, steps: [{ text: "L comes before A", math: "u = ln(x)" }]},
                    keyPoints: ["LIATE: L-I-A-T-E", "Choose u from earlier in list", "dv gets the rest"],
                    mistakes: [{ wrong: "u = eˣ", why: "LIATE: A (algebraic x) comes before E (exponential). u = x" }],
                    guided: {
                        problem: `∫ x·sin(x) dx. u = ?`, steps: [{ label: "x is A, sin is T", value: "A comes before T" }], answer: "u = x", answerLabel: "u =",
                        interactiveSteps: [
                            { prompt: "In LIATE, does A or T come first?", hint: "L-I-A-T-E", answer: "A", acceptableAnswers: ["A", "Algebraic"], commonMistakes: {}},
                            { prompt: "So u = ?", hint: "The algebraic term", answer: "x", acceptableAnswers: ["x", "u = x"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `∫ ln(x) dx. What is u?`, answer: "ln(x)", options: ["ln(x)", "1", "x", "dx"], mistakeAnalysis: { "1": "Use LIATE! Logs come first, so u = ln(x)" }}
                },
                {
                    id: "apply", name: "Apply Integration by Parts",
                    goalProblem: `Evaluate ∫ x·eˣ dx`,
                    teachingSteps: [
                        { title: "Choose u and dv", explanation: "u = x → du = dx<br>dv = eˣ dx → v = eˣ", visual: "u = x, v = eˣ" },
                        { title: "Apply Formula", explanation: "∫ u dv = uv - ∫ v du<br>= x·eˣ - ∫ eˣ dx<br>= x·eˣ - eˣ + C<br>= <strong>eˣ(x - 1) + C</strong>", visual: "eˣ(x - 1) + C" }
                    ],
                    finalAnswer: "xeˣ - eˣ + C = eˣ(x-1) + C",
                    example: { problem: `∫ x·cos(x) dx`, steps: [{ text: "u=x, v=sin(x)", math: "x·sin(x) - ∫sin(x)dx = x·sin(x) + cos(x) + C" }]},
                    keyPoints: ["Apply formula step by step", "Simplify remaining integral", "Factor if possible"],
                    mistakes: [{ wrong: "Forgetting minus sign", why: "It's uv MINUS ∫v du" }],
                    guided: {
                        problem: `∫ x·cos(x) dx`, steps: [{ label: "u=x, dv=cos(x)dx", value: "v = sin(x)" }], answer: "x·sin(x) + cos(x) + C", answerLabel: "∫ =",
                        interactiveSteps: [
                            { prompt: "uv = x·sin(x). What's ∫v du = ∫sin(x)dx?", hint: "Antiderivative of sin", answer: "-cos(x)", acceptableAnswers: ["-cos(x)", "-cosx"], commonMistakes: { "cos(x)": "∫sin = -cos!" }},
                            { prompt: "x·sin(x) - (-cos(x)) + C = ?", hint: "Minus negative is plus", answer: "x·sin(x) + cos(x) + C", acceptableAnswers: ["x·sin(x) + cos(x) + C", "xsin(x) + cos(x) + C"], commonMistakes: {}}
                        ]
                    },
                    practice: { problem: `∫ x·eˣ dx = ?`, answer: "xeˣ - eˣ + C", options: ["xeˣ - eˣ + C", "xeˣ + eˣ + C", "x²eˣ/2 + C", "eˣ + C"], mistakeAnalysis: { "xeˣ + eˣ + C": "Formula has MINUS: uv - ∫v du" }}
                }
            ]
        })
    },
    10: {
        Matrices: () => ({
            hasSubSkills: true,
            subSkills: [
                // determinant sub-skill
                (() => {
                    const a = rand(1, 4);
                    const b = rand(1, 3);
                    const c = rand(1, 3);
                    const d = rand(1, 4);
                    const det = a * d - b * c;
                    return {
                        id: "determinant",
                        name: "2×2 Determinants",
                        goalProblem: `Find the determinant of [${a} ${b}; ${c} ${d}]`,
                        teachingSteps: [
                            {
                                title: "What is a Determinant?",
                                explanation: "The <strong>determinant</strong> is a special number calculated from a square matrix.<br><br>It tells us if a matrix is <strong>invertible</strong> (det ≠ 0) and measures how the matrix <strong>scales areas/volumes</strong>.",
                                visual: "det(A) = scalar from square matrix"
                            },
                            {
                                title: "2×2 Determinant Formula",
                                explanation: "For matrix [a b; c d]:<br><br><strong>det = ad - bc</strong><br><br>\"Main diagonal minus other diagonal\"<br>Main: top-left to bottom-right (ad)<br>Other: top-right to bottom-left (bc)",
                                visual: "[a b; c d] → det = ad - bc"
                            },
                            {
                                title: "Our Matrix",
                                explanation: `Our matrix is [${a} ${b}; ${c} ${d}]<br><br>a = ${a}, b = ${b}, c = ${c}, d = ${d}`,
                                visual: `[${a} ${b}; ${c} ${d}]`
                            },
                            {
                                title: "Calculate Main Diagonal",
                                explanation: `Main diagonal product: ad = ${a} × ${d} = <strong>${a*d}</strong>`,
                                visual: `ad = ${a*d}`
                            },
                            {
                                title: "Calculate Other Diagonal",
                                explanation: `Other diagonal product: bc = ${b} × ${c} = <strong>${b*c}</strong>`,
                                visual: `bc = ${b*c}`
                            },
                            {
                                title: "Final Answer",
                                explanation: `det = ad - bc = ${a*d} - ${b*c} = <strong>${det}</strong><br><br>${det === 0 ? 'Since det = 0, this matrix is NOT invertible.' : 'Since det ≠ 0, this matrix IS invertible.'}`,
                                visual: `det = ${det}`
                            }
                        ],
                        finalAnswer: String(det),
                        example: { problem: `Find det of [3 1; 2 4]`, steps: [
                            { text: "Identify values", math: "a=3, b=1, c=2, d=4" },
                            { text: "Apply formula", math: "det = (3)(4) - (1)(2)" },
                            { text: "Calculate", math: "<strong>det = 12 - 2 = 10</strong>" }
                        ]},
                        keyPoints: [
                            "2×2 determinant: det = ad - bc",
                            "det ≠ 0 means matrix is invertible",
                            "det = 0 means matrix is singular (not invertible)"
                        ],
                        mistakes: [
                            { wrong: "Using ad + bc instead of ad - bc", why: "It's SUBTRACTION: main diagonal minus other diagonal." },
                            { wrong: "Mixing up diagonals", why: "Main diagonal: top-left to bottom-right (ad). Other: top-right to bottom-left (bc)." }
                        ],
                        guided: (() => {
                            const m = [[rand(1, 4), rand(1, 3)], [rand(1, 3), rand(1, 4)]];
                            const result = m[0][0] * m[1][1] - m[0][1] * m[1][0];
                            return {
                                problem: `Find the determinant of [${m[0][0]} ${m[0][1]}; ${m[1][0]} ${m[1][1]}]`,
                                steps: [
                                    { label: "Formula", value: "det = ad - bc" }
                                ],
                                answer: String(result),
                                answerLabel: "Determinant =",
                                interactiveSteps: [
                                    {
                                        prompt: `What is the determinant formula for a 2×2 matrix?`,
                                        hint: "Main diagonal minus other diagonal...",
                                        answer: "ad - bc",
                                        acceptableAnswers: ["ad - bc", "ad-bc", "a*d - b*c"],
                                        commonMistakes: {
                                            "ad + bc": "It's SUBTRACTION, not addition! det = ad - bc"
                                        }
                                    },
                                    {
                                        prompt: `Calculate ad: ${m[0][0]} × ${m[1][1]} = ?`,
                                        hint: "Main diagonal product...",
                                        answer: String(m[0][0] * m[1][1]),
                                        acceptableAnswers: [String(m[0][0] * m[1][1])],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Calculate bc: ${m[0][1]} × ${m[1][0]} = ?`,
                                        hint: "Other diagonal product...",
                                        answer: String(m[0][1] * m[1][0]),
                                        acceptableAnswers: [String(m[0][1] * m[1][0])],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `det = ${m[0][0] * m[1][1]} - ${m[0][1] * m[1][0]} = ?`,
                                        hint: "Subtract...",
                                        answer: String(result),
                                        acceptableAnswers: [String(result)],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `If det(A) = 0, what does this tell us about matrix A?`, answer: "A is not invertible",
                            options: ["A is not invertible", "A is the identity", "A has all zeros", "A is symmetric"],
                            mistakeAnalysis: {
                                "A is the identity": "Identity matrix has det = 1, not 0.",
                                "A has all zeros": "Many non-zero matrices also have det = 0.",
                                "A is symmetric": "Symmetry is unrelated to determinant value."
                            }}
                    };
                })(),
                // multiply_size sub-skill
                (() => {
                    const m1rows = 2, m1cols = 3, m2rows = 3, m2cols = 2;
                    return {
                        id: "multiply_size",
                        name: "Matrix Multiplication Dimensions",
                        goalProblem: `If A is ${m1rows}×${m1cols} and B is ${m2rows}×${m2cols}, what is the size of AB?`,
                        teachingSteps: [
                            {
                                title: "Matrix Multiplication Rule",
                                explanation: "To multiply matrices A × B:<br><br><strong>Columns of A MUST equal Rows of B</strong><br><br>If A is m×n and B is n×p, then AB is <strong>m×p</strong>",
                                visual: "(m×n) × (n×p) = m×p"
                            },
                            {
                                title: "Check Compatibility",
                                explanation: `A is ${m1rows}×${m1cols} and B is ${m2rows}×${m2cols}<br><br>Columns of A = ${m1cols}<br>Rows of B = ${m2rows}<br><br>${m1cols === m2rows ? '✓ They match! Multiplication is possible.' : '✗ They don\'t match! Cannot multiply.'}`,
                                visual: `${m1cols} = ${m2rows} ✓`
                            },
                            {
                                title: "Result Size",
                                explanation: `AB will have:<br><br>• Rows from A: <strong>${m1rows}</strong><br>• Columns from B: <strong>${m2cols}</strong><br><br>Result: AB is <strong>${m1rows}×${m2cols}</strong>`,
                                visual: `AB is ${m1rows}×${m2cols}`
                            },
                            {
                                title: "Memory Trick",
                                explanation: "Think: (m×<s>n</s>) × (<s>n</s>×p) = m×p<br><br>The \"inner\" dimensions must match and cancel out.<br>The \"outer\" dimensions give the result size.",
                                visual: "Outer dimensions = result size"
                            }
                        ],
                        finalAnswer: `${m1rows}×${m2cols}`,
                        example: { problem: `(3×4) × (4×2) = ?`, steps: [
                            { text: "Check inner dimensions", math: "4 = 4 ✓ (compatible)" },
                            { text: "Outer dimensions", math: "3 and 2" },
                            { text: "Result size", math: "<strong>3×2</strong>" }
                        ]},
                        keyPoints: [
                            "Columns of A must equal rows of B",
                            "Result is (rows of A) × (columns of B)",
                            "Order matters: AB ≠ BA in general"
                        ],
                        mistakes: [
                            { wrong: "Multiplying incompatible matrices", why: "Always check: columns of A = rows of B?" },
                            { wrong: "Wrong result dimensions", why: "Result uses OUTER dimensions: rows of A × columns of B" }
                        ],
                        guided: (() => {
                            const r1 = rand(2, 4), c1 = rand(2, 4), c2 = rand(2, 4);
                            return {
                                problem: `If A is ${r1}×${c1} and B is ${c1}×${c2}, what size is AB?`,
                                steps: [
                                    { label: "Check compatibility", value: `Cols of A (${c1}) = Rows of B (${c1}) ✓` }
                                ],
                                answer: `${r1}×${c2}`,
                                answerLabel: "Size of AB:",
                                interactiveSteps: [
                                    {
                                        prompt: `For matrix multiplication, what must be equal?`,
                                        hint: "Something from A must match something from B...",
                                        answer: "columns of A and rows of B",
                                        acceptableAnswers: ["columns of A and rows of B", "cols of A = rows of B", "inner dimensions"],
                                        commonMistakes: {
                                            "rows": "No, COLUMNS of A must equal ROWS of B."
                                        }
                                    },
                                    {
                                        prompt: `A is ${r1}×${c1}. How many columns does A have?`,
                                        hint: "The second number in dimensions...",
                                        answer: String(c1),
                                        acceptableAnswers: [String(c1)],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `B is ${c1}×${c2}. How many rows does B have?`,
                                        hint: "The first number in dimensions...",
                                        answer: String(c1),
                                        acceptableAnswers: [String(c1)],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `AB has rows from A (${r1}) and columns from B (${c2}). What is the size of AB?`,
                                        hint: "rows × columns...",
                                        answer: `${r1}×${c2}`,
                                        acceptableAnswers: [`${r1}×${c2}`, `${r1}x${c2}`, `${r1} × ${c2}`, `${r1} x ${c2}`],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `Can you multiply a 2×3 matrix by a 4×2 matrix?`, answer: "No",
                            options: ["No", "Yes, result is 2×2", "Yes, result is 2×4", "Yes, result is 3×4"],
                            mistakeAnalysis: {
                                "Yes, result is 2×2": "Cols of first (3) ≠ Rows of second (4). Cannot multiply!",
                                "Yes, result is 2×4": "Cols of first (3) ≠ Rows of second (4). Cannot multiply!",
                                "Yes, result is 3×4": "Cols of first (3) ≠ Rows of second (4). Cannot multiply!"
                            }}
                    };
                })()
            ]
        }),
        Series: () => ({
            hasSubSkills: true,
            subSkills: [
                // geometric sub-skill
                (() => {
                    const a = rand(2, 4);
                    const r = rand(2, 3);
                    const n = 4;
                    const sum = a * (1 - Math.pow(r, n)) / (1 - r);
                    return {
                        id: "geometric",
                        name: "Geometric Series",
                        goalProblem: `Find the sum: ${a} + ${a*r} + ${a*r*r} + ${a*r*r*r}`,
                        teachingSteps: [
                            {
                                title: "What is a Geometric Series?",
                                explanation: "A <strong>geometric series</strong> has a constant <strong>ratio</strong> between consecutive terms.<br><br>Each term = previous term × r<br><br>Example: 2, 6, 18, 54 (multiplying by 3 each time)",
                                visual: "Geometric: ×r each time"
                            },
                            {
                                title: "Geometric Series Formula",
                                explanation: "For n terms with first term a and ratio r:<br><br><strong>Sum = a(1 - rⁿ)/(1 - r)</strong><br><br>Or equivalently: a(rⁿ - 1)/(r - 1)",
                                visual: "Sum = a(1 - rⁿ)/(1 - r)"
                            },
                            {
                                title: "Identify Our Values",
                                explanation: `Series: ${a} + ${a*r} + ${a*r*r} + ${a*r*r*r}<br><br>• First term (a) = ${a}<br>• Ratio (r) = ${a*r}/${a} = ${r}<br>• Number of terms (n) = ${n}`,
                                visual: `a = ${a}, r = ${r}, n = ${n}`
                            },
                            {
                                title: "Apply the Formula",
                                explanation: `Sum = ${a}(1 - ${r}⁴)/(1 - ${r})<br><br>= ${a}(1 - ${Math.pow(r, n)})/(${1-r})<br>= ${a}(${1 - Math.pow(r, n)})/(${1-r})`,
                                visual: `Sum = ${a} × ${1 - Math.pow(r, n)} / ${1-r}`
                            },
                            {
                                title: "Calculate",
                                explanation: `Sum = ${a} × ${Math.abs(1 - Math.pow(r, n))} / ${Math.abs(1-r)}<br><br>= <strong>${sum}</strong>`,
                                visual: `Sum = ${sum}`
                            }
                        ],
                        finalAnswer: String(sum),
                        example: { problem: `Find sum: 3 + 6 + 12 + 24`, steps: [
                            { text: "Identify values", math: "a = 3, r = 2, n = 4" },
                            { text: "Apply formula", math: "Sum = 3(1 - 2⁴)/(1 - 2)" },
                            { text: "Calculate", math: "= 3(-15)/(-1) = <strong>45</strong>" }
                        ]},
                        keyPoints: [
                            "Geometric: constant ratio between terms",
                            "Sum = a(1 - rⁿ)/(1 - r)",
                            "Find r by dividing any term by previous term"
                        ],
                        mistakes: [
                            { wrong: "Using arithmetic formula", why: "Geometric has constant RATIO, not difference. Use Sum = a(1-rⁿ)/(1-r)." },
                            { wrong: "Wrong value of r", why: "r = (any term)/(previous term). Check division!" }
                        ],
                        guided: (() => {
                            const ga = rand(2, 3);
                            const gr = 2;
                            const gsum = ga * (1 - Math.pow(gr, 4)) / (1 - gr);
                            return {
                                problem: `Find the sum: ${ga} + ${ga*gr} + ${ga*gr*gr} + ${ga*gr*gr*gr}`,
                                steps: [
                                    { label: "First term (a)", value: String(ga) },
                                    { label: "Ratio (r)", value: String(gr) }
                                ],
                                answer: String(gsum),
                                answerLabel: "Sum =",
                                interactiveSteps: [
                                    {
                                        prompt: `What is the first term (a)?`,
                                        hint: "The series starts with...",
                                        answer: String(ga),
                                        acceptableAnswers: [String(ga)],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `What is the ratio (r)? Hint: ${ga*gr} ÷ ${ga} = ?`,
                                        hint: "Divide second term by first...",
                                        answer: String(gr),
                                        acceptableAnswers: [String(gr)],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `How many terms are there?`,
                                        hint: "Count them...",
                                        answer: "4",
                                        acceptableAnswers: ["4", "four"],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Using Sum = a(1-rⁿ)/(1-r) = ${ga}(1-2⁴)/(1-2) = ${ga}(-15)/(-1) = ?`,
                                        hint: "Simplify...",
                                        answer: String(gsum),
                                        acceptableAnswers: [String(gsum)],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `In a geometric series, what is constant between terms?`, answer: "The ratio",
                            options: ["The ratio", "The difference", "The sum", "The product"],
                            mistakeAnalysis: {
                                "The difference": "That's arithmetic series. Geometric has constant RATIO.",
                                "The sum": "The ratio between consecutive terms is constant.",
                                "The product": "The ratio (division) is constant, not product."
                            }}
                    };
                })(),
                // convergence sub-skill
                {
                    id: "convergence",
                    name: "Series Convergence",
                    goalProblem: `Does the series 1 + 1/2 + 1/4 + 1/8 + ... converge? If so, to what value?`,
                    teachingSteps: [
                        {
                            title: "Infinite Series",
                            explanation: "An <strong>infinite series</strong> adds infinitely many terms.<br><br>Key question: Does the sum approach a finite value (<strong>converge</strong>) or grow without bound (<strong>diverge</strong>)?",
                            visual: "Converge = finite sum | Diverge = infinite"
                        },
                        {
                            title: "Geometric Series Convergence",
                            explanation: "For infinite geometric series with ratio r:<br><br>• <strong>|r| < 1</strong>: Series CONVERGES<br>• <strong>|r| ≥ 1</strong>: Series DIVERGES<br><br>If converges: Sum = a/(1-r)",
                            visual: "|r| < 1 → converges to a/(1-r)"
                        },
                        {
                            title: "Our Series",
                            explanation: `1 + 1/2 + 1/4 + 1/8 + ...<br><br>• First term (a) = 1<br>• Ratio (r) = 1/2 = 0.5<br>• |r| = 0.5 < 1 ✓`,
                            visual: "a = 1, r = 1/2"
                        },
                        {
                            title: "Check Convergence",
                            explanation: `Since |r| = 0.5 < 1, the series <strong>CONVERGES</strong>!<br><br>We can find the exact sum.`,
                            visual: "|0.5| < 1 → Converges!"
                        },
                        {
                            title: "Find the Sum",
                            explanation: `Sum = a/(1-r) = 1/(1-0.5) = 1/0.5 = <strong>2</strong><br><br>The infinite sum approaches 2!`,
                            visual: "Sum = 1/(1-0.5) = 2"
                        }
                    ],
                    finalAnswer: "Yes, converges to 2",
                    example: { problem: `Does 3 + 3/4 + 3/16 + ... converge?`, steps: [
                        { text: "Find ratio", math: "r = (3/4)/3 = 1/4" },
                        { text: "Check |r|", math: "|1/4| = 0.25 < 1 ✓" },
                        { text: "Sum = a/(1-r)", math: "= 3/(1-0.25) = 3/0.75 = <strong>4</strong>" }
                    ]},
                    keyPoints: [
                        "|r| < 1: geometric series converges",
                        "|r| ≥ 1: geometric series diverges",
                        "Convergent sum = a/(1-r)"
                    ],
                    mistakes: [
                        { wrong: "Forgetting absolute value", why: "Use |r|. Even r = -0.5 gives |r| = 0.5 < 1, so it converges." },
                        { wrong: "Using finite formula for infinite series", why: "For infinite: Sum = a/(1-r), not a(1-rⁿ)/(1-r)" }
                    ],
                    guided: {
                        problem: `Does 5 + 5/3 + 5/9 + 5/27 + ... converge? Find the sum if it does.`,
                        steps: [
                            { label: "First term", value: "a = 5" },
                            { label: "Ratio", value: "r = (5/3)/5 = 1/3" }
                        ],
                        answer: "7.5",
                        answerLabel: "Sum =",
                        interactiveSteps: [
                            {
                                prompt: `What is the ratio r? (5/3) ÷ 5 = ?`,
                                hint: "(5/3)/5 = 5/3 × 1/5 = ...",
                                answer: "1/3",
                                acceptableAnswers: ["1/3", "0.333", "0.33"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Is |1/3| < 1?`,
                                hint: "1/3 ≈ 0.333...",
                                answer: "yes",
                                acceptableAnswers: ["yes", "y", "true"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `So does this series converge or diverge?`,
                                hint: "|r| < 1 means...",
                                answer: "converge",
                                acceptableAnswers: ["converge", "converges", "it converges"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Sum = a/(1-r) = 5/(1-1/3) = 5/(2/3) = ?`,
                                hint: "5 ÷ (2/3) = 5 × (3/2) = ...",
                                answer: "7.5",
                                acceptableAnswers: ["7.5", "15/2"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `For |r| = 1.5, does the geometric series converge?`, answer: "No, it diverges",
                        options: ["No, it diverges", "Yes, to a/(1-r)", "Yes, to 0", "Depends on a"],
                        mistakeAnalysis: {
                            "Yes, to a/(1-r)": "|r| = 1.5 > 1, so series diverges! Formula only works when |r| < 1.",
                            "Yes, to 0": "|r| > 1 means terms grow, not shrink. Series diverges.",
                            "Depends on a": "|r| ≥ 1 always diverges, regardless of a."
                        }}
                }
            ]
        }),
        "Partial Derivatives": () => ({
            hasSubSkills: true,
            subSkills: [
                // partial_x sub-skill
                (() => {
                    const a = rand(2, 5);
                    const b = rand(2, 4);
                    return {
                        id: "partial_x",
                        name: "Partial Derivative ∂/∂x",
                        goalProblem: `Find ∂/∂x of f(x,y) = ${a}x²y + ${b}xy²`,
                        teachingSteps: [
                            {
                                title: "What is ∂/∂x?",
                                explanation: "The partial derivative <strong>∂/∂x</strong> means: differentiate with respect to x, <strong>treating all other variables as constants</strong>.<br><br>Think of y as just a number like 5!",
                                visual: "∂/∂x: treat y as constant"
                            },
                            {
                                title: "Our Function",
                                explanation: `f(x,y) = ${a}x²y + ${b}xy²<br><br>For ∂/∂x, treat y (and y²) as constants.`,
                                visual: `f = ${a}x²y + ${b}xy²`
                            },
                            {
                                title: "First Term: ${a}x²y",
                                explanation: `∂/∂x(${a}x²y) = ${a}y · ∂/∂x(x²)<br>= ${a}y · 2x<br>= <strong>${a*2}xy</strong>`,
                                visual: `∂/∂x(${a}x²y) = ${a*2}xy`
                            },
                            {
                                title: "Second Term: ${b}xy²",
                                explanation: `∂/∂x(${b}xy²) = ${b}y² · ∂/∂x(x)<br>= ${b}y² · 1<br>= <strong>${b}y²</strong>`,
                                visual: `∂/∂x(${b}xy²) = ${b}y²`
                            },
                            {
                                title: "Final Answer",
                                explanation: `∂f/∂x = ${a*2}xy + ${b}y²`,
                                visual: `∂f/∂x = ${a*2}xy + ${b}y²`
                            }
                        ],
                        finalAnswer: `${a*2}xy + ${b}y²`,
                        example: { problem: `Find ∂/∂x of 3x²y + 2xy²`, steps: [
                            { text: "First term", math: "∂/∂x(3x²y) = 3y · 2x = 6xy" },
                            { text: "Second term", math: "∂/∂x(2xy²) = 2y² · 1 = 2y²" },
                            { text: "Combine", math: "<strong>∂f/∂x = 6xy + 2y²</strong>" }
                        ]},
                        keyPoints: [
                            "∂/∂x: treat y as constant",
                            "Apply power rule to x terms only",
                            "Keep y factors as coefficients"
                        ],
                        mistakes: [
                            { wrong: "Differentiating y as well", why: "For ∂/∂x, y is a CONSTANT. Only differentiate x." },
                            { wrong: "Dropping y factors", why: "Keep y! ∂/∂x(${a}x²y) = ${a*2}xy, not ${a*2}x" }
                        ],
                        guided: (() => {
                            const c1 = rand(2, 4);
                            const c2 = rand(2, 3);
                            return {
                                problem: `Find ∂/∂x of f(x,y) = ${c1}x³y + ${c2}xy`,
                                steps: [
                                    { label: "First term", value: `∂/∂x(${c1}x³y) = ${c1*3}x²y` }
                                ],
                                answer: `${c1*3}x²y + ${c2}y`,
                                answerLabel: "∂f/∂x =",
                                interactiveSteps: [
                                    {
                                        prompt: `When finding ∂/∂x, what do we treat as constant?`,
                                        hint: "The other variable...",
                                        answer: "y",
                                        acceptableAnswers: ["y", "y values"],
                                        commonMistakes: {
                                            "x": "No! We're differentiating WITH RESPECT TO x. Treat y as constant."
                                        }
                                    },
                                    {
                                        prompt: `Find ∂/∂x of ${c1}x³y (using power rule on x³)`,
                                        hint: "Power rule: 3x² times the constant ${c1}y...",
                                        answer: `${c1*3}x²y`,
                                        acceptableAnswers: [`${c1*3}x²y`, `${c1*3}x^2y`],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Find ∂/∂x of ${c2}xy (x becomes 1)`,
                                        hint: "${c2}y times derivative of x...",
                                        answer: `${c2}y`,
                                        acceptableAnswers: [`${c2}y`],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `Find ∂/∂x of f(x,y) = 5xy + 3x²`, answer: "5y + 6x",
                            options: ["5y + 6x", "5x + 6x", "5 + 6x", "5xy + 6x"],
                            mistakeAnalysis: {
                                "5x + 6x": "For ∂/∂x(5xy), y is constant, so it's 5y, not 5x",
                                "5 + 6x": "Keep the y! ∂/∂x(5xy) = 5y",
                                "5xy + 6x": "You need to differentiate x terms!"
                            }}
                    };
                })(),
                // partial_y sub-skill
                (() => {
                    const a = rand(2, 4);
                    const b = rand(2, 3);
                    return {
                        id: "partial_y",
                        name: "Partial Derivative ∂/∂y",
                        goalProblem: `Find ∂/∂y of f(x,y) = ${a}x²y + ${b}xy³`,
                        teachingSteps: [
                            {
                                title: "What is ∂/∂y?",
                                explanation: "The partial derivative <strong>∂/∂y</strong> means: differentiate with respect to y, <strong>treating x as constant</strong>.<br><br>Think of x as just a number like 3!",
                                visual: "∂/∂y: treat x as constant"
                            },
                            {
                                title: "Our Function",
                                explanation: `f(x,y) = ${a}x²y + ${b}xy³<br><br>For ∂/∂y, treat x (and x²) as constants.`,
                                visual: `f = ${a}x²y + ${b}xy³`
                            },
                            {
                                title: "First Term: ${a}x²y",
                                explanation: `∂/∂y(${a}x²y) = ${a}x² · ∂/∂y(y)<br>= ${a}x² · 1<br>= <strong>${a}x²</strong>`,
                                visual: `∂/∂y(${a}x²y) = ${a}x²`
                            },
                            {
                                title: "Second Term: ${b}xy³",
                                explanation: `∂/∂y(${b}xy³) = ${b}x · ∂/∂y(y³)<br>= ${b}x · 3y²<br>= <strong>${b*3}xy²</strong>`,
                                visual: `∂/∂y(${b}xy³) = ${b*3}xy²`
                            },
                            {
                                title: "Final Answer",
                                explanation: `∂f/∂y = ${a}x² + ${b*3}xy²`,
                                visual: `∂f/∂y = ${a}x² + ${b*3}xy²`
                            }
                        ],
                        finalAnswer: `${a}x² + ${b*3}xy²`,
                        example: { problem: `Find ∂/∂y of 3x²y + 2xy²`, steps: [
                            { text: "First term", math: "∂/∂y(3x²y) = 3x² · 1 = 3x²" },
                            { text: "Second term", math: "∂/∂y(2xy²) = 2x · 2y = 4xy" },
                            { text: "Combine", math: "<strong>∂f/∂y = 3x² + 4xy</strong>" }
                        ]},
                        keyPoints: [
                            "∂/∂y: treat x as constant",
                            "Apply power rule to y terms only",
                            "Keep x factors as coefficients"
                        ],
                        mistakes: [
                            { wrong: "Differentiating x as well", why: "For ∂/∂y, x is a CONSTANT. Only differentiate y." },
                            { wrong: "Confusing with ∂/∂x", why: "∂/∂y treats x as constant. ∂/∂x treats y as constant." }
                        ],
                        guided: (() => {
                            const c1 = rand(2, 4);
                            const c2 = rand(2, 3);
                            return {
                                problem: `Find ∂/∂y of f(x,y) = ${c1}xy + ${c2}xy²`,
                                steps: [
                                    { label: "First term", value: `∂/∂y(${c1}xy) = ${c1}x` }
                                ],
                                answer: `${c1}x + ${c2*2}xy`,
                                answerLabel: "∂f/∂y =",
                                interactiveSteps: [
                                    {
                                        prompt: `Find ∂/∂y of ${c1}xy (x is constant)`,
                                        hint: "${c1}x times derivative of y...",
                                        answer: `${c1}x`,
                                        acceptableAnswers: [`${c1}x`],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Find ∂/∂y of ${c2}xy² (power rule on y²)`,
                                        hint: "${c2}x times 2y...",
                                        answer: `${c2*2}xy`,
                                        acceptableAnswers: [`${c2*2}xy`],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Combine: ∂f/∂y = ${c1}x + ?`,
                                        hint: "Add the second result...",
                                        answer: `${c2*2}xy`,
                                        acceptableAnswers: [`${c2*2}xy`],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `Find ∂/∂y of f(x,y) = x²y² + 3y`, answer: "2x²y + 3",
                            options: ["2x²y + 3", "2xy² + 3", "x²y² + 3", "2x²y"],
                            mistakeAnalysis: {
                                "2xy² + 3": "That's ∂/∂x of x²y². For ∂/∂y, x² is constant: 2x²y",
                                "x²y² + 3": "You need to differentiate! ∂/∂y(x²y²) = x² · 2y = 2x²y",
                                "2x²y": "Don't forget ∂/∂y(3y) = 3!"
                            }}
                    };
                })()
            ]
        }),
        "Discrete Math": () => ({
            hasSubSkills: true,
            subSkills: [
                // subsets sub-skill
                (() => {
                    const n = rand(3, 5);
                    const numSubsets = Math.pow(2, n);
                    return {
                        id: "subsets",
                        name: "Counting Subsets",
                        goalProblem: `How many subsets does a set with ${n} elements have?`,
                        teachingSteps: [
                            {
                                title: "What is a Subset?",
                                explanation: "A <strong>subset</strong> is any collection of elements from a set (including the empty set and the set itself).<br><br>For set {a, b}, subsets are: {}, {a}, {b}, {a,b}",
                                visual: "Subset = any selection from a set"
                            },
                            {
                                title: "Counting Subsets Formula",
                                explanation: "A set with <strong>n elements</strong> has exactly <strong>2ⁿ subsets</strong>.<br><br>Why? Each element has 2 choices: include it or not!",
                                visual: "n elements → 2ⁿ subsets"
                            },
                            {
                                title: "Our Problem",
                                explanation: `Set has ${n} elements.<br><br>Number of subsets = 2^${n} = <strong>${numSubsets}</strong>`,
                                visual: `2^${n} = ${numSubsets} subsets`
                            },
                            {
                                title: "Verification",
                                explanation: `Each of the ${n} elements can be IN or OUT of a subset.<br><br>2 × 2 × ... (${n} times) = 2^${n} = ${numSubsets}`,
                                visual: `2^${n} = ${numSubsets}`
                            }
                        ],
                        finalAnswer: String(numSubsets),
                        example: { problem: `Subsets of {a, b, c}?`, steps: [
                            { text: "n = 3 elements", math: "Number = 2³" },
                            { text: "Calculate", math: "2³ = <strong>8 subsets</strong>" },
                            { text: "They are", math: "{}, {a}, {b}, {c}, {a,b}, {a,c}, {b,c}, {a,b,c}" }
                        ]},
                        keyPoints: [
                            "n elements → 2ⁿ subsets",
                            "Empty set {} is always a subset",
                            "The set itself is always a subset"
                        ],
                        mistakes: [
                            { wrong: "Forgetting the empty set", why: "The empty set {} is a valid subset of every set!" },
                            { wrong: "Using n! instead of 2ⁿ", why: "n! counts arrangements. 2ⁿ counts subsets (include/exclude each element)." }
                        ],
                        guided: (() => {
                            const gn = rand(3, 4);
                            return {
                                problem: `How many subsets does a set with ${gn} elements have?`,
                                steps: [
                                    { label: "Formula", value: "2ⁿ subsets" }
                                ],
                                answer: String(Math.pow(2, gn)),
                                answerLabel: "Number of subsets:",
                                interactiveSteps: [
                                    {
                                        prompt: `What formula gives the number of subsets of a set with n elements?`,
                                        hint: "Each element: in or out...",
                                        answer: "2^n",
                                        acceptableAnswers: ["2^n", "2ⁿ", "2 to the n"],
                                        commonMistakes: {
                                            "n!": "n! counts arrangements. For subsets, use 2ⁿ."
                                        }
                                    },
                                    {
                                        prompt: `Calculate 2^${gn} = ?`,
                                        hint: "2 × 2 × ... (${gn} times)...",
                                        answer: String(Math.pow(2, gn)),
                                        acceptableAnswers: [String(Math.pow(2, gn))],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `A set with 4 elements has how many subsets?`, answer: "16",
                            options: ["16", "4", "8", "24"],
                            mistakeAnalysis: {
                                "4": "That's n itself. Number of subsets = 2ⁿ = 2⁴ = 16",
                                "8": "That's 2³. For 4 elements: 2⁴ = 16",
                                "24": "That's 4!. For subsets use 2ⁿ = 2⁴ = 16"
                            }}
                    };
                })(),
                // pigeonhole sub-skill
                (() => {
                    const pigeons = rand(11, 15);
                    const holes = 10;
                    const minInOne = Math.ceil(pigeons / holes);
                    return {
                        id: "pigeonhole",
                        name: "Pigeonhole Principle",
                        goalProblem: `If ${pigeons} pigeons fly into ${holes} pigeonholes, at least how many must be in one hole?`,
                        teachingSteps: [
                            {
                                title: "The Pigeonhole Principle",
                                explanation: "If <strong>n items</strong> go into <strong>k containers</strong> and n > k, then at least one container has <strong>more than one item</strong>.<br><br>More generally: at least one container has ⌈n/k⌉ items.",
                                visual: "n items, k boxes → at least ⌈n/k⌉ in one box"
                            },
                            {
                                title: "The Formula",
                                explanation: "Minimum in one container = <strong>⌈n/k⌉</strong><br><br>⌈ ⌉ means \"ceiling\" - round UP to nearest integer.",
                                visual: "⌈n/k⌉ = ceiling of n÷k"
                            },
                            {
                                title: "Our Problem",
                                explanation: `${pigeons} pigeons, ${holes} holes<br><br>⌈${pigeons}/${holes}⌉ = ⌈${pigeons/holes}⌉ = <strong>${minInOne}</strong>`,
                                visual: `⌈${pigeons}/${holes}⌉ = ${minInOne}`
                            },
                            {
                                title: "Why This Works",
                                explanation: `If each hole had only ${minInOne - 1} pigeons, we could fit at most ${(minInOne-1) * holes} pigeons.<br><br>But we have ${pigeons} > ${(minInOne-1) * holes}, so at least one hole needs ${minInOne}!`,
                                visual: `${minInOne} pigeons guaranteed in one hole`
                            }
                        ],
                        finalAnswer: String(minInOne),
                        example: { problem: `13 socks into 4 drawers`, steps: [
                            { text: "Apply formula", math: "⌈13/4⌉ = ⌈3.25⌉" },
                            { text: "Ceiling rounds up", math: "<strong>4 socks</strong> in at least one drawer" }
                        ]},
                        keyPoints: [
                            "Pigeonhole: ⌈n/k⌉ items in at least one container",
                            "⌈x⌉ = ceiling = round up",
                            "Powerful for existence proofs"
                        ],
                        mistakes: [
                            { wrong: "Using floor instead of ceiling", why: "Use CEILING (round up). Floor would undercount." },
                            { wrong: "Dividing in wrong order", why: "It's items ÷ containers, not containers ÷ items." }
                        ],
                        guided: (() => {
                            const gp = rand(10, 13);
                            const gh = 4;
                            const gmin = Math.ceil(gp / gh);
                            return {
                                problem: `${gp} books on ${gh} shelves. At least how many on one shelf?`,
                                steps: [
                                    { label: "Formula", value: "⌈books/shelves⌉" }
                                ],
                                answer: String(gmin),
                                answerLabel: "Minimum on one shelf:",
                                interactiveSteps: [
                                    {
                                        prompt: `Calculate ${gp} ÷ ${gh} = ?`,
                                        hint: "Divide...",
                                        answer: String(gp / gh),
                                        acceptableAnswers: [String(gp / gh), (gp / gh).toFixed(2)],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Now round UP to get the ceiling: ⌈${gp / gh}⌉ = ?`,
                                        hint: "Round up to nearest integer...",
                                        answer: String(gmin),
                                        acceptableAnswers: [String(gmin)],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `25 students, 7 days of week. At least how many share a birthday weekday?`, answer: "4",
                            options: ["4", "3", "7", "25"],
                            mistakeAnalysis: {
                                "3": "⌈25/7⌉ = ⌈3.57⌉ = 4 (round UP, not down)",
                                "7": "That's the number of weekdays. Answer is ⌈25/7⌉ = 4",
                                "25": "That's total students. At least ⌈25/7⌉ = 4 share a day."
                            }}
                    };
                })()
            ]
        }),
        "Multivariable Calculus": () => ({
            hasSubSkills: true,
            subSkills: [
                // gradient sub-skill
                (() => {
                    const a = rand(2, 4);
                    const b = rand(2, 3);
                    return {
                        id: "gradient",
                        name: "Gradient Vector",
                        goalProblem: `Find ∇f for f(x,y) = ${a}x² + ${b}y²`,
                        teachingSteps: [
                            {
                                title: "What is the Gradient?",
                                explanation: "The <strong>gradient</strong> ∇f is a vector of all partial derivatives:<br><br>∇f = ⟨∂f/∂x, ∂f/∂y⟩<br><br>It points toward <strong>steepest increase</strong>!",
                                visual: "∇f = ⟨∂f/∂x, ∂f/∂y⟩"
                            },
                            {
                                title: "Find ∂f/∂x",
                                explanation: `∂/∂x(${a}x² + ${b}y²) = ${a*2}x + 0 = <strong>${a*2}x</strong>`,
                                visual: `∂f/∂x = ${a*2}x`
                            },
                            {
                                title: "Find ∂f/∂y",
                                explanation: `∂/∂y(${a}x² + ${b}y²) = 0 + ${b*2}y = <strong>${b*2}y</strong>`,
                                visual: `∂f/∂y = ${b*2}y`
                            },
                            {
                                title: "Form the Gradient",
                                explanation: `∇f = ⟨${a*2}x, ${b*2}y⟩`,
                                visual: `∇f = ⟨${a*2}x, ${b*2}y⟩`
                            }
                        ],
                        finalAnswer: `⟨${a*2}x, ${b*2}y⟩`,
                        example: { problem: `∇f of f(x,y) = x² + 4xy`, steps: [
                            { text: "∂f/∂x", math: "2x + 4y" },
                            { text: "∂f/∂y", math: "4x" },
                            { text: "Gradient", math: "<strong>⟨2x + 4y, 4x⟩</strong>" }
                        ]},
                        keyPoints: [
                            "∇f = ⟨∂f/∂x, ∂f/∂y⟩",
                            "Gradient points toward steepest increase",
                            "|∇f| = rate of steepest increase"
                        ],
                        mistakes: [
                            { wrong: "Writing gradient as scalar", why: "Gradient is a VECTOR with multiple components." },
                            { wrong: "Wrong order of components", why: "First component is ∂f/∂x, second is ∂f/∂y." }
                        ],
                        guided: (() => {
                            const c1 = rand(1, 3);
                            const c2 = rand(2, 4);
                            return {
                                problem: `Find ∇f for f(x,y) = ${c1}x³ + ${c2}y²`,
                                steps: [],
                                answer: `⟨${c1*3}x², ${c2*2}y⟩`,
                                answerLabel: "∇f =",
                                interactiveSteps: [
                                    {
                                        prompt: `Find ∂f/∂x of ${c1}x³`,
                                        hint: "Power rule...",
                                        answer: `${c1*3}x²`,
                                        acceptableAnswers: [`${c1*3}x²`, `${c1*3}x^2`],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Find ∂f/∂y of ${c2}y²`,
                                        hint: "Power rule...",
                                        answer: `${c2*2}y`,
                                        acceptableAnswers: [`${c2*2}y`],
                                        commonMistakes: {}
                                    },
                                    {
                                        prompt: `Form ∇f = ⟨?, ?⟩`,
                                        hint: "Put partials together...",
                                        answer: `⟨${c1*3}x², ${c2*2}y⟩`,
                                        acceptableAnswers: [`⟨${c1*3}x², ${c2*2}y⟩`, `<${c1*3}x², ${c2*2}y>`],
                                        commonMistakes: {}
                                    }
                                ]
                            };
                        })(),
                        practice: { problem: `Gradient points toward:`, answer: "Steepest increase",
                            options: ["Steepest increase", "Steepest decrease", "Origin", "Perpendicular"],
                            mistakeAnalysis: {
                                "Steepest decrease": "That's -∇f. Gradient itself points toward INCREASE.",
                                "Origin": "Direction depends on function, not always toward origin.",
                                "Perpendicular": "Gradient points toward steepest increase."
                            }}
                    };
                })(),
                // double sub-skill (double integrals)
                (() => {
                    const a = rand(2, 4);
                    const b = rand(2, 3);
                    return {
                        id: "double",
                        name: "Double Integrals",
                        goalProblem: `Evaluate: ∫∫_R ${a} dA where R = [0,${b}] × [0,2]`,
                        teachingSteps: [
                            {
                                title: "What is a Double Integral?",
                                explanation: "A <strong>double integral</strong> integrates over a 2D region.<br><br>∫∫_R f dA = volume under surface f over region R",
                                visual: "∫∫ = integrate over 2D"
                            },
                            {
                                title: "For Constants",
                                explanation: "When f is constant:<br><br>∫∫_R c dA = c × Area(R)",
                                visual: "constant × area"
                            },
                            {
                                title: "Our Problem",
                                explanation: `∫∫_R ${a} dA over [0,${b}] × [0,2]<br><br>Area = ${b} × 2 = ${b*2}<br>Result = ${a} × ${b*2} = <strong>${a*b*2}</strong>`,
                                visual: `${a} × ${b*2} = ${a*b*2}`
                            }
                        ],
                        finalAnswer: String(a * b * 2),
                        example: { problem: `∫∫_R 3 dA over [0,2] × [0,4]`, steps: [
                            { text: "Area = 2 × 4 = 8", math: "" },
                            { text: "Answer = 3 × 8", math: "<strong>24</strong>" }
                        ]},
                        keyPoints: [
                            "∫∫ constant dA = constant × Area",
                            "Evaluate inner integral first, then outer",
                            "∫∫ 1 dA = Area of region"
                        ],
                        mistakes: [
                            { wrong: "Forgetting second integration", why: "Double integral needs TWO integrations." },
                            { wrong: "Wrong limits order", why: "Inner limits first, then outer." }
                        ],
                        guided: {
                            problem: `∫∫_R 2 dA over [0,3] × [0,4]`,
                            steps: [],
                            answer: "24",
                            answerLabel: "Result:",
                            interactiveSteps: [
                                {
                                    prompt: `What is the area of [0,3] × [0,4]?`,
                                    hint: "3 × 4 = ?",
                                    answer: "12",
                                    acceptableAnswers: ["12"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `∫∫ 2 dA = 2 × 12 = ?`,
                                    hint: "Multiply...",
                                    answer: "24",
                                    acceptableAnswers: ["24"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `∫∫ 1 dA over a region gives:`, answer: "Area of region",
                            options: ["Area of region", "Volume", "Perimeter", "0"],
                            mistakeAnalysis: {
                                "Volume": "∫∫ f dA is volume under f. When f=1, it's area.",
                                "Perimeter": "Double integrals give area, not perimeter.",
                                "0": "∫∫ 1 dA = Area (not zero)."
                            }}
                    };
                })(),
                // chain sub-skill (multivariable chain rule)
                {
                    id: "chain",
                    name: "Multivariable Chain Rule",
                    goalProblem: `If z = f(x,y), x = t², y = t³, find dz/dt`,
                    teachingSteps: [
                        {
                            title: "The Multivariable Chain Rule",
                            explanation: "When z = f(x,y) and x, y depend on t:<br><br><strong>dz/dt = (∂z/∂x)(dx/dt) + (∂z/∂y)(dy/dt)</strong>",
                            visual: "dz/dt = (∂z/∂x)(dx/dt) + (∂z/∂y)(dy/dt)"
                        },
                        {
                            title: "Apply to Our Problem",
                            explanation: "x = t², y = t³<br><br>dx/dt = 2t<br>dy/dt = 3t²<br><br>dz/dt = (∂z/∂x)(2t) + (∂z/∂y)(3t²)",
                            visual: "dz/dt = 2t(∂z/∂x) + 3t²(∂z/∂y)"
                        },
                        {
                            title: "General Form",
                            explanation: "The answer depends on f:<br><br>dz/dt = <strong>2t·fₓ + 3t²·fᵧ</strong><br><br>where fₓ = ∂f/∂x and fᵧ = ∂f/∂y",
                            visual: "dz/dt = 2t·fₓ + 3t²·fᵧ"
                        }
                    ],
                    finalAnswer: "2t(∂z/∂x) + 3t²(∂z/∂y)",
                    example: { problem: `z = xy, x = t, y = t²`, steps: [
                        { text: "∂z/∂x = y, ∂z/∂y = x", math: "" },
                        { text: "dx/dt = 1, dy/dt = 2t", math: "" },
                        { text: "dz/dt = y(1) + x(2t)", math: "<strong>= t² + 2t²  = 3t²</strong>" }
                    ]},
                    keyPoints: [
                        "dz/dt = (∂z/∂x)(dx/dt) + (∂z/∂y)(dy/dt)",
                        "Sum contributions from each path",
                        "Each term: partial × derivative"
                    ],
                    mistakes: [
                        { wrong: "Using single-variable chain rule", why: "Need to add ALL paths: through x AND through y." },
                        { wrong: "Forgetting a term", why: "Every variable that depends on t contributes a term." }
                    ],
                    guided: {
                        problem: `z = x²y, x = t, y = t². Find dz/dt.`,
                        steps: [],
                        answer: "4t³",
                        answerLabel: "dz/dt =",
                        interactiveSteps: [
                            {
                                prompt: `Find ∂z/∂x of z = x²y`,
                                hint: "Treat y as constant...",
                                answer: "2xy",
                                acceptableAnswers: ["2xy"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Find ∂z/∂y of z = x²y`,
                                hint: "Treat x as constant...",
                                answer: "x²",
                                acceptableAnswers: ["x²", "x^2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `dx/dt for x = t is?`,
                                hint: "Derivative of t...",
                                answer: "1",
                                acceptableAnswers: ["1"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `dy/dt for y = t² is?`,
                                hint: "Power rule...",
                                answer: "2t",
                                acceptableAnswers: ["2t"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Chain rule: dz/dt = (∂z/∂x)(?) + (∂z/∂y)(?)`, answer: "(dx/dt) + (dy/dt)",
                        options: ["(dx/dt) + (dy/dt)", "(dt/dx) + (dt/dy)", "(∂t/∂x) + (∂t/∂y)", "None"],
                        mistakeAnalysis: {
                            "(dt/dx) + (dt/dy)": "It's dx/dt and dy/dt, not inverted.",
                            "(∂t/∂x) + (∂t/∂y)": "Use ordinary derivatives dx/dt, dy/dt.",
                            "None": "Answer is (dx/dt) for first term, (dy/dt) for second."
                        }}
                }
            ]
        }),
        "Linear Algebra": () => ({
            hasSubSkills: true,
            subSkills: [
                // eigenvalue sub-skill
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "eigenvalue",
                        name: "Eigenvalues",
                        goalProblem: `Find eigenvalues of A = [${a} 0; 0 ${a+1}]`,
                        teachingSteps: [
                            {
                                title: "What are Eigenvalues?",
                                explanation: "<strong>Eigenvalues</strong> (λ) satisfy: Av = λv<br><br>The vector v only gets <strong>scaled</strong>, not rotated!",
                                visual: "Av = λv"
                            },
                            {
                                title: "Finding Eigenvalues",
                                explanation: "Solve: <strong>det(A - λI) = 0</strong><br><br>This gives the characteristic equation.",
                                visual: "det(A - λI) = 0"
                            },
                            {
                                title: "Diagonal Matrix Shortcut",
                                explanation: `For diagonal matrices, eigenvalues = diagonal entries!<br><br>A = [${a} 0; 0 ${a+1}] → λ = ${a}, ${a+1}`,
                                visual: `λ = ${a}, ${a+1}`
                            }
                        ],
                        finalAnswer: `λ = ${a} and ${a+1}`,
                        example: { problem: `Eigenvalues of [3 0; 0 5]`, steps: [
                            { text: "Diagonal matrix", math: "Eigenvalues = diagonal" },
                            { text: "Read entries", math: "<strong>λ = 3, 5</strong>" }
                        ]},
                        keyPoints: [
                            "det(A - λI) = 0 gives eigenvalues",
                            "For diagonal: eigenvalues = diagonal entries",
                            "n×n matrix has n eigenvalues (counting multiplicity)"
                        ],
                        mistakes: [
                            { wrong: "Confusing eigenvalues/eigenvectors", why: "Eigenvalues are SCALARS. Eigenvectors are the vectors." },
                            { wrong: "Using off-diagonal entries", why: "For diagonal matrices, only diagonal entries matter." }
                        ],
                        guided: {
                            problem: `Find eigenvalues of [5 0; 0 2]`,
                            steps: [],
                            answer: "5 and 2",
                            answerLabel: "λ =",
                            interactiveSteps: [
                                {
                                    prompt: `For diagonal matrix, eigenvalues are?`,
                                    hint: "They're on the main diagonal...",
                                    answer: "diagonal entries",
                                    acceptableAnswers: ["diagonal entries", "diagonal", "the diagonal"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `What are the eigenvalues of [5 0; 0 2]?`,
                                    hint: "Read the diagonal...",
                                    answer: "5 and 2",
                                    acceptableAnswers: ["5 and 2", "5, 2", "2 and 5"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `Eigenvalues satisfy which equation?`, answer: "det(A - λI) = 0",
                            options: ["det(A - λI) = 0", "det(A + λI) = 0", "det(A) = λ", "A = λI"],
                            mistakeAnalysis: {
                                "det(A + λI) = 0": "It's MINUS: det(A - λI) = 0",
                                "det(A) = λ": "det(A) = product of eigenvalues, not individual ones.",
                                "A = λI": "Only for scalar matrices. Use det(A - λI) = 0."
                            }}
                    };
                })(),
                // span sub-skill
                {
                    id: "span",
                    name: "Vector Span",
                    goalProblem: `Does ⟨3, 6⟩ lie in span{⟨1, 2⟩}?`,
                    teachingSteps: [
                        {
                            title: "What is Span?",
                            explanation: "The <strong>span</strong> of vectors is all linear combinations:<br><br>span{v} = {cv : c ∈ ℝ}<br>span{v, w} = {av + bw : a, b ∈ ℝ}",
                            visual: "Span = all linear combinations"
                        },
                        {
                            title: "Our Problem",
                            explanation: "Is ⟨3, 6⟩ = c⟨1, 2⟩ for some scalar c?<br><br>⟨3, 6⟩ = ⟨c, 2c⟩<br>c = 3 ✓ and 2c = 6 ✓",
                            visual: "3 = c, 6 = 2c → c = 3 works!"
                        },
                        {
                            title: "Answer",
                            explanation: "Yes! ⟨3, 6⟩ = 3⟨1, 2⟩<br><br>So ⟨3, 6⟩ is in span{⟨1, 2⟩}",
                            visual: "⟨3, 6⟩ ∈ span{⟨1, 2⟩}"
                        }
                    ],
                    finalAnswer: "Yes, with c = 3",
                    example: { problem: `Is ⟨4, 6⟩ in span{⟨2, 3⟩}?`, steps: [
                        { text: "Check if ⟨4, 6⟩ = c⟨2, 3⟩", math: "4 = 2c → c = 2" },
                        { text: "Verify", math: "3c = 6 ✓" },
                        { text: "Answer", math: "<strong>Yes, c = 2</strong>" }
                    ]},
                    keyPoints: [
                        "Span = all linear combinations",
                        "v ∈ span{w} iff v = cw for some c",
                        "span{v, w} = plane (if independent)"
                    ],
                    mistakes: [
                        { wrong: "Forgetting to check all components", why: "Must verify ALL components work with same scalar." },
                        { wrong: "Confusing span with magnitude", why: "Span is about direction and scaling, not just length." }
                    ],
                    guided: {
                        problem: `Is ⟨6, 9⟩ in span{⟨2, 3⟩}?`,
                        steps: [],
                        answer: "Yes",
                        answerLabel: "In span?",
                        interactiveSteps: [
                            {
                                prompt: `If ⟨6, 9⟩ = c⟨2, 3⟩, what is c from first component?`,
                                hint: "6 = 2c, so c = ?",
                                answer: "3",
                                acceptableAnswers: ["3"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Check: does 3 × 3 = 9?`,
                                hint: "Second component check...",
                                answer: "yes",
                                acceptableAnswers: ["yes", "y", "9"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `span{⟨1, 0⟩, ⟨0, 1⟩} equals:`, answer: "All of ℝ²",
                        options: ["All of ℝ²", "Just the axes", "A single line", "Just origin"],
                        mistakeAnalysis: {
                            "Just the axes": "Linear COMBINATIONS can reach any point, not just axes.",
                            "A single line": "Two non-parallel vectors span a plane (all ℝ²).",
                            "Just origin": "Span always includes more than origin (unless zero vector)."
                        }}
                },
                // independence sub-skill
                {
                    id: "independence",
                    name: "Linear Independence",
                    goalProblem: `Are ⟨1, 2⟩ and ⟨2, 4⟩ linearly independent?`,
                    teachingSteps: [
                        {
                            title: "Linear Independence",
                            explanation: "Vectors are <strong>linearly independent</strong> if none is a scalar multiple of the others.<br><br>av₁ + bv₂ = 0 only when a = b = 0",
                            visual: "Independent = no redundancy"
                        },
                        {
                            title: "Check Our Vectors",
                            explanation: "⟨1, 2⟩ and ⟨2, 4⟩<br><br>Is ⟨2, 4⟩ = c⟨1, 2⟩?<br>⟨2, 4⟩ = 2⟨1, 2⟩ ✓",
                            visual: "⟨2, 4⟩ = 2⟨1, 2⟩"
                        },
                        {
                            title: "Answer",
                            explanation: "NO, they are <strong>linearly dependent</strong>!<br><br>One is a scalar multiple of the other.",
                            visual: "Dependent (parallel vectors)"
                        }
                    ],
                    finalAnswer: "No, they are dependent",
                    example: { problem: `Are ⟨1, 0⟩ and ⟨0, 1⟩ independent?`, steps: [
                        { text: "Check: is ⟨0, 1⟩ = c⟨1, 0⟩?", math: "No c makes 0 = c and 1 = 0" },
                        { text: "Not multiples", math: "" },
                        { text: "Answer", math: "<strong>Yes, independent</strong>" }
                    ]},
                    keyPoints: [
                        "Independent: no vector is combo of others",
                        "Dependent: one is multiple/combo of others",
                        "n vectors in ℝⁿ: check if det ≠ 0"
                    ],
                    mistakes: [
                        { wrong: "Only checking magnitudes", why: "Direction matters! Parallel vectors are dependent." },
                        { wrong: "Confusing with orthogonal", why: "Perpendicular ≠ independent (though orthogonal vectors ARE independent)." }
                    ],
                    guided: {
                        problem: `Are ⟨1, 3⟩ and ⟨2, 6⟩ independent?`,
                        steps: [],
                        answer: "No",
                        answerLabel: "Independent?",
                        interactiveSteps: [
                            {
                                prompt: `Is ⟨2, 6⟩ a multiple of ⟨1, 3⟩? Check: 2 = ?×1`,
                                hint: "What times 1 gives 2?",
                                answer: "2",
                                acceptableAnswers: ["2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Does 2 × 3 = 6?`,
                                hint: "Checking second component...",
                                answer: "yes",
                                acceptableAnswers: ["yes", "y"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Since ⟨2, 6⟩ = 2⟨1, 3⟩, are they dependent or independent?`,
                                hint: "One is a multiple of the other...",
                                answer: "dependent",
                                acceptableAnswers: ["dependent", "linearly dependent"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `If det([v₁ v₂]) ≠ 0, the vectors are:`, answer: "Independent",
                        options: ["Independent", "Dependent", "Orthogonal", "Parallel"],
                        mistakeAnalysis: {
                            "Dependent": "det ≠ 0 means independent. det = 0 means dependent.",
                            "Orthogonal": "Nonzero det means independent, not necessarily perpendicular.",
                            "Parallel": "Parallel vectors have det = 0, not det ≠ 0."
                        }}
                }
            ]
        }),
        "Eigenvalues": () => ({
            hasSubSkills: true,
            subSkills: [
                // definition sub-skill
                {
                    id: "definition",
                    name: "Eigenvalue Definition",
                    goalProblem: `What is an eigenvalue?`,
                    teachingSteps: [
                        {
                            title: "The Eigenvalue Equation",
                            explanation: "An <strong>eigenvalue</strong> λ satisfies:<br><br><strong>Av = λv</strong><br><br>where v ≠ 0 is the eigenvector.",
                            visual: "Av = λv"
                        },
                        {
                            title: "What This Means",
                            explanation: "When A multiplies v, the result is just v <strong>scaled by λ</strong>.<br><br>The eigenvector's direction doesn't change - it only stretches or shrinks!",
                            visual: "A scales v by factor λ"
                        },
                        {
                            title: "Key Insight",
                            explanation: "Eigenvalues tell us the <strong>scaling factors</strong> of the transformation A along special directions (the eigenvectors).",
                            visual: "λ = how much v is stretched"
                        }
                    ],
                    finalAnswer: "λ where Av = λv for some v ≠ 0",
                    example: { problem: `If A⟨2,1⟩ = 3⟨2,1⟩, what's the eigenvalue?`, steps: [
                        { text: "Compare to Av = λv", math: "A⟨2,1⟩ = 3⟨2,1⟩" },
                        { text: "The scaling factor", math: "<strong>λ = 3</strong>" }
                    ]},
                    keyPoints: [
                        "Av = λv defines eigenvalues",
                        "λ is the scaling factor",
                        "v is the eigenvector (direction preserved)"
                    ],
                    mistakes: [
                        { wrong: "Confusing λ and v", why: "λ is the scalar (eigenvalue). v is the vector (eigenvector)." },
                        { wrong: "Allowing v = 0", why: "Eigenvectors must be NON-ZERO. v = 0 trivially satisfies Av = λv." }
                    ],
                    guided: {
                        problem: `If A⟨1,2⟩ = 5⟨1,2⟩, what is the eigenvalue?`,
                        steps: [],
                        answer: "5",
                        answerLabel: "λ =",
                        interactiveSteps: [
                            {
                                prompt: `In Av = λv, what is λ called?`,
                                hint: "The scaling factor...",
                                answer: "eigenvalue",
                                acceptableAnswers: ["eigenvalue", "the eigenvalue"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `In A⟨1,2⟩ = 5⟨1,2⟩, what is λ?`,
                                hint: "The number multiplying the vector...",
                                answer: "5",
                                acceptableAnswers: ["5"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `In Av = λv, what is v called?`, answer: "Eigenvector",
                        options: ["Eigenvector", "Eigenvalue", "Determinant", "Scalar"],
                        mistakeAnalysis: {
                            "Eigenvalue": "λ is the eigenvalue. v is the eigenvector.",
                            "Determinant": "Determinant is det(A). v is the eigenvector.",
                            "Scalar": "λ is the scalar. v is the eigenvector (a vector)."
                        }}
                },
                // calculate_2x2 sub-skill
                (() => {
                    const a = rand(2, 4);
                    return {
                        id: "calculate_2x2",
                        name: "2×2 Eigenvalues",
                        goalProblem: `Find eigenvalues of [${a} 0; 0 ${a+1}]`,
                        teachingSteps: [
                            {
                                title: "The Method",
                                explanation: "Solve: det(A - λI) = 0<br><br>For 2×2: gives quadratic in λ.",
                                visual: "det(A - λI) = 0"
                            },
                            {
                                title: "Diagonal Shortcut",
                                explanation: `For diagonal matrices, eigenvalues = diagonal entries!<br><br>[${a} 0; 0 ${a+1}] → λ = ${a}, ${a+1}`,
                                visual: `λ = ${a}, ${a+1}`
                            }
                        ],
                        finalAnswer: `λ = ${a}, ${a+1}`,
                        example: { problem: `Eigenvalues of [3 0; 0 5]`, steps: [
                            { text: "Diagonal matrix", math: "λ = diagonal entries" },
                            { text: "Answer", math: "<strong>λ = 3, 5</strong>" }
                        ]},
                        keyPoints: [
                            "Use det(A - λI) = 0",
                            "Diagonal matrices: λ = diagonal entries",
                            "2×2 gives quadratic equation"
                        ],
                        mistakes: [
                            { wrong: "Wrong characteristic polynomial", why: "Check: A - λI, not A + λI" },
                            { wrong: "Missing eigenvalue", why: "n×n matrix has n eigenvalues (with multiplicity)" }
                        ],
                        guided: {
                            problem: `Find eigenvalues of [4 0; 0 7]`,
                            steps: [],
                            answer: "4 and 7",
                            answerLabel: "λ =",
                            interactiveSteps: [
                                {
                                    prompt: `For diagonal matrix, eigenvalues are?`,
                                    hint: "The entries on the main diagonal...",
                                    answer: "diagonal entries",
                                    acceptableAnswers: ["diagonal entries", "diagonal", "4 and 7"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `So eigenvalues of [4 0; 0 7] are?`,
                                    hint: "Read the diagonal...",
                                    answer: "4 and 7",
                                    acceptableAnswers: ["4 and 7", "4, 7", "7 and 4"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `Eigenvalues of [2 0; 0 2] are:`, answer: "2 (with multiplicity 2)",
                            options: ["2 (with multiplicity 2)", "2 and 0", "4", "2 and 4"],
                            mistakeAnalysis: {
                                "2 and 0": "Both diagonal entries are 2. So λ = 2 twice.",
                                "4": "That would be the trace. Eigenvalues are the diagonal: 2, 2.",
                                "2 and 4": "Only read the diagonal: 2 and 2 (same eigenvalue repeated)."
                            }}
                    };
                })(),
                // properties sub-skill
                {
                    id: "properties",
                    name: "Eigenvalue Properties",
                    goalProblem: `What is det(A) in terms of eigenvalues?`,
                    teachingSteps: [
                        {
                            title: "Key Properties",
                            explanation: "For eigenvalues λ₁, λ₂, ..., λₙ:<br><br>• <strong>det(A) = λ₁ × λ₂ × ... × λₙ</strong><br>• <strong>trace(A) = λ₁ + λ₂ + ... + λₙ</strong>",
                            visual: "det = product, trace = sum"
                        },
                        {
                            title: "Example",
                            explanation: "If λ = 2, 3 then:<br>det(A) = 2 × 3 = 6<br>trace(A) = 2 + 3 = 5",
                            visual: "det = 6, trace = 5"
                        }
                    ],
                    finalAnswer: "det(A) = product of all eigenvalues",
                    example: { problem: `λ = 3, 4. Find det(A).`, steps: [
                        { text: "det = product of eigenvalues", math: "det = 3 × 4" },
                        { text: "Answer", math: "<strong>det = 12</strong>" }
                    ]},
                    keyPoints: [
                        "det(A) = product of eigenvalues",
                        "trace(A) = sum of eigenvalues",
                        "Useful for checking calculations"
                    ],
                    mistakes: [
                        { wrong: "Confusing det and trace", why: "det = PRODUCT, trace = SUM of eigenvalues" },
                        { wrong: "Forgetting multiplicity", why: "Count repeated eigenvalues in product/sum" }
                    ],
                    guided: {
                        problem: `If eigenvalues are 2, 5, what is det(A)?`,
                        steps: [],
                        answer: "10",
                        answerLabel: "det(A) =",
                        interactiveSteps: [
                            {
                                prompt: `det(A) equals what in terms of eigenvalues?`,
                                hint: "Product or sum?",
                                answer: "product",
                                acceptableAnswers: ["product", "product of eigenvalues"],
                                commonMistakes: { "sum": "Sum is the trace. det = product." }
                            },
                            {
                                prompt: `So det = 2 × 5 = ?`,
                                hint: "Multiply...",
                                answer: "10",
                                acceptableAnswers: ["10"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `trace(A) equals:`, answer: "Sum of eigenvalues",
                        options: ["Sum of eigenvalues", "Product of eigenvalues", "Largest eigenvalue", "Number of eigenvalues"],
                        mistakeAnalysis: {
                            "Product of eigenvalues": "Product is det(A). Sum is trace(A).",
                            "Largest eigenvalue": "Trace is the SUM of all eigenvalues, not just largest.",
                            "Number of eigenvalues": "Number of eigenvalues = dimension. Trace = sum."
                        }}
                },
                // characteristic sub-skill
                {
                    id: "characteristic",
                    name: "Characteristic Polynomial",
                    goalProblem: `What is the characteristic polynomial?`,
                    teachingSteps: [
                        {
                            title: "Definition",
                            explanation: "The <strong>characteristic polynomial</strong> is:<br><br><strong>p(λ) = det(A - λI)</strong><br><br>Setting p(λ) = 0 gives eigenvalues.",
                            visual: "p(λ) = det(A - λI)"
                        },
                        {
                            title: "For 2×2",
                            explanation: "For [a b; c d]:<br><br>p(λ) = λ² - (a+d)λ + (ad-bc)<br>= λ² - trace·λ + det",
                            visual: "λ² - (trace)λ + det"
                        }
                    ],
                    finalAnswer: "p(λ) = det(A - λI)",
                    example: { problem: `Find char. poly of [2 1; 0 3]`, steps: [
                        { text: "trace = 2+3 = 5, det = 6", math: "" },
                        { text: "p(λ) = λ² - 5λ + 6", math: "" },
                        { text: "Factor", math: "<strong>(λ-2)(λ-3)</strong>" }
                    ]},
                    keyPoints: [
                        "p(λ) = det(A - λI)",
                        "Roots of p(λ) = 0 are eigenvalues",
                        "Degree of p = dimension of A"
                    ],
                    mistakes: [
                        { wrong: "Using A + λI", why: "It's A - λI, with MINUS sign." },
                        { wrong: "Wrong polynomial degree", why: "n×n matrix gives degree n polynomial" }
                    ],
                    guided: {
                        problem: `For 2×2 with trace=4, det=3, find char. polynomial`,
                        steps: [],
                        answer: "λ² - 4λ + 3",
                        answerLabel: "p(λ) =",
                        interactiveSteps: [
                            {
                                prompt: `2×2 char. poly is λ² - (trace)λ + det. What's coefficient of λ?`,
                                hint: "Negative trace...",
                                answer: "-4",
                                acceptableAnswers: ["-4", "-trace"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `So p(λ) = λ² - 4λ + ?`,
                                hint: "The constant term is det...",
                                answer: "3",
                                acceptableAnswers: ["3"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Roots of characteristic polynomial are:`, answer: "Eigenvalues",
                        options: ["Eigenvalues", "Eigenvectors", "Diagonal entries", "Determinant"],
                        mistakeAnalysis: {
                            "Eigenvectors": "Roots are eigenVALUES (scalars), not eigenvectors.",
                            "Diagonal entries": "Only for diagonal matrices. In general, roots = eigenvalues.",
                            "Determinant": "det is the constant term. Roots are eigenvalues."
                        }}
                }
            ]
        }),
        "Double Integrals": () => ({
            hasSubSkills: true,
            subSkills: [
                // evaluate sub-skill
                (() => {
                    const a = rand(2, 4);
                    const b = rand(2, 3);
                    return {
                        id: "evaluate",
                        name: "Evaluate Double Integrals",
                        goalProblem: `Evaluate: ∫∫_R ${a} dA where R = [0,${b}] × [0,2]`,
                        teachingSteps: [
                            {
                                title: "Double Integral Evaluation",
                                explanation: "Integrate inner first, then outer:<br><br>∫∫_R f dA = ∫(∫ f dx) dy",
                                visual: "Inner → Outer"
                            },
                            {
                                title: "For Constant Functions",
                                explanation: `∫∫_R c dA = c × Area(R)<br><br>Area = ${b} × 2 = ${b*2}<br>Answer = ${a} × ${b*2} = <strong>${a*b*2}</strong>`,
                                visual: `${a} × ${b*2} = ${a*b*2}`
                            }
                        ],
                        finalAnswer: String(a * b * 2),
                        example: { problem: `∫∫_R 3 dA over [0,2] × [0,4]`, steps: [
                            { text: "Area = 2 × 4 = 8", math: "" },
                            { text: "Answer = 3 × 8", math: "<strong>24</strong>" }
                        ]},
                        keyPoints: [
                            "Inner integral first, then outer",
                            "For constant: c × Area(R)",
                            "∫∫ 1 dA = Area"
                        ],
                        mistakes: [
                            { wrong: "Only one integration", why: "DOUBLE integral needs TWO integrations!" },
                            { wrong: "Wrong limits", why: "Inner uses inner limits, outer uses outer." }
                        ],
                        guided: {
                            problem: `∫∫_R 2 dA over [0,3] × [0,4]`,
                            steps: [],
                            answer: "24",
                            answerLabel: "Result:",
                            interactiveSteps: [
                                {
                                    prompt: `Area of [0,3] × [0,4] = ?`,
                                    hint: "3 × 4 = ?",
                                    answer: "12",
                                    acceptableAnswers: ["12"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `∫∫ 2 dA = 2 × 12 = ?`,
                                    hint: "Multiply...",
                                    answer: "24",
                                    acceptableAnswers: ["24"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `∫∫ 1 dA over region R gives:`, answer: "Area of R",
                            options: ["Area of R", "Volume", "Perimeter", "0"],
                            mistakeAnalysis: {
                                "Volume": "∫∫ gives volume under surface. When f=1, it's area.",
                                "Perimeter": "Double integrals give area, not perimeter.",
                                "0": "∫∫ 1 dA = Area (not zero)."
                            }}
                    };
                })(),
                // setup sub-skill
                {
                    id: "setup",
                    name: "Setting Up Double Integrals",
                    goalProblem: `Set up ∫∫_R xy dA for R = [0,2] × [0,3]`,
                    teachingSteps: [
                        {
                            title: "Setting Up the Integral",
                            explanation: "For rectangle [a,b] × [c,d]:<br><br>∫∫_R f dA = ∫_c^d ∫_a^b f(x,y) dx dy<br><br>Or equivalently: ∫_a^b ∫_c^d f(x,y) dy dx",
                            visual: "∫_y ∫_x f dx dy"
                        },
                        {
                            title: "Our Setup",
                            explanation: "R = [0,2] × [0,3]<br><br>∫∫_R xy dA = ∫_0^3 ∫_0^2 xy dx dy",
                            visual: "∫_0^3 ∫_0^2 xy dx dy"
                        }
                    ],
                    finalAnswer: "∫_0^3 ∫_0^2 xy dx dy",
                    example: { problem: `Set up ∫∫ x² dA over [1,3] × [0,2]`, steps: [
                        { text: "x from 1 to 3, y from 0 to 2", math: "" },
                        { text: "Setup", math: "<strong>∫_0^2 ∫_1^3 x² dx dy</strong>" }
                    ]},
                    keyPoints: [
                        "Identify x and y bounds",
                        "Inner integral: variable of inner dx or dy",
                        "Rectangle: limits are constants"
                    ],
                    mistakes: [
                        { wrong: "Swapping limits", why: "Match x-limits with dx, y-limits with dy." },
                        { wrong: "Missing differential", why: "Always include dx dy or dy dx." }
                    ],
                    guided: {
                        problem: `Set up ∫∫ y dA over [0,1] × [0,4]`,
                        steps: [],
                        answer: "∫_0^4 ∫_0^1 y dx dy",
                        answerLabel: "Setup:",
                        interactiveSteps: [
                            {
                                prompt: `x goes from 0 to ?`,
                                hint: "First interval...",
                                answer: "1",
                                acceptableAnswers: ["1"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `y goes from 0 to ?`,
                                hint: "Second interval...",
                                answer: "4",
                                acceptableAnswers: ["4"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `For [a,b] × [c,d], inner integral is ∫_a^b dx. Outer is:`, answer: "∫_c^d ... dy",
                        options: ["∫_c^d ... dy", "∫_a^b ... dy", "∫_c^d ... dx", "∫_a^b ... dx"],
                        mistakeAnalysis: {
                            "∫_a^b ... dy": "Inner used [a,b] for x. Outer uses [c,d] for y.",
                            "∫_c^d ... dx": "Outer should be dy (y-variable), not dx.",
                            "∫_a^b ... dx": "Inner already used x. Outer is y."
                        }}
                },
                // region sub-skill
                {
                    id: "region",
                    name: "Integration Regions",
                    goalProblem: `Describe region: 0 ≤ x ≤ 1, 0 ≤ y ≤ x`,
                    teachingSteps: [
                        {
                            title: "Types of Regions",
                            explanation: "<strong>Type I:</strong> a ≤ x ≤ b, g(x) ≤ y ≤ h(x)<br><strong>Type II:</strong> c ≤ y ≤ d, g(y) ≤ x ≤ h(y)",
                            visual: "Type I: y varies with x"
                        },
                        {
                            title: "Our Region",
                            explanation: "0 ≤ x ≤ 1, 0 ≤ y ≤ x<br><br>This is Type I: triangle below y = x",
                            visual: "Triangle with vertices (0,0), (1,0), (1,1)"
                        }
                    ],
                    finalAnswer: "Triangle below y = x from x = 0 to 1",
                    example: { problem: `Region: 0 ≤ x ≤ 2, x ≤ y ≤ 2`, steps: [
                        { text: "Type I region", math: "y goes from x to 2" },
                        { text: "Shape", math: "<strong>Triangle above y = x</strong>" }
                    ]},
                    keyPoints: [
                        "Type I: y depends on x",
                        "Type II: x depends on y",
                        "Sketch the region to understand"
                    ],
                    mistakes: [
                        { wrong: "Wrong region type", why: "Check which variable's limits depend on the other." },
                        { wrong: "Bounds reversed", why: "Lower bound ≤ variable ≤ upper bound" }
                    ],
                    guided: {
                        problem: `Describe: 0 ≤ y ≤ 1, 0 ≤ x ≤ y`,
                        steps: [],
                        answer: "Triangle below x = y",
                        answerLabel: "Region:",
                        interactiveSteps: [
                            {
                                prompt: `Is this Type I (y depends on x) or Type II (x depends on y)?`,
                                hint: "x goes from 0 to y...",
                                answer: "Type II",
                                acceptableAnswers: ["Type II", "II", "type 2"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `For 0 ≤ x ≤ 1, x² ≤ y ≤ x, what's the region?`, answer: "Between parabola and line",
                        options: ["Between parabola and line", "Rectangle", "Circle", "Triangle"],
                        mistakeAnalysis: {
                            "Rectangle": "y depends on x (x² to x), not constant bounds.",
                            "Circle": "Bounds are x² and x, not circular.",
                            "Triangle": "y = x² is a parabola, not a line."
                        }}
                },
                // order sub-skill
                {
                    id: "order",
                    name: "Changing Integration Order",
                    goalProblem: `Reverse: ∫_0^1 ∫_0^x f dy dx`,
                    teachingSteps: [
                        {
                            title: "Why Change Order?",
                            explanation: "Sometimes one order is easier to evaluate.<br><br>Fubini's Theorem: can swap if f is continuous.",
                            visual: "∫∫ dx dy ↔ ∫∫ dy dx"
                        },
                        {
                            title: "How to Reverse",
                            explanation: "Original: x from 0 to 1, y from 0 to x<br><br>Reversed: y from 0 to 1, x from y to 1<br><br>∫_0^1 ∫_y^1 f dx dy",
                            visual: "Sketch region, then re-describe"
                        }
                    ],
                    finalAnswer: "∫_0^1 ∫_y^1 f dx dy",
                    example: { problem: `Reverse ∫_0^2 ∫_0^y f dx dy`, steps: [
                        { text: "Region: y from 0 to 2, x from 0 to y", math: "" },
                        { text: "Reversed", math: "<strong>∫_0^2 ∫_x^2 f dy dx</strong>" }
                    ]},
                    keyPoints: [
                        "Sketch the region first",
                        "Re-describe with new outer variable",
                        "Check bounds match same region"
                    ],
                    mistakes: [
                        { wrong: "Not sketching region", why: "Always sketch to visualize the region." },
                        { wrong: "Wrong new bounds", why: "Solve for new limits from region description." }
                    ],
                    guided: {
                        problem: `Reverse: ∫_0^2 ∫_0^x f dy dx`,
                        steps: [],
                        answer: "∫_0^2 ∫_y^2 f dx dy",
                        answerLabel: "Reversed:",
                        interactiveSteps: [
                            {
                                prompt: `Original: x from 0 to 2, y from 0 to x. What shape is this?`,
                                hint: "Triangle below y = x...",
                                answer: "triangle",
                                acceptableAnswers: ["triangle", "a triangle"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `For reversed, y goes from 0 to 2. x goes from y to ?`,
                                hint: "Right edge of triangle is x = 2...",
                                answer: "2",
                                acceptableAnswers: ["2"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `When can you change integration order?`, answer: "When f is continuous",
                        options: ["When f is continuous", "Never", "Only for rectangles", "Only for constants"],
                        mistakeAnalysis: {
                            "Never": "Fubini's theorem allows order change for continuous f.",
                            "Only for rectangles": "Works for any region if f is continuous.",
                            "Only for constants": "Works for any continuous function."
                        }}
                }
            ]
        }),
        "Triple Integrals": () => ({
            hasSubSkills: true,
            subSkills: [
                // evaluate sub-skill
                (() => {
                    const c = rand(2, 3);
                    return {
                        id: "evaluate",
                        name: "Evaluate Triple Integrals",
                        goalProblem: `Evaluate: ∫∫∫_E ${c} dV where E = [0,1] × [0,1] × [0,1]`,
                        teachingSteps: [
                            {
                                title: "Triple Integral Evaluation",
                                explanation: "Integrate innermost first, then middle, then outer:<br><br>∫∫∫ f dV = ∫(∫(∫ f dx) dy) dz",
                                visual: "Inner → Middle → Outer"
                            },
                            {
                                title: "For Constants",
                                explanation: `∫∫∫_E c dV = c × Volume(E)<br><br>Unit cube volume = 1<br>Answer = ${c} × 1 = <strong>${c}</strong>`,
                                visual: `${c} × 1 = ${c}`
                            }
                        ],
                        finalAnswer: String(c),
                        example: { problem: `∫∫∫ 5 dV over unit cube`, steps: [
                            { text: "Volume = 1", math: "" },
                            { text: "Answer = 5 × 1", math: "<strong>5</strong>" }
                        ]},
                        keyPoints: [
                            "Three integrations needed",
                            "For constant: c × Volume",
                            "∫∫∫ 1 dV = Volume"
                        ],
                        mistakes: [
                            { wrong: "Only two integrations", why: "TRIPLE integral needs THREE!" },
                            { wrong: "Wrong volume", why: "Calculate volume correctly: l × w × h" }
                        ],
                        guided: {
                            problem: `∫∫∫ 3 dV over [0,2] × [0,2] × [0,2]`,
                            steps: [],
                            answer: "24",
                            answerLabel: "Result:",
                            interactiveSteps: [
                                {
                                    prompt: `Volume of [0,2]³ = 2 × 2 × 2 = ?`,
                                    hint: "2 cubed...",
                                    answer: "8",
                                    acceptableAnswers: ["8"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `∫∫∫ 3 dV = 3 × 8 = ?`,
                                    hint: "Multiply...",
                                    answer: "24",
                                    acceptableAnswers: ["24"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `∫∫∫ 1 dV over region E gives:`, answer: "Volume of E",
                            options: ["Volume of E", "Surface area", "Mass", "0"],
                            mistakeAnalysis: {
                                "Surface area": "Surface integral for area. ∫∫∫ 1 dV = volume.",
                                "Mass": "Mass needs density. With 1, it's volume.",
                                "0": "∫∫∫ 1 dV = Volume (not zero)."
                            }}
                    };
                })(),
                // volume sub-skill
                {
                    id: "volume",
                    name: "Volume via Triple Integrals",
                    goalProblem: `Find volume of box [0,2] × [0,3] × [0,4]`,
                    teachingSteps: [
                        {
                            title: "Volume Formula",
                            explanation: "Volume = ∫∫∫_E 1 dV<br><br>For a box: Volume = length × width × height",
                            visual: "V = ∫∫∫ 1 dV"
                        },
                        {
                            title: "Our Box",
                            explanation: "[0,2] × [0,3] × [0,4]<br><br>V = 2 × 3 × 4 = <strong>24</strong>",
                            visual: "2 × 3 × 4 = 24"
                        }
                    ],
                    finalAnswer: "24",
                    example: { problem: `Volume of [0,1] × [0,2] × [0,3]`, steps: [
                        { text: "V = l × w × h", math: "1 × 2 × 3" },
                        { text: "Answer", math: "<strong>6</strong>" }
                    ]},
                    keyPoints: [
                        "V = ∫∫∫ 1 dV",
                        "Box: V = (b-a)(d-c)(f-e)",
                        "Works for any 3D region"
                    ],
                    mistakes: [
                        { wrong: "Adding dimensions", why: "MULTIPLY dimensions, don't add." },
                        { wrong: "Forgetting a dimension", why: "3D needs all three measurements." }
                    ],
                    guided: {
                        problem: `Volume of [1,3] × [0,2] × [2,5]`,
                        steps: [],
                        answer: "12",
                        answerLabel: "Volume:",
                        interactiveSteps: [
                            {
                                prompt: `x-length: 3 - 1 = ?`,
                                hint: "Subtract bounds...",
                                answer: "2",
                                acceptableAnswers: ["2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `y-length: 2 - 0 = ?`,
                                hint: "Subtract...",
                                answer: "2",
                                acceptableAnswers: ["2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `z-length: 5 - 2 = ?`,
                                hint: "Subtract...",
                                answer: "3",
                                acceptableAnswers: ["3"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `V = 2 × 2 × 3 = ?`,
                                hint: "Multiply...",
                                answer: "12",
                                acceptableAnswers: ["12"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Volume of unit cube [0,1]³ is:`, answer: "1",
                        options: ["1", "3", "6", "0"],
                        mistakeAnalysis: {
                            "3": "That's 1+1+1 (adding). Volume = 1×1×1 = 1",
                            "6": "That would be surface area. Volume = 1³ = 1",
                            "0": "Unit cube has volume 1, not 0."
                        }}
                },
                // setup sub-skill
                {
                    id: "setup",
                    name: "Setting Up Triple Integrals",
                    goalProblem: `Set up ∫∫∫_E xyz dV for E = [0,1] × [0,2] × [0,3]`,
                    teachingSteps: [
                        {
                            title: "Setting Up",
                            explanation: "For box [a,b] × [c,d] × [e,f]:<br><br>∫_e^f ∫_c^d ∫_a^b f(x,y,z) dx dy dz",
                            visual: "∫_z ∫_y ∫_x f dx dy dz"
                        },
                        {
                            title: "Our Setup",
                            explanation: "E = [0,1] × [0,2] × [0,3]<br><br>∫_0^3 ∫_0^2 ∫_0^1 xyz dx dy dz",
                            visual: "∫_0^3 ∫_0^2 ∫_0^1 xyz dx dy dz"
                        }
                    ],
                    finalAnswer: "∫_0^3 ∫_0^2 ∫_0^1 xyz dx dy dz",
                    example: { problem: `Set up over [1,2] × [0,1] × [0,3]`, steps: [
                        { text: "Match limits to variables", math: "" },
                        { text: "Answer", math: "<strong>∫_0^3 ∫_0^1 ∫_1^2 f dx dy dz</strong>" }
                    ]},
                    keyPoints: [
                        "Match limits to correct variable",
                        "Inner integral first",
                        "Include all three differentials"
                    ],
                    mistakes: [
                        { wrong: "Missing a differential", why: "Need dx dy dz (all three)." },
                        { wrong: "Wrong limits", why: "x-limits with dx, etc." }
                    ],
                    guided: {
                        problem: `Set up ∫∫∫ x dV over [0,2] × [0,1] × [0,4]`,
                        steps: [],
                        answer: "∫_0^4 ∫_0^1 ∫_0^2 x dx dy dz",
                        answerLabel: "Setup:",
                        interactiveSteps: [
                            {
                                prompt: `x goes from 0 to ?`,
                                hint: "First interval...",
                                answer: "2",
                                acceptableAnswers: ["2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `z goes from 0 to ?`,
                                hint: "Third interval...",
                                answer: "4",
                                acceptableAnswers: ["4"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `Triple integral needs how many differentials?`, answer: "3 (dx dy dz)",
                        options: ["3 (dx dy dz)", "2 (dx dy)", "1 (dV)", "None"],
                        mistakeAnalysis: {
                            "2 (dx dy)": "That's double integral. Triple needs all three.",
                            "1 (dV)": "dV = dx dy dz, so effectively 3 differentials.",
                            "None": "Must have dx dy dz or dV."
                        }}
                },
                // coordinates sub-skill
                {
                    id: "coordinates",
                    name: "Coordinate Systems",
                    goalProblem: `When to use cylindrical vs spherical coordinates?`,
                    teachingSteps: [
                        {
                            title: "Cylindrical Coordinates",
                            explanation: "Use for <strong>cylinders, cones</strong>:<br><br>(r, θ, z) where x = r cos θ, y = r sin θ<br><br>dV = r dr dθ dz",
                            visual: "Cylindrical: r, θ, z"
                        },
                        {
                            title: "Spherical Coordinates",
                            explanation: "Use for <strong>spheres, cones</strong>:<br><br>(ρ, φ, θ) where x = ρ sin φ cos θ, etc.<br><br>dV = ρ² sin φ dρ dφ dθ",
                            visual: "Spherical: ρ, φ, θ"
                        }
                    ],
                    finalAnswer: "Cylindrical for cylinders, spherical for spheres",
                    example: { problem: `Which for x² + y² + z² ≤ 4?`, steps: [
                        { text: "This is a sphere", math: "radius 2" },
                        { text: "Use", math: "<strong>Spherical</strong>" }
                    ]},
                    keyPoints: [
                        "Cylindrical: (r, θ, z), dV = r dr dθ dz",
                        "Spherical: (ρ, φ, θ), dV = ρ² sin φ dρ dφ dθ",
                        "Match coords to region shape"
                    ],
                    mistakes: [
                        { wrong: "Forgetting Jacobian", why: "Cylindrical has r, spherical has ρ² sin φ." },
                        { wrong: "Wrong coord system", why: "Match symmetry of region." }
                    ],
                    guided: {
                        problem: `For x² + y² ≤ 4, 0 ≤ z ≤ 3, use which coordinates?`,
                        steps: [],
                        answer: "Cylindrical",
                        answerLabel: "Use:",
                        interactiveSteps: [
                            {
                                prompt: `x² + y² ≤ 4 is what shape in xy-plane?`,
                                hint: "Circle of radius 2...",
                                answer: "circle",
                                acceptableAnswers: ["circle", "disk"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `With z added, it becomes a ?`,
                                hint: "Circle extended in z...",
                                answer: "cylinder",
                                acceptableAnswers: ["cylinder"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `So we use ? coordinates`,
                                hint: "Named after the shape...",
                                answer: "cylindrical",
                                acceptableAnswers: ["cylindrical"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `dV in spherical coordinates is:`, answer: "ρ² sin φ dρ dφ dθ",
                        options: ["ρ² sin φ dρ dφ dθ", "r dr dθ dz", "dx dy dz", "ρ dρ dφ dθ"],
                        mistakeAnalysis: {
                            "r dr dθ dz": "That's cylindrical. Spherical has ρ² sin φ.",
                            "dx dy dz": "That's Cartesian. Need Jacobian for spherical.",
                            "ρ dρ dφ dθ": "Missing sin φ and ρ². It's ρ² sin φ dρ dφ dθ."
                        }}
                }
            ]
        }),
        "Vector Calculus": () => ({
            hasSubSkills: true,
            subSkills: [
                // gradient sub-skill
                (() => {
                    const a = rand(2, 4);
                    const b = rand(2, 3);
                    return {
                        id: "gradient",
                        name: "Gradient of Scalar Field",
                        goalProblem: `Find ∇f for f(x,y,z) = ${a}x² + ${b}yz`,
                        teachingSteps: [
                            {
                                title: "What is the Gradient?",
                                explanation: "The <strong>gradient</strong> ∇f of a scalar field is a vector of partial derivatives:<br><br>∇f = ⟨∂f/∂x, ∂f/∂y, ∂f/∂z⟩",
                                visual: "∇f = ⟨fₓ, fᵧ, f_z⟩"
                            },
                            {
                                title: "Calculate Partials",
                                explanation: `f = ${a}x² + ${b}yz<br><br>∂f/∂x = ${a*2}x<br>∂f/∂y = ${b}z<br>∂f/∂z = ${b}y`,
                                visual: `⟨${a*2}x, ${b}z, ${b}y⟩`
                            }
                        ],
                        finalAnswer: `⟨${a*2}x, ${b}z, ${b}y⟩`,
                        example: { problem: `∇(x² + yz)`, steps: [
                            { text: "Partials", math: "fₓ = 2x, fᵧ = z, f_z = y" },
                            { text: "Gradient", math: "<strong>⟨2x, z, y⟩</strong>" }
                        ]},
                        keyPoints: [
                            "∇f = ⟨∂f/∂x, ∂f/∂y, ∂f/∂z⟩",
                            "Gradient points toward steepest increase",
                            "|∇f| = rate of steepest increase"
                        ],
                        mistakes: [
                            { wrong: "Wrong order of components", why: "Order: x, y, z components." },
                            { wrong: "Scalar instead of vector", why: "Gradient is a VECTOR." }
                        ],
                        guided: {
                            problem: `∇f for f = 3xy + z²`,
                            steps: [],
                            answer: "⟨3y, 3x, 2z⟩",
                            answerLabel: "∇f =",
                            interactiveSteps: [
                                {
                                    prompt: `∂/∂x of 3xy + z² = ?`,
                                    hint: "Treat y, z as constants...",
                                    answer: "3y",
                                    acceptableAnswers: ["3y"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `∂/∂y of 3xy + z² = ?`,
                                    hint: "Treat x, z as constants...",
                                    answer: "3x",
                                    acceptableAnswers: ["3x"],
                                    commonMistakes: {}
                                },
                                {
                                    prompt: `∂/∂z of 3xy + z² = ?`,
                                    hint: "Power rule on z²...",
                                    answer: "2z",
                                    acceptableAnswers: ["2z"],
                                    commonMistakes: {}
                                }
                            ]
                        },
                        practice: { problem: `Gradient ∇f gives:`, answer: "A vector",
                            options: ["A vector", "A scalar", "A matrix", "A function"],
                            mistakeAnalysis: {
                                "A scalar": "Gradient of scalar gives VECTOR. Divergence gives scalar.",
                                "A matrix": "Gradient is a vector, not matrix.",
                                "A function": "It's a vector field (vector at each point)."
                            }}
                    };
                })(),
                // divergence sub-skill
                {
                    id: "divergence",
                    name: "Divergence",
                    goalProblem: `Find ∇·F for F = ⟨x², y², z²⟩`,
                    teachingSteps: [
                        {
                            title: "What is Divergence?",
                            explanation: "Divergence measures how much a field \"spreads out\":<br><br>∇·F = ∂F₁/∂x + ∂F₂/∂y + ∂F₃/∂z",
                            visual: "∇·F = sum of partials"
                        },
                        {
                            title: "Calculate",
                            explanation: "F = ⟨x², y², z²⟩<br><br>∇·F = 2x + 2y + 2z = <strong>2(x+y+z)</strong>",
                            visual: "2x + 2y + 2z"
                        }
                    ],
                    finalAnswer: "2x + 2y + 2z",
                    example: { problem: `∇·⟨3x, 2y, z⟩`, steps: [
                        { text: "Sum partials", math: "3 + 2 + 1" },
                        { text: "Answer", math: "<strong>6</strong>" }
                    ]},
                    keyPoints: [
                        "∇·F = ∂F₁/∂x + ∂F₂/∂y + ∂F₃/∂z",
                        "Divergence is a SCALAR",
                        "Positive = source, Negative = sink"
                    ],
                    mistakes: [
                        { wrong: "Getting a vector", why: "Divergence gives SCALAR (sum of partials)." },
                        { wrong: "Wrong partial", why: "∂/∂x only acts on first component, etc." }
                    ],
                    guided: {
                        problem: `∇·⟨2x, 3y, 4z⟩`,
                        steps: [],
                        answer: "9",
                        answerLabel: "∇·F =",
                        interactiveSteps: [
                            {
                                prompt: `∂(2x)/∂x = ?`,
                                hint: "Derivative of 2x...",
                                answer: "2",
                                acceptableAnswers: ["2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `∂(3y)/∂y = ?`,
                                hint: "Derivative of 3y...",
                                answer: "3",
                                acceptableAnswers: ["3"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `∂(4z)/∂z = ?`,
                                hint: "Derivative of 4z...",
                                answer: "4",
                                acceptableAnswers: ["4"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Sum: 2 + 3 + 4 = ?`,
                                hint: "Add...",
                                answer: "9",
                                acceptableAnswers: ["9"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `∇·F gives:`, answer: "A scalar",
                        options: ["A scalar", "A vector", "A matrix", "Zero"],
                        mistakeAnalysis: {
                            "A vector": "That's curl. Divergence gives scalar.",
                            "A matrix": "Divergence is scalar, not matrix.",
                            "Zero": "Only zero for specific fields. Generally a scalar."
                        }}
                },
                // curl sub-skill
                {
                    id: "curl",
                    name: "Curl",
                    goalProblem: `Find ∇×F for F = ⟨y, -x, 0⟩`,
                    teachingSteps: [
                        {
                            title: "What is Curl?",
                            explanation: "Curl measures rotation of a field:<br><br>∇×F = ⟨∂F₃/∂y - ∂F₂/∂z, ∂F₁/∂z - ∂F₃/∂x, ∂F₂/∂x - ∂F₁/∂y⟩",
                            visual: "∇×F = rotation measure"
                        },
                        {
                            title: "Calculate",
                            explanation: "F = ⟨y, -x, 0⟩<br><br>x-comp: ∂(0)/∂y - ∂(-x)/∂z = 0 - 0 = 0<br>y-comp: ∂(y)/∂z - ∂(0)/∂x = 0 - 0 = 0<br>z-comp: ∂(-x)/∂x - ∂(y)/∂y = -1 - 1 = -2<br><br>∇×F = <strong>⟨0, 0, -2⟩</strong>",
                            visual: "⟨0, 0, -2⟩"
                        }
                    ],
                    finalAnswer: "⟨0, 0, -2⟩",
                    example: { problem: `∇×⟨z, 0, x⟩`, steps: [
                        { text: "z-comp: ∂0/∂x - ∂z/∂y = 0", math: "" },
                        { text: "Full curl", math: "<strong>⟨0, 1, 0⟩</strong>" }
                    ]},
                    keyPoints: [
                        "Curl is a VECTOR",
                        "Measures local rotation",
                        "Use determinant formula"
                    ],
                    mistakes: [
                        { wrong: "Getting a scalar", why: "Curl gives VECTOR. Divergence gives scalar." },
                        { wrong: "Wrong component order", why: "Remember: y-z, z-x, x-y pattern" }
                    ],
                    guided: {
                        problem: `∇×⟨0, z, -y⟩`,
                        steps: [],
                        answer: "⟨-2, 0, 0⟩",
                        answerLabel: "∇×F =",
                        interactiveSteps: [
                            {
                                prompt: `x-comp: ∂(-y)/∂y - ∂(z)/∂z = ?`,
                                hint: "-1 - 1 = ?",
                                answer: "-2",
                                acceptableAnswers: ["-2"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `y-comp: ∂(0)/∂z - ∂(-y)/∂x = ?`,
                                hint: "0 - 0 = ?",
                                answer: "0",
                                acceptableAnswers: ["0"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `z-comp: ∂(z)/∂x - ∂(0)/∂y = ?`,
                                hint: "0 - 0 = ?",
                                answer: "0",
                                acceptableAnswers: ["0"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `∇×F gives:`, answer: "A vector",
                        options: ["A vector", "A scalar", "Zero always", "A matrix"],
                        mistakeAnalysis: {
                            "A scalar": "Scalar is divergence. Curl gives vector.",
                            "Zero always": "Zero only for conservative fields.",
                            "A matrix": "Curl is a vector, not matrix."
                        }}
                },
                // line_integral sub-skill
                {
                    id: "line_integral",
                    name: "Line Integrals",
                    goalProblem: `What is ∫_C F·dr?`,
                    teachingSteps: [
                        {
                            title: "Line Integral Definition",
                            explanation: "A <strong>line integral</strong> integrates a vector field along a curve:<br><br>∫_C F·dr = ∫_a^b F(r(t))·r'(t) dt",
                            visual: "∫_C F·dr = work done"
                        },
                        {
                            title: "Interpretation",
                            explanation: "∫_C F·dr = <strong>work</strong> done by force F along path C.<br><br>For conservative F: result depends only on endpoints!",
                            visual: "Work = ∫ F·dr"
                        }
                    ],
                    finalAnswer: "Work done by F along curve C",
                    example: { problem: `∫_C F·dr for F = ⟨1, 0⟩, C from (0,0) to (1,0)`, steps: [
                        { text: "Parametrize: r(t) = ⟨t, 0⟩, 0≤t≤1", math: "" },
                        { text: "r'(t) = ⟨1, 0⟩", math: "" },
                        { text: "∫_0^1 ⟨1,0⟩·⟨1,0⟩ dt", math: "<strong>= 1</strong>" }
                    ]},
                    keyPoints: [
                        "∫_C F·dr = ∫ F(r(t))·r'(t) dt",
                        "Represents work done",
                        "Conservative fields: path-independent"
                    ],
                    mistakes: [
                        { wrong: "Forgetting to parametrize", why: "Need r(t) and r'(t) for curve." },
                        { wrong: "Wrong dot product", why: "F·r' not F·r!" }
                    ],
                    guided: {
                        problem: `For F = ∇f, ∫_C F·dr from A to B equals?`,
                        steps: [],
                        answer: "f(B) - f(A)",
                        answerLabel: "Result:",
                        interactiveSteps: [
                            {
                                prompt: `If F = ∇f, F is called?`,
                                hint: "Gradient of potential...",
                                answer: "conservative",
                                acceptableAnswers: ["conservative", "a conservative field"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `For conservative fields, ∫_C F·dr depends only on?`,
                                hint: "Start and end...",
                                answer: "endpoints",
                                acceptableAnswers: ["endpoints", "the endpoints"],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Specifically, ∫_C ∇f·dr = f(B) - ?`,
                                hint: "Value at start...",
                                answer: "f(A)",
                                acceptableAnswers: ["f(A)", "f(a)"],
                                commonMistakes: {}
                            }
                        ]
                    },
                    practice: { problem: `∫_C F·dr represents:`, answer: "Work done by F along C",
                        options: ["Work done by F along C", "Area under F", "Length of C", "Volume"],
                        mistakeAnalysis: {
                            "Area under F": "Area is ∫ f dx. Line integral is work.",
                            "Length of C": "Length is ∫_C |dr|. Work is ∫_C F·dr.",
                            "Volume": "Volume needs triple integral, not line integral."
                        }}
                }
            ]
        }),
        "Number Theory": () => {
            const a = rand(12, 30);
            const b = rand(8, 20);
            const gcdVal = (x, y) => y === 0 ? x : gcdVal(y, x % y);
            const g = gcdVal(a, b);
            return {
                goalProblem: `Find GCD(${a}, ${b})`,
                teachingSteps: [
                    {
                        title: "What is Number Theory?",
                        explanation: "<strong>Number theory</strong> studies properties of integers: divisibility, primes, GCD, modular arithmetic, etc.",
                        visual: "Integers and their properties"
                    },
                    {
                        title: "GCD (Greatest Common Divisor)",
                        explanation: "The <strong>GCD</strong> is the largest integer that divides both numbers.<br><br>GCD(12, 8) = 4 because 4 divides both.",
                        visual: "GCD = largest common factor"
                    },
                    {
                        title: "Euclidean Algorithm",
                        explanation: "Use repeated division:<br>GCD(a, b) = GCD(b, a mod b)<br><br>Continue until remainder is 0.",
                        visual: "GCD(a,b) = GCD(b, a mod b)"
                    },
                    {
                        title: "Our problem",
                        explanation: `GCD(${a}, ${b}):<br>${a} = ${b} × ${Math.floor(a/b)} + ${a%b}<br>GCD(${b}, ${a%b}) = ${g}`,
                        visual: `GCD = ${g}`
                    }
                ],
                finalAnswer: String(g),
                answerExplanation: `Using Euclidean algorithm: GCD(${a}, ${b}) = ${g}`,
                example: { problem: `GCD(48, 18)`, steps: [
                    { text: "48 = 18 × 2 + 12", math: "GCD(48,18) = GCD(18,12)" },
                    { text: "18 = 12 × 1 + 6", math: "GCD(18,12) = GCD(12,6)" },
                    { text: "12 = 6 × 2 + 0", math: "<strong>GCD = 6</strong>" }
                ]},
                keyPoints: [
                    "GCD(a,b) = GCD(b, a mod b)",
                    "Stop when remainder = 0",
                    "GCD(a, 0) = a"
                ],
                mistakes: [
                    { wrong: "Finding LCM instead", why: "GCD = greatest common divisor. LCM = least common multiple (different!)." },
                    { wrong: "Stopping too early", why: "Continue until remainder is 0." }
                ],
                guided: {
                    problem: `Find GCD(24, 36)`,
                    steps: [
                        { label: "36 = 24 × 1 + 12", value: "GCD(36,24) = GCD(24,12)" },
                        { label: "24 = 12 × 2 + 0", value: "GCD = ?" }
                    ],
                    answer: "12",
                    answerLabel: "GCD = ",
                    interactiveSteps: [
                        {
                            prompt: "36 mod 24 = ?",
                            hint: "36 - 24 = ?",
                            answer: "12",
                            acceptableAnswers: ["12"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "24 mod 12 = ?",
                            hint: "24 ÷ 12 = 2 with remainder ?",
                            answer: "0",
                            acceptableAnswers: ["0"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "When remainder = 0, GCD is the last non-zero remainder. GCD = ?",
                            hint: "The divisor when remainder became 0...",
                            answer: "12",
                            acceptableAnswers: ["12"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `GCD(a, 0) = ?`, answer: "a",
                    options: ["a", "0", "1", "undefined"],
                    mistakeAnalysis: {
                        "0": "GCD(a, 0) = a. Every integer divides 0!",
                        "1": "Only if a = 1. Generally GCD(a, 0) = a.",
                        "undefined": "It's defined! GCD(a, 0) = a."
                    }}
            };
        },
        "Mathematical Logic": () => {
            return {
                goalProblem: `What is the contrapositive of \"If P, then Q\"?`,
                teachingSteps: [
                    {
                        title: "What is Mathematical Logic?",
                        explanation: "<strong>Mathematical logic</strong> studies formal reasoning, proofs, and logical structures.",
                        visual: "Logic = formal reasoning"
                    },
                    {
                        title: "Conditional statements",
                        explanation: "\"If P, then Q\" (written P → Q) has related statements:<br><br>• <strong>Converse:</strong> Q → P<br>• <strong>Inverse:</strong> ¬P → ¬Q<br>• <strong>Contrapositive:</strong> ¬Q → ¬P",
                        visual: "P→Q: Converse, Inverse, Contrapositive"
                    },
                    {
                        title: "The Contrapositive",
                        explanation: "Contrapositive of \"If P, then Q\" is:<br><br><strong>\"If not Q, then not P\"</strong><br><br>Written: ¬Q → ¬P",
                        visual: "P→Q ≡ ¬Q→¬P"
                    },
                    {
                        title: "Key fact",
                        explanation: "A statement and its contrapositive are <strong>logically equivalent</strong>!<br><br>P → Q ≡ ¬Q → ¬P",
                        visual: "Contrapositive = same truth value"
                    }
                ],
                finalAnswer: "If not Q, then not P (¬Q → ¬P)",
                answerExplanation: "The contrapositive negates both parts and flips them: P→Q becomes ¬Q→¬P",
                example: { problem: `Contrapositive of \"If it rains, then the ground is wet\"`, steps: [
                    { text: "Negate both", math: "not wet, not rain" },
                    { text: "Flip order", math: "If not wet, then not rain" },
                    { text: "Result", math: "<strong>If ground not wet, it didn't rain</strong>" }
                ]},
                keyPoints: [
                    "Contrapositive: negate both, flip order",
                    "P→Q is equivalent to ¬Q→¬P",
                    "Converse and inverse are NOT equivalent to original"
                ],
                mistakes: [
                    { wrong: "Just negating: ¬P → ¬Q", why: "That's the INVERSE. Contrapositive also flips: ¬Q → ¬P." },
                    { wrong: "Just flipping: Q → P", why: "That's the CONVERSE. Contrapositive also negates: ¬Q → ¬P." }
                ],
                guided: {
                    problem: `Find the contrapositive of \"If x > 5, then x² > 25\"`,
                    steps: [
                        { label: "P: x > 5, Q: x² > 25", value: "Negate and flip" },
                        { label: "¬Q: x² ≤ 25, ¬P: x ≤ 5", value: "?" }
                    ],
                    answer: "If x² ≤ 25, then x ≤ 5",
                    answerLabel: "Contrapositive: ",
                    interactiveSteps: [
                        {
                            prompt: "What is the negation of \"x > 5\"?",
                            hint: "x is NOT greater than 5...",
                            answer: "x ≤ 5",
                            acceptableAnswers: ["x ≤ 5", "x <= 5", "x is less than or equal to 5"],
                            commonMistakes: {
                                "x < 5": "Close! Negation of > is ≤ (includes equal)."
                            }
                        },
                        {
                            prompt: "What is the negation of \"x² > 25\"?",
                            hint: "x² is NOT greater than 25...",
                            answer: "x² ≤ 25",
                            acceptableAnswers: ["x² ≤ 25", "x^2 <= 25"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A conditional and its contrapositive are:`, answer: "Logically equivalent",
                    options: ["Logically equivalent", "Converses", "Negations", "Unrelated"],
                    mistakeAnalysis: {
                        "Converses": "The converse is Q→P. The contrapositive ¬Q→¬P is equivalent to original.",
                        "Negations": "Negation is different. Contrapositive = logically equivalent.",
                        "Unrelated": "They have the SAME truth value! P→Q ≡ ¬Q→¬P."
                    }}
            };
        },
        "Real Analysis": () => {
            return {
                goalProblem: `Prove that the sequence aₙ = 1/n converges to 0`,
                teachingSteps: [
                    {
                        title: "What is Real Analysis?",
                        explanation: "<strong>Real Analysis</strong> provides rigorous foundations for calculus using ε-δ definitions, limits, continuity, and convergence proofs.",
                        visual: "Rigorous study of real numbers and functions"
                    },
                    {
                        title: "The ε-N definition of convergence",
                        explanation: "A sequence {aₙ} converges to L if:<br><br>For every ε > 0, there exists N such that for all n > N: |aₙ - L| < ε",
                        visual: "∀ε > 0, ∃N: n > N ⟹ |aₙ - L| < ε"
                    },
                    {
                        title: "Our proof",
                        explanation: "To prove 1/n → 0:<br><br>Given ε > 0, we need |1/n - 0| < ε<br>This means 1/n < ε<br>So n > 1/ε",
                        visual: "Choose N = ⌈1/ε⌉"
                    },
                    {
                        title: "Conclusion",
                        explanation: "For any ε > 0, choose N = ⌈1/ε⌉. Then for n > N:<br>n > 1/ε ⟹ 1/n < ε ⟹ |1/n - 0| < ε ✓",
                        visual: "lim(n→∞) 1/n = 0"
                    }
                ],
                finalAnswer: "The sequence converges to 0",
                answerExplanation: "Using ε-N definition: for any ε > 0, choosing N > 1/ε ensures |1/n| < ε for all n > N.",
                example: { problem: `Prove 1/n → 0`, steps: [
                    { text: "Given ε > 0, need |1/n - 0| < ε", math: "1/n < ε" },
                    { text: "This requires n > 1/ε", math: "Choose N = ⌈1/ε⌉" },
                    { text: "For n > N, we have 1/n < ε ✓", math: "<strong>QED</strong>" }
                ]},
                keyPoints: [
                    "ε-N definition: for all ε > 0, exists N such that...",
                    "Must work for ANY ε, no matter how small",
                    "Choose N as a function of ε"
                ],
                mistakes: [
                    { wrong: "Choosing N before ε", why: "N depends on ε. Must start with 'given ε > 0'." },
                    { wrong: "Only showing it works for specific ε", why: "Must work for ALL ε > 0." }
                ],
                guided: {
                    problem: `What N works for ε = 0.01 to prove 1/n → 0?`,
                    steps: [
                        { label: "Need 1/n < 0.01", value: "n > 100" },
                        { label: "So N = ?", value: "?" }
                    ],
                    answer: "100",
                    answerLabel: "N = ",
                    interactiveSteps: [
                        {
                            prompt: "If 1/n < 0.01, then n > ?",
                            hint: "0.01 = 1/100, so n must be greater than...",
                            answer: "100",
                            acceptableAnswers: ["100"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `In ε-N definition, which comes first?`, answer: "ε is given, then N is chosen",
                    options: ["ε is given, then N is chosen", "N is given, then ε is chosen", "Both are given", "Neither matters"],
                    mistakeAnalysis: {
                        "N is given, then ε is chosen": "No! ε is arbitrary first, then we find N that works.",
                        "Both are given": "ε is given (arbitrary). N is our choice based on ε.",
                        "Neither matters": "Order matters! ε first, then N depends on ε."
                    }}
            };
        },
        "Complex Analysis": () => {
            return {
                goalProblem: `Find the residue of f(z) = 1/(z-2) at z = 2`,
                teachingSteps: [
                    {
                        title: "What is Complex Analysis?",
                        explanation: "<strong>Complex Analysis</strong> studies functions of complex variables. Key concepts: analytic functions, contour integrals, residues.",
                        visual: "Functions of z = x + iy"
                    },
                    {
                        title: "What is a residue?",
                        explanation: "The <strong>residue</strong> is the coefficient of 1/(z-a) in the Laurent series at a singularity. For simple poles: Res(f, a) = lim(z→a) (z-a)f(z)",
                        visual: "Res(f, a) = coefficient of 1/(z-a)"
                    },
                    {
                        title: "Simple pole at z = 2",
                        explanation: "f(z) = 1/(z-2) has a simple pole at z = 2.<br><br>Res(f, 2) = lim(z→2) (z-2) · 1/(z-2) = lim(z→2) 1 = <strong>1</strong>",
                        visual: "Res = 1"
                    },
                    {
                        title: "Why residues matter",
                        explanation: "Residues are used in the Residue Theorem:<br>∮ f(z)dz = 2πi × (sum of residues)<br><br>This evaluates complex integrals!",
                        visual: "∮ f dz = 2πi Σ Res"
                    }
                ],
                finalAnswer: "Residue = 1",
                answerExplanation: "For simple pole: Res(1/(z-2), 2) = lim(z→2)(z-2)·1/(z-2) = 1",
                example: { problem: `Residue of 1/(z-2) at z=2`, steps: [
                    { text: "Simple pole formula", math: "Res = lim(z→a)(z-a)f(z)" },
                    { text: "Apply", math: "lim(z→2)(z-2)·1/(z-2)" },
                    { text: "Simplify", math: "<strong>= 1</strong>" }
                ]},
                keyPoints: [
                    "Residue at simple pole: lim(z→a)(z-a)f(z)",
                    "Residue Theorem: ∮f dz = 2πi·Σ(residues inside)",
                    "Analytic functions satisfy Cauchy-Riemann equations"
                ],
                mistakes: [
                    { wrong: "Forgetting factor of 2πi in Residue Theorem", why: "∮f dz = 2πi × sum of residues (not just sum)." },
                    { wrong: "Using wrong formula for higher-order poles", why: "Simple pole: (z-a)f(z). Higher order needs derivatives." }
                ],
                guided: {
                    problem: `Find residue of 3/(z-1) at z = 1`,
                    steps: [
                        { label: "Simple pole at z = 1", value: "Res = lim(z→1)(z-1)·3/(z-1)" },
                        { label: "Simplify", value: "?" }
                    ],
                    answer: "3",
                    answerLabel: "Residue = ",
                    interactiveSteps: [
                        {
                            prompt: "(z-1) · 3/(z-1) simplifies to?",
                            hint: "(z-1) cancels...",
                            answer: "3",
                            acceptableAnswers: ["3"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `The Residue Theorem gives ∮f dz = ?`, answer: "2πi times sum of residues",
                    options: ["2πi times sum of residues", "Sum of residues", "πi times sum", "Product of residues"],
                    mistakeAnalysis: {
                        "Sum of residues": "Missing the factor! It's 2πi × Σ residues.",
                        "πi times sum": "It's 2πi, not πi.",
                        "Product of residues": "It's the SUM of residues, not product."
                    }}
            };
        },
        "Abstract Algebra": () => {
            return {
                goalProblem: `Is (Z, +) a group? Verify the group axioms.`,
                teachingSteps: [
                    {
                        title: "What is Abstract Algebra?",
                        explanation: "<strong>Abstract Algebra</strong> studies algebraic structures: groups, rings, fields. It generalizes arithmetic to abstract operations.",
                        visual: "Groups, Rings, Fields"
                    },
                    {
                        title: "Group axioms",
                        explanation: "A <strong>group</strong> (G, ∗) must satisfy:<br>1. Closure: a∗b ∈ G<br>2. Associativity: (a∗b)∗c = a∗(b∗c)<br>3. Identity: ∃e such that a∗e = a<br>4. Inverse: ∃a⁻¹ such that a∗a⁻¹ = e",
                        visual: "Closure, Associative, Identity, Inverse"
                    },
                    {
                        title: "Verify (Z, +)",
                        explanation: "1. Closure: a + b ∈ Z ✓<br>2. Associative: (a+b)+c = a+(b+c) ✓<br>3. Identity: 0 (a + 0 = a) ✓<br>4. Inverse: -a (a + (-a) = 0) ✓",
                        visual: "All 4 axioms satisfied!"
                    },
                    {
                        title: "Conclusion",
                        explanation: "<strong>(Z, +) is a group!</strong><br><br>It's also abelian (commutative) since a + b = b + a.",
                        visual: "(Z, +) is an abelian group"
                    }
                ],
                finalAnswer: "Yes, (Z, +) is a group",
                answerExplanation: "All four group axioms are satisfied: closure, associativity, identity (0), and inverses (-a).",
                example: { problem: `Is (Z, +) a group?`, steps: [
                    { text: "Check closure", math: "a + b ∈ Z ✓" },
                    { text: "Check associativity", math: "(a+b)+c = a+(b+c) ✓" },
                    { text: "Check identity", math: "0: a + 0 = a ✓" },
                    { text: "Check inverse", math: "-a: a + (-a) = 0 ✓" },
                    { text: "Conclusion", math: "<strong>Yes, it's a group</strong>" }
                ]},
                keyPoints: [
                    "Group needs: closure, associativity, identity, inverses",
                    "Abelian group adds: commutativity",
                    "(Z, +) is abelian; (Z, ×) is not a group (no inverses)"
                ],
                mistakes: [
                    { wrong: "Forgetting to check closure", why: "All four axioms must be verified!" },
                    { wrong: "Thinking (Z, ×) is a group", why: "No multiplicative inverses! 2 has no integer inverse." }
                ],
                guided: {
                    problem: `What is the identity element in (Z, +)?`,
                    steps: [
                        { label: "Need e where a + e = a", value: "What number adds to give a back?" },
                        { label: "Answer", value: "?" }
                    ],
                    answer: "0",
                    answerLabel: "Identity = ",
                    interactiveSteps: [
                        {
                            prompt: "a + ? = a for all integers a",
                            hint: "What adds to any number and gives the same number?",
                            answer: "0",
                            acceptableAnswers: ["0", "zero"],
                            commonMistakes: {
                                "1": "That's multiplicative identity. For addition, a + 0 = a."
                            }
                        }
                    ]
                },
                practice: { problem: `Why isn't (Z, ×) a group?`, answer: "No multiplicative inverses for most elements",
                    options: ["No multiplicative inverses for most elements", "Not closed", "Not associative", "No identity"],
                    mistakeAnalysis: {
                        "Not closed": "Z is closed under ×. a × b ∈ Z.",
                        "Not associative": "× is associative. (ab)c = a(bc).",
                        "No identity": "1 is the identity. But 2 has no integer inverse."
                    }}
            };
        },
        "Advanced Number Theory": () => {
            return {
                goalProblem: `Find 7⁻¹ mod 11 (multiplicative inverse)`,
                teachingSteps: [
                    {
                        title: "Modular arithmetic",
                        explanation: "<strong>Modular arithmetic</strong> works with remainders. a ≡ b (mod n) means a and b have the same remainder when divided by n.",
                        visual: "a mod n = remainder"
                    },
                    {
                        title: "Multiplicative inverse mod n",
                        explanation: "The inverse of a mod n is b such that:<br><br><strong>a · b ≡ 1 (mod n)</strong><br><br>Exists only if gcd(a, n) = 1.",
                        visual: "a · a⁻¹ ≡ 1 (mod n)"
                    },
                    {
                        title: "Find 7⁻¹ mod 11",
                        explanation: "Need 7x ≡ 1 (mod 11).<br><br>Test: 7 × 8 = 56 = 55 + 1 = 5(11) + 1 ≡ 1 (mod 11) ✓<br><br>So <strong>7⁻¹ ≡ 8 (mod 11)</strong>",
                        visual: "7 × 8 = 56 ≡ 1 (mod 11)"
                    },
                    {
                        title: "Extended Euclidean Algorithm",
                        explanation: "For larger numbers, use Extended GCD to find inverse systematically.",
                        visual: "7⁻¹ ≡ 8 (mod 11)"
                    }
                ],
                finalAnswer: "8",
                answerExplanation: "7 × 8 = 56 = 5(11) + 1 ≡ 1 (mod 11), so 7⁻¹ ≡ 8 (mod 11).",
                example: { problem: `Find 7⁻¹ mod 11`, steps: [
                    { text: "Need 7x ≡ 1 (mod 11)", math: "Try values" },
                    { text: "7 × 8 = 56", math: "56 = 55 + 1 = 5(11) + 1" },
                    { text: "56 ≡ 1 (mod 11) ✓", math: "<strong>7⁻¹ = 8</strong>" }
                ]},
                keyPoints: [
                    "a⁻¹ exists mod n iff gcd(a,n) = 1",
                    "a · a⁻¹ ≡ 1 (mod n)",
                    "Use Extended Euclidean for large numbers"
                ],
                mistakes: [
                    { wrong: "Thinking 1/7 is the inverse", why: "We need an INTEGER inverse mod 11, not a fraction." },
                    { wrong: "Forgetting to check gcd = 1", why: "If gcd(a,n) ≠ 1, no inverse exists." }
                ],
                guided: {
                    problem: `Find 3⁻¹ mod 7`,
                    steps: [
                        { label: "Need 3x ≡ 1 (mod 7)", value: "Try: 3 × 5 = 15 = 14 + 1" },
                        { label: "15 mod 7", value: "?" }
                    ],
                    answer: "5",
                    answerLabel: "3⁻¹ mod 7 = ",
                    interactiveSteps: [
                        {
                            prompt: "3 × 5 = 15. What is 15 mod 7?",
                            hint: "15 = 7 × 2 + ?",
                            answer: "1",
                            acceptableAnswers: ["1"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "Since 3 × 5 ≡ 1 (mod 7), what is 3⁻¹?",
                            hint: "The multiplier that gives 1...",
                            answer: "5",
                            acceptableAnswers: ["5"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Does 6⁻¹ exist mod 9?`, answer: "No (gcd = 3 ≠ 1)",
                    options: ["No (gcd = 3 ≠ 1)", "Yes, it's 3", "Yes, it's 6", "Yes, it's 1"],
                    mistakeAnalysis: {
                        "Yes, it's 3": "6 × 3 = 18 ≡ 0 (mod 9), not 1. gcd(6,9) = 3, so no inverse.",
                        "Yes, it's 6": "6 × 6 = 36 ≡ 0 (mod 9), not 1.",
                        "Yes, it's 1": "6 × 1 = 6 ≢ 1 (mod 9)."
                    }}
            };
        },
        "Differential Geometry": () => {
            return {
                goalProblem: `Find the curvature of y = x² at the origin`,
                teachingSteps: [
                    {
                        title: "What is Differential Geometry?",
                        explanation: "<strong>Differential Geometry</strong> studies curves and surfaces using calculus. Key concepts: curvature, geodesics, manifolds.",
                        visual: "Geometry + Calculus = Differential Geometry"
                    },
                    {
                        title: "Curvature of a plane curve",
                        explanation: "For y = f(x), curvature is:<br><br><strong>κ = |y''| / (1 + y'²)^(3/2)</strong><br><br>Curvature measures how sharply the curve bends.",
                        visual: "κ = |y''| / (1 + y'²)^(3/2)"
                    },
                    {
                        title: "Calculate for y = x²",
                        explanation: "y = x²<br>y' = 2x<br>y'' = 2<br><br>At origin (x = 0):<br>y' = 0, y'' = 2",
                        visual: "y' = 0, y'' = 2 at x = 0"
                    },
                    {
                        title: "Apply formula",
                        explanation: "κ = |2| / (1 + 0²)^(3/2) = 2 / 1 = <strong>2</strong>",
                        visual: "κ = 2"
                    }
                ],
                finalAnswer: "κ = 2",
                answerExplanation: "Using κ = |y''|/(1+y'²)^(3/2) with y' = 0 and y'' = 2 at origin: κ = 2/1 = 2.",
                example: { problem: `Curvature of y = x² at origin`, steps: [
                    { text: "Find derivatives", math: "y' = 2x, y'' = 2" },
                    { text: "At x = 0", math: "y' = 0, y'' = 2" },
                    { text: "Apply formula", math: "κ = |2|/(1+0)^(3/2) = <strong>2</strong>" }
                ]},
                keyPoints: [
                    "κ = |y''|/(1+y'²)^(3/2) for y = f(x)",
                    "Higher curvature = sharper bend",
                    "κ = 0 for straight lines"
                ],
                mistakes: [
                    { wrong: "Forgetting absolute value on y''", why: "Curvature is always non-negative." },
                    { wrong: "Using κ = y'' directly", why: "Must use full formula with (1+y'²)^(3/2) in denominator." }
                ],
                guided: {
                    problem: `What is the curvature of a line y = 2x + 1?`,
                    steps: [
                        { label: "y' = 2, y'' = 0", value: "Apply formula" },
                        { label: "κ = |0|/(1+4)^(3/2)", value: "?" }
                    ],
                    answer: "0",
                    answerLabel: "κ = ",
                    interactiveSteps: [
                        {
                            prompt: "For y = 2x + 1, what is y''?",
                            hint: "Second derivative of a linear function...",
                            answer: "0",
                            acceptableAnswers: ["0"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "If y'' = 0, what is the curvature?",
                            hint: "|0|/(anything) = ?",
                            answer: "0",
                            acceptableAnswers: ["0"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Lines have what curvature?`, answer: "0",
                    options: ["0", "1", "∞", "Undefined"],
                    mistakeAnalysis: {
                        "1": "Lines don't bend at all, so curvature is 0.",
                        "∞": "Infinite curvature would be an infinitely sharp corner.",
                        "Undefined": "κ = 0 for lines (y'' = 0)."
                    }}
            };
        },
        "Advanced Statistics": () => {
            return {
                goalProblem: `What is the Central Limit Theorem?`,
                teachingSteps: [
                    {
                        title: "What is Advanced Statistics?",
                        explanation: "<strong>Advanced Statistics</strong> includes hypothesis testing, regression, Bayesian methods, and theoretical foundations.",
                        visual: "Beyond basic probability"
                    },
                    {
                        title: "The Central Limit Theorem (CLT)",
                        explanation: "The <strong>CLT</strong> states: The distribution of sample means approaches a <strong>normal distribution</strong> as sample size increases, regardless of population distribution!",
                        visual: "Sample means → Normal distribution"
                    },
                    {
                        title: "The formula",
                        explanation: "If X̄ is the mean of n samples from a population with mean μ and std σ:<br><br>X̄ ~ N(μ, σ/√n) approximately, for large n",
                        visual: "X̄ ~ N(μ, σ/√n)"
                    },
                    {
                        title: "Why it matters",
                        explanation: "CLT allows us to use normal distribution for inference even when population isn't normal. This is the foundation of many statistical tests!",
                        visual: "Foundation of statistical inference"
                    }
                ],
                finalAnswer: "Sample means approach normal distribution as n → ∞",
                answerExplanation: "The CLT states that the distribution of sample means becomes approximately normal as sample size increases.",
                example: { problem: `Central Limit Theorem`, steps: [
                    { text: "Take many samples from any distribution", math: "Compute mean of each sample" },
                    { text: "Distribution of these means", math: "Approaches N(μ, σ/√n)" },
                    { text: "Key insight", math: "<strong>Works for ANY population distribution</strong>" }
                ]},
                keyPoints: [
                    "Sample means → Normal as n increases",
                    "Works regardless of population shape",
                    "Standard error = σ/√n"
                ],
                mistakes: [
                    { wrong: "Thinking population must be normal", why: "CLT works for ANY population distribution!" },
                    { wrong: "Confusing σ with σ/√n", why: "Standard error of mean is σ/√n, not σ." }
                ],
                guided: {
                    problem: `If population has σ = 10, what's the standard error for n = 100?`,
                    steps: [
                        { label: "Standard error = σ/√n", value: "10/√100" },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: "1",
                    answerLabel: "SE = ",
                    interactiveSteps: [
                        {
                            prompt: "√100 = ?",
                            hint: "Square root of 100...",
                            answer: "10",
                            acceptableAnswers: ["10"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "10/10 = ?",
                            hint: "Divide...",
                            answer: "1",
                            acceptableAnswers: ["1"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `CLT applies to:`, answer: "Any distribution with finite variance",
                    options: ["Any distribution with finite variance", "Only normal distributions", "Only uniform distributions", "Only discrete distributions"],
                    mistakeAnalysis: {
                        "Only normal distributions": "That's the beauty of CLT - it works for ANY distribution!",
                        "Only uniform distributions": "CLT works for all distributions with finite variance.",
                        "Only discrete distributions": "Works for continuous too."
                    }}
            };
        },
        "Applied Mathematics": () => {
            return {
                goalProblem: `Model exponential growth: Population doubles every 10 years. If P₀ = 1000, find P(30).`,
                teachingSteps: [
                    {
                        title: "What is Applied Mathematics?",
                        explanation: "<strong>Applied Mathematics</strong> uses math to solve real-world problems: physics, engineering, biology, finance, etc.",
                        visual: "Math in the real world"
                    },
                    {
                        title: "Exponential growth model",
                        explanation: "Population growth: <strong>P(t) = P₀ · 2^(t/T)</strong><br><br>Where T = doubling time",
                        visual: "P(t) = P₀ · 2^(t/T)"
                    },
                    {
                        title: "Apply our values",
                        explanation: "P₀ = 1000, T = 10 years<br><br>P(30) = 1000 · 2^(30/10) = 1000 · 2³",
                        visual: "P(30) = 1000 · 8"
                    },
                    {
                        title: "Calculate",
                        explanation: "P(30) = 1000 × 8 = <strong>8000</strong>",
                        visual: "P(30) = 8000"
                    }
                ],
                finalAnswer: "8000",
                answerExplanation: "Using P(t) = P₀·2^(t/T): P(30) = 1000·2^(30/10) = 1000·8 = 8000",
                example: { problem: `Population doubling every 10 years`, steps: [
                    { text: "Model: P(t) = P₀·2^(t/T)", math: "P₀ = 1000, T = 10" },
                    { text: "At t = 30", math: "P(30) = 1000·2^3" },
                    { text: "Calculate", math: "<strong>8000</strong>" }
                ]},
                keyPoints: [
                    "Exponential: P(t) = P₀·e^(kt) or P₀·2^(t/T)",
                    "Doubling time T: 2^(t/T) doubles when t = T",
                    "Half-life problems use similar formulas"
                ],
                mistakes: [
                    { wrong: "Multiplying by 3 instead of 2³", why: "3 doubling periods means 2³ = 8 times, not 3 times." },
                    { wrong: "Using linear growth", why: "Exponential growth compounds! Not P₀ + rate×t." }
                ],
                guided: {
                    problem: `Half-life of 5 years, A₀ = 80g. Find A(15).`,
                    steps: [
                        { label: "A(t) = A₀·(1/2)^(t/T)", value: "80·(1/2)^(15/5)" },
                        { label: "= 80·(1/2)³", value: "?" }
                    ],
                    answer: "10g",
                    answerLabel: "A(15) = ",
                    interactiveSteps: [
                        {
                            prompt: "15/5 = ?",
                            hint: "How many half-lives?",
                            answer: "3",
                            acceptableAnswers: ["3"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "(1/2)³ = ?",
                            hint: "1/2 × 1/2 × 1/2 = ?",
                            answer: "1/8",
                            acceptableAnswers: ["1/8", "0.125"],
                            commonMistakes: {}
                        },
                        {
                            prompt: "80 × 1/8 = ?",
                            hint: "80 divided by 8...",
                            answer: "10",
                            acceptableAnswers: ["10", "10g"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `After 2 doubling periods, population is:`, answer: "4 times original",
                    options: ["4 times original", "2 times original", "8 times original", "Doubled"],
                    mistakeAnalysis: {
                        "2 times original": "That's after 1 doubling. 2 doublings = 2² = 4 times.",
                        "8 times original": "That's 3 doublings (2³). 2 doublings = 2² = 4 times.",
                        "Doubled": "Doubled is 1 period. 2 periods = 2² = 4 times."
                    }}
            };
        },
        "Theoretical Mathematics": () => {
            return {
                goalProblem: `What does Gödel's Incompleteness Theorem state?`,
                teachingSteps: [
                    {
                        title: "What is Theoretical Mathematics?",
                        explanation: "<strong>Theoretical Mathematics</strong> explores foundational questions: What is provable? What is computable? What are the limits of mathematics?",
                        visual: "Foundations and limits of math"
                    },
                    {
                        title: "Gödel's First Incompleteness Theorem",
                        explanation: "In any consistent formal system capable of expressing arithmetic, there exist statements that are <strong>true but unprovable</strong> within the system.",
                        visual: "True ≠ Provable"
                    },
                    {
                        title: "What this means",
                        explanation: "Mathematics will always have gaps! No matter how many axioms we add, there will be true statements we cannot prove using those axioms alone.",
                        visual: "Completeness is impossible"
                    },
                    {
                        title: "Second Incompleteness Theorem",
                        explanation: "Such a system cannot prove its own consistency. You can't use math to prove math is consistent!",
                        visual: "Can't prove own consistency"
                    }
                ],
                finalAnswer: "There are true statements that cannot be proven within the system",
                answerExplanation: "Gödel showed that sufficiently powerful formal systems are necessarily incomplete - they contain true but unprovable statements.",
                example: { problem: `Gödel's Incompleteness Theorem`, steps: [
                    { text: "Any consistent system with arithmetic", math: "Has true unprovable statements" },
                    { text: "This is fundamental", math: "Math has inherent limitations" },
                    { text: "Key implication", math: "<strong>Completeness is impossible</strong>" }
                ]},
                keyPoints: [
                    "True statements may be unprovable",
                    "Consistency cannot be self-proven",
                    "Applies to systems containing arithmetic"
                ],
                mistakes: [
                    { wrong: "Thinking math is 'broken'", why: "Math still works! Just has inherent limitations." },
                    { wrong: "Applying to simple systems", why: "Only applies to systems complex enough for arithmetic." }
                ],
                guided: {
                    problem: `Can a formal system prove its own consistency?`,
                    steps: [
                        { label: "Gödel's 2nd theorem", value: "Addresses this directly" },
                        { label: "Answer", value: "?" }
                    ],
                    answer: "No",
                    answerLabel: "Answer: ",
                    interactiveSteps: [
                        {
                            prompt: "According to Gödel's second theorem, can a system prove its own consistency?",
                            hint: "This is the main result of the 2nd theorem...",
                            answer: "no",
                            acceptableAnswers: ["no", "No", "it cannot"],
                            commonMistakes: {
                                "yes": "Gödel proved this is impossible for sufficiently powerful systems!"
                            }
                        }
                    ]
                },
                practice: { problem: `Gödel's theorem applies to systems that can express:`, answer: "Arithmetic",
                    options: ["Arithmetic", "Any math", "Only geometry", "Only set theory"],
                    mistakeAnalysis: {
                        "Any math": "Only systems powerful enough to express arithmetic.",
                        "Only geometry": "Euclidean geometry is actually complete!",
                        "Only set theory": "Applies to arithmetic and systems containing it."
                    }}
            };
        },
        "Advanced Computational Methods": () => {
            return {
                goalProblem: `What is the time complexity of binary search?`,
                teachingSteps: [
                    {
                        title: "What are Computational Methods?",
                        explanation: "<strong>Computational Methods</strong> study algorithms, complexity, and numerical techniques for solving problems with computers.",
                        visual: "Algorithms + Complexity + Numerical Methods"
                    },
                    {
                        title: "Big-O notation",
                        explanation: "<strong>Big-O</strong> describes how an algorithm's time/space grows with input size n.<br><br>Common: O(1), O(log n), O(n), O(n²), O(2ⁿ)",
                        visual: "O(1) < O(log n) < O(n) < O(n²)"
                    },
                    {
                        title: "Binary search analysis",
                        explanation: "Binary search halves the search space each step.<br><br>n → n/2 → n/4 → ... → 1<br><br>Takes log₂(n) steps.",
                        visual: "Each step halves the problem"
                    },
                    {
                        title: "Conclusion",
                        explanation: "Binary search has time complexity <strong>O(log n)</strong>.<br><br>For n = 1,000,000: only ~20 comparisons needed!",
                        visual: "O(log n)"
                    }
                ],
                finalAnswer: "O(log n)",
                answerExplanation: "Binary search halves the search space each iteration, requiring log₂(n) steps.",
                example: { problem: `Binary search complexity`, steps: [
                    { text: "Each step halves the space", math: "n → n/2 → n/4 → ..." },
                    { text: "Number of halvings to reach 1", math: "log₂(n)" },
                    { text: "Time complexity", math: "<strong>O(log n)</strong>" }
                ]},
                keyPoints: [
                    "O(log n): halving problems (binary search, balanced BST)",
                    "O(n): linear scan, simple loops",
                    "O(n²): nested loops, naive sorting"
                ],
                mistakes: [
                    { wrong: "Thinking binary search is O(n)", why: "That's linear search! Binary search is O(log n)." },
                    { wrong: "Confusing log n with n", why: "log₂(1,000,000) ≈ 20, not 1,000,000." }
                ],
                guided: {
                    problem: `What's the complexity of a simple loop from 1 to n?`,
                    steps: [
                        { label: "Loop runs n times", value: "Each iteration is O(1)" },
                        { label: "Total", value: "?" }
                    ],
                    answer: "O(n)",
                    answerLabel: "Complexity: ",
                    interactiveSteps: [
                        {
                            prompt: "A loop that runs n times has what complexity?",
                            hint: "Directly proportional to n...",
                            answer: "O(n)",
                            acceptableAnswers: ["O(n)", "linear", "n"],
                            commonMistakes: {
                                "O(1)": "O(1) is constant time. A loop running n times is O(n)."
                            }
                        }
                    ]
                },
                practice: { problem: `Nested loops (both 1 to n) have complexity:`, answer: "O(n²)",
                    options: ["O(n²)", "O(n)", "O(2n)", "O(log n)"],
                    mistakeAnalysis: {
                        "O(n)": "That's one loop. Nested = n × n = n².",
                        "O(2n)": "O(2n) = O(n). Nested loops give O(n²).",
                        "O(log n)": "That's for halving problems. Nested loops = O(n²)."
                    }}
            };
        }
    }
};

// Generate lesson for any tier/skill (falls back to basic template)
// Supports progressive sub-skills: lessons with hasSubSkills=true contain an array of sub-lessons
function generateLesson(tier, skill, subSkillIndex = null) {
    if (lessons[tier] && lessons[tier][skill]) {
        const lessonData = lessons[tier][skill]();

        // Check if this lesson has progressive sub-skills
        if (lessonData.hasSubSkills && lessonData.subSkills) {
            // Initialize completed sub-skills tracking if not exists
            const key = `${tier}_${skill}`;
            if (!state.completedSubSkills[key]) {
                state.completedSubSkills[key] = [];
            }

            // Determine which sub-skill to show
            let targetIndex = subSkillIndex;
            if (targetIndex === null) {
                // Find first incomplete sub-skill
                targetIndex = 0;
                for (let i = 0; i < lessonData.subSkills.length; i++) {
                    if (!state.completedSubSkills[key].includes(lessonData.subSkills[i].id)) {
                        targetIndex = i;
                        break;
                    }
                }
            }

            // Clamp to valid range
            targetIndex = Math.max(0, Math.min(targetIndex, lessonData.subSkills.length - 1));
            state.currentSubSkillIndex = targetIndex;

            // Get the specific sub-skill lesson
            const subSkill = lessonData.subSkills[targetIndex];

            // Return sub-skill with metadata about the parent skill
            return {
                ...subSkill,
                // Add sub-skill navigation metadata
                _isSubSkill: true,
                _parentSkill: skill,
                _subSkillIndex: targetIndex,
                _totalSubSkills: lessonData.subSkills.length,
                _subSkillId: subSkill.id,
                _subSkillName: subSkill.name,
                _allSubSkills: lessonData.subSkills.map((s, i) => ({
                    id: s.id,
                    name: s.name,
                    completed: state.completedSubSkills[key].includes(s.id),
                    current: i === targetIndex
                }))
            };
        }

        return lessonData;
    }
    // No generic fallback - all lessons must be explicitly defined with proper steps
    console.warn(`Lesson not found: Tier ${tier}, Skill: ${skill}`);
    return null;
}

// Mark a sub-skill as completed
function completeSubSkill(tier, skill, subSkillId) {
    const key = `${tier}_${skill}`;
    if (!state.completedSubSkills[key]) {
        state.completedSubSkills[key] = [];
    }
    if (!state.completedSubSkills[key].includes(subSkillId)) {
        state.completedSubSkills[key].push(subSkillId);
        // Save progress to localStorage
        saveSubSkillProgress();
    }
}

// Save sub-skill progress to localStorage
function saveSubSkillProgress() {
    try {
        const userId = getUserId();
        const key = userId ? `subskill_progress_${userId}` : 'subskill_progress';
        localStorage.setItem(key, JSON.stringify(state.completedSubSkills));
    } catch (e) {
        console.warn('Could not save sub-skill progress:', e);
    }
}

// Load sub-skill progress from localStorage
function loadSubSkillProgress() {
    try {
        const userId = getUserId();
        const key = userId ? `subskill_progress_${userId}` : 'subskill_progress';
        const saved = localStorage.getItem(key);
        if (saved) {
            state.completedSubSkills = JSON.parse(saved);
        }
    } catch (e) {
        console.warn('Could not load sub-skill progress:', e);
        state.completedSubSkills = {};
    }
}

// Check if all sub-skills for a domain are complete
function areAllSubSkillsComplete(tier, skill) {
    if (!lessons[tier] || !lessons[tier][skill]) return true;
    const lessonData = lessons[tier][skill]();
    if (!lessonData.hasSubSkills) return true;

    const key = `${tier}_${skill}`;
    const completed = state.completedSubSkills[key] || [];
    return lessonData.subSkills.every(s => completed.includes(s.id));
}

// Get list of unlocked question types based on completed sub-skills
function getUnlockedQuestionTypes(tier, skill) {
    if (!lessons[tier] || !lessons[tier][skill]) return null; // null = all unlocked
    const lessonData = lessons[tier][skill]();
    if (!lessonData.hasSubSkills) return null; // no sub-skills = all unlocked

    const key = `${tier}_${skill}`;
    const completed = state.completedSubSkills[key] || [];

    // Return array of completed sub-skill IDs that can be used for practice
    return completed.length > 0 ? completed : null;
}

// ========================================
// GENERATE QUESTION
// ========================================
function generateQuestion(tier, domain = null) {
    const tierGens = generators[tier];
    if (!tierGens) return null;

    const allDomains = Object.keys(tierGens);
    let selectedDomain;

    if (domain && tierGens[domain]) {
        // Specific domain requested
        selectedDomain = domain;
    } else if (state.mode === 'placement') {
        // In placement mode, prioritize untested domains for comprehensive coverage
        if (!state.testedDomains[tier]) {
            state.testedDomains[tier] = new Set();
        }

        // Find domains not yet tested in this tier
        const untestedDomains = allDomains.filter(d => !state.testedDomains[tier].has(d));

        if (untestedDomains.length > 0) {
            // Pick from untested domains first
            selectedDomain = pick(untestedDomains);
        } else {
            // All domains tested, reset and pick any (allows retesting for accuracy)
            state.testedDomains[tier].clear();
            selectedDomain = pick(allDomains);
        }

        // Mark this domain as tested
        state.testedDomains[tier].add(selectedDomain);
    } else {
        // Testing center or learning - random selection
        selectedDomain = pick(allDomains);
    }

    const generator = tierGens[selectedDomain];
    
    const q = generator();
    q.tier = tier;
    q.domain = selectedDomain;
    q.type = q.type || "procedural";
    q.timeExpected = tier <= 2 ? 15 : tier <= 4 ? 20 : tier <= 6 ? 25 : tier <= 8 ? 30 : 35;
    
    // Generate options if not provided
    if (!q.options) {
        if (typeof q.answer === "number") {
            const distractors = generateDistractors(q.answer);
            q.options = shuffle([q.answer, ...distractors]);
            q.answerIndex = q.options.indexOf(q.answer);
        } else {
            q.options = [q.answer, ...generateDistractors(0, 3).map(d => `${d}`)];
            q.answerIndex = 0;
            q.options = shuffle(q.options);
            q.answerIndex = q.options.indexOf(q.answer);
        }
    } else {
        // Deduplicate options to prevent identical answer buttons, then shuffle
        q.options = shuffle(q.options.filter((v, i, a) => a.indexOf(v) === i));
        q.answerIndex = q.options.findIndex(o => o == q.answer || o === q.answer);
        if (q.answerIndex === -1) q.answerIndex = 0;
    }

    return q;
}

// ========================================
// STATE & UI MANAGEMENT
// ========================================
// (state is declared earlier in the file to avoid temporal dead zone errors)

function initTierGrid() {
    const grid = document.getElementById('tier-selection-grid');
    grid.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const div = document.createElement('div');
        div.className = 'tier-option';
        div.setAttribute('data-tier', t);
        div.onclick = () => toggleTier(t);
        div.innerHTML = `<div class="tier-checkbox"></div><div><div class="tier-name">Tier ${t}: ${TIERS[t].name}</div><div class="tier-grades">Grades ${TIERS[t].grades}</div></div>`;
        grid.appendChild(div);
    }
}
initTierGrid();

// ==================== SPARRING ARENA SETUP ====================

function initArenaSkillGrid() {
    const grid = document.getElementById('arena-skill-grid');
    const filter = document.getElementById('skill-tier-filter');
    if (!grid || !filter) return;

    // Populate tier filter dropdown
    filter.innerHTML = '<option value="all">All Tiers</option>';
    for (let t = 1; t <= 10; t++) {
        filter.innerHTML += `<option value="${t}">Tier ${t}: ${TIERS[t].name}</option>`;
    }

    renderArenaSkills('all');
}

function renderArenaSkills(tierFilter) {
    const grid = document.getElementById('arena-skill-grid');
    if (!grid) return;
    grid.innerHTML = '';

    for (let t = 1; t <= 10; t++) {
        if (tierFilter !== 'all' && t !== parseInt(tierFilter)) continue;

        const tierGens = generators[t];
        if (!tierGens) continue;

        const skills = Object.keys(tierGens);
        skills.forEach(skill => {
            const div = document.createElement('div');
            const skillState = getSkillState(skill);
            const isUnlocked = isSkillUnlocked(skill);
            const mastery = getSkillMastery(skill);

            div.className = 'skill-option';
            div.setAttribute('data-tier', t);
            div.setAttribute('data-skill', skill);

            // Add state-based styling
            if (!isUnlocked) {
                div.classList.add('locked');
            } else if (skillState === 'mastered') {
                div.classList.add('mastered');
            } else if (skillState === 'needs_review') {
                div.classList.add('needs-review');
            }

            // Check if already selected
            if (state.selectedSkills.some(s => s.tier === t && s.skill === skill)) {
                div.classList.add('selected');
            }

            // Build content
            let content = `<div style="color:var(--slate-200)">${skill}</div>`;
            content += `<div class="skill-tier">Tier ${t}</div>`;

            // Show mastery bar for unlocked skills
            if (isUnlocked && mastery > 0) {
                content += `<div class="skill-mastery-bar" style="margin-top:0.5rem"><div class="skill-mastery-fill" style="width:${mastery}%"></div></div>`;
            }

            // Show lock icon for locked skills
            if (!isUnlocked) {
                content += `<div style="font-size:0.8rem;color:var(--slate-500);margin-top:0.25rem">🔒 Locked</div>`;
            }

            // State badges
            if (skillState === 'mastered') {
                content += `<div style="font-size:0.7rem;color:var(--amber-400);margin-top:0.25rem">✓ Mastered</div>`;
            } else if (skillState === 'needs_review') {
                content += `<div style="font-size:0.7rem;color:var(--rose-400);margin-top:0.25rem">⟳ Review</div>`;
            }

            div.innerHTML = content;

            // Only allow selection if unlocked
            if (isUnlocked) {
                div.onclick = () => toggleSkillSelection(t, skill);
            } else {
                div.onclick = () => showLockedSkillInfo(skill);
            }

            grid.appendChild(div);
        });
    }
}

function filterSkillsByTier() {
    const filter = document.getElementById('skill-tier-filter');
    renderArenaSkills(filter.value);
}

function setSelectionMode(mode) {
    state.arenaSelectionMode = mode;

    document.getElementById('select-by-tier-btn').classList.toggle('active', mode === 'tier');
    document.getElementById('select-by-skill-btn').classList.toggle('active', mode === 'skill');
    document.getElementById('select-needs-practice-btn').classList.toggle('active', mode === 'needs-practice');

    document.getElementById('tier-selection-panel').style.display = mode === 'tier' ? 'block' : 'none';
    document.getElementById('skill-selection-panel').style.display = mode === 'skill' ? 'block' : 'none';
    document.getElementById('needs-practice-panel').style.display = mode === 'needs-practice' ? 'block' : 'none';

    if (mode === 'skill') {
        initArenaSkillGrid();
    } else if (mode === 'needs-practice') {
        loadNeedsPracticeSkills();
    }

    updateArenaStartButton();
}

// ========================================
// NEEDS PRACTICE MODE
// ========================================

// Get skills that need practice from the skill tree
function getNeedsPracticeSkills() {
    const needsPractice = [];

    // Go through all skills in the tree data
    for (const [skillName, data] of Object.entries(skillTreeData.skills)) {
        if (!data) continue;

        const state = data.state;
        const mastery = data.mastery_score || 0;
        const lastPracticed = data.last_practiced;
        const decayRate = data.decay_rate || 14;

        // Calculate days since practice
        let daysSince = Infinity;
        if (lastPracticed) {
            daysSince = Math.floor((Date.now() - new Date(lastPracticed).getTime()) / (1000 * 60 * 60 * 24));
        }

        // Calculate priority (higher = more urgent)
        let priority = 0;
        let reason = '';

        // Needs review (decayed)
        if (state === 'needs_review') {
            priority = 100;
            reason = 'Needs review';
        }
        // Mastered but decaying
        else if ((state === 'mastered' || state === 'activated') && daysSince > decayRate) {
            priority = 80 + Math.min(daysSince - decayRate, 20);
            reason = `${daysSince} days since practice`;
        }
        // In progress (started but not mastered)
        else if (state === 'in_progress') {
            priority = 60 + (100 - mastery) / 2;
            reason = `In progress (${mastery}%)`;
        }
        // Activated but low mastery
        else if (state === 'activated' && mastery < 85) {
            priority = 40 + (85 - mastery);
            reason = `Building mastery (${mastery}%)`;
        }
        // Available but never practiced
        else if (state === 'available' && !lastPracticed) {
            priority = 30;
            reason = 'Ready to learn';
        }
        // Stale (7-14 days since practice)
        else if ((state === 'mastered' || state === 'activated') && daysSince > 7) {
            priority = 20 + daysSince;
            reason = `Getting stale (${daysSince} days)`;
        }

        if (priority > 0) {
            // Find the Dojo domain name for this skill
            const dojoInfo = findDojoSkillInfo(skillName);
            if (dojoInfo) {
                needsPractice.push({
                    skill: skillName,
                    domain: dojoInfo.domain,
                    tier: dojoInfo.tier,
                    priority,
                    reason,
                    mastery,
                    state,
                    daysSince
                });
            }
        }
    }

    // Sort by priority (highest first)
    needsPractice.sort((a, b) => b.priority - a.priority);

    return needsPractice;
}

// Find the Dojo tier and domain for a tree skill name
function findDojoSkillInfo(treeSkillName) {
    for (let tier = 1; tier <= 10; tier++) {
        const tierGens = generators[tier];
        if (!tierGens) continue;

        for (const domain of Object.keys(tierGens)) {
            const mappedName = getTreeSkillName(domain);
            if (mappedName === treeSkillName || domain === treeSkillName) {
                return { tier, domain };
            }
        }
    }
    return null;
}

// Load and render needs practice skills
function loadNeedsPracticeSkills() {
    const skills = getNeedsPracticeSkills();
    const grid = document.getElementById('needs-practice-grid');
    const summary = document.getElementById('needs-practice-summary');
    const noSkills = document.getElementById('no-needs-practice');

    if (skills.length === 0) {
        grid.style.display = 'none';
        summary.style.display = 'none';
        noSkills.style.display = 'block';
        state.selectedSkills = [];
        updateArenaStartButton();
        return;
    }

    grid.style.display = 'grid';
    summary.style.display = 'block';
    noSkills.style.display = 'none';

    // Show summary
    const urgent = skills.filter(s => s.priority >= 80).length;
    const moderate = skills.filter(s => s.priority >= 40 && s.priority < 80).length;
    const light = skills.filter(s => s.priority < 40).length;

    summary.innerHTML = `
        <div style="display:flex;gap:1.5rem;flex-wrap:wrap;">
            ${urgent > 0 ? `<div style="color:var(--rose-400);"><strong>${urgent}</strong> urgent</div>` : ''}
            ${moderate > 0 ? `<div style="color:var(--amber-400);"><strong>${moderate}</strong> moderate</div>` : ''}
            ${light > 0 ? `<div style="color:var(--cyan-400);"><strong>${light}</strong> light</div>` : ''}
            <div style="color:var(--slate-400);margin-left:auto;">${skills.length} skills total</div>
        </div>
    `;

    // Render skills (top 20 for performance)
    grid.innerHTML = '';
    const displaySkills = skills.slice(0, 20);

    displaySkills.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'skill-option needs-practice-skill selected';
        div.setAttribute('data-tier', s.tier);
        div.setAttribute('data-skill', s.domain);
        div.style.position = 'relative';

        // Priority color
        let priorityColor = 'var(--cyan-500)';
        let priorityLabel = 'Low';
        if (s.priority >= 80) {
            priorityColor = 'var(--rose-500)';
            priorityLabel = 'Urgent';
        } else if (s.priority >= 40) {
            priorityColor = 'var(--amber-500)';
            priorityLabel = 'Med';
        }

        div.innerHTML = `
            <div class="priority-badge" style="background:${priorityColor}">${priorityLabel}</div>
            <div style="color:var(--slate-200);font-weight:500;">${s.domain}</div>
            <div class="skill-tier">Tier ${s.tier}</div>
            <div style="font-size:0.75rem;color:var(--slate-500);margin-top:0.25rem;">${s.reason}</div>
        `;

        div.onclick = () => toggleNeedsPracticeSkill(s.tier, s.domain, div);
        grid.appendChild(div);
    });

    // Auto-select all needs practice skills
    state.selectedSkills = displaySkills.map(s => ({ tier: s.tier, skill: s.domain }));
    updateArenaStartButton();
}

// Toggle selection for needs practice skill
function toggleNeedsPracticeSkill(tier, skill, element) {
    const idx = state.selectedSkills.findIndex(s => s.tier === tier && s.skill === skill);

    if (idx > -1) {
        state.selectedSkills.splice(idx, 1);
        element.classList.remove('selected');
    } else {
        state.selectedSkills.push({ tier, skill });
        element.classList.add('selected');
    }

    updateArenaStartButton();
}

function toggleSkillSelection(tier, skill) {
    // Check if skill is unlocked
    if (!isSkillUnlocked(skill)) {
        showLockedSkillInfo(skill);
        return;
    }

    const idx = state.selectedSkills.findIndex(s => s.tier === tier && s.skill === skill);
    const el = document.querySelector(`.skill-option[data-tier="${tier}"][data-skill="${skill}"]`);

    if (idx > -1) {
        state.selectedSkills.splice(idx, 1);
        if (el) el.classList.remove('selected');
    } else {
        state.selectedSkills.push({ tier, skill });
        if (el) el.classList.add('selected');
    }

    updateArenaStartButton();
}

function selectAllSkills() {
    state.selectedSkills = [];
    const filter = document.getElementById('skill-tier-filter').value;

    for (let t = 1; t <= 10; t++) {
        if (filter !== 'all' && t !== parseInt(filter)) continue;
        const tierGens = generators[t];
        if (!tierGens) continue;
        Object.keys(tierGens).forEach(skill => {
            // Only add unlocked skills
            if (isSkillUnlocked(skill)) {
                state.selectedSkills.push({ tier: t, skill });
            }
        });
    }

    // Update visual selection (only for unlocked skills)
    document.querySelectorAll('.skill-option').forEach(el => {
        if (!el.classList.contains('locked')) {
            el.classList.add('selected');
        }
    });
    updateArenaStartButton();
}

function clearSkillSelection() {
    state.selectedSkills = [];
    document.querySelectorAll('.skill-option').forEach(el => el.classList.remove('selected'));
    updateArenaStartButton();
}

function setPracticeMode(mode) {
    state.practiceMode = mode;

    document.querySelectorAll('.mode-option').forEach(el => {
        el.classList.toggle('selected', el.getAttribute('data-practice-mode') === mode);
    });

    document.getElementById('timed-options').style.display = mode === 'timed' ? 'block' : 'none';
    document.getElementById('countdown-options').style.display = mode === 'countdown' ? 'block' : 'none';
}

function setTimeLimit(seconds) {
    state.timeLimit = seconds;
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.getAttribute('data-time')) === seconds);
    });
    // Clear custom input if a preset was selected
    const customInput = document.getElementById('custom-time-input');
    if (customInput) customInput.value = '';
}

function setCustomTimeLimit() {
    const input = document.getElementById('custom-time-input');
    const minutes = parseInt(input.value);
    if (minutes && minutes >= 1 && minutes <= 60) {
        state.timeLimit = minutes * 60;
        // Deselect all preset buttons
        document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
    }
}

function setQuestionCount(count) {
    state.questionGoal = count;
    document.querySelectorAll('.count-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.getAttribute('data-count')) === count);
    });
    // Clear custom input if a preset was selected
    const customInput = document.getElementById('custom-count-input');
    if (customInput) customInput.value = '';
}

function setCustomQuestionCount() {
    const input = document.getElementById('custom-count-input');
    const count = parseInt(input.value);
    if (count && count >= 1 && count <= 500) {
        state.questionGoal = count;
        // Deselect all preset buttons
        document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('selected'));
    }
}

function updateArenaStartButton() {
    let hasSelection = false;
    if (state.arenaSelectionMode === 'tier') {
        hasSelection = state.selectedTiers.length > 0;
    } else if (state.arenaSelectionMode === 'skill' || state.arenaSelectionMode === 'needs-practice') {
        hasSelection = state.selectedSkills.length > 0;
    }
    document.getElementById('start-testing-btn').disabled = !hasSelection;
}

function selectMode(mode) {
    state.mode = mode;
    document.getElementById('mode-screen').classList.remove('active');
    if (mode === 'placement') {
        document.getElementById('placement-setup-screen').classList.add('active');
    } else if (mode === 'testing') {
        document.getElementById('testing-setup-screen').classList.add('active');
    } else if (mode === 'learning') {
        initLearningSetup();
        document.getElementById('learning-setup-screen').classList.add('active');
    }
}

function goToModeSelect() {
    resetState();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('mode-screen').classList.add('active');
}

function resetState() {
    state = { mode: null, currentTier: 5, selectedTiers: [], history: [], tierScores: {}, domainScores: {}, gapLog: [], currentQuestion: null, selectedAnswer: null, startTime: null, timerInterval: null, elapsedTime: 0, consecutiveCorrect: 0, consecutiveWrong: 0, currentStreak: 0, probeMode: false,
        learningTier: 1, learningSkill: null, learningPhase: 'learn', currentLesson: null, guidedStep: 0, practiceAttempts: 0, practiceCorrect: 0,
        testedDomains: {},
        arenaSelectionMode: 'tier', selectedSkills: [], practiceMode: 'endless', timeLimit: 60, questionGoal: 10, arenaStartTime: null, arenaTimeRemaining: 0
    };
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.tier-option').forEach(o => o.classList.remove('selected'));
    document.querySelectorAll('.skill-option').forEach(o => o.classList.remove('selected'));
    document.getElementById('start-placement-btn').disabled = true;
    document.getElementById('start-testing-btn').disabled = true;

    // Reset arena selection mode buttons and panels
    document.getElementById('select-by-tier-btn')?.classList.add('active');
    document.getElementById('select-by-skill-btn')?.classList.remove('active');
    document.getElementById('select-needs-practice-btn')?.classList.remove('active');
    document.getElementById('tier-selection-panel').style.display = 'block';
    document.getElementById('skill-selection-panel').style.display = 'none';
    document.getElementById('needs-practice-panel').style.display = 'none';
}

function selectLevel(el, tier) {
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    state.currentTier = tier;
    document.getElementById('start-placement-btn').disabled = false;
}

function toggleTier(tier) {
    const opt = document.querySelector(`.tier-option[data-tier="${tier}"]`);
    const idx = state.selectedTiers.indexOf(tier);
    if (idx > -1) { state.selectedTiers.splice(idx, 1); opt.classList.remove('selected'); }
    else { state.selectedTiers.push(tier); opt.classList.add('selected'); }
    updateArenaStartButton();
}

function selectAllTiers() { for (let t = 1; t <= 10; t++) if (!state.selectedTiers.includes(t)) toggleTier(t); }
function clearTierSelection() { [...state.selectedTiers].forEach(t => toggleTier(t)); }
function selectTierRange(a, b) { clearTierSelection(); for (let t = a; t <= b; t++) toggleTier(t); }

function initScores() { 
    for (let i = 1; i <= 10; i++) {
        state.tierScores[i] = { correct: 0, total: 0, times: [] };
        state.domainScores[i] = {};
    }
}

function startPlacementTest() {
    initScores();
    startSessionTracking('placement');
    setupTestUI(false);
    document.getElementById('placement-setup-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');
    loadQuestion();
}

function startTestingCenter() {
    initScores();
    startSessionTracking('testing');

    // Set current tier based on selection mode
    if (state.arenaSelectionMode === 'tier') {
        state.currentTier = Math.min(...state.selectedTiers);
    } else {
        // For skill mode, set current tier from first selected skill
        state.currentTier = state.selectedSkills.length > 0 ? state.selectedSkills[0].tier : 1;
    }

    // Initialize arena timer
    state.arenaStartTime = Date.now();
    state.arenaTimeRemaining = state.timeLimit;

    setupTestUI(true);
    document.getElementById('testing-setup-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');

    // Start arena timer if in timed mode
    if (state.practiceMode === 'timed') {
        startArenaTimer();
    }

    loadQuestion();
}

let arenaTimerInterval = null;

function startArenaTimer() {
    if (arenaTimerInterval) clearInterval(arenaTimerInterval);

    arenaTimerInterval = setInterval(() => {
        const elapsed = (Date.now() - state.arenaStartTime) / 1000;
        state.arenaTimeRemaining = Math.max(0, state.timeLimit - elapsed);

        // Update display
        updateArenaTimerDisplay();

        // Check if time is up
        if (state.arenaTimeRemaining <= 0) {
            clearInterval(arenaTimerInterval);
            arenaTimerInterval = null;
            endArenaSession('time');
        }
    }, 100);
}

function updateArenaTimerDisplay() {
    const display = document.getElementById('arena-timer-display');
    if (!display) return;

    if (state.practiceMode === 'timed') {
        const mins = Math.floor(state.arenaTimeRemaining / 60);
        const secs = Math.floor(state.arenaTimeRemaining % 60);
        display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        display.style.color = state.arenaTimeRemaining < 10 ? 'var(--red-400)' : 'var(--cyan-400)';
    } else if (state.practiceMode === 'countdown') {
        const remaining = state.questionGoal - state.history.length;
        display.textContent = `${remaining} left`;
    } else {
        const elapsed = Math.floor((Date.now() - state.arenaStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

function endArenaSession(reason = 'manual') {
    if (arenaTimerInterval) {
        clearInterval(arenaTimerInterval);
        arenaTimerInterval = null;
    }
    endTest();
}

function setupTestUI(isTC) {
    const header = document.getElementById('test-header');
    header.classList.toggle('testing-center-header', isTC);
    document.getElementById('tc-stats-bar').style.display = isTC ? 'flex' : 'none';
    document.getElementById('end-session-btn').style.display = isTC ? 'inline-flex' : 'none';
    document.getElementById('idk-btn').style.display = isTC ? 'none' : 'inline-flex';
    document.getElementById('test-screen').classList.toggle('testing-center-mode', isTC);
    const btnClass = isTC ? 'btn btn-cyan' : 'btn btn-primary';
    document.getElementById('submit-btn').className = btnClass;
    document.getElementById('next-btn').className = btnClass;
}

// Helper function to get tier accuracy
function getTierAccuracy(tier) {
    const ts = state.tierScores[tier];
    if (!ts || ts.total === 0) return null;
    return (ts.correct / ts.total) * 100;
}

// Helper function to determine adaptive tier based on recent performance
function getAdaptiveTier() {
    // Find the current working tier (where we have good but not perfect accuracy)
    // Move up if doing well (>80%), move down if struggling (<50%)

    let workingTier = state.currentTier;

    // Check recent history (last 5 questions at current working tier)
    const recentAtTier = state.history.filter(h => h.tier === workingTier).slice(-5);
    if (recentAtTier.length >= 3) {
        const recentCorrect = recentAtTier.filter(h => h.correct).length;
        const recentAcc = (recentCorrect / recentAtTier.length) * 100;

        if (recentAcc >= 80 && workingTier < 10) {
            // Doing great, try harder tier
            workingTier = Math.min(10, workingTier + 1);
        } else if (recentAcc < 50 && workingTier > 1) {
            // Struggling, try easier tier
            workingTier = Math.max(1, workingTier - 1);
        }
    }

    return workingTier;
}

function loadQuestion() {
    // Placement test: dynamic length based on convergence (min 20, max 40)
    const minQuestions = 20;
    const maxQuestions = 40;

    if (state.mode === 'placement') {
        // Check if we've converged on a stable tier
        if (state.history.length >= minQuestions) {
            const hasConverged = checkPlacementConvergence();
            if (hasConverged || state.history.length >= maxQuestions) {
                endTest();
                return;
            }
        }
    }

    let targetTier = state.currentTier;
    state.probeMode = false;

    if (state.mode === 'placement') {
        // Fully adaptive placement test algorithm:
        // 1. Start at selected tier, test 3 questions
        // 2. If >66% correct, move up a tier; if <33% correct, move down
        // 3. Continue until we find the "edge" tier (50-80% accuracy)
        // 4. Once edge is found, test domains within that tier and adjacent tiers
        // 5. Periodically probe 2-3 tiers above/below to ensure we haven't missed anything

        const qNum = state.history.length;

        // Phase 1 (Q0-2): Initial calibration at starting tier
        if (qNum < 3) {
            targetTier = state.currentTier;
        }
        // Phase 2 (Q3+): Adaptive tier selection
        else {
            // Get current tier's accuracy
            const currentAcc = getTierAccuracy(state.currentTier);

            // Every 5 questions, do a probe of a distant tier
            if (qNum % 5 === 0 && qNum > 0) {
                state.probeMode = true;
                // Probe higher if doing well, lower if struggling
                if (currentAcc !== null && currentAcc >= 60) {
                    // Probe 2-3 tiers above current
                    const probeUp = Math.min(10, state.currentTier + rand(2, 3));
                    targetTier = probeUp;
                } else {
                    // Probe 2-3 tiers below current
                    const probeDown = Math.max(1, state.currentTier - rand(2, 3));
                    targetTier = probeDown;
                }
            }
            // Regular adaptive selection
            else {
                targetTier = getAdaptiveTier();

                // Update working tier if we've moved
                if (targetTier !== state.currentTier) {
                    const tierAcc = getTierAccuracy(targetTier);
                    // Only commit to new tier if we have evidence it's appropriate
                    if (tierAcc === null || (tierAcc >= 30 && tierAcc <= 90)) {
                        state.currentTier = targetTier;
                    }
                }
            }
        }

        // Ensure we're testing within bounds
        targetTier = Math.max(1, Math.min(10, targetTier));
    }

    // Testing center / Sparring Arena logic
    let selectedDomain = null;

    if (state.mode === 'testing') {
        // Check if countdown mode goal reached
        if (state.practiceMode === 'countdown' && state.history.length >= state.questionGoal) {
            endArenaSession('goal');
            return;
        }

        // Skill-based selection (includes 'skill' and 'needs-practice' modes)
        if ((state.arenaSelectionMode === 'skill' || state.arenaSelectionMode === 'needs-practice') && state.selectedSkills.length > 0) {
            // For needs-practice mode, prioritize higher priority skills by shuffling with weight
            if (state.arenaSelectionMode === 'needs-practice') {
                // Random selection weighted toward earlier skills (higher priority)
                const weightedIdx = Math.floor(Math.pow(Math.random(), 1.5) * state.selectedSkills.length);
                const selected = state.selectedSkills[weightedIdx];
                targetTier = selected.tier;
                selectedDomain = selected.skill;
            } else {
                // Regular skill mode - cycle through selected skills
                const skillIdx = state.history.length % state.selectedSkills.length;
                const selected = state.selectedSkills[skillIdx];
                targetTier = selected.tier;
                selectedDomain = selected.skill;
            }
        }
        // Tier-based selection
        else if (state.selectedTiers.length > 0) {
            const sorted = [...state.selectedTiers].sort((a, b) => a - b);
            targetTier = sorted[state.history.length % sorted.length];
        }

        // Update arena timer display
        updateArenaTimerDisplay();
    }

    const q = generateQuestion(targetTier, selectedDomain);
    if (!q) { endTest(); return; }

    state.currentQuestion = q;
    state.selectedAnswer = null;
    renderQuestion();
    startTimer();
    updateProgress();
}

// Check if placement test has converged to a stable tier
function checkPlacementConvergence() {
    // Need at least 5 questions at the current tier
    const atCurrentTier = state.history.filter(h => h.tier === state.currentTier);
    if (atCurrentTier.length < 5) return false;

    // Check if accuracy is stable (between 40-80% suggests correct placement)
    const acc = getTierAccuracy(state.currentTier);
    if (acc === null) return false;

    // Also need to have tested adjacent tiers
    const tierAbove = state.currentTier < 10 ? getTierAccuracy(state.currentTier + 1) : 100;
    const tierBelow = state.currentTier > 1 ? getTierAccuracy(state.currentTier - 1) : 0;

    // Converged if: current tier is challenging but doable (40-80%)
    // AND tier above is harder (<60%) or we're at top
    // AND tier below is easier (>60%) or we're at bottom
    const currentInRange = acc >= 40 && acc <= 80;
    const aboveIsHarder = tierAbove === null || tierAbove < 60 || state.currentTier === 10;
    const belowIsEasier = tierBelow === null || tierBelow > 60 || state.currentTier === 1;

    return currentInRange && aboveIsHarder && belowIsEasier;
}

// ========================================
// VISUAL RENDERING SYSTEM
// ========================================

function setVisualAnswer(value) {
    state.visualAnswer = value;
    if (state.visualInteractive) {
        document.getElementById('submit-btn').disabled = false;
    }
}

function compareVisualAnswer(userAnswer, expectedAnswer, type) {
    if (type === 'numberline' || type === 'clock') {
        return Math.abs(userAnswer - expectedAnswer) < 0.01;
    }
    if (type === 'coordinate') {
        if (typeof expectedAnswer === 'string') {
            return userAnswer === expectedAnswer;
        }
        return userAnswer.x === expectedAnswer.x && userAnswer.y === expectedAnswer.y;
    }
    return userAnswer === expectedAnswer;
}

function renderVisual(visual) {
    const container = document.getElementById('visual-container');
    container.innerHTML = '';
    state.visualAnswer = null;
    state.visualType = null;
    state.visualInteractive = false;

    if (!visual) return;

    state.visualType = visual.type;
    state.visualInteractive = visual.mode === 'interactive';

    switch (visual.type) {
        case 'numberline':
            renderNumberLine(container, visual.data, visual.mode);
            break;
        case 'shape':
            renderShape(container, visual.data);
            break;
        case 'coordinate':
            renderCoordinatePlane(container, visual.data, visual.mode);
            break;
        case 'fraction':
            renderFractionVisual(container, visual.data);
            break;
        case 'clock':
            renderClockFace(container, visual.data, visual.mode);
            break;
        case 'chart':
            renderChart(container, visual.data);
            break;
    }
}

function renderNumberLine(container, data, mode) {
    const { min = 0, max = 20, step = 1, markers = [], target = null, initialValue = null } = data;
    const range = max - min;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-number-line';

    const track = document.createElement('div');
    track.className = 'dojo-number-line-track';

    // Create ticks and labels
    for (let v = min; v <= max; v += step) {
        const pct = ((v - min) / range) * 100;
        const tick = document.createElement('div');
        tick.className = 'dojo-number-line-tick' + (v % (step * 5) === 0 || v === min || v === max ? ' major' : '');
        tick.style.left = pct + '%';
        track.appendChild(tick);

        // Labels for major ticks
        if (v % (step * 5) === 0 || v === min || v === max || range <= 10) {
            const label = document.createElement('div');
            label.className = 'dojo-number-line-label';
            label.style.left = pct + '%';
            label.textContent = v;
            track.appendChild(label);
        }
    }

    // Fixed markers (display mode)
    markers.forEach(m => {
        const pct = ((m - min) / range) * 100;
        const marker = document.createElement('div');
        marker.className = 'dojo-number-line-fixed-marker';
        marker.style.left = pct + '%';
        track.appendChild(marker);
    });

    // Interactive marker
    if (mode === 'interactive') {
        const startVal = initialValue !== null ? initialValue : (min + max) / 2;
        let currentValue = startVal;

        const marker = document.createElement('div');
        marker.className = 'dojo-number-line-marker';
        marker.style.left = ((startVal - min) / range) * 100 + '%';

        const valueDisplay = document.createElement('div');
        valueDisplay.className = 'dojo-number-line-value';
        valueDisplay.textContent = startVal;
        marker.appendChild(valueDisplay);

        const updateMarker = (clientX) => {
            const rect = track.getBoundingClientRect();
            let pct = (clientX - rect.left) / rect.width;
            pct = Math.max(0, Math.min(1, pct));
            let val = min + pct * range;
            val = Math.round(val / step) * step;
            val = Math.max(min, Math.min(max, val));

            currentValue = val;
            marker.style.left = ((val - min) / range) * 100 + '%';
            valueDisplay.textContent = val;
            setVisualAnswer(val);
        };

        // Mouse events
        marker.addEventListener('mousedown', (e) => {
            e.preventDefault();
            marker.classList.add('dragging');
            const onMove = (e) => updateMarker(e.clientX);
            const onUp = () => {
                marker.classList.remove('dragging');
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });

        // Touch events
        marker.addEventListener('touchstart', (e) => {
            e.preventDefault();
            marker.classList.add('dragging');
        });
        wrapper.addEventListener('touchmove', (e) => {
            if (marker.classList.contains('dragging')) {
                updateMarker(e.touches[0].clientX);
            }
        });
        wrapper.addEventListener('touchend', () => {
            marker.classList.remove('dragging');
        });

        // Click on track
        track.addEventListener('click', (e) => {
            if (e.target === marker) return;
            updateMarker(e.clientX);
        });

        track.appendChild(marker);
        setVisualAnswer(startVal);
    }

    wrapper.appendChild(track);
    container.appendChild(wrapper);
}

function renderShape(container, data) {
    const { shape, dimensions = {}, showMeasurements = true, showAngles = false, highlightSides = [], shaded = 0 } = data;

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'dojo-shape-svg');
    svg.setAttribute('viewBox', '0 0 200 160');

    let path = '';
    let dimLines = [];
    let angleArcs = [];

    switch (shape) {
        case 'triangle': {
            const base = dimensions.base || 80;
            const height = dimensions.height || 70;
            const x1 = 100 - base/2, y1 = 130;
            const x2 = 100 + base/2, y2 = 130;
            const x3 = dimensions.isRight ? x1 : 100, y3 = 130 - height;
            path = `M${x1},${y1} L${x2},${y2} L${x3},${y3} Z`;
            if (showMeasurements) {
                dimLines.push({ x1, y1: y1+15, x2, y2: y2+15, label: dimensions.base || 'base', labelY: y1+28 });
                if (dimensions.height) {
                    dimLines.push({ x1: x3+10, y1: y3, x2: x3+10, y2: y1, label: height, labelX: x3+22, vertical: true });
                }
            }
            if (showAngles && dimensions.isRight) {
                angleArcs.push({ cx: x1, cy: y1, label: '90°' });
            }
            break;
        }
        case 'right-triangle': {
            // Right triangle for Pythagorean theorem problems
            const a = dimensions.a || 60;  // vertical leg
            const b = dimensions.b || 80;  // horizontal leg (base)
            // Scale to fit
            const scale = Math.min(80/Math.max(a, b), 1.5);
            const scaledA = a * scale;
            const scaledB = b * scale;
            const x1 = 60, y1 = 130;        // bottom-left (right angle)
            const x2 = 60 + scaledB, y2 = 130;  // bottom-right
            const x3 = 60, y3 = 130 - scaledA;   // top-left
            path = `M${x1},${y1} L${x2},${y2} L${x3},${y3} Z`;
            // Right angle indicator
            const sq = 12;
            const rightAnglePath = `M${x1+sq},${y1} L${x1+sq},${y1-sq} L${x1},${y1-sq}`;
            const rightAngleEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            rightAngleEl.setAttribute('d', rightAnglePath);
            rightAngleEl.setAttribute('fill', 'none');
            rightAngleEl.setAttribute('stroke', 'var(--slate-400)');
            rightAngleEl.setAttribute('stroke-width', '1.5');
            // Label sides a, b, c
            if (showMeasurements) {
                const isHighlight = (side) => highlightSides.includes(side);
                // Side 'a' - vertical leg (left side)
                dimLines.push({ x1: x1-12, y1: y3, x2: x1-12, y2: y1, label: dimensions.a, labelX: x1-25, vertical: true, highlight: isHighlight('a') });
                // Side 'b' - horizontal leg (bottom)
                dimLines.push({ x1, y1: y1+15, x2: x2, y2: y2+15, label: dimensions.b, labelY: y1+28, highlight: isHighlight('b') });
                // Side 'c' - hypotenuse (diagonal)
                const midX = (x2 + x3) / 2 + 12;
                const midY = (y2 + y3) / 2 - 5;
                dimLines.push({ x1: x2, y1: y2, x2: x3, y2: y3, label: dimensions.c, labelX: midX, labelY: midY, highlight: isHighlight('c') });
            }
            // Store right angle element to append after path
            svg._rightAngle = rightAngleEl;
            break;
        }
        case 'square': {
            const side = dimensions.side || 80;
            const x = 100 - side/2, y = 80 - side/2;
            path = `M${x},${y} L${x+side},${y} L${x+side},${y+side} L${x},${y+side} Z`;
            if (showMeasurements) {
                dimLines.push({ x1: x, y1: y+side+15, x2: x+side, y2: y+side+15, label: side, labelY: y+side+28 });
            }
            break;
        }
        case 'rectangle': {
            const width = dimensions.width || 100;
            const height = dimensions.height || 60;
            const x = 100 - width/2, y = 80 - height/2;
            path = `M${x},${y} L${x+width},${y} L${x+width},${y+height} L${x},${y+height} Z`;
            if (showMeasurements) {
                dimLines.push({ x1: x, y1: y+height+15, x2: x+width, y2: y+height+15, label: width, labelY: y+height+28 });
                dimLines.push({ x1: x-15, y1: y, x2: x-15, y2: y+height, label: height, labelX: x-28, vertical: true });
            }
            break;
        }
        case 'circle': {
            const r = dimensions.radius || 50;
            path = `M${100-r},80 A${r},${r} 0 1,1 ${100+r},80 A${r},${r} 0 1,1 ${100-r},80`;
            if (showMeasurements && dimensions.radius) {
                dimLines.push({ x1: 100, y1: 80, x2: 100+r, y2: 80, label: `r=${r}`, labelY: 72 });
            }
            break;
        }
        case 'pentagon': {
            const r = 50;
            const pts = [];
            for (let i = 0; i < 5; i++) {
                const angle = -Math.PI/2 + (2*Math.PI*i/5);
                pts.push([100 + r*Math.cos(angle), 80 + r*Math.sin(angle)]);
            }
            path = 'M' + pts.map(p => p.join(',')).join(' L') + ' Z';
            break;
        }
        case 'hexagon': {
            const r = 50;
            const pts = [];
            for (let i = 0; i < 6; i++) {
                const angle = (2*Math.PI*i/6);
                pts.push([100 + r*Math.cos(angle), 80 + r*Math.sin(angle)]);
            }
            path = 'M' + pts.map(p => p.join(',')).join(' L') + ' Z';
            break;
        }
        case 'cube': {
            // 3D cube representation
            const s = 50;
            const off = 20;
            path = `M60,100 L${60+s},100 L${60+s},${100-s} L60,${100-s} Z
                    M60,${100-s} L${60+off},${100-s-off} L${60+s+off},${100-s-off} L${60+s},${100-s}
                    M${60+s},100 L${60+s+off},${100-off} L${60+s+off},${100-s-off}`;
            break;
        }
        case 'cylinder': {
            const r = 35, h = 70;
            path = `M${100-r},50 A${r},12 0 1,1 ${100+r},50 A${r},12 0 1,1 ${100-r},50
                    M${100-r},50 L${100-r},${50+h} A${r},12 0 0,0 ${100+r},${50+h} L${100+r},50`;
            break;
        }
        case 'cone': {
            const r = 40, h = 80;
            path = `M100,40 L${100-r},${40+h} A${r},12 0 0,0 ${100+r},${40+h} Z`;
            break;
        }
        case 'sphere': {
            const r = 50;
            path = `M${100-r},80 A${r},${r} 0 1,1 ${100+r},80 A${r},${r} 0 1,1 ${100-r},80
                    M${100-r},80 Q100,${80+r*0.3} ${100+r},80`;
            break;
        }
    }

    const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    pathEl.setAttribute('d', path);
    pathEl.setAttribute('class', 'shape-fill' + (shaded ? ' shaded' : ''));
    svg.appendChild(pathEl);

    // Right angle indicator for right triangles
    if (svg._rightAngle) {
        svg.appendChild(svg._rightAngle);
    }

    // Dimension lines
    dimLines.forEach(d => {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', d.x1);
        line.setAttribute('y1', d.y1);
        line.setAttribute('x2', d.x2);
        line.setAttribute('y2', d.y2);
        line.setAttribute('class', 'dimension-line' + (d.highlight ? ' highlight' : ''));
        svg.appendChild(line);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', d.labelX || (d.x1 + d.x2) / 2);
        text.setAttribute('y', d.labelY || (d.y1 + d.y2) / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('class', 'dimension-text' + (d.highlight ? ' highlight' : ''));
        text.textContent = d.label;
        svg.appendChild(text);
    });

    // Angle arcs
    angleArcs.forEach(a => {
        const arc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        arc.setAttribute('d', `M${a.cx+15},${a.cy} A15,15 0 0,0 ${a.cx},${a.cy-15}`);
        arc.setAttribute('class', 'angle-arc');
        svg.appendChild(arc);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', a.cx + 20);
        text.setAttribute('y', a.cy - 8);
        text.setAttribute('class', 'angle-text');
        text.textContent = a.label;
        svg.appendChild(text);
    });

    container.appendChild(svg);
}

function renderCoordinatePlane(container, data, mode) {
    const { xRange = [-5, 5], yRange = [-5, 5], gridStep = 1, points = [], lines = [], curves = [],
            unitCircle = false, angleRadians = null, showAngleLabel = null, showQuadrantLabels = false,
            highlightQuadrant = null, showReferenceAngle = false, shadeRegion = null } = data;

    const width = 300, height = 300;
    const padding = 30;
    const plotWidth = width - 2*padding;
    const plotHeight = height - 2*padding;

    const xMin = xRange[0], xMax = xRange[1];
    const yMin = yRange[0], yMax = yRange[1];

    const toX = (x) => padding + ((x - xMin) / (xMax - xMin)) * plotWidth;
    const toY = (y) => padding + ((yMax - y) / (yMax - yMin)) * plotHeight;

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'dojo-coordinate-svg');
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

    // Grid lines
    for (let x = xMin; x <= xMax; x += gridStep) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', toX(x));
        line.setAttribute('y1', padding);
        line.setAttribute('x2', toX(x));
        line.setAttribute('y2', height - padding);
        line.setAttribute('class', 'grid-line');
        svg.appendChild(line);
    }
    for (let y = yMin; y <= yMax; y += gridStep) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', padding);
        line.setAttribute('y1', toY(y));
        line.setAttribute('x2', width - padding);
        line.setAttribute('y2', toY(y));
        line.setAttribute('class', 'grid-line');
        svg.appendChild(line);
    }

    // Axes
    const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxis.setAttribute('x1', padding);
    xAxis.setAttribute('y1', toY(0));
    xAxis.setAttribute('x2', width - padding);
    xAxis.setAttribute('y2', toY(0));
    xAxis.setAttribute('class', 'axis-line');
    svg.appendChild(xAxis);

    const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxis.setAttribute('x1', toX(0));
    yAxis.setAttribute('y1', padding);
    yAxis.setAttribute('x2', toX(0));
    yAxis.setAttribute('y2', height - padding);
    yAxis.setAttribute('class', 'axis-line');
    svg.appendChild(yAxis);

    // Axis labels
    for (let x = xMin; x <= xMax; x += gridStep) {
        if (x === 0) continue;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', toX(x));
        text.setAttribute('y', toY(0) + 15);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('class', 'axis-label');
        text.textContent = x;
        svg.appendChild(text);
    }
    for (let y = yMin; y <= yMax; y += gridStep) {
        if (y === 0) continue;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', toX(0) - 8);
        text.setAttribute('y', toY(y) + 4);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('class', 'axis-label');
        text.textContent = y;
        svg.appendChild(text);
    }

    // Unit circle
    if (unitCircle) {
        const cx = toX(0), cy = toY(0);
        const r = Math.min(plotWidth, plotHeight) / (xMax - xMin);

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', cx);
        circle.setAttribute('cy', cy);
        circle.setAttribute('r', r);
        circle.setAttribute('fill', 'none');
        circle.setAttribute('stroke', 'var(--violet-500)');
        circle.setAttribute('stroke-width', '2');
        svg.appendChild(circle);

        // Draw angle if specified
        if (angleRadians !== null) {
            const px = cx + r * Math.cos(angleRadians);
            const py = cy - r * Math.sin(angleRadians);

            // Radius line to angle
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', cx);
            line.setAttribute('y1', cy);
            line.setAttribute('x2', px);
            line.setAttribute('y2', py);
            line.setAttribute('stroke', 'var(--amber-500)');
            line.setAttribute('stroke-width', '2');
            svg.appendChild(line);

            // Point on circle
            const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            point.setAttribute('cx', px);
            point.setAttribute('cy', py);
            point.setAttribute('r', 5);
            point.setAttribute('fill', 'var(--amber-500)');
            svg.appendChild(point);

            // Angle arc
            if (angleRadians > 0.1) {
                const arcR = 20;
                const endX = cx + arcR * Math.cos(angleRadians);
                const endY = cy - arcR * Math.sin(angleRadians);
                const largeArc = angleRadians > Math.PI ? 1 : 0;
                const arc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                arc.setAttribute('d', `M${cx + arcR},${cy} A${arcR},${arcR} 0 ${largeArc},0 ${endX},${endY}`);
                arc.setAttribute('fill', 'none');
                arc.setAttribute('stroke', 'var(--emerald-400)');
                arc.setAttribute('stroke-width', '2');
                svg.appendChild(arc);
            }

            // Angle label
            if (showAngleLabel) {
                const labelR = 35;
                const labelX = cx + labelR * Math.cos(angleRadians / 2);
                const labelY = cy - labelR * Math.sin(angleRadians / 2);
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', labelX);
                label.setAttribute('y', labelY);
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('fill', 'var(--emerald-400)');
                label.setAttribute('font-size', '11px');
                label.textContent = showAngleLabel;
                svg.appendChild(label);
            }
        }
    }

    // Quadrant labels
    if (showQuadrantLabels) {
        const quads = [
            { label: 'I', x: (xMax + 0) / 2, y: (yMax + 0) / 2 },
            { label: 'II', x: (xMin + 0) / 2, y: (yMax + 0) / 2 },
            { label: 'III', x: (xMin + 0) / 2, y: (yMin + 0) / 2 },
            { label: 'IV', x: (xMax + 0) / 2, y: (yMin + 0) / 2 }
        ];
        quads.forEach(q => {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', toX(q.x));
            text.setAttribute('y', toY(q.y));
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('fill', highlightQuadrant === q.label ? 'var(--amber-400)' : 'var(--slate-500)');
            text.setAttribute('font-size', highlightQuadrant === q.label ? '16px' : '14px');
            text.setAttribute('font-weight', highlightQuadrant === q.label ? 'bold' : 'normal');
            text.textContent = q.label;
            svg.appendChild(text);
        });
    }

    // Draw lines/curves
    lines.forEach((lineData, idx) => {
        if (lineData.equation) {
            // y = mx + b format
            const { m, b } = lineData.equation;
            const pathPoints = [];
            for (let x = xMin; x <= xMax; x += 0.1) {
                const y = m * x + b;
                if (y >= yMin && y <= yMax) {
                    pathPoints.push([toX(x), toY(y)]);
                }
            }
            if (pathPoints.length > 1) {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M' + pathPoints.map(p => p.join(',')).join(' L'));
                path.setAttribute('class', 'graph-line' + (idx > 0 ? ' secondary' : ''));
                svg.appendChild(path);
            }
        } else if (lineData.points) {
            // Line through specific points
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = lineData.points.map((p, i) => (i === 0 ? 'M' : 'L') + toX(p.x) + ',' + toY(p.y)).join(' ');
            path.setAttribute('d', d);
            path.setAttribute('class', 'graph-line' + (idx > 0 ? ' secondary' : ''));
            svg.appendChild(path);
        }
    });

    // Draw curves (quadratic, circle, ellipse, hyperbola, trig)
    curves.forEach((curveData, idx) => {
        if (curveData.type === 'circle') {
            const { r = 1, h = 0, k = 0 } = curveData;
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            const scale = plotWidth / (xMax - xMin);
            circle.setAttribute('cx', toX(h));
            circle.setAttribute('cy', toY(k));
            circle.setAttribute('r', r * scale);
            circle.setAttribute('fill', 'none');
            circle.setAttribute('stroke', 'var(--emerald-500)');
            circle.setAttribute('stroke-width', '2');
            svg.appendChild(circle);
            return;
        }

        if (curveData.type === 'ellipse') {
            const { a = 1, b = 1, h = 0, k = 0 } = curveData;
            const scale = plotWidth / (xMax - xMin);
            const ellipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
            ellipse.setAttribute('cx', toX(h));
            ellipse.setAttribute('cy', toY(k));
            ellipse.setAttribute('rx', a * scale);
            ellipse.setAttribute('ry', b * scale);
            ellipse.setAttribute('fill', 'none');
            ellipse.setAttribute('stroke', 'var(--emerald-500)');
            ellipse.setAttribute('stroke-width', '2');
            svg.appendChild(ellipse);
            return;
        }

        const pathPoints = [];
        if (curveData.type === 'quadratic') {
            const { a, b, c } = curveData;
            for (let x = xMin; x <= xMax; x += 0.1) {
                const y = a*x*x + b*x + c;
                if (y >= yMin && y <= yMax) {
                    pathPoints.push([toX(x), toY(y)]);
                }
            }
        } else if (curveData.type === 'hyperbola') {
            // Draw both branches of hyperbola: x²/a² - y²/b² = 1
            const { a = 1, b = 1 } = curveData;
            // Right branch
            for (let x = a; x <= xMax; x += 0.1) {
                const y1 = b * Math.sqrt((x*x)/(a*a) - 1);
                const y2 = -y1;
                if (y1 >= yMin && y1 <= yMax) pathPoints.push([toX(x), toY(y1)]);
            }
            // Left branch (separate path)
            const leftPoints = [];
            for (let x = -a; x >= xMin; x -= 0.1) {
                const y1 = b * Math.sqrt((x*x)/(a*a) - 1);
                if (y1 >= yMin && y1 <= yMax) leftPoints.push([toX(x), toY(y1)]);
            }
            if (leftPoints.length > 1) {
                const leftPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                leftPath.setAttribute('d', 'M' + leftPoints.map(p => p.join(',')).join(' L'));
                leftPath.setAttribute('class', 'graph-line');
                svg.appendChild(leftPath);
            }
            // Bottom branches
            const bottomRight = [];
            for (let x = a; x <= xMax; x += 0.1) {
                const y = -b * Math.sqrt((x*x)/(a*a) - 1);
                if (y >= yMin && y <= yMax) bottomRight.push([toX(x), toY(y)]);
            }
            if (bottomRight.length > 1) {
                const brPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                brPath.setAttribute('d', 'M' + bottomRight.map(p => p.join(',')).join(' L'));
                brPath.setAttribute('class', 'graph-line');
                svg.appendChild(brPath);
            }
            const bottomLeft = [];
            for (let x = -a; x >= xMin; x -= 0.1) {
                const y = -b * Math.sqrt((x*x)/(a*a) - 1);
                if (y >= yMin && y <= yMax) bottomLeft.push([toX(x), toY(y)]);
            }
            if (bottomLeft.length > 1) {
                const blPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                blPath.setAttribute('d', 'M' + bottomLeft.map(p => p.join(',')).join(' L'));
                blPath.setAttribute('class', 'graph-line');
                svg.appendChild(blPath);
            }
        } else if (curveData.type === 'trig') {
            const { func, amplitude = 1, period = 2*Math.PI, phase = 0 } = curveData;
            for (let x = xMin; x <= xMax; x += 0.05) {
                let y;
                const angle = (2*Math.PI/period) * x + phase;
                if (func === 'sin') y = amplitude * Math.sin(angle);
                else if (func === 'cos') y = amplitude * Math.cos(angle);
                else if (func === 'tan') y = amplitude * Math.tan(angle);
                if (y >= yMin && y <= yMax && Math.abs(y) < 100) {
                    pathPoints.push([toX(x), toY(y)]);
                }
            }
        }
        if (pathPoints.length > 1) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M' + pathPoints.map(p => p.join(',')).join(' L'));
            path.setAttribute('class', 'graph-line');
            svg.appendChild(path);
        }
    });

    // Plot points
    points.forEach(p => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', toX(p.x));
        circle.setAttribute('cy', toY(p.y));
        circle.setAttribute('r', 5);
        circle.setAttribute('class', 'plot-point' + (p.interactive ? ' interactive' : ''));
        svg.appendChild(circle);

        if (p.label) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', toX(p.x) + 8);
            text.setAttribute('y', toY(p.y) - 8);
            text.setAttribute('class', 'point-label');
            text.textContent = p.label;
            svg.appendChild(text);
        }
    });

    // Interactive point placement
    if (mode === 'interactive' && data.targetPoint) {
        let placedPoint = null;

        svg.style.cursor = 'crosshair';
        svg.addEventListener('click', (e) => {
            const rect = svg.getBoundingClientRect();
            const scale = width / rect.width;
            const px = (e.clientX - rect.left) * scale;
            const py = (e.clientY - rect.top) * scale;

            const x = Math.round(xMin + ((px - padding) / plotWidth) * (xMax - xMin));
            const y = Math.round(yMax - ((py - padding) / plotHeight) * (yMax - yMin));

            if (x >= xMin && x <= xMax && y >= yMin && y <= yMax) {
                if (placedPoint) svg.removeChild(placedPoint);

                placedPoint = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                placedPoint.setAttribute('cx', toX(x));
                placedPoint.setAttribute('cy', toY(y));
                placedPoint.setAttribute('r', 6);
                placedPoint.setAttribute('class', 'plot-point interactive');
                svg.appendChild(placedPoint);

                setVisualAnswer({ x, y });
            }
        });
    }

    container.appendChild(svg);
}

function renderFractionVisual(container, data) {
    const { style = 'bar', numerator, denominator, compare = null } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-fraction-container';

    const createBar = (num, denom, label) => {
        const row = document.createElement('div');
        row.className = 'dojo-fraction-row';

        const bar = document.createElement('div');
        bar.className = 'dojo-fraction-bar';

        for (let i = 0; i < denom; i++) {
            const segment = document.createElement('div');
            segment.className = 'dojo-fraction-bar-segment' + (i < num ? ' filled' : '');
            bar.appendChild(segment);
        }

        row.appendChild(bar);

        if (label) {
            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-fraction-label';
            labelEl.textContent = label;
            row.appendChild(labelEl);
        }

        return row;
    };

    const createCircle = (num, denom, label) => {
        const row = document.createElement('div');
        row.className = 'dojo-fraction-row';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'dojo-fraction-circle');
        svg.setAttribute('viewBox', '0 0 100 100');

        for (let i = 0; i < denom; i++) {
            const startAngle = (i / denom) * 2 * Math.PI - Math.PI/2;
            const endAngle = ((i + 1) / denom) * 2 * Math.PI - Math.PI/2;
            const x1 = 50 + 40 * Math.cos(startAngle);
            const y1 = 50 + 40 * Math.sin(startAngle);
            const x2 = 50 + 40 * Math.cos(endAngle);
            const y2 = 50 + 40 * Math.sin(endAngle);
            const largeArc = (endAngle - startAngle > Math.PI) ? 1 : 0;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M50,50 L${x1},${y1} A40,40 0 ${largeArc},1 ${x2},${y2} Z`);
            path.setAttribute('class', 'slice' + (i < num ? ' filled' : ''));
            svg.appendChild(path);
        }

        row.appendChild(svg);

        if (label) {
            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-fraction-label';
            labelEl.textContent = label;
            row.appendChild(labelEl);
        }

        return row;
    };

    if (style === 'bar') {
        wrapper.appendChild(createBar(numerator, denominator, `${numerator}/${denominator}`));
        if (compare) {
            wrapper.appendChild(createBar(compare.numerator, compare.denominator, `${compare.numerator}/${compare.denominator}`));
        }
    } else {
        wrapper.appendChild(createCircle(numerator, denominator, `${numerator}/${denominator}`));
        if (compare) {
            wrapper.appendChild(createCircle(compare.numerator, compare.denominator, `${compare.numerator}/${compare.denominator}`));
        }
    }

    container.appendChild(wrapper);
}

function renderClockFace(container, data, mode) {
    const { hour = 12, minute = 0, interactive = false } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-clock-container';

    const canvas = document.createElement('canvas');
    canvas.className = 'dojo-clock-canvas';
    canvas.width = 160;
    canvas.height = 160;
    const ctx = canvas.getContext('2d');

    let currentHour = hour;
    let currentMinute = minute;
    let draggingHand = null;

    const drawClock = () => {
        const cx = 80, cy = 80, r = 70;

        ctx.clearRect(0, 0, 160, 160);

        // Clock face
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
        ctx.fillStyle = '#334155';
        ctx.fill();
        ctx.strokeStyle = '#64748b';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Hour markers
        for (let i = 1; i <= 12; i++) {
            const angle = (i / 12) * 2 * Math.PI - Math.PI/2;
            const x = cx + (r - 15) * Math.cos(angle);
            const y = cy + (r - 15) * Math.sin(angle);
            ctx.fillStyle = '#e2e8f0';
            ctx.font = '12px Source Sans 3';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(i.toString(), x, y);
        }

        // Tick marks
        for (let i = 0; i < 60; i++) {
            const angle = (i / 60) * 2 * Math.PI - Math.PI/2;
            const inner = i % 5 === 0 ? r - 8 : r - 5;
            const outer = r - 2;
            ctx.beginPath();
            ctx.moveTo(cx + inner * Math.cos(angle), cy + inner * Math.sin(angle));
            ctx.lineTo(cx + outer * Math.cos(angle), cy + outer * Math.sin(angle));
            ctx.strokeStyle = i % 5 === 0 ? '#94a3b8' : '#64748b';
            ctx.lineWidth = i % 5 === 0 ? 2 : 1;
            ctx.stroke();
        }

        // Hour hand
        const hourAngle = ((currentHour % 12) / 12 + currentMinute / 720) * 2 * Math.PI - Math.PI/2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + 35 * Math.cos(hourAngle), cy + 35 * Math.sin(hourAngle));
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.stroke();

        // Minute hand
        const minuteAngle = (currentMinute / 60) * 2 * Math.PI - Math.PI/2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + 50 * Math.cos(minuteAngle), cy + 50 * Math.sin(minuteAngle));
        ctx.strokeStyle = '#22d3ee';
        ctx.lineWidth = 3;
        ctx.stroke();

        // Center dot
        ctx.beginPath();
        ctx.arc(cx, cy, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#f1f5f9';
        ctx.fill();
    };

    drawClock();
    wrapper.appendChild(canvas);

    // Time display
    const display = document.createElement('div');
    display.className = 'dojo-clock-display';
    display.textContent = `${currentHour}:${currentMinute.toString().padStart(2, '0')}`;
    wrapper.appendChild(display);

    // Interactive mode
    if (mode === 'interactive') {
        const updateTime = (clientX, clientY) => {
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left - 80;
            const y = clientY - rect.top - 80;
            let angle = Math.atan2(y, x) + Math.PI/2;
            if (angle < 0) angle += 2 * Math.PI;

            if (draggingHand === 'minute') {
                currentMinute = Math.round((angle / (2 * Math.PI)) * 60) % 60;
            } else if (draggingHand === 'hour') {
                currentHour = Math.round((angle / (2 * Math.PI)) * 12) || 12;
            }

            drawClock();
            display.textContent = `${currentHour}:${currentMinute.toString().padStart(2, '0')}`;
            setVisualAnswer({ hour: currentHour, minute: currentMinute });
        };

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - 80;
            const y = e.clientY - rect.top - 80;
            const dist = Math.sqrt(x*x + y*y);

            if (dist < 45) draggingHand = 'hour';
            else draggingHand = 'minute';

            updateTime(e.clientX, e.clientY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (draggingHand) updateTime(e.clientX, e.clientY);
        });

        canvas.addEventListener('mouseup', () => { draggingHand = null; });
        canvas.addEventListener('mouseleave', () => { draggingHand = null; });

        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 80;
            const y = e.touches[0].clientY - rect.top - 80;
            const dist = Math.sqrt(x*x + y*y);
            draggingHand = dist < 45 ? 'hour' : 'minute';
            updateTime(e.touches[0].clientX, e.touches[0].clientY);
        });

        canvas.addEventListener('touchmove', (e) => {
            if (draggingHand) {
                e.preventDefault();
                updateTime(e.touches[0].clientX, e.touches[0].clientY);
            }
        });

        canvas.addEventListener('touchend', () => { draggingHand = null; });

        setVisualAnswer({ hour: currentHour, minute: currentMinute });
    }

    container.appendChild(wrapper);
}

function renderChart(container, data) {
    const { type = 'bar', labels = [], values = [], icon = null } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-chart-container';

    if (type === 'bar') {
        const chart = document.createElement('div');
        chart.className = 'dojo-bar-chart';

        const maxVal = Math.max(...values, 1);

        labels.forEach((label, i) => {
            const bar = document.createElement('div');
            bar.className = 'dojo-bar';

            const value = document.createElement('div');
            value.className = 'dojo-bar-value';
            value.textContent = values[i];
            bar.appendChild(value);

            const fill = document.createElement('div');
            fill.className = 'dojo-bar-fill';
            fill.style.height = (values[i] / maxVal * 100) + 'px';
            bar.appendChild(fill);

            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-bar-label';
            labelEl.textContent = label;
            bar.appendChild(labelEl);

            chart.appendChild(bar);
        });

        wrapper.appendChild(chart);
    } else if (type === 'line') {
        const chart = document.createElement('div');
        chart.className = 'dojo-line-chart';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 300 120');

        const maxVal = Math.max(...values, 1);
        const points = values.map((v, i) => {
            const x = 20 + (i / (values.length - 1 || 1)) * 260;
            const y = 100 - (v / maxVal) * 80;
            return [x, y];
        });

        // Line
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M' + points.map(p => p.join(',')).join(' L'));
        path.setAttribute('class', 'chart-line');
        svg.appendChild(path);

        // Points
        points.forEach(([x, y], i) => {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 4);
            circle.setAttribute('class', 'chart-point');
            svg.appendChild(circle);
        });

        chart.appendChild(svg);
        wrapper.appendChild(chart);
    } else if (type === 'picture') {
        const chart = document.createElement('div');
        chart.className = 'dojo-picture-chart';

        labels.forEach((label, i) => {
            const row = document.createElement('div');
            row.className = 'dojo-picture-row';

            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-picture-row-label';
            labelEl.textContent = label;
            row.appendChild(labelEl);

            const icons = document.createElement('div');
            icons.className = 'dojo-picture-icons';
            icons.textContent = (icon || '★').repeat(values[i]);
            row.appendChild(icons);

            chart.appendChild(row);
        });

        wrapper.appendChild(chart);
    } else if (type === 'line_plot') {
        // Line plot with X's above a number line
        const { counts = [], title = '' } = data;
        const chart = document.createElement('div');
        chart.className = 'dojo-line-plot';
        chart.style.cssText = 'display: flex; flex-direction: column; align-items: center; padding: 1rem;';

        if (title) {
            const titleEl = document.createElement('div');
            titleEl.style.cssText = 'color: var(--slate-300); font-size: 0.9rem; margin-bottom: 0.75rem;';
            titleEl.textContent = title;
            chart.appendChild(titleEl);
        }

        // X's area
        const xsArea = document.createElement('div');
        xsArea.style.cssText = 'display: flex; gap: 1.5rem; margin-bottom: 0.5rem;';

        const maxCount = Math.max(...counts, 1);
        labels.forEach((label, i) => {
            const col = document.createElement('div');
            col.style.cssText = 'display: flex; flex-direction: column-reverse; align-items: center; min-width: 30px;';
            for (let j = 0; j < counts[i]; j++) {
                const x = document.createElement('div');
                x.style.cssText = 'color: var(--cyan-400); font-weight: bold; font-size: 1rem; line-height: 1.2;';
                x.textContent = 'X';
                col.appendChild(x);
            }
            xsArea.appendChild(col);
        });
        chart.appendChild(xsArea);

        // Number line
        const line = document.createElement('div');
        line.style.cssText = 'display: flex; align-items: center; border-top: 2px solid var(--slate-500); padding-top: 0.5rem; gap: 1.5rem;';
        labels.forEach((label) => {
            const tick = document.createElement('div');
            tick.style.cssText = 'display: flex; flex-direction: column; align-items: center; min-width: 30px;';
            const tickMark = document.createElement('div');
            tickMark.style.cssText = 'width: 2px; height: 8px; background: var(--slate-500); margin-bottom: 0.25rem;';
            tick.appendChild(tickMark);
            const labelEl = document.createElement('div');
            labelEl.style.cssText = 'color: var(--slate-300); font-size: 0.85rem;';
            labelEl.textContent = label;
            tick.appendChild(labelEl);
            line.appendChild(tick);
        });
        chart.appendChild(line);

        wrapper.appendChild(chart);
    }

    container.appendChild(wrapper);
}

function renderQuestion() {
    const q = state.currentQuestion;
    document.getElementById('tag-tier').textContent = `Tier ${q.tier}`;
    document.getElementById('tag-domain').textContent = q.domain;
    document.getElementById('tag-type').textContent = q.type;

    const meta = document.getElementById('question-meta');
    meta.querySelectorAll('.tag-probe, .tag-practice').forEach(e => e.remove());
    if (state.probeMode) { const t = document.createElement('span'); t.className = 'question-tag tag-probe'; t.textContent = 'GAP PROBE'; meta.appendChild(t); }
    if (state.mode === 'testing') { const t = document.createElement('span'); t.className = 'question-tag tag-practice'; t.textContent = 'PRACTICE'; meta.appendChild(t); }

    document.getElementById('question-text').textContent = q.question;

    // Render visual if present
    renderVisual(q.visual || null);

    // Reset visual state
    state.selectedAnswer = null;

    const opts = document.getElementById('answer-options');
    opts.innerHTML = '';

    // Determine if this should be a typed-answer question
    // Tier 5+ (Algebra and above) with a plain numeric answer = type it in
    const isTypedAnswer = q.tier >= 5 && typeof q.answer === 'number' && !q.options?.some(o => typeof o === 'string' && isNaN(o));
    state.isTypedAnswer = isTypedAnswer;

    // For interactive visuals, hide multiple choice options
    if (q.visual && q.visual.mode === 'interactive') {
        // Don't show multiple choice options for interactive visuals
    } else if (isTypedAnswer) {
        // Show a text input for typed numeric answers
        const inputDiv = document.createElement('div');
        inputDiv.className = 'typed-answer-container';
        inputDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 16px 0;';
        inputDiv.innerHTML = `
            <label style="font-size: 1.1rem; color: var(--slate-300); white-space: nowrap;">Your answer:</label>
            <input type="text" id="typed-answer-input" class="typed-answer-input"
                   style="flex: 1; max-width: 200px; padding: 12px 16px; font-size: 1.2rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 10px; color: white; outline: none; text-align: center;"
                   placeholder="Type your answer"
                   autocomplete="off"
                   inputmode="text">
        `;
        opts.appendChild(inputDiv);

        const input = document.getElementById('typed-answer-input');
        input.addEventListener('input', () => {
            document.getElementById('submit-btn').disabled = input.value.trim() === '';
        });
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim() !== '') submitAnswer();
        });
        input.focus();
    } else {
        ['A','B','C','D'].forEach((l, i) => {
            if (i < q.options.length) {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.onclick = () => selectAnswer(i);
                div.innerHTML = `<span class="option-letter">${l}</span><span>${q.options[i]}</span>`;
                opts.appendChild(div);
            }
        });
    }

    document.getElementById('explanation-box').classList.remove('show');
    document.getElementById('submit-btn').style.display = 'inline-flex';
    document.getElementById('submit-btn').disabled = isTypedAnswer ? true : !state.visualInteractive;
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('feedback').classList.remove('show', 'correct', 'incorrect');

    // Show IDK button only in placement mode
    if (state.mode === 'placement') {
        document.getElementById('idk-btn').style.display = 'inline-flex';
    }
}

function selectAnswer(i) {
    if (document.getElementById('next-btn').style.display !== 'none') return;
    state.selectedAnswer = i;
    document.querySelectorAll('.answer-option').forEach((o, idx) => o.classList.toggle('selected', idx === i));
    document.getElementById('submit-btn').disabled = false;
}

function startTimer() {
    state.startTime = Date.now();
    state.elapsedTime = 0;
    const fill = document.getElementById('timer-fill');
    fill.style.width = '0%';
    fill.classList.remove('slow');
    if (state.timerInterval) clearInterval(state.timerInterval);
    state.timerInterval = setInterval(() => {
        state.elapsedTime = (Date.now() - state.startTime) / 1000;
        document.getElementById('timer-display').textContent = state.elapsedTime.toFixed(1) + 's';
        const pct = Math.min((state.elapsedTime / (state.currentQuestion.timeExpected * 2)) * 100, 100);
        fill.style.width = pct + '%';
        if (state.elapsedTime > state.currentQuestion.timeExpected) fill.classList.add('slow');
    }, 100);
}

function stopTimer() { if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; } return state.elapsedTime; }

function updateProgress() {
    document.getElementById('question-number').textContent = state.history.length + 1;
    document.getElementById('correct-count').textContent = state.history.filter(h => h.correct).length;
    document.getElementById('current-tier-display').textContent = `Tier ${state.currentQuestion.tier} — ${TIERS[state.currentQuestion.tier].name}`;
    
    if (state.mode === 'testing' && state.history.length > 0) {
        const c = state.history.filter(h => h.correct).length;
        const acc = Math.round((c / state.history.length) * 100);
        const avg = (state.history.reduce((s, h) => s + h.time, 0) / state.history.length).toFixed(1);
        document.getElementById('tc-accuracy').textContent = acc + '%';
        document.getElementById('tc-accuracy').className = `stat-value ${acc >= 70 ? 'good' : acc >= 50 ? 'medium' : 'poor'}`;
        document.getElementById('tc-avg-time').textContent = avg + 's';
        document.getElementById('tc-streak').textContent = state.currentStreak;
    }
}

function submitAnswer() {
    const time = stopTimer();
    const q = state.currentQuestion;

    // Determine correctness based on visual or multiple choice
    let correct;
    let correctAnswerDisplay;

    if (q.visual && q.visual.mode === 'interactive') {
        // Visual interactive answer
        const visualTarget = q.visual.data.target;
        correct = compareVisualAnswer(state.visualAnswer, visualTarget, state.visualType);
        correctAnswerDisplay = formatVisualAnswer(visualTarget, state.visualType);
    } else if (state.isTypedAnswer) {
        // Typed answer - use intelligent interpreter
        const input = document.getElementById('typed-answer-input');
        const userInput = input?.value?.trim();
        const result = AnswerInterpreter.checkAnswer(userInput, q.answer);
        correct = result.correct;
        correctAnswerDisplay = q.answer;
    } else {
        // Standard multiple choice
        correct = state.selectedAnswer === q.answerIndex;
        correctAnswerDisplay = q.options[q.answerIndex];
    }

    const fast = time <= q.timeExpected * 0.7;
    const slow = time > q.timeExpected * 1.5;

    state.history.push({ tier: q.tier, domain: q.domain, type: q.type, question: q.question, correct, time, fast, slow });

    // Record for batched session tracking
    recordQuestionResult(q.domain, q.tier, correct, time);

    const ts = state.tierScores[q.tier];
    ts.total++;
    if (correct) ts.correct++;
    ts.times.push(time);

    // Track domain scores
    if (!state.domainScores[q.tier][q.domain]) {
        state.domainScores[q.tier][q.domain] = { correct: 0, total: 0 };
    }
    state.domainScores[q.tier][q.domain].total++;
    if (correct) state.domainScores[q.tier][q.domain].correct++;

    // Send progress update to Skill Tree
    const ds = state.domainScores[q.tier][q.domain];
    sendSkillProgress(q.domain, q.tier, ds.correct, ds.total, time);

    state.currentStreak = correct ? state.currentStreak + 1 : 0;

    const fb = document.getElementById('feedback');
    fb.classList.add('show');
    if (correct) {
        fb.className = 'feedback show correct';
        fb.textContent = fast ? '✓ Correct! (Fast)' : slow ? '✓ Correct (Slow)' : '✓ Correct!';
    } else {
        fb.className = 'feedback show incorrect';
        fb.textContent = `✗ Incorrect. Answer: ${correctAnswerDisplay}`;
        if (!state.gapLog.find(g => g.tier === q.tier && g.domain === q.domain))
            state.gapLog.push({ tier: q.tier, domain: q.domain, type: q.type });
    }

    // Highlight correct/incorrect for multiple choice
    if (state.isTypedAnswer) {
        const input = document.getElementById('typed-answer-input');
        if (input) {
            input.disabled = true;
            input.style.borderColor = correct ? 'var(--emerald-500)' : 'var(--rose-500)';
            input.style.background = correct ? 'rgba(16, 185, 129, 0.1)' : 'rgba(244, 63, 94, 0.1)';
        }
    } else if (!(q.visual && q.visual.mode === 'interactive')) {
        document.querySelectorAll('.answer-option').forEach((o, i) => {
            if (i === q.answerIndex) o.classList.add('correct');
            else if (i === state.selectedAnswer && !correct) o.classList.add('incorrect');
        });
    }

    if (state.mode === 'testing' && q.explanation) {
        document.getElementById('explanation-text').textContent = q.explanation;
        document.getElementById('explanation-box').classList.add('show');
    }

    if (state.mode === 'placement') adaptTier(correct, fast, slow);

    document.getElementById('idk-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-flex';
    updateProgress();
}

function formatVisualAnswer(value, type) {
    if (type === 'clock') {
        return `${value.hour}:${value.minute.toString().padStart(2, '0')}`;
    }
    if (type === 'coordinate') {
        return `(${value.x}, ${value.y})`;
    }
    return value;
}

function adaptTier(correct, fast, slow) {
    if (correct) {
        state.consecutiveCorrect++;
        state.consecutiveWrong = 0;
        if (fast && state.consecutiveCorrect >= 2) { state.currentTier = Math.min(state.currentTier + 1, 10); state.consecutiveCorrect = 0; }
        else if (!slow && state.consecutiveCorrect >= 3) { state.currentTier = Math.min(state.currentTier + 1, 10); state.consecutiveCorrect = 0; }
    } else {
        state.consecutiveWrong++;
        state.consecutiveCorrect = 0;
        if (state.consecutiveWrong >= 2) { state.currentTier = Math.max(state.currentTier - 1, 1); state.consecutiveWrong = 0; }
    }
}

function submitIDK() {
    const time = stopTimer();
    const q = state.currentQuestion;
    
    // Record as unknown (counts as incorrect for placement purposes)
    state.history.push({ 
        tier: q.tier, 
        domain: q.domain, 
        type: q.type, 
        question: q.question, 
        correct: false, 
        time: time, 
        fast: false, 
        slow: false,
        idk: true  // Mark as IDK
    });
    
    const ts = state.tierScores[q.tier];
    ts.total++; 
    // Don't increment correct - it's unknown
    ts.times.push(time);
    
    // Track domain scores
    if (!state.domainScores[q.tier][q.domain]) {
        state.domainScores[q.tier][q.domain] = { correct: 0, total: 0, idk: 0 };
    }
    state.domainScores[q.tier][q.domain].total++;
    state.domainScores[q.tier][q.domain].idk = (state.domainScores[q.tier][q.domain].idk || 0) + 1;

    // Send progress update to Skill Tree (IDK counts as incorrect)
    const ds = state.domainScores[q.tier][q.domain];
    sendSkillProgress(q.domain, q.tier, ds.correct, ds.total, time);

    // Log as gap immediately
    if (!state.gapLog.find(g => g.tier === q.tier && g.domain === q.domain))
        state.gapLog.push({ tier: q.tier, domain: q.domain, type: q.type, idk: true });
    
    // Show brief feedback
    const fb = document.getElementById('feedback');
    fb.className = 'feedback show incorrect';
    fb.textContent = `Skipped — Answer was: ${q.options[q.answerIndex]}`;
    fb.classList.add('show');
    
    // Show correct answer
    document.querySelectorAll('.answer-option').forEach((o, i) => {
        if (i === q.answerIndex) o.classList.add('correct');
    });
    
    // IDK counts as wrong for tier adaptation (more aggressive drop)
    state.consecutiveWrong++;
    state.consecutiveCorrect = 0;
    state.currentStreak = 0;
    
    // Drop tier immediately on IDK (they clearly don't know this level)
    if (state.consecutiveWrong >= 1) { 
        state.currentTier = Math.max(state.currentTier - 1, 1); 
        state.consecutiveWrong = 0; 
    }
    
    // Hide IDK and submit, show next
    document.getElementById('idk-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-flex';
    
    updateProgress();
}

function nextQuestion() { loadQuestion(); }

function endTest() {
    stopTimer();

    // End session tracking and send batched update
    endSessionTracking();

    const placement = calculatePlacement();
    document.getElementById('test-screen').classList.remove('active');
    document.getElementById('results-screen').classList.add('active');
    document.getElementById('results-screen').classList.toggle('testing-center-results', state.mode === 'testing');
    document.getElementById('results-title').textContent = state.mode === 'placement' ? 'Belt Test Results' : 'Practice Results';
    renderResults(placement);

    // Apply belt test results to skill tree (for placement mode)
    if (state.mode === 'placement') {
        const treeResults = applyBeltTestToTree();

        // Show tree sync results
        const treeSyncCard = document.getElementById('tree-sync-card');
        const treeSyncContainer = document.getElementById('tree-sync-results');

        if (treeResults.totalSkillsUpdated > 0) {
            treeSyncCard.style.display = 'block';
            treeSyncContainer.innerHTML = renderBeltTestTreeResults(treeResults);

            // Show notification
            const masteredCount = treeResults.mastered.length + treeResults.inferred.filter(s => s.newState === 'mastered').length;
            if (masteredCount > 0) {
                showNotification(`🎉 ${masteredCount} skills mastered!`);
            }
        } else {
            treeSyncCard.style.display = 'none';
        }
    } else {
        // Hide tree sync card for non-placement modes
        document.getElementById('tree-sync-card').style.display = 'none';
    }

    // Send full session results to Skill Tree
    sendSessionResults();
}

function calculatePlacement() {
    let best = 1;
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total >= 2 && s.correct / s.total >= 0.6) best = t;
    }
    const relevant = state.history.filter(h => h.tier <= best + 1);
    const fastCorrect = relevant.filter(h => h.fast && h.correct).length;
    let fluency = 'Normal';
    if (relevant.length > 0) {
        const ratio = fastCorrect / relevant.length;
        if (ratio >= 0.6) fluency = 'Automatic';
        else if (ratio <= 0.2) fluency = 'Slow';
    }
    const tc = state.history.filter(h => h.correct).length;
    const avg = state.history.length > 0 ? state.history.reduce((s, h) => s + h.time, 0) / state.history.length : 0;
    return { tier: best, fluency, total: state.history.length, correct: tc, accuracy: state.history.length > 0 ? Math.round(tc / state.history.length * 100) : 0, avgTime: avg.toFixed(1) };
}

function renderResults(p) {
    document.getElementById('result-tier-number').textContent = p.tier;
    document.getElementById('result-tier-title').textContent = TIERS[p.tier].name;
    document.getElementById('result-tier-grades').textContent = `Grades ${TIERS[p.tier].grades}`;
    const fb = document.getElementById('fluency-badge');
    fb.textContent = p.fluency + ' Fluency';
    fb.className = `fluency-badge fluency-${p.fluency.toLowerCase()}`;
    document.getElementById('stat-total').textContent = p.total;
    document.getElementById('stat-correct').textContent = p.correct;
    document.getElementById('stat-idk').textContent = state.history.filter(h => h.idk).length;
    document.getElementById('stat-accuracy').textContent = p.accuracy + '%';
    
    const bd = document.getElementById('tier-breakdown');
    bd.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total === 0) continue;
        const acc = Math.round(s.correct / s.total * 100);
        const cls = acc >= 70 ? 'good' : acc >= 50 ? 'medium' : 'poor';
        bd.innerHTML += `<div class="tier-row"><span class="tier-label">T${t}: ${TIERS[t].name}</span><div class="tier-bar"><div class="tier-fill ${cls}" style="width:${acc}%"></div></div><span class="tier-score">${s.correct}/${s.total}</span></div>`;
    }
    
    const gl = document.getElementById('gap-log');
    if (state.gapLog.length === 0) gl.innerHTML = '<div class="no-gaps">✓ No gaps identified</div>';
    else gl.innerHTML = state.gapLog.map(g => `<div class="gap-item${g.idk ? ' idk' : ''}"><span class="gap-tier">T${g.tier}</span><span class="gap-skill">${g.domain} (${g.type})${g.idk ? ' — Unknown' : ''}</span></div>`).join('');
    
    const recs = document.getElementById('recommendations');
    recs.innerHTML = `<div class="rec-item"><div class="rec-icon">📍</div><div class="rec-content"><h4>Placement: Tier ${p.tier} — ${TIERS[p.tier].name}</h4><p>Ready for Grades ${TIERS[p.tier].grades} content. Domains: ${TIERS[p.tier].domains.slice(0,3).join(', ')}</p></div></div>`;
    if (p.fluency === 'Slow') recs.innerHTML += `<div class="rec-item"><div class="rec-icon">⏱️</div><div class="rec-content"><h4>Focus on Fluency</h4><p>Practice timed drills to build automaticity.</p></div></div>`;
    else if (p.fluency === 'Automatic') recs.innerHTML += `<div class="rec-item"><div class="rec-icon">⚡</div><div class="rec-content"><h4>Strong Fluency</h4><p>Quick responses indicate solid automaticity. Consider advancing.</p></div></div>`;
    if (state.gapLog.length > 0) {
        const idkGaps = state.gapLog.filter(g => g.idk);
        const wrongGaps = state.gapLog.filter(g => !g.idk);
        if (idkGaps.length > 0) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">❓</div><div class="rec-content"><h4>Topics to Learn</h4><p>New material needed: ${idkGaps.slice(0,3).map(g => `${g.domain} (Tier ${g.tier})`).join(', ')}</p></div></div>`;
        if (wrongGaps.length > 0) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">🔧</div><div class="rec-content"><h4>Topics to Review</h4><p>Review: ${wrongGaps.slice(0,3).map(g => `${g.domain} (Tier ${g.tier})`).join(', ')}</p></div></div>`;
    }
    if (p.tier < 10) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">📈</div><div class="rec-content"><h4>Next Level</h4><p>To advance to Tier ${p.tier + 1} (${TIERS[p.tier + 1].name}), master: ${TIERS[p.tier + 1].domains.slice(0,3).join(', ')}</p></div></div>`;
    
    const hist = document.getElementById('question-history');
    hist.innerHTML = state.history.map((h, i) => `<div class="history-item ${h.correct ? 'correct' : h.idk ? 'idk' : 'incorrect'}"><span class="q-number">${i+1}</span><span class="q-text">${h.idk ? '❓ ' : ''}${h.question}</span><span class="q-time">${h.time.toFixed(1)}s</span><span class="q-tier">T${h.tier}${h.idk ? ' IDK' : ''}</span></div>`).join('');
}

// ========================================
// LEARNING CENTER FUNCTIONS
// ========================================

function initLearningSetup() {
    // Create tier selection buttons
    const tierSelect = document.getElementById('learning-tier-select');
    tierSelect.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const btn = document.createElement('button');
        btn.className = 'tier-select-btn' + (t === 1 ? ' selected' : '');
        btn.textContent = `T${t}`;
        btn.title = `Tier ${t}: ${TIERS[t].name}`;
        btn.onclick = () => selectLearningTier(t);
        tierSelect.appendChild(btn);
    }
    state.learningTier = 1;
    updateSkillGrid();
}

function selectLearningTier(tier) {
    state.learningTier = tier;
    state.learningSkill = null;
    document.querySelectorAll('.tier-select-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === tier);
    });
    updateSkillGrid();
    document.getElementById('start-learning-btn').disabled = true;
}

function updateSkillGrid() {
    const grid = document.getElementById('skill-grid');
    const domains = TIERS[state.learningTier].domains;
    grid.innerHTML = '';
    domains.forEach(skill => {
        const card = document.createElement('div');
        const skillState = getSkillState(skill);
        const isUnlocked = isSkillUnlocked(skill);
        const mastery = getSkillMastery(skill);

        card.className = 'skill-card';

        // Add state-based styling
        if (!isUnlocked) {
            card.classList.add('locked');
        } else if (skillState === 'mastered') {
            card.classList.add('mastered');
        } else if (skillState === 'activated' || skillState === 'in_progress') {
            card.classList.add('in-progress');
        } else if (skillState === 'needs_review') {
            card.classList.add('needs-review');
        }

        // Build card content
        let cardContent = `<div class="skill-name">${skill}</div>`;

        // Show mastery indicator for unlocked skills
        if (isUnlocked && mastery > 0) {
            cardContent += `<div class="skill-mastery-bar"><div class="skill-mastery-fill" style="width: ${mastery}%"></div></div>`;
        }

        // Show lock icon and prerequisites for locked skills
        if (!isUnlocked) {
            const prereqs = getSkillPrerequisites(skill);
            cardContent += `<div class="skill-lock-icon">🔒</div>`;
            if (prereqs.length > 0) {
                const prereqList = prereqs.slice(0, 2).join(', ') + (prereqs.length > 2 ? '...' : '');
                cardContent += `<div class="skill-prereq-hint">Master: ${prereqList}</div>`;
            }
        }

        // Show state badges
        if (skillState === 'mastered') {
            cardContent += `<div class="skill-badge mastered">✓ Mastered</div>`;
        } else if (skillState === 'needs_review') {
            cardContent += `<div class="skill-badge needs-review">⟳ Review</div>`;
        }

        card.innerHTML = cardContent;

        // Only make clickable if unlocked
        if (isUnlocked) {
            card.onclick = () => selectSkill(skill);
        } else {
            card.onclick = () => showLockedSkillInfo(skill);
        }

        grid.appendChild(card);
    });
}

// Show info modal for locked skills
function showLockedSkillInfo(skill) {
    const prereqs = getSkillPrerequisites(skill);
    const prereqStatuses = prereqs.map(p => {
        const state = getSkillState(p);
        const mastery = getSkillMastery(p);
        const isMastered = ['mastered', 'activated', 'needs_review'].includes(state);
        return { name: p, mastered: isMastered, mastery, state };
    });

    let message = `To unlock "${skill}", you need to master:\n\n`;
    prereqStatuses.forEach(p => {
        const status = p.mastered ? '✓' : '○';
        const masteryText = p.mastery > 0 ? ` (${p.mastery}%)` : '';
        message += `${status} ${p.name}${masteryText}\n`;
    });

    alert(message);
}

function selectSkill(skill) {
    // Verify skill is unlocked
    if (!isSkillUnlocked(skill)) {
        showLockedSkillInfo(skill);
        return;
    }

    state.learningSkill = skill;
    document.querySelectorAll('.skill-card').forEach(card => {
        const cardSkill = card.querySelector('.skill-name').textContent;
        card.classList.toggle('selected', cardSkill === skill);
    });
    document.getElementById('start-learning-btn').disabled = false;

    // Notify tree to highlight this skill
    requestTreeHighlight(skill);
}

function startLearning() {
    state.learningPhase = 'learn';
    state.currentLesson = generateLesson(state.learningTier, state.learningSkill);
    state.guidedStep = 0;
    state.practiceAttempts = 0;
    state.practiceCorrect = 0;

    if (!state.currentLesson) {
        // Lesson not available - just return silently (button should be disabled)
        return;
    }

    // Start session tracking for batched updates
    startSessionTracking('learning');

    document.getElementById('learning-setup-screen').classList.remove('active');
    document.getElementById('learning-screen').classList.add('active');

    // Update header
    document.getElementById('learning-tier-badge').textContent = `Tier ${state.learningTier}`;
    document.getElementById('learning-skill-name').textContent = state.learningSkill;

    renderLearningPhase();
}

function renderLearningPhase() {
    const lesson = state.currentLesson;
    
    // Update phase indicators
    document.querySelectorAll('.phase-dot').forEach(dot => {
        const phase = dot.dataset.phase;
        dot.classList.remove('active', 'completed');
        if (phase === state.learningPhase) dot.classList.add('active');
        else if ((phase === 'learn' && state.learningPhase !== 'learn') || 
                 (phase === 'guided' && state.learningPhase === 'practice')) {
            dot.classList.add('completed');
        }
    });
    document.querySelectorAll('.phase-label').forEach(label => {
        label.classList.toggle('active', label.dataset.phase === state.learningPhase);
    });
    document.querySelectorAll('.phase-line').forEach((line, i) => {
        line.classList.toggle('completed', 
            (i === 0 && state.learningPhase !== 'learn') ||
            (i === 1 && state.learningPhase === 'practice'));
    });
    
    // Hide all phases
    document.querySelectorAll('.phase-content').forEach(p => p.classList.remove('active'));
    
    if (state.learningPhase === 'learn') {
        renderLearnPhase(lesson);
        document.getElementById('phase-learn').classList.add('active');
        document.getElementById('learning-continue-btn').textContent = 'Continue to Guided Practice →';
        document.getElementById('learning-continue-btn').style.display = 'inline-flex';
    } else if (state.learningPhase === 'guided') {
        renderGuidedPhase(lesson);
        document.getElementById('phase-guided').classList.add('active');
        document.getElementById('learning-continue-btn').style.display = 'none';
    } else if (state.learningPhase === 'practice') {
        renderPracticePhase(lesson);
        document.getElementById('phase-practice').classList.add('active');
        document.getElementById('learning-continue-btn').style.display = 'none';
    }
}

function renderLearnPhase(lesson) {
    // Reset step reveal state
    state.currentConceptStep = 0;
    state.totalConceptSteps = lesson.teachingSteps ? lesson.teachingSteps.length : 0;

    // Render sub-skill progress if this is a sub-skill lesson
    const progressContainer = document.getElementById('subskill-progress-container');
    if (progressContainer) {
        if (lesson._isSubSkill && lesson._allSubSkills) {
            progressContainer.innerHTML = `
                <div class="subskill-progress">
                    <div class="subskill-progress-header">
                        <span class="subskill-parent">${lesson._parentSkill}</span>
                        <span class="subskill-counter">${lesson._subSkillIndex + 1} of ${lesson._totalSubSkills}</span>
                    </div>
                    <div class="subskill-progress-bar">
                        ${lesson._allSubSkills.map((s, i) => `
                            <div class="subskill-pip ${s.completed ? 'completed' : ''} ${s.current ? 'current' : ''}"
                                 title="${s.name}"
                                 onclick="${s.completed || i <= lesson._subSkillIndex ? `jumpToSubSkill(${i})` : ''}"
                                 style="${s.completed || i <= lesson._subSkillIndex ? 'cursor:pointer' : 'cursor:default'}">
                                ${s.completed ? '✓' : i + 1}
                            </div>
                        `).join('')}
                    </div>
                    <div class="subskill-current-name">${lesson._subSkillName}</div>
                </div>
            `;
            progressContainer.style.display = 'block';
        } else {
            progressContainer.style.display = 'none';
        }
    }

    // Check if lesson has new step-by-step format
    if (lesson.teachingSteps && lesson.teachingSteps.length > 0) {
        // New step-by-step format
        document.getElementById('goal-problem-text').innerHTML = lesson.goalProblem || lesson.example.problem;

        // Build concept steps HTML (all hidden initially)
        document.getElementById('concept-steps').innerHTML = lesson.teachingSteps.map((step, i) =>
            `<div class="concept-step" id="concept-step-${i}">
                <div class="step-header">
                    <span class="step-number">${i + 1}</span>
                    <span class="step-title">${step.title}</span>
                    <button class="read-aloud-btn step-read-btn" onclick="readConceptStep(${i}, this)" title="Read aloud">
                        <span class="speaker-icon">🔊</span> Read
                    </button>
                </div>
                <div class="step-explanation">${step.explanation}</div>
                ${step.visual ? `<div class="step-visual">${step.visual}</div>` : ''}
            </div>`
        ).join('');

        // Set up final answer
        document.getElementById('answer-text').innerHTML = lesson.finalAnswer || lesson.example.steps[lesson.example.steps.length - 1]?.math || '';
        document.getElementById('answer-explanation').innerHTML = lesson.answerExplanation || '';

        // Reset visibility
        document.getElementById('final-answer').classList.remove('visible');

        // Get or recreate button container if needed
        let btnContainer = document.getElementById('reveal-btn-container');
        let btn = document.getElementById('reveal-next-btn');

        // If button doesn't exist (was removed), recreate it
        if (!btn || !btnContainer) {
            btnContainer = document.createElement('div');
            btnContainer.id = 'reveal-btn-container';
            btnContainer.innerHTML = `<button class="concept-reveal-btn" id="reveal-next-btn" onclick="revealNextConceptStep()">
                <span class="btn-icon">👉</span>
                <span>Show Next Step</span>
            </button>`;
            btn = btnContainer.querySelector('#reveal-next-btn');
        }

        btn.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">👉</span><span>Show Next Step</span>';
        btn.onclick = revealNextConceptStep;

        // Move button container back to after concept-steps
        document.getElementById('concept-steps').insertAdjacentElement('afterend', btnContainer);

        document.getElementById('key-points-section').style.display = 'none';
        document.getElementById('mistakes-section').style.display = 'none';

        // Reveal first step automatically
        setTimeout(() => revealNextConceptStep(), 300);
    } else {
        // Fallback to old format - show everything at once
        document.getElementById('goal-problem-text').innerHTML = lesson.example.problem;

        // Convert old format to steps
        const steps = lesson.example.steps.map((step, i) => ({
            title: step.text,
            explanation: '',
            visual: step.math
        }));

        document.getElementById('concept-steps').innerHTML = steps.map((step, i) =>
            `<div class="concept-step visible" id="concept-step-${i}">
                <div class="step-header">
                    <span class="step-number">${i + 1}</span>
                    <span class="step-title">${step.title}</span>
                    <button class="read-aloud-btn step-read-btn" onclick="readConceptStepOld(${i}, this)" title="Read aloud">
                        <span class="speaker-icon">🔊</span> Read
                    </button>
                </div>
                ${step.visual ? `<div class="step-visual">${step.visual}</div>` : ''}
            </div>`
        ).join('');

        // Show answer immediately
        document.getElementById('answer-text').innerHTML = lesson.example.steps[lesson.example.steps.length - 1]?.math || '';
        document.getElementById('answer-explanation').innerHTML = '';
        document.getElementById('final-answer').classList.add('visible');
        document.getElementById('reveal-next-btn').style.display = 'none';

        // Show key points and mistakes
        document.getElementById('key-points-section').style.display = 'block';
        document.getElementById('mistakes-section').style.display = 'block';
    }

    // Key points
    document.getElementById('key-points-list').innerHTML = lesson.keyPoints.map(p => `<li>${p}</li>`).join('');

    // Common mistakes
    document.getElementById('common-mistakes-list').innerHTML = lesson.mistakes.map(m =>
        `<div class="mistake-item"><div class="mistake-wrong">✗ ${m.wrong}</div><div class="mistake-why">→ ${m.why}</div></div>`
    ).join('');
}

function revealNextConceptStep() {
    const lesson = state.currentLesson;
    const currentStep = state.currentConceptStep;
    const totalSteps = state.totalConceptSteps;
    const btnContainer = document.getElementById('reveal-btn-container');
    const btn = document.getElementById('reveal-next-btn');

    if (currentStep < totalSteps) {
        // Reveal the next step
        const stepEl = document.getElementById(`concept-step-${currentStep}`);
        if (stepEl) {
            stepEl.classList.add('visible');

            // Move button container right after this step
            stepEl.insertAdjacentElement('afterend', btnContainer);

            // Scroll the button into view smoothly
            setTimeout(() => {
                btnContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        state.currentConceptStep++;

        // Update button text
        if (state.currentConceptStep >= totalSteps) {
            btn.innerHTML = '<span class="btn-icon">🎯</span><span>Show the Answer!</span>';
        } else {
            btn.innerHTML = `<span class="btn-icon">👉</span><span>Next Step (${state.currentConceptStep + 1}/${totalSteps})</span>`;
        }
    } else {
        // All steps revealed, show the answer
        const finalAnswer = document.getElementById('final-answer');
        finalAnswer.classList.add('visible');

        // Move button after final answer and update it
        finalAnswer.insertAdjacentElement('afterend', btnContainer);
        btn.innerHTML = '<span class="btn-icon">✅</span><span>Continue to Guided Practice →</span>';
        btn.onclick = nextLearningPhase;

        // Scroll to final answer
        setTimeout(() => {
            finalAnswer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);

        // Show key points and mistakes after a short delay
        setTimeout(() => {
            document.getElementById('key-points-section').style.display = 'block';
            document.getElementById('mistakes-section').style.display = 'block';
        }, 500);
    }
}

function renderGuidedPhase(lesson) {
    const guided = lesson.guided;

    // Initialize guided state
    state.guidedCurrentStep = 0;
    state.guidedSteps = guided.interactiveSteps || generateInteractiveSteps(guided, lesson);
    state.guidedAttempts = 0;

    // Set problem text
    document.getElementById('guided-problem').innerHTML = guided.problem;

    // Set total steps
    const totalSteps = state.guidedSteps.length;
    document.getElementById('guided-total-steps').textContent = totalSteps;
    document.getElementById('guided-current-step').textContent = '1';

    // Create progress dots
    document.getElementById('guided-progress-dots').innerHTML = state.guidedSteps.map((_, i) =>
        `<div class="dot ${i === 0 ? 'current' : ''}"></div>`
    ).join('');

    // Clear completed steps
    document.getElementById('guided-completed-steps').innerHTML = '';

    // Show completion area as hidden
    document.getElementById('guided-completion').style.display = 'none';
    document.getElementById('guided-current-step-area').style.display = 'block';

    // Render first step
    renderGuidedStep();
}

// Generate interactive steps from the old format
function generateInteractiveSteps(guided, lesson) {
    const steps = [];
    const mistakes = lesson.mistakes || [];

    // Convert old guided.steps to interactive format
    guided.steps.forEach((step, i) => {
        const isLast = i === guided.steps.length - 1;
        if (isLast) {
            // Last step is always user input for final answer
            steps.push({
                prompt: guided.answerLabel || step.label,
                hint: `Look at the previous steps to find the answer`,
                answer: guided.answer,
                acceptableAnswers: [guided.answer],
                commonMistakes: buildMistakeMap(guided.answer, mistakes, lesson)
            });
        } else if (step.value && step.value !== '?') {
            // Create fill-in step for intermediate values
            const answerValue = extractAnswer(step.value);
            if (answerValue && i > 0) { // Skip first step (usually just setup)
                steps.push({
                    prompt: step.label,
                    hint: `Calculate: ${guided.steps[i-1]?.value || 'using what you know'}`,
                    answer: answerValue,
                    acceptableAnswers: [answerValue],
                    showWork: guided.steps.slice(0, i).map(s => `${s.label}: ${s.value}`),
                    commonMistakes: {}
                });
            }
        }
    });

    // If no steps were generated, create at least the final answer step
    if (steps.length === 0) {
        steps.push({
            prompt: guided.answerLabel || 'Final Answer',
            hint: 'Use the information given to solve the problem',
            answer: guided.answer,
            acceptableAnswers: [guided.answer],
            commonMistakes: buildMistakeMap(guided.answer, mistakes, lesson)
        });
    }

    return steps;
}

// Extract a numeric or simple answer from a step value
function extractAnswer(value) {
    if (!value || value === '?') return null;
    // Try to extract the last number or simple expression
    const match = value.match(/=\s*([^=]+)$/) || value.match(/(\d+(?:\.\d+)?(?:\/\d+)?)/);
    return match ? match[1].trim() : value.trim();
}

// Build mistake map from lesson mistakes
function buildMistakeMap(correctAnswer, mistakes, lesson) {
    const mistakeMap = {};

    // Add common arithmetic mistakes
    const numAnswer = parseFloat(correctAnswer);
    if (!isNaN(numAnswer)) {
        // Common off-by-one or arithmetic errors
        mistakeMap[String(numAnswer + 1)] = "Almost! Double-check your arithmetic.";
        mistakeMap[String(numAnswer - 1)] = "Almost! Double-check your arithmetic.";
        mistakeMap[String(numAnswer * 2)] = "You might have doubled when you shouldn't have.";
        mistakeMap[String(numAnswer / 2)] = "You might have halved when you shouldn't have.";
        mistakeMap[String(-numAnswer)] = "Check if the sign (positive/negative) is correct.";
    }

    // Add lesson-specific mistakes
    mistakes.forEach(m => {
        if (m.wrong && m.why) {
            // Extract any numbers from the wrong answer description
            const wrongNums = m.wrong.match(/\d+(?:\.\d+)?/g);
            if (wrongNums) {
                wrongNums.forEach(num => {
                    mistakeMap[num] = m.why;
                });
            }
        }
    });

    return mistakeMap;
}

function renderGuidedStep() {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const stepNum = state.guidedCurrentStep + 1;

    // Update step counter
    document.getElementById('guided-current-step').textContent = stepNum;

    // Update progress dots
    document.querySelectorAll('.guided-progress .dot').forEach((dot, i) => {
        dot.classList.remove('current', 'completed');
        if (i < state.guidedCurrentStep) dot.classList.add('completed');
        else if (i === state.guidedCurrentStep) dot.classList.add('current');
    });

    // Show previous work if available
    if (step.showWork && step.showWork.length > 0) {
        document.getElementById('guided-step-hint').innerHTML = `<strong>So far:</strong> ${step.showWork.join(' → ')}`;
    } else {
        document.getElementById('guided-step-hint').textContent = step.hint || '';
    }

    // Set prompt with read aloud button
    document.getElementById('guided-step-prompt').innerHTML = `
        <div class="step-header-row">
            <div class="step-prompt-text"><strong>Step ${stepNum}:</strong> ${step.prompt}</div>
            <button class="read-aloud-btn" onclick="readAloud(this)" title="Read aloud">
                <span class="speaker-icon">🔊</span> Read
            </button>
        </div>
    `;

    // Check if this step uses selection options (clickable choices) instead of text input
    if (step.selectOptions && step.selectOptions.length > 0) {
        // Render clickable option buttons
        document.getElementById('guided-input-area').innerHTML = `
            <div class="guided-select-options">
                ${step.selectOptions.map((opt, i) => `
                    <button class="guided-select-option" onclick="selectGuidedOption('${opt.value}', ${i})">${opt.label}</button>
                `).join('')}
            </div>
        `;
    } else {
        // Reset input - use formatHint for placeholder, or derive a smart default from the expected answer
        const placeholderText = step.formatHint || getSmartPlaceholder(step);
        document.getElementById('guided-input-area').innerHTML = `
            <input type="text" class="guided-input" id="guided-answer-input" placeholder="${placeholderText}" onkeypress="if(event.key==='Enter')checkGuidedStepAnswer()">
            <button class="btn btn-emerald guided-submit" onclick="checkGuidedStepAnswer()">Check</button>
        `;
    }

    // Clear feedback
    document.getElementById('guided-feedback').classList.remove('show', 'correct', 'incorrect', 'hint');

    // Focus input (only if it's a text input step)
    if (!step.selectOptions) {
        setTimeout(() => document.getElementById('guided-answer-input')?.focus(), 100);
    }
}

function selectGuidedOption(value, index) {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const fb = document.getElementById('guided-feedback');

    state.guidedAttempts++;

    // Use intelligent answer interpreter
    const acceptableAnswers = step.acceptableAnswers || [step.answer];
    const result = AnswerInterpreter.checkAnswer(value, acceptableAnswers);
    const isCorrect = result.correct;

    // Highlight selected option
    document.querySelectorAll('.guided-select-option').forEach((opt, i) => {
        opt.classList.remove('selected', 'correct', 'incorrect');
        if (i === index) {
            opt.classList.add('selected');
            opt.classList.add(isCorrect ? 'correct' : 'incorrect');
        }
    });

    if (isCorrect) {
        fb.className = 'guided-feedback show correct';
        fb.innerHTML = `✓ Correct! ${getEncouragement()}`;

        addCompletedStep(step, value);

        setTimeout(() => {
            state.guidedCurrentStep++;
            state.guidedAttempts = 0;

            if (state.guidedCurrentStep >= state.guidedSteps.length) {
                showGuidedCompletion();
            } else {
                renderGuidedStep();
            }
        }, 1000);
    } else {
        // Check for specific mistake feedback
        const normalizedValue = String(value).toLowerCase().replace(/\s+/g, '');
        const mistakeFeedback = step.commonMistakes?.[value] || step.commonMistakes?.[normalizedValue];

        if (mistakeFeedback) {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite.<div class="mistake-tip">💡 ${mistakeFeedback}</div>`;
        } else {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite. Try again!`;
        }

        // After 3 attempts, show the answer
        if (state.guidedAttempts >= 3) {
            fb.innerHTML += `<br><br>The correct answer is: <strong>${step.answer}</strong>`;

            setTimeout(() => {
                addCompletedStep(step, step.answer);
                state.guidedCurrentStep++;
                state.guidedAttempts = 0;

                if (state.guidedCurrentStep >= state.guidedSteps.length) {
                    showGuidedCompletion();
                } else {
                    renderGuidedStep();
                }
            }, 2000);
        }
    }
}

function checkGuidedStepAnswer() {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const input = document.getElementById('guided-answer-input').value.trim();
    const fb = document.getElementById('guided-feedback');

    state.guidedAttempts++;

    // Use intelligent answer interpreter
    const acceptableAnswers = step.acceptableAnswers || [step.answer];
    const result = AnswerInterpreter.checkAnswer(input, acceptableAnswers);
    const isCorrect = result.correct;

    // Provide "close answer" feedback if applicable
    if (!isCorrect && result.matchType === 'close') {
        fb.className = 'guided-feedback show hint';
        fb.innerHTML = `Almost! Did you mean "${result.suggestion}"?`;
        return;
    }

    if (isCorrect) {
        fb.className = 'guided-feedback show correct';
        fb.innerHTML = `✓ Correct! ${getEncouragement()}`;

        // Add to completed steps
        addCompletedStep(step, input);

        // Move to next step or complete
        setTimeout(() => {
            state.guidedCurrentStep++;
            state.guidedAttempts = 0;

            if (state.guidedCurrentStep >= state.guidedSteps.length) {
                // All steps complete
                showGuidedCompletion();
            } else {
                renderGuidedStep();
            }
        }, 1000);
    } else {
        // Check for common mistakes (try both raw input and normalized)
        const normalizedInput = input.toLowerCase().replace(/\s+/g, '');
        const mistakeFeedback = step.commonMistakes?.[input] || step.commonMistakes?.[normalizedInput];

        if (mistakeFeedback) {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite.<div class="mistake-tip">💡 ${mistakeFeedback}</div>`;
        } else if (state.guidedAttempts >= 2) {
            // After 2 attempts, give a stronger hint
            fb.className = 'guided-feedback show hint';
            fb.innerHTML = `💡 Hint: The answer involves "${step.answer.toString().charAt(0)}..." - try again!`;
        } else {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite. Check your work and try again.`;
        }

        // After 3 attempts, show the answer
        if (state.guidedAttempts >= 3) {
            fb.innerHTML += `<br><br>The correct answer is: <strong>${step.answer}</strong>`;

            setTimeout(() => {
                addCompletedStep(step, step.answer);
                state.guidedCurrentStep++;
                state.guidedAttempts = 0;

                if (state.guidedCurrentStep >= state.guidedSteps.length) {
                    showGuidedCompletion();
                } else {
                    renderGuidedStep();
                }
            }, 2000);
        }

        // Select input for easy retry
        document.getElementById('guided-answer-input')?.select();
    }
}

function addCompletedStep(step, answer) {
    const stepNum = state.guidedCurrentStep + 1;
    const completedHTML = `
        <div class="guided-completed-step">
            <div class="step-num">✓</div>
            <div class="step-content">
                <div class="step-question">${step.prompt}</div>
                <div class="step-answer">${answer}</div>
            </div>
        </div>
    `;
    document.getElementById('guided-completed-steps').innerHTML += completedHTML;
}

function showGuidedCompletion() {
    const lesson = state.currentLesson;

    document.getElementById('guided-current-step-area').style.display = 'none';
    document.getElementById('guided-completion').style.display = 'block';
    document.getElementById('guided-final-answer').innerHTML = `Final Answer: <strong>${lesson.guided.answer}</strong>`;

    // Update progress dots
    document.querySelectorAll('.guided-progress .dot').forEach(dot => {
        dot.classList.remove('current');
        dot.classList.add('completed');
    });
}

// Derive a smart placeholder based on the expected answer type
function getSmartPlaceholder(step) {
    const answer = String(step.answer || '').toLowerCase().trim();
    const acceptableAnswers = step.acceptableAnswers || [];

    // Check if answer is a fraction (contains /)
    if (answer.includes('/') && !answer.includes(':')) {
        return 'e.g., 3/4';
    }

    // Check if answer is a time (contains :)
    if (answer.includes(':')) {
        return 'e.g., 3:30';
    }

    // Check if answer is yes/no type
    if (['yes', 'no', 'yeah', 'yep', 'nope'].includes(answer)) {
        return 'yes or no';
    }

    // Check if answer is a direction
    if (['left', 'right', 'up', 'down'].includes(answer)) {
        return 'left or right';
    }

    // Check if answer is round up/down
    if (answer.includes('round')) {
        return 'round up or round down';
    }

    // Check if answer is even/odd
    if (['even', 'odd'].includes(answer)) {
        return 'even or odd';
    }

    // Check if answer is an operation
    if (['add', 'subtract', 'multiply', 'divide', 'addition', 'subtraction', 'multiplication', 'division'].includes(answer)) {
        return 'e.g., multiply';
    }

    // Check if any acceptable answer has units (like "26 units")
    const hasUnits = acceptableAnswers.some(a => /\d+\s*(units?|cm|m|ft|in|inches|feet|cents?|¢|\$)/.test(a));
    if (hasUnits) {
        return 'Enter a number (with or without units)';
    }

    // Check if it's a pure number
    if (/^-?\d+(\.\d+)?$/.test(answer)) {
        return 'Enter a number';
    }

    // Check if it's asking for a digit
    if (/^[0-9]$/.test(answer)) {
        return 'Enter a digit (0-9)';
    }

    // Default
    return 'Your answer';
}

function getEncouragement() {
    const phrases = ['Great job!', 'Excellent!', 'Perfect!', 'Well done!', 'Awesome!', 'Nice work!'];
    return phrases[Math.floor(Math.random() * phrases.length)];
}

// Legacy function kept for compatibility
function checkGuidedAnswer() {
    checkGuidedStepAnswer();
}

function renderPracticePhase(lesson) {
    // Reset practice state on first render
    if (state.practiceCorrect === 0) {
        state.practiceAttempts = 0;
    }

    // Generate a fresh question from the generators (not the static lesson practice)
    const question = generateQuestion(state.learningTier, state.learningSkill);

    // Store current practice question in state
    state.currentPracticeQuestion = question;

    document.getElementById('practice-problem').innerHTML = question.question;
    document.getElementById('practice-options').innerHTML = question.options.map((opt, i) =>
        `<div class="practice-option" onclick="selectPracticeOption(${i})">${opt}</div>`
    ).join('');

    // Update progress display
    document.getElementById('practice-correct-count').textContent = state.practiceCorrect;
    for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot-${i}`);
        dot.classList.toggle('completed', i <= state.practiceCorrect);
    }

    document.getElementById('practice-feedback').classList.remove('show', 'correct', 'incorrect');
    document.getElementById('mistake-analysis').classList.remove('show');
}

function selectPracticeOption(index) {
    const question = state.currentPracticeQuestion;
    const selectedAnswer = question.options[index];
    const correct = String(selectedAnswer) === String(question.answer);

    state.practiceAttempts++;

    // Record for batched session tracking
    recordQuestionResult(state.learningSkill, state.learningTier, correct, 0);

    // Show selection
    document.querySelectorAll('.practice-option').forEach((opt, i) => {
        opt.classList.remove('selected');
        if (i === index) opt.classList.add('selected');
    });

    const fb = document.getElementById('practice-feedback');
    fb.classList.add('show');

    if (correct) {
        state.practiceCorrect++;

        // Update progress display
        document.getElementById('practice-correct-count').textContent = state.practiceCorrect;
        document.getElementById(`dot-${state.practiceCorrect}`).classList.add('completed');

        document.querySelectorAll('.practice-option').forEach((opt, i) => {
            if (String(question.options[i]) === String(question.answer)) {
                opt.classList.add('correct');
            }
        });

        if (state.practiceCorrect >= 3) {
            // Completed 3 in a row!
            fb.className = 'practice-feedback show correct';
            fb.innerHTML = `✓ Excellent! 3 in a row - you've mastered this concept!`;
            setTimeout(() => {
                document.getElementById('learning-continue-btn').textContent = 'Complete Lesson ✓';
                document.getElementById('learning-continue-btn').style.display = 'inline-flex';
                document.getElementById('learning-continue-btn').onclick = completeLearning;
            }, 500);
        } else {
            // More to go
            fb.className = 'practice-feedback show correct';
            fb.innerHTML = `✓ Correct! ${3 - state.practiceCorrect} more in a row to go.`;
            setTimeout(() => {
                renderPracticePhase(state.currentLesson);
            }, 1200);
        }
    } else {
        // Reset streak on incorrect answer
        const hadProgress = state.practiceCorrect > 0;
        state.practiceCorrect = 0;

        // Reset progress display
        document.getElementById('practice-correct-count').textContent = '0';
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`dot-${i}`).classList.remove('completed');
        }

        fb.className = 'practice-feedback show incorrect';
        fb.innerHTML = hadProgress ? `Not quite. Streak reset - let's try again!` : `Not quite. Try again!`;

        document.querySelectorAll('.practice-option')[index].classList.add('incorrect');

        // Show explanation if available
        const mistakeDiv = document.getElementById('mistake-analysis');
        if (question.explanation) {
            mistakeDiv.innerHTML = `<h4>💡 Explanation</h4><p>${question.explanation}</p><button class="btn btn-emerald practice-ok-btn" onclick="dismissPracticeFeedback()">OK - Next Problem</button>`;
            mistakeDiv.classList.add('show');
        } else {
            mistakeDiv.innerHTML = `<h4>💡 Tip</h4><p>Review the worked example and try again.</p><button class="btn btn-emerald practice-ok-btn" onclick="dismissPracticeFeedback()">OK - Next Problem</button>`;
            mistakeDiv.classList.add('show');
        }

        // Disable option clicking while feedback is shown
        document.querySelectorAll('.practice-option').forEach(opt => opt.style.pointerEvents = 'none');
    }
}

function dismissPracticeFeedback() {
    // Re-enable option clicking and load next problem
    document.querySelectorAll('.practice-option').forEach(opt => opt.style.pointerEvents = 'auto');
    renderPracticePhase(state.currentLesson);
}

function nextLearningPhase() {
    if (state.learningPhase === 'learn') {
        state.learningPhase = 'guided';
    } else if (state.learningPhase === 'guided') {
        state.learningPhase = 'practice';
    }
    renderLearningPhase();
}

function previousLearningPhase() {
    if (state.learningPhase === 'guided') {
        state.learningPhase = 'learn';
        renderLearningPhase();
    } else if (state.learningPhase === 'practice') {
        state.learningPhase = 'guided';
        renderLearningPhase();
    }
}

function goBackToLearn() {
    // Go directly back to the Learn phase from any phase
    state.learningPhase = 'learn';
    state.practiceCorrect = 0; // Reset practice progress
    renderLearningPhase();
}

function completeLearning() {
    const lesson = state.currentLesson;

    // Check if this is a sub-skill lesson
    if (lesson && lesson._isSubSkill) {
        // Mark this sub-skill as complete
        completeSubSkill(state.learningTier, lesson._parentSkill, lesson._subSkillId);

        // Check if there are more sub-skills to learn
        const nextIndex = lesson._subSkillIndex + 1;
        if (nextIndex < lesson._totalSubSkills) {
            // Move to next sub-skill
            showNotification(`Sub-skill Complete: ${lesson._subSkillName}`);
            state.learningPhase = 'learn';
            state.practiceCorrect = 0;
            state.currentLesson = generateLesson(state.learningTier, state.learningSkill, nextIndex);
            renderLearningPhase();
            return; // Don't end learning yet
        }

        // All sub-skills complete - show special notification
        showNotification(`All ${lesson._totalSubSkills} sub-skills mastered! 🎉`);
    }

    // End session tracking and send batched update to tree
    endSessionTracking();

    // Ensure the mastered skill unlocks dependents in our local tree data
    const treeSkill = getTreeSkillName(state.learningSkill);
    if (!skillTreeData.skills[treeSkill]) {
        skillTreeData.skills[treeSkill] = { state: 'mastered', mastery_score: 100 };
    } else {
        skillTreeData.skills[treeSkill].state = 'mastered';
        skillTreeData.skills[treeSkill].mastery_score = 100;
    }
    triggerDependentUnlocks(treeSkill);
    saveSkillTreeData();

    // Send skill mastery to Skill Tree (completed lesson = high mastery)
    sendSkillProgress(state.learningSkill, state.learningTier, 3, 3, 0);

    // Also send a lesson complete message
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({
            type: 'DOGO_LESSON_COMPLETE',
            skill: getSkillTreeName(state.learningSkill),
            domain: state.learningSkill,
            tier: state.learningTier,
            timestamp: Date.now()
        }, '*');
    }

    // Write lesson completion to localStorage for tree cross-tab sync
    localStorage.setItem('dojo_lesson_complete', JSON.stringify({
        skill: getTreeSkillName(state.learningSkill),
        domain: state.learningSkill,
        tier: state.learningTier,
        userId: getUserId(),
        timestamp: Date.now()
    }));

    endLearning();

    // Show mastery notification
    showNotification(`Skill Mastered: ${state.learningSkill}!`);
}

// Jump to a specific sub-skill (for navigation)
function jumpToSubSkill(index) {
    const lesson = state.currentLesson;
    if (!lesson || !lesson._isSubSkill) return;

    // Only allow jumping to completed sub-skills or the current one
    const key = `${state.learningTier}_${lesson._parentSkill}`;
    const completed = state.completedSubSkills[key] || [];

    // Get the target sub-skill id
    const targetSubSkill = lesson._allSubSkills[index];
    if (!targetSubSkill) return;

    // Allow if completed or if it's at or before current position
    if (targetSubSkill.completed || index <= lesson._subSkillIndex) {
        state.learningPhase = 'learn';
        state.practiceCorrect = 0;
        state.currentLesson = generateLesson(state.learningTier, state.learningSkill, index);
        renderLearningPhase();
    }
}

function endLearning() {
    // End session tracking if not already ended
    endSessionTracking();

    document.getElementById('learning-screen').classList.remove('active');
    document.getElementById('learning-setup-screen').classList.add('active');

    // Stop any ongoing speech
    stopSpeaking();

    // Reset button
    document.getElementById('learning-continue-btn').onclick = nextLearningPhase;
    document.getElementById('learning-continue-btn').textContent = 'Continue →';

    // Refresh skill grid to show updated states
    updateSkillGrid();
}

// ========================================
// TEXT-TO-SPEECH (READ ALOUD) FUNCTIONS
// ========================================

// Track current speech state
let currentUtterance = null;
let currentSpeakingBtn = null;

// Clean text for speech (remove HTML, special chars, etc.)
function cleanTextForSpeech(text) {
    // Remove HTML tags
    let cleaned = text.replace(/<[^>]*>/g, ' ');
    // Replace common math symbols with spoken equivalents
    cleaned = cleaned
        .replace(/×/g, ' times ')
        .replace(/÷/g, ' divided by ')
        .replace(/\+/g, ' plus ')
        .replace(/−|–|-/g, ' minus ')
        .replace(/=/g, ' equals ')
        .replace(/≥/g, ' is greater than or equal to ')
        .replace(/≤/g, ' is less than or equal to ')
        .replace(/>/g, ' is greater than ')
        .replace(/</g, ' is less than ')
        .replace(/≠/g, ' is not equal to ')
        .replace(/²/g, ' squared ')
        .replace(/³/g, ' cubed ')
        .replace(/√/g, ' square root of ')
        .replace(/π/g, ' pi ')
        .replace(/°/g, ' degrees ')
        .replace(/\$/g, ' dollars ')
        .replace(/%/g, ' percent ')
        .replace(/\^/g, ' to the power of ')
        .replace(/\*/g, ' times ')
        .replace(/\//g, ' divided by ')
        .replace(/\(x\)/g, ' of x ')
        .replace(/x²/g, ' x squared ')
        .replace(/x³/g, ' x cubed ')
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, ' and ')
        .replace(/\s+/g, ' ')
        .trim();
    return cleaned;
}

// Read guided step aloud (Guided Practice phase)
function readAloud(buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the current step's text to read
    const step = state.guidedSteps[state.guidedCurrentStep];
    const stepNum = state.guidedCurrentStep + 1;

    // Build the text to read
    let textToRead = `Step ${stepNum}. ${step.prompt}`;

    // Also add the hint if available
    if (step.hint) {
        textToRead += `. Hint: ${step.hint}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Stop speaking
function stopSpeaking() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    resetSpeakingButton();
}

// Reset button state
function resetSpeakingButton() {
    if (currentSpeakingBtn) {
        currentSpeakingBtn.classList.remove('speaking');
        currentSpeakingBtn.innerHTML = '<span class="speaker-icon">🔊</span> Read';
        currentSpeakingBtn = null;
    }
    currentUtterance = null;
}

// Stop speaking when moving to next step
const originalRenderGuidedStep = renderGuidedStep;
renderGuidedStep = function() {
    stopSpeaking();
    originalRenderGuidedStep();
};

// Read a concept step aloud (Learn phase - new format with teachingSteps)
function readConceptStep(stepIndex, buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the step from the lesson
    const lesson = state.currentLesson;
    if (!lesson || !lesson.teachingSteps || !lesson.teachingSteps[stepIndex]) return;

    const step = lesson.teachingSteps[stepIndex];

    // Build the text to read
    let textToRead = `Step ${stepIndex + 1}. ${step.title}. ${step.explanation}`;

    // Add visual if present
    if (step.visual) {
        textToRead += `. ${step.visual}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Read a concept step aloud (Learn phase - old format)
function readConceptStepOld(stepIndex, buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the step from the lesson
    const lesson = state.currentLesson;
    if (!lesson || !lesson.example || !lesson.example.steps || !lesson.example.steps[stepIndex]) return;

    const step = lesson.example.steps[stepIndex];

    // Build the text to read
    let textToRead = `Step ${stepIndex + 1}. ${step.text}`;

    // Add math if present
    if (step.math) {
        textToRead += `. ${step.math}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Common function to handle speech
function speakText(text, buttonElement) {
    // Clean the text
    const textToRead = cleanTextForSpeech(text);

    // Create utterance
    currentUtterance = new SpeechSynthesisUtterance(textToRead);
    currentUtterance.rate = 0.9; // Slightly slower for clarity
    currentUtterance.pitch = 1;
    currentUtterance.volume = 1;

    // Try to use a good voice (prefer US English)
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(v =>
        v.lang.startsWith('en') && (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Samantha'))
    ) || voices.find(v => v.lang.startsWith('en-US')) || voices.find(v => v.lang.startsWith('en'));

    if (preferredVoice) {
        currentUtterance.voice = preferredVoice;
    }

    // Update button state
    currentSpeakingBtn = buttonElement;
    buttonElement.classList.add('speaking');
    buttonElement.innerHTML = '<span class="speaker-icon">🔊</span> Stop';

    // Handle speech end
    currentUtterance.onend = () => {
        resetSpeakingButton();
    };

    currentUtterance.onerror = () => {
        resetSpeakingButton();
    };

    // Start speaking
    speechSynthesis.speak(currentUtterance);
}

// Ensure voices are loaded (some browsers load them asynchronously)
if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}
    </script>
</body>
</html>
