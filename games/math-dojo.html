<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Math Dojo - Train Your Mind</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --slate-900: #0f172a; --slate-800: #1e293b; --slate-700: #334155;
            --slate-600: #475569; --slate-400: #94a3b8; --slate-300: #cbd5e1;
            --slate-200: #e2e8f0; --slate-100: #f1f5f9;
            --amber-500: #f59e0b; --amber-400: #fbbf24; --amber-300: #fcd34d;
            --emerald-500: #10b981; --emerald-400: #34d399;
            --rose-500: #f43f5e; --rose-400: #fb7185;
            --indigo-600: #4f46e5; --cyan-500: #06b6d4; --cyan-400: #22d3ee;
            --violet-500: #8b5cf6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { font-family: 'Source Sans 3', sans-serif; background: linear-gradient(135deg, var(--slate-900), var(--slate-800)); min-height: 100vh; min-height: 100dvh; color: var(--slate-100); line-height: 1.6; overflow-x: hidden; }
        body.fullscreen-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; height: 100dvh; overflow-y: auto; padding-top: env(safe-area-inset-top, 0); padding-bottom: env(safe-area-inset-bottom, 0); }
        .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        h1, h2, h3 { font-family: 'Fraunces', serif; font-weight: 600; }
        .header { text-align: center; padding: 3rem 0; border-bottom: 1px solid var(--slate-700); margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--amber-400), var(--amber-300)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header.testing-center h1 { background: linear-gradient(135deg, var(--cyan-400), var(--cyan-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header p { color: var(--slate-400); font-size: 1.1rem; }
        .header-badge { display: inline-block; padding: 0.35rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
        .badge-placement { background: var(--amber-500); color: var(--slate-900); }
        .badge-testing { background: var(--cyan-500); color: var(--slate-900); }
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mode-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 3rem 0; }
        .mode-card { background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 20px; padding: 2rem; cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden; }
        .mode-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .mode-card.placement::before { background: var(--amber-500); }
        .mode-card.learning::before { background: var(--emerald-500); }
        .mode-card.testing::before { background: var(--cyan-500); }
        .mode-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .mode-card.placement:hover { border-color: var(--amber-500); }
        .mode-card.learning:hover { border-color: var(--emerald-500); }
        .mode-card.testing:hover { border-color: var(--cyan-500); }
        .mode-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .mode-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .mode-card .mode-subtitle { font-weight: 600; margin-bottom: 0.75rem; }
        .mode-card.placement .mode-subtitle { color: var(--amber-400); }
        .mode-card.learning .mode-subtitle { color: var(--emerald-400); }
        .mode-card.testing .mode-subtitle { color: var(--cyan-400); }
        .mode-card .mode-description { color: var(--slate-400); font-size: 0.9rem; }
        .mode-features { margin-top: 1.25rem; text-align: left; }
        .mode-feature { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; color: var(--slate-300); font-size: 0.85rem; }
        .mode-feature .check { color: var(--emerald-400); }
        .level-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin: 3rem 0; }
        .level-card { background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 16px; padding: 2rem 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .level-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--slate-600); }
        .level-card:hover { border-color: var(--amber-500); transform: translateY(-4px); }
        .level-card:hover::before { background: var(--amber-500); }
        .level-card.selected { border-color: var(--amber-400); background: var(--slate-700); }
        .level-card.selected::before { background: var(--amber-400); }
        .level-card h3 { font-size: 1.4rem; margin-bottom: 0.5rem; }
        .level-card .grades { color: var(--amber-400); font-weight: 600; margin-bottom: 1rem; }
        .level-card .tiers { color: var(--slate-400); font-size: 0.9rem; }
        .level-card .tier-list { margin-top: 0.75rem; font-size: 0.85rem; color: var(--slate-500); line-height: 1.8; }
        .tier-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 2rem 0; }
        .tier-option { display: flex; align-items: center; padding: 1rem 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
        .tier-option:hover { border-color: var(--slate-500); background: var(--slate-700); }
        .tier-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .tier-option .tier-checkbox { width: 24px; height: 24px; border: 2px solid var(--slate-500); border-radius: 6px; margin-right: 1rem; display: flex; align-items: center; justify-content: center; }
        .tier-option.selected .tier-checkbox { background: var(--cyan-500); border-color: var(--cyan-500); }
        .tier-option.selected .tier-checkbox::after { content: '✓'; color: var(--slate-900); font-weight: bold; }
        .tier-option .tier-name { font-weight: 600; color: var(--slate-200); }
        .tier-option .tier-grades { font-size: 0.85rem; color: var(--slate-400); }
        .selection-actions { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .selection-btn { padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--slate-700); border: 1px solid var(--slate-600); border-radius: 6px; color: var(--slate-300); cursor: pointer; transition: all 0.2s; }
        .selection-btn:hover { background: var(--slate-600); }
        .selection-btn.active { background: var(--cyan-600); border-color: var(--cyan-500); color: white; }
        .selection-btn.needs-practice-btn { border-color: var(--rose-500); color: var(--rose-400); }
        .selection-btn.needs-practice-btn:hover { background: rgba(244, 63, 94, 0.1); }
        .selection-btn.needs-practice-btn.active { background: var(--rose-600); border-color: var(--rose-500); color: white; }
        .needs-practice-skill { border-color: var(--rose-500) !important; background: rgba(244, 63, 94, 0.1) !important; }
        .needs-practice-skill .priority-badge { position: absolute; top: -6px; right: -6px; background: var(--rose-500); color: white; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 10px; font-weight: 600; }
        .mode-option { padding: 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .mode-option:hover { border-color: var(--slate-500); background: var(--slate-700); }
        .mode-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .time-btn, .count-btn { padding: 0.5rem 1rem; background: var(--slate-700); border: 1px solid var(--slate-600); border-radius: 6px; color: var(--slate-300); cursor: pointer; transition: all 0.2s; }
        .time-btn:hover, .count-btn:hover { background: var(--slate-600); }
        .time-btn.selected, .count-btn.selected { background: var(--cyan-600); border-color: var(--cyan-500); color: white; }
        .skill-option { padding: 0.75rem 1rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .skill-option:hover { border-color: var(--slate-500); }
        .skill-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.15); }
        .skill-option .skill-tier { font-size: 0.7rem; color: var(--slate-400); margin-top: 0.25rem; }
        .skill-option.locked { opacity: 0.5; cursor: not-allowed; background: var(--slate-900); }
        .skill-option.locked:hover { border-color: var(--slate-700); }
        .skill-option.mastered { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .skill-option.needs-review { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 1rem 2.5rem; font-size: 1.1rem; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--amber-500), var(--amber-400)); color: var(--slate-900); box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-cyan { background: linear-gradient(135deg, var(--cyan-500), var(--cyan-400)); color: var(--slate-900); }
        .btn-cyan:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--slate-700); color: var(--slate-200); border: 1px solid var(--slate-600); }
        .btn-ghost { background: transparent; color: var(--slate-400); padding: 0.5rem 1rem; font-size: 0.9rem; }
        .btn-ghost:hover { color: var(--slate-200); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        .phase-header-row { display: flex; justify-content: flex-start; margin-bottom: 0.5rem; }
        .back-to-learn-btn { opacity: 0.8; }
        .back-to-learn-btn:hover { opacity: 1; background: var(--slate-700); }
        .btn-idk { background: var(--slate-600); color: var(--slate-200); border: 2px dashed var(--slate-500); }
        .btn-idk:hover { background: var(--slate-500); border-color: var(--slate-400); }
        .test-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--slate-700); flex-wrap: wrap; gap: 1rem; }
        .test-header.testing-center-header { border-left: 4px solid var(--cyan-500); }
        .progress-info { display: flex; gap: 2rem; }
        .progress-item { text-align: center; }
        .progress-item .label { font-size: 0.8rem; color: var(--slate-400); text-transform: uppercase; }
        .progress-item .value { font-size: 1.5rem; font-weight: 700; color: var(--amber-400); font-family: 'Fraunces', serif; }
        .testing-center-header .progress-item .value { color: var(--cyan-400); }
        .tier-badge { background: var(--slate-700); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; }
        .tier-badge .tier-name { color: var(--amber-400); font-weight: 600; }
        .testing-center-header .tier-badge .tier-name { color: var(--cyan-400); }
        .question-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; }
        .question-meta { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .question-tag { font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 20px; font-weight: 500; text-transform: uppercase; }
        .tag-tier { background: var(--indigo-600); color: white; }
        .tag-domain { background: var(--slate-700); color: var(--slate-300); }
        .tag-type { background: var(--violet-500); color: white; }
        .tag-probe { background: var(--cyan-500); color: var(--slate-900); }
        .tag-practice { background: var(--emerald-500); color: white; }
        .question-text { font-size: 1.4rem; margin-bottom: 2rem; line-height: 1.5; }
        .answer-options { display: grid; gap: 1rem; }
        .answer-option { display: flex; align-items: center; padding: 1.25rem 1.5rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 1.1rem; }
        .answer-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .answer-option.selected { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .testing-center-mode .answer-option.selected { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .answer-option .option-letter { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--slate-600); border-radius: 8px; margin-right: 1rem; font-weight: 700; color: var(--slate-300); flex-shrink: 0; }
        .answer-option.selected .option-letter { background: var(--amber-500); color: var(--slate-900); }
        .testing-center-mode .answer-option.selected .option-letter { background: var(--cyan-500); }
        .answer-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .answer-option.correct .option-letter { background: var(--emerald-500); color: white; }
        .answer-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); }
        .answer-option.incorrect .option-letter { background: var(--rose-500); color: white; }
        .timer-bar { height: 4px; background: var(--slate-700); border-radius: 2px; margin-top: 2rem; overflow: hidden; }
        .timer-fill { height: 100%; background: linear-gradient(90deg, var(--emerald-500), var(--amber-400)); border-radius: 2px; transition: width 0.1s linear; }
        .timer-fill.slow { background: linear-gradient(90deg, var(--amber-400), var(--rose-400)); }
        .timer-display { text-align: center; margin-top: 0.5rem; color: var(--slate-400); font-size: 0.9rem; }
        .explanation-box { margin-top: 1.5rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; border-left: 4px solid var(--cyan-500); display: none; }
        .explanation-box.show { display: block; }
        .explanation-box h4 { color: var(--cyan-400); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; }
        .explanation-box p { color: var(--slate-300); }
        .submit-area { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; flex-wrap: wrap; gap: 1rem; }
        .feedback { padding: 1rem 1.5rem; border-radius: 12px; font-weight: 500; display: none; }
        .feedback.show { display: block; }
        .feedback.correct { background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); border: 1px solid var(--emerald-500); }
        .feedback.incorrect { background: rgba(244, 63, 94, 0.15); color: var(--rose-400); border: 1px solid var(--rose-500); }
        .button-group { display: flex; gap: 0.75rem; }
        .tc-stats-bar { display: flex; gap: 1.5rem; padding: 1rem 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--slate-700); flex-wrap: wrap; }
        .tc-stat { display: flex; align-items: center; gap: 0.5rem; }
        .tc-stat .stat-label { color: var(--slate-400); font-size: 0.85rem; }
        .tc-stat .stat-value { color: var(--slate-200); font-weight: 600; }
        .tc-stat .stat-value.good { color: var(--emerald-400); }
        .tc-stat .stat-value.medium { color: var(--amber-400); }
        .tc-stat .stat-value.poor { color: var(--rose-400); }
        .results-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; }
        .results-card h2 { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .placement-result { text-align: center; padding: 3rem; background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border-radius: 16px; margin-bottom: 2rem; border: 2px solid var(--amber-500); }
        .testing-center-results .placement-result { border-color: var(--cyan-500); }
        .placement-result .tier-number { font-size: 5rem; font-weight: 700; font-family: 'Fraunces', serif; background: linear-gradient(135deg, var(--amber-400), var(--amber-300)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
        .testing-center-results .placement-result .tier-number { background: linear-gradient(135deg, var(--cyan-400), var(--cyan-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .placement-result .tier-title { font-size: 1.8rem; font-family: 'Fraunces', serif; margin-top: 0.5rem; }
        .placement-result .tier-grades { color: var(--slate-400); margin-top: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--slate-700); border-radius: 12px; padding: 1.5rem; text-align: center; }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; font-family: 'Fraunces', serif; color: var(--amber-400); }
        .testing-center-results .stat-card .stat-value { color: var(--cyan-400); }
        .stat-card .stat-label { font-size: 0.8rem; color: var(--slate-400); text-transform: uppercase; margin-top: 0.25rem; }
        .fluency-badge { display: inline-block; padding: 0.5rem 1.5rem; border-radius: 20px; font-weight: 600; margin-top: 1rem; }
        .fluency-automatic { background: var(--emerald-500); color: white; }
        .fluency-normal { background: var(--amber-500); color: var(--slate-900); }
        .fluency-slow { background: var(--rose-500); color: white; }
        .tier-row { display: flex; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--slate-700); }
        .tier-row:last-child { border-bottom: none; }
        .tier-row .tier-label { width: 180px; font-weight: 500; color: var(--slate-300); }
        .tier-row .tier-bar { flex: 1; height: 24px; background: var(--slate-700); border-radius: 4px; overflow: hidden; margin: 0 1rem; }
        .tier-row .tier-fill { height: 100%; border-radius: 4px; }
        .tier-row .tier-fill.good { background: var(--emerald-500); }
        .tier-row .tier-fill.medium { background: var(--amber-500); }
        .tier-row .tier-fill.poor { background: var(--rose-500); }
        .tier-row .tier-score { width: 60px; text-align: right; font-weight: 600; color: var(--slate-300); }
        .gap-item { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; border-left: 3px solid var(--rose-500); }
        .gap-item.idk { border-left-color: var(--slate-400); }
        .gap-item .gap-tier { background: var(--slate-600); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; margin-right: 1rem; }
        .gap-item .gap-skill { color: var(--slate-300); }
        .no-gaps { color: var(--emerald-400); padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center; }
        .rec-item { display: flex; align-items: flex-start; padding: 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; }
        .rec-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: var(--amber-500); border-radius: 10px; margin-right: 1rem; font-size: 1.2rem; flex-shrink: 0; }
        .testing-center-results .rec-icon { background: var(--cyan-500); }
        .rec-content h4 { font-size: 1rem; margin-bottom: 0.25rem; }
        .rec-content p { color: var(--slate-400); font-size: 0.9rem; }
        .question-history { max-height: 400px; overflow-y: auto; margin-top: 1rem; }
        .history-item { display: flex; align-items: center; padding: 0.75rem 1rem; background: var(--slate-700); border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .history-item .q-number { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 700; margin-right: 1rem; flex-shrink: 0; }
        .history-item.correct .q-number { background: var(--emerald-500); color: white; }
        .history-item.incorrect .q-number { background: var(--rose-500); color: white; }
        .history-item.idk .q-number { background: var(--slate-500); color: white; }
        
        /* Learning Center Styles */
        .header.learning-center h1 { background: linear-gradient(135deg, var(--emerald-400), var(--emerald-500)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .badge-learning { background: var(--emerald-500); color: var(--slate-900); }
        .btn-emerald { background: linear-gradient(135deg, var(--emerald-500), var(--emerald-400)); color: var(--slate-900); }
        .btn-emerald:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .tier-select-row { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-bottom: 1rem; }
        .tier-select-btn { padding: 0.6rem 1rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; color: var(--slate-300); cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .tier-select-btn:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .tier-select-btn.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); }
        
        .skill-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
        .skill-card { padding: 1.25rem; background: var(--slate-800); border: 2px solid var(--slate-700); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; position: relative; }
        .skill-card:hover { border-color: var(--slate-500); transform: translateY(-2px); }
        .skill-card.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .skill-card .skill-name { font-weight: 600; color: var(--slate-200); margin-bottom: 0.25rem; }
        .skill-card .skill-desc { font-size: 0.8rem; color: var(--slate-400); }

        /* Skill card states for tree integration */
        .skill-card.locked { opacity: 0.6; cursor: not-allowed; background: var(--slate-900); border-color: var(--slate-800); }
        .skill-card.locked:hover { transform: none; border-color: var(--slate-700); }
        .skill-card.locked .skill-name { color: var(--slate-500); }
        .skill-card.mastered { border-color: var(--amber-500); background: rgba(245, 158, 11, 0.1); }
        .skill-card.mastered:hover { border-color: var(--amber-400); }
        .skill-card.in-progress { border-color: var(--cyan-500); background: rgba(6, 182, 212, 0.1); }
        .skill-card.needs-review { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.1); animation: pulseReview 2s ease-in-out infinite; }
        @keyframes pulseReview { 0%, 100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(244, 63, 94, 0); } }

        .skill-lock-icon { font-size: 1.5rem; margin: 0.5rem 0; }
        .skill-prereq-hint { font-size: 0.7rem; color: var(--slate-500); margin-top: 0.5rem; line-height: 1.3; }
        .skill-mastery-bar { height: 4px; background: var(--slate-700); border-radius: 2px; margin-top: 0.5rem; overflow: hidden; }

        /* Skill Legend */
        .skill-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 0.75rem 1rem;
            background: var(--slate-900);
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }
        .skill-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--slate-400);
        }
        .skill-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid;
        }
        .skill-legend-dot.available { background: var(--slate-800); border-color: var(--slate-600); }
        .skill-legend-dot.in-progress { background: rgba(6, 182, 212, 0.2); border-color: var(--cyan-500); }
        .skill-legend-dot.mastered { background: rgba(245, 158, 11, 0.2); border-color: var(--amber-500); }
        .skill-legend-dot.needs-review { background: rgba(244, 63, 94, 0.2); border-color: var(--rose-500); }
        .skill-legend-dot.locked { background: var(--slate-900); border-color: var(--slate-700); opacity: 0.6; }
        .skill-mastery-fill { height: 100%; background: linear-gradient(90deg, var(--emerald-500), var(--amber-400)); border-radius: 2px; transition: width 0.3s ease; }
        .skill-badge { position: absolute; top: -8px; right: -8px; font-size: 0.65rem; padding: 0.2rem 0.5rem; border-radius: 10px; font-weight: 600; }
        .skill-badge.mastered { background: var(--amber-500); color: var(--slate-900); }
        .skill-badge.needs-review { background: var(--rose-500); color: white; }

        /* Notification toast animations */
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

        /* Belt Test → Tree Sync Results */
        .tree-sync-results { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; }
        .tree-sync-results h3 { font-family: 'Fraunces', serif; }
        .tree-sync-results .result-section { margin-bottom: 1rem; }
        .tree-sync-results h4 { font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 600; }
        .skill-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .skill-chip { display: inline-block; padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .skill-chip.mastered { background: rgba(245, 158, 11, 0.2); color: var(--amber-400); border: 1px solid var(--amber-500); }
        .skill-chip.activated { background: rgba(6, 182, 212, 0.2); color: var(--cyan-400); border: 1px solid var(--cyan-500); }
        .skill-chip.in-progress { background: rgba(148, 163, 184, 0.2); color: var(--slate-400); border: 1px solid var(--slate-600); }
        .skill-chip.inferred-mastered { background: rgba(139, 92, 246, 0.2); color: var(--violet-400); border: 1px solid var(--violet-500); }
        .skill-chip.inferred-activated { background: rgba(139, 92, 246, 0.15); color: var(--violet-300); border: 1px solid var(--violet-600); }
        .skill-chip.more { background: var(--slate-700); color: var(--slate-400); border: 1px solid var(--slate-600); }

        .learning-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; background: var(--slate-800); border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid var(--emerald-500); flex-wrap: wrap; gap: 1rem; }
        .learning-progress { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .phase-indicator { display: flex; align-items: center; gap: 0; }
        .phase-dot { width: 32px; height: 32px; border-radius: 50%; background: var(--slate-700); border: 2px solid var(--slate-600); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: var(--slate-400); }
        .phase-dot.active { background: var(--emerald-500); border-color: var(--emerald-500); color: var(--slate-900); }
        .phase-dot.completed { background: var(--emerald-600); border-color: var(--emerald-500); color: white; }
        .phase-line { width: 40px; height: 3px; background: var(--slate-700); }
        .phase-line.completed { background: var(--emerald-500); }
        .phase-labels { display: flex; gap: 2rem; }
        .phase-label { font-size: 0.8rem; color: var(--slate-500); text-transform: uppercase; }
        .phase-label.active { color: var(--emerald-400); font-weight: 600; }
        
        .learning-skill-badge { display: flex; gap: 0.75rem; align-items: center; }
        .learning-skill-badge span:first-child { background: var(--indigo-600); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
        .learning-skill-badge span:last-child { color: var(--emerald-400); font-weight: 600; font-size: 1.1rem; }
        
        .learning-card { background: var(--slate-800); border: 1px solid var(--slate-700); border-radius: 20px; padding: 2.5rem; min-height: 400px; }
        .phase-content { display: none; animation: fadeIn 0.4s ease; }
        .phase-content.active { display: block; }
        .phase-content h2 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--emerald-400); }
        .phase-intro { color: var(--slate-400); margin-bottom: 1.5rem; }
        
        .concept-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--slate-700); }
        .concept-text { color: var(--slate-300); font-size: 1.1rem; line-height: 1.7; }
        .concept-text strong { color: var(--emerald-400); }

        /* Step-by-step concept teaching styles */
        .concept-steps { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; }
        .concept-step { padding: 1.25rem; background: var(--slate-700); border-radius: 12px; border-left: 4px solid var(--slate-600); opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .concept-step.visible { opacity: 1; transform: translateY(0); border-left-color: var(--emerald-500); }
        .concept-step .step-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .concept-step .step-number { background: var(--emerald-500); color: var(--slate-900); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0; }
        .concept-step .step-title { color: var(--emerald-400); font-weight: 600; font-size: 1.05rem; flex: 1; }
        .concept-step .step-read-btn { margin-left: auto; }
        .concept-step .step-explanation { color: var(--slate-300); line-height: 1.6; }
        .concept-step .step-visual { margin-top: 0.75rem; padding: 1rem; background: var(--slate-800); border-radius: 8px; font-family: monospace; color: var(--amber-400); font-size: 1.1rem; text-align: center; }

        .concept-reveal-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: var(--slate-700); border: 2px solid var(--emerald-500); border-radius: 8px; color: var(--emerald-400); cursor: pointer; font-size: 1rem; transition: all 0.2s; margin: 1rem auto; }
        .concept-reveal-btn:hover { background: rgba(16, 185, 129, 0.15); }
        .concept-reveal-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--slate-600); color: var(--slate-500); }
        .concept-reveal-btn .btn-icon { font-size: 1.2rem; }

        .starting-problem { background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border: 2px solid var(--indigo-500); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .starting-problem .problem-label { color: var(--indigo-400); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .starting-problem .problem-text { font-size: 1.4rem; color: var(--slate-100); font-family: monospace; }

        .final-answer { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 2px solid var(--emerald-500); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; opacity: 0; transform: scale(0.95); transition: all 0.4s ease; }
        .final-answer.visible { opacity: 1; transform: scale(1); }
        .final-answer .answer-label { color: var(--emerald-400); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .final-answer .answer-text { font-size: 1.6rem; color: var(--emerald-300); font-family: monospace; font-weight: 700; }
        .final-answer .answer-explanation { color: var(--slate-400); margin-top: 0.5rem; font-size: 0.95rem; }
        
        .example-section { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--slate-700); }
        .example-section h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .example-problem { font-size: 1.3rem; padding: 1rem 1.5rem; background: var(--slate-700); border-radius: 10px; margin-bottom: 1rem; font-family: 'Source Sans 3', monospace; }
        .example-steps { display: flex; flex-direction: column; gap: 0.75rem; }
        .example-step { display: flex; align-items: flex-start; gap: 1rem; padding: 0.75rem 1rem; background: #283548; border-radius: 8px; border-left: 3px solid var(--emerald-500); }
        .example-step .step-num { background: var(--emerald-500); color: var(--slate-900); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; }
        .example-step .step-content { color: var(--slate-300); }
        .example-step .step-math { font-family: monospace; color: var(--amber-400); margin-top: 0.25rem; }
        
        .key-points { margin-bottom: 2rem; }
        .key-points h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .key-points ul { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .key-points li { padding: 0.5rem 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; color: var(--slate-300); border-left: 3px solid var(--emerald-500); }
        
        .common-mistakes h3 { color: var(--slate-200); margin-bottom: 1rem; }
        .mistake-item { padding: 1rem; background: rgba(244, 63, 94, 0.1); border-radius: 8px; margin-bottom: 0.75rem; border-left: 3px solid var(--rose-500); }
        .mistake-item .mistake-wrong { color: var(--rose-400); font-weight: 600; margin-bottom: 0.25rem; }
        .mistake-item .mistake-why { color: var(--slate-400); font-size: 0.9rem; }
        
        .practice-problem { font-size: 1.4rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; margin-bottom: 1.5rem; text-align: center; }
        .practice-progress { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--slate-800); border-radius: 8px; }
        .practice-progress .progress-text { color: var(--slate-300); font-weight: 600; }
        .practice-progress .progress-dots { display: flex; gap: 0.5rem; }
        .practice-progress .progress-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--slate-600); transition: all 0.3s; }
        .practice-progress .progress-dot.completed { background: var(--emerald-500); }

        /* New Interactive Guided Phase Styles */
        .guided-problem-card { background: linear-gradient(135deg, var(--slate-700), var(--slate-800)); border: 2px solid var(--indigo-500); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .guided-problem-label { color: var(--indigo-400); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .guided-problem { font-size: 1.3rem; color: var(--slate-100); text-align: center; }

        .guided-progress { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: var(--slate-800); border-radius: 8px; }
        .guided-progress .progress-text { color: var(--slate-400); font-size: 0.9rem; }
        .guided-progress .progress-dots { display: flex; gap: 0.5rem; }
        .guided-progress .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--slate-600); transition: all 0.3s; }
        .guided-progress .dot.completed { background: var(--emerald-500); }
        .guided-progress .dot.current { background: var(--amber-400); transform: scale(1.2); }

        .guided-steps-container { min-height: 200px; }
        .guided-completed-steps { margin-bottom: 1rem; }
        .guided-completed-step { padding: 1rem 1.25rem; background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--emerald-500); border-radius: 0 8px 8px 0; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem; }
        .guided-completed-step .step-num { width: 28px; height: 28px; background: var(--emerald-500); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 600; }
        .guided-completed-step .step-content { flex: 1; }
        .guided-completed-step .step-question { color: var(--slate-400); font-size: 0.9rem; }
        .guided-completed-step .step-answer { color: var(--emerald-400); font-weight: 600; font-family: monospace; }

        .guided-current-step-area { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05)); border: 2px solid var(--amber-500); border-radius: 12px; padding: 1.5rem; }
        .step-prompt { font-size: 1.2rem; color: var(--slate-100); margin-bottom: 0.75rem; text-align: center; }
        .step-hint { color: var(--slate-400); font-size: 0.95rem; margin-bottom: 1.25rem; text-align: center; font-style: italic; }

        .guided-input-area { display: flex; gap: 1rem; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem; }
        .guided-input { padding: 0.75rem 1.25rem; font-size: 1.3rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; color: var(--slate-100); width: 180px; text-align: center; font-family: monospace; }
        .guided-input:focus { outline: none; border-color: var(--amber-400); box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2); }
        .guided-submit { padding: 0.75rem 1.5rem; }

        .guided-feedback { padding: 1rem 1.5rem; border-radius: 10px; margin-top: 1rem; display: none; }
        .guided-feedback.show { display: block; animation: slideIn 0.3s ease; }
        .guided-feedback.correct { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--emerald-500); color: var(--emerald-400); }
        .guided-feedback.incorrect { background: rgba(244, 63, 94, 0.15); border: 1px solid var(--rose-500); color: var(--rose-400); }
        .guided-feedback.hint { background: rgba(251, 191, 36, 0.15); border: 1px solid var(--amber-500); color: var(--amber-400); }
        .guided-feedback .mistake-tip { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid rgba(244, 63, 94, 0.3); font-size: 0.95rem; }

        .guided-completion { text-align: center; padding: 2rem; }
        .guided-completion .completion-icon { font-size: 3rem; margin-bottom: 1rem; }
        .guided-completion .completion-message { font-size: 1.3rem; color: var(--emerald-400); margin-bottom: 1rem; }
        .final-answer-display { background: rgba(16, 185, 129, 0.15); border: 2px solid var(--emerald-500); border-radius: 12px; padding: 1.25rem; font-size: 1.4rem; color: var(--slate-100); font-family: monospace; }

        .guided-inline-actions { display: flex; justify-content: center; margin-top: 1.5rem; }

        /* Read Aloud Button Styles */
        .read-aloud-btn { background: var(--slate-600); border: 1px solid var(--slate-500); color: var(--slate-300); padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; transition: all 0.2s; }
        .read-aloud-btn:hover { background: var(--slate-500); color: var(--slate-100); }
        .read-aloud-btn.speaking { background: var(--emerald-600); border-color: var(--emerald-500); color: white; animation: pulse 1.5s infinite; }
        .read-aloud-btn .speaker-icon { font-size: 1rem; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .step-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .step-prompt-text { flex: 1; font-size: 1.2rem; color: var(--slate-100); text-align: center; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .practice-feedback { padding: 1rem 1.5rem; border-radius: 10px; margin-top: 1rem; display: none; }
        .practice-feedback.show { display: block; }
        .practice-feedback.correct { background: rgba(16, 185, 129, 0.15); border: 1px solid var(--emerald-500); color: var(--emerald-400); }
        .practice-feedback.incorrect { background: rgba(244, 63, 94, 0.15); border: 1px solid var(--rose-500); color: var(--rose-400); }
        
        .practice-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .practice-option { padding: 1.25rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 12px; cursor: pointer; text-align: center; font-size: 1.2rem; transition: all 0.2s; }
        .practice-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .practice-option.selected { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.1); }
        .practice-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); }
        .practice-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.15); }
        .practice-option.correct-answer { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.2); }
        
        .mistake-analysis { margin-top: 1.5rem; padding: 1.5rem; background: var(--slate-700); border-radius: 12px; display: none; }
        .mistake-analysis.show { display: block; }
        .mistake-analysis h4 { color: var(--amber-400); margin-bottom: 0.75rem; }
        .mistake-analysis p { color: var(--slate-300); }
        .practice-ok-btn { margin-top: 1rem; width: 100%; }

        .guided-select-options { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; }
        .guided-select-option { padding: 0.75rem 1.5rem; background: var(--slate-700); border: 2px solid var(--slate-600); border-radius: 8px; cursor: pointer; font-size: 1rem; color: var(--slate-200); transition: all 0.2s; }
        .guided-select-option:hover { border-color: var(--slate-500); background: var(--slate-600); }
        .guided-select-option.selected { border-color: var(--emerald-500); }
        .guided-select-option.correct { border-color: var(--emerald-500); background: rgba(16, 185, 129, 0.15); color: var(--emerald-400); }
        .guided-select-option.incorrect { border-color: var(--rose-500); background: rgba(244, 63, 94, 0.15); color: var(--rose-400); }
        
        .learning-actions { display: flex; justify-content: space-between; margin-top: 2rem; }
        .history-item .q-text { flex: 1; color: var(--slate-300); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item .q-time { margin-left: 1rem; color: var(--slate-500); font-size: 0.85rem; }
        .history-item .q-tier { margin-left: 0.75rem; font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--slate-600); border-radius: 4px; color: var(--slate-400); }
        @media (max-width: 900px) {
            .mode-selector { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .level-selector, .tier-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .test-header { flex-direction: column; }
            .practice-options { grid-template-columns: 1fr; }
        }

        /* Visual Container Styles */
        .visual-container {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60px;
        }
        .visual-container:empty { display: none; }

        /* Number Line Styles */
        .dojo-number-line {
            position: relative;
            width: 100%;
            max-width: 500px;
            padding: 2rem 1rem 1.5rem;
            user-select: none;
            touch-action: none;
        }
        .dojo-number-line-track {
            position: relative;
            height: 4px;
            background: var(--slate-600);
            border-radius: 2px;
        }
        .dojo-number-line-tick {
            position: absolute;
            width: 2px;
            height: 12px;
            background: var(--slate-500);
            transform: translateX(-50%);
            top: -4px;
        }
        .dojo-number-line-tick.major {
            height: 16px;
            background: var(--slate-400);
            top: -6px;
        }
        .dojo-number-line-label {
            position: absolute;
            transform: translateX(-50%);
            top: 16px;
            font-size: 0.8rem;
            color: var(--slate-400);
        }
        .dojo-number-line-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--amber-500);
            border-radius: 50%;
            top: -8px;
            transform: translateX(-50%);
            cursor: grab;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
            z-index: 10;
        }
        .dojo-number-line-marker:hover { transform: translateX(-50%) scale(1.1); }
        .dojo-number-line-marker.dragging {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.2);
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.6);
        }
        .dojo-number-line-value {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--slate-700);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--amber-400);
            font-weight: 600;
            white-space: nowrap;
        }
        .dojo-number-line-fixed-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--cyan-500);
            border-radius: 50%;
            top: -2px;
            transform: translateX(-50%);
        }

        /* Shape Styles */
        .dojo-shape-svg {
            max-width: 300px;
            max-height: 200px;
        }
        .dojo-shape-svg .shape-fill { fill: rgba(139, 92, 246, 0.2); stroke: var(--violet-500); stroke-width: 2; }
        .dojo-shape-svg .shape-fill.shaded { fill: rgba(139, 92, 246, 0.5); }
        .dojo-shape-svg .dimension-line { stroke: var(--slate-400); stroke-width: 1; stroke-dasharray: 4 2; }
        .dojo-shape-svg .dimension-text { fill: var(--slate-300); font-size: 12px; }
        .dojo-shape-svg .angle-arc { fill: none; stroke: var(--amber-400); stroke-width: 1.5; }
        .dojo-shape-svg .angle-text { fill: var(--amber-400); font-size: 11px; }
        .dojo-shape-svg .highlight { stroke: var(--amber-500); stroke-width: 3; }

        /* Coordinate Plane Styles */
        .dojo-coordinate-svg {
            max-width: 350px;
            max-height: 350px;
            background: var(--slate-800);
            border-radius: 8px;
        }
        .dojo-coordinate-svg .grid-line { stroke: var(--slate-700); stroke-width: 1; }
        .dojo-coordinate-svg .axis-line { stroke: var(--slate-400); stroke-width: 2; }
        .dojo-coordinate-svg .axis-label { fill: var(--slate-400); font-size: 10px; }
        .dojo-coordinate-svg .plot-point { fill: var(--cyan-500); }
        .dojo-coordinate-svg .plot-point.interactive { cursor: pointer; fill: var(--amber-500); }
        .dojo-coordinate-svg .graph-line { fill: none; stroke: var(--emerald-500); stroke-width: 2; }
        .dojo-coordinate-svg .graph-line.secondary { stroke: var(--amber-500); }
        .dojo-coordinate-svg .point-label { fill: var(--slate-300); font-size: 11px; }

        /* Fraction Visual Styles */
        .dojo-fraction-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .dojo-fraction-row {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .dojo-fraction-bar {
            display: flex;
            border: 2px solid var(--slate-500);
            border-radius: 4px;
            overflow: hidden;
            height: 40px;
            min-width: 200px;
        }
        .dojo-fraction-bar-segment {
            flex: 1;
            border-right: 1px solid var(--slate-600);
            background: var(--slate-700);
        }
        .dojo-fraction-bar-segment:last-child { border-right: none; }
        .dojo-fraction-bar-segment.filled { background: var(--violet-500); }
        .dojo-fraction-label {
            font-size: 1.2rem;
            color: var(--slate-300);
            font-weight: 600;
        }
        .dojo-fraction-circle {
            width: 120px;
            height: 120px;
        }
        .dojo-fraction-circle .slice { fill: var(--slate-700); stroke: var(--slate-500); stroke-width: 2; }
        .dojo-fraction-circle .slice.filled { fill: var(--violet-500); }

        /* Clock Styles */
        .dojo-clock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        .dojo-clock-canvas {
            background: var(--slate-700);
            border-radius: 50%;
            border: 3px solid var(--slate-500);
        }
        .dojo-clock-display {
            font-size: 1.2rem;
            color: var(--amber-400);
            font-weight: 600;
        }

        /* Chart Styles */
        .dojo-chart-container {
            width: 100%;
            max-width: 400px;
        }
        .dojo-bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 0.75rem;
            height: 150px;
            padding: 0.5rem;
            border-left: 2px solid var(--slate-500);
            border-bottom: 2px solid var(--slate-500);
        }
        .dojo-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
        }
        .dojo-bar-fill {
            width: 100%;
            background: linear-gradient(to top, var(--cyan-600), var(--cyan-400));
            border-radius: 4px 4px 0 0;
            transition: height 0.3s;
        }
        .dojo-bar-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--slate-400);
            text-align: center;
        }
        .dojo-bar-value {
            font-size: 0.8rem;
            color: var(--slate-200);
            margin-bottom: 0.25rem;
        }
        .dojo-line-chart {
            position: relative;
            height: 150px;
            padding: 0.5rem;
            border-left: 2px solid var(--slate-500);
            border-bottom: 2px solid var(--slate-500);
        }
        .dojo-line-chart svg { width: 100%; height: 100%; }
        .dojo-line-chart .chart-line { fill: none; stroke: var(--emerald-500); stroke-width: 2; }
        .dojo-line-chart .chart-point { fill: var(--emerald-400); }
        .dojo-picture-chart {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .dojo-picture-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .dojo-picture-row-label {
            min-width: 60px;
            font-size: 0.85rem;
            color: var(--slate-400);
        }
        .dojo-picture-icons {
            display: flex;
            gap: 0.25rem;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mode-screen" class="screen active">
            <header class="header"><h1>🥋 Math Dojo</h1><p>Train Your Mind, Master Your Skills</p></header>
            <h2 style="text-align:center;margin-bottom:1rem;color:var(--slate-200)">Choose Your Training</h2>
            <p style="text-align:center;color:var(--slate-400);margin-bottom:2rem">Select your path to mathematical mastery</p>
            <div class="mode-selector">
                <div class="mode-card placement" onclick="selectMode('placement')">
                    <div class="mode-icon">🎖️</div><h3>Belt Test</h3>
                    <div class="mode-subtitle">Prove Your Skill</div>
                    <div class="mode-description">Take an adaptive test to earn your math belt ranking.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">✓</span> Adaptive difficulty</div>
                        <div class="mode-feature"><span class="check">✓</span> Earn your belt rank</div>
                        <div class="mode-feature"><span class="check">✓</span> Weakness analysis</div>
                        <div class="mode-feature"><span class="check">✓</span> 20-40 adaptive challenges</div>
                    </div>
                </div>
                <div class="mode-card learning" onclick="selectMode('learning')">
                    <div class="mode-icon">🥋</div><h3>Training Grounds</h3>
                    <div class="mode-subtitle">Learn the Forms</div>
                    <div class="mode-description">Master new techniques step-by-step with a sensei's guidance.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">✓</span> Technique breakdowns</div>
                        <div class="mode-feature"><span class="check">✓</span> Worked examples</div>
                        <div class="mode-feature"><span class="check">✓</span> Guided practice</div>
                        <div class="mode-feature"><span class="check">✓</span> Error correction</div>
                    </div>
                </div>
                <div class="mode-card testing" onclick="selectMode('testing')">
                    <div class="mode-icon">⚔️</div><h3>Sparring Arena</h3>
                    <div class="mode-subtitle">Hone Your Skills</div>
                    <div class="mode-description">Practice specific techniques at your own pace.</div>
                    <div class="mode-features">
                        <div class="mode-feature"><span class="check">✓</span> Choose your challenges</div>
                        <div class="mode-feature"><span class="check">✓</span> Unlimited practice</div>
                        <div class="mode-feature"><span class="check">✓</span> Detailed feedback</div>
                        <div class="mode-feature"><span class="check">✓</span> End anytime</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="placement-setup-screen" class="screen">
            <header class="header"><div class="header-badge badge-placement">Belt Test</div><h1>🎖️ Belt Ranking Assessment</h1><p>Prove Your Mathematical Prowess</p></header>
            <h2 style="text-align:center;margin-bottom:1rem;color:var(--slate-200)">Select Your Starting Dojo</h2>
            <p style="text-align:center;color:var(--slate-400);margin-bottom:2rem">Choose the level closest to your current ability.</p>
            <div class="level-selector">
                <div class="level-card" onclick="selectLevel(this, 2)"><h3>Elementary</h3><div class="grades">Grades K-4</div><div class="tiers">Starts at Tier 2</div><div class="tier-list">Counting • Addition/Subtraction<br>Multiplication • Division</div></div>
                <div class="level-card" onclick="selectLevel(this, 5)"><h3>Middle School</h3><div class="grades">Grades 5-8</div><div class="tiers">Starts at Tier 5</div><div class="tier-list">Algebra I • Pre-Algebra<br>Equations • Functions</div></div>
                <div class="level-card" onclick="selectLevel(this, 7)"><h3>High School</h3><div class="grades">Grades 9-12</div><div class="tiers">Starts at Tier 7</div><div class="tier-list">Algebra II • Geometry<br>Pre-Calculus • Trigonometry</div></div>
            </div>
            <div style="display:flex;gap:1rem;justify-content:center"><button class="btn btn-ghost" onclick="goToModeSelect()">← Back</button><button id="start-placement-btn" class="btn btn-primary" onclick="startPlacementTest()" disabled>Begin Belt Test</button></div>
        </div>

        <div id="testing-setup-screen" class="screen">
            <header class="header testing-center"><div class="header-badge badge-testing">Sparring Arena</div><h1>⚔️ Sparring Arena</h1><p>Configure your training session</p></header>
            <div class="testing-mode">
                <!-- Selection Mode Toggle -->
                <div style="display:flex;gap:1rem;justify-content:center;margin-bottom:1.5rem;flex-wrap:wrap;">
                    <button class="selection-btn active" id="select-by-tier-btn" onclick="setSelectionMode('tier')">Select by Tier</button>
                    <button class="selection-btn" id="select-by-skill-btn" onclick="setSelectionMode('skill')">Select by Skill</button>
                    <button class="selection-btn needs-practice-btn" id="select-needs-practice-btn" onclick="setSelectionMode('needs-practice')">🎯 Needs Practice</button>
                </div>

                <!-- Needs Practice Panel -->
                <div id="needs-practice-panel" style="display:none;">
                    <h2 style="margin-bottom:1rem;color:var(--rose-400)">🎯 Skills That Need Practice</h2>
                    <p style="color:var(--slate-400);margin-bottom:1rem;">Auto-targeting skills based on your skill tree progress: decayed skills, low mastery, and skills you're working on.</p>
                    <div id="needs-practice-summary" style="margin-bottom:1rem;"></div>
                    <div class="skill-grid" id="needs-practice-grid" style="max-height:300px;overflow-y:auto;padding:0.5rem;"></div>
                    <div id="no-needs-practice" style="display:none;text-align:center;padding:2rem;color:var(--slate-400);">
                        <div style="font-size:3rem;margin-bottom:1rem;">✨</div>
                        <div style="font-size:1.1rem;">All caught up! No skills need practice right now.</div>
                        <div style="font-size:0.9rem;margin-top:0.5rem;">Try the Belt Test to unlock more skills.</div>
                    </div>
                </div>

                <!-- Tier Selection Panel -->
                <div id="tier-selection-panel">
                    <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select Tiers to Practice</h2>
                    <div class="selection-actions">
                        <button class="selection-btn" onclick="selectAllTiers()">Select All</button>
                        <button class="selection-btn" onclick="clearTierSelection()">Clear All</button>
                        <button class="selection-btn" onclick="selectTierRange(1,2)">Elementary</button>
                        <button class="selection-btn" onclick="selectTierRange(3,5)">Middle</button>
                        <button class="selection-btn" onclick="selectTierRange(6,10)">High</button>
                    </div>
                    <div class="tier-grid" id="tier-selection-grid"></div>
                </div>

                <!-- Skill Selection Panel -->
                <div id="skill-selection-panel" style="display:none;">
                    <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select Skills to Practice</h2>
                    <div class="selection-actions">
                        <button class="selection-btn" onclick="selectAllSkills()">Select All</button>
                        <button class="selection-btn" onclick="clearSkillSelection()">Clear All</button>
                    </div>
                    <div style="margin:1rem 0;">
                        <label style="color:var(--slate-300);margin-right:0.5rem;">Filter by Tier:</label>
                        <select id="skill-tier-filter" onchange="filterSkillsByTier()" style="padding:0.5rem;border-radius:8px;background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600);">
                            <option value="all">All Tiers</option>
                        </select>
                    </div>
                    <div class="skill-legend">
                        <div class="skill-legend-item"><span class="skill-legend-dot available"></span> Available</div>
                        <div class="skill-legend-item"><span class="skill-legend-dot mastered"></span> Mastered</div>
                        <div class="skill-legend-item"><span class="skill-legend-dot needs-review"></span> Needs Review</div>
                        <div class="skill-legend-item"><span class="skill-legend-dot locked"></span> Locked</div>
                    </div>
                    <div class="skill-grid" id="arena-skill-grid" style="max-height:300px;overflow-y:auto;padding:0.5rem;"></div>
                </div>

                <!-- Practice Mode Options -->
                <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--slate-700);">
                    <h2 style="margin-bottom:1rem;color:var(--slate-200)">Practice Mode</h2>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
                        <div class="mode-option selected" data-practice-mode="endless" onclick="setPracticeMode('endless')">
                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">♾️</div>
                            <div style="font-weight:600;color:var(--slate-200);">Endless</div>
                            <div style="font-size:0.8rem;color:var(--slate-400);">Practice until you stop</div>
                        </div>
                        <div class="mode-option" data-practice-mode="timed" onclick="setPracticeMode('timed')">
                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">⏱️</div>
                            <div style="font-weight:600;color:var(--slate-200);">Timed Challenge</div>
                            <div style="font-size:0.8rem;color:var(--slate-400);">Complete as many as possible</div>
                        </div>
                        <div class="mode-option" data-practice-mode="countdown" onclick="setPracticeMode('countdown')">
                            <div style="font-size:1.5rem;margin-bottom:0.5rem;">🎯</div>
                            <div style="font-weight:600;color:var(--slate-200);">Question Goal</div>
                            <div style="font-size:0.8rem;color:var(--slate-400);">Race to finish N questions</div>
                        </div>
                    </div>

                    <!-- Timed Mode Options -->
                    <div id="timed-options" style="display:none;margin-top:1rem;padding:1rem;background:var(--slate-800);border-radius:12px;">
                        <label style="color:var(--slate-300);">Time Limit:</label>
                        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;align-items:center;">
                            <button class="time-btn selected" data-time="60" onclick="setTimeLimit(60)">1 min</button>
                            <button class="time-btn" data-time="120" onclick="setTimeLimit(120)">2 min</button>
                            <button class="time-btn" data-time="300" onclick="setTimeLimit(300)">5 min</button>
                            <button class="time-btn" data-time="600" onclick="setTimeLimit(600)">10 min</button>
                            <div style="display:flex;align-items:center;gap:0.5rem;">
                                <input type="number" id="custom-time-input" min="1" max="60" placeholder="Custom" style="width:70px;padding:0.5rem;border-radius:8px;background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600);text-align:center;" onchange="setCustomTimeLimit()">
                                <span style="color:var(--slate-400);">min</span>
                            </div>
                        </div>
                    </div>

                    <!-- Countdown Mode Options -->
                    <div id="countdown-options" style="display:none;margin-top:1rem;padding:1rem;background:var(--slate-800);border-radius:12px;">
                        <label style="color:var(--slate-300);">Number of Questions:</label>
                        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;align-items:center;">
                            <button class="count-btn selected" data-count="10" onclick="setQuestionCount(10)">10</button>
                            <button class="count-btn" data-count="20" onclick="setQuestionCount(20)">20</button>
                            <button class="count-btn" data-count="30" onclick="setQuestionCount(30)">30</button>
                            <button class="count-btn" data-count="50" onclick="setQuestionCount(50)">50</button>
                            <input type="number" id="custom-count-input" min="1" max="500" placeholder="Custom" style="width:80px;padding:0.5rem;border-radius:8px;background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600);text-align:center;" onchange="setCustomQuestionCount()">
                        </div>
                    </div>
                </div>

                <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem"><button class="btn btn-ghost" onclick="goToModeSelect()">← Back</button><button id="start-testing-btn" class="btn btn-cyan" onclick="startTestingCenter()" disabled>Enter the Arena</button></div>
            </div>
        </div>

        <div id="learning-setup-screen" class="screen">
            <header class="header learning-center"><div class="header-badge badge-learning">Training Grounds</div><h1>🥋 Training Grounds</h1><p>Learn new techniques with guided instruction</p></header>
            <div class="learning-setup">
                <h2 style="margin-bottom:1rem;color:var(--slate-200)">Select a Discipline</h2>
                <div class="tier-select-row" id="learning-tier-select"></div>
                <h2 style="margin:2rem 0 1rem;color:var(--slate-200)">Select a Technique to Learn</h2>
                <div class="skill-legend">
                    <div class="skill-legend-item"><span class="skill-legend-dot available"></span> Available</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot in-progress"></span> In Progress</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot mastered"></span> Mastered</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot needs-review"></span> Needs Review</div>
                    <div class="skill-legend-item"><span class="skill-legend-dot locked"></span> Locked</div>
                </div>
                <div class="skill-grid" id="skill-grid"></div>
                <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem"><button class="btn btn-ghost" onclick="goToModeSelect()">← Back</button><button id="start-learning-btn" class="btn btn-emerald" onclick="startLearning()" disabled>Begin Training</button></div>
            </div>
        </div>

        <div id="learning-screen" class="screen">
            <div class="learning-header">
                <div class="learning-progress">
                    <div class="phase-indicator">
                        <div class="phase-dot active" data-phase="learn">1</div>
                        <div class="phase-line"></div>
                        <div class="phase-dot" data-phase="guided">2</div>
                        <div class="phase-line"></div>
                        <div class="phase-dot" data-phase="practice">3</div>
                    </div>
                    <div class="phase-labels">
                        <span class="phase-label active" data-phase="learn">Learn</span>
                        <span class="phase-label" data-phase="guided">Guided</span>
                        <span class="phase-label" data-phase="practice">Practice</span>
                    </div>
                </div>
                <div class="learning-skill-badge">
                    <span id="learning-tier-badge">Tier 2</span>
                    <span id="learning-skill-name">Addition</span>
                </div>
            </div>

            <div class="learning-card" id="learning-card">
                <!-- Phase 1: Learn (I Do) -->
                <div class="learn-phase phase-content active" id="phase-learn">
                    <div class="concept-section">
                        <h2>📖 Let's Learn Step by Step</h2>
                        <div class="starting-problem" id="starting-problem">
                            <div class="problem-label">🎯 Our Goal</div>
                            <div class="problem-text" id="goal-problem-text"></div>
                        </div>
                        <div class="concept-steps" id="concept-steps"></div>
                        <div id="reveal-btn-container">
                            <button class="concept-reveal-btn" id="reveal-next-btn" onclick="revealNextConceptStep()">
                                <span class="btn-icon">👉</span>
                                <span>Show Next Step</span>
                            </button>
                        </div>
                        <div class="final-answer" id="final-answer">
                            <div class="answer-label">✅ The Answer</div>
                            <div class="answer-text" id="answer-text"></div>
                            <div class="answer-explanation" id="answer-explanation"></div>
                        </div>
                    </div>
                    <div class="key-points" id="key-points-section" style="display:none;">
                        <h3>💡 Key Points to Remember</h3>
                        <ul id="key-points-list"></ul>
                    </div>
                    <div class="common-mistakes" id="mistakes-section" style="display:none;">
                        <h3>⚠️ Common Mistakes to Avoid</h3>
                        <div id="common-mistakes-list"></div>
                    </div>
                </div>

                <!-- Phase 2: Guided Practice (We Do) -->
                <div class="guided-phase phase-content" id="phase-guided">
                    <div class="phase-header-row" style="display:flex;gap:1rem;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                        <button class="btn btn-ghost" onclick="previousLearningPhase()">← Back to Learn</button>
                        <button class="btn btn-ghost" onclick="endLearning()">✕ Exit to Skills</button>
                    </div>
                    <h2>🤝 Let's Solve Together</h2>
                    <p class="phase-intro">I'll guide you through each step - you provide the answers!</p>
                    <div class="guided-problem-card" id="guided-problem-card">
                        <div class="guided-problem-label">📝 Your Problem:</div>
                        <div class="guided-problem" id="guided-problem"></div>
                    </div>
                    <div class="guided-progress" id="guided-progress">
                        <span class="progress-text">Step <span id="guided-current-step">1</span> of <span id="guided-total-steps">3</span></span>
                        <div class="progress-dots" id="guided-progress-dots"></div>
                    </div>
                    <div class="guided-steps-container" id="guided-steps-container">
                        <div class="guided-completed-steps" id="guided-completed-steps"></div>
                        <div class="guided-current-step-area" id="guided-current-step-area">
                            <div class="step-prompt" id="guided-step-prompt"></div>
                            <div class="step-hint" id="guided-step-hint"></div>
                            <div class="guided-input-area" id="guided-input-area">
                                <input type="text" class="guided-input" id="guided-answer-input" placeholder="Your answer">
                                <button class="btn btn-emerald guided-submit" onclick="checkGuidedStepAnswer()">Check</button>
                            </div>
                            <div class="guided-feedback" id="guided-feedback"></div>
                        </div>
                    </div>
                    <div class="guided-completion" id="guided-completion" style="display:none;">
                        <div class="completion-icon">🎉</div>
                        <div class="completion-message">Great job! You completed the guided practice!</div>
                        <div class="final-answer-display" id="guided-final-answer"></div>
                        <div class="guided-inline-actions" id="guided-inline-actions">
                            <button class="btn btn-emerald" onclick="nextLearningPhase()">Continue to Practice →</button>
                        </div>
                    </div>
                </div>

                <!-- Phase 3: Independent Practice (You Do) -->
                <div class="practice-phase phase-content" id="phase-practice">
                    <div class="phase-header-row" style="display:flex;gap:1rem;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                        <button class="btn btn-ghost" onclick="goBackToLearn()">← Back to Learn</button>
                        <button class="btn btn-ghost" onclick="endLearning()">✕ Exit to Skills</button>
                    </div>
                    <h2>🎯 Now You Try!</h2>
                    <p class="phase-intro">Get 3 correct in a row to complete the lesson.</p>
                    <div class="practice-progress" id="practice-progress">
                        <span class="progress-text"><span id="practice-correct-count">0</span> / 3 in a row</span>
                        <div class="progress-dots">
                            <span class="progress-dot" id="dot-1"></span>
                            <span class="progress-dot" id="dot-2"></span>
                            <span class="progress-dot" id="dot-3"></span>
                        </div>
                    </div>
                    <div class="practice-problem" id="practice-problem"></div>
                    <div class="practice-options" id="practice-options"></div>
                    <div class="practice-feedback" id="practice-feedback"></div>
                    <div class="mistake-analysis" id="mistake-analysis"></div>
                </div>
            </div>

            <div class="learning-actions">
                <button class="btn btn-ghost" onclick="endLearning()">← Exit</button>
                <button class="btn btn-emerald" id="learning-continue-btn" onclick="nextLearningPhase()">Continue →</button>
            </div>
        </div>

        <div id="test-screen" class="screen">
            <div class="test-header" id="test-header">
                <div class="progress-info">
                    <div class="progress-item"><div class="label">Question</div><div class="value" id="question-number">1</div></div>
                    <div class="progress-item"><div class="label">Correct</div><div class="value" id="correct-count">0</div></div>
                </div>
                <div class="tier-badge">Current: <span class="tier-name" id="current-tier-display">Tier 5</span></div>
            </div>
            <div class="tc-stats-bar" id="tc-stats-bar" style="display:none">
                <div class="tc-stat"><span>📊</span><span class="stat-label">Accuracy:</span><span class="stat-value" id="tc-accuracy">--%</span></div>
                <div class="tc-stat"><span>⏱️</span><span class="stat-label">Avg:</span><span class="stat-value" id="tc-avg-time">--s</span></div>
                <div class="tc-stat"><span>🔥</span><span class="stat-label">Streak:</span><span class="stat-value" id="tc-streak">0</span></div>
                <div class="tc-stat" id="arena-timer-stat"><span>⏳</span><span class="stat-label" id="arena-timer-label">Time:</span><span class="stat-value" id="arena-timer-display" style="font-size:1.2rem;">--</span></div>
            </div>
            <div class="question-card">
                <div class="question-meta" id="question-meta"><span class="question-tag tag-tier" id="tag-tier">Tier 5</span><span class="question-tag tag-domain" id="tag-domain">Algebra</span><span class="question-tag tag-type" id="tag-type">Procedural</span></div>
                <div class="question-text" id="question-text">Loading...</div>
                <div class="visual-container" id="visual-container"></div>
                <div class="answer-options" id="answer-options"></div>
                <div class="explanation-box" id="explanation-box"><h4>💡 Explanation</h4><p id="explanation-text"></p></div>
                <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
                <div class="timer-display" id="timer-display">0.0s</div>
            </div>
            <div class="submit-area">
                <div class="feedback" id="feedback"></div>
                <div class="button-group">
                    <button id="end-session-btn" class="btn btn-secondary" onclick="endTest()" style="display:none">End Session</button>
                    <button id="idk-btn" class="btn btn-idk" onclick="submitIDK()" style="display:none">I Don't Know</button>
                    <button id="submit-btn" class="btn btn-primary" onclick="submitAnswer()" disabled>Submit Answer</button>
                    <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()" style="display:none">Next →</button>
                </div>
            </div>
        </div>

        <div id="results-screen" class="screen">
            <div class="results-card">
                <h2 id="results-title">Results</h2>
                <div class="placement-result">
                    <div class="tier-number" id="result-tier-number">5</div>
                    <div class="tier-title" id="result-tier-title">Algebra I</div>
                    <div class="tier-grades" id="result-tier-grades">Grades 9-10</div>
                    <div class="fluency-badge fluency-normal" id="fluency-badge">Normal Fluency</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Questions</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-correct">0</div><div class="stat-label">Correct</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-idk">0</div><div class="stat-label">Unknown</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-accuracy">0%</div><div class="stat-label">Accuracy</div></div>
                </div>
            </div>
            <div class="results-card"><h2>Performance by Tier</h2><div class="tier-breakdown" id="tier-breakdown"></div></div>
            <div class="results-card"><h2>Gap Analysis</h2><div id="gap-log"></div></div>
            <div class="results-card"><h2>Recommendations</h2><div class="recommendations" id="recommendations"></div></div>
            <div class="results-card" id="tree-sync-card" style="display:none;"><h2>🌳 Skill Tree Progress</h2><div id="tree-sync-results"></div></div>
            <div class="results-card"><h2>Question History</h2><div class="question-history" id="question-history"></div></div>
            <div style="text-align:center;margin-top:2rem"><button class="btn btn-secondary" onclick="goToModeSelect()">← Back to Menu</button><button class="btn btn-primary" onclick="window.print()" style="margin-left:1rem">Print Results</button></div>
        </div>
    </div>

    <script>
// ========================================
// TIER & DOMAIN DEFINITIONS
// ========================================
const TIERS = {
    1: { name: "Foundations", grades: "K-1", domains: [
        "Counting", "Comparison", "Addition", "Subtraction", "Shapes", "Place Value",
        "Patterns", "Skip Counting", "Number Lines", "Even and Odd", "Ordering Numbers",
        "Teen Numbers", "Number Bonds", "Picture Graphs", "3D Shapes", "Partitioning Shapes",
        "Composing Shapes", "Comparing Lengths", "Positional Words", "Classifying Objects"
    ]},
    2: { name: "Core Operations", grades: "2-4", domains: [
        "Multi-Digit Addition", "Multi-Digit Subtraction", "Multiplication", "Division",
        "Long Division", "Fractions", "Fraction Operations", "Equivalent Fractions",
        "Simplifying Fractions", "Mixed Numbers", "Fraction Word Problems",
        "Word Problems", "Time", "Money", "Rounding", "Estimation", "Measurement",
        "Perimeter", "Arrays and Area Models", "Factors and Multiples", "Prime and Composite",
        "Area", "Bar Graphs", "Line Plots", "Line Symmetry", "Types of Angles",
        "Types of Lines", "Mass and Capacity", "Elapsed Time", "Multiplication Properties"
    ]},
    3: { name: "Rational Numbers", grades: "5-7", domains: [
        "Fractions", "Decimals", "Integers", "Percents", "Ratios", "Proportions",
        "Statistics", "Data Collection", "Mean Median Mode", "Unit Conversion",
        "Basic Graphing", "Absolute Value", "Scientific Notation", "Square Roots",
        "GCF and LCM", "Powers of 10", "Coordinate Plane", "Volume", "Order of Operations",
        "Expressions with Variables", "One-Step Equations", "Simple Probability",
        "Comparing Distributions", "Nets of 3D Shapes"
    ]},
    4: { name: "Pre-Algebra", grades: "7-8", domains: [
        "Equations", "Exponents", "Slope", "Pythagorean", "Angles and Lines",
        "Algebraic Expressions", "Surface Area", "Two-Way Tables", "Scatter Plots",
        "Box Plots", "Probability Basics", "Irrational Numbers", "Cube Roots",
        "Compound Probability", "Sampling Methods", "Transformations", "Similar Figures",
        "Parallel Lines and Transversals", "Volume of Cylinders Cones Spheres"
    ]},
    5: { name: "Algebra I", grades: "8-9", domains: [
        "Linear Equations", "Systems", "Factoring", "Functions", "Inequalities",
        "Radicals", "Exponential Functions", "Arithmetic Sequences", "Geometric Sequences",
        "Compound Interest", "Domain and Range", "Multi-Step Equations", "Literal Equations",
        "Absolute Value Equations", "Graphing Linear Inequalities", "Systems by Graphing",
        "Systems by Substitution", "Systems by Elimination", "Correlation and Trend Lines"
    ]},
    6: { name: "Geometry", grades: "9-10", domains: [
        "Area", "Volume", "Triangles", "Circles", "Trigonometry", "Transformations",
        "Similarity", "Congruence", "Proofs", "Law of Sines", "Law of Cosines",
        "Coordinate Geometry", "Angle Bisectors", "Perpendicular Bisectors",
        "Triangle Inequality", "Triangle Centers", "Midsegments", "Inscribed Angles",
        "Arc Length", "Sector Area", "Tangent Lines", "Dilations"
    ]},
    7: { name: "Algebra II", grades: "10-11", domains: [
        "Quadratics", "Completing the Square", "Logarithms", "Polynomials",
        "Sequences", "Probability", "Conic Sections", "Rational Functions",
        "Piecewise Functions", "Asymptotes", "Permutations", "Combinations",
        "Expected Value", "Synthetic Division", "Binomial Theorem", "Matrices Intro"
    ]},
    8: { name: "Pre-Calculus", grades: "11-12", domains: [
        "Trig Functions", "Radian Measure", "Inverse Trig", "Limits",
        "Complex Numbers", "Vectors", "Advanced Functions", "Parametric Equations",
        "Polar Coordinates", "Normal Distribution", "Unit Circle", "Trig Identities",
        "Graphing Trig Functions", "Series Convergence"
    ]},
    9: { name: "Calculus", grades: "12+", domains: [
        "Derivatives", "Integrals", "Limits", "Applications", "Differential Equations",
        "Chain Rule", "Product Rule", "Integration Techniques", "Quotient Rule",
        "Implicit Differentiation", "Related Rates", "U-Substitution", "Integration by Parts"
    ]},
    10: { name: "Advanced", grades: "College", domains: [
        "Partial Derivatives", "Matrices", "Series", "Discrete Math",
        "Multivariable Calculus", "Linear Algebra", "Eigenvalues", "Double Integrals",
        "Triple Integrals", "Vector Calculus", "Real Analysis", "Complex Analysis",
        "Abstract Algebra", "Number Theory", "Advanced Number Theory", "Mathematical Logic",
        "Differential Geometry", "Topology", "Advanced Statistics", "Applied Mathematics",
        "Theoretical Mathematics", "Advanced Computational Methods"
    ]}
};

const QUESTION_TYPES = ["procedural", "conceptual", "reasoning"];

// ========================================
// SKILL TREE COMMUNICATION
// ========================================
// Maps Dojo domain names to Skill Tree skill names
// Most names match exactly; only include those that differ
const SKILL_TREE_MAPPING = {
    // Tier 1 - Foundations
    "Comparison": "Number Comparison",
    "Place Value": "Place Value",
    "Number Lines": "Number Lines",
    "Even and Odd": "Even and Odd",
    "Ordering Numbers": "Ordering Numbers",
    // Tier 2 - Core Operations
    "Multi-Digit Addition": "Multi-Digit Addition",
    "Multi-Digit Subtraction": "Multi-Digit Subtraction",
    "Long Division": "Long Division",
    "Equivalent Fractions": "Equivalent Fractions",
    "Mixed Numbers": "Mixed Numbers",
    "Word Problems": "Word Problems",
    "Arrays and Area Models": "Arrays and Area Models",
    // Tier 3 - Rational Numbers
    "Mean Median Mode": "Mean Median Mode",
    "Data Collection": "Data Collection",
    "Basic Graphing": "Basic Graphing",
    "Unit Conversion": "Unit Conversion",
    "Absolute Value": "Absolute Value",
    "Scientific Notation": "Scientific Notation",
    "Square Roots": "Square Roots",
    // Tier 4 - Pre-Algebra
    "Order of Operations": "Order of Operations",
    "Algebraic Expressions": "Algebraic Expressions",
    "Angles and Lines": "Angles and Lines",
    "Surface Area": "Surface Area",
    "Two-Way Tables": "Two-Way Tables",
    "Scatter Plots": "Scatter Plots",
    "Box Plots": "Box Plots",
    "Probability Basics": "Probability Basics",
    // Tier 5 - Algebra I
    "Linear Equations": "Linear Equations",
    "Exponential Functions": "Exponential Functions",
    "Arithmetic Sequences": "Arithmetic Sequences",
    "Geometric Sequences": "Geometric Sequences",
    "Compound Interest": "Compound Interest",
    "Domain and Range": "Domain and Range",
    // Tier 6 - Geometry
    "Law of Sines": "Law of Sines",
    "Law of Cosines": "Law of Cosines",
    "Coordinate Geometry": "Coordinate Geometry",
    // Tier 7 - Algebra II
    "Completing the Square": "Completing the Square",
    "Conic Sections": "Conic Sections",
    "Rational Functions": "Rational Functions",
    "Piecewise Functions": "Piecewise Functions",
    "Expected Value": "Expected Value",
    // Tier 8 - Pre-Calculus
    "Trig Functions": "Trig Functions",
    "Radian Measure": "Radian Measure",
    "Inverse Trig": "Inverse Trig",
    "Advanced Functions": "Advanced Functions",
    "Parametric Equations": "Parametric Equations",
    "Polar Coordinates": "Polar Coordinates",
    "Normal Distribution": "Normal Distribution",
    // Tier 9 - Calculus
    "Differential Equations": "Differential Equations",
    "Chain Rule": "Chain Rule",
    "Product Rule": "Product Rule",
    "Integration Techniques": "Integration Techniques",
    // Tier 10 - Advanced
    "Partial Derivatives": "Partial Derivatives",
    "Multivariable Calculus": "Multivariable Calculus",
    "Linear Algebra": "Linear Algebra",
    "Discrete Math": "Discrete Math"
};

// Get the Skill Tree skill name for a Dojo domain
function getSkillTreeName(domain) {
    return SKILL_TREE_MAPPING[domain] || domain;
}

// ========================================
// SKILL TREE INTEGRATION - PHASE 1-4
// ========================================

// Skill tree state storage
let skillTreeData = {
    skills: {},        // { skillName: { state, mastery_score, last_practiced, prerequisites } }
    connections: [],   // [[from, to], ...] for prerequisites
    lastSync: null,
    userId: null
};

// Math skill tree connections (prerequisites) - matches SkillTreeViewer.html
const MATH_CONNECTIONS = [
    // Basic Arithmetic
    ["Counting and Number Recognition", "Place Value Understanding"],
    ["Counting and Number Recognition", "Comparing Numbers"],
    ["Counting and Number Recognition", "Skip Counting"],
    ["Counting and Number Recognition", "Number Lines"],
    ["Counting and Number Recognition", "Even and Odd"],
    ["Comparing Numbers", "Ordering Numbers"],
    ["Comparing Numbers", "Time Telling"],
    ["Place Value Understanding", "Time Telling"],
    ["Time Telling", "Money and Coins"],
    ["Money and Coins", "Patterns and Sequences"],
    ["Place Value Understanding", "Basic Addition"],
    ["Place Value Understanding", "Basic Subtraction"],
    // Additional Tier 1 connections
    ["Counting and Number Recognition", "Teen Numbers"],
    ["Counting and Number Recognition", "Number Bonds"],
    ["Teen Numbers", "Place Value Understanding"],
    ["Number Bonds", "Basic Addition"],
    ["Number Bonds", "Basic Subtraction"],
    ["Skip Counting", "Picture Graphs"],
    ["Basic Geometry Concepts", "3D Shapes"],
    ["Basic Geometry Concepts", "Partitioning Shapes"],
    ["Partitioning Shapes", "Composing Shapes"],
    ["Comparing Numbers", "Comparing Lengths"],
    ["Comparing Lengths", "Positional Words"],
    ["Positional Words", "Classifying Objects"],
    // Intermediate Arithmetic
    ["Basic Addition", "Multi-Digit Addition"],
    ["Basic Subtraction", "Multi-Digit Subtraction"],
    ["Multi-Digit Addition", "Multiplication"],
    ["Multi-Digit Subtraction", "Multiplication"],
    ["Basic Addition", "Multiplication"],
    ["Basic Subtraction", "Multiplication"],
    ["Multiplication", "Division"],
    ["Multiplication", "Arrays and Area Models"],
    ["Division", "Long Division"],
    ["Multiplication", "Basic Fractions"],
    ["Multiplication", "Rounding and Estimation"],
    ["Rounding and Estimation", "Estimation"],
    ["Division", "Basic Fractions"],
    ["Basic Fractions", "Equivalent Fractions"],
    ["Equivalent Fractions", "Mixed Numbers"],
    ["Basic Geometry Concepts", "Basic Measurement"],
    ["Basic Measurement", "Unit Conversion"],
    ["Basic Measurement", "Perimeter"],
    // Additional Tier 2 connections
    ["Basic Fractions", "Fraction Operations"],
    ["Equivalent Fractions", "Simplifying Fractions"],
    ["Fraction Operations", "Fraction Word Problems"],
    ["Division", "Word Problems"],
    ["Multiplication", "Factors and Multiples"],
    ["Factors and Multiples", "Prime and Composite"],
    ["Data Collection", "Bar Graphs"],
    ["Bar Graphs", "Line Plots"],
    ["Basic Geometry Concepts", "Line Symmetry"],
    ["Angles and Lines", "Types of Angles"],
    ["Types of Angles", "Types of Lines"],
    ["Basic Measurement", "Mass and Capacity"],
    ["Time Telling", "Elapsed Time"],
    ["Multiplication", "Multiplication Properties"],
    ["Perimeter", "Area"],
    // Advanced Arithmetic
    ["Basic Subtraction", "Negatives"],
    ["Negatives", "Absolute Value"],
    ["Basic Fractions", "Advanced Fractions"],
    ["Basic Fractions", "Basic Geometry Concepts"],
    ["Advanced Fractions", "Decimals"],
    ["Decimals", "Percentages"],
    ["Decimals", "Scientific Notation"],
    ["Percentages", "Proportions"],
    ["Advanced Fractions", "Square Roots"],
    ["Basic Graphing", "Data Collection"],
    ["Data Collection", "Mean Median Mode"],
    ["Mean Median Mode", "Probability and Statistics"],
    // Additional Tier 3 connections
    ["Factors and Multiples", "GCF and LCM"],
    ["Place Value Understanding", "Powers of 10"],
    ["Basic Graphing", "Coordinate Plane"],
    ["Basic Algebraic Expressions", "Expressions with Variables"],
    ["Solving Simple Equations", "One-Step Equations"],
    ["Probability Basics", "Simple Probability"],
    ["Mean Median Mode", "Comparing Distributions"],
    ["3D Shapes", "Nets of 3D Shapes"],
    // Additional forward connections for leaf nodes
    ["Long Division", "Basic Fractions"],
    ["Unit Conversion", "Proportions"],
    ["Proportions", "Ratio and Proportion"],
    ["Coordinate Plane", "Coordinate Geometry"],
    ["Ratio and Proportion", "Proportions"],
    ["GCF and LCM", "Simplifying Fractions"],
    ["Powers of 10", "Scientific Notation"],
    ["One-Step Equations", "Multi-Step Equations"],
    ["Expressions with Variables", "Basic Algebraic Expressions"],
    ["Simple Probability", "Compound Probability"],
    ["Mixed Numbers", "Fraction Operations"],
    ["Line Plots", "Mean Median Mode"],
    ["Types of Lines", "Parallel Lines and Transversals"],
    ["Area", "Area and Perimeter"],
    ["Prime and Composite", "GCF and LCM"],
    ["Fraction Word Problems", "Word Problems"],
    ["Simplifying Fractions", "Fraction Operations"],
    // Pre-Algebra
    ["Percentages", "Basic Algebraic Expressions"],
    ["Percentages", "Ratio and Proportion"],
    ["Percentages", "Basic Graphing"],
    ["Square Roots", "Order of Operations"],
    ["Basic Algebraic Expressions", "Order of Operations"],
    ["Basic Algebraic Expressions", "Solving Simple Equations"],
    ["Basic Graphing", "Two-Way Tables"],
    ["Basic Graphing", "Scatter Plots"],
    ["Scatter Plots", "Box Plots"],
    ["Data Collection", "Probability Basics"],
    ["Volume", "Surface Area"],
    // Additional Tier 4 connections
    ["Order of Operations", "Exponents"],
    ["Square Roots", "Irrational Numbers"],
    ["Square Roots", "Cube Roots"],
    ["Probability Basics", "Compound Probability"],
    ["Data Collection", "Sampling Methods"],
    ["Similarity", "Similar Figures"],
    ["Angles and Lines", "Parallel Lines and Transversals"],
    ["Volume", "Volume of Cylinders Cones Spheres"],
    // Additional forward connections
    ["Exponents", "Exponential Functions"],
    ["Irrational Numbers", "Radicals"],
    ["Cube Roots", "Radicals"],
    ["Sampling Methods", "Probability and Statistics"],
    ["Similar Figures", "Dilations"],
    ["Parallel Lines and Transversals", "Proofs"],
    ["Volume of Cylinders Cones Spheres", "Surface Area"],
    ["Surface Area", "Volume"],
    ["Compound Probability", "Permutations"],
    // Geometry
    ["Basic Geometry Concepts", "Angles and Lines"],
    ["Basic Geometry Concepts", "Transformations"],
    ["Angles and Lines", "Triangles and Pythagorean Theorem"],
    ["Triangles and Pythagorean Theorem", "Circles"],
    ["Angles and Lines", "Area and Perimeter"],
    ["Area and Perimeter", "Volume"],
    ["Triangles and Pythagorean Theorem", "Similarity"],
    ["Similarity", "Congruence"],
    ["Congruence", "Proofs"],
    ["Triangles and Pythagorean Theorem", "Law of Sines"],
    ["Triangles and Pythagorean Theorem", "Law of Cosines"],
    ["Angles and Lines", "Coordinate Geometry"],
    // Additional Tier 6 Geometry connections
    ["Angles and Lines", "Angle Bisectors"],
    ["Angles and Lines", "Perpendicular Bisectors"],
    ["Triangles and Pythagorean Theorem", "Triangle Inequality"],
    ["Triangles and Pythagorean Theorem", "Triangle Centers"],
    ["Triangles and Pythagorean Theorem", "Midsegments"],
    ["Circles", "Inscribed Angles"],
    ["Circles", "Arc Length"],
    ["Circles", "Sector Area"],
    ["Circles", "Tangent Lines"],
    ["Transformations", "Dilations"],
    // Additional Geometry forward connections
    ["Angle Bisectors", "Triangle Centers"],
    ["Perpendicular Bisectors", "Triangle Centers"],
    ["Triangle Inequality", "Proofs"],
    ["Midsegments", "Similarity"],
    ["Inscribed Angles", "Arc Length"],
    ["Arc Length", "Sector Area"],
    ["Tangent Lines", "Conic Sections"],
    ["Coordinate Geometry", "Conic Sections"],
    ["Law of Sines", "Trigonometry"],
    ["Law of Cosines", "Trigonometry"],
    ["Proofs", "Mathematical Logic"],
    // Algebra 1
    ["Solving Simple Equations", "Polynomials"],
    ["Solving Simple Equations", "Linear Equations"],
    ["Square Roots", "Radicals"],
    ["Linear Equations", "Inequalities"],
    ["Linear Equations", "Basic Functions"],
    ["Polynomials", "Factoring"],
    ["Factoring", "Quadratic Equations"],
    ["Basic Functions", "Domain and Range"],
    ["Basic Functions", "Exponential Functions"],
    ["Basic Functions", "Arithmetic Sequences"],
    ["Arithmetic Sequences", "Geometric Sequences"],
    ["Exponential Functions", "Compound Interest"],
    // Additional Tier 5 Algebra 1 connections
    ["Linear Equations", "Multi-Step Equations"],
    ["Solving Simple Equations", "Literal Equations"],
    ["Absolute Value", "Absolute Value Equations"],
    ["Inequalities", "Graphing Linear Inequalities"],
    ["Linear Equations", "Systems by Graphing"],
    ["Linear Equations", "Systems by Substitution"],
    ["Linear Equations", "Systems by Elimination"],
    ["Scatter Plots", "Correlation and Trend Lines"],
    // Additional Algebra 1 forward connections
    ["Multi-Step Equations", "Literal Equations"],
    ["Literal Equations", "Systems by Substitution"],
    ["Absolute Value Equations", "Piecewise Functions"],
    ["Graphing Linear Inequalities", "Systems by Graphing"],
    ["Systems by Graphing", "Conic Sections"],
    ["Systems by Substitution", "Systems by Elimination"],
    ["Systems by Elimination", "Matrices"],
    ["Correlation and Trend Lines", "Probability and Statistics"],
    ["Geometric Sequences", "Sequence and Series"],
    ["Domain and Range", "Rational Functions"],
    ["Compound Interest", "Exponential and Logarithmic Functions"],
    ["Radicals", "Complex Numbers"],
    // Algebra 2
    ["Quadratic Equations", "Complex Numbers"],
    ["Quadratic Equations", "Completing the Square"],
    ["Factoring", "Advanced Polynomials"],
    ["Basic Functions", "Exponential and Logarithmic Functions"],
    ["Basic Functions", "Rational Functions"],
    ["Basic Functions", "Piecewise Functions"],
    ["Rational Functions", "Asymptotes"],
    ["Basic Functions", "Sequence and Series"],
    ["Probability Basics", "Permutations"],
    ["Permutations", "Combinations"],
    ["Probability and Statistics", "Expected Value"],
    // Additional Tier 7 Algebra 2 connections
    ["Advanced Polynomials", "Synthetic Division"],
    ["Sequence and Series", "Binomial Theorem"],
    ["Matrices", "Matrices Intro"],
    // Additional Algebra 2 forward connections
    ["Completing the Square", "Conic Sections"],
    ["Piecewise Functions", "Advanced Functions"],
    ["Asymptotes", "Limits"],
    ["Combinations", "Binomial Theorem"],
    ["Expected Value", "Normal Distribution"],
    ["Synthetic Division", "Rational Functions"],
    ["Binomial Theorem", "Series"],
    ["Matrices Intro", "Matrices"],
    // Pre-Calculus
    ["Exponential and Logarithmic Functions", "Conic Sections"],
    ["Triangles and Pythagorean Theorem", "Trigonometry"],
    ["Trigonometry", "Radian Measure"],
    ["Trigonometry", "Inverse Trig"],
    ["Complex Numbers", "Matrices"],
    ["Advanced Polynomials", "Advanced Functions"],
    ["Advanced Functions", "Parametric Equations"],
    ["Trigonometry", "Vectors"],
    ["Vectors", "Polar Coordinates"],
    ["Probability and Statistics", "Normal Distribution"],
    // Additional Tier 8 Pre-Calculus connections
    ["Trigonometry", "Unit Circle"],
    ["Trigonometry", "Trig Identities"],
    ["Trigonometry", "Graphing Trig Functions"],
    ["Sequence and Series", "Series Convergence"],
    // Additional Pre-Calculus forward connections
    ["Unit Circle", "Trig Identities"],
    ["Trig Identities", "Inverse Trig"],
    ["Graphing Trig Functions", "Limits"],
    ["Series Convergence", "Series"],
    ["Radian Measure", "Unit Circle"],
    ["Inverse Trig", "Derivatives"],
    ["Parametric Equations", "Vector Calculus"],
    ["Polar Coordinates", "Double Integrals"],
    ["Normal Distribution", "Advanced Statistics"],
    ["Conic Sections", "Multivariable Calculus"],
    // Calculus
    ["Advanced Functions", "Limits"],
    ["Matrices", "Limits"],
    ["Vectors", "Limits"],
    ["Limits", "Derivatives"],
    ["Derivatives", "Chain Rule"],
    ["Derivatives", "Product Rule"],
    ["Derivatives", "Integrals"],
    ["Integrals", "Integration Techniques"],
    ["Integrals", "Multivariable Calculus"],
    ["Integrals", "Differential Equations"],
    // Additional Tier 9 Calculus connections
    ["Derivatives", "Quotient Rule"],
    ["Derivatives", "Implicit Differentiation"],
    ["Derivatives", "Related Rates"],
    ["Derivatives", "Applications"],
    ["Integrals", "U-Substitution"],
    ["Integrals", "Integration by Parts"],
    // Additional Calculus forward connections
    ["Chain Rule", "Implicit Differentiation"],
    ["Product Rule", "Integration by Parts"],
    ["Quotient Rule", "Rational Functions"],
    ["Implicit Differentiation", "Related Rates"],
    ["Related Rates", "Applications"],
    ["Applications", "Applied Mathematics"],
    ["U-Substitution", "Integration Techniques"],
    ["Integration by Parts", "Integration Techniques"],
    ["Integration Techniques", "Differential Equations"],
    // Advanced Mathematics connections
    ["Multivariable Calculus", "Partial Derivatives"],
    ["Sequence and Series", "Series"],
    ["Linear Algebra", "Eigenvalues"],
    ["Multivariable Calculus", "Double Integrals"],
    ["Double Integrals", "Triple Integrals"],
    ["Multivariable Calculus", "Vector Calculus"],
    ["Matrices", "Linear Algebra"],
    ["Basic Graphing", "Probability and Statistics"],
    ["Integrals", "Real Analysis"],
    ["Real Analysis", "Complex Analysis"],
    // Specialized Topics connections
    ["Advanced Polynomials", "Abstract Algebra"],
    ["Advanced Fractions", "Number Theory"],
    ["Basic Graphing", "Discrete Mathematics"],
    ["Number Theory", "Advanced Number Theory"],
    ["Discrete Mathematics", "Mathematical Logic"],
    // Mastery connections
    ["Differential Equations", "Applied Mathematics"],
    ["Abstract Algebra", "Theoretical Mathematics"],
    ["Real Analysis", "Theoretical Mathematics"],
    ["Complex Analysis", "Theoretical Mathematics"],
    ["Discrete Mathematics", "Advanced Computational Methods"],
    ["Probability and Statistics", "Advanced Computational Methods"],
    ["Applied Mathematics", "Mathematical Research Techniques"],
    ["Theoretical Mathematics", "Mathematical Research Techniques"],
    ["Advanced Computational Methods", "Mathematical Research Techniques"],
    ["Mathematical Research Techniques", "Differential Geometry"],
    ["Theoretical Mathematics", "Topology"],
    ["Advanced Computational Methods", "Advanced Statistics"]
];

// Map Dojo skill names to tree skill names for prerequisites
const DOJO_TO_TREE_SKILL = {
    // Tier 1 mappings
    "Counting": "Counting and Number Recognition",
    "Comparison": "Comparing Numbers",
    "Addition": "Basic Addition",
    "Subtraction": "Basic Subtraction",
    "Shapes": "Basic Geometry Concepts",
    "Place Value": "Place Value Understanding",
    "Patterns": "Patterns and Sequences",
    "Skip Counting": "Skip Counting",
    "Number Lines": "Number Lines",
    "Even and Odd": "Even and Odd",
    "Ordering Numbers": "Ordering Numbers",
    "Teen Numbers": "Teen Numbers",
    "Number Bonds": "Number Bonds",
    "Picture Graphs": "Picture Graphs",
    "3D Shapes": "3D Shapes",
    "Partitioning Shapes": "Partitioning Shapes",
    "Composing Shapes": "Composing Shapes",
    "Comparing Lengths": "Comparing Lengths",
    "Positional Words": "Positional Words",
    "Classifying Objects": "Classifying Objects",
    // Tier 2 mappings
    "Time": "Time Telling",
    "Money": "Money and Coins",
    "Fractions": "Basic Fractions",
    "Rounding": "Rounding and Estimation",
    "Estimation": "Estimation",
    "Measurement": "Basic Measurement",
    "Perimeter": "Perimeter",
    "Multi-Digit Addition": "Multi-Digit Addition",
    "Multi-Digit Subtraction": "Multi-Digit Subtraction",
    "Multiplication": "Multiplication",
    "Division": "Division",
    "Long Division": "Long Division",
    "Fraction Operations": "Fraction Operations",
    "Equivalent Fractions": "Equivalent Fractions",
    "Simplifying Fractions": "Simplifying Fractions",
    "Mixed Numbers": "Mixed Numbers",
    "Fraction Word Problems": "Fraction Word Problems",
    "Word Problems": "Word Problems",
    "Arrays and Area Models": "Arrays and Area Models",
    "Factors and Multiples": "Factors and Multiples",
    "Prime and Composite": "Prime and Composite",
    "Area": "Area",
    "Bar Graphs": "Bar Graphs",
    "Line Plots": "Line Plots",
    "Line Symmetry": "Line Symmetry",
    "Types of Angles": "Types of Angles",
    "Types of Lines": "Types of Lines",
    "Mass and Capacity": "Mass and Capacity",
    "Elapsed Time": "Elapsed Time",
    "Multiplication Properties": "Multiplication Properties",
    // Tier 3 mappings
    "Decimals": "Decimals",
    "Percents": "Percentages",
    "Ratios": "Ratio and Proportion",
    "Proportions": "Proportions",
    "Integers": "Negatives",
    "Statistics": "Probability and Statistics",
    "Basic Graphing": "Basic Graphing",
    "Absolute Value": "Absolute Value",
    "Scientific Notation": "Scientific Notation",
    "Square Roots": "Square Roots",
    "Volume": "Volume",
    "Order of Operations": "Order of Operations",
    "Data Collection": "Data Collection",
    "Mean Median Mode": "Mean Median Mode",
    "Unit Conversion": "Unit Conversion",
    "GCF and LCM": "GCF and LCM",
    "Powers of 10": "Powers of 10",
    "Coordinate Plane": "Coordinate Plane",
    "Expressions with Variables": "Expressions with Variables",
    "One-Step Equations": "One-Step Equations",
    "Simple Probability": "Simple Probability",
    "Comparing Distributions": "Comparing Distributions",
    "Nets of 3D Shapes": "Nets of 3D Shapes",
    // Tier 4 mappings
    "Equations": "Solving Simple Equations",
    "Exponents": "Exponents",
    "Slope": "Linear Equations",
    "Pythagorean": "Triangles and Pythagorean Theorem",
    "Angles and Lines": "Angles and Lines",
    "Algebraic Expressions": "Basic Algebraic Expressions",
    "Surface Area": "Surface Area",
    "Two-Way Tables": "Two-Way Tables",
    "Scatter Plots": "Scatter Plots",
    "Box Plots": "Box Plots",
    "Probability Basics": "Probability Basics",
    "Transformations": "Transformations",
    "Irrational Numbers": "Irrational Numbers",
    "Cube Roots": "Cube Roots",
    "Compound Probability": "Compound Probability",
    "Sampling Methods": "Sampling Methods",
    "Similar Figures": "Similar Figures",
    "Parallel Lines and Transversals": "Parallel Lines and Transversals",
    "Volume of Cylinders Cones Spheres": "Volume of Cylinders Cones Spheres",
    // Tier 5 mappings
    "Linear Equations": "Linear Equations",
    "Systems": "Linear Equations",
    "Factoring": "Factoring",
    "Functions": "Basic Functions",
    "Inequalities": "Inequalities",
    "Radicals": "Radicals",
    "Exponential Functions": "Exponential Functions",
    "Arithmetic Sequences": "Arithmetic Sequences",
    "Geometric Sequences": "Geometric Sequences",
    "Compound Interest": "Compound Interest",
    "Domain and Range": "Domain and Range",
    "Multi-Step Equations": "Multi-Step Equations",
    "Literal Equations": "Literal Equations",
    "Absolute Value Equations": "Absolute Value Equations",
    "Graphing Linear Inequalities": "Graphing Linear Inequalities",
    "Systems by Graphing": "Systems by Graphing",
    "Systems by Substitution": "Systems by Substitution",
    "Systems by Elimination": "Systems by Elimination",
    "Correlation and Trend Lines": "Correlation and Trend Lines",
    // Tier 6 mappings
    "Triangles": "Triangles and Pythagorean Theorem",
    "Circles": "Circles",
    "Trigonometry": "Trigonometry",
    "Similarity": "Similarity",
    "Congruence": "Congruence",
    "Proofs": "Proofs",
    "Law of Sines": "Law of Sines",
    "Law of Cosines": "Law of Cosines",
    "Coordinate Geometry": "Coordinate Geometry",
    "Angle Bisectors": "Angle Bisectors",
    "Perpendicular Bisectors": "Perpendicular Bisectors",
    "Triangle Inequality": "Triangle Inequality",
    "Triangle Centers": "Triangle Centers",
    "Midsegments": "Midsegments",
    "Inscribed Angles": "Inscribed Angles",
    "Arc Length": "Arc Length",
    "Sector Area": "Sector Area",
    "Tangent Lines": "Tangent Lines",
    "Dilations": "Dilations",
    // Tier 7 mappings
    "Quadratics": "Quadratic Equations",
    "Completing the Square": "Completing the Square",
    "Logarithms": "Exponential and Logarithmic Functions",
    "Polynomials": "Polynomials",
    "Sequences": "Sequence and Series",
    "Probability": "Probability and Statistics",
    "Conic Sections": "Conic Sections",
    "Rational Functions": "Rational Functions",
    "Piecewise Functions": "Piecewise Functions",
    "Asymptotes": "Asymptotes",
    "Permutations": "Permutations",
    "Combinations": "Combinations",
    "Expected Value": "Expected Value",
    "Synthetic Division": "Synthetic Division",
    "Binomial Theorem": "Binomial Theorem",
    "Matrices Intro": "Matrices Intro",
    // Tier 8 mappings
    "Trig Functions": "Trigonometry",
    "Radian Measure": "Radian Measure",
    "Inverse Trig": "Inverse Trig",
    "Limits": "Limits",
    "Complex Numbers": "Complex Numbers",
    "Vectors": "Vectors",
    "Advanced Functions": "Advanced Functions",
    "Parametric Equations": "Parametric Equations",
    "Polar Coordinates": "Polar Coordinates",
    "Normal Distribution": "Normal Distribution",
    "Unit Circle": "Unit Circle",
    "Trig Identities": "Trig Identities",
    "Graphing Trig Functions": "Graphing Trig Functions",
    "Series Convergence": "Series Convergence",
    // Tier 9 mappings
    "Derivatives": "Derivatives",
    "Integrals": "Integrals",
    "Differential Equations": "Differential Equations",
    "Chain Rule": "Chain Rule",
    "Product Rule": "Product Rule",
    "Integration Techniques": "Integration Techniques",
    "Applications": "Applications",
    "Quotient Rule": "Quotient Rule",
    "Implicit Differentiation": "Implicit Differentiation",
    "Related Rates": "Related Rates",
    "U-Substitution": "U-Substitution",
    "Integration by Parts": "Integration by Parts",
    // Tier 10 mappings
    "Partial Derivatives": "Partial Derivatives",
    "Matrices": "Matrices",
    "Series": "Series",
    "Discrete Math": "Discrete Mathematics",
    "Multivariable Calculus": "Multivariable Calculus",
    "Linear Algebra": "Linear Algebra",
    "Eigenvalues": "Eigenvalues",
    "Double Integrals": "Double Integrals",
    "Triple Integrals": "Triple Integrals",
    "Vector Calculus": "Vector Calculus",
    "Real Analysis": "Real Analysis",
    "Complex Analysis": "Complex Analysis",
    "Abstract Algebra": "Abstract Algebra",
    "Number Theory": "Number Theory",
    "Advanced Number Theory": "Advanced Number Theory",
    "Mathematical Logic": "Mathematical Logic",
    "Differential Geometry": "Differential Geometry",
    "Topology": "Topology",
    "Advanced Statistics": "Advanced Statistics",
    "Applied Mathematics": "Applied Mathematics",
    "Theoretical Mathematics": "Theoretical Mathematics",
    "Advanced Computational Methods": "Advanced Computational Methods"
};

// Get the tree skill name for a Dojo domain
function getTreeSkillName(domain) {
    return DOJO_TO_TREE_SKILL[domain] || SKILL_TREE_MAPPING[domain] || domain;
}

// Get prerequisites for a skill (returns Dojo domain names)
function getSkillPrerequisites(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const prereqs = MATH_CONNECTIONS
        .filter(([from, to]) => to === treeSkillName)
        .map(([from]) => from);

    // Convert tree names back to Dojo names
    const dojoPrereqs = [];
    for (const prereq of prereqs) {
        // Find Dojo name that maps to this tree skill
        let dojoName = null;
        for (const [dojo, tree] of Object.entries(DOJO_TO_TREE_SKILL)) {
            if (tree === prereq) {
                dojoName = dojo;
                break;
            }
        }
        // Also check SKILL_TREE_MAPPING
        if (!dojoName) {
            for (const [dojo, tree] of Object.entries(SKILL_TREE_MAPPING)) {
                if (tree === prereq) {
                    dojoName = dojo;
                    break;
                }
            }
        }
        // Use tree name if no Dojo mapping found
        dojoPrereqs.push(dojoName || prereq);
    }
    return dojoPrereqs;
}

// Check if a skill is unlocked (prerequisites mastered)
function isSkillUnlocked(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const skillData = skillTreeData.skills[treeSkillName];

    // Debug logging
    if (!skillData) {
        console.log(`isSkillUnlocked: ${domain} -> ${treeSkillName} - NO DATA in skillTreeData.skills`);
    }

    // If we have explicit state data, use it
    if (skillData && skillData.state) {
        const unlockedStates = ['activated', 'mastered', 'needs_review', 'available', 'in_progress'];
        return unlockedStates.includes(skillData.state);
    }

    // No skill data - check if this is a root skill (no prerequisites)
    const prereqs = MATH_CONNECTIONS
        .filter(([from, to]) => to === treeSkillName)
        .map(([from]) => from);

    // Root skills (no prerequisites) are always available
    if (prereqs.length === 0) return true;

    // Non-root skills without explicit data are locked
    return false;
}

// Get the state of a skill from tree data
function getSkillState(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const skillData = skillTreeData.skills[treeSkillName];
    return skillData ? skillData.state : 'locked';
}

// Get mastery score for a skill
function getSkillMastery(domain) {
    const treeSkillName = getTreeSkillName(domain);
    const skillData = skillTreeData.skills[treeSkillName];
    return skillData ? (skillData.mastery_score || 0) : 0;
}

// Load skill tree data from localStorage (cross-tab sync)
function loadSkillTreeData() {
    try {
        // Merge data from multiple sources - tree viewer saves to math_skill_states
        // while user-specific data may be in math_skill_progress_${userId}
        const userId = getUserId();
        const userKey = userId ? `math_skill_progress_${userId}` : 'math_skill_progress_guest';

        // Start with tree viewer data (always check this)
        const treeData = localStorage.getItem('math_skill_states');
        if (treeData) {
            const parsed = JSON.parse(treeData);
            skillTreeData.skills = parsed.skills || parsed;
            skillTreeData.lastSync = parsed.lastSync || Date.now();
            console.log('Loaded skill tree data from math_skill_states:', Object.keys(skillTreeData.skills).length, 'skills');
        }

        // Merge with user-specific data if it exists and is newer
        const userData = localStorage.getItem(userKey);
        if (userData) {
            const parsed = JSON.parse(userData);
            const userSkills = parsed.skills || parsed;
            const userSync = parsed.lastSync || 0;

            // If user data is newer, merge it (user data takes precedence)
            if (userSync > (skillTreeData.lastSync || 0)) {
                Object.assign(skillTreeData.skills, userSkills);
                skillTreeData.lastSync = userSync;
                console.log('Merged newer user-specific data:', Object.keys(userSkills).length, 'skills');
            }
        }

        console.log('Total skills loaded:', Object.keys(skillTreeData.skills).length);
    } catch (e) {
        console.warn('Failed to load skill tree data:', e);
    }
}

// Save skill tree data to localStorage (for cross-tab sync)
function saveSkillTreeData() {
    try {
        const userId = getUserId();
        const userKey = userId ? `math_skill_progress_${userId}` : 'math_skill_progress_guest';

        const dataToSave = {
            skills: skillTreeData.skills,
            lastSync: Date.now()
        };

        // Save to user-specific key
        localStorage.setItem(userKey, JSON.stringify(dataToSave));

        // Also save to math_skill_states so Skill Tree can read it
        localStorage.setItem('math_skill_states', JSON.stringify(dataToSave));

        console.log('💾 Saved skill progress to localStorage');

        // Notify parent (portal) that skill data has been updated
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'DOJO_SKILL_DATA_UPDATED',
                skills: skillTreeData.skills,
                timestamp: Date.now()
            }, '*');
        }
    } catch (e) {
        console.warn('Failed to save skill tree data:', e);
    }
}

// Get user ID from various sources
function getUserId() {
    // Try to get from parent window data
    if (window.dojoUserId) return window.dojoUserId;

    // Try URL params
    const params = new URLSearchParams(window.location.search);
    if (params.get('userId')) return params.get('userId');

    // Try localStorage
    const stored = localStorage.getItem('current_user_id');
    if (stored) return stored;

    return null;
}

// ========================================
// CROSS-TAB COMMUNICATION (localStorage events)
// ========================================

// Listen for skill tree updates from other tabs
window.addEventListener('storage', (event) => {
    // Tree practice request - open skill in Dojo
    if (event.key === 'tree_practice_request' && event.newValue) {
        try {
            const data = JSON.parse(event.newValue);
            // Only handle recent requests (within 5 seconds)
            if (Date.now() - data.timestamp < 5000) {
                handleTreePracticeRequest(data);
            }
        } catch (e) {
            console.warn('Failed to parse tree practice request:', e);
        }
    }

    // Skill tree data updated - refresh our local copy
    if (event.key && (event.key.includes('skill_progress') || event.key === 'math_skill_states')) {
        loadSkillTreeData();
        // Refresh UI if we're on skill selection screen
        if (document.getElementById('learning-setup-screen').classList.contains('active')) {
            updateSkillGrid();
        }
        if (document.getElementById('arena-skill-grid')) {
            renderArenaSkills(document.getElementById('skill-tier-filter')?.value || 'all');
        }
    }
});

// Handle practice request from skill tree
function handleTreePracticeRequest(data) {
    const { skill, subject } = data;
    if (subject !== 'Math') return;

    console.log('Received practice request from skill tree:', skill);

    // Find which tier this skill belongs to
    let targetTier = null;
    let targetDomain = null;

    for (let t = 1; t <= 10; t++) {
        for (const domain of TIERS[t].domains) {
            const treeName = getTreeSkillName(domain);
            if (treeName === skill || domain === skill) {
                targetTier = t;
                targetDomain = domain;
                break;
            }
        }
        if (targetTier) break;
    }

    if (targetTier && targetDomain) {
        // Navigate to Sparring Arena (testing mode) for practice
        selectMode('testing');

        // Wait for arena to initialize, then select the skill
        setTimeout(() => {
            // Switch to skill selection mode
            setSelectionMode('skill');

            // Filter to the correct tier
            const tierFilter = document.getElementById('skill-tier-filter');
            if (tierFilter) {
                tierFilter.value = targetTier.toString();
                filterSkillsByTier();
            }

            // Wait for grid to render then select the skill
            setTimeout(() => {
                selectArenaSkill(targetTier, targetDomain);
                showNotification(`Ready to practice: ${targetDomain}`);
            }, 150);
        }, 100);
    } else {
        console.warn('Could not find skill in any tier:', skill);
        // Still open testing mode even if skill not found
        selectMode('testing');
        showNotification(`Skill "${skill}" not found - select a skill to practice`);
    }
}

// Select a skill in the Sparring Arena
function selectArenaSkill(tier, skill) {
    const grid = document.getElementById('arena-skill-grid');
    if (!grid) return;

    // Find the skill card and click it
    const cards = grid.querySelectorAll('.skill-option');
    for (const card of cards) {
        const cardTier = parseInt(card.getAttribute('data-tier'));
        const cardSkill = card.getAttribute('data-skill');
        if (cardTier === tier && cardSkill === skill) {
            // Check if it's not locked
            if (!card.classList.contains('locked')) {
                card.click();
                // Scroll the card into view
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                showNotification(`"${skill}" is locked - complete prerequisites first`);
            }
            return;
        }
    }
    console.warn('Skill card not found in arena grid:', skill);
}

// Send navigation request to skill tree
function requestTreeHighlight(domain) {
    const treeSkillName = getTreeSkillName(domain);
    localStorage.setItem('dojo_highlight_request', JSON.stringify({
        skill: treeSkillName,
        subject: 'Math',
        timestamp: Date.now()
    }));
}

// ========================================
// BATCHED SESSION UPDATES (Phase 2)
// ========================================

// Session tracking for batched updates
let sessionData = {
    startTime: null,
    questions: [],      // { domain, tier, correct, time }
    skillProgress: {},  // { domain: { correct, total, totalTime } }
    mode: null
};

// Start tracking a session
function startSessionTracking(mode) {
    sessionData = {
        startTime: Date.now(),
        questions: [],
        skillProgress: {},
        mode: mode
    };
}

// Record a question result
function recordQuestionResult(domain, tier, correct, time) {
    sessionData.questions.push({ domain, tier, correct, time, timestamp: Date.now() });

    // Update skill progress
    if (!sessionData.skillProgress[domain]) {
        sessionData.skillProgress[domain] = { correct: 0, total: 0, totalTime: 0, tier };
    }
    sessionData.skillProgress[domain].total++;
    sessionData.skillProgress[domain].totalTime += time;
    if (correct) {
        sessionData.skillProgress[domain].correct++;
    }
}

// End session and send batched update
function endSessionTracking() {
    if (!sessionData.startTime || sessionData.questions.length === 0) return;

    const sessionDuration = Date.now() - sessionData.startTime;

    // Prepare data for tree
    const batchedUpdate = {
        timestamp: Date.now(),
        userId: getUserId(),
        sessionDuration,
        mode: sessionData.mode,
        skillResults: []
    };

    // Compile skill results
    for (const [domain, data] of Object.entries(sessionData.skillProgress)) {
        const treeSkillName = getTreeSkillName(domain);
        batchedUpdate.skillResults.push({
            skill: treeSkillName,
            domain: domain,
            tier: data.tier,
            correct: data.correct,
            total: data.total,
            avgTime: data.total > 0 ? Math.round(data.totalTime / data.total) : 0,
            accuracy: data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0
        });
    }

    // Write to localStorage for tree to pick up
    localStorage.setItem('dojo_session_complete', JSON.stringify(batchedUpdate));

    // Also update our local skill data based on results
    for (const result of batchedUpdate.skillResults) {
        if (!skillTreeData.skills[result.skill]) {
            skillTreeData.skills[result.skill] = { state: 'in_progress' };
        }

        const skill = skillTreeData.skills[result.skill];
        skill.last_practiced = new Date().toISOString();
        skill.practice_count = (skill.practice_count || 0) + 1;

        // Update mastery based on this session (will be properly calculated by tree)
        if (result.accuracy >= 80 && result.total >= 3) {
            skill.state = 'mastered';
            skill.mastery_score = Math.max(skill.mastery_score || 0, result.accuracy);
        } else if (result.accuracy >= 60 && result.total >= 2) {
            if (skill.state !== 'mastered') {
                skill.state = 'activated';
            }
            skill.mastery_score = Math.max(skill.mastery_score || 0, result.accuracy);
        }
    }

    saveSkillTreeData();

    // Reset session
    sessionData = { startTime: null, questions: [], skillProgress: {}, mode: null };
}

// Show notification toast
function showNotification(message) {
    // Check if notification container exists
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.style.cssText = `
        background: var(--slate-700);
        border: 1px solid var(--amber-500);
        color: var(--slate-100);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 10px;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ========================================
// BELT TEST → SKILL TREE SYNC
// ========================================

// Apply belt test results to skill tree
// Returns object with lists of mastered, activated, and inferred skills
function applyBeltTestToTree() {
    const results = {
        mastered: [],      // Skills with 100% accuracy
        activated: [],     // Skills with ≥70% accuracy
        inProgress: [],    // Skills attempted but below threshold
        inferred: [],      // Prerequisites auto-unlocked
        totalSkillsUpdated: 0
    };

    // Process each tested domain
    for (let tier = 1; tier <= 10; tier++) {
        const domains = state.domainScores[tier];
        if (!domains) continue;

        for (const [domain, scores] of Object.entries(domains)) {
            if (scores.total === 0) continue;

            const accuracy = Math.round((scores.correct / scores.total) * 100);
            const treeSkillName = getTreeSkillName(domain);

            // Determine new state based on thresholds
            let newState = null;
            let newMastery = accuracy;

            if (accuracy === 100 && scores.total >= 2) {
                // 100% accuracy with at least 2 questions = mastered
                newState = 'mastered';
                newMastery = 100;
                results.mastered.push({ skill: treeSkillName, domain, tier, accuracy, questions: scores.total });
            } else if (accuracy >= 70 && scores.total >= 2) {
                // ≥70% accuracy with at least 2 questions = activated
                newState = 'activated';
                results.activated.push({ skill: treeSkillName, domain, tier, accuracy, questions: scores.total });
            } else if (scores.total >= 1) {
                // Attempted but below threshold = in_progress
                newState = 'in_progress';
                results.inProgress.push({ skill: treeSkillName, domain, tier, accuracy, questions: scores.total });
            }

            if (newState) {
                updateSkillInTree(treeSkillName, newState, newMastery);
                results.totalSkillsUpdated++;
            }
        }
    }

    // Infer prerequisites: if a skill is mastered/activated, prerequisites should be too
    const inferredSkills = inferPrerequisiteMastery(results.mastered, results.activated);
    results.inferred = inferredSkills;
    results.totalSkillsUpdated += inferredSkills.length;

    // Save to localStorage for tree to pick up
    saveSkillTreeData();

    // Write belt test results to localStorage for tree cross-tab sync
    localStorage.setItem('belt_test_complete', JSON.stringify({
        timestamp: Date.now(),
        userId: getUserId(),
        results: results,
        tierScores: state.tierScores,
        domainScores: state.domainScores
    }));

    return results;
}

// Update a single skill in the tree data
function updateSkillInTree(skillName, newState, mastery) {
    if (!skillTreeData.skills[skillName]) {
        skillTreeData.skills[skillName] = {};
    }

    const skill = skillTreeData.skills[skillName];
    const currentState = skill.state;

    // Only upgrade states, never downgrade
    const stateRank = { 'locked': 0, 'available': 1, 'in_progress': 2, 'activated': 3, 'mastered': 4, 'needs_review': 3 };
    if (stateRank[newState] > (stateRank[currentState] || 0)) {
        skill.state = newState;
    }

    // Update mastery score (keep higher)
    skill.mastery_score = Math.max(skill.mastery_score || 0, mastery);
    skill.last_practiced = new Date().toISOString();
    skill.practice_count = (skill.practice_count || 0) + 1;

    if (newState === 'mastered' && !skill.mastered_at) {
        skill.mastered_at = new Date().toISOString();
    }
}

// Infer that prerequisites are mastered if higher-level skills are mastered
function inferPrerequisiteMastery(masteredSkills, activatedSkills) {
    const inferred = [];
    const processedSkills = new Set();

    // Helper to get all prerequisites recursively
    function getAllPrereqs(skillName, visited = new Set()) {
        if (visited.has(skillName)) return [];
        visited.add(skillName);

        const directPrereqs = MATH_CONNECTIONS
            .filter(([from, to]) => to === skillName)
            .map(([from]) => from);

        let allPrereqs = [...directPrereqs];
        for (const prereq of directPrereqs) {
            allPrereqs = allPrereqs.concat(getAllPrereqs(prereq, visited));
        }
        return [...new Set(allPrereqs)];
    }

    // For each mastered skill, mark all prerequisites as mastered
    for (const { skill } of masteredSkills) {
        const prereqs = getAllPrereqs(skill);
        for (const prereq of prereqs) {
            if (!processedSkills.has(prereq)) {
                processedSkills.add(prereq);

                // Check if not already mastered
                const currentState = skillTreeData.skills[prereq]?.state;
                if (currentState !== 'mastered') {
                    updateSkillInTree(prereq, 'mastered', 100);
                    inferred.push({ skill: prereq, inferredFrom: skill, newState: 'mastered' });
                }
            }
        }
    }

    // For each activated skill, mark prerequisites as at least activated
    for (const { skill, accuracy } of activatedSkills) {
        const prereqs = getAllPrereqs(skill);
        for (const prereq of prereqs) {
            if (!processedSkills.has(prereq)) {
                processedSkills.add(prereq);

                // Check if not already mastered or activated
                const currentState = skillTreeData.skills[prereq]?.state;
                if (currentState !== 'mastered' && currentState !== 'activated') {
                    updateSkillInTree(prereq, 'activated', Math.max(accuracy, 70));
                    inferred.push({ skill: prereq, inferredFrom: skill, newState: 'activated' });
                }
            }
        }
    }

    return inferred;
}

// Generate HTML for belt test skill tree results
function renderBeltTestTreeResults(results) {
    let html = '<div class="tree-sync-results">';
    html += '<h3 style="color: var(--amber-400); margin-bottom: 1rem;">🌳 Skill Tree Updated</h3>';

    if (results.mastered.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--emerald-400);">✓ Mastered (100%)</h4>';
        html += '<div class="skill-chips">';
        for (const s of results.mastered) {
            html += `<span class="skill-chip mastered">${s.domain}</span>`;
        }
        html += '</div></div>';
    }

    if (results.activated.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--cyan-400);">◐ Activated (≥70%)</h4>';
        html += '<div class="skill-chips">';
        for (const s of results.activated) {
            html += `<span class="skill-chip activated">${s.domain} (${s.accuracy}%)</span>`;
        }
        html += '</div></div>';
    }

    if (results.inferred.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--violet-400);">↑ Prerequisites Inferred</h4>';
        html += '<div class="skill-chips">';
        const masteredInferred = results.inferred.filter(s => s.newState === 'mastered');
        const activatedInferred = results.inferred.filter(s => s.newState === 'activated');
        for (const s of masteredInferred.slice(0, 8)) {
            html += `<span class="skill-chip inferred-mastered">${s.skill}</span>`;
        }
        for (const s of activatedInferred.slice(0, 8)) {
            html += `<span class="skill-chip inferred-activated">${s.skill}</span>`;
        }
        if (results.inferred.length > 16) {
            html += `<span class="skill-chip more">+${results.inferred.length - 16} more</span>`;
        }
        html += '</div></div>';
    }

    if (results.inProgress.length > 0) {
        html += '<div class="result-section">';
        html += '<h4 style="color: var(--slate-400);">○ Needs Practice</h4>';
        html += '<div class="skill-chips">';
        for (const s of results.inProgress) {
            html += `<span class="skill-chip in-progress">${s.domain} (${s.accuracy}%)</span>`;
        }
        html += '</div></div>';
    }

    html += `<div class="total-updated" style="margin-top: 1rem; color: var(--slate-400); font-size: 0.9rem;">`;
    html += `Total skills updated: ${results.totalSkillsUpdated}`;
    html += '</div></div>';

    return html;
}

// Initialize skill tree integration on load
document.addEventListener('DOMContentLoaded', () => {
    loadSkillTreeData();

    // Request skill data from parent
    requestSkillData();

    // Check for pending practice request from skill tree
    checkPendingPracticeRequest();
});

// Check for and handle pending practice request from skill tree
function checkPendingPracticeRequest() {
    try {
        const requestData = localStorage.getItem('tree_practice_request');
        if (!requestData) return;

        const data = JSON.parse(requestData);
        // Only handle recent requests (within 10 seconds)
        if (Date.now() - data.timestamp < 10000) {
            console.log('Found pending practice request:', data.skill);
            // Clear the request so we don't handle it again
            localStorage.removeItem('tree_practice_request');
            // Small delay to let the page fully initialize
            setTimeout(() => {
                handleTreePracticeRequest(data);
            }, 500);
        } else {
            // Clear old request
            localStorage.removeItem('tree_practice_request');
        }
    } catch (e) {
        console.warn('Failed to check pending practice request:', e);
    }
}

// Also load on script execution (in case DOMContentLoaded already fired)
loadSkillTreeData();

// Send progress update to parent window (portal)
function sendSkillProgress(domain, tier, correct, total, time) {
    if (!window.parent || window.parent === window) return;

    const skillName = getSkillTreeName(domain);
    const masteryScore = total > 0 ? Math.round((correct / total) * 100) : 0;

    // Determine skill state based on mastery
    let skillState = 'in_progress';
    if (masteryScore >= 80 && total >= 3) {
        skillState = 'mastered';
    } else if (masteryScore >= 60 && total >= 2) {
        skillState = 'activated';
    }

    window.parent.postMessage({
        type: 'DOGO_SKILL_PROGRESS',
        skill: skillName,
        domain: domain,
        tier: tier,
        correct: correct,
        total: total,
        masteryScore: masteryScore,
        averageTime: time,
        skillState: skillState,
        timestamp: Date.now()
    }, '*');
}

// Send session results when test/learning ends
function sendSessionResults() {
    if (!window.parent || window.parent === window) return;

    const skillProgress = [];

    // Compile all domain scores into skill progress
    for (let t = 1; t <= 10; t++) {
        const domains = state.domainScores[t];
        if (!domains) continue;

        for (const [domain, scores] of Object.entries(domains)) {
            if (scores.total > 0) {
                const skillName = getSkillTreeName(domain);
                const masteryScore = Math.round((scores.correct / scores.total) * 100);

                let skillState = 'in_progress';
                if (masteryScore >= 80 && scores.total >= 3) {
                    skillState = 'mastered';
                } else if (masteryScore >= 60 && scores.total >= 2) {
                    skillState = 'activated';
                }

                skillProgress.push({
                    skill: skillName,
                    domain: domain,
                    tier: t,
                    correct: scores.correct,
                    total: scores.total,
                    masteryScore: masteryScore,
                    skillState: skillState
                });
            }
        }
    }

    window.parent.postMessage({
        type: 'DOGO_SESSION_COMPLETE',
        mode: state.mode,
        skillProgress: skillProgress,
        gapLog: state.gapLog.map(g => ({
            ...g,
            skill: getSkillTreeName(g.domain)
        })),
        history: state.history,
        timestamp: Date.now()
    }, '*');
}

// Request initial skill data from parent (for showing unlocked skills)
function requestSkillData() {
    if (!window.parent || window.parent === window) return;

    window.parent.postMessage({
        type: 'DOGO_REQUEST_SKILL_DATA'
    }, '*');
}

// Listen for messages from parent
window.addEventListener('message', (event) => {
    if (event.data.type === 'SKILL_DATA_FOR_DOGO') {
        // Could use this to show which skills are already mastered
        // or to unlock certain tiers based on skill tree progress
        console.log('Received skill data from parent:', event.data);
    } else if (event.data.type === 'SKILL_STATES_FROM_TREE') {
        // Skill tree has updated states - refresh our local data
        console.log('📥 Received skill states from tree:', Object.keys(event.data.skills || {}).length, 'skills');
        if (event.data.skills) {
            // Update our local skill data
            Object.assign(skillTreeData.skills, event.data.skills);
            skillTreeData.lastSync = Date.now();
            console.log('✅ Updated local skill data from tree');
        }
    } else if (event.data.type === 'FULLSCREEN_ENTER') {
        document.body.classList.add('fullscreen-mode');
    } else if (event.data.type === 'FULLSCREEN_EXIT') {
        document.body.classList.remove('fullscreen-mode');
    }
});

// ========================================
// UTILITY FUNCTIONS
// ========================================
const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const pick = arr => arr[rand(0, arr.length - 1)];
const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
const simplifyFrac = (n, d) => { const g = gcd(Math.abs(n), Math.abs(d)); return [n/g, d/g]; };

function generateDistractors(correct, count = 3, variance = null) {
    const distractors = new Set();
    const v = variance || Math.max(Math.abs(correct) * 0.5, 2);
    while (distractors.size < count) {
        let d;
        const strategy = rand(0, 3);
        if (strategy === 0) d = correct + rand(1, Math.ceil(v));
        else if (strategy === 1) d = correct - rand(1, Math.ceil(v));
        else if (strategy === 2) d = correct * 2;
        else d = Math.abs(correct - rand(1, Math.ceil(v)));
        if (d !== correct && !distractors.has(d)) distractors.add(d);
    }
    return Array.from(distractors);
}

function formatNumber(n) {
    if (Number.isInteger(n)) return n.toString();
    return parseFloat(n.toFixed(3)).toString();
}

// ========================================
// QUESTION GENERATORS BY TIER
// ========================================
const generators = {
    // TIER 1: Foundations (K-1)
    1: {
        Counting: () => {
            const type = pick(["after", "before", "count"]);
            if (type === "after") {
                const n = rand(1, 18);
                return { question: `What number comes after ${n}?`, answer: n + 1, type: "procedural",
                    explanation: `When counting up, the next number after ${n} is ${n + 1}.` };
            } else if (type === "before") {
                const n = rand(2, 19);
                return { question: `What number comes before ${n}?`, answer: n - 1, type: "procedural",
                    explanation: `When counting, the number before ${n} is ${n - 1}.` };
            } else {
                const n = rand(3, 8);
                const stars = "★ ".repeat(n).trim();
                return { question: `Count the stars: ${stars}`, answer: n, type: "procedural",
                    explanation: `Counting each star: there are ${n} stars.` };
            }
        },
        Comparison: () => {
            const a = rand(1, 20), b = rand(1, 20);
            while (a === b) b = rand(1, 20);
            const answer = a > b ? a : b;
            return { question: `Which is larger: ${a} or ${b}?`, answer, type: "conceptual",
                options: [a, b], explanation: `${answer} is larger because it comes later when counting.` };
        },
        Addition: () => {
            const a = rand(1, 9), b = rand(1, 9);
            return { question: `What is ${a} + ${b}?`, answer: a + b, type: "procedural",
                explanation: `${a} + ${b} = ${a + b}. You can count up ${b} from ${a}.` };
        },
        Subtraction: () => {
            const a = rand(5, 15), b = rand(1, a - 1);
            return { question: `What is ${a} - ${b}?`, answer: a - b, type: "procedural",
                explanation: `${a} - ${b} = ${a - b}. You can count back ${b} from ${a}.` };
        },
        Shapes: () => {
            const shapes = [
                { name: "triangle", sides: 3 }, { name: "square", sides: 4 },
                { name: "pentagon", sides: 5 }, { name: "hexagon", sides: 6 }
            ];
            const shape = pick(shapes);
            return {
                question: `How many sides does this ${shape.name} have?`,
                answer: shape.sides, type: "conceptual",
                explanation: `A ${shape.name} has ${shape.sides} sides.`,
                visual: {
                    type: 'shape',
                    mode: 'display',
                    data: { shape: shape.name, showMeasurements: false }
                }
            };
        },
        "Place Value": () => {
            const type = pick(["tens", "ones", "identify"]);
            if (type === "tens") {
                const tens = rand(1, 9);
                const ones = rand(0, 9);
                const num = tens * 10 + ones;
                return { question: `In the number ${num}, what digit is in the tens place?`, answer: tens, type: "conceptual",
                    explanation: `In ${num}, the ${tens} is in the tens place (worth ${tens * 10}).` };
            } else if (type === "ones") {
                const tens = rand(1, 9);
                const ones = rand(0, 9);
                const num = tens * 10 + ones;
                return { question: `In the number ${num}, what digit is in the ones place?`, answer: ones, type: "conceptual",
                    explanation: `In ${num}, the ${ones} is in the ones place.` };
            } else {
                const tens = rand(2, 5);
                const ones = rand(1, 5);
                return { question: `What number has ${tens} tens and ${ones} ones?`, answer: tens * 10 + ones, type: "procedural",
                    explanation: `${tens} tens = ${tens * 10}, plus ${ones} ones = ${tens * 10 + ones}.` };
            }
        },
        Patterns: () => {
            const type = pick(["number", "shape"]);
            if (type === "number") {
                const start = rand(1, 5);
                const step = pick([1, 2, 3]);
                const seq = [start, start + step, start + 2 * step, start + 3 * step];
                const answer = start + 4 * step;
                return { question: `What comes next? ${seq.join(", ")}, ?`, answer, type: "reasoning",
                    explanation: `The pattern adds ${step} each time. ${seq[3]} + ${step} = ${answer}` };
            } else {
                const patterns = [
                    { seq: "○ ● ○ ● ○ ?", answer: "●", exp: "The pattern alternates: circle, filled circle" },
                    { seq: "□ □ △ □ □ △ □ □ ?", answer: "△", exp: "The pattern is: square, square, triangle (repeating)" },
                    { seq: "★ ○ ○ ★ ○ ○ ★ ?", answer: "○", exp: "The pattern is: star, circle, circle (repeating)" }
                ];
                const p = pick(patterns);
                return { question: `What comes next? ${p.seq}`, answer: p.answer, type: "reasoning",
                    options: ["○", "●", "□", "△", "★"].slice(0, 4), explanation: p.exp };
            }
        },
        "Skip Counting": () => {
            const by = pick([2, 5, 10]);
            const start = by * rand(1, 3);
            const seq = [start, start + by, start + 2 * by, start + 3 * by];
            const answer = start + 4 * by;
            return {
                question: `Count by ${by}s: ${seq.join(", ")}, ?`,
                answer, type: "procedural",
                explanation: `Counting by ${by}s: add ${by} each time. ${seq[3]} + ${by} = ${answer}`,
                visual: {
                    type: 'numberline',
                    mode: 'display',
                    data: { min: 0, max: answer + by, step: by, markers: seq }
                }
            };
        },
        "Number Lines": () => {
            const type = pick(["locate", "jump", "between"]);
            if (type === "locate") {
                const n = rand(0, 20);
                return {
                    question: `Drag the marker to show where ${n} is on the number line.`,
                    answer: n, type: "conceptual",
                    explanation: `${n} is located ${n} units from 0 on the number line.`,
                    visual: {
                        type: 'numberline',
                        mode: 'interactive',
                        data: { min: 0, max: 20, step: 1, target: n, initialValue: 10 }
                    }
                };
            } else if (type === "jump") {
                const start = rand(2, 10);
                const jump = rand(2, 5);
                return {
                    question: `Start at ${start}. Jump forward ${jump}. Drag to show where you land.`,
                    answer: start + jump, type: "procedural",
                    explanation: `${start} + ${jump} = ${start + jump}. Moving right on a number line means adding.`,
                    visual: {
                        type: 'numberline',
                        mode: 'interactive',
                        data: { min: 0, max: 20, step: 1, markers: [start], target: start + jump, initialValue: start }
                    }
                };
            } else {
                const a = rand(1, 8), b = a + 2;
                return {
                    question: `What number is between ${a} and ${b}? Drag to show it.`,
                    answer: a + 1, type: "conceptual",
                    explanation: `${a + 1} comes right after ${a} and right before ${b}.`,
                    visual: {
                        type: 'numberline',
                        mode: 'interactive',
                        data: { min: 0, max: 10, step: 1, markers: [a, b], target: a + 1, initialValue: a }
                    }
                };
            }
        },
        "Even and Odd": () => {
            const type = pick(["identify", "next"]);
            if (type === "identify") {
                const n = rand(1, 20);
                const isEven = n % 2 === 0;
                return { question: `Is ${n} even or odd?`, answer: isEven ? "even" : "odd", type: "conceptual",
                    options: ["even", "odd"],
                    explanation: `${n} is ${isEven ? "even" : "odd"} because it ${isEven ? "can" : "cannot"} be divided into 2 equal groups.` };
            } else {
                const n = rand(2, 18);
                const isEven = n % 2 === 0;
                const nextSame = isEven ? n + 2 : n + 2;
                return { question: `What is the next ${isEven ? "even" : "odd"} number after ${n}?`, answer: nextSame, type: "procedural",
                    explanation: `${isEven ? "Even" : "Odd"} numbers are 2 apart. ${n} + 2 = ${nextSame}` };
            }
        },
        "Ordering Numbers": () => {
            const nums = [rand(1, 20), rand(1, 20), rand(1, 20)];
            while (nums[1] === nums[0]) nums[1] = rand(1, 20);
            while (nums[2] === nums[0] || nums[2] === nums[1]) nums[2] = rand(1, 20);
            const sorted = [...nums].sort((a, b) => a - b);
            const type = pick(["smallest", "largest", "middle"]);
            const visual = {
                type: 'numberline',
                mode: 'display',
                data: { min: 0, max: 20, step: 1, markers: nums }
            };
            if (type === "smallest") {
                return { question: `Look at the number line. Which is smallest: ${nums.join(", ")}?`, answer: sorted[0], type: "conceptual",
                    options: nums, explanation: `${sorted[0]} is the smallest because it's leftmost on the number line.`, visual };
            } else if (type === "largest") {
                return { question: `Look at the number line. Which is largest: ${nums.join(", ")}?`, answer: sorted[2], type: "conceptual",
                    options: nums, explanation: `${sorted[2]} is the largest because it's rightmost on the number line.`, visual };
            } else {
                return { question: `Using the number line, put in order from least to greatest: ${nums.join(", ")}`, answer: sorted.join(", "), type: "procedural",
                    explanation: `Ordered left to right: ${sorted.join(" < ")}`, visual };
            }
        },
        "Teen Numbers": () => {
            const type = pick(["identify", "compose", "place_value", "compare"]);
            if (type === "identify") {
                const teen = rand(11, 19);
                const ones = teen - 10;
                return { question: `The number ${teen} has 1 ten and how many ones?`, answer: ones, type: "conceptual",
                    options: [ones, ones + 1, teen, 10],
                    explanation: `${teen} = 10 + ${ones}. It has 1 ten and ${ones} ones.` };
            } else if (type === "compose") {
                const ones = rand(1, 9);
                const teen = 10 + ones;
                return { question: `What number is 10 + ${ones}?`, answer: teen, type: "procedural",
                    options: [teen, ones, teen + 10, ones + 1],
                    explanation: `10 + ${ones} = ${teen}. Teen numbers are 10 plus some ones.` };
            } else if (type === "place_value") {
                const teen = rand(11, 19);
                return { question: `How many tens are in the number ${teen}?`, answer: 1, type: "conceptual",
                    options: [1, teen - 10, 10, 2],
                    explanation: `${teen} has exactly 1 ten (and ${teen - 10} ones).` };
            } else {
                const teen1 = rand(11, 15);
                const teen2 = rand(16, 19);
                const larger = teen2;
                return { question: `Which is larger: ${teen1} or ${teen2}?`, answer: larger, type: "conceptual",
                    options: [teen1, teen2],
                    explanation: `${teen2} > ${teen1} because ${teen2 - 10} ones > ${teen1 - 10} ones (both have 1 ten).` };
            }
        },
        "Number Bonds": () => {
            const type = pick(["make_5", "make_10", "break_apart", "missing"]);
            if (type === "make_5") {
                const part1 = rand(0, 5);
                const part2 = 5 - part1;
                return { question: `${part1} + ? = 5`, answer: part2, type: "procedural",
                    options: [part2, part1, 5, part2 + 1].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${part1} + ${part2} = 5. These are number bonds to 5.` };
            } else if (type === "make_10") {
                const part1 = rand(0, 10);
                const part2 = 10 - part1;
                return { question: `${part1} + ? = 10`, answer: part2, type: "procedural",
                    options: [part2, part1, 10, Math.abs(part2 - 1)].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${part1} + ${part2} = 10. Knowing bonds to 10 helps with mental math!` };
            } else if (type === "break_apart") {
                const total = pick([5, 10]);
                const part1 = rand(1, total - 1);
                const part2 = total - part1;
                return { question: `Break apart ${total}: ${total} = ${part1} + ?`, answer: part2, type: "procedural",
                    explanation: `${total} = ${part1} + ${part2}. We can break ${total} into ${part1} and ${part2}.` };
            } else {
                const total = rand(6, 10);
                const part1 = rand(1, total - 1);
                const part2 = total - part1;
                return { question: `? + ${part2} = ${total}`, answer: part1, type: "procedural",
                    options: [part1, part2, total, part1 + 1].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${part1} + ${part2} = ${total}. The missing part is ${part1}.` };
            }
        },
        "Picture Graphs": () => {
            const type = pick(["count", "compare", "total", "difference"]);
            const items = pick([
                { name: "apples", symbol: "🍎" },
                { name: "stars", symbol: "★" },
                { name: "hearts", symbol: "♥" },
                { name: "circles", symbol: "●" }
            ]);
            if (type === "count") {
                const count = rand(2, 6);
                const display = (items.symbol + " ").repeat(count).trim();
                return { question: `How many ${items.name}? ${display}`, answer: count, type: "procedural",
                    explanation: `Count each ${items.symbol}: there are ${count} ${items.name}.` };
            } else if (type === "compare") {
                const count1 = rand(2, 5);
                const count2 = rand(2, 5);
                while (count2 === count1) count2 = rand(2, 5);
                const row1 = "Red: " + (items.symbol + " ").repeat(count1).trim();
                const row2 = "Blue: " + (items.symbol + " ").repeat(count2).trim();
                const more = count1 > count2 ? "Red" : "Blue";
                return { question: `Which has more?\n${row1}\n${row2}`, answer: more, type: "conceptual",
                    options: ["Red", "Blue", "Same"],
                    explanation: `${more} has more (${Math.max(count1, count2)} vs ${Math.min(count1, count2)}).` };
            } else if (type === "total") {
                const count1 = rand(2, 4);
                const count2 = rand(2, 4);
                const row1 = "Cats: " + ("🐱 ").repeat(count1).trim();
                const row2 = "Dogs: " + ("🐶 ").repeat(count2).trim();
                return { question: `How many pets in all?\n${row1}\n${row2}`, answer: count1 + count2, type: "procedural",
                    explanation: `${count1} cats + ${count2} dogs = ${count1 + count2} pets total.` };
            } else {
                const count1 = rand(4, 7);
                const count2 = rand(1, count1 - 1);
                const row1 = "Sunny: " + ("☀ ").repeat(count1).trim();
                const row2 = "Rainy: " + ("🌧 ").repeat(count2).trim();
                return { question: `How many more sunny days than rainy?\n${row1}\n${row2}`, answer: count1 - count2, type: "reasoning",
                    explanation: `${count1} sunny - ${count2} rainy = ${count1 - count2} more sunny days.` };
            }
        },
        "3D Shapes": () => {
            const type = pick(["identify", "faces", "real_world", "compare"]);
            const shapes3D = [
                { name: "cube", faces: 6, edges: 12, vertices: 8, realWorld: ["dice", "ice cube", "box"] },
                { name: "sphere", faces: 0, edges: 0, vertices: 0, realWorld: ["ball", "globe", "orange"] },
                { name: "cylinder", faces: 2, edges: 2, vertices: 0, realWorld: ["can", "tube", "log"] },
                { name: "cone", faces: 1, edges: 1, vertices: 1, realWorld: ["ice cream cone", "party hat", "traffic cone"] },
                { name: "rectangular prism", faces: 6, edges: 12, vertices: 8, realWorld: ["cereal box", "brick", "book"] }
            ];
            const getVisual = (shapeName) => ({
                type: 'shape', mode: 'display',
                data: { shape: shapeName === 'rectangular prism' ? 'cube' : shapeName, showMeasurements: false }
            });
            if (type === "identify") {
                const shape = pick(shapes3D);
                const item = pick(shape.realWorld);
                return { question: `A ${item} is shaped like a...?`, answer: shape.name, type: "conceptual",
                    options: shapes3D.slice(0, 4).map(s => s.name),
                    explanation: `A ${item} is shaped like a ${shape.name}.` };
            } else if (type === "faces") {
                const shape = pick(shapes3D.filter(s => s.faces > 0));
                return { question: `How many flat faces does this ${shape.name} have?`, answer: shape.faces, type: "conceptual",
                    options: [shape.faces, shape.faces + 1, shape.faces - 1, shape.faces + 2].filter(n => n >= 0),
                    explanation: `A ${shape.name} has ${shape.faces} flat face${shape.faces !== 1 ? "s" : ""}.`,
                    visual: getVisual(shape.name) };
            } else if (type === "real_world") {
                const shape = pick(shapes3D);
                const correct = pick(shape.realWorld);
                const wrong = shapes3D.filter(s => s.name !== shape.name).flatMap(s => s.realWorld).slice(0, 3);
                return { question: `Look at this shape. Which object is shaped like it?`, answer: correct, type: "conceptual",
                    options: shuffle([correct, ...wrong]).slice(0, 4),
                    explanation: `A ${correct} is shaped like a ${shape.name}.`,
                    visual: getVisual(shape.name) };
            } else {
                const shape = pick(shapes3D.filter(s => s.name !== "sphere"));
                return { question: `Can this ${shape.name} roll?`, answer: shape.name === "sphere" || shape.name === "cylinder" || shape.name === "cone" ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: shape.name === "sphere" || shape.name === "cylinder" || shape.name === "cone" ?
                        `Yes! A ${shape.name} has curved surfaces and can roll.` :
                        `No. A ${shape.name} has only flat faces and cannot roll.`,
                    visual: getVisual(shape.name) };
            }
        },
        "Partitioning Shapes": () => {
            const type = pick(["halves", "fourths", "identify", "equal_parts"]);
            if (type === "halves") {
                const shape = pick(["circle", "square", "rectangle"]);
                return { question: `If we cut a ${shape} into 2 equal parts, what is each part called?`, answer: "half", type: "conceptual",
                    options: ["half", "fourth", "third", "whole"],
                    explanation: `When we divide something into 2 equal parts, each part is called a half.` };
            } else if (type === "fourths") {
                const shape = pick(["circle", "square", "rectangle"]);
                return { question: `If we cut a ${shape} into 4 equal parts, what is each part called?`, answer: "fourth", type: "conceptual",
                    options: ["fourth", "half", "third", "whole"],
                    explanation: `When we divide something into 4 equal parts, each part is called a fourth (or quarter).` };
            } else if (type === "identify") {
                const parts = pick([2, 4]);
                const partName = parts === 2 ? "halves" : "fourths";
                return { question: `A pizza is cut into ${parts} equal slices. The pizza is cut into...?`, answer: partName, type: "conceptual",
                    options: ["halves", "fourths", "thirds", "sixths"],
                    explanation: `${parts} equal parts are called ${partName}.` };
            } else {
                const total = pick([2, 4]);
                const shaded = rand(1, total);
                return { question: `A shape is divided into ${total} equal parts. ${shaded} part${shaded > 1 ? "s are" : " is"} shaded. How many parts are shaded?`, answer: shaded, type: "procedural",
                    explanation: `${shaded} out of ${total} equal parts are shaded.` };
            }
        },
        "Composing Shapes": () => {
            const type = pick(["combine", "build", "identify_parts"]);
            if (type === "combine") {
                const combos = [
                    { parts: "2 triangles", result: "square", explanation: "Two right triangles can form a square." },
                    { parts: "2 triangles", result: "rectangle", explanation: "Two triangles can form a rectangle." },
                    { parts: "2 squares", result: "rectangle", explanation: "Two squares side by side make a rectangle." },
                    { parts: "6 squares", result: "cube", explanation: "Six squares can fold into a cube." }
                ];
                const combo = pick(combos);
                return { question: `What shape can you make with ${combo.parts}?`, answer: combo.result, type: "reasoning",
                    options: ["square", "rectangle", "triangle", "cube"].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: combo.explanation };
            } else if (type === "build") {
                const shapes = [
                    { target: "rectangle", needs: "2 squares" },
                    { target: "hexagon", needs: "6 triangles" },
                    { target: "square", needs: "2 triangles" }
                ];
                const shape = pick(shapes);
                return { question: `To build a ${shape.target}, you could use...?`, answer: shape.needs, type: "reasoning",
                    options: ["2 squares", "2 triangles", "6 triangles", "4 circles"],
                    explanation: `You can build a ${shape.target} using ${shape.needs}.` };
            } else {
                const wholes = [
                    { shape: "rectangle", parts: 2, partName: "squares" },
                    { shape: "square", parts: 4, partName: "smaller squares" },
                    { shape: "hexagon", parts: 6, partName: "triangles" }
                ];
                const whole = pick(wholes);
                return { question: `A ${whole.shape} is made of ${whole.parts} ${whole.partName}. How many ${whole.partName}?`, answer: whole.parts, type: "conceptual",
                    options: [whole.parts, whole.parts + 1, whole.parts - 1, whole.parts * 2],
                    explanation: `The ${whole.shape} is composed of ${whole.parts} ${whole.partName}.` };
            }
        },
        "Comparing Lengths": () => {
            const type = pick(["compare", "order", "measure", "estimate"]);
            if (type === "compare") {
                const items = [
                    { name: "pencil", length: 7 },
                    { name: "crayon", length: 4 },
                    { name: "book", length: 10 },
                    { name: "eraser", length: 2 }
                ];
                const item1 = pick(items);
                let item2 = pick(items);
                while (item2.name === item1.name) item2 = pick(items);
                const longer = item1.length > item2.length ? item1.name : item2.name;
                return { question: `Which is longer: a ${item1.name} or a ${item2.name}?`, answer: longer, type: "conceptual",
                    options: [item1.name, item2.name, "Same length"],
                    explanation: `A ${longer} is longer than a ${item1.name === longer ? item2.name : item1.name}.` };
            } else if (type === "order") {
                const items = ["ant", "cat", "bus"];
                return { question: `Order from shortest to longest: ${shuffle([...items]).join(", ")}`, answer: items.join(", "), type: "reasoning",
                    explanation: `From shortest to longest: ant (tiny), cat (small), bus (large).` };
            } else if (type === "measure") {
                const cubes = rand(3, 8);
                return { question: `A ribbon is ${cubes} cubes long. How many cubes?`, answer: cubes, type: "procedural",
                    explanation: `The ribbon measures ${cubes} cubes in length.` };
            } else {
                const objects = [
                    { name: "your hand", length: "about 6 inches" },
                    { name: "a door", length: "about 7 feet" },
                    { name: "a paperclip", length: "about 1 inch" }
                ];
                const obj = pick(objects);
                return { question: `About how long is ${obj.name}?`, answer: obj.length, type: "conceptual",
                    options: ["about 1 inch", "about 6 inches", "about 7 feet", "about 100 feet"],
                    explanation: `${obj.name.charAt(0).toUpperCase() + obj.name.slice(1)} is ${obj.length}.` };
            }
        },
        "Positional Words": () => {
            const positions = [
                { word: "above", opposite: "below", example: "The bird is ___ the tree", answer: "above" },
                { word: "below", opposite: "above", example: "The fish is ___ the water surface", answer: "below" },
                { word: "beside", opposite: "far from", example: "The chair is ___ the table", answer: "beside" },
                { word: "between", opposite: "outside", example: "The number 5 is ___ 4 and 6", answer: "between" },
                { word: "behind", opposite: "in front of", example: "The sun is ___ the clouds", answer: "behind" },
                { word: "next to", opposite: "far from", example: "My desk is ___ the window", answer: "next to" }
            ];
            const type = pick(["fill_in", "identify", "opposite"]);
            if (type === "fill_in") {
                const pos = pick(positions);
                return { question: pos.example.replace("___", "____"), answer: pos.answer, type: "conceptual",
                    options: shuffle(positions.slice(0, 4).map(p => p.word)),
                    explanation: `"${pos.word}" describes the position correctly.` };
            } else if (type === "identify") {
                const pos = pick(positions);
                return { question: `What word means the same as "${pos.word}"?`, answer: pos.word, type: "conceptual",
                    options: shuffle([pos.word, pos.opposite, pick(positions.filter(p => p.word !== pos.word)).word, "inside"]).slice(0, 4),
                    explanation: `"${pos.word}" describes a position.` };
            } else {
                const pos = pick(positions.filter(p => p.opposite !== "far from"));
                return { question: `What is the opposite of "${pos.word}"?`, answer: pos.opposite, type: "conceptual",
                    options: shuffle([pos.opposite, pos.word, "beside", "through"]).slice(0, 4),
                    explanation: `The opposite of "${pos.word}" is "${pos.opposite}".` };
            }
        },
        "Classifying Objects": () => {
            const type = pick(["by_color", "by_size", "by_shape", "odd_one_out"]);
            if (type === "by_color") {
                const colors = ["red", "blue", "green", "yellow"];
                const color = pick(colors);
                const items = [
                    { name: "apple", color: "red" }, { name: "fire truck", color: "red" },
                    { name: "sky", color: "blue" }, { name: "ocean", color: "blue" },
                    { name: "grass", color: "green" }, { name: "leaf", color: "green" },
                    { name: "sun", color: "yellow" }, { name: "banana", color: "yellow" }
                ];
                const matching = items.filter(i => i.color === color);
                const item = pick(matching);
                return { question: `What color group does a ${item.name} belong to?`, answer: color, type: "conceptual",
                    options: colors,
                    explanation: `A ${item.name} is ${color}, so it belongs in the ${color} group.` };
            } else if (type === "by_size") {
                const sizes = [
                    { item: "elephant", size: "big" },
                    { item: "ant", size: "small" },
                    { item: "house", size: "big" },
                    { item: "button", size: "small" },
                    { item: "car", size: "big" },
                    { item: "penny", size: "small" }
                ];
                const obj = pick(sizes);
                return { question: `Is a ${obj.item} big or small?`, answer: obj.size, type: "conceptual",
                    options: ["big", "small"],
                    explanation: `A ${obj.item} is ${obj.size}.` };
            } else if (type === "by_shape") {
                const items = [
                    { name: "clock", shape: "circle" },
                    { name: "window", shape: "square" },
                    { name: "door", shape: "rectangle" },
                    { name: "slice of pizza", shape: "triangle" },
                    { name: "wheel", shape: "circle" },
                    { name: "book", shape: "rectangle" }
                ];
                const item = pick(items);
                return { question: `What shape is a ${item.name}?`, answer: item.shape, type: "conceptual",
                    options: ["circle", "square", "rectangle", "triangle"],
                    explanation: `A ${item.name} is shaped like a ${item.shape}.` };
            } else {
                const groups = [
                    { items: ["apple", "banana", "orange", "car"], odd: "car", reason: "car is not a fruit" },
                    { items: ["dog", "cat", "bird", "table"], odd: "table", reason: "table is not an animal" },
                    { items: ["2", "4", "6", "7"], odd: "7", reason: "7 is not an even number" },
                    { items: ["circle", "square", "triangle", "red"], odd: "red", reason: "red is a color, not a shape" }
                ];
                const group = pick(groups);
                return { question: `Which one does NOT belong: ${group.items.join(", ")}?`, answer: group.odd, type: "reasoning",
                    options: group.items,
                    explanation: `${group.odd} does not belong because ${group.reason}.` };
            }
        }
    },

    // TIER 2: Core Operations (2-4)
    2: {
        "Multi-Digit Addition": () => {
            const a = rand(100, 999), b = rand(100, 999);
            return { question: `What is ${a} + ${b}?`, answer: a + b, type: "procedural",
                explanation: `Add ones, then tens, then hundreds. Carry when needed. ${a} + ${b} = ${a + b}` };
        },
        "Multi-Digit Subtraction": () => {
            const a = rand(200, 999), b = rand(100, a - 50);
            return { question: `What is ${a} - ${b}?`, answer: a - b, type: "procedural",
                explanation: `Subtract ones, tens, hundreds. Borrow when needed. ${a} - ${b} = ${a - b}` };
        },
        Multiplication: () => {
            const a = rand(2, 12), b = rand(2, 12);
            return { question: `What is ${a} × ${b}?`, answer: a * b, type: "procedural",
                explanation: `${a} × ${b} = ${a * b}. This means ${a} groups of ${b}.` };
        },
        Division: () => {
            const b = rand(2, 12), answer = rand(2, 12);
            const a = b * answer;
            return { question: `What is ${a} ÷ ${b}?`, answer, type: "procedural",
                explanation: `${a} ÷ ${b} = ${answer} because ${b} × ${answer} = ${a}.` };
        },
        "Long Division": () => {
            const divisor = rand(2, 9);
            const quotient = rand(10, 30);
            const remainder = rand(0, divisor - 1);
            const dividend = divisor * quotient + remainder;
            if (remainder === 0) {
                return { question: `What is ${dividend} ÷ ${divisor}?`, answer: quotient, type: "procedural",
                    explanation: `${dividend} ÷ ${divisor} = ${quotient} with no remainder.` };
            } else {
                return { question: `${dividend} ÷ ${divisor} = ? R ?`, answer: `${quotient} R ${remainder}`, type: "procedural",
                    options: [`${quotient} R ${remainder}`, `${quotient + 1} R ${remainder}`, `${quotient} R ${remainder + 1}`, `${quotient - 1} R ${divisor}`],
                    explanation: `${dividend} = ${divisor} × ${quotient} + ${remainder}, so ${dividend} ÷ ${divisor} = ${quotient} R ${remainder}` };
            }
        },
        Fractions: () => {
            const type = pick(["identify", "compare_same", "compare_diff", "of_number", "number_line", "order"]);

            if (type === "identify") {
                // Identify fraction from visual
                const d = pick([2, 3, 4, 5, 6, 8]);
                const n = rand(1, d - 1);
                const style = pick(['bar', 'circle']);
                return {
                    question: `What fraction of the shape is shaded?`,
                    answer: `${n}/${d}`, type: "conceptual",
                    options: [`${n}/${d}`, `${d}/${n}`, `${n}/${d+1}`, `${d-n}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `${n} shaded out of ${d} equal parts = ${n}/${d}. The numerator is parts shaded, the denominator is total parts.`,
                    visual: { type: 'fraction', mode: 'display', data: { style, numerator: n, denominator: d } }
                };
            } else if (type === "compare_same") {
                // Compare fractions with same denominator
                const d = pick([2, 3, 4, 5, 6, 8]);
                const n1 = rand(1, d - 1);
                let n2 = rand(1, d - 1);
                while (n2 === n1) n2 = rand(1, d - 1);
                const larger = n1 > n2 ? `${n1}/${d}` : `${n2}/${d}`;
                return {
                    question: `Which fraction is larger?`,
                    answer: larger, type: "conceptual",
                    options: [`${n1}/${d}`, `${n2}/${d}`, "They are equal"],
                    explanation: `With the same denominator, compare numerators. ${Math.max(n1,n2)} > ${Math.min(n1,n2)}, so ${larger} is larger.`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n1, denominator: d, compare: { numerator: n2, denominator: d } } }
                };
            } else if (type === "compare_diff") {
                // Compare fractions with different denominators
                const pairs = [
                    { n1: 1, d1: 4, n2: 1, d2: 3 }, { n1: 1, d1: 2, n2: 2, d2: 3 },
                    { n1: 2, d1: 3, n2: 3, d2: 4 }, { n1: 1, d1: 3, n2: 1, d2: 2 }
                ];
                const p = pick(pairs);
                const v1 = p.n1 / p.d1, v2 = p.n2 / p.d2;
                const larger = v1 > v2 ? `${p.n1}/${p.d1}` : `${p.n2}/${p.d2}`;
                return {
                    question: `Compare these fractions. Which is larger?`,
                    answer: larger, type: "conceptual",
                    options: [`${p.n1}/${p.d1}`, `${p.n2}/${p.d2}`, "They are equal"],
                    explanation: `${larger} is larger. You can compare by finding common denominators or using the visuals.`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'circle', numerator: p.n1, denominator: p.d1, compare: { numerator: p.n2, denominator: p.d2 } } }
                };
            } else if (type === "of_number") {
                // Fraction of a whole number
                const d = pick([2, 3, 4, 5]);
                const n = rand(1, d - 1);
                const multiples = [d * 2, d * 3, d * 4, d * 5, d * 6];
                const whole = pick(multiples);
                const answer = (n * whole) / d;
                return {
                    question: `What is ${n}/${d} of ${whole}?`,
                    answer: answer, type: "procedural",
                    options: [answer, whole / d, n * whole, whole - answer].filter((v,i,a) => a.indexOf(v) === i && v > 0),
                    explanation: `To find ${n}/${d} of ${whole}: First divide ${whole} ÷ ${d} = ${whole/d}. Then multiply ${whole/d} × ${n} = ${answer}.`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n, denominator: d } }
                };
            } else if (type === "number_line") {
                // Fractions on number line
                const d = pick([2, 3, 4]);
                const n = rand(1, d);
                const lineDesc = d === 2 ? "two equal parts" : d === 3 ? "three equal parts" : "four equal parts";
                return { question: `A number line from 0 to 1 is divided into ${lineDesc}. What fraction is at the ${n === 1 ? "first" : n === 2 ? "second" : n === 3 ? "third" : "fourth"} mark?`,
                    answer: n === d ? "1" : `${n}/${d}`, type: "conceptual",
                    options: [`${n}/${d}`, `${d}/${n}`, `${n}/${d+1}`, `${d-n}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `The number line is divided into ${d} equal parts. The ${n === 1 ? "first" : n === 2 ? "second" : n === 3 ? "third" : "fourth"} mark represents ${n}/${d}${n === d ? " = 1" : ""}.` };
            } else {
                // Order fractions (same denominator)
                const d = pick([4, 6, 8]);
                const nums = [];
                while (nums.length < 3) {
                    const n = rand(1, d - 1);
                    if (!nums.includes(n)) nums.push(n);
                }
                const sorted = [...nums].sort((a, b) => a - b);
                const answer = sorted.map(n => `${n}/${d}`).join(", ");
                return { question: `Order from least to greatest: ${nums.map(n => `${n}/${d}`).join(", ")}`, answer: answer, type: "procedural",
                    explanation: `With the same denominator (${d}), order by numerator: ${sorted.join(" < ")}. Answer: ${answer}` };
            }
        },
        "Fraction Operations": () => {
            const type = pick(["add_same", "subtract_same", "add_visual", "subtract_visual"]);
            const d = pick([2, 3, 4, 5, 6, 8]);

            if (type === "add_same") {
                // Adding fractions with same denominator
                const n1 = rand(1, d - 2);
                const n2 = rand(1, d - n1);
                const sum = n1 + n2;
                const answerStr = sum >= d ? (sum === d ? "1" : `${sum}/${d}`) : `${sum}/${d}`;
                return { question: `What is ${n1}/${d} + ${n2}/${d}?`, answer: answerStr, type: "procedural",
                    options: [`${sum}/${d}`, `${n1 + n2}/${d + d}`, `${n1}/${d + n2}`, `${sum}/${d * 2}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `When adding fractions with the same denominator, add the numerators and keep the denominator: ${n1}/${d} + ${n2}/${d} = ${n1 + n2}/${d}${sum === d ? " = 1" : ""}` };
            } else if (type === "subtract_same") {
                // Subtracting fractions with same denominator
                const n1 = rand(2, d - 1);
                const n2 = rand(1, n1 - 1);
                const diff = n1 - n2;
                return { question: `What is ${n1}/${d} - ${n2}/${d}?`, answer: `${diff}/${d}`, type: "procedural",
                    options: [`${diff}/${d}`, `${n1 - n2}/${d - d || 1}`, `${n1}/${d - n2 || 1}`, `${diff}/${d * 2}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `When subtracting fractions with the same denominator, subtract the numerators and keep the denominator: ${n1}/${d} - ${n2}/${d} = ${diff}/${d}` };
            } else if (type === "add_visual") {
                // Visual addition with context
                const d = pick([4, 8]);
                const n1 = rand(1, d - 2);
                const n2 = rand(1, d - n1);
                const sum = n1 + n2;
                const item = d === 4 ? "pizza" : "pie";
                return { question: `You eat ${n1}/${d} of a ${item}. Your friend eats ${n2}/${d} of the same ${item}. How much ${item} was eaten in total?`,
                    answer: `${sum}/${d}`, type: "reasoning",
                    options: [`${sum}/${d}`, `${n1 + n2}/${d + d}`, `${sum}/${d * 2}`, `${n1 * n2}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Add the parts: ${n1}/${d} + ${n2}/${d} = ${sum}/${d} of the ${item} was eaten.` };
            } else {
                // Visual subtraction with context
                const d = pick([4, 8]);
                const n1 = rand(3, d - 1);
                const n2 = rand(1, n1 - 1);
                const diff = n1 - n2;
                const item = d === 4 ? "cake" : "pie";
                return { question: `A ${item} has ${n1}/${d} left. You eat ${n2}/${d} of the whole ${item}. How much is left now?`,
                    answer: `${diff}/${d}`, type: "reasoning",
                    options: [`${diff}/${d}`, `${n1 + n2}/${d}`, `${diff}/${d * 2}`, `${n1 * n2}/${d}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Subtract the parts: ${n1}/${d} - ${n2}/${d} = ${diff}/${d} of the ${item} remains.` };
            }
        },
        "Equivalent Fractions": () => {
            const type = pick(["multiply", "divide", "identify"]);

            if (type === "multiply") {
                const n = rand(1, 4), d = rand(n + 1, 6);
                const mult = rand(2, 4);
                return {
                    question: `This fraction bar shows ${n}/${d}. What equivalent fraction has ${d * mult} parts?`,
                    answer: `${n * mult}/${d * mult}`, type: "procedural",
                    options: [`${n * mult}/${d * mult}`, `${n + mult}/${d + mult}`, `${n * mult}/${d}`, `${n}/${d * mult}`],
                    explanation: `Multiply both by ${mult}: ${n}×${mult}/${d}×${mult} = ${n * mult}/${d * mult}`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n, denominator: d } }
                };
            } else if (type === "divide") {
                const n = rand(1, 3), d = rand(n + 1, 5);
                const mult = rand(2, 4);
                const bigN = n * mult, bigD = d * mult;
                return {
                    question: `Simplify ${bigN}/${bigD} by dividing by ${mult}.`,
                    answer: `${n}/${d}`, type: "procedural",
                    options: [`${n}/${d}`, `${bigN - mult}/${bigD - mult}`, `${bigN}/${d}`, `${n}/${bigD}`],
                    explanation: `Divide both by ${mult}: ${bigN}÷${mult}/${bigD}÷${mult} = ${n}/${d}`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: bigN, denominator: bigD } }
                };
            } else {
                const n = rand(1, 3), d = rand(n + 1, 5);
                const mult = rand(2, 4);
                const isEquiv = pick([true, false]);
                const n2 = isEquiv ? n * mult : n * mult + 1;
                const d2 = d * mult;
                return {
                    question: `Are these fractions equivalent?`,
                    answer: isEquiv ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isEquiv ?
                        `Yes! ${n}×${mult}=${n2} and ${d}×${mult}=${d2}, so ${n}/${d} = ${n2}/${d2}` :
                        `No. ${n}×${mult}=${n*mult} (not ${n2}), so ${n}/${d} ≠ ${n2}/${d2}`,
                    visual: { type: 'fraction', mode: 'display', data: { style: 'bar', numerator: n, denominator: d, compare: { numerator: n2, denominator: d2 } } }
                };
            }
        },
        "Simplifying Fractions": () => {
            const type = pick(["simplify_basic", "simplify_gcf", "already_simplified", "simplify_to_whole"]);

            if (type === "simplify_basic") {
                // Simple cases with small common factors
                const simplified = [
                    { n: 1, d: 2, mult: pick([2, 3, 4]) },
                    { n: 1, d: 3, mult: pick([2, 3]) },
                    { n: 1, d: 4, mult: pick([2, 3]) },
                    { n: 2, d: 3, mult: pick([2, 3]) },
                    { n: 3, d: 4, mult: pick([2, 3]) }
                ];
                const frac = pick(simplified);
                const bigN = frac.n * frac.mult, bigD = frac.d * frac.mult;
                return { question: `Simplify ${bigN}/${bigD} to lowest terms.`, answer: `${frac.n}/${frac.d}`, type: "procedural",
                    options: [`${frac.n}/${frac.d}`, `${bigN}/${frac.d}`, `${frac.n}/${bigD}`, `${bigN - 1}/${bigD - 1}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Find the GCF of ${bigN} and ${bigD}, which is ${frac.mult}. Divide both by ${frac.mult}: ${bigN}÷${frac.mult}/${bigD}÷${frac.mult} = ${frac.n}/${frac.d}` };
            } else if (type === "simplify_gcf") {
                // Teach GCF concept
                const gcf = pick([2, 3, 4, 5]);
                const n = rand(1, 3) * gcf;
                const d = rand(2, 4) * gcf;
                if (n >= d) return { question: `Simplify ${gcf * 2}/${gcf * 4} to lowest terms.`, answer: `1/2`, type: "procedural",
                    options: ["1/2", `${gcf}/2`, `2/${gcf}`, `${gcf * 2 - 1}/${gcf * 4 - 1}`],
                    explanation: `The GCF of ${gcf * 2} and ${gcf * 4} is ${gcf * 2}. Divide both: ${gcf * 2}÷${gcf * 2}/${gcf * 4}÷${gcf * 2} = 1/2` };
                const simpN = n / gcf, simpD = d / gcf;
                return { question: `Simplify ${n}/${d}. (Hint: GCF is ${gcf})`, answer: `${simpN}/${simpD}`, type: "procedural",
                    options: [`${simpN}/${simpD}`, `${n - gcf}/${d - gcf}`, `${n}/${simpD}`, `${simpN}/${d}`].filter((v,i,a) => a.indexOf(v) === i && !v.includes("-") && !v.includes("/0")),
                    explanation: `Divide both numerator and denominator by the GCF (${gcf}): ${n}÷${gcf}/${d}÷${gcf} = ${simpN}/${simpD}` };
            } else if (type === "already_simplified") {
                // Recognize when a fraction is already in lowest terms
                const fractions = [
                    { n: 1, d: 2 }, { n: 1, d: 3 }, { n: 2, d: 3 }, { n: 1, d: 4 }, { n: 3, d: 4 },
                    { n: 1, d: 5 }, { n: 2, d: 5 }, { n: 3, d: 5 }, { n: 4, d: 5 }, { n: 5, d: 6 }
                ];
                const frac = pick(fractions);
                return { question: `Is ${frac.n}/${frac.d} already in simplest form?`, answer: "Yes", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `Yes! ${frac.n} and ${frac.d} share no common factors other than 1, so ${frac.n}/${frac.d} is already in simplest form.` };
            } else {
                // Simplify to a whole number
                const whole = rand(2, 5);
                const d = pick([2, 3, 4, 5]);
                const n = whole * d;
                return { question: `Simplify ${n}/${d}.`, answer: `${whole}`, type: "procedural",
                    options: [`${whole}`, `${n - 1}/${d}`, `1/${d}`, `${d}/${n}`],
                    explanation: `${n} ÷ ${d} = ${whole}. When the numerator is divisible by the denominator, the fraction equals a whole number.` };
            }
        },
        "Mixed Numbers": () => {
            const whole = rand(1, 5), n = rand(1, 3), d = rand(n + 1, 5);
            const improper = whole * d + n;
            const type = pick(["toImproper", "toMixed", "compare", "add_mixed"]);
            if (type === "toImproper") {
                return { question: `Convert ${whole} ${n}/${d} to an improper fraction.`, answer: `${improper}/${d}`, type: "procedural",
                    options: [`${improper}/${d}`, `${whole + n}/${d}`, `${whole * n}/${d}`, `${n}/${whole * d}`],
                    explanation: `${whole} × ${d} + ${n} = ${improper}, so ${whole} ${n}/${d} = ${improper}/${d}` };
            } else if (type === "toMixed") {
                return { question: `Convert ${improper}/${d} to a mixed number.`, answer: `${whole} ${n}/${d}`, type: "procedural",
                    options: [`${whole} ${n}/${d}`, `${whole + 1} ${n}/${d}`, `${whole} ${n + 1}/${d}`, `${improper - d} ${n}/${d}`],
                    explanation: `${improper} ÷ ${d} = ${whole} R ${n}, so ${improper}/${d} = ${whole} ${n}/${d}` };
            } else if (type === "compare") {
                // Compare mixed number to improper fraction
                const w2 = whole + pick([-1, 0, 1]);
                const improper2 = w2 * d + n;
                if (improper === improper2) {
                    return { question: `Are ${whole} ${n}/${d} and ${improper}/${d} equal?`, answer: "Yes", type: "conceptual",
                        options: ["Yes", "No"],
                        explanation: `Yes! ${whole} ${n}/${d} = ${improper}/${d} because ${whole}×${d}+${n} = ${improper}.` };
                }
                const larger = improper > improper2 ? `${whole} ${n}/${d}` : `${improper2}/${d}`;
                return { question: `Which is larger: ${whole} ${n}/${d} or ${improper2}/${d}?`, answer: larger, type: "conceptual",
                    options: [`${whole} ${n}/${d}`, `${improper2}/${d}`, "They are equal"],
                    explanation: `Convert to compare: ${whole} ${n}/${d} = ${improper}/${d}. Since ${Math.max(improper, improper2)} > ${Math.min(improper, improper2)}, ${larger} is larger.` };
            } else {
                // Add mixed numbers with same denominator
                const w1 = rand(1, 3), w2 = rand(1, 3);
                const d = pick([2, 3, 4]);
                const n1 = rand(1, d - 1), n2 = rand(1, d - 1);
                const sumWhole = w1 + w2 + Math.floor((n1 + n2) / d);
                const sumFrac = (n1 + n2) % d;
                const answer = sumFrac === 0 ? `${sumWhole}` : `${sumWhole} ${sumFrac}/${d}`;
                return { question: `What is ${w1} ${n1}/${d} + ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                    explanation: `Add whole numbers: ${w1} + ${w2} = ${w1 + w2}. Add fractions: ${n1}/${d} + ${n2}/${d} = ${n1 + n2}/${d}${n1 + n2 >= d ? ` = 1 ${(n1+n2) - d}/${d}` : ""}. Total: ${answer}` };
            }
        },
        "Fraction Word Problems": () => {
            const type = pick(["part_of_whole", "remaining", "sharing", "combining", "comparing"]);

            if (type === "part_of_whole") {
                // Finding a fraction of a group
                const d = pick([2, 3, 4, 5]);
                const n = rand(1, d - 1);
                const total = d * rand(2, 5);
                const answer = (n * total) / d;
                const items = pick(["cookies", "marbles", "stickers", "books", "apples"]);
                return { question: `There are ${total} ${items}. ${n}/${d} of them are red. How many red ${items} are there?`,
                    answer: answer, type: "reasoning",
                    explanation: `To find ${n}/${d} of ${total}: Divide ${total} ÷ ${d} = ${total/d} (one part). Multiply ${total/d} × ${n} = ${answer} red ${items}.` };
            } else if (type === "remaining") {
                // What fraction remains
                const d = pick([4, 6, 8]);
                const eaten = rand(1, d - 2);
                const remaining = d - eaten;
                const food = pick(["pizza", "pie", "cake", "sandwich"]);
                return { question: `A ${food} is cut into ${d} equal slices. ${eaten} slices are eaten. What fraction of the ${food} is left?`,
                    answer: `${remaining}/${d}`, type: "reasoning",
                    options: [`${remaining}/${d}`, `${eaten}/${d}`, `${remaining}/${eaten}`, `${d}/${remaining}`].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `Started with ${d}/${d} (whole ${food}). Eaten: ${eaten}/${d}. Remaining: ${d}/${d} - ${eaten}/${d} = ${remaining}/${d}` };
            } else if (type === "sharing") {
                // Equal sharing problem
                const items = rand(2, 4);
                const people = pick([2, 3, 4]);
                const answer = items < people ? `${items}/${people}` : (items % people === 0 ? `${items/people}` : `${Math.floor(items/people)} ${items % people}/${people}`);
                const thing = pick(["pizzas", "cakes", "pies", "sandwiches"]);
                return { question: `${items} ${thing} are shared equally among ${people} friends. How much does each friend get?`,
                    answer: items % people === 0 ? items / people : `${items}/${people}`, type: "reasoning",
                    explanation: `${items} ÷ ${people} = ${items}/${people}${items % people === 0 ? ` = ${items/people}` : ""} ${thing.slice(0, -1)} per person.` };
            } else if (type === "combining") {
                // Adding fractions in context
                const d = pick([4, 8]);
                const n1 = rand(1, d - 2);
                const n2 = rand(1, d - n1);
                const sum = n1 + n2;
                const liquid = pick(["juice", "milk", "water"]);
                return { question: `Mom pours ${n1}/${d} cup of ${liquid}. Then she adds ${n2}/${d} cup more. How much ${liquid} in total?`,
                    answer: sum === d ? "1 cup" : `${sum}/${d} cup`, type: "reasoning",
                    explanation: `${n1}/${d} + ${n2}/${d} = ${sum}/${d}${sum === d ? " = 1 whole cup" : " cup"} of ${liquid}.` };
            } else {
                // Comparing fractions in context
                const d = pick([4, 6, 8]);
                const n1 = rand(1, d - 1);
                let n2 = rand(1, d - 1);
                while (n2 === n1) n2 = rand(1, d - 1);
                const name1 = pick(["Emma", "Liam", "Olivia", "Noah"]);
                const name2 = pick(["Sophia", "Jackson", "Ava", "Lucas"]);
                const winner = n1 > n2 ? name1 : name2;
                const food = pick(["pizza", "pie", "cake"]);
                return { question: `${name1} ate ${n1}/${d} of a ${food}. ${name2} ate ${n2}/${d} of the same ${food}. Who ate more?`,
                    answer: winner, type: "reasoning",
                    options: [name1, name2, "They ate the same"],
                    explanation: `Compare numerators (same denominator): ${Math.max(n1, n2)} > ${Math.min(n1, n2)}, so ${winner} ate more (${Math.max(n1, n2)}/${d} vs ${Math.min(n1, n2)}/${d}).` };
            }
        },
        "Word Problems": () => {
            const templates = [
                () => { const a = rand(10, 30), b = rand(5, 15); return { q: `Sam has ${a} apples and buys ${b} more. How many total?`, ans: a + b, exp: `${a} + ${b} = ${a + b} apples` }; },
                () => { const a = rand(20, 50), b = rand(5, 15); return { q: `Maria has ${a} stickers and gives ${b} away. How many left?`, ans: a - b, exp: `${a} - ${b} = ${a - b} stickers` }; },
                () => { const a = rand(3, 8), b = rand(4, 10); return { q: `${a} bags with ${b} marbles each. How many total?`, ans: a * b, exp: `${a} × ${b} = ${a * b} marbles` }; }
            ];
            const t = pick(templates)();
            return { question: t.q, answer: t.ans, type: "reasoning", explanation: t.exp };
        },
        Time: () => {
            const type = pick(["read", "set", "elapsed", "convert"]);
            if (type === "read") {
                const hour = rand(1, 12);
                const min = pick([0, 15, 30, 45]);
                return {
                    question: `What time does this clock show?`,
                    answer: `${hour}:${min.toString().padStart(2, '0')}`, type: "procedural",
                    options: [`${hour}:${min.toString().padStart(2, '0')}`, `${hour}:${((min + 15) % 60).toString().padStart(2, '0')}`, `${(hour % 12) + 1}:${min.toString().padStart(2, '0')}`, `${hour}:${((min + 30) % 60).toString().padStart(2, '0')}`],
                    explanation: `The hour hand points to ${hour} and the minute hand shows ${min} minutes. Time: ${hour}:${min.toString().padStart(2, '0')}`,
                    visual: { type: 'clock', mode: 'display', data: { hour, minute: min } }
                };
            } else if (type === "set") {
                const hour = rand(1, 12);
                const min = pick([0, 15, 30, 45]);
                return {
                    question: `Set the clock to ${hour}:${min.toString().padStart(2, '0')}`,
                    answer: `${hour}:${min.toString().padStart(2, '0')}`, type: "procedural",
                    explanation: `${hour}:${min.toString().padStart(2, '0')} means the hour hand at ${hour} and minute hand at ${min === 0 ? 12 : min / 5}.`,
                    visual: { type: 'clock', mode: 'interactive', data: { hour: 12, minute: 0, target: { hour, minute: min } } }
                };
            } else if (type === "elapsed") {
                const start = rand(1, 10);
                const elapsed = pick([1, 2, 3]);
                const end = start + elapsed;
                return {
                    question: `The clock shows ${start}:00. What time will it be in ${elapsed} hour${elapsed > 1 ? 's' : ''}?`,
                    answer: `${end}:00`, type: "procedural",
                    options: [`${end}:00`, `${start + elapsed - 1}:00`, `${start}:${elapsed}0`, `${end + 1}:00`],
                    explanation: `${start}:00 + ${elapsed} hours = ${end}:00`,
                    visual: { type: 'clock', mode: 'display', data: { hour: start, minute: 0 } }
                };
            } else {
                const hours = rand(1, 3);
                const minutes = hours * 60;
                return { question: `How many minutes are in ${hours} hour${hours > 1 ? 's' : ''}?`, answer: minutes, type: "procedural",
                    explanation: `1 hour = 60 minutes. ${hours} hours = ${hours} × 60 = ${minutes} minutes` };
            }
        },
        Money: () => {
            const type = pick(["count", "add", "change"]);
            if (type === "count") {
                const quarters = rand(0, 4);
                const dimes = rand(0, 5);
                const nickels = rand(0, 4);
                const total = quarters * 25 + dimes * 10 + nickels * 5;
                return { question: `${quarters} quarter${quarters !== 1 ? 's' : ''}, ${dimes} dime${dimes !== 1 ? 's' : ''}, ${nickels} nickel${nickels !== 1 ? 's' : ''}. How many cents?`,
                    answer: total, type: "procedural",
                    explanation: `${quarters}×25¢ + ${dimes}×10¢ + ${nickels}×5¢ = ${quarters*25} + ${dimes*10} + ${nickels*5} = ${total}¢` };
            } else if (type === "add") {
                const a = rand(10, 50);
                const b = rand(10, 40);
                return { question: `$0.${a.toString().padStart(2, '0')} + $0.${b.toString().padStart(2, '0')} = ?`, answer: `$${((a + b) / 100).toFixed(2)}`, type: "procedural",
                    options: [`$${((a + b) / 100).toFixed(2)}`, `$${((a + b + 10) / 100).toFixed(2)}`, `$${((a + b - 10) / 100).toFixed(2)}`, `$${(a + b)}`],
                    explanation: `${a}¢ + ${b}¢ = ${a + b}¢ = $${((a + b) / 100).toFixed(2)}` };
            } else {
                const price = rand(1, 5) * 10;
                const paid = 100;
                const change = paid - price;
                return { question: `Item costs ${price}¢. You pay $1.00. How much change?`, answer: `${change}¢`, type: "procedural",
                    options: [`${change}¢`, `${change + 10}¢`, `${change - 10}¢`, `${price}¢`],
                    explanation: `100¢ - ${price}¢ = ${change}¢` };
            }
        },
        Rounding: () => {
            const type = pick(["tens", "hundreds"]);
            if (type === "tens") {
                const num = rand(11, 99);
                const rounded = Math.round(num / 10) * 10;
                return { question: `Round ${num} to the nearest ten.`, answer: rounded, type: "procedural",
                    explanation: `${num} is closer to ${rounded} than ${rounded < num ? rounded - 10 : rounded + 10}. Rounded: ${rounded}` };
            } else {
                const num = rand(101, 999);
                const rounded = Math.round(num / 100) * 100;
                return { question: `Round ${num} to the nearest hundred.`, answer: rounded, type: "procedural",
                    explanation: `${num} rounds to ${rounded} (look at the tens digit: ${Math.floor((num % 100) / 10)})` };
            }
        },
        Measurement: () => {
            const type = pick(["length", "compare", "estimate"]);
            if (type === "length") {
                const inches = rand(12, 36);
                const feet = Math.floor(inches / 12);
                const remainInches = inches % 12;
                return { question: `${inches} inches = ? feet and ? inches`, answer: `${feet} ft ${remainInches} in`, type: "procedural",
                    options: [`${feet} ft ${remainInches} in`, `${feet + 1} ft ${remainInches} in`, `${feet} ft ${remainInches + 1} in`, `${remainInches} ft ${feet} in`],
                    explanation: `${inches} ÷ 12 = ${feet} remainder ${remainInches}. So ${feet} feet and ${remainInches} inches.` };
            } else if (type === "compare") {
                const items = [
                    { name: "new pencil", length: "about 7 inches", article: "a" },
                    { name: "standard ruler", length: "about 1 foot", article: "a" },
                    { name: "classroom door", length: "about 7 feet", article: "a" },
                    { name: "typical car", length: "about 15 feet", article: "a" }
                ];
                const item = pick(items);
                return { question: `What is the approximate length of ${item.article} ${item.name}?`, answer: item.length, type: "conceptual",
                    options: ["about 7 inches", "about 1 foot", "about 7 feet", "about 15 feet"],
                    explanation: `A ${item.name} is typically ${item.length} long.` };
            } else {
                const cm = rand(2, 10) * 10;
                const inches = Math.round(cm / 2.54);
                return { question: `About how many inches is ${cm} centimeters? (1 inch ≈ 2.5 cm)`, answer: inches, type: "procedural",
                    explanation: `${cm} ÷ 2.5 ≈ ${inches} inches` };
            }
        },
        Estimation: () => {
            const type = pick(["round_add", "round_mult", "estimate_count"]);
            if (type === "round_add") {
                const a = rand(18, 89), b = rand(18, 89);
                const roundA = Math.round(a / 10) * 10, roundB = Math.round(b / 10) * 10;
                const estimate = roundA + roundB;
                return { question: `Estimate ${a} + ${b} by rounding to the nearest ten.`, answer: estimate, type: "procedural",
                    options: [estimate, estimate + 10, estimate - 10, a + b],
                    explanation: `${a} ≈ ${roundA}, ${b} ≈ ${roundB}. Estimate: ${roundA} + ${roundB} = ${estimate}` };
            } else if (type === "round_mult") {
                const a = rand(3, 9), b = rand(18, 52);
                const roundB = Math.round(b / 10) * 10;
                const estimate = a * roundB;
                return { question: `Estimate ${a} × ${b} by rounding ${b} to the nearest ten.`, answer: estimate, type: "procedural",
                    options: [estimate, a * b, estimate + 10, estimate - 10],
                    explanation: `${b} ≈ ${roundB}. Estimate: ${a} × ${roundB} = ${estimate}` };
            } else {
                const scenarios = [
                    { item: "jelly beans in a small jar", reasonable: 50, wrong: [5, 500, 5000] },
                    { item: "students in an elementary school", reasonable: 300, wrong: [30, 3000, 30000] },
                    { item: "pages in a chapter book", reasonable: 200, wrong: [20, 2000, 20000] },
                    { item: "apples in a grocery bag", reasonable: 8, wrong: [1, 80, 800] },
                    { item: "seats in a movie theater", reasonable: 150, wrong: [15, 1500, 15000] },
                    { item: "cars in a parking lot", reasonable: 100, wrong: [10, 1000, 10000] }
                ];
                const scenario = pick(scenarios);
                const options = [scenario.reasonable, ...scenario.wrong].sort(() => Math.random() - 0.5);
                return { question: `About how many ${scenario.item} would there be? Pick the most reasonable estimate.`, answer: scenario.reasonable, type: "reasoning",
                    options: options,
                    explanation: `${scenario.reasonable} is the most reasonable estimate. ${scenario.wrong[0]} is too few, and ${scenario.wrong[1]} or ${scenario.wrong[2]} would be way too many.` };
            }
        },
        Perimeter: () => {
            const type = pick(["rectangle", "square", "triangle"]);
            if (type === "rectangle") {
                const length = rand(5, 15), width = rand(3, 10);
                const perimeter = 2 * (length + width);
                return {
                    question: `Find the perimeter of this rectangle.`,
                    answer: perimeter, type: "procedural",
                    explanation: `Perimeter = 2 × (length + width) = 2 × (${length} + ${width}) = ${perimeter}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'rectangle', dimensions: { width: length, height: width }, showMeasurements: true } }
                };
            } else if (type === "square") {
                const side = rand(4, 12);
                const perimeter = 4 * side;
                return {
                    question: `Find the perimeter of this square.`,
                    answer: perimeter, type: "procedural",
                    explanation: `Perimeter = 4 × side = 4 × ${side} = ${perimeter}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'square', dimensions: { side }, showMeasurements: true } }
                };
            } else {
                const a = rand(4, 8);
                const b = rand(4, 8);
                const minC = Math.abs(a - b) + 1;
                const maxC = Math.min(a + b - 1, 10);
                const c = rand(minC, maxC);
                const perimeter = a + b + c;
                return {
                    question: `Find the perimeter of this triangle with sides ${a}, ${b}, and ${c}.`,
                    answer: perimeter, type: "procedural",
                    explanation: `Perimeter = ${a} + ${b} + ${c} = ${perimeter}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'triangle', dimensions: { base: a, height: b }, showMeasurements: true } }
                };
            }
        },
        "Arrays and Area Models": () => {
            const type = pick(["array", "area_model"]);
            if (type === "array") {
                const rows = rand(2, 6), cols = rand(3, 8);
                const total = rows * cols;
                return { question: `An array has ${rows} rows and ${cols} columns. How many total?`, answer: total, type: "conceptual",
                    explanation: `Arrays show multiplication: ${rows} rows × ${cols} columns = ${total}` };
            } else {
                const tens = rand(1, 3) * 10, ones = rand(2, 8);
                const mult = rand(2, 5);
                const total = (tens + ones) * mult;
                return { question: `Use area model: ${tens + ones} × ${mult} = (${tens} × ${mult}) + (${ones} × ${mult}) = ?`, answer: total, type: "procedural",
                    explanation: `Break apart: ${tens} × ${mult} = ${tens * mult}, ${ones} × ${mult} = ${ones * mult}. Total: ${tens * mult} + ${ones * mult} = ${total}` };
            }
        },
        "Factors and Multiples": () => {
            const type = pick(["find_factors", "is_factor", "find_multiples", "is_multiple", "common_factors"]);
            if (type === "find_factors") {
                const nums = [12, 18, 24, 20, 16, 30, 36];
                const n = pick(nums);
                const factors = [];
                for (let i = 1; i <= n; i++) { if (n % i === 0) factors.push(i); }
                const askFor = pick(["smallest", "largest", "count"]);
                if (askFor === "smallest") {
                    return { question: `What is the smallest factor of ${n} (other than 1)?`, answer: factors[1], type: "procedural",
                        options: [factors[1], factors[2] || 3, n, 1],
                        explanation: `Factors of ${n}: ${factors.join(", ")}. The smallest (other than 1) is ${factors[1]}.` };
                } else if (askFor === "largest") {
                    return { question: `What is the largest factor of ${n}?`, answer: n, type: "conceptual",
                        options: [n, n/2, factors[factors.length-2], factors[1]],
                        explanation: `The largest factor of any number is the number itself. ${n} ÷ ${n} = 1 ✓` };
                } else {
                    return { question: `How many factors does ${n} have?`, answer: factors.length, type: "procedural",
                        explanation: `Factors of ${n}: ${factors.join(", ")}. Count: ${factors.length} factors.` };
                }
            } else if (type === "is_factor") {
                const n = pick([12, 15, 18, 20, 24, 30]);
                const testNum = pick([2, 3, 4, 5, 6, 7]);
                const isFactor = n % testNum === 0;
                return { question: `Is ${testNum} a factor of ${n}?`, answer: isFactor ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isFactor ? `Yes! ${n} ÷ ${testNum} = ${n/testNum} with no remainder.` : `No. ${n} ÷ ${testNum} = ${Math.floor(n/testNum)} R ${n % testNum}.` };
            } else if (type === "find_multiples") {
                const n = pick([2, 3, 4, 5, 6, 7, 8, 9]);
                const multiples = [n, n*2, n*3, n*4, n*5];
                const position = pick([3, 4, 5]);
                return { question: `What is the ${position === 3 ? "3rd" : position === 4 ? "4th" : "5th"} multiple of ${n}?`, answer: n * position, type: "procedural",
                    options: [n * position, n * (position - 1), n * (position + 1), n + position],
                    explanation: `Multiples of ${n}: ${multiples.join(", ")}... The ${position === 3 ? "3rd" : position === 4 ? "4th" : "5th"} is ${n * position}.` };
            } else if (type === "is_multiple") {
                const n = pick([3, 4, 5, 6]);
                const mult = n * rand(2, 8);
                const testNum = pick([mult, mult + 1, mult - 1]);
                const isMultiple = testNum % n === 0;
                return { question: `Is ${testNum} a multiple of ${n}?`, answer: isMultiple ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isMultiple ? `Yes! ${testNum} ÷ ${n} = ${testNum/n} exactly.` : `No. ${testNum} ÷ ${n} = ${Math.floor(testNum/n)} R ${testNum % n}.` };
            } else {
                const pairs = [[12, 18], [8, 12], [15, 20], [10, 15]];
                const [a, b] = pick(pairs);
                const commonFactors = [];
                for (let i = 1; i <= Math.min(a, b); i++) { if (a % i === 0 && b % i === 0) commonFactors.push(i); }
                return { question: `What is the greatest common factor of ${a} and ${b}?`, answer: commonFactors[commonFactors.length - 1], type: "procedural",
                    options: shuffle([commonFactors[commonFactors.length - 1], commonFactors[0], a, b]).slice(0, 4),
                    explanation: `Common factors of ${a} and ${b}: ${commonFactors.join(", ")}. GCF = ${commonFactors[commonFactors.length - 1]}` };
            }
        },
        "Prime and Composite": () => {
            const type = pick(["identify", "classify", "find_primes", "prime_factors"]);
            const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31];
            const composites = [4, 6, 8, 9, 10, 12, 14, 15, 16, 18, 20, 21, 22, 24, 25, 26, 27, 28];
            if (type === "identify") {
                const isPrime = pick([true, false]);
                const n = isPrime ? pick(primes.slice(0, 8)) : pick(composites.slice(0, 10));
                return { question: `Is ${n} prime or composite?`, answer: isPrime ? "Prime" : "Composite", type: "conceptual",
                    options: ["Prime", "Composite"],
                    explanation: isPrime ? `${n} is prime (only divisible by 1 and itself).` : `${n} is composite (has factors other than 1 and ${n}).` };
            } else if (type === "classify") {
                const n = pick([...primes.slice(0, 6), ...composites.slice(0, 6)]);
                const isPrime = primes.includes(n);
                const factors = [];
                for (let i = 1; i <= n; i++) { if (n % i === 0) factors.push(i); }
                return { question: `${n} has factors: ${factors.join(", ")}. Is it prime or composite?`, answer: isPrime ? "Prime" : "Composite", type: "reasoning",
                    options: ["Prime", "Composite"],
                    explanation: isPrime ? `Only 2 factors (1 and ${n}) = Prime` : `More than 2 factors = Composite` };
            } else if (type === "find_primes") {
                const start = pick([1, 10, 20]);
                const end = start + 10;
                const primesInRange = primes.filter(p => p > start && p <= end);
                return { question: `How many prime numbers are there from ${start + 1} to ${end}?`, answer: primesInRange.length, type: "procedural",
                    options: [primesInRange.length, primesInRange.length + 1, primesInRange.length - 1, primesInRange.length + 2].filter(n => n >= 0),
                    explanation: `Primes from ${start + 1} to ${end}: ${primesInRange.join(", ")}. Count: ${primesInRange.length}` };
            } else {
                const n = pick([12, 18, 20, 24, 30]);
                const primeFactorsList = {
                    12: "2 × 2 × 3", 18: "2 × 3 × 3", 20: "2 × 2 × 5", 24: "2 × 2 × 2 × 3", 30: "2 × 3 × 5"
                };
                const smallestPrime = n % 2 === 0 ? 2 : 3;
                return { question: `What is the smallest prime factor of ${n}?`, answer: smallestPrime, type: "procedural",
                    options: [2, 3, 5, 7],
                    explanation: `${n} = ${primeFactorsList[n]}. Smallest prime factor is ${smallestPrime}.` };
            }
        },
        "Area": () => {
            const type = pick(["rectangle", "square", "find_side", "word_problem"]);
            if (type === "rectangle") {
                const length = rand(3, 12);
                const width = rand(2, 8);
                const area = length * width;
                return {
                    question: `Find the area of this rectangle.`,
                    answer: area, type: "procedural",
                    explanation: `Area = length × width = ${length} × ${width} = ${area} square units`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'rectangle', dimensions: { width: length, height: width }, showMeasurements: true } }
                };
            } else if (type === "square") {
                const side = rand(2, 10);
                const area = side * side;
                return {
                    question: `Find the area of this square.`,
                    answer: area, type: "procedural",
                    explanation: `Area = side × side = ${side} × ${side} = ${area} square units`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'square', dimensions: { side }, showMeasurements: true } }
                };
            } else if (type === "find_side") {
                const side = rand(3, 8);
                const area = side * side;
                return {
                    question: `This square has an area of ${area} square units. What is the side length?`,
                    answer: side, type: "reasoning",
                    options: [side, side + 1, side - 1, area / 2],
                    explanation: `If area = side × side = ${area}, then side = √${area} = ${side}`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'square', dimensions: { side }, showMeasurements: false, shaded: true } }
                };
            } else {
                const length = rand(5, 15);
                const width = rand(4, 10);
                const area = length * width;
                const context = pick(["garden", "room", "rug", "poster"]);
                return {
                    question: `A ${context} is ${length} feet long and ${width} feet wide. What is its area?`,
                    answer: area, type: "reasoning",
                    explanation: `Area = ${length} × ${width} = ${area} square feet`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'rectangle', dimensions: { width: length, height: width }, showMeasurements: true } }
                };
            }
        },
        "Bar Graphs": () => {
            const type = pick(["read", "compare", "total", "difference"]);
            const data = {
                labels: ["Mon", "Tue", "Wed", "Thu", "Fri"],
                values: [rand(2, 8), rand(2, 8), rand(2, 8), rand(2, 8), rand(2, 8)]
            };
            const visual = { type: 'chart', mode: 'display', data: { type: 'bar', labels: data.labels, values: data.values } };
            if (type === "read") {
                const idx = rand(0, 4);
                return {
                    question: `This bar graph shows books read each day. How many books on ${data.labels[idx]}?`,
                    answer: data.values[idx], type: "procedural",
                    explanation: `Reading the bar for ${data.labels[idx]}: ${data.values[idx]} books.`,
                    visual
                };
            } else if (type === "compare") {
                const maxVal = Math.max(...data.values);
                const maxIdx = data.values.indexOf(maxVal);
                return {
                    question: `Look at the bar graph. Which day had the most books read?`,
                    answer: data.labels[maxIdx], type: "conceptual",
                    options: data.labels,
                    explanation: `${data.labels[maxIdx]} had the most with ${maxVal}.`,
                    visual
                };
            } else if (type === "total") {
                const total = data.values.reduce((a, b) => a + b, 0);
                return {
                    question: `Look at the bar graph. What is the total number of books read?`,
                    answer: total, type: "procedural",
                    explanation: `Total = ${data.values.join(" + ")} = ${total}`,
                    visual
                };
            } else {
                const maxVal = Math.max(...data.values);
                const minVal = Math.min(...data.values);
                return {
                    question: `Using the bar graph, what is the difference between the highest and lowest days?`,
                    answer: maxVal - minVal, type: "procedural",
                    explanation: `Highest: ${maxVal}, Lowest: ${minVal}. Difference: ${maxVal} - ${minVal} = ${maxVal - minVal}`,
                    visual
                };
            }
        },
        "Line Plots": () => {
            const type = pick(["read", "count", "most_common", "range"]);
            const values = [2, 2, 3, 3, 3, 4, 4, 5];
            const display = "Shoe sizes: X on 2, X on 2, X on 3, X on 3, X on 3, X on 4, X on 4, X on 5";
            if (type === "read") {
                const target = pick([2, 3, 4, 5]);
                const count = values.filter(v => v === target).length;
                return { question: `Line plot shows shoe sizes: 2(XX), 3(XXX), 4(XX), 5(X). How many students have size ${target}?`, answer: count, type: "procedural",
                    explanation: `Count the X's above ${target}: ${count} students.` };
            } else if (type === "count") {
                return { question: `Line plot: 2(XX), 3(XXX), 4(XX), 5(X). How many students in all?`, answer: values.length, type: "procedural",
                    explanation: `Total X's: 2 + 3 + 2 + 1 = ${values.length} students.` };
            } else if (type === "most_common") {
                return { question: `Line plot: 2(XX), 3(XXX), 4(XX), 5(X). What is the most common shoe size?`, answer: 3, type: "conceptual",
                    options: [2, 3, 4, 5],
                    explanation: `Size 3 has the most X's (3), so it's most common.` };
            } else {
                const min = Math.min(...values);
                const max = Math.max(...values);
                return { question: `Line plot: 2(XX), 3(XXX), 4(XX), 5(X). What is the range of shoe sizes?`, answer: max - min, type: "procedural",
                    explanation: `Range = largest - smallest = ${max} - ${min} = ${max - min}` };
            }
        },
        "Line Symmetry": () => {
            const type = pick(["identify", "count_lines", "draw", "real_world"]);
            const symmetricShapes = [
                { name: "square", lines: 4 },
                { name: "rectangle", lines: 2 },
                { name: "equilateral triangle", lines: 3 },
                { name: "circle", lines: "infinite" },
                { name: "regular hexagon", lines: 6 },
                { name: "isosceles triangle", lines: 1 }
            ];
            const asymmetricShapes = ["scalene triangle", "parallelogram", "trapezoid"];
            if (type === "identify") {
                const isSymmetric = pick([true, false]);
                const shape = isSymmetric ? pick(symmetricShapes).name : pick(asymmetricShapes);
                return { question: `Does a ${shape} have line symmetry?`, answer: isSymmetric ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: isSymmetric ? `Yes! A ${shape} can be folded so both halves match.` : `No. A ${shape} cannot be folded into matching halves.` };
            } else if (type === "count_lines") {
                const shape = pick(symmetricShapes.filter(s => typeof s.lines === "number"));
                return { question: `How many lines of symmetry does a ${shape.name} have?`, answer: shape.lines, type: "conceptual",
                    options: [shape.lines, shape.lines + 1, shape.lines - 1, 0].filter(n => n >= 0),
                    explanation: `A ${shape.name} has ${shape.lines} line(s) of symmetry.` };
            } else if (type === "draw") {
                const options = ["vertical", "horizontal", "diagonal", "no line"];
                const shape = pick(["heart", "butterfly", "letter A", "arrow pointing up"]);
                return { question: `Where is the line of symmetry for a ${shape}?`, answer: "vertical", type: "conceptual",
                    options: options,
                    explanation: `A ${shape} has a vertical line of symmetry (down the middle).` };
            } else {
                const items = [
                    { name: "butterfly", symmetric: true },
                    { name: "human face", symmetric: true },
                    { name: "leaf", symmetric: true },
                    { name: "hand", symmetric: false },
                    { name: "starfish", symmetric: true }
                ];
                const item = pick(items);
                return { question: `Does a ${item.name} have line symmetry in nature?`, answer: item.symmetric ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: item.symmetric ? `Yes! A ${item.name} is approximately symmetric.` : `No. A ${item.name} is not symmetric.` };
            }
        },
        "Types of Angles": () => {
            const type = pick(["identify", "measure", "compare", "classify"]);
            if (type === "identify") {
                const angles = [
                    { name: "acute", range: "less than 90°", example: 45 },
                    { name: "right", range: "exactly 90°", example: 90 },
                    { name: "obtuse", range: "between 90° and 180°", example: 120 }
                ];
                const angle = pick(angles);
                return {
                    question: `This shape shows an angle. What type is it?`,
                    answer: angle.name, type: "conceptual",
                    options: angles.map(a => a.name),
                    explanation: `${angle.example}° is ${angle.range}, so it's ${angle.name}.`,
                    visual: { type: 'shape', mode: 'display', data: { shape: 'triangle', dimensions: { base: 80, height: 60, isRight: angle.name === 'right' }, showAngles: true } }
                };
            } else if (type === "measure") {
                const angles = [30, 45, 60, 90, 120, 135, 150];
                const angle = pick(angles);
                const angleType = angle < 90 ? "acute" : angle === 90 ? "right" : "obtuse";
                return { question: `What type of angle measures ${angle}°?`, answer: angleType, type: "conceptual",
                    options: ["acute", "right", "obtuse", "straight"],
                    explanation: `${angle}° is ${angleType} because it's ${angle < 90 ? "less than" : angle === 90 ? "exactly" : "greater than"} 90°.` };
            } else if (type === "compare") {
                const angle1 = rand(20, 80);
                const angle2 = rand(100, 160);
                return { question: `Which is larger: a ${angle1}° angle or a ${angle2}° angle?`, answer: `${angle2}°`, type: "conceptual",
                    options: [`${angle1}°`, `${angle2}°`],
                    explanation: `${angle2}° > ${angle1}°. The obtuse angle is larger than the acute angle.` };
            } else {
                const cornerType = pick(["book", "door", "slice of pizza", "clock at 3:00"]);
                const isRight = cornerType === "book" || cornerType === "door" || cornerType === "clock at 3:00";
                return { question: `The corner of a ${cornerType} is most likely what type of angle?`, answer: isRight ? "right" : "acute", type: "reasoning",
                    options: ["acute", "right", "obtuse"],
                    explanation: isRight ? `A ${cornerType} typically has a right angle (90°).` : `A ${cornerType} typically has an acute angle (less than 90°).` };
            }
        },
        "Types of Lines": () => {
            const type = pick(["identify", "parallel", "perpendicular", "intersecting", "real_world"]);
            if (type === "identify") {
                const lineTypes = [
                    { name: "parallel", desc: "lines that never meet" },
                    { name: "perpendicular", desc: "lines that meet at a 90° angle" },
                    { name: "intersecting", desc: "lines that cross at any angle" }
                ];
                const line = pick(lineTypes);
                return { question: `Lines that ${line.desc.replace("lines that ", "")} are called...?`, answer: line.name, type: "conceptual",
                    options: lineTypes.map(l => l.name),
                    explanation: `${line.name.charAt(0).toUpperCase() + line.name.slice(1)} lines: ${line.desc}.` };
            } else if (type === "parallel") {
                const examples = [
                    { item: "railroad tracks", isParallel: true },
                    { item: "opposite sides of a rectangle", isParallel: true },
                    { item: "the letter X", isParallel: false },
                    { item: "rungs on a ladder", isParallel: true }
                ];
                const ex = pick(examples);
                return { question: `Are the lines in "${ex.item}" parallel?`, answer: ex.isParallel ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: ex.isParallel ? `Yes! ${ex.item} shows parallel lines (never meet).` : `No. ${ex.item} shows lines that cross.` };
            } else if (type === "perpendicular") {
                const examples = [
                    { item: "corner of a paper", isPerpendicular: true },
                    { item: "plus sign (+)", isPerpendicular: true },
                    { item: "letter V", isPerpendicular: false },
                    { item: "floor and wall meeting", isPerpendicular: true }
                ];
                const ex = pick(examples);
                return { question: `Do the lines in "${ex.item}" form perpendicular lines?`, answer: ex.isPerpendicular ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: ex.isPerpendicular ? `Yes! They meet at a 90° angle.` : `No. They don't meet at a right angle.` };
            } else if (type === "intersecting") {
                return { question: `When two lines cross at a point, they are called...?`, answer: "intersecting", type: "conceptual",
                    options: ["parallel", "perpendicular", "intersecting", "skew"],
                    explanation: `Lines that cross are intersecting lines. They share one point.` };
            } else {
                const items = [
                    { name: "opposite edges of a door", type: "parallel" },
                    { name: "hands of a clock at 3:00", type: "perpendicular" },
                    { name: "scissors blades", type: "intersecting" },
                    { name: "lines on notebook paper", type: "parallel" }
                ];
                const item = pick(items);
                return { question: `The ${item.name} are an example of what type of lines?`, answer: item.type, type: "reasoning",
                    options: ["parallel", "perpendicular", "intersecting"],
                    explanation: `${item.name} are ${item.type} lines.` };
            }
        },
        "Mass and Capacity": () => {
            const type = pick(["compare_mass", "compare_capacity", "units", "estimate", "convert"]);
            if (type === "compare_mass") {
                const items = [
                    { name: "feather", mass: "light" },
                    { name: "brick", mass: "heavy" },
                    { name: "apple", mass: "medium" },
                    { name: "elephant", mass: "very heavy" },
                    { name: "paperclip", mass: "light" }
                ];
                const item1 = pick(items);
                let item2 = pick(items);
                while (item2.name === item1.name) item2 = pick(items);
                const massOrder = { "light": 1, "medium": 2, "heavy": 3, "very heavy": 4 };
                const heavier = massOrder[item1.mass] > massOrder[item2.mass] ? item1.name : item2.name;
                return { question: `Which is heavier: a ${item1.name} or a ${item2.name}?`, answer: heavier, type: "conceptual",
                    options: [item1.name, item2.name, "Same"],
                    explanation: `A ${heavier} is heavier.` };
            } else if (type === "compare_capacity") {
                const containers = [
                    { name: "teaspoon", capacity: 1 },
                    { name: "cup", capacity: 2 },
                    { name: "bottle", capacity: 3 },
                    { name: "bucket", capacity: 4 },
                    { name: "bathtub", capacity: 5 }
                ];
                const c1 = pick(containers);
                let c2 = pick(containers);
                while (c2.name === c1.name) c2 = pick(containers);
                const more = c1.capacity > c2.capacity ? c1.name : c2.name;
                return { question: `Which holds more: a ${c1.name} or a ${c2.name}?`, answer: more, type: "conceptual",
                    options: [c1.name, c2.name, "Same"],
                    explanation: `A ${more} holds more liquid.` };
            } else if (type === "units") {
                const units = [
                    { unit: "gram", measures: "mass", abbrev: "g" },
                    { unit: "kilogram", measures: "mass", abbrev: "kg" },
                    { unit: "liter", measures: "capacity", abbrev: "L" },
                    { unit: "milliliter", measures: "capacity", abbrev: "mL" }
                ];
                const u = pick(units);
                return { question: `A ${u.unit} (${u.abbrev}) measures...?`, answer: u.measures, type: "conceptual",
                    options: ["mass", "capacity", "length", "time"],
                    explanation: `${u.unit}s measure ${u.measures}.` };
            } else if (type === "estimate") {
                const estimates = [
                    { item: "paperclip", value: "1 gram", unit: "mass" },
                    { item: "textbook", value: "1 kilogram", unit: "mass" },
                    { item: "water bottle", value: "500 milliliters", unit: "capacity" },
                    { item: "fish tank", value: "40 liters", unit: "capacity" }
                ];
                const est = pick(estimates);
                return { question: `About how much ${est.unit} does a ${est.item} have?`, answer: est.value, type: "reasoning",
                    options: ["1 gram", "1 kilogram", "500 milliliters", "40 liters"],
                    explanation: `A ${est.item} is about ${est.value}.` };
            } else {
                const kg = rand(1, 5);
                const g = kg * 1000;
                return { question: `${kg} kilogram${kg > 1 ? "s" : ""} = ? grams`, answer: g, type: "procedural",
                    explanation: `1 kg = 1000 g, so ${kg} kg = ${kg} × 1000 = ${g} grams.` };
            }
        },
        "Elapsed Time": () => {
            const type = pick(["forward_hours", "forward_minutes", "backward", "word_problem", "duration"]);
            if (type === "forward_hours") {
                const startHour = rand(1, 10);
                const elapsed = rand(1, 3);
                const endHour = startHour + elapsed;
                return { question: `It is ${startHour}:00. What time will it be in ${elapsed} hour${elapsed > 1 ? "s" : ""}?`, answer: `${endHour}:00`, type: "procedural",
                    options: [`${endHour}:00`, `${endHour - 1}:00`, `${startHour}:${elapsed}0`, `${endHour + 1}:00`],
                    explanation: `${startHour}:00 + ${elapsed} hours = ${endHour}:00` };
            } else if (type === "forward_minutes") {
                const startHour = rand(1, 11);
                const startMin = pick([0, 15, 30]);
                const elapsed = pick([15, 30, 45]);
                const totalMin = startMin + elapsed;
                const endHour = startHour + Math.floor(totalMin / 60);
                const endMin = totalMin % 60;
                return { question: `It is ${startHour}:${startMin.toString().padStart(2, '0')}. What time will it be in ${elapsed} minutes?`,
                    answer: `${endHour}:${endMin.toString().padStart(2, '0')}`, type: "procedural",
                    explanation: `${startHour}:${startMin.toString().padStart(2, '0')} + ${elapsed} min = ${endHour}:${endMin.toString().padStart(2, '0')}` };
            } else if (type === "backward") {
                const endHour = rand(3, 12);
                const elapsed = rand(1, 2);
                const startHour = endHour - elapsed;
                return { question: `It is ${endHour}:00 now. What time was it ${elapsed} hour${elapsed > 1 ? "s" : ""} ago?`, answer: `${startHour}:00`, type: "procedural",
                    explanation: `${endHour}:00 - ${elapsed} hours = ${startHour}:00` };
            } else if (type === "word_problem") {
                const startHour = rand(8, 11);
                const duration = rand(1, 3);
                const endHour = startHour + duration;
                const activity = pick(["movie", "soccer game", "class", "car trip"]);
                return { question: `The ${activity} starts at ${startHour}:00 and lasts ${duration} hour${duration > 1 ? "s" : ""}. What time does it end?`,
                    answer: `${endHour}:00`, type: "reasoning",
                    explanation: `${startHour}:00 + ${duration} hours = ${endHour}:00` };
            } else {
                const startHour = rand(9, 12);
                const endHour = startHour + rand(1, 3);
                const duration = endHour - startHour;
                return { question: `School starts at ${startHour}:00 and ends at ${endHour}:00. How long is school?`, answer: `${duration} hours`, type: "procedural",
                    options: [`${duration} hours`, `${duration + 1} hours`, `${duration - 1} hours`, `${endHour} hours`],
                    explanation: `From ${startHour}:00 to ${endHour}:00 is ${duration} hours.` };
            }
        },
        "Multiplication Properties": () => {
            const type = pick(["commutative", "associative", "distributive", "identity", "zero"]);
            if (type === "commutative") {
                const a = rand(2, 9), b = rand(2, 9);
                return { question: `If ${a} × ${b} = ${a * b}, what is ${b} × ${a}?`, answer: a * b, type: "conceptual",
                    explanation: `Commutative Property: ${a} × ${b} = ${b} × ${a} = ${a * b}. Order doesn't matter!` };
            } else if (type === "associative") {
                const a = rand(2, 5), b = rand(2, 5), c = rand(2, 5);
                return { question: `(${a} × ${b}) × ${c} = ${a} × (${b} × ${c}) = ?`, answer: a * b * c, type: "conceptual",
                    explanation: `Associative Property: (${a} × ${b}) × ${c} = ${a * b} × ${c} = ${a * b * c}. Grouping doesn't matter!` };
            } else if (type === "distributive") {
                const a = rand(2, 5), b = rand(3, 7), c = rand(2, 5);
                const sum = b + c;
                return { question: `Use distributive property: ${a} × ${sum} = ${a} × ${b} + ${a} × ${c} = ?`, answer: a * sum, type: "procedural",
                    explanation: `${a} × ${sum} = ${a} × ${b} + ${a} × ${c} = ${a * b} + ${a * c} = ${a * sum}` };
            } else if (type === "identity") {
                const n = rand(5, 50);
                return { question: `${n} × 1 = ?`, answer: n, type: "conceptual",
                    explanation: `Identity Property: Any number × 1 = itself. ${n} × 1 = ${n}` };
            } else {
                const n = rand(5, 100);
                return { question: `${n} × 0 = ?`, answer: 0, type: "conceptual",
                    explanation: `Zero Property: Any number × 0 = 0. ${n} × 0 = 0` };
            }
        }
    },

    // TIER 3: Rational Numbers (5-7)
    3: {
        Fractions: () => {
            const type = pick(["add_diff_denom", "subtract_diff_denom", "multiply", "divide", "mixed_add", "mixed_subtract", "lcd_find"]);

            // Helper to find LCD
            const findLCD = (d1, d2) => {
                const max = d1 * d2;
                for (let i = Math.max(d1, d2); i <= max; i++) {
                    if (i % d1 === 0 && i % d2 === 0) return i;
                }
                return max;
            };

            if (type === "add_diff_denom") {
                // Adding fractions with different denominators
                const denoms = [[2, 3], [2, 4], [3, 4], [2, 5], [3, 6], [4, 6], [2, 6], [3, 5]];
                const [d1, d2] = pick(denoms);
                const n1 = rand(1, d1 - 1), n2 = rand(1, d2 - 1);
                const lcd = findLCD(d1, d2);
                const newN1 = n1 * (lcd / d1), newN2 = n2 * (lcd / d2);
                const sumN = newN1 + newN2;
                const [simpN, simpD] = simplifyFrac(sumN, lcd);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                return { question: `What is ${n1}/${d1} + ${n2}/${d2}?`, answer: answer, type: "procedural",
                    explanation: `Find LCD of ${d1} and ${d2} = ${lcd}. Convert: ${n1}/${d1} = ${newN1}/${lcd}, ${n2}/${d2} = ${newN2}/${lcd}. Add: ${newN1}/${lcd} + ${newN2}/${lcd} = ${sumN}/${lcd}${simpD !== lcd ? ` = ${answer}` : ""}` };
            } else if (type === "subtract_diff_denom") {
                // Subtracting fractions with different denominators
                const denoms = [[2, 3], [2, 4], [3, 4], [2, 5], [3, 6], [4, 6]];
                const [d1, d2] = pick(denoms);
                const lcd = findLCD(d1, d2);
                // Ensure first fraction is larger
                let n1 = rand(Math.ceil(d1 / 2), d1 - 1), n2 = rand(1, Math.floor(d2 / 2));
                const newN1 = n1 * (lcd / d1), newN2 = n2 * (lcd / d2);
                if (newN1 <= newN2) { n1 = d1 - 1; }
                const finalN1 = n1 * (lcd / d1), finalN2 = n2 * (lcd / d2);
                const diffN = finalN1 - finalN2;
                const [simpN, simpD] = simplifyFrac(diffN, lcd);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                return { question: `What is ${n1}/${d1} - ${n2}/${d2}?`, answer: answer, type: "procedural",
                    explanation: `Find LCD of ${d1} and ${d2} = ${lcd}. Convert: ${n1}/${d1} = ${finalN1}/${lcd}, ${n2}/${d2} = ${finalN2}/${lcd}. Subtract: ${finalN1}/${lcd} - ${finalN2}/${lcd} = ${diffN}/${lcd}${simpD !== lcd ? ` = ${answer}` : ""}` };
            } else if (type === "multiply") {
                // Multiplying fractions (different fractions)
                const n1 = rand(1, 4), d1 = rand(n1 + 1, 6);
                const n2 = rand(1, 4), d2 = rand(n2 + 1, 6);
                const prodN = n1 * n2, prodD = d1 * d2;
                const [simpN, simpD] = simplifyFrac(prodN, prodD);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                return { question: `What is ${n1}/${d1} × ${n2}/${d2}?`, answer: answer, type: "procedural",
                    explanation: `Multiply numerators: ${n1} × ${n2} = ${prodN}. Multiply denominators: ${d1} × ${d2} = ${prodD}. Result: ${prodN}/${prodD}${simpN !== prodN || simpD !== prodD ? ` = ${answer} (simplified)` : ""}` };
            } else if (type === "divide") {
                // Dividing fractions (keep, change, flip)
                const n1 = rand(1, 4), d1 = rand(2, 5);
                const n2 = rand(1, 3), d2 = rand(2, 5);
                const prodN = n1 * d2, prodD = d1 * n2;
                const [simpN, simpD] = simplifyFrac(prodN, prodD);
                const answer = simpD === 1 ? `${simpN}` : `${simpN}/${simpD}`;
                return { question: `What is ${n1}/${d1} ÷ ${n2}/${d2}?`, answer: answer, type: "procedural",
                    explanation: `Keep ${n1}/${d1}, change ÷ to ×, flip ${n2}/${d2} to ${d2}/${n2}. Then multiply: ${n1}/${d1} × ${d2}/${n2} = ${prodN}/${prodD}${simpN !== prodN || simpD !== prodD ? ` = ${answer}` : ""}` };
            } else if (type === "mixed_add") {
                // Adding mixed numbers
                const w1 = rand(1, 3), w2 = rand(1, 3);
                const d = pick([2, 3, 4, 5]);
                const n1 = rand(1, d - 1), n2 = rand(1, d - 1);
                const totalFrac = n1 + n2;
                const extraWhole = Math.floor(totalFrac / d);
                const remainFrac = totalFrac % d;
                const totalWhole = w1 + w2 + extraWhole;
                const answer = remainFrac === 0 ? `${totalWhole}` : `${totalWhole} ${remainFrac}/${d}`;
                return { question: `What is ${w1} ${n1}/${d} + ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                    explanation: `Add whole numbers: ${w1} + ${w2} = ${w1 + w2}. Add fractions: ${n1}/${d} + ${n2}/${d} = ${totalFrac}/${d}${extraWhole > 0 ? ` = ${extraWhole} ${remainFrac}/${d}` : ""}. Total: ${answer}` };
            } else if (type === "mixed_subtract") {
                // Subtracting mixed numbers
                const w1 = rand(3, 5), w2 = rand(1, w1 - 1);
                const d = pick([2, 3, 4, 5]);
                const n1 = rand(1, d - 1);
                let n2 = rand(1, d - 1);
                // Handle borrowing case sometimes
                if (n2 > n1 && pick([true, false])) {
                    // Need to borrow
                    const borrowed = d + n1 - n2;
                    const newW1 = w1 - 1;
                    const resultW = newW1 - w2;
                    const answer = borrowed === 0 ? `${resultW}` : `${resultW} ${borrowed}/${d}`;
                    return { question: `What is ${w1} ${n1}/${d} - ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                        explanation: `Since ${n1}/${d} < ${n2}/${d}, borrow 1 from ${w1}: ${w1} ${n1}/${d} = ${newW1} ${d + n1}/${d}. Then subtract: ${newW1} - ${w2} = ${resultW}, ${d + n1}/${d} - ${n2}/${d} = ${borrowed}/${d}. Answer: ${answer}` };
                } else {
                    if (n2 > n1) n2 = n1 - 1 > 0 ? n1 - 1 : 1;
                    const resultW = w1 - w2;
                    const resultN = n1 - n2;
                    const answer = resultN === 0 ? `${resultW}` : `${resultW} ${resultN}/${d}`;
                    return { question: `What is ${w1} ${n1}/${d} - ${w2} ${n2}/${d}?`, answer: answer, type: "procedural",
                        explanation: `Subtract whole numbers: ${w1} - ${w2} = ${resultW}. Subtract fractions: ${n1}/${d} - ${n2}/${d} = ${resultN}/${d}. Answer: ${answer}` };
                }
            } else {
                // Find the LCD
                const denoms = [[2, 3, 6], [2, 4, 4], [3, 4, 12], [2, 5, 10], [3, 6, 6], [4, 6, 12], [2, 8, 8], [3, 9, 9]];
                const [d1, d2, lcd] = pick(denoms);
                return { question: `What is the LCD (Least Common Denominator) of ${d1} and ${d2}?`, answer: lcd, type: "procedural",
                    options: [lcd, d1 * d2, Math.max(d1, d2), lcd + d1],
                    explanation: `The LCD is the smallest number that both ${d1} and ${d2} divide into evenly. ${lcd} ÷ ${d1} = ${lcd/d1} ✓, ${lcd} ÷ ${d2} = ${lcd/d2} ✓. LCD = ${lcd}` };
            }
        },
        Decimals: () => {
            const a = (rand(10, 99) / 10).toFixed(1), b = (rand(10, 99) / 10).toFixed(1);
            const op = pick(["+", "-", "×"]);
            let answer;
            if (op === "+") answer = (parseFloat(a) + parseFloat(b)).toFixed(2);
            else if (op === "-") { const big = Math.max(a, b), sm = Math.min(a, b); answer = (big - sm).toFixed(2); return { question: `What is ${big} - ${sm}?`, answer: parseFloat(answer), type: "procedural", explanation: `${big} - ${sm} = ${answer}` }; }
            else answer = (parseFloat(a) * parseFloat(b)).toFixed(2);
            return { question: `What is ${a} ${op} ${b}?`, answer: parseFloat(answer), type: "procedural",
                explanation: `${a} ${op} ${b} = ${answer}` };
        },
        Integers: () => {
            const a = rand(-15, 15), b = rand(-15, 15);
            const op = pick(["+", "-", "×"]);
            let answer;
            if (op === "+") answer = a + b;
            else if (op === "-") answer = a - b;
            else answer = a * b;
            const aStr = a < 0 ? `(${a})` : a;
            const bStr = b < 0 ? `(${b})` : b;
            return { question: `What is ${aStr} ${op} ${bStr}?`, answer, type: "procedural",
                explanation: `${aStr} ${op} ${bStr} = ${answer}` };
        },
        Percents: () => {
            const pct = pick([10, 20, 25, 50, 75]);
            const base = pick([20, 40, 50, 80, 100, 200]);
            const answer = (pct / 100) * base;
            return { question: `What is ${pct}% of ${base}?`, answer, type: "procedural",
                explanation: `${pct}% = ${pct}/100 = ${pct/100}. Multiply: ${pct/100} × ${base} = ${answer}` };
        },
        Ratios: () => {
            const a = rand(2, 5), b = rand(2, 5);
            const mult = rand(2, 6);
            const total = a * mult;
            return { question: `Ratio of cats to dogs is ${a}:${b}. If there are ${total} cats, how many dogs?`, answer: b * mult, type: "reasoning",
                explanation: `${a} parts = ${total}, so 1 part = ${mult}. Dogs = ${b} × ${mult} = ${b * mult}` };
        },
        Statistics: () => {
            const n = rand(4, 6);
            const nums = Array.from({length: n}, () => rand(2, 15));
            const sum = nums.reduce((a, b) => a + b, 0);
            const mean = sum / n;
            return { question: `What is the mean of: ${nums.join(", ")}?`, answer: parseFloat(mean.toFixed(2)), type: "procedural",
                explanation: `Sum = ${sum}, count = ${n}. Mean = ${sum}/${n} = ${mean.toFixed(2)}` };
        },
        "Data Collection": () => {
            const type = pick(["tally", "read", "organize"]);
            if (type === "tally") {
                const count = rand(3, 12);
                const tallyStr = "||||".repeat(Math.floor(count / 5)) + "|".repeat(count % 5);
                return { question: `How many does this tally show? ${tallyStr.replace(/\|\|\|\|\|/g, '||||̸ ')}`, answer: count, type: "procedural",
                    explanation: `Each group of 5 is ||||̸. Count: ${Math.floor(count/5)} groups of 5 + ${count % 5} = ${count}` };
            } else if (type === "read") {
                const categories = ["Red", "Blue", "Green"];
                const values = [rand(2, 8), rand(2, 8), rand(2, 8)];
                const maxIdx = values.indexOf(Math.max(...values));
                return { question: `Bar graph shows: Red=${values[0]}, Blue=${values[1]}, Green=${values[2]}. Which has the most?`,
                    answer: categories[maxIdx], type: "conceptual",
                    options: categories.concat(["They're equal"]),
                    explanation: `${categories[maxIdx]} has ${values[maxIdx]}, which is the highest.` };
            } else {
                const data = [rand(5, 10), rand(3, 8), rand(7, 12), rand(4, 9)];
                const total = data.reduce((a, b) => a + b, 0);
                return { question: `Survey results: Mon=${data[0]}, Tue=${data[1]}, Wed=${data[2]}, Thu=${data[3]}. Total responses?`,
                    answer: total, type: "procedural",
                    explanation: `${data.join(" + ")} = ${total}` };
            }
        },
        "Mean Median Mode": () => {
            const type = pick(["median", "mode", "range"]);
            if (type === "median") {
                const n = 5;
                const nums = Array.from({length: n}, () => rand(2, 20)).sort((a, b) => a - b);
                const median = nums[Math.floor(n / 2)];
                return { question: `Find the median: ${nums.join(", ")}`, answer: median, type: "procedural",
                    explanation: `Ordered: ${nums.join(", ")}. Middle value = ${median}` };
            } else if (type === "mode") {
                const base = rand(2, 10);
                const nums = [base, base, base, rand(1, 15), rand(1, 15)].sort((a, b) => a - b);
                return { question: `Find the mode: ${nums.join(", ")}`, answer: base, type: "conceptual",
                    explanation: `${base} appears most often (3 times). Mode = ${base}` };
            } else {
                const nums = Array.from({length: 5}, () => rand(5, 25)).sort((a, b) => a - b);
                const range = nums[4] - nums[0];
                return { question: `Find the range: ${nums.join(", ")}`, answer: range, type: "procedural",
                    explanation: `Range = max - min = ${nums[4]} - ${nums[0]} = ${range}` };
            }
        },
        "Unit Conversion": () => {
            const type = pick(["length", "weight", "volume"]);
            if (type === "length") {
                const feet = rand(2, 10);
                const inches = feet * 12;
                return { question: `Convert ${feet} feet to inches.`, answer: inches, type: "procedural",
                    explanation: `1 foot = 12 inches. ${feet} × 12 = ${inches} inches` };
            } else if (type === "weight") {
                const pounds = rand(2, 10);
                const ounces = pounds * 16;
                return { question: `Convert ${pounds} pounds to ounces.`, answer: ounces, type: "procedural",
                    explanation: `1 pound = 16 ounces. ${pounds} × 16 = ${ounces} ounces` };
            } else {
                const gallons = rand(1, 5);
                const quarts = gallons * 4;
                return { question: `Convert ${gallons} gallon${gallons > 1 ? 's' : ''} to quarts.`, answer: quarts, type: "procedural",
                    explanation: `1 gallon = 4 quarts. ${gallons} × 4 = ${quarts} quarts` };
            }
        },
        "Basic Graphing": () => {
            const type = pick(["plot", "quadrant", "distance"]);
            if (type === "plot") {
                const x = rand(-5, 5);
                const y = rand(-5, 5);
                const quadrant = x > 0 && y > 0 ? "I" : x < 0 && y > 0 ? "II" : x < 0 && y < 0 ? "III" : x > 0 && y < 0 ? "IV" : "axis";
                return { question: `Point (${x}, ${y}) is in which quadrant?`, answer: quadrant === "axis" ? "on an axis" : `Quadrant ${quadrant}`, type: "conceptual",
                    options: ["Quadrant I", "Quadrant II", "Quadrant III", "Quadrant IV"],
                    explanation: `(${x}, ${y}): x is ${x > 0 ? "positive" : x < 0 ? "negative" : "zero"}, y is ${y > 0 ? "positive" : y < 0 ? "negative" : "zero"}. That's ${quadrant === "axis" ? "on an axis" : "Quadrant " + quadrant}.` };
            } else if (type === "quadrant") {
                const quadrants = [
                    { q: "I", desc: "x positive, y positive", ex: "(3, 2)" },
                    { q: "II", desc: "x negative, y positive", ex: "(-3, 2)" },
                    { q: "III", desc: "x negative, y negative", ex: "(-3, -2)" },
                    { q: "IV", desc: "x positive, y negative", ex: "(3, -2)" }
                ];
                const quad = pick(quadrants);
                return { question: `In Quadrant ${quad.q}, x is ___ and y is ___.`, answer: quad.desc, type: "conceptual",
                    options: quadrants.map(q => q.desc),
                    explanation: `Quadrant ${quad.q} has ${quad.desc}. Example: ${quad.ex}` };
            } else {
                const x1 = 0, y1 = 0;
                const x2 = rand(3, 5), y2 = 0;
                return { question: `Distance from (${x1}, ${y1}) to (${x2}, ${y2})?`, answer: x2, type: "procedural",
                    explanation: `Points on same horizontal line: distance = |${x2} - ${x1}| = ${x2}` };
            }
        },
        Proportions: () => {
            const type = pick(["solve", "setup", "word"]);
            if (type === "solve") {
                const a = rand(2, 8), b = rand(2, 6), c = rand(3, 12);
                const d = (b * c) / a;
                if (d === Math.floor(d)) {
                    return { question: `Solve: ${a}/${b} = ${c}/x`, answer: d, type: "procedural",
                        explanation: `Cross multiply: ${a} × x = ${b} × ${c} → ${a}x = ${b*c} → x = ${d}` };
                } else {
                    const newA = rand(2, 5), newB = rand(2, 4), newC = newA * rand(2, 4);
                    const newD = (newB * newC) / newA;
                    return { question: `Solve: ${newA}/${newB} = ${newC}/x`, answer: newD, type: "procedural",
                        explanation: `Cross multiply: ${newA} × x = ${newB} × ${newC} → ${newA}x = ${newB*newC} → x = ${newD}` };
                }
            } else if (type === "setup") {
                const rate = rand(2, 5), unit = rand(3, 10);
                const total = rate * unit;
                return { question: `If ${rate} apples cost $${unit}, write a proportion to find the cost of ${total/rate * 2} apples.`,
                    answer: `${rate}/${unit} = ${total/rate * 2}/x`, type: "conceptual",
                    options: [`${rate}/${unit} = ${total/rate * 2}/x`, `${unit}/${rate} = x/${total/rate * 2}`, `${rate}/x = ${unit}/${total/rate * 2}`, `${total/rate * 2}/${rate} = x/${unit}`],
                    explanation: `Set up: apples/cost = apples/cost → ${rate}/${unit} = ${total/rate * 2}/x` };
            } else {
                const miles = rand(50, 150), hours = rand(2, 4);
                const rate = miles / hours;
                const newHours = hours + rand(1, 3);
                const newMiles = rate * newHours;
                return { question: `You drive ${miles} miles in ${hours} hours. At this rate, how far in ${newHours} hours?`, answer: newMiles, type: "reasoning",
                    explanation: `Rate = ${miles}/${hours} = ${rate} mph. Distance = ${rate} × ${newHours} = ${newMiles} miles` };
            }
        },
        "Absolute Value": () => {
            const type = pick(["evaluate", "compare", "solve"]);
            if (type === "evaluate") {
                const n = rand(-15, 15);
                return { question: `What is |${n}|?`, answer: Math.abs(n), type: "procedural",
                    explanation: `|${n}| = ${Math.abs(n)}. Absolute value is the distance from 0, always positive.` };
            } else if (type === "compare") {
                const a = rand(-10, -1), b = rand(1, 10);
                const absA = Math.abs(a), absB = Math.abs(b);
                const larger = absA > absB ? `|${a}|` : absA < absB ? `|${b}|` : "equal";
                return { question: `Which is greater: |${a}| or |${b}|?`, answer: larger, type: "conceptual",
                    options: [`|${a}|`, `|${b}|`, "equal"],
                    explanation: `|${a}| = ${absA}, |${b}| = ${absB}. ${larger === "equal" ? "They are equal." : larger + " is greater."}` };
            } else {
                const ans = rand(2, 10);
                return { question: `Solve: |x| = ${ans}`, answer: `${ans} or -${ans}`, type: "procedural",
                    options: [`${ans} or -${ans}`, `${ans}`, `-${ans}`, `${ans * 2}`],
                    explanation: `|x| = ${ans} means x = ${ans} or x = -${ans} (both are ${ans} away from 0)` };
            }
        },
        "Scientific Notation": () => {
            const type = pick(["convert_to", "convert_from", "multiply"]);
            if (type === "convert_to") {
                const sig = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(3, 7);
                const standard = sig * Math.pow(10, exp);
                return { question: `Write ${standard.toLocaleString()} in scientific notation.`, answer: `${sig} × 10^${exp}`, type: "procedural",
                    options: [`${sig} × 10^${exp}`, `${sig} × 10^${exp-1}`, `${sig * 10} × 10^${exp-1}`, `${sig / 10} × 10^${exp+1}`],
                    explanation: `Move decimal ${exp} places left: ${standard.toLocaleString()} = ${sig} × 10^${exp}` };
            } else if (type === "convert_from") {
                const sig = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(2, 5);
                const answer = sig * Math.pow(10, exp);
                return { question: `Convert ${sig} × 10^${exp} to standard form.`, answer: answer, type: "procedural",
                    explanation: `Move decimal ${exp} places right: ${sig} × 10^${exp} = ${answer}` };
            } else {
                const a = rand(2, 5), b = rand(2, 4), expA = rand(3, 5), expB = rand(2, 4);
                const product = a * b;
                const expSum = expA + expB;
                return { question: `(${a} × 10^${expA}) × (${b} × 10^${expB}) = ?`, answer: `${product} × 10^${expSum}`, type: "procedural",
                    options: [`${product} × 10^${expSum}`, `${a + b} × 10^${expSum}`, `${product} × 10^${expA * expB}`, `${product} × 10^${expA}`],
                    explanation: `Multiply coefficients: ${a} × ${b} = ${product}. Add exponents: ${expA} + ${expB} = ${expSum}` };
            }
        },
        "Square Roots": () => {
            const type = pick(["perfect", "estimate", "simplify"]);
            if (type === "perfect") {
                const root = rand(2, 12);
                const square = root * root;
                return { question: `What is √${square}?`, answer: root, type: "procedural",
                    explanation: `√${square} = ${root} because ${root} × ${root} = ${square}` };
            } else if (type === "estimate") {
                const root = rand(4, 9);
                const between = root * root + rand(1, root * 2 - 1);
                const low = root, high = root + 1;
                return { question: `Between which two integers is √${between}?`, answer: `${low} and ${high}`, type: "reasoning",
                    options: [`${low} and ${high}`, `${low - 1} and ${low}`, `${high} and ${high + 1}`, `${low - 1} and ${high + 1}`],
                    explanation: `${low}² = ${low*low}, ${high}² = ${high*high}. Since ${low*low} < ${between} < ${high*high}, √${between} is between ${low} and ${high}.` };
            } else {
                const outside = rand(2, 5), inside = rand(2, 5);
                const radicand = outside * outside * inside;
                return { question: `Simplify √${radicand}`, answer: `${outside}√${inside}`, type: "procedural",
                    options: [`${outside}√${inside}`, `${inside}√${outside}`, `√${radicand}`, `${outside * inside}`],
                    explanation: `√${radicand} = √(${outside}² × ${inside}) = ${outside}√${inside}` };
            }
        },
        "GCF and LCM": () => {
            const type = pick(["gcf", "lcm", "gcf_word", "lcm_word"]);
            const pairs = [[12, 18], [8, 12], [15, 20], [10, 15], [14, 21], [16, 24], [9, 12], [6, 8]];
            const [a, b] = pick(pairs);
            // Calculate GCF
            const findGCF = (x, y) => { while (y) { [x, y] = [y, x % y]; } return x; };
            const gcfVal = findGCF(a, b);
            // Calculate LCM
            const lcmVal = (a * b) / gcfVal;
            if (type === "gcf") {
                return { question: `What is the GCF (Greatest Common Factor) of ${a} and ${b}?`, answer: gcfVal, type: "procedural",
                    options: [gcfVal, lcmVal, Math.min(a, b), a + b].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `Factors of ${a}: ${[...Array(a)].map((_,i)=>i+1).filter(n=>a%n===0).join(", ")}. Factors of ${b}: ${[...Array(b)].map((_,i)=>i+1).filter(n=>b%n===0).join(", ")}. GCF = ${gcfVal}` };
            } else if (type === "lcm") {
                return { question: `What is the LCM (Least Common Multiple) of ${a} and ${b}?`, answer: lcmVal, type: "procedural",
                    options: [lcmVal, a * b, gcfVal, Math.max(a, b)].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `Multiples of ${a}: ${a}, ${a*2}, ${a*3}... Multiples of ${b}: ${b}, ${b*2}, ${b*3}... LCM = ${lcmVal}` };
            } else if (type === "gcf_word") {
                return { question: `${a} red beads and ${b} blue beads are divided into equal groups. What is the greatest number of groups possible?`, answer: gcfVal, type: "reasoning",
                    explanation: `GCF of ${a} and ${b} = ${gcfVal}. You can make ${gcfVal} equal groups.` };
            } else {
                return { question: `Hot dogs come in packs of ${a}. Buns come in packs of ${b}. What's the least number of each to have the same amount?`, answer: lcmVal, type: "reasoning",
                    explanation: `LCM of ${a} and ${b} = ${lcmVal}. Buy ${lcmVal / a} packs of hot dogs and ${lcmVal / b} packs of buns.` };
            }
        },
        "Powers of 10": () => {
            const type = pick(["multiply", "divide", "pattern", "decimal", "scientific"]);
            if (type === "multiply") {
                const n = rand(1, 99);
                const power = rand(1, 4);
                const result = n * Math.pow(10, power);
                return { question: `${n} × 10${power > 1 ? `^${power}` : ""} = ?`, answer: result, type: "procedural",
                    explanation: `Move the decimal ${power} place(s) right: ${n} → ${result}` };
            } else if (type === "divide") {
                const n = rand(1, 9) * Math.pow(10, rand(2, 4));
                const power = rand(1, 3);
                const result = n / Math.pow(10, power);
                return { question: `${n} ÷ 10${power > 1 ? `^${power}` : ""} = ?`, answer: result, type: "procedural",
                    explanation: `Move the decimal ${power} place(s) left: ${n} → ${result}` };
            } else if (type === "pattern") {
                const base = rand(2, 9);
                const exp = rand(2, 5);
                const value = base * Math.pow(10, exp);
                return { question: `${base} × 10^${exp} = ?`, answer: value, type: "procedural",
                    options: [value, base * exp, Math.pow(base, exp), value / 10],
                    explanation: `10^${exp} = ${Math.pow(10, exp)}. So ${base} × 10^${exp} = ${value}` };
            } else if (type === "decimal") {
                const n = rand(1, 99) / 100;
                const power = rand(2, 4);
                const result = n * Math.pow(10, power);
                return { question: `${n} × 10^${power} = ?`, answer: result, type: "procedural",
                    explanation: `Move decimal ${power} places right: ${n} → ${result}` };
            } else {
                const coefficient = rand(1, 9) + rand(1, 9) / 10;
                const exp = rand(3, 6);
                const value = coefficient * Math.pow(10, exp);
                return { question: `Write ${coefficient} × 10^${exp} in standard form.`, answer: value, type: "procedural",
                    explanation: `${coefficient} × 10^${exp} = ${value}` };
            }
        },
        "Coordinate Plane": () => {
            const type = pick(["identify", "plot", "quadrant", "distance", "midpoint"]);
            if (type === "identify") {
                const x = rand(-5, 5);
                const y = rand(-5, 5);
                const which = pick(["x", "y"]);
                return {
                    question: `Look at point A on the graph. What is its ${which}-coordinate?`,
                    answer: which === "x" ? x : y, type: "conceptual",
                    options: [x, y, -x, -y].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `In (${x}, ${y}), the x-coordinate is ${x} and y-coordinate is ${y}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-6, 6], yRange: [-6, 6], gridStep: 1, points: [{ x, y, label: 'A' }] } }
                };
            } else if (type === "plot") {
                const x = rand(-4, 4);
                const y = rand(-4, 4);
                return {
                    question: `Click on the coordinate plane to plot the point (${x}, ${y}).`,
                    answer: `(${x}, ${y})`, type: "procedural",
                    explanation: `(${x}, ${y}) means go ${x} on x-axis and ${y} on y-axis.`,
                    visual: { type: 'coordinate', mode: 'interactive', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, targetPoint: { x, y } } }
                };
            } else if (type === "quadrant") {
                const quadrants = [
                    { q: "I", x: rand(1, 5), y: rand(1, 5), signs: "(+, +)" },
                    { q: "II", x: rand(-5, -1), y: rand(1, 5), signs: "(-, +)" },
                    { q: "III", x: rand(-5, -1), y: rand(-5, -1), signs: "(-, -)" },
                    { q: "IV", x: rand(1, 5), y: rand(-5, -1), signs: "(+, -)" }
                ];
                const quad = pick(quadrants);
                return {
                    question: `In which quadrant is point A?`,
                    answer: `Quadrant ${quad.q}`, type: "conceptual",
                    options: ["Quadrant I", "Quadrant II", "Quadrant III", "Quadrant IV"],
                    explanation: `${quad.signs} means Quadrant ${quad.q}. (${quad.x}, ${quad.y}) is in Quadrant ${quad.q}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-6, 6], yRange: [-6, 6], gridStep: 1, points: [{ x: quad.x, y: quad.y, label: 'A' }] } }
                };
            } else if (type === "distance") {
                const x1 = 0, y1 = 0, x2 = 3, y2 = 4;
                return {
                    question: `Find the distance from A to B.`,
                    answer: 5, type: "procedural",
                    options: [5, 7, 12, 1],
                    explanation: `Distance = √(3² + 4²) = √(9 + 16) = √25 = 5`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 6], yRange: [-1, 6], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] }] } }
                };
            } else {
                const x1 = rand(0, 2) * 2, y1 = rand(0, 2) * 2;
                const x2 = rand(2, 4) * 2, y2 = rand(2, 4) * 2;
                const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
                return {
                    question: `Find the midpoint of segment AB.`,
                    answer: `(${midX}, ${midY})`, type: "procedural",
                    options: [`(${midX}, ${midY})`, `(${x1 + x2}, ${y1 + y2})`, `(${midY}, ${midX})`, `(${x2 - x1}, ${y2 - y1})`],
                    explanation: `Midpoint = ((${x1}+${x2})/2, (${y1}+${y2})/2) = (${midX}, ${midY})`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 10], yRange: [-1, 10], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] }] } }
                };
            }
        },
        "Volume": () => {
            const type = pick(["rectangular_prism", "cube", "find_dimension", "word_problem", "compare"]);
            if (type === "rectangular_prism") {
                const l = rand(2, 8), w = rand(2, 6), h = rand(2, 5);
                const vol = l * w * h;
                return { question: `Find the volume of a rectangular prism: length ${l}, width ${w}, height ${h}.`, answer: vol, type: "procedural",
                    explanation: `Volume = l × w × h = ${l} × ${w} × ${h} = ${vol} cubic units` };
            } else if (type === "cube") {
                const s = rand(2, 6);
                const vol = s * s * s;
                return { question: `Find the volume of a cube with side length ${s}.`, answer: vol, type: "procedural",
                    explanation: `Volume = s³ = ${s}³ = ${vol} cubic units` };
            } else if (type === "find_dimension") {
                const l = rand(3, 6), w = rand(2, 4);
                const vol = l * w * rand(2, 4);
                const h = vol / (l * w);
                return { question: `A box has volume ${vol} cubic units. Length = ${l}, width = ${w}. What is the height?`, answer: h, type: "reasoning",
                    options: [h, h + 1, h - 1, vol / l].filter((v,i,arr) => arr.indexOf(v) === i),
                    explanation: `Volume = l × w × h, so h = Volume ÷ (l × w) = ${vol} ÷ ${l * w} = ${h}` };
            } else if (type === "word_problem") {
                const l = rand(3, 8), w = rand(2, 5), h = rand(2, 4);
                const vol = l * w * h;
                const container = pick(["fish tank", "storage box", "shipping crate"]);
                return { question: `A ${container} is ${l} ft long, ${w} ft wide, and ${h} ft tall. What is its volume?`, answer: vol, type: "reasoning",
                    explanation: `Volume = ${l} × ${w} × ${h} = ${vol} cubic feet` };
            } else {
                const v1 = { l: rand(3, 5), w: rand(2, 4), h: rand(2, 3) };
                const v2 = { l: rand(3, 5), w: rand(2, 4), h: rand(2, 3) };
                const vol1 = v1.l * v1.w * v1.h;
                const vol2 = v2.l * v2.w * v2.h;
                const larger = vol1 > vol2 ? "Box A" : vol2 > vol1 ? "Box B" : "Same";
                return { question: `Box A: ${v1.l}×${v1.w}×${v1.h}. Box B: ${v2.l}×${v2.w}×${v2.h}. Which has more volume?`, answer: larger, type: "reasoning",
                    options: ["Box A", "Box B", "Same"],
                    explanation: `A: ${vol1} cu units. B: ${vol2} cu units. ${larger} has more volume.` };
            }
        },
        "Order of Operations": () => {
            const type = pick(["basic", "with_exponents", "with_parentheses", "complex"]);
            if (type === "basic") {
                const a = rand(2, 8), b = rand(2, 6), c = rand(2, 5);
                const result = a + b * c;
                return { question: `${a} + ${b} × ${c} = ?`, answer: result, type: "procedural",
                    explanation: `PEMDAS: Multiply first: ${b} × ${c} = ${b * c}. Then add: ${a} + ${b * c} = ${result}` };
            } else if (type === "with_exponents") {
                const a = rand(2, 4), b = rand(2, 5), c = rand(1, 4);
                const result = a * a + b * c;
                return { question: `${a}² + ${b} × ${c} = ?`, answer: result, type: "procedural",
                    explanation: `PEMDAS: Exponents first: ${a}² = ${a * a}. Then multiply: ${b} × ${c} = ${b * c}. Add: ${a * a} + ${b * c} = ${result}` };
            } else if (type === "with_parentheses") {
                const a = rand(2, 5), b = rand(2, 5), c = rand(2, 4);
                const result = (a + b) * c;
                return { question: `(${a} + ${b}) × ${c} = ?`, answer: result, type: "procedural",
                    explanation: `PEMDAS: Parentheses first: ${a} + ${b} = ${a + b}. Then multiply: ${a + b} × ${c} = ${result}` };
            } else {
                const a = rand(2, 3), b = rand(2, 4), c = rand(2, 3), d = rand(1, 3);
                const result = a * a + b * (c + d);
                return { question: `${a}² + ${b} × (${c} + ${d}) = ?`, answer: result, type: "procedural",
                    explanation: `Parentheses: ${c} + ${d} = ${c + d}. Exponent: ${a}² = ${a * a}. Multiply: ${b} × ${c + d} = ${b * (c + d)}. Add: ${a * a} + ${b * (c + d)} = ${result}` };
            }
        },
        "Expressions with Variables": () => {
            const type = pick(["evaluate", "simplify", "translate", "like_terms"]);
            if (type === "evaluate") {
                const x = rand(2, 8);
                const a = rand(2, 5), b = rand(1, 10);
                const result = a * x + b;
                return { question: `Evaluate ${a}x + ${b} when x = ${x}`, answer: result, type: "procedural",
                    explanation: `${a}(${x}) + ${b} = ${a * x} + ${b} = ${result}` };
            } else if (type === "simplify") {
                const a = rand(2, 6), b = rand(1, 5);
                const sum = a + b;
                return { question: `Simplify: ${a}x + ${b}x`, answer: `${sum}x`, type: "procedural",
                    options: [`${sum}x`, `${a * b}x`, `${a}x²`, `x${sum}`],
                    explanation: `${a}x + ${b}x = (${a} + ${b})x = ${sum}x` };
            } else if (type === "translate") {
                const phrases = [
                    { words: "5 more than a number", expr: "n + 5" },
                    { words: "twice a number", expr: "2n" },
                    { words: "a number decreased by 3", expr: "n - 3" },
                    { words: "a number divided by 4", expr: "n ÷ 4" },
                    { words: "3 times a number plus 2", expr: "3n + 2" }
                ];
                const phrase = pick(phrases);
                return { question: `Write an expression: "${phrase.words}"`, answer: phrase.expr, type: "reasoning",
                    options: shuffle(phrases.map(p => p.expr)).slice(0, 4),
                    explanation: `"${phrase.words}" translates to ${phrase.expr}` };
            } else {
                const a = rand(2, 5), b = rand(1, 4), c = rand(1, 5), d = rand(1, 4);
                const xCoef = a + c, constant = b + d;
                return { question: `Combine like terms: ${a}x + ${b} + ${c}x + ${d}`, answer: `${xCoef}x + ${constant}`, type: "procedural",
                    explanation: `x terms: ${a}x + ${c}x = ${xCoef}x. Constants: ${b} + ${d} = ${constant}. Result: ${xCoef}x + ${constant}` };
            }
        },
        "One-Step Equations": () => {
            const type = pick(["add", "subtract", "multiply", "divide"]);
            const x = rand(2, 12);
            if (type === "add") {
                const b = rand(3, 15);
                return { question: `Solve: x + ${b} = ${x + b}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b} from both sides: x = ${x + b} - ${b} = ${x}` };
            } else if (type === "subtract") {
                const b = rand(3, 10);
                return { question: `Solve: x - ${b} = ${x - b}`, answer: x, type: "procedural",
                    explanation: `Add ${b} to both sides: x = ${x - b} + ${b} = ${x}` };
            } else if (type === "multiply") {
                const a = rand(2, 6);
                return { question: `Solve: ${a}x = ${a * x}`, answer: x, type: "procedural",
                    explanation: `Divide both sides by ${a}: x = ${a * x} ÷ ${a} = ${x}` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve: x/${a} = ${x / a}`, answer: x, type: "procedural",
                    explanation: `Multiply both sides by ${a}: x = ${x / a} × ${a} = ${x}` };
            }
        },
        "Simple Probability": () => {
            const type = pick(["basic", "fraction", "complement", "word_problem", "compare"]);
            if (type === "basic") {
                const total = pick([6, 8, 10, 12]);
                const favorable = rand(1, total - 1);
                const prob = `${favorable}/${total}`;
                const color = pick(["red", "blue", "green"]);
                return { question: `A bag has ${total} marbles. ${favorable} are ${color}. What is P(${color})?`, answer: prob, type: "procedural",
                    options: [prob, `${total - favorable}/${total}`, `${favorable}/${favorable}`, `${total}/${favorable}`],
                    explanation: `P(${color}) = favorable/total = ${favorable}/${total}` };
            } else if (type === "fraction") {
                const die = true;
                const event = pick(["even", "odd", "greater than 4", "less than 3"]);
                const probs = { "even": "3/6", "odd": "3/6", "greater than 4": "2/6", "less than 3": "2/6" };
                return { question: `Roll a die. What is P(${event})?`, answer: probs[event], type: "procedural",
                    options: ["1/6", "2/6", "3/6", "4/6"],
                    explanation: `P(${event}) = ${probs[event]}` };
            } else if (type === "complement") {
                const total = 10;
                const favorable = rand(2, 8);
                const complement = total - favorable;
                return { question: `P(winning) = ${favorable}/${total}. What is P(not winning)?`, answer: `${complement}/${total}`, type: "procedural",
                    options: [`${complement}/${total}`, `${favorable}/${total}`, `${total}/${favorable}`, `1/${total}`],
                    explanation: `P(not winning) = 1 - P(winning) = 1 - ${favorable}/${total} = ${complement}/${total}` };
            } else if (type === "word_problem") {
                const total = rand(5, 10);
                const red = rand(1, total - 1);
                const blue = total - red;
                return { question: `Bag has ${red} red and ${blue} blue balls. What is P(blue)?`, answer: `${blue}/${total}`, type: "reasoning",
                    explanation: `Total = ${total}. P(blue) = ${blue}/${total}` };
            } else {
                const p1 = rand(1, 4), p2 = rand(1, 4);
                const total = 8;
                const more = p1 > p2 ? "Event A" : p2 > p1 ? "Event B" : "Same";
                return { question: `P(A) = ${p1}/8, P(B) = ${p2}/8. Which is more likely?`, answer: more, type: "reasoning",
                    options: ["Event A", "Event B", "Same"],
                    explanation: `${p1}/8 ${p1 > p2 ? ">" : p1 < p2 ? "<" : "="} ${p2}/8. ${more} is more likely.` };
            }
        },
        "Comparing Distributions": () => {
            const type = pick(["mean", "spread", "center", "shape"]);
            if (type === "mean") {
                const set1 = [rand(10, 20), rand(10, 20), rand(10, 20), rand(10, 20), rand(10, 20)];
                const set2 = [rand(15, 25), rand(15, 25), rand(15, 25), rand(15, 25), rand(15, 25)];
                const mean1 = set1.reduce((a, b) => a + b, 0) / 5;
                const mean2 = set2.reduce((a, b) => a + b, 0) / 5;
                const higher = mean1 > mean2 ? "Set A" : "Set B";
                return { question: `Set A: ${set1.join(", ")}. Set B: ${set2.join(", ")}. Which has a higher mean?`, answer: higher, type: "reasoning",
                    options: ["Set A", "Set B", "Same"],
                    explanation: `Mean A = ${mean1.toFixed(1)}. Mean B = ${mean2.toFixed(1)}. ${higher} is higher.` };
            } else if (type === "spread") {
                const set1 = [10, 11, 12, 13, 14];
                const set2 = [5, 10, 12, 15, 23];
                return { question: `Set A: ${set1.join(", ")}. Set B: ${set2.join(", ")}. Which has more spread?`, answer: "Set B", type: "conceptual",
                    options: ["Set A", "Set B", "Same"],
                    explanation: `Set A ranges 10-14 (4). Set B ranges 5-23 (18). Set B has more spread.` };
            } else if (type === "center") {
                const median1 = rand(15, 25);
                const median2 = rand(10, 20);
                const higher = median1 > median2 ? "Class A" : "Class B";
                return { question: `Class A median score: ${median1}. Class B median score: ${median2}. Which class performed better?`, answer: higher, type: "reasoning",
                    options: ["Class A", "Class B", "Same"],
                    explanation: `Higher median = better typical performance. ${higher} (median ${Math.max(median1, median2)}) did better.` };
            } else {
                return { question: `A distribution where most values cluster around the mean is called...?`, answer: "symmetric", type: "conceptual",
                    options: ["symmetric", "skewed left", "skewed right", "uniform"],
                    explanation: `When data clusters around the center with similar spread on both sides, it's symmetric.` };
            }
        },
        "Nets of 3D Shapes": () => {
            const type = pick(["identify", "surface_area", "count_faces", "fold"]);
            const shapes = [
                { name: "cube", faces: 6, net: "6 squares" },
                { name: "rectangular prism", faces: 6, net: "6 rectangles (or 4 rectangles + 2 squares)" },
                { name: "triangular prism", faces: 5, net: "2 triangles + 3 rectangles" },
                { name: "square pyramid", faces: 5, net: "1 square + 4 triangles" },
                { name: "cylinder", faces: 3, net: "2 circles + 1 rectangle" }
            ];
            if (type === "identify") {
                const shape = pick(shapes);
                return { question: `A net with ${shape.net} folds into a...?`, answer: shape.name, type: "conceptual",
                    options: shapes.slice(0, 4).map(s => s.name),
                    explanation: `${shape.net} makes a ${shape.name}.` };
            } else if (type === "surface_area") {
                const side = rand(2, 5);
                const sa = 6 * side * side;
                return { question: `A cube has side length ${side}. What is its surface area?`, answer: sa, type: "procedural",
                    explanation: `Surface area = 6 × side² = 6 × ${side}² = 6 × ${side * side} = ${sa} sq units` };
            } else if (type === "count_faces") {
                const shape = pick(shapes);
                return { question: `How many faces does a ${shape.name} have?`, answer: shape.faces, type: "conceptual",
                    options: [shape.faces, shape.faces + 1, shape.faces - 1, shape.faces + 2].filter(n => n > 0),
                    explanation: `A ${shape.name} has ${shape.faces} faces.` };
            } else {
                const shape = pick(shapes.filter(s => s.name !== "cylinder"));
                return { question: `What 2D shapes appear in the net of a ${shape.name}?`, answer: shape.net, type: "conceptual",
                    options: shapes.filter(s => s.name !== "cylinder").map(s => s.net),
                    explanation: `The net of a ${shape.name} contains ${shape.net}.` };
            }
        }
    },

    // TIER 4: Pre-Algebra (7-8)
    4: {
        "Order of Operations": () => {
            const templates = [
                () => { const a = rand(2, 8), b = rand(2, 6), c = rand(2, 5); return { q: `${a} + ${b} × ${c}`, ans: a + b * c, exp: `Multiply first: ${b} × ${c} = ${b*c}. Then add: ${a} + ${b*c} = ${a + b*c}` }; },
                () => { const a = rand(2, 5), b = rand(2, 5), c = rand(2, 4); return { q: `(${a} + ${b}) × ${c}`, ans: (a + b) * c, exp: `Parentheses first: ${a} + ${b} = ${a+b}. Then multiply: ${(a+b)} × ${c} = ${(a+b)*c}` }; },
                () => { const a = rand(2, 4), b = rand(2, 4), c = rand(1, 5); return { q: `${a}² + ${b} × ${c}`, ans: a*a + b*c, exp: `Exponent first: ${a}² = ${a*a}. Multiply: ${b} × ${c} = ${b*c}. Add: ${a*a} + ${b*c} = ${a*a + b*c}` }; }
            ];
            const t = pick(templates)();
            return { question: `What is ${t.q}?`, answer: t.ans, type: "procedural", explanation: t.exp };
        },
        Equations: () => {
            const type = pick(["add", "sub", "mult", "div"]);
            const x = rand(2, 15);
            let question, explanation;
            if (type === "add") { const b = rand(3, 12); question = `x + ${b} = ${x + b}`; explanation = `Subtract ${b}: x = ${x + b} - ${b} = ${x}`; }
            else if (type === "sub") { const b = rand(3, 12); question = `x - ${b} = ${x - b}`; explanation = `Add ${b}: x = ${x - b} + ${b} = ${x}`; }
            else if (type === "mult") { const b = rand(2, 8); question = `${b}x = ${b * x}`; explanation = `Divide by ${b}: x = ${b * x} ÷ ${b} = ${x}`; }
            else { const b = rand(2, 6); question = `x ÷ ${b} = ${x}`; explanation = `Multiply by ${b}: x = ${x} × ${b} = ${x * b}`; return { question: `Solve: ${question}`, answer: x * b, type: "procedural", explanation }; }
            return { question: `Solve: ${question}`, answer: x, type: "procedural", explanation };
        },
        Exponents: () => {
            const type = pick(["eval", "multiply", "power"]);
            if (type === "eval") {
                const base = rand(2, 5), exp = rand(2, 4);
                return { question: `What is ${base}${["⁰","¹","²","³","⁴"][exp]}?`, answer: Math.pow(base, exp), type: "procedural",
                    explanation: `${base}^${exp} = ${"×".repeat(exp-1).split("").map(() => base).join(" × ")} = ${Math.pow(base, exp)}` };
            } else if (type === "multiply") {
                const base = rand(2, 4), e1 = rand(2, 4), e2 = rand(2, 3);
                return { question: `Simplify: ${base}${["","¹","²","³","⁴"][e1]} × ${base}${["","¹","²","³"][e2]}`, answer: `${base}^${e1+e2}`, type: "procedural",
                    options: [`${base}^${e1+e2}`, `${base}^${e1*e2}`, `${base*2}^${e1}`, `${base}^${e1}`],
                    explanation: `Add exponents when multiplying same base: ${base}^${e1} × ${base}^${e2} = ${base}^${e1+e2}` };
            } else {
                const base = rand(2, 3), e1 = rand(2, 3), e2 = rand(2, 3);
                return { question: `Simplify: (${base}${["","¹","²","³"][e1]})${["","¹","²","³"][e2]}`, answer: `${base}^${e1*e2}`, type: "procedural",
                    options: [`${base}^${e1*e2}`, `${base}^${e1+e2}`, `${base*e2}^${e1}`, `${base}^${e1}`],
                    explanation: `Multiply exponents for power of power: (${base}^${e1})^${e2} = ${base}^${e1*e2}` };
            }
        },
        Slope: () => {
            const rise = rand(1, 4), run = rand(1, 4);
            const type = pick(["formula", "points"]);
            if (type === "formula") {
                const x1 = 0, y1 = 1;
                const x2 = run, y2 = y1 + rise;
                return {
                    question: `What is the slope of this line?`,
                    answer: rise / run, type: "conceptual",
                    explanation: `Slope = rise/run = ${rise}/${run} = ${(rise/run).toFixed(2)}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 6], yRange: [-1, 6], gridStep: 1, lines: [{ equation: { m: rise/run, b: y1 } }], points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] } }
                };
            } else {
                const x1 = rand(0, 2), y1 = rand(0, 2);
                const x2 = x1 + run, y2 = y1 + rise;
                return {
                    question: `Find the slope of the line through A and B.`,
                    answer: rise / run, type: "procedural",
                    explanation: `Slope = (${y2}-${y1})/(${x2}-${x1}) = ${rise}/${run} = ${(rise/run).toFixed(2)}`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-1, 7], yRange: [-1, 7], gridStep: 1, points: [{ x: x1, y: y1, label: 'A' }, { x: x2, y: y2, label: 'B' }], lines: [{ points: [{ x: x1, y: y1 }, { x: x2, y: y2 }] }] } }
                };
            }
        },
        Pythagorean: () => {
            const triples = [[3,4,5], [5,12,13], [8,15,17], [6,8,10]];
            const [a, b, c] = pick(triples);
            const type = pick(["hyp", "leg"]);
            if (type === "hyp") {
                return { question: `Right triangle legs ${a} and ${b}. Find hypotenuse.`, answer: c, type: "procedural",
                    explanation: `a² + b² = c². ${a}² + ${b}² = ${a*a} + ${b*b} = ${c*c}. c = ${c}` };
            } else {
                return { question: `Right triangle: leg ${a}, hypotenuse ${c}. Find other leg.`, answer: b, type: "procedural",
                    explanation: `a² + b² = c². ${a}² + b² = ${c}². b² = ${c*c} - ${a*a} = ${b*b}. b = ${b}` };
            }
        },
        "Angles and Lines": () => {
            const type = pick(["complementary", "supplementary", "vertical", "parallel"]);
            if (type === "complementary") {
                const angle1 = rand(10, 80);
                const angle2 = 90 - angle1;
                return { question: `Two complementary angles: one is ${angle1}°. Find the other.`, answer: angle2, type: "procedural",
                    explanation: `Complementary angles add to 90°. 90° - ${angle1}° = ${angle2}°` };
            } else if (type === "supplementary") {
                const angle1 = rand(30, 150);
                const angle2 = 180 - angle1;
                return { question: `Two supplementary angles: one is ${angle1}°. Find the other.`, answer: angle2, type: "procedural",
                    explanation: `Supplementary angles add to 180°. 180° - ${angle1}° = ${angle2}°` };
            } else if (type === "vertical") {
                const angle = rand(20, 160);
                return { question: `Two lines intersect. One angle is ${angle}°. What is the vertical angle?`, answer: angle, type: "conceptual",
                    explanation: `Vertical angles are equal. The vertical angle is also ${angle}°.` };
            } else {
                const angle = rand(40, 140);
                const type2 = pick(["corresponding", "alternate"]);
                return { question: `Parallel lines cut by a transversal. One angle is ${angle}°. Find the ${type2} angle.`, answer: angle, type: "conceptual",
                    explanation: `${type2.charAt(0).toUpperCase() + type2.slice(1)} angles with parallel lines are equal: ${angle}°` };
            }
        },
        "Algebraic Expressions": () => {
            const type = pick(["evaluate", "simplify", "translate"]);
            if (type === "evaluate") {
                const a = rand(2, 5);
                const b = rand(1, 10);
                const x = rand(2, 6);
                const answer = a * x + b;
                return { question: `Evaluate ${a}x + ${b} when x = ${x}`, answer, type: "procedural",
                    explanation: `Substitute x = ${x}: ${a}(${x}) + ${b} = ${a * x} + ${b} = ${answer}` };
            } else if (type === "simplify") {
                const a = rand(2, 6);
                const b = rand(1, 5);
                const c = rand(1, 4);
                const d = rand(1, 5);
                return { question: `Simplify: ${a}x + ${b} + ${c}x + ${d}`, answer: `${a + c}x + ${b + d}`, type: "procedural",
                    options: [`${a + c}x + ${b + d}`, `${a * c}x + ${b + d}`, `${a + c}x + ${b * d}`, `${a + b}x + ${c + d}`],
                    explanation: `Combine like terms: (${a} + ${c})x + (${b} + ${d}) = ${a + c}x + ${b + d}` };
            } else {
                const templates = [
                    { phrase: "5 more than a number x", expr: "x + 5" },
                    { phrase: "3 times a number x", expr: "3x" },
                    { phrase: "a number x decreased by 7", expr: "x - 7" },
                    { phrase: "twice a number x plus 4", expr: "2x + 4" }
                ];
                const t = pick(templates);
                return { question: `Write as an expression: "${t.phrase}"`, answer: t.expr, type: "conceptual",
                    options: ["x + 5", "3x", "x - 7", "2x + 4"],
                    explanation: `"${t.phrase}" translates to ${t.expr}` };
            }
        },
        "Surface Area": () => {
            const type = pick(["cube", "rectangular_prism", "cylinder"]);
            if (type === "cube") {
                const s = rand(2, 6);
                const sa = 6 * s * s;
                return { question: `Find the surface area of a cube with side length ${s}.`, answer: sa, type: "procedural",
                    explanation: `SA = 6s² = 6 × ${s}² = 6 × ${s*s} = ${sa}` };
            } else if (type === "rectangular_prism") {
                const l = rand(3, 6), w = rand(2, 5), h = rand(2, 4);
                const sa = 2 * (l*w + l*h + w*h);
                return { question: `Surface area of a box: length=${l}, width=${w}, height=${h}?`, answer: sa, type: "procedural",
                    explanation: `SA = 2(lw + lh + wh) = 2(${l*w} + ${l*h} + ${w*h}) = 2(${l*w + l*h + w*h}) = ${sa}` };
            } else {
                const r = rand(2, 5), h = rand(3, 8);
                const sa = Math.round(2 * Math.PI * r * (r + h));
                return { question: `Surface area of cylinder: radius=${r}, height=${h}? (Round to nearest whole, use π≈3.14)`, answer: sa, type: "procedural",
                    explanation: `SA = 2πr(r+h) = 2×3.14×${r}×${r+h} ≈ ${sa}` };
            }
        },
        "Two-Way Tables": () => {
            const type = pick(["read", "total", "relative"]);
            const a = rand(10, 25), b = rand(15, 30), c = rand(12, 22), d = rand(8, 18);
            if (type === "read") {
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. How many boys like sports?`,
                    answer: a, type: "conceptual",
                    explanation: `Read directly from the table: Boys who like Sports = ${a}` };
            } else if (type === "total") {
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. Total boys?`,
                    answer: a + b, type: "procedural",
                    explanation: `Total boys = ${a} + ${b} = ${a + b}` };
            } else {
                const total = a + b + c + d;
                const pct = Math.round((a / total) * 100);
                return { question: `Table: Boys-Sports=${a}, Boys-Music=${b}, Girls-Sports=${c}, Girls-Music=${d}. What percent are boys who like sports?`,
                    answer: pct, type: "procedural",
                    explanation: `Total = ${total}. Boys-Sports/Total = ${a}/${total} = ${pct}%` };
            }
        },
        "Scatter Plots": () => {
            const type = pick(["correlation", "trend", "outlier"]);
            if (type === "correlation") {
                const corr = pick(["positive", "negative", "none"]);
                const desc = corr === "positive" ? "points go up from left to right" :
                            corr === "negative" ? "points go down from left to right" :
                            "points are scattered randomly";
                return { question: `A scatter plot shows ${desc}. What type of correlation?`, answer: corr, type: "conceptual",
                    options: ["positive", "negative", "none"],
                    explanation: `When ${desc}, the correlation is ${corr}.` };
            } else if (type === "trend") {
                const scenarios = [
                    { desc: "hours studied vs. test score", trend: "positive" },
                    { desc: "temperature vs. hot chocolate sales", trend: "negative" },
                    { desc: "age vs. height (for children)", trend: "positive" },
                    { desc: "price vs. quantity demanded", trend: "negative" }
                ];
                const s = pick(scenarios);
                return { question: `What correlation would you expect: ${s.desc}?`, answer: s.trend, type: "reasoning",
                    options: ["positive", "negative", "none"],
                    explanation: `${s.desc} shows a ${s.trend} correlation.` };
            } else {
                const points = [[2, 3], [3, 5], [4, 6], [5, 8], [6, 9], [4, 20]];
                return { question: `Points: (2,3), (3,5), (4,6), (5,8), (6,9), (4,20). Which is the outlier?`, answer: "(4, 20)", type: "conceptual",
                    options: ["(2, 3)", "(4, 6)", "(4, 20)", "(6, 9)"],
                    explanation: `(4, 20) is far from the pattern of other points, making it an outlier.` };
            }
        },
        "Box Plots": () => {
            const type = pick(["identify", "IQR", "compare"]);
            const data = [12, 15, 18, 22, 25, 28, 30, 35, 40];
            const min = data[0], q1 = data[2], median = data[4], q3 = data[6], max = data[8];
            if (type === "identify") {
                const part = pick(["minimum", "Q1", "median", "Q3", "maximum"]);
                const values = { minimum: min, Q1: q1, median: median, Q3: q3, maximum: max };
                return { question: `Data: ${data.join(", ")}. What is the ${part}?`, answer: values[part], type: "procedural",
                    explanation: `${part} = ${values[part]}. Min=${min}, Q1=${q1}, Med=${median}, Q3=${q3}, Max=${max}` };
            } else if (type === "IQR") {
                const iqr = q3 - q1;
                return { question: `Data: ${data.join(", ")}. What is the IQR (Interquartile Range)?`, answer: iqr, type: "procedural",
                    explanation: `IQR = Q3 - Q1 = ${q3} - ${q1} = ${iqr}` };
            } else {
                const range = max - min;
                return { question: `Data: ${data.join(", ")}. What is the range?`, answer: range, type: "procedural",
                    explanation: `Range = Max - Min = ${max} - ${min} = ${range}` };
            }
        },
        "Probability Basics": () => {
            const type = pick(["simple", "complement", "word"]);
            if (type === "simple") {
                const favorable = rand(1, 5), total = favorable + rand(2, 6);
                return { question: `A bag has ${favorable} red and ${total - favorable} blue marbles. P(red)?`, answer: `${favorable}/${total}`, type: "procedural",
                    options: [`${favorable}/${total}`, `${total - favorable}/${total}`, `${favorable}/${total - favorable}`, `1/${total}`],
                    explanation: `P(red) = favorable/total = ${favorable}/${total}` };
            } else if (type === "complement") {
                const pct = rand(20, 80);
                const complement = 100 - pct;
                return { question: `If P(rain) = ${pct}%, what is P(no rain)?`, answer: `${complement}%`, type: "procedural",
                    options: [`${complement}%`, `${pct}%`, `${100 - complement}%`, `${pct / 2}%`],
                    explanation: `P(no rain) = 100% - P(rain) = 100% - ${pct}% = ${complement}%` };
            } else {
                const dice = rand(1, 6);
                return { question: `Roll a fair die. What is P(rolling a ${dice})?`, answer: "1/6", type: "conceptual",
                    options: ["1/6", "1/3", "1/2", "6/6"],
                    explanation: `Each number 1-6 has equal chance: P(${dice}) = 1/6` };
            }
        },
        "Irrational Numbers": () => {
            const type = pick(["identify", "approximate", "compare", "classify"]);
            if (type === "identify") {
                const irrational = pick(["√2", "√3", "√5", "π", "√7"]);
                return { question: `Is ${irrational} rational or irrational?`, answer: "Irrational", type: "conceptual",
                    options: ["Rational", "Irrational"],
                    explanation: `${irrational} cannot be written as a fraction of integers, so it's irrational.` };
            } else if (type === "approximate") {
                const roots = { 2: 1.414, 3: 1.732, 5: 2.236, 7: 2.646, 10: 3.162 };
                const n = pick([2, 3, 5, 7, 10]);
                return { question: `Approximate √${n} to 3 decimal places.`, answer: roots[n], type: "procedural",
                    options: [roots[n], roots[n] + 0.1, roots[n] - 0.1, n / 2],
                    explanation: `√${n} ≈ ${roots[n]}` };
            } else if (type === "compare") {
                const a = rand(2, 4);
                const b = rand(a + 1, a + 3);
                const sqrtA = Math.sqrt(a);
                const larger = sqrtA > b / 2 ? `√${a}` : `${b}/2`;
                return { question: `Which is larger: √${a} or ${b}/2?`, answer: larger, type: "reasoning",
                    options: [`√${a}`, `${b}/2`],
                    explanation: `√${a} ≈ ${sqrtA.toFixed(2)}, ${b}/2 = ${b / 2}. ${larger} is larger.` };
            } else {
                const nums = [
                    { num: "0.333...", type: "Rational" },
                    { num: "0.141421356...", type: "Irrational" },
                    { num: "3/7", type: "Rational" },
                    { num: "π", type: "Irrational" },
                    { num: "√16", type: "Rational" },
                    { num: "√15", type: "Irrational" }
                ];
                const n = pick(nums);
                return { question: `Classify: ${n.num}`, answer: n.type, type: "conceptual",
                    options: ["Rational", "Irrational"],
                    explanation: n.type === "Rational" ? `${n.num} can be written as a fraction.` : `${n.num} has a non-repeating, non-terminating decimal.` };
            }
        },
        "Cube Roots": () => {
            const type = pick(["perfect", "estimate", "negative"]);
            if (type === "perfect") {
                const cubes = [1, 8, 27, 64, 125, 216];
                const roots = [1, 2, 3, 4, 5, 6];
                const idx = rand(0, 5);
                return { question: `What is ∛${cubes[idx]}?`, answer: roots[idx], type: "procedural",
                    options: [roots[idx], roots[idx] + 1, roots[idx] - 1, cubes[idx] / 3].filter((v,i,a) => a.indexOf(v) === i),
                    explanation: `∛${cubes[idx]} = ${roots[idx]} because ${roots[idx]}³ = ${cubes[idx]}` };
            } else if (type === "estimate") {
                const root = rand(2, 4);
                const cube = root * root * root;
                const between = cube + rand(1, root * root);
                return { question: `Between which integers is ∛${between}?`, answer: `${root} and ${root + 1}`, type: "reasoning",
                    options: [`${root} and ${root + 1}`, `${root - 1} and ${root}`, `${root + 1} and ${root + 2}`, `1 and 2`],
                    explanation: `${root}³ = ${cube}, ${root + 1}³ = ${(root + 1) ** 3}. Since ${cube} < ${between} < ${(root + 1) ** 3}, ∛${between} is between ${root} and ${root + 1}.` };
            } else {
                const root = rand(2, 4);
                const cube = root * root * root;
                return { question: `What is ∛-${cube}?`, answer: -root, type: "procedural",
                    options: [-root, root, -cube, cube / root],
                    explanation: `∛-${cube} = -${root} because (-${root})³ = -${cube}` };
            }
        },
        "Compound Probability": () => {
            const type = pick(["and_independent", "or_mutually_exclusive", "with_replacement", "without_replacement"]);
            if (type === "and_independent") {
                const p1 = pick([1, 2, 3]);
                const p2 = pick([1, 2, 3]);
                const d = 6;
                return { question: `Two dice are rolled. P(first shows ${p1} AND second shows ${p2})?`, answer: `1/${d * d}`, type: "procedural",
                    options: [`1/${d * d}`, `2/${d}`, `1/${d}`, `${p1 + p2}/${d * d}`],
                    explanation: `P(A and B) = P(A) × P(B) = 1/${d} × 1/${d} = 1/${d * d}` };
            } else if (type === "or_mutually_exclusive") {
                const n1 = rand(1, 3), n2 = rand(4, 6);
                return { question: `Roll a die. P(${n1} OR ${n2})?`, answer: "2/6", type: "procedural",
                    options: ["2/6", "1/6", "1/36", "12/6"],
                    explanation: `P(A or B) = P(A) + P(B) = 1/6 + 1/6 = 2/6 = 1/3` };
            } else if (type === "with_replacement") {
                const red = rand(2, 4), blue = rand(2, 4);
                const total = red + blue;
                return { question: `Bag: ${red} red, ${blue} blue. Draw one, replace, draw again. P(both red)?`, answer: `${red * red}/${total * total}`, type: "procedural",
                    explanation: `With replacement: P(red, red) = ${red}/${total} × ${red}/${total} = ${red * red}/${total * total}` };
            } else {
                const red = 3, blue = 2;
                const total = red + blue;
                return { question: `Bag: ${red} red, ${blue} blue. Draw two without replacing. P(both red)?`, answer: `${red * (red - 1)}/${total * (total - 1)}`, type: "procedural",
                    options: [`${red * (red - 1)}/${total * (total - 1)}`, `${red * red}/${total * total}`, `${red}/${total}`, `2/${total}`],
                    explanation: `Without replacement: P = ${red}/${total} × ${red - 1}/${total - 1} = ${red * (red - 1)}/${total * (total - 1)}` };
            }
        },
        "Sampling Methods": () => {
            const type = pick(["identify", "bias", "best_method"]);
            const methods = [
                { name: "Simple Random", desc: "Every member has equal chance of being selected" },
                { name: "Stratified", desc: "Population divided into groups, samples taken from each" },
                { name: "Systematic", desc: "Select every nth member from a list" },
                { name: "Convenience", desc: "Use easily available members (often biased)" }
            ];
            if (type === "identify") {
                const method = pick(methods);
                return { question: `"${method.desc}" describes which sampling method?`, answer: method.name, type: "conceptual",
                    options: methods.map(m => m.name),
                    explanation: `${method.name} sampling: ${method.desc}` };
            } else if (type === "bias") {
                const scenarios = [
                    { scenario: "Survey only honors students about school satisfaction", biased: true, reason: "Only surveys high-achieving students" },
                    { scenario: "Randomly select 100 names from all student IDs", biased: false, reason: "Every student has equal chance" },
                    { scenario: "Ask people leaving a gym about exercise habits", biased: true, reason: "Only surveys gym-goers" }
                ];
                const s = pick(scenarios);
                return { question: `Is this sampling biased? "${s.scenario}"`, answer: s.biased ? "Yes" : "No", type: "reasoning",
                    options: ["Yes", "No"],
                    explanation: s.biased ? `Biased: ${s.reason}` : `Unbiased: ${s.reason}` };
            } else {
                const situations = [
                    { situation: "Survey opinions of all school grades", best: "Stratified", reason: "Sample from each grade ensures representation" },
                    { situation: "Quality check every 10th item on assembly line", best: "Systematic", reason: "Regular intervals for consistent checking" },
                    { situation: "Select lottery winners", best: "Simple Random", reason: "Everyone must have equal chance" }
                ];
                const s = pick(situations);
                return { question: `Best sampling method for: "${s.situation}"?`, answer: s.best, type: "reasoning",
                    options: methods.map(m => m.name),
                    explanation: `${s.best}: ${s.reason}` };
            }
        },
        "Transformations": () => {
            const type = pick(["translation", "reflection", "rotation", "identify"]);
            if (type === "translation") {
                const dx = rand(-5, 5), dy = rand(-5, 5);
                const x = rand(0, 5), y = rand(0, 5);
                return { question: `Point (${x}, ${y}) is translated ${dx > 0 ? "right" : "left"} ${Math.abs(dx)} and ${dy > 0 ? "up" : "down"} ${Math.abs(dy)}. New coordinates?`,
                    answer: `(${x + dx}, ${y + dy})`, type: "procedural",
                    options: [`(${x + dx}, ${y + dy})`, `(${x - dx}, ${y - dy})`, `(${x + dy}, ${y + dx})`, `(${dx}, ${dy})`],
                    explanation: `(${x} + ${dx}, ${y} + ${dy}) = (${x + dx}, ${y + dy})` };
            } else if (type === "reflection") {
                const x = rand(1, 5), y = rand(1, 5);
                const axis = pick(["x-axis", "y-axis"]);
                const newCoord = axis === "x-axis" ? `(${x}, ${-y})` : `(${-x}, ${y})`;
                return { question: `Reflect (${x}, ${y}) over the ${axis}. New coordinates?`, answer: newCoord, type: "procedural",
                    options: [`(${x}, ${-y})`, `(${-x}, ${y})`, `(${-x}, ${-y})`, `(${y}, ${x})`],
                    explanation: `Reflection over ${axis}: ${axis === "x-axis" ? "y changes sign" : "x changes sign"}. New point: ${newCoord}` };
            } else if (type === "rotation") {
                const x = rand(1, 4), y = rand(1, 4);
                const degrees = pick([90, 180, 270]);
                const rotations = {
                    90: `(${-y}, ${x})`,
                    180: `(${-x}, ${-y})`,
                    270: `(${y}, ${-x})`
                };
                return { question: `Rotate (${x}, ${y}) by ${degrees}° counterclockwise around the origin. New coordinates?`, answer: rotations[degrees], type: "procedural",
                    options: [rotations[90], rotations[180], rotations[270], `(${x}, ${y})`],
                    explanation: `${degrees}° rotation: (${x}, ${y}) → ${rotations[degrees]}` };
            } else {
                const transformations = [
                    { desc: "Slides a figure without changing size or orientation", name: "Translation" },
                    { desc: "Flips a figure over a line", name: "Reflection" },
                    { desc: "Turns a figure around a point", name: "Rotation" },
                    { desc: "Changes the size of a figure", name: "Dilation" }
                ];
                const t = pick(transformations);
                return { question: `"${t.desc}" describes which transformation?`, answer: t.name, type: "conceptual",
                    options: transformations.map(tr => tr.name),
                    explanation: `${t.name}: ${t.desc}` };
            }
        },
        "Similar Figures": () => {
            const type = pick(["identify", "find_side", "scale_factor", "perimeter"]);
            if (type === "identify") {
                const same = pick([true, false]);
                if (same) {
                    const ratio = pick([2, 3, 4]);
                    return { question: `Triangle A: 3, 4, 5. Triangle B: ${3 * ratio}, ${4 * ratio}, ${5 * ratio}. Are they similar?`, answer: "Yes", type: "conceptual",
                        options: ["Yes", "No"],
                        explanation: `All sides have the same ratio (1:${ratio}), so they are similar.` };
                } else {
                    return { question: `Triangle A: 3, 4, 5. Triangle B: 6, 8, 11. Are they similar?`, answer: "No", type: "conceptual",
                        options: ["Yes", "No"],
                        explanation: `Ratios: 3/6=0.5, 4/8=0.5, 5/11≈0.45. Not all equal, so not similar.` };
                }
            } else if (type === "find_side") {
                const scale = rand(2, 4);
                const a = rand(3, 6), b = rand(4, 8);
                const missing = a * scale;
                return { question: `Similar triangles. Small: ${a}, ${b}. Large: ?, ${b * scale}. Find the missing side.`, answer: missing, type: "procedural",
                    explanation: `Scale factor = ${b * scale}/${b} = ${scale}. Missing = ${a} × ${scale} = ${missing}` };
            } else if (type === "scale_factor") {
                const a1 = rand(2, 5), a2 = a1 * rand(2, 4);
                const scale = a2 / a1;
                return { question: `Similar rectangles. Small side: ${a1}. Large side: ${a2}. Scale factor?`, answer: scale, type: "procedural",
                    options: [scale, scale + 1, a2 - a1, a1 / a2],
                    explanation: `Scale factor = large/small = ${a2}/${a1} = ${scale}` };
            } else {
                const scale = rand(2, 3);
                const p1 = rand(10, 20);
                const p2 = p1 * scale;
                return { question: `Similar figures have scale factor ${scale}. If small perimeter = ${p1}, large perimeter = ?`, answer: p2, type: "procedural",
                    explanation: `Perimeters have the same scale factor. ${p1} × ${scale} = ${p2}` };
            }
        },
        "Parallel Lines and Transversals": () => {
            const type = pick(["corresponding", "alternate_interior", "same_side", "identify"]);
            if (type === "corresponding") {
                const angle = rand(40, 140);
                return { question: `Parallel lines cut by a transversal. One angle is ${angle}°. Its corresponding angle is?`, answer: `${angle}°`, type: "conceptual",
                    options: [`${angle}°`, `${180 - angle}°`, `${90 - angle}°`, `${angle + 90}°`],
                    explanation: `Corresponding angles are equal when lines are parallel. Both are ${angle}°.` };
            } else if (type === "alternate_interior") {
                const angle = rand(40, 140);
                return { question: `Parallel lines cut by a transversal. One alternate interior angle is ${angle}°. The other is?`, answer: `${angle}°`, type: "conceptual",
                    options: [`${angle}°`, `${180 - angle}°`, `${90}°`, `${angle / 2}°`],
                    explanation: `Alternate interior angles are equal. Both are ${angle}°.` };
            } else if (type === "same_side") {
                const angle = rand(40, 140);
                const supplement = 180 - angle;
                return { question: `Parallel lines cut by a transversal. One same-side interior angle is ${angle}°. The other is?`, answer: `${supplement}°`, type: "procedural",
                    options: [`${supplement}°`, `${angle}°`, `${90}°`, `${angle * 2}°`],
                    explanation: `Same-side interior angles are supplementary. ${angle}° + ${supplement}° = 180°` };
            } else {
                const pairs = [
                    { name: "Corresponding", property: "equal" },
                    { name: "Alternate Interior", property: "equal" },
                    { name: "Alternate Exterior", property: "equal" },
                    { name: "Same-Side Interior", property: "supplementary (sum to 180°)" }
                ];
                const pair = pick(pairs);
                return { question: `When parallel lines are cut by a transversal, ${pair.name} angles are...?`, answer: pair.property, type: "conceptual",
                    options: ["equal", "supplementary (sum to 180°)", "complementary (sum to 90°)", "vertical"],
                    explanation: `${pair.name} angles are ${pair.property}.` };
            }
        },
        "Volume of Cylinders Cones Spheres": () => {
            const type = pick(["cylinder", "cone", "sphere", "compare"]);
            if (type === "cylinder") {
                const r = rand(2, 5), h = rand(3, 8);
                const vol = Math.round(Math.PI * r * r * h * 100) / 100;
                return { question: `Cylinder: radius ${r}, height ${h}. Volume = ? (use π ≈ 3.14)`, answer: Math.round(3.14 * r * r * h * 100) / 100, type: "procedural",
                    explanation: `V = πr²h = 3.14 × ${r}² × ${h} = 3.14 × ${r * r} × ${h} = ${Math.round(3.14 * r * r * h * 100) / 100}` };
            } else if (type === "cone") {
                const r = rand(2, 4), h = rand(3, 6);
                const vol = Math.round(3.14 * r * r * h / 3 * 100) / 100;
                return { question: `Cone: radius ${r}, height ${h}. Volume = ? (use π ≈ 3.14)`, answer: vol, type: "procedural",
                    explanation: `V = (1/3)πr²h = (1/3) × 3.14 × ${r}² × ${h} = ${vol}` };
            } else if (type === "sphere") {
                const r = rand(2, 4);
                const vol = Math.round(4 / 3 * 3.14 * r * r * r * 100) / 100;
                return { question: `Sphere: radius ${r}. Volume = ? (use π ≈ 3.14)`, answer: vol, type: "procedural",
                    explanation: `V = (4/3)πr³ = (4/3) × 3.14 × ${r}³ = ${vol}` };
            } else {
                const r = rand(2, 3), h = r * 3;
                const vCyl = Math.round(3.14 * r * r * h);
                const vCone = Math.round(3.14 * r * r * h / 3);
                return { question: `Cylinder and cone have same radius (${r}) and height (${h}). Cylinder volume is how many times the cone volume?`, answer: 3, type: "reasoning",
                    options: [3, 2, 4, 1],
                    explanation: `Cylinder = πr²h, Cone = (1/3)πr²h. Cylinder is 3× the cone.` };
            }
        }
    },

    // TIER 5: Algebra I (8-9)
    5: {
        "Linear Equations": () => {
            const type = pick(["solve", "graph"]);
            if (type === "solve") {
                const x = rand(2, 10);
                const a = rand(2, 5), b = rand(3, 15);
                const c = a * x + b;
                return { question: `Solve: ${a}x + ${b} = ${c}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b}: ${a}x = ${c - b}. Divide by ${a}: x = ${(c-b)/a}` };
            } else {
                const m = pick([1, 2, -1, -2, 0.5]);
                const b = rand(-2, 3);
                return {
                    question: `What is the slope of this line?`,
                    answer: m, type: "conceptual",
                    options: [m, -m, b, m + 1].filter((v,i,arr) => arr.indexOf(v) === i).slice(0, 4),
                    explanation: `The line y = ${m}x + ${b} has slope ${m}.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, lines: [{ equation: { m, b } }] } }
                };
            }
        },
        Systems: () => {
            const x = rand(2, 8), y = rand(2, 8);
            const type = pick(["elimination", "substitution"]);
            if (type === "elimination") {
                return { question: `x + y = ${x + y} and x - y = ${x - y}. Find x.`, answer: x, type: "procedural",
                    explanation: `Add equations: 2x = ${2*x}, so x = ${x}` };
            } else {
                const a = rand(2, 4);
                return { question: `${a}x + y = ${a*x + y} and x = ${x}. Find y.`, answer: y, type: "procedural",
                    explanation: `Substitute x=${x}: ${a}(${x}) + y = ${a*x + y}. ${a*x} + y = ${a*x + y}. y = ${y}` };
            }
        },
        Factoring: () => {
            const type = pick(["trinomial", "difference"]);
            if (type === "trinomial") {
                const a = rand(1, 6), b = rand(1, 6);
                const sum = a + b, prod = a * b;
                return { question: `Factor: x² + ${sum}x + ${prod}`, answer: `(x+${a})(x+${b})`, type: "procedural",
                    options: [`(x+${a})(x+${b})`, `(x+${sum})(x+1)`, `(x-${a})(x-${b})`, `(x+${prod})(x+1)`],
                    explanation: `Find two numbers that multiply to ${prod} and add to ${sum}: ${a} and ${b}. Factor: (x+${a})(x+${b})` };
            } else {
                const a = rand(2, 8);
                return { question: `Factor: x² - ${a*a}`, answer: `(x+${a})(x-${a})`, type: "procedural",
                    options: [`(x+${a})(x-${a})`, `(x-${a})²`, `(x+${a})²`, `(x-${a*a})(x+1)`],
                    explanation: `Difference of squares: x² - ${a}² = (x+${a})(x-${a})` };
            }
        },
        Functions: () => {
            const a = rand(2, 5), b = rand(-5, 10);
            const x = rand(1, 6);
            const answer = a * x + b;
            return { question: `If f(x) = ${a}x ${b >= 0 ? '+' : ''} ${b}, what is f(${x})?`, answer, type: "procedural",
                explanation: `f(${x}) = ${a}(${x}) + ${b} = ${a*x} + ${b} = ${answer}` };
        },
        Inequalities: () => {
            const a = rand(2, 5), b = rand(5, 20);
            const boundary = b / a;
            const dir = pick(["<", ">", "≤", "≥"]);
            return { question: `Solve: ${a}x ${dir} ${b}`, answer: `x ${dir} ${boundary}`, type: "procedural",
                options: [`x ${dir} ${boundary}`, `x ${dir === '<' ? '>' : dir === '>' ? '<' : dir === '≤' ? '≥' : '≤'} ${boundary}`, `x ${dir} ${-boundary}`, `x ${dir} ${a}`],
                explanation: `Divide both sides by ${a}: x ${dir} ${boundary}` };
        },
        "Rational Functions": () => {
            const type = pick(["simplify", "domain", "asymptote"]);
            if (type === "simplify") {
                const a = rand(2, 6);
                return { question: `Simplify: ${a}x/(${a})`, answer: "x", type: "procedural",
                    options: ["x", `${a}x`, "1", `x/${a}`],
                    explanation: `${a}x/${a} = x (divide out common factor ${a})` };
            } else if (type === "domain") {
                const a = rand(2, 8);
                return { question: `For f(x) = 1/(x - ${a}), what value of x is NOT in the domain?`, answer: a, type: "conceptual",
                    explanation: `Cannot divide by zero. x - ${a} = 0 when x = ${a}. So x ≠ ${a}.` };
            } else {
                const a = rand(1, 5);
                return { question: `For f(x) = 1/(x - ${a}), what is the vertical asymptote?`, answer: `x = ${a}`, type: "conceptual",
                    options: [`x = ${a}`, `x = ${-a}`, `y = ${a}`, `y = 0`],
                    explanation: `Vertical asymptote where denominator = 0: x - ${a} = 0, so x = ${a}` };
            }
        },
        Radicals: () => {
            const type = pick(["simplify", "add", "multiply"]);
            if (type === "simplify") {
                const outside = rand(2, 5), inside = rand(2, 7);
                const radicand = outside * outside * inside;
                return { question: `Simplify: √${radicand}`, answer: `${outside}√${inside}`, type: "procedural",
                    options: [`${outside}√${inside}`, `${inside}√${outside}`, `${outside * inside}`, `√${radicand}`],
                    explanation: `√${radicand} = √(${outside}² × ${inside}) = ${outside}√${inside}` };
            } else if (type === "add") {
                const coeff1 = rand(2, 5), coeff2 = rand(2, 5), inside = rand(2, 7);
                const sum = coeff1 + coeff2;
                return { question: `Simplify: ${coeff1}√${inside} + ${coeff2}√${inside}`, answer: `${sum}√${inside}`, type: "procedural",
                    options: [`${sum}√${inside}`, `${coeff1 * coeff2}√${inside}`, `${sum}√${inside * 2}`, `√${inside * sum}`],
                    explanation: `Like terms: (${coeff1} + ${coeff2})√${inside} = ${sum}√${inside}` };
            } else {
                const a = rand(2, 5), b = rand(2, 6);
                const product = a * b;
                return { question: `Simplify: √${a} × √${b}`, answer: `√${product}`, type: "procedural",
                    options: [`√${product}`, `√${a + b}`, `${a}√${b}`, `${b}√${a}`],
                    explanation: `√${a} × √${b} = √(${a} × ${b}) = √${product}` };
            }
        },
        "Exponential Functions": () => {
            const type = pick(["evaluate", "growth_decay", "identify"]);
            if (type === "evaluate") {
                const base = rand(2, 4), exp = rand(2, 4);
                const result = Math.pow(base, exp);
                return { question: `If f(x) = ${base}^x, find f(${exp}).`, answer: result, type: "procedural",
                    explanation: `f(${exp}) = ${base}^${exp} = ${result}` };
            } else if (type === "growth_decay") {
                const init = rand(100, 500), rate = rand(5, 20);
                const isGrowth = pick([true, false]);
                const factor = isGrowth ? 1 + rate/100 : 1 - rate/100;
                const years = 2;
                const final = Math.round(init * Math.pow(factor, years));
                return { question: `Initial value ${init}, ${isGrowth ? "growth" : "decay"} ${rate}% per year. Value after ${years} years?`, answer: final, type: "procedural",
                    explanation: `${init} × ${factor.toFixed(2)}^${years} = ${init} × ${Math.pow(factor, years).toFixed(3)} ≈ ${final}` };
            } else {
                const a = rand(2, 5);
                const isGrowth = pick([true, false]);
                const b = isGrowth ? 1 + rand(1, 5)/10 : rand(1, 9)/10;
                return { question: `y = ${a}(${b.toFixed(1)})^x represents growth or decay?`, answer: isGrowth ? "growth" : "decay", type: "conceptual",
                    options: ["growth", "decay"],
                    explanation: `Base ${b.toFixed(1)} is ${b > 1 ? "> 1, so growth" : "< 1, so decay"}` };
            }
        },
        "Arithmetic Sequences": () => {
            const type = pick(["find_term", "find_d", "formula"]);
            const a1 = rand(2, 10), d = rand(2, 6);
            if (type === "find_term") {
                const n = rand(5, 10);
                const an = a1 + (n - 1) * d;
                return { question: `Arithmetic sequence: first term ${a1}, common difference ${d}. Find the ${n}th term.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ + (n-1)d = ${a1} + (${n}-1)(${d}) = ${a1} + ${(n-1)*d} = ${an}` };
            } else if (type === "find_d") {
                const seq = [a1, a1 + d, a1 + 2*d, a1 + 3*d];
                return { question: `Find common difference: ${seq.join(", ")}, ...`, answer: d, type: "procedural",
                    explanation: `d = ${seq[1]} - ${seq[0]} = ${d}` };
            } else {
                const seq = [a1, a1 + d, a1 + 2*d];
                return { question: `Sequence: ${seq.join(", ")}, ... Write the formula for the nth term.`, answer: `${a1} + ${d}(n-1)`, type: "conceptual",
                    options: [`${a1} + ${d}(n-1)`, `${a1}n + ${d}`, `${d}n + ${a1}`, `${a1} × ${d}^(n-1)`],
                    explanation: `aₙ = a₁ + (n-1)d = ${a1} + ${d}(n-1)` };
            }
        },
        "Geometric Sequences": () => {
            const type = pick(["find_term", "find_r", "formula"]);
            const a1 = rand(2, 5), r = rand(2, 4);
            if (type === "find_term") {
                const n = rand(4, 6);
                const an = a1 * Math.pow(r, n - 1);
                return { question: `Geometric sequence: first term ${a1}, common ratio ${r}. Find the ${n}th term.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ × r^(n-1) = ${a1} × ${r}^${n-1} = ${a1} × ${Math.pow(r, n-1)} = ${an}` };
            } else if (type === "find_r") {
                const seq = [a1, a1 * r, a1 * r * r];
                return { question: `Find common ratio: ${seq.join(", ")}, ...`, answer: r, type: "procedural",
                    explanation: `r = ${seq[1]}/${seq[0]} = ${r}` };
            } else {
                return { question: `Geometric sequence with a₁ = ${a1} and r = ${r}. Which formula?`, answer: `${a1} × ${r}^(n-1)`, type: "conceptual",
                    options: [`${a1} × ${r}^(n-1)`, `${a1} + ${r}(n-1)`, `${a1}n × ${r}`, `${r} × ${a1}^(n-1)`],
                    explanation: `Geometric: aₙ = a₁ × r^(n-1) = ${a1} × ${r}^(n-1)` };
            }
        },
        "Compound Interest": () => {
            const type = pick(["annual", "multiple", "formula"]);
            const P = pick([100, 200, 500, 1000]);
            const r = pick([5, 6, 8, 10]);
            if (type === "annual") {
                const t = rand(1, 3);
                const A = Math.round(P * Math.pow(1 + r/100, t));
                return { question: `$${P} at ${r}% annual interest compounded yearly for ${t} year${t > 1 ? 's' : ''}. Final amount?`, answer: A, type: "procedural",
                    explanation: `A = P(1 + r)^t = ${P}(1.${r.toString().padStart(2, '0')})^${t} ≈ $${A}` };
            } else if (type === "multiple") {
                const n = pick([2, 4, 12]); // semiannual, quarterly, monthly
                const nName = n === 2 ? "semiannually" : n === 4 ? "quarterly" : "monthly";
                const t = 1;
                const A = Math.round(P * Math.pow(1 + r/(100*n), n*t));
                return { question: `$${P} at ${r}% compounded ${nName} for 1 year. Final amount?`, answer: A, type: "procedural",
                    explanation: `A = P(1 + r/n)^(nt) = ${P}(1 + ${r/100}/${n})^${n} ≈ $${A}` };
            } else {
                return { question: `Which formula calculates compound interest?`, answer: "A = P(1 + r/n)^(nt)", type: "conceptual",
                    options: ["A = P(1 + r/n)^(nt)", "A = P + Prt", "A = P × r × t", "A = P(1 + rt)"],
                    explanation: `Compound interest: A = P(1 + r/n)^(nt). Simple interest is A = P(1 + rt).` };
            }
        },
        "Domain and Range": () => {
            const type = pick(["linear", "quadratic", "rational"]);
            if (type === "linear") {
                const m = rand(-5, 5), b = rand(-10, 10);
                return { question: `What is the domain of f(x) = ${m}x + ${b}?`, answer: "all real numbers", type: "conceptual",
                    options: ["all real numbers", "x ≥ 0", "x ≤ 0", "x ≠ 0"],
                    explanation: `Linear functions have domain of all real numbers (no restrictions).` };
            } else if (type === "quadratic") {
                const a = pick([-1, 1, 2, -2]);
                const vertex = rand(-5, 5);
                const range = a > 0 ? `y ≥ ${vertex}` : `y ≤ ${vertex}`;
                return { question: `Parabola opens ${a > 0 ? "up" : "down"} with vertex at y = ${vertex}. What is the range?`, answer: range, type: "conceptual",
                    options: [`y ≥ ${vertex}`, `y ≤ ${vertex}`, "all real numbers", `y ≠ ${vertex}`],
                    explanation: `Opens ${a > 0 ? "up" : "down"} from vertex, so range is ${range}` };
            } else {
                const a = rand(1, 5);
                return { question: `What is the domain of f(x) = 1/(x - ${a})?`, answer: `x ≠ ${a}`, type: "conceptual",
                    options: [`x ≠ ${a}`, "all real numbers", `x ≥ ${a}`, `x > ${a}`],
                    explanation: `Cannot divide by 0. x - ${a} = 0 when x = ${a}, so x ≠ ${a}` };
            }
        },
        "Multi-Step Equations": () => {
            const type = pick(["two_step", "distribute", "variables_both_sides", "combine_like"]);
            const x = rand(2, 8);
            if (type === "two_step") {
                const a = rand(2, 5), b = rand(3, 10), c = a * x + b;
                return { question: `Solve: ${a}x + ${b} = ${c}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b}: ${a}x = ${c - b}. Divide by ${a}: x = ${x}` };
            } else if (type === "distribute") {
                const a = rand(2, 4), b = rand(1, 5), c = a * (x + b);
                return { question: `Solve: ${a}(x + ${b}) = ${c}`, answer: x, type: "procedural",
                    explanation: `Distribute: ${a}x + ${a * b} = ${c}. Subtract ${a * b}: ${a}x = ${c - a * b}. Divide: x = ${x}` };
            } else if (type === "variables_both_sides") {
                const a = rand(3, 6), b = rand(2, 4), c = rand(1, 10);
                const result = a * x + c;
                return { question: `Solve: ${a}x + ${c} = ${b}x + ${c + (a - b) * x}`, answer: x, type: "procedural",
                    explanation: `Subtract ${b}x: ${a - b}x + ${c} = ${c + (a - b) * x}. Subtract ${c}: ${a - b}x = ${(a - b) * x}. x = ${x}` };
            } else {
                const a = rand(2, 4), b = rand(1, 3), c = rand(5, 15);
                const sum = (a + b) * x + c;
                return { question: `Solve: ${a}x + ${b}x + ${c} = ${sum}`, answer: x, type: "procedural",
                    explanation: `Combine like terms: ${a + b}x + ${c} = ${sum}. Subtract ${c}: ${a + b}x = ${sum - c}. x = ${x}` };
            }
        },
        "Literal Equations": () => {
            const type = pick(["solve_for_x", "formula", "rearrange"]);
            if (type === "solve_for_x") {
                const formulas = [
                    { eq: "ax + b = c", solve: "x", answer: "(c - b)/a", steps: "Subtract b: ax = c - b. Divide by a: x = (c - b)/a" },
                    { eq: "y = mx + b", solve: "x", answer: "(y - b)/m", steps: "Subtract b: y - b = mx. Divide by m: x = (y - b)/m" },
                    { eq: "A = lw", solve: "w", answer: "A/l", steps: "Divide both sides by l: w = A/l" }
                ];
                const f = pick(formulas);
                return { question: `Solve ${f.eq} for ${f.solve}.`, answer: f.answer, type: "procedural",
                    options: [f.answer, `${f.solve} + ${f.answer}`, f.answer.split("/").reverse().join("/"), "Cannot solve"],
                    explanation: f.steps };
            } else if (type === "formula") {
                const formulas = [
                    { name: "Perimeter of rectangle", eq: "P = 2l + 2w", solve: "l", answer: "(P - 2w)/2" },
                    { name: "Area of triangle", eq: "A = ½bh", solve: "h", answer: "2A/b" },
                    { name: "Distance", eq: "d = rt", solve: "t", answer: "d/r" }
                ];
                const f = pick(formulas);
                return { question: `${f.name}: ${f.eq}. Solve for ${f.solve}.`, answer: f.answer, type: "procedural",
                    explanation: `Isolate ${f.solve}: ${f.solve} = ${f.answer}` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve for y: ${a}y - x = 0`, answer: `y = x/${a}`, type: "procedural",
                    options: [`y = x/${a}`, `y = ${a}x`, `y = x - ${a}`, `y = ${a}/x`],
                    explanation: `Add x: ${a}y = x. Divide by ${a}: y = x/${a}` };
            }
        },
        "Absolute Value Equations": () => {
            const type = pick(["basic", "with_constant", "no_solution"]);
            if (type === "basic") {
                const a = rand(2, 8);
                return { question: `Solve: |x| = ${a}`, answer: `x = ${a} or x = -${a}`, type: "procedural",
                    options: [`x = ${a} or x = -${a}`, `x = ${a}`, `x = -${a}`, "No solution"],
                    explanation: `|x| = ${a} means x = ${a} or x = -${a}` };
            } else if (type === "with_constant") {
                const a = rand(2, 6), b = rand(1, 5);
                const sol1 = a + b, sol2 = -a + b;
                return { question: `Solve: |x - ${b}| = ${a}`, answer: `x = ${sol1} or x = ${sol2}`, type: "procedural",
                    options: [`x = ${sol1} or x = ${sol2}`, `x = ${sol1}`, `x = ${sol2}`, "No solution"],
                    explanation: `x - ${b} = ${a} gives x = ${sol1}. x - ${b} = -${a} gives x = ${sol2}.` };
            } else {
                const a = rand(2, 8);
                return { question: `Solve: |x| = -${a}`, answer: "No solution", type: "conceptual",
                    options: [`x = ${a}`, `x = -${a}`, `x = ${a} or x = -${a}`, "No solution"],
                    explanation: `Absolute value cannot equal a negative number. No solution.` };
            }
        },
        "Graphing Linear Inequalities": () => {
            const type = pick(["boundary", "shading", "test_point", "system"]);
            if (type === "boundary") {
                const m = rand(1, 3), b = rand(-5, 5);
                const strict = pick([true, false]);
                const lineType = strict ? "dashed" : "solid";
                return { question: `For y ${strict ? "<" : "≤"} ${m}x + ${b}, the boundary line is...?`, answer: lineType, type: "conceptual",
                    options: ["dashed", "solid"],
                    explanation: `< or > uses dashed (not included). ≤ or ≥ uses solid (included). Answer: ${lineType}` };
            } else if (type === "shading") {
                const above = pick([true, false]);
                const symbol = above ? ">" : "<";
                const shade = above ? "above" : "below";
                return { question: `For y ${symbol} 2x + 1, shade...?`, answer: shade, type: "conceptual",
                    options: ["above", "below"],
                    explanation: `y ${symbol} means shade ${shade} the line.` };
            } else if (type === "test_point") {
                const m = rand(1, 2), b = rand(1, 5);
                const testX = 0, testY = 0;
                const isSolution = testY < m * testX + b;
                return { question: `Is (0, 0) a solution to y < ${m}x + ${b}?`, answer: isSolution ? "Yes" : "No", type: "reasoning",
                    options: ["Yes", "No"],
                    explanation: `Test: 0 < ${m}(0) + ${b} → 0 < ${b}. ${isSolution ? "True" : "False"}, so ${isSolution ? "yes" : "no"}.` };
            } else {
                return { question: `The solution to a system of linear inequalities is...?`, answer: "the overlapping shaded region", type: "conceptual",
                    options: ["the overlapping shaded region", "any shaded region", "the boundary lines", "a single point"],
                    explanation: `The solution is where all inequality regions overlap.` };
            }
        },
        "Systems by Graphing": () => {
            const x = rand(1, 5), y = rand(1, 5);
            const m1 = rand(1, 2), b1 = y - m1 * x;
            const m2 = rand(-2, -1), b2 = y - m2 * x;
            return { question: `Lines y = ${m1}x + ${b1} and y = ${m2}x + ${b2} intersect at...?`, answer: `(${x}, ${y})`, type: "procedural",
                options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${-x}, ${y})`, `(${x}, ${-y})`],
                explanation: `Set equal: ${m1}x + ${b1} = ${m2}x + ${b2}. Solve: x = ${x}. Then y = ${m1}(${x}) + ${b1} = ${y}. Point: (${x}, ${y})` };
        },
        "Systems by Substitution": () => {
            const x = rand(2, 6), y = rand(1, 5);
            const a = rand(1, 3), b = rand(1, 3);
            return { question: `y = ${a}x - ${a * x - y} and ${b}x + y = ${b * x + y}. Find x using substitution.`, answer: x, type: "procedural",
                explanation: `Substitute first equation into second: ${b}x + (${a}x - ${a * x - y}) = ${b * x + y}. Solve for x = ${x}` };
        },
        "Systems by Elimination": () => {
            const x = rand(2, 5), y = rand(1, 4);
            const type = pick(["add", "subtract", "multiply"]);
            if (type === "add") {
                return { question: `x + y = ${x + y} and x - y = ${x - y}. Add equations to find x.`, answer: x, type: "procedural",
                    explanation: `Adding: 2x = ${2 * x}, so x = ${x}` };
            } else if (type === "subtract") {
                return { question: `2x + y = ${2 * x + y} and x + y = ${x + y}. Subtract to find x.`, answer: x, type: "procedural",
                    explanation: `Subtracting: x = ${x}` };
            } else {
                const a = 2;
                return { question: `${a}x + y = ${a * x + y} and x + y = ${x + y}. Find x.`, answer: x, type: "procedural",
                    explanation: `Subtract equations: ${a - 1}x = ${(a - 1) * x}, so x = ${x}` };
            }
        },
        "Correlation and Trend Lines": () => {
            const type = pick(["identify", "predict", "strength", "equation"]);
            if (type === "identify") {
                const correlations = [
                    { desc: "As x increases, y increases", type: "Positive" },
                    { desc: "As x increases, y decreases", type: "Negative" },
                    { desc: "No pattern between x and y", type: "None" }
                ];
                const c = pick(correlations);
                return { question: `"${c.desc}" describes what type of correlation?`, answer: c.type, type: "conceptual",
                    options: ["Positive", "Negative", "None"],
                    explanation: `${c.type} correlation: ${c.desc}` };
            } else if (type === "predict") {
                const m = rand(2, 5), b = rand(5, 20);
                const x = rand(5, 10);
                const y = m * x + b;
                return { question: `Trend line: y = ${m}x + ${b}. Predict y when x = ${x}.`, answer: y, type: "procedural",
                    explanation: `y = ${m}(${x}) + ${b} = ${m * x} + ${b} = ${y}` };
            } else if (type === "strength") {
                const r = pick([0.95, 0.75, 0.45, 0.15]);
                const strength = r > 0.8 ? "strong" : r > 0.5 ? "moderate" : "weak";
                return { question: `Correlation coefficient r = ${r}. How strong is the correlation?`, answer: strength, type: "conceptual",
                    options: ["strong", "moderate", "weak", "none"],
                    explanation: `|r| close to 1 = strong, close to 0 = weak. ${r} is ${strength}.` };
            } else {
                return { question: `A trend line that best fits scattered data is called the line of...?`, answer: "best fit", type: "conceptual",
                    options: ["best fit", "symmetry", "reflection", "slope"],
                    explanation: `The line of best fit minimizes distance to all points.` };
            }
        }
    },

    // TIER 6: Geometry (9-10)
    6: {
        Area: () => {
            const shape = pick(["rectangle", "triangle", "parallelogram"]);
            const a = rand(3, 12), b = rand(3, 12);
            let answer, explanation, question;
            if (shape === "rectangle") {
                answer = a * b;
                question = `Rectangle with length ${a} and width ${b}. Find area.`;
                explanation = `Area = length × width = ${a} × ${b} = ${answer}`;
            } else if (shape === "triangle") {
                answer = (a * b) / 2;
                question = `Triangle with base ${a} and height ${b}. Find area.`;
                explanation = `Area = ½ × base × height = ½ × ${a} × ${b} = ${answer}`;
            } else {
                answer = a * b;
                question = `Parallelogram with base ${a} and height ${b}. Find area.`;
                explanation = `Area = base × height = ${a} × ${b} = ${answer}`;
            }
            return { question, answer, type: "procedural", explanation };
        },
        Volume: () => {
            const shape = pick(["cube", "rectangular", "cylinder"]);
            if (shape === "cube") {
                const s = rand(2, 7);
                return { question: `Cube with side ${s}. Find volume.`, answer: s * s * s, type: "procedural",
                    explanation: `V = s³ = ${s}³ = ${s*s*s}` };
            } else if (shape === "rectangular") {
                const l = rand(2, 8), w = rand(2, 6), h = rand(2, 5);
                return { question: `Box with dimensions ${l} × ${w} × ${h}. Find volume.`, answer: l * w * h, type: "procedural",
                    explanation: `V = l × w × h = ${l} × ${w} × ${h} = ${l*w*h}` };
            } else {
                const r = rand(2, 5), h = rand(3, 8);
                return { question: `Cylinder: radius ${r}, height ${h}. Volume in terms of π?`, answer: `${r*r*h}π`, type: "procedural",
                    options: [`${r*r*h}π`, `${r*h}π`, `${2*r*r*h}π`, `${r*r}π`],
                    explanation: `V = πr²h = π(${r})²(${h}) = ${r*r*h}π` };
            }
        },
        Circles: () => {
            const r = rand(2, 10);
            const type = pick(["area", "circumference"]);
            if (type === "area") {
                return { question: `Circle radius ${r}. Area in terms of π?`, answer: `${r*r}π`, type: "procedural",
                    options: [`${r*r}π`, `${2*r}π`, `${r}π`, `${2*r*r}π`],
                    explanation: `A = πr² = π(${r})² = ${r*r}π` };
            } else {
                return { question: `Circle radius ${r}. Circumference in terms of π?`, answer: `${2*r}π`, type: "procedural",
                    options: [`${2*r}π`, `${r*r}π`, `${r}π`, `${4*r}π`],
                    explanation: `C = 2πr = 2π(${r}) = ${2*r}π` };
            }
        },
        Triangles: () => {
            const type = pick(["congruence", "angles"]);
            if (type === "congruence") {
                const rules = ["SSS", "SAS", "ASA", "AAS"];
                const invalid = "AAA";
                const answer = invalid;
                return { question: `Which does NOT prove triangle congruence?`, answer, type: "conceptual",
                    options: shuffle([...rules.slice(0, 3), invalid]),
                    explanation: `AAA proves similarity, not congruence. The triangles could be different sizes.` };
            } else {
                const a = rand(30, 80), b = rand(30, 80);
                const c = 180 - a - b;
                return { question: `Triangle angles: ${a}° and ${b}°. Find third angle.`, answer: c, type: "procedural",
                    explanation: `Angles sum to 180°. Third = 180 - ${a} - ${b} = ${c}°` };
            }
        },
        Trigonometry: () => {
            const triples = [[3,4,5], [5,12,13], [8,15,17]];
            const [opp, adj, hyp] = pick(triples);
            const func = pick(["sin", "cos", "tan"]);
            let answer, explanation;
            if (func === "sin") { answer = `${opp}/${hyp}`; explanation = `sin = opposite/hypotenuse = ${opp}/${hyp}`; }
            else if (func === "cos") { answer = `${adj}/${hyp}`; explanation = `cos = adjacent/hypotenuse = ${adj}/${hyp}`; }
            else { answer = `${opp}/${adj}`; explanation = `tan = opposite/adjacent = ${opp}/${adj}`; }
            return { question: `Right triangle: opposite=${opp}, adjacent=${adj}, hypotenuse=${hyp}. Find ${func}(θ).`, answer, type: "procedural",
                options: [`${opp}/${hyp}`, `${adj}/${hyp}`, `${opp}/${adj}`, `${hyp}/${opp}`], explanation };
        },
        Transformations: () => {
            const type = pick(["translate", "reflect", "rotate", "dilate"]);
            if (type === "translate") {
                const x = rand(1, 5), y = rand(1, 5);
                const dx = rand(2, 6), dy = rand(2, 6);
                return { question: `Point (${x}, ${y}) translated right ${dx} and up ${dy}. New point?`, answer: `(${x + dx}, ${y + dy})`, type: "procedural",
                    options: [`(${x + dx}, ${y + dy})`, `(${x - dx}, ${y + dy})`, `(${x + dx}, ${y - dy})`, `(${x + dy}, ${y + dx})`],
                    explanation: `Right ${dx}: x + ${dx} = ${x + dx}. Up ${dy}: y + ${dy} = ${y + dy}. New point: (${x + dx}, ${y + dy})` };
            } else if (type === "reflect") {
                const x = rand(1, 8), y = rand(1, 8);
                const axis = pick(["x-axis", "y-axis"]);
                const newPoint = axis === "x-axis" ? `(${x}, ${-y})` : `(${-x}, ${y})`;
                return { question: `Point (${x}, ${y}) reflected over the ${axis}. New point?`, answer: newPoint, type: "procedural",
                    options: [`(${x}, ${-y})`, `(${-x}, ${y})`, `(${-x}, ${-y})`, `(${y}, ${x})`],
                    explanation: `Reflect over ${axis}: ${axis === "x-axis" ? "negate y" : "negate x"}. New point: ${newPoint}` };
            } else if (type === "rotate") {
                const x = rand(1, 5), y = rand(1, 5);
                return { question: `Point (${x}, ${y}) rotated 180° about origin. New point?`, answer: `(${-x}, ${-y})`, type: "procedural",
                    options: [`(${-x}, ${-y})`, `(${x}, ${-y})`, `(${-x}, ${y})`, `(${y}, ${x})`],
                    explanation: `180° rotation: negate both coordinates. (${x}, ${y}) → (${-x}, ${-y})` };
            } else {
                const x = rand(1, 4), y = rand(1, 4);
                const scale = rand(2, 3);
                return { question: `Point (${x}, ${y}) dilated by factor ${scale} from origin. New point?`, answer: `(${x * scale}, ${y * scale})`, type: "procedural",
                    options: [`(${x * scale}, ${y * scale})`, `(${x + scale}, ${y + scale})`, `(${x * scale}, ${y})`, `(${x}, ${y * scale})`],
                    explanation: `Dilation by ${scale}: multiply both coordinates. (${x}, ${y}) → (${x * scale}, ${y * scale})` };
            }
        },
        Similarity: () => {
            const type = pick(["ratio", "find_side", "identify"]);
            if (type === "ratio") {
                const small = rand(3, 8), large = small * rand(2, 4);
                return { question: `Similar triangles have sides ${small} and ${large}. Scale factor?`, answer: large / small, type: "procedural",
                    explanation: `Scale factor = ${large}/${small} = ${large / small}` };
            } else if (type === "find_side") {
                const s1 = rand(4, 8), s2 = rand(6, 12), scale = rand(2, 3);
                const x = s2 * scale;
                return { question: `Similar triangles: sides ${s1} and ${s2} match to ${s1 * scale} and x. Find x.`, answer: x, type: "procedural",
                    explanation: `Scale factor = ${s1 * scale}/${s1} = ${scale}. So x = ${s2} × ${scale} = ${x}` };
            } else {
                return { question: `Two triangles have angles 30°, 60°, 90° and 30°, 60°, 90°. Are they similar?`, answer: "Yes", type: "conceptual",
                    options: ["Yes", "No", "Need more info"],
                    explanation: `AA Similarity: If two angles are equal, triangles are similar.` };
            }
        },
        Congruence: () => {
            const type = pick(["postulate", "identify", "corresponding"]);
            if (type === "postulate") {
                const postulates = ["SSS", "SAS", "ASA", "AAS", "HL"];
                const post = pick(postulates);
                const descriptions = {
                    "SSS": "all three sides equal",
                    "SAS": "two sides and included angle equal",
                    "ASA": "two angles and included side equal",
                    "AAS": "two angles and non-included side equal",
                    "HL": "hypotenuse and leg of right triangles equal"
                };
                return { question: `Which postulate: ${descriptions[post]}?`, answer: post, type: "conceptual",
                    options: postulates,
                    explanation: `${post}: ${descriptions[post]}` };
            } else if (type === "identify") {
                const given = pick(["3 sides", "2 sides and included angle", "2 angles and 1 side"]);
                const answers = { "3 sides": "SSS", "2 sides and included angle": "SAS", "2 angles and 1 side": "ASA or AAS" };
                return { question: `Given: ${given}. Which congruence can you prove?`, answer: answers[given], type: "reasoning",
                    options: ["SSS", "SAS", "ASA or AAS", "Cannot prove"],
                    explanation: `With ${given}, use ${answers[given]} to prove congruence.` };
            } else {
                return { question: `If △ABC ≅ △DEF, which side corresponds to BC?`, answer: "EF", type: "conceptual",
                    options: ["DE", "EF", "DF", "FE"],
                    explanation: `Corresponding parts: A↔D, B↔E, C↔F. So BC↔EF.` };
            }
        },
        Proofs: () => {
            const type = pick(["reason", "statement", "property"]);
            if (type === "reason") {
                const reasons = [
                    { statement: "If a = b and b = c, then a = c", reason: "Transitive Property" },
                    { statement: "If a = b, then b = a", reason: "Symmetric Property" },
                    { statement: "a = a", reason: "Reflexive Property" },
                    { statement: "If a = b, then a + c = b + c", reason: "Addition Property of Equality" }
                ];
                const r = pick(reasons);
                return { question: `"${r.statement}" uses which property?`, answer: r.reason, type: "conceptual",
                    options: ["Transitive Property", "Symmetric Property", "Reflexive Property", "Addition Property of Equality"],
                    explanation: `${r.reason}: ${r.statement}` };
            } else if (type === "statement") {
                return { question: `If ∠A and ∠B are supplementary and m∠A = 70°, what can you conclude?`, answer: "m∠B = 110°", type: "reasoning",
                    options: ["m∠B = 110°", "m∠B = 70°", "m∠B = 90°", "m∠B = 180°"],
                    explanation: `Supplementary angles sum to 180°. So m∠B = 180° - 70° = 110°` };
            } else {
                return { question: `Vertical angles are always:`, answer: "congruent", type: "conceptual",
                    options: ["congruent", "supplementary", "complementary", "adjacent"],
                    explanation: `Vertical Angles Theorem: Vertical angles are congruent.` };
            }
        },
        "Law of Sines": () => {
            const type = pick(["find_side", "find_angle", "formula"]);
            if (type === "formula") {
                return { question: `The Law of Sines states:`, answer: "a/sin(A) = b/sin(B) = c/sin(C)", type: "conceptual",
                    options: ["a/sin(A) = b/sin(B) = c/sin(C)", "a² + b² = c²", "a/b = c/d", "sin²(A) + cos²(A) = 1"],
                    explanation: `Law of Sines: a/sin(A) = b/sin(B) = c/sin(C)` };
            } else if (type === "find_side") {
                const A = 30, B = 60, a = 5;
                const b = Math.round(a * Math.sin(B * Math.PI/180) / Math.sin(A * Math.PI/180));
                return { question: `Triangle: A=30°, B=60°, a=5. Find b using Law of Sines.`, answer: b, type: "procedural",
                    explanation: `b/sin(60°) = 5/sin(30°) → b = 5 × sin(60°)/sin(30°) ≈ ${b}` };
            } else {
                return { question: `When do you use Law of Sines?`, answer: "When you know AAS, ASA, or SSA", type: "conceptual",
                    options: ["When you know AAS, ASA, or SSA", "When you know SAS", "When you know SSS", "Only for right triangles"],
                    explanation: `Law of Sines is used when you have angle-side pairs (AAS, ASA, SSA).` };
            }
        },
        "Law of Cosines": () => {
            const type = pick(["formula", "find_side", "when_to_use"]);
            if (type === "formula") {
                return { question: `Law of Cosines formula for side c:`, answer: "c² = a² + b² - 2ab·cos(C)", type: "conceptual",
                    options: ["c² = a² + b² - 2ab·cos(C)", "c² = a² + b²", "c = a + b", "c² = a² + b² + 2ab·cos(C)"],
                    explanation: `Law of Cosines: c² = a² + b² - 2ab·cos(C)` };
            } else if (type === "find_side") {
                const a = 5, b = 7, C = 60;
                const c = Math.round(Math.sqrt(a*a + b*b - 2*a*b*Math.cos(C * Math.PI/180)));
                return { question: `Triangle: a=5, b=7, C=60°. Find c using Law of Cosines.`, answer: c, type: "procedural",
                    explanation: `c² = 25 + 49 - 2(5)(7)cos(60°) = 74 - 35 = 39. c ≈ ${c}` };
            } else {
                return { question: `When do you use Law of Cosines?`, answer: "When you know SAS or SSS", type: "conceptual",
                    options: ["When you know SAS or SSS", "When you know AAS", "When you know ASA", "Only for right triangles"],
                    explanation: `Law of Cosines is used for SAS (find third side) or SSS (find an angle).` };
            }
        },
        "Coordinate Geometry": () => {
            const type = pick(["midpoint", "distance", "slope"]);
            if (type === "midpoint") {
                const x1 = rand(2, 10), y1 = rand(2, 10), x2 = rand(2, 10), y2 = rand(2, 10);
                const mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
                return { question: `Midpoint of (${x1}, ${y1}) and (${x2}, ${y2})?`, answer: `(${mx}, ${my})`, type: "procedural",
                    options: [`(${mx}, ${my})`, `(${(x1+x2)}, ${(y1+y2)})`, `(${x2-x1}, ${y2-y1})`, `(${Math.abs(x1-x2)}, ${Math.abs(y1-y2)})`],
                    explanation: `Midpoint = ((${x1}+${x2})/2, (${y1}+${y2})/2) = (${mx}, ${my})` };
            } else if (type === "distance") {
                const x1 = rand(1, 5), y1 = rand(1, 5), x2 = x1 + rand(3, 6), y2 = y1 + rand(3, 6);
                const dx = x2 - x1, dy = y2 - y1;
                const dist = Math.sqrt(dx*dx + dy*dy).toFixed(2);
                return { question: `Distance from (${x1}, ${y1}) to (${x2}, ${y2})?`, answer: parseFloat(dist), type: "procedural",
                    explanation: `d = √[(${x2}-${x1})² + (${y2}-${y1})²] = √[${dx}² + ${dy}²] = √${dx*dx + dy*dy} ≈ ${dist}` };
            } else {
                const x1 = rand(1, 5), y1 = rand(1, 5), x2 = x1 + rand(2, 5), y2 = y1 + rand(2, 8);
                const slope = (y2 - y1) / (x2 - x1);
                return { question: `Slope of line through (${x1}, ${y1}) and (${x2}, ${y2})?`, answer: parseFloat(slope.toFixed(2)), type: "procedural",
                    explanation: `m = (${y2}-${y1})/(${x2}-${x1}) = ${y2-y1}/${x2-x1} = ${slope.toFixed(2)}` };
            }
        },
        "Angle Bisectors": () => {
            const type = pick(["definition", "property", "calculate"]);
            if (type === "definition") {
                return { question: `An angle bisector divides an angle into...?`, answer: "two equal parts", type: "conceptual",
                    options: ["two equal parts", "two unequal parts", "a right angle", "three parts"],
                    explanation: `An angle bisector splits an angle into two congruent angles.` };
            } else if (type === "property") {
                return { question: `Points on an angle bisector are equidistant from the...?`, answer: "sides of the angle", type: "conceptual",
                    options: ["sides of the angle", "vertex", "opposite side", "other angles"],
                    explanation: `Any point on an angle bisector is equally far from both sides of the angle.` };
            } else {
                const angle = rand(4, 16) * 10;
                const half = angle / 2;
                return { question: `An angle bisector splits a ${angle}° angle. Each part measures...?`, answer: `${half}°`, type: "procedural",
                    options: [`${half}°`, `${angle}°`, `${angle * 2}°`, `${90 - half}°`],
                    explanation: `${angle}° ÷ 2 = ${half}°` };
            }
        },
        "Perpendicular Bisectors": () => {
            const type = pick(["definition", "property", "find_point"]);
            if (type === "definition") {
                return { question: `A perpendicular bisector of a segment...?`, answer: "passes through the midpoint at 90°", type: "conceptual",
                    options: ["passes through the midpoint at 90°", "passes through an endpoint", "is parallel to the segment", "bisects an angle"],
                    explanation: `A perpendicular bisector passes through the midpoint and forms a 90° angle with the segment.` };
            } else if (type === "property") {
                return { question: `Points on the perpendicular bisector of AB are equidistant from...?`, answer: "A and B", type: "conceptual",
                    options: ["A and B", "the midpoint only", "the origin", "the x-axis"],
                    explanation: `Any point on the perpendicular bisector is equally far from both endpoints.` };
            } else {
                const x1 = 0, y1 = 0, x2 = rand(2, 6) * 2, y2 = 0;
                const midX = (x1 + x2) / 2;
                return { question: `Segment from (${x1}, ${y1}) to (${x2}, ${y2}). Perpendicular bisector passes through...?`, answer: `(${midX}, any y)`, type: "reasoning",
                    options: [`(${midX}, any y)`, `(${x2}, 0)`, `(0, ${midX})`, `(${x1}, ${y1})`],
                    explanation: `Midpoint is (${midX}, 0). Perpendicular bisector is vertical line x = ${midX}.` };
            }
        },
        "Triangle Inequality": () => {
            const type = pick(["valid", "find_range", "identify"]);
            if (type === "valid") {
                const a = rand(3, 8), b = rand(3, 8);
                const valid = rand(Math.abs(a - b) + 1, a + b - 1);
                const invalid = a + b + rand(1, 3);
                const testC = pick([valid, invalid]);
                const isValid = testC < a + b && testC > Math.abs(a - b);
                return { question: `Can a triangle have sides ${a}, ${b}, ${testC}?`, answer: isValid ? "Yes" : "No", type: "reasoning",
                    options: ["Yes", "No"],
                    explanation: isValid ?
                        `Yes! ${a} + ${b} = ${a + b} > ${testC}, and ${a} + ${testC} > ${b}, and ${b} + ${testC} > ${a}.` :
                        `No! ${a} + ${b} = ${a + b} is not greater than ${testC}. Violates triangle inequality.` };
            } else if (type === "find_range") {
                const a = rand(4, 8), b = rand(3, 6);
                const min = Math.abs(a - b) + 1;
                const max = a + b - 1;
                return { question: `Sides ${a} and ${b}. Third side must be between...?`, answer: `${min} and ${max}`, type: "procedural",
                    options: [`${min} and ${max}`, `1 and ${a + b}`, `${a} and ${b}`, `0 and ${a * b}`],
                    explanation: `Third side c: |${a} - ${b}| < c < ${a} + ${b}, so ${Math.abs(a-b)} < c < ${a + b}. Range: ${min} to ${max}.` };
            } else {
                return { question: `Triangle Inequality Theorem states:`, answer: "sum of any two sides > third side", type: "conceptual",
                    options: ["sum of any two sides > third side", "all sides must be equal", "angles sum to 180°", "largest angle opposite longest side"],
                    explanation: `The sum of any two sides must be greater than the third side.` };
            }
        },
        "Triangle Centers": () => {
            const centers = [
                { name: "Centroid", formed: "medians", property: "center of gravity, divides medians 2:1" },
                { name: "Incenter", formed: "angle bisectors", property: "equidistant from all three sides" },
                { name: "Circumcenter", formed: "perpendicular bisectors", property: "equidistant from all three vertices" },
                { name: "Orthocenter", formed: "altitudes", property: "where all altitudes meet" }
            ];
            const center = pick(centers);
            const type = pick(["identify", "property"]);
            if (type === "identify") {
                return { question: `The ${center.name} is formed by the intersection of...?`, answer: center.formed, type: "conceptual",
                    options: ["medians", "angle bisectors", "perpendicular bisectors", "altitudes"],
                    explanation: `${center.name}: intersection of ${center.formed}.` };
            } else {
                return { question: `The ${center.name} of a triangle is...?`, answer: center.property, type: "conceptual",
                    options: centers.map(c => c.property),
                    explanation: `${center.name}: ${center.property}.` };
            }
        },
        "Midsegments": () => {
            const type = pick(["triangle", "length", "parallel"]);
            if (type === "triangle") {
                return { question: `A midsegment of a triangle connects...?`, answer: "midpoints of two sides", type: "conceptual",
                    options: ["midpoints of two sides", "a vertex to the opposite side", "two vertices", "the centroid to a vertex"],
                    explanation: `A midsegment connects the midpoints of two sides of a triangle.` };
            } else if (type === "length") {
                const base = rand(6, 16);
                const mid = base / 2;
                return { question: `Triangle base = ${base}. The midsegment parallel to it = ?`, answer: mid, type: "procedural",
                    options: [mid, base, base * 2, mid + 1],
                    explanation: `Midsegment = ½ × parallel side = ½ × ${base} = ${mid}` };
            } else {
                return { question: `A midsegment is parallel to which side?`, answer: "the third side (not connected to it)", type: "conceptual",
                    options: ["the third side (not connected to it)", "the longest side", "the shortest side", "no side"],
                    explanation: `The midsegment is parallel to the side it doesn't touch.` };
            }
        },
        "Inscribed Angles": () => {
            const type = pick(["relationship", "calculate", "diameter"]);
            if (type === "relationship") {
                return { question: `An inscribed angle is _____ the central angle with the same arc.`, answer: "half", type: "conceptual",
                    options: ["half", "equal to", "twice", "unrelated to"],
                    explanation: `Inscribed Angle = ½ × Central Angle (same arc).` };
            } else if (type === "calculate") {
                const central = rand(4, 16) * 10;
                const inscribed = central / 2;
                return { question: `Central angle = ${central}°. Inscribed angle on same arc = ?`, answer: `${inscribed}°`, type: "procedural",
                    options: [`${inscribed}°`, `${central}°`, `${central * 2}°`, `${180 - central}°`],
                    explanation: `Inscribed = ½ × Central = ½ × ${central}° = ${inscribed}°` };
            } else {
                return { question: `An inscribed angle that intercepts a semicircle measures...?`, answer: "90°", type: "conceptual",
                    options: ["90°", "180°", "45°", "60°"],
                    explanation: `Semicircle = 180° arc. Inscribed angle = ½ × 180° = 90°.` };
            }
        },
        "Arc Length": () => {
            const r = rand(3, 10);
            const degrees = pick([30, 45, 60, 90, 120, 180]);
            const arcLength = (degrees / 360) * 2 * 3.14 * r;
            const type = pick(["formula", "calculate"]);
            if (type === "formula") {
                return { question: `Arc length formula (in degrees):`, answer: "(θ/360) × 2πr", type: "conceptual",
                    options: ["(θ/360) × 2πr", "πr²", "2πr", "θ × r"],
                    explanation: `Arc length = (central angle/360°) × circumference = (θ/360) × 2πr` };
            } else {
                return { question: `Circle radius ${r}, central angle ${degrees}°. Arc length ≈ ? (π ≈ 3.14)`, answer: Math.round(arcLength * 100) / 100, type: "procedural",
                    explanation: `Arc = (${degrees}/360) × 2(3.14)(${r}) = (${degrees}/360) × ${(2 * 3.14 * r).toFixed(2)} ≈ ${(arcLength).toFixed(2)}` };
            }
        },
        "Sector Area": () => {
            const r = rand(3, 8);
            const degrees = pick([30, 45, 60, 90, 120, 180]);
            const area = (degrees / 360) * 3.14 * r * r;
            const type = pick(["formula", "calculate"]);
            if (type === "formula") {
                return { question: `Sector area formula (in degrees):`, answer: "(θ/360) × πr²", type: "conceptual",
                    options: ["(θ/360) × πr²", "πr²", "2πr", "(θ/360) × 2πr"],
                    explanation: `Sector area = (central angle/360°) × circle area = (θ/360) × πr²` };
            } else {
                return { question: `Circle radius ${r}, central angle ${degrees}°. Sector area ≈ ? (π ≈ 3.14)`, answer: Math.round(area * 100) / 100, type: "procedural",
                    explanation: `Area = (${degrees}/360) × 3.14 × ${r}² = (${degrees}/360) × ${(3.14 * r * r).toFixed(2)} ≈ ${area.toFixed(2)}` };
            }
        },
        "Tangent Lines": () => {
            const type = pick(["property", "perpendicular", "two_tangents"]);
            if (type === "property") {
                return { question: `A tangent line touches a circle at how many points?`, answer: "exactly 1", type: "conceptual",
                    options: ["exactly 1", "exactly 2", "0", "infinitely many"],
                    explanation: `A tangent line touches a circle at exactly one point (point of tangency).` };
            } else if (type === "perpendicular") {
                return { question: `A tangent line is _____ to the radius at the point of tangency.`, answer: "perpendicular", type: "conceptual",
                    options: ["perpendicular", "parallel", "equal", "congruent"],
                    explanation: `The tangent is always perpendicular (90°) to the radius at the point of tangency.` };
            } else {
                return { question: `Two tangent segments from the same external point are...?`, answer: "congruent", type: "conceptual",
                    options: ["congruent", "perpendicular", "parallel", "complementary"],
                    explanation: `Tangent segments from an external point to a circle are always equal in length.` };
            }
        },
        "Dilations": () => {
            const type = pick(["identify", "calculate", "properties"]);
            if (type === "identify") {
                const k = pick([0.5, 2, 3]);
                const result = k > 1 ? "enlargement" : "reduction";
                return { question: `A dilation with scale factor ${k} produces a(n)...?`, answer: result, type: "conceptual",
                    options: ["enlargement", "reduction", "reflection", "rotation"],
                    explanation: `Scale factor > 1 = enlargement. Scale factor < 1 = reduction. ${k} gives ${result}.` };
            } else if (type === "calculate") {
                const x = rand(2, 6), y = rand(2, 6);
                const k = rand(2, 4);
                return { question: `Dilate (${x}, ${y}) by scale factor ${k} from origin. New point?`, answer: `(${x * k}, ${y * k})`, type: "procedural",
                    options: [`(${x * k}, ${y * k})`, `(${x + k}, ${y + k})`, `(${x - k}, ${y - k})`, `(${k}, ${k})`],
                    explanation: `Multiply each coordinate by k: (${x} × ${k}, ${y} × ${k}) = (${x * k}, ${y * k})` };
            } else {
                return { question: `Dilations preserve...?`, answer: "angle measures and shape", type: "conceptual",
                    options: ["angle measures and shape", "side lengths", "area", "perimeter"],
                    explanation: `Dilations create similar figures: same angles, proportional sides.` };
            }
        }
    },

    // TIER 7: Algebra II (10-11)
    7: {
        Quadratics: () => {
            const type = pick(["solve", "vertex", "graph"]);
            if (type === "solve") {
                const r1 = rand(1, 6), r2 = rand(1, 6);
                const b = -(r1 + r2), c = r1 * r2;
                return { question: `Solve: x² ${b >= 0 ? '+' : ''}${b}x + ${c} = 0`, answer: `x = ${r1}, ${r2}`, type: "procedural",
                    options: [`x = ${r1}, ${r2}`, `x = ${-r1}, ${-r2}`, `x = ${r1 + r2}, 0`, `x = ${c}, ${-b}`],
                    explanation: `Factor: (x - ${r1})(x - ${r2}) = 0. Solutions: x = ${r1} or x = ${r2}` };
            } else if (type === "vertex") {
                const h = rand(1, 4), k = rand(-3, 3);
                return {
                    question: `What is the vertex of this parabola?`,
                    answer: `(${h}, ${k})`, type: "conceptual",
                    options: [`(${h}, ${k})`, `(${-h}, ${k})`, `(${h}, ${-k})`, `(${-h}, ${-k})`],
                    explanation: `The vertex is the minimum/maximum point: (${h}, ${k})`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-2, 8], yRange: [-5, 5], gridStep: 1, curves: [{ type: 'quadratic', a: 1, b: -2*h, c: h*h + k }] } }
                };
            } else {
                const a = pick([1, -1]);
                const opens = a > 0 ? "up" : "down";
                return {
                    question: `Does this parabola open up or down?`,
                    answer: opens, type: "conceptual",
                    options: ["up", "down"],
                    explanation: `When a > 0, parabola opens up. When a < 0, it opens down.`,
                    visual: { type: 'coordinate', mode: 'display', data: { xRange: [-5, 5], yRange: [-5, 5], gridStep: 1, curves: [{ type: 'quadratic', a, b: 0, c: 0 }] } }
                };
            }
        },
        Logarithms: () => {
            const bases = [[2, 8, 3], [2, 16, 4], [3, 9, 2], [3, 27, 3], [10, 100, 2], [10, 1000, 3]];
            const [base, val, ans] = pick(bases);
            const type = pick(["eval", "property"]);
            if (type === "eval") {
                return { question: `log${base === 10 ? '' : '₊'.replace('₊', base)}(${val}) = ?`, answer: ans, type: "procedural",
                    explanation: `${base}^? = ${val}. Since ${base}^${ans} = ${val}, answer is ${ans}` };
            } else {
                const a = rand(2, 5), b = rand(2, 5);
                return { question: `Simplify: log(${a * b}) using log(${a}) + log(${b})`, answer: `log(${a}) + log(${b})`, type: "conceptual",
                    options: [`log(${a}) + log(${b})`, `log(${a}) × log(${b})`, `log(${a + b})`, `${a} × log(${b})`],
                    explanation: `log(ab) = log(a) + log(b). So log(${a*b}) = log(${a}) + log(${b})` };
            }
        },
        Polynomials: () => {
            const type = pick(["degree", "add"]);
            if (type === "degree") {
                const deg = rand(2, 5);
                const terms = [`${rand(1,5)}x^${deg}`, `${rand(1,5)}x^${deg-1}`, `${rand(1,5)}`].join(" + ");
                return { question: `Degree of ${terms}?`, answer: deg, type: "conceptual",
                    explanation: `Highest exponent is ${deg}, so degree = ${deg}` };
            } else {
                const a1 = rand(1, 4), a2 = rand(1, 4), b1 = rand(1, 5), b2 = rand(1, 5);
                return { question: `(${a1}x² + ${b1}x) + (${a2}x² + ${b2}x) = ?`, answer: `${a1+a2}x² + ${b1+b2}x`, type: "procedural",
                    options: [`${a1+a2}x² + ${b1+b2}x`, `${a1*a2}x² + ${b1*b2}x`, `${a1+a2}x⁴ + ${b1+b2}x²`, `${a1+b1}x² + ${a2+b2}x`],
                    explanation: `Combine like terms: (${a1}+${a2})x² + (${b1}+${b2})x = ${a1+a2}x² + ${b1+b2}x` };
            }
        },
        Sequences: () => {
            const type = pick(["arithmetic", "geometric", "sum"]);
            if (type === "arithmetic") {
                const a1 = rand(2, 10), d = rand(2, 5), n = rand(8, 12);
                const an = a1 + (n - 1) * d;
                return { question: `Arithmetic: first term ${a1}, common difference ${d}. Find term ${n}.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ + (n-1)d = ${a1} + ${n-1}(${d}) = ${a1} + ${(n-1)*d} = ${an}` };
            } else if (type === "geometric") {
                const a1 = rand(2, 5), r = rand(2, 3), n = rand(4, 6);
                const an = a1 * Math.pow(r, n - 1);
                return { question: `Geometric: first term ${a1}, ratio ${r}. Find term ${n}.`, answer: an, type: "procedural",
                    explanation: `aₙ = a₁ × r^(n-1) = ${a1} × ${r}^${n-1} = ${a1} × ${Math.pow(r, n-1)} = ${an}` };
            } else {
                const n = rand(10, 20);
                const sum = (n * (n + 1)) / 2;
                return { question: `Sum: 1 + 2 + 3 + ... + ${n} = ?`, answer: sum, type: "procedural",
                    explanation: `Sum = n(n+1)/2 = ${n}(${n+1})/2 = ${sum}` };
            }
        },
        Probability: () => {
            const type = pick(["permutation", "combination"]);
            if (type === "permutation") {
                const n = rand(3, 6);
                let factorial = 1;
                for (let i = 2; i <= n; i++) factorial *= i;
                return { question: `How many ways to arrange ${n} items?`, answer: factorial, type: "procedural",
                    explanation: `${n}! = ${Array.from({length: n}, (_, i) => n - i).join(" × ")} = ${factorial}` };
            } else {
                const n = rand(4, 7), r = rand(2, 3);
                const nFact = (x) => { let f = 1; for (let i = 2; i <= x; i++) f *= i; return f; };
                const comb = nFact(n) / (nFact(r) * nFact(n - r));
                return { question: `Choose ${r} from ${n}. How many ways?`, answer: comb, type: "procedural",
                    explanation: `C(${n},${r}) = ${n}!/(${r}!×${n-r}!) = ${comb}` };
            }
        },
        "Conic Sections": () => {
            const type = pick(["identify", "circle", "parabola", "ellipse"]);
            if (type === "identify") {
                const conics = [
                    { eq: "x² + y² = 25", name: "circle", exp: "Both x² and y² with same coefficient" },
                    { eq: "y = x²", name: "parabola", exp: "Only one variable is squared" },
                    { eq: "x²/9 + y²/4 = 1", name: "ellipse", exp: "x² and y² with different denominators, sum = 1" },
                    { eq: "x²/9 - y²/4 = 1", name: "hyperbola", exp: "x² and y² with subtraction" }
                ];
                const c = pick(conics);
                return { question: `Identify the conic: ${c.eq}`, answer: c.name, type: "conceptual",
                    options: ["circle", "parabola", "ellipse", "hyperbola"],
                    explanation: `${c.eq} is a ${c.name}. ${c.exp}` };
            } else if (type === "circle") {
                const r = rand(2, 8);
                return { question: `Circle x² + y² = ${r * r}. What is the radius?`, answer: r, type: "procedural",
                    explanation: `x² + y² = r². Here r² = ${r * r}, so r = ${r}` };
            } else if (type === "parabola") {
                const a = pick([1, 2, -1, -2]);
                const dir = a > 0 ? "upward" : "downward";
                return { question: `Parabola y = ${a === 1 ? '' : a === -1 ? '-' : a}x². Opens which direction?`, answer: dir, type: "conceptual",
                    options: ["upward", "downward", "left", "right"],
                    explanation: `When coefficient of x² is ${a > 0 ? "positive" : "negative"}, parabola opens ${dir}` };
            } else {
                const a = rand(2, 5), b = rand(2, 5);
                while (a === b) b = rand(2, 5);
                const major = a > b ? "horizontal" : "vertical";
                return { question: `Ellipse x²/${a*a} + y²/${b*b} = 1. Major axis is...?`, answer: major, type: "conceptual",
                    options: ["horizontal", "vertical"],
                    explanation: `Larger denominator (${Math.max(a*a, b*b)}) is under ${a > b ? "x²" : "y²"}, so major axis is ${major}` };
            }
        },
        "Completing the Square": () => {
            const type = pick(["rewrite", "solve", "vertex"]);
            if (type === "rewrite") {
                const b = rand(2, 8) * 2; // even number
                const c = rand(1, 10);
                const halfB = b / 2;
                return { question: `Complete the square: x² + ${b}x + ${c} = (x + ?)² + ?`, answer: `(x + ${halfB})² + ${c - halfB*halfB}`, type: "procedural",
                    options: [`(x + ${halfB})² + ${c - halfB*halfB}`, `(x + ${b})² + ${c}`, `(x + ${halfB})² + ${c}`, `(x + ${halfB})² - ${halfB*halfB}`],
                    explanation: `Half of ${b} is ${halfB}. x² + ${b}x + ${halfB}² = (x + ${halfB})². Adjust: ${c} - ${halfB*halfB} = ${c - halfB*halfB}` };
            } else if (type === "solve") {
                const r = rand(1, 5);
                const c = r * r;
                return { question: `Solve by completing the square: x² - ${2*r}x + ${c} = 0`, answer: r, type: "procedural",
                    explanation: `(x - ${r})² = 0, so x = ${r}` };
            } else {
                const h = rand(1, 5), k = rand(-5, 5);
                return { question: `y = (x - ${h})² + ${k}. Vertex is?`, answer: `(${h}, ${k})`, type: "conceptual",
                    options: [`(${h}, ${k})`, `(${-h}, ${k})`, `(${h}, ${-k})`, `(${k}, ${h})`],
                    explanation: `Vertex form y = (x - h)² + k has vertex at (h, k) = (${h}, ${k})` };
            }
        },
        "Piecewise Functions": () => {
            const type = pick(["evaluate", "identify", "graph"]);
            if (type === "evaluate") {
                const x = rand(-3, 5);
                const boundary = rand(0, 2);
                const ans = x < boundary ? x + 5 : 2 * x;
                return { question: `f(x) = {x + 5 if x < ${boundary}, 2x if x ≥ ${boundary}}. Find f(${x}).`, answer: ans, type: "procedural",
                    explanation: `Since ${x} ${x < boundary ? '<' : '≥'} ${boundary}, use ${x < boundary ? 'x + 5' : '2x'}. f(${x}) = ${ans}` };
            } else if (type === "identify") {
                return { question: `A piecewise function has different rules for different:`, answer: "intervals of x", type: "conceptual",
                    options: ["intervals of x", "values of y", "slopes", "intercepts"],
                    explanation: `Piecewise functions have different rules for different intervals of x.` };
            } else {
                return { question: `At x = 2, f(x) = {x² if x < 2, 2x if x ≥ 2}. Is f continuous at x = 2?`, answer: "Yes", type: "reasoning",
                    options: ["Yes", "No", "Cannot determine"],
                    explanation: `Left: 2² = 4. Right: 2(2) = 4. Both equal, so continuous.` };
            }
        },
        Asymptotes: () => {
            const type = pick(["vertical", "horizontal", "both"]);
            if (type === "vertical") {
                const a = rand(1, 6);
                return { question: `f(x) = 1/(x - ${a}). Vertical asymptote at x = ?`, answer: a, type: "procedural",
                    explanation: `Vertical asymptote where denominator = 0: x - ${a} = 0, so x = ${a}` };
            } else if (type === "horizontal") {
                const num = rand(2, 5), denom = rand(2, 5);
                return { question: `f(x) = ${num}x/(${denom}x + 1). Horizontal asymptote at y = ?`, answer: num / denom, type: "procedural",
                    explanation: `Same degree: HA = leading coefficients ratio = ${num}/${denom}` };
            } else {
                const a = rand(1, 4), b = rand(1, 4);
                return { question: `f(x) = (x + ${a})/(x - ${b}). Find both asymptotes.`, answer: `x = ${b}, y = 1`, type: "procedural",
                    options: [`x = ${b}, y = 1`, `x = ${-b}, y = 1`, `x = ${b}, y = 0`, `x = ${a}, y = 1`],
                    explanation: `VA: x - ${b} = 0 → x = ${b}. HA: same degree → y = 1/1 = 1` };
            }
        },
        Permutations: () => {
            const type = pick(["formula", "calculate", "word"]);
            if (type === "formula") {
                return { question: `The permutation formula P(n,r) equals:`, answer: "n!/(n-r)!", type: "conceptual",
                    options: ["n!/(n-r)!", "n!/r!", "n!/(n-r)!r!", "(n-r)!/n!"],
                    explanation: `P(n,r) = n!/(n-r)! counts ordered arrangements.` };
            } else if (type === "calculate") {
                const n = rand(4, 7), r = rand(2, 3);
                let result = 1;
                for (let i = 0; i < r; i++) result *= (n - i);
                return { question: `Calculate P(${n}, ${r})`, answer: result, type: "procedural",
                    explanation: `P(${n},${r}) = ${n}!/${n-r}! = ${Array.from({length: r}, (_, i) => n - i).join(' × ')} = ${result}` };
            } else {
                const n = rand(4, 6);
                let factorial = 1;
                for (let i = 2; i <= n; i++) factorial *= i;
                return { question: `How many ways to arrange ${n} different books on a shelf?`, answer: factorial, type: "reasoning",
                    explanation: `All different, order matters: ${n}! = ${factorial}` };
            }
        },
        Combinations: () => {
            const type = pick(["formula", "calculate", "word"]);
            if (type === "formula") {
                return { question: `The combination formula C(n,r) equals:`, answer: "n!/(r!(n-r)!)", type: "conceptual",
                    options: ["n!/(r!(n-r)!)", "n!/(n-r)!", "n!/r!", "(n-r)!"],
                    explanation: `C(n,r) = n!/(r!(n-r)!) counts unordered selections.` };
            } else if (type === "calculate") {
                const n = rand(5, 8), r = rand(2, 3);
                let num = 1, denom = 1;
                for (let i = 0; i < r; i++) { num *= (n - i); denom *= (i + 1); }
                const result = num / denom;
                return { question: `Calculate C(${n}, ${r})`, answer: result, type: "procedural",
                    explanation: `C(${n},${r}) = ${n}!/(${r}!${n-r}!) = ${result}` };
            } else {
                const n = rand(8, 12), r = rand(3, 4);
                let num = 1, denom = 1;
                for (let i = 0; i < r; i++) { num *= (n - i); denom *= (i + 1); }
                const result = num / denom;
                return { question: `How many ways to choose ${r} students from ${n} for a committee?`, answer: result, type: "reasoning",
                    explanation: `Order doesn't matter: C(${n},${r}) = ${result}` };
            }
        },
        "Expected Value": () => {
            const type = pick(["dice", "coins", "custom"]);
            if (type === "dice") {
                return { question: `Roll a fair die. What is the expected value?`, answer: 3.5, type: "procedural",
                    explanation: `E(X) = (1+2+3+4+5+6)/6 = 21/6 = 3.5` };
            } else if (type === "coins") {
                const win = rand(5, 10), lose = rand(2, 4);
                const ev = (0.5 * win - 0.5 * lose).toFixed(2);
                return { question: `Flip coin: win $${win} for heads, lose $${lose} for tails. Expected value?`, answer: parseFloat(ev), type: "procedural",
                    explanation: `E(X) = 0.5(${win}) + 0.5(-${lose}) = ${win/2} - ${lose/2} = ${ev}` };
            } else {
                const p1 = 0.3, v1 = rand(10, 20), p2 = 0.7, v2 = rand(2, 8);
                const ev = (p1 * v1 + p2 * v2).toFixed(2);
                return { question: `30% chance to win $${v1}, 70% chance to win $${v2}. Expected value?`, answer: parseFloat(ev), type: "procedural",
                    explanation: `E(X) = 0.3(${v1}) + 0.7(${v2}) = ${(p1*v1).toFixed(1)} + ${(p2*v2).toFixed(1)} = ${ev}` };
            }
        },
        "Synthetic Division": () => {
            const type = pick(["setup", "divide", "remainder"]);
            if (type === "setup") {
                const a = rand(1, 4);
                return { question: `To divide by (x - ${a}) using synthetic division, use which number?`, answer: a, type: "conceptual",
                    options: [a, -a, a * 2, 0],
                    explanation: `For (x - ${a}), use +${a} in synthetic division (opposite sign).` };
            } else if (type === "divide") {
                // Simple case: (x² + bx + c) ÷ (x - a) where a is a root
                const a = rand(1, 3);
                const otherRoot = rand(-3, 3);
                const b = -(a + otherRoot);
                const c = a * otherRoot;
                return { question: `Use synthetic division: (x² ${b >= 0 ? '+' : ''}${b}x ${c >= 0 ? '+' : ''}${c}) ÷ (x - ${a}). Quotient?`, answer: `x ${otherRoot >= 0 ? '+' : ''}${-otherRoot}`, type: "procedural",
                    options: [`x ${-otherRoot >= 0 ? '+' : ''}${-otherRoot}`, `x ${otherRoot >= 0 ? '+' : ''}${otherRoot}`, `x² + ${a}`, `x - ${a}`],
                    explanation: `Synthetic division with ${a}: quotient is x ${-otherRoot >= 0 ? '+' : ''}${-otherRoot} with remainder 0.` };
            } else {
                const a = rand(1, 3);
                const b = rand(-5, 5);
                const c = rand(-10, 10);
                const remainder = a * a + b * a + c;
                return { question: `By Remainder Theorem: f(x) = x² ${b >= 0 ? '+' : ''}${b}x ${c >= 0 ? '+' : ''}${c}. Find f(${a}).`, answer: remainder, type: "procedural",
                    explanation: `f(${a}) = ${a}² ${b >= 0 ? '+' : ''}${b}(${a}) ${c >= 0 ? '+' : ''}${c} = ${a * a} ${b * a >= 0 ? '+' : ''}${b * a} ${c >= 0 ? '+' : ''}${c} = ${remainder}` };
            }
        },
        "Binomial Theorem": () => {
            const type = pick(["pascal", "coefficient", "expand_simple"]);
            if (type === "pascal") {
                const row = rand(3, 5);
                const pascalRows = { 3: "1 3 3 1", 4: "1 4 6 4 1", 5: "1 5 10 10 5 1" };
                return { question: `Row ${row} of Pascal's Triangle:`, answer: pascalRows[row], type: "conceptual",
                    options: [pascalRows[3], pascalRows[4], pascalRows[5], "1 2 1"],
                    explanation: `Row ${row}: ${pascalRows[row]}` };
            } else if (type === "coefficient") {
                const n = 4;
                const k = rand(1, 3);
                const coef = { 1: 4, 2: 6, 3: 4 };
                return { question: `In (a + b)⁴, coefficient of a^${4-k}b^${k}?`, answer: coef[k], type: "procedural",
                    options: [coef[1], coef[2], coef[3], 1],
                    explanation: `C(4, ${k}) = ${coef[k]}` };
            } else {
                return { question: `(x + 1)² expands to:`, answer: "x² + 2x + 1", type: "procedural",
                    options: ["x² + 2x + 1", "x² + x + 1", "x² + 1", "2x² + 2x"],
                    explanation: `(x + 1)² = x² + 2(x)(1) + 1² = x² + 2x + 1` };
            }
        },
        "Matrices Intro": () => {
            const type = pick(["dimensions", "add", "scalar_mult", "element"]);
            if (type === "dimensions") {
                const rows = rand(2, 4), cols = rand(2, 4);
                return { question: `A matrix with ${rows} rows and ${cols} columns has dimensions:`, answer: `${rows} × ${cols}`, type: "conceptual",
                    options: [`${rows} × ${cols}`, `${cols} × ${rows}`, `${rows + cols}`, `${rows * cols}`],
                    explanation: `Matrix dimensions: rows × columns = ${rows} × ${cols}` };
            } else if (type === "add") {
                const a = rand(1, 5), b = rand(1, 5), c = rand(1, 5), d = rand(1, 5);
                const e = rand(1, 5), f = rand(1, 5), g = rand(1, 5), h = rand(1, 5);
                return { question: `[${a} ${b}; ${c} ${d}] + [${e} ${f}; ${g} ${h}] = ? (top-left element)`, answer: a + e, type: "procedural",
                    explanation: `Add corresponding elements: ${a} + ${e} = ${a + e}` };
            } else if (type === "scalar_mult") {
                const k = rand(2, 5);
                const a = rand(1, 5), b = rand(1, 5);
                return { question: `${k} × [${a} ${b}] = ?`, answer: `[${k * a} ${k * b}]`, type: "procedural",
                    options: [`[${k * a} ${k * b}]`, `[${a + k} ${b + k}]`, `[${a} ${b}]`, `[${k} ${k}]`],
                    explanation: `Multiply each element by ${k}: [${k}×${a} ${k}×${b}] = [${k * a} ${k * b}]` };
            } else {
                const matrix = [[rand(1, 9), rand(1, 9)], [rand(1, 9), rand(1, 9)]];
                const row = rand(1, 2), col = rand(1, 2);
                return { question: `Matrix [${matrix[0][0]} ${matrix[0][1]}; ${matrix[1][0]} ${matrix[1][1]}]. Element at row ${row}, column ${col}?`, answer: matrix[row - 1][col - 1], type: "procedural",
                    options: [matrix[0][0], matrix[0][1], matrix[1][0], matrix[1][1]],
                    explanation: `Row ${row}, Column ${col} = ${matrix[row - 1][col - 1]}` };
            }
        }
    },

    // TIER 8: Pre-Calculus (11-12)
    8: {
        Transformations: () => {
            const h = rand(1, 5), k = rand(1, 5);
            const type = pick(["horizontal", "vertical", "combined"]);
            if (type === "horizontal") {
                const dir = pick(["left", "right"]);
                const sign = dir === "right" ? "-" : "+";
                return { question: `f(x ${sign} ${h}) shifts the graph...`, answer: `${dir} ${h}`, type: "conceptual",
                    options: [`${dir} ${h}`, `${dir === "left" ? "right" : "left"} ${h}`, `up ${h}`, `down ${h}`],
                    explanation: `f(x ${sign} ${h}) shifts ${dir} by ${h} units` };
            } else if (type === "vertical") {
                const dir = pick(["up", "down"]);
                const sign = dir === "up" ? "+" : "-";
                return { question: `f(x) ${sign} ${k} shifts the graph...`, answer: `${dir} ${k}`, type: "conceptual",
                    options: [`${dir} ${k}`, `${dir === "up" ? "down" : "up"} ${k}`, `left ${k}`, `right ${k}`],
                    explanation: `f(x) ${sign} ${k} shifts ${dir} by ${k} units` };
            } else {
                return { question: `-f(x) does what to the graph?`, answer: "reflects over x-axis", type: "conceptual",
                    options: ["reflects over x-axis", "reflects over y-axis", "shifts up", "shifts down"],
                    explanation: `Negating f(x) reflects the graph over the x-axis` };
            }
        },
        "Trig Functions": () => {
            const values = [
                { angle: "π/6", sin: "1/2", cos: "√3/2", tan: "1/√3" },
                { angle: "π/4", sin: "√2/2", cos: "√2/2", tan: "1" },
                { angle: "π/3", sin: "√3/2", cos: "1/2", tan: "√3" },
                { angle: "π/2", sin: "1", cos: "0", tan: "undefined" }
            ];
            const v = pick(values);
            const func = pick(["sin", "cos"]);
            return { question: `${func}(${v.angle}) = ?`, answer: v[func], type: "procedural",
                options: ["1/2", "√2/2", "√3/2", "1"],
                explanation: `${func}(${v.angle}) = ${v[func]} (standard angle)` };
        },
        Limits: () => {
            const type = pick(["direct", "factor", "infinity"]);
            if (type === "direct") {
                const a = rand(1, 5), b = rand(1, 5);
                const c = rand(1, 4);
                const answer = a * c + b;
                return { question: `lim(x→${c}) (${a}x + ${b}) = ?`, answer, type: "procedural",
                    explanation: `Direct substitution: ${a}(${c}) + ${b} = ${answer}` };
            } else if (type === "factor") {
                const a = rand(1, 4);
                return { question: `lim(x→${a}) (x² - ${a*a})/(x - ${a}) = ?`, answer: 2 * a, type: "procedural",
                    explanation: `Factor: (x+${a})(x-${a})/(x-${a}) = x+${a}. At x=${a}: ${2*a}` };
            } else {
                const a = rand(2, 5), b = rand(1, 4);
                return { question: `lim(x→∞) (${a}x² + 1)/(${b}x² + x) = ?`, answer: a / b, type: "procedural",
                    explanation: `Highest powers: ${a}x²/${b}x² = ${a}/${b} = ${(a/b).toFixed(2)}` };
            }
        },
        "Complex Numbers": () => {
            const type = pick(["i_power", "multiply", "add"]);
            if (type === "i_power") {
                const powers = [{ n: 2, ans: "-1" }, { n: 3, ans: "-i" }, { n: 4, ans: "1" }];
                const p = pick(powers);
                return { question: `i${["⁰","¹","²","³","⁴"][p.n]} = ?`, answer: p.ans, type: "procedural",
                    options: ["1", "-1", "i", "-i"],
                    explanation: `i² = -1, i³ = -i, i⁴ = 1. So i^${p.n} = ${p.ans}` };
            } else if (type === "add") {
                const a = rand(1, 5), b = rand(1, 5), c = rand(1, 5), d = rand(1, 5);
                return { question: `(${a} + ${b}i) + (${c} + ${d}i) = ?`, answer: `${a+c} + ${b+d}i`, type: "procedural",
                    options: [`${a+c} + ${b+d}i`, `${a*c} + ${b*d}i`, `${a+c} + ${b*d}i`, `${a+b} + ${c+d}i`],
                    explanation: `Add real and imaginary parts: (${a}+${c}) + (${b}+${d})i = ${a+c} + ${b+d}i` };
            } else {
                const a = rand(1, 4), b = rand(1, 3);
                const answer = a * a + b * b;
                return { question: `(${a} + ${b}i)(${a} - ${b}i) = ?`, answer, type: "procedural",
                    explanation: `Conjugate product: a² + b² = ${a}² + ${b}² = ${answer}` };
            }
        },
        Vectors: () => {
            const type = pick(["add", "magnitude", "scalar"]);
            if (type === "add") {
                const a1 = rand(1, 5), a2 = rand(1, 5);
                const b1 = rand(1, 5), b2 = rand(1, 5);
                return { question: `⟨${a1}, ${a2}⟩ + ⟨${b1}, ${b2}⟩ = ?`, answer: `⟨${a1+b1}, ${a2+b2}⟩`, type: "procedural",
                    options: [`⟨${a1+b1}, ${a2+b2}⟩`, `⟨${a1*b1}, ${a2*b2}⟩`, `⟨${a1+a2}, ${b1+b2}⟩`, `⟨${a1-b1}, ${a2-b2}⟩`],
                    explanation: `Add components: ⟨${a1}+${b1}, ${a2}+${b2}⟩ = ⟨${a1+b1}, ${a2+b2}⟩` };
            } else if (type === "magnitude") {
                const pairs = [[3, 4, 5], [5, 12, 13], [6, 8, 10]];
                const [a, b, mag] = pick(pairs);
                return { question: `Magnitude of ⟨${a}, ${b}⟩ = ?`, answer: mag, type: "procedural",
                    explanation: `|v| = √(${a}² + ${b}²) = √(${a*a} + ${b*b}) = √${mag*mag} = ${mag}` };
            } else {
                const k = rand(2, 4);
                const a = rand(1, 5), b = rand(1, 5);
                return { question: `${k}⟨${a}, ${b}⟩ = ?`, answer: `⟨${k*a}, ${k*b}⟩`, type: "procedural",
                    options: [`⟨${k*a}, ${k*b}⟩`, `⟨${k+a}, ${k+b}⟩`, `⟨${a}, ${b}⟩`, `⟨${k*a}, ${b}⟩`],
                    explanation: `Multiply each component by ${k}: ⟨${k}×${a}, ${k}×${b}⟩ = ⟨${k*a}, ${k*b}⟩` };
            }
        },
        "Advanced Functions": () => {
            const type = pick(["composite", "inverse", "domain"]);
            if (type === "composite") {
                const a = rand(2, 4), b = rand(1, 5);
                const x = rand(1, 4);
                const gx = a * x;
                const fgx = gx + b;
                return { question: `f(x) = x + ${b}, g(x) = ${a}x. Find f(g(${x})).`, answer: fgx, type: "procedural",
                    explanation: `g(${x}) = ${a}(${x}) = ${gx}. Then f(${gx}) = ${gx} + ${b} = ${fgx}` };
            } else if (type === "inverse") {
                const a = rand(2, 5);
                return { question: `f(x) = ${a}x. Find f⁻¹(x).`, answer: `x/${a}`, type: "procedural",
                    options: [`x/${a}`, `${a}x`, `${a}/x`, `x - ${a}`],
                    explanation: `If f(x) = ${a}x, then f⁻¹(x) = x/${a} (divide by ${a} to undo multiplication)` };
            } else {
                const a = rand(1, 5);
                return { question: `f(x) = √(x - ${a}). Domain is x ≥ ?`, answer: a, type: "conceptual",
                    explanation: `Can't take square root of negative. x - ${a} ≥ 0 means x ≥ ${a}` };
            }
        },
        "Radian Measure": () => {
            const type = pick(["convert_to_rad", "convert_to_deg", "arc_length"]);
            if (type === "convert_to_rad") {
                const degrees = pick([30, 45, 60, 90, 120, 180, 270, 360]);
                const radians = { 30: "π/6", 45: "π/4", 60: "π/3", 90: "π/2", 120: "2π/3", 180: "π", 270: "3π/2", 360: "2π" };
                return { question: `Convert ${degrees}° to radians.`, answer: radians[degrees], type: "procedural",
                    options: ["π/6", "π/4", "π/3", "π/2", "2π/3", "π", "3π/2", "2π"].slice(0, 4),
                    explanation: `${degrees}° × (π/180°) = ${radians[degrees]}` };
            } else if (type === "convert_to_deg") {
                const rads = pick(["π/6", "π/4", "π/3", "π/2"]);
                const degs = { "π/6": 30, "π/4": 45, "π/3": 60, "π/2": 90 };
                return { question: `Convert ${rads} radians to degrees.`, answer: degs[rads], type: "procedural",
                    options: [30, 45, 60, 90],
                    explanation: `${rads} × (180°/π) = ${degs[rads]}°` };
            } else {
                const r = rand(3, 8), theta = pick([Math.PI/2, Math.PI/3, Math.PI/4]);
                const arc = (r * theta).toFixed(2);
                const thetaStr = theta === Math.PI/2 ? "π/2" : theta === Math.PI/3 ? "π/3" : "π/4";
                return { question: `Arc length: radius ${r}, central angle ${thetaStr}. (Round to 2 decimal places)`, answer: parseFloat(arc), type: "procedural",
                    explanation: `s = rθ = ${r} × ${thetaStr} ≈ ${arc}` };
            }
        },
        "Inverse Trig": () => {
            const type = pick(["evaluate", "domain", "range"]);
            if (type === "evaluate") {
                const values = [
                    { input: "0", func: "sin⁻¹", output: "0" },
                    { input: "1", func: "sin⁻¹", output: "π/2" },
                    { input: "1", func: "cos⁻¹", output: "0" },
                    { input: "0", func: "cos⁻¹", output: "π/2" },
                    { input: "1", func: "tan⁻¹", output: "π/4" },
                    { input: "0", func: "tan⁻¹", output: "0" }
                ];
                const v = pick(values);
                return { question: `Evaluate ${v.func}(${v.input})`, answer: v.output, type: "procedural",
                    options: ["0", "π/6", "π/4", "π/3", "π/2"],
                    explanation: `${v.func}(${v.input}) = ${v.output}` };
            } else if (type === "domain") {
                const func = pick(["sin⁻¹", "cos⁻¹"]);
                return { question: `What is the domain of ${func}(x)?`, answer: "[-1, 1]", type: "conceptual",
                    options: ["[-1, 1]", "all real numbers", "[0, π]", "[-π/2, π/2]"],
                    explanation: `${func} only accepts inputs from -1 to 1 (sine and cosine output range).` };
            } else {
                const func = pick(["sin⁻¹", "tan⁻¹"]);
                const range = func === "sin⁻¹" ? "[-π/2, π/2]" : "(-π/2, π/2)";
                return { question: `What is the range of ${func}(x)?`, answer: range, type: "conceptual",
                    options: ["[-π/2, π/2]", "(-π/2, π/2)", "[0, π]", "all real numbers"],
                    explanation: `Range of ${func} is ${range}` };
            }
        },
        "Parametric Equations": () => {
            const type = pick(["evaluate", "eliminate", "identify"]);
            if (type === "evaluate") {
                const t = rand(1, 4);
                const x = 2 * t, y = t * t;
                return { question: `x = 2t, y = t². Find (x, y) when t = ${t}.`, answer: `(${x}, ${y})`, type: "procedural",
                    options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${t}, ${t})`, `(${x + y}, ${x * y})`],
                    explanation: `x = 2(${t}) = ${x}, y = ${t}² = ${y}. Point: (${x}, ${y})` };
            } else if (type === "eliminate") {
                return { question: `x = t + 1, y = t - 2. Eliminate the parameter.`, answer: "y = x - 3", type: "procedural",
                    options: ["y = x - 3", "y = x + 3", "y = 2x - 1", "y = x - 1"],
                    explanation: `From x = t + 1: t = x - 1. Substitute: y = (x - 1) - 2 = x - 3` };
            } else {
                return { question: `x = cos(t), y = sin(t) traces what shape?`, answer: "circle", type: "conceptual",
                    options: ["circle", "line", "parabola", "ellipse"],
                    explanation: `x² + y² = cos²(t) + sin²(t) = 1, which is a unit circle.` };
            }
        },
        "Polar Coordinates": () => {
            const type = pick(["convert_to_rect", "convert_to_polar", "identify"]);
            if (type === "convert_to_rect") {
                const r = rand(2, 5), theta = pick([0, Math.PI/2, Math.PI, 3*Math.PI/2]);
                const thetaStr = theta === 0 ? "0" : theta === Math.PI/2 ? "π/2" : theta === Math.PI ? "π" : "3π/2";
                const x = Math.round(r * Math.cos(theta)), y = Math.round(r * Math.sin(theta));
                return { question: `Convert polar (${r}, ${thetaStr}) to rectangular.`, answer: `(${x}, ${y})`, type: "procedural",
                    options: [`(${x}, ${y})`, `(${y}, ${x})`, `(${r}, ${r})`, `(${-x}, ${-y})`],
                    explanation: `x = r·cos(θ) = ${r}·cos(${thetaStr}) = ${x}. y = r·sin(θ) = ${y}` };
            } else if (type === "convert_to_polar") {
                const pairs = [[3, 4, 5, "0.93"], [0, 5, 5, "π/2"], [5, 0, 5, "0"], [-3, 0, 3, "π"]];
                const [x, y, r, theta] = pick(pairs);
                return { question: `Convert rectangular (${x}, ${y}) to polar (r, θ).`, answer: `(${r}, ${theta})`, type: "procedural",
                    explanation: `r = √(${x}² + ${y}²) = ${r}. θ = arctan(${y}/${x}) ≈ ${theta}` };
            } else {
                return { question: `r = 5 in polar coordinates represents a:`, answer: "circle with radius 5", type: "conceptual",
                    options: ["circle with radius 5", "line", "point", "spiral"],
                    explanation: `r = constant is a circle centered at origin with that radius.` };
            }
        },
        "Normal Distribution": () => {
            const type = pick(["z_score", "empirical", "interpret"]);
            if (type === "z_score") {
                const mean = rand(50, 80), sd = rand(5, 15), x = mean + sd * rand(1, 2);
                const z = (x - mean) / sd;
                return { question: `Mean = ${mean}, SD = ${sd}. Find z-score for x = ${x}.`, answer: z.toFixed(1), type: "procedural",
                    explanation: `z = (x - μ)/σ = (${x} - ${mean})/${sd} = ${z.toFixed(1)}` };
            } else if (type === "empirical") {
                const pct = pick([68, 95, 99.7]);
                const sds = pct === 68 ? 1 : pct === 95 ? 2 : 3;
                return { question: `In a normal distribution, ${pct}% of data falls within how many standard deviations?`, answer: sds, type: "conceptual",
                    options: [1, 2, 3, 4],
                    explanation: `Empirical Rule: ${pct}% within ${sds} SD${sds > 1 ? 's' : ''} of the mean.` };
            } else {
                const z = pick([1, 2, -1, -2]);
                const direction = z > 0 ? "above" : "below";
                return { question: `A z-score of ${z} means the value is:`, answer: `${Math.abs(z)} SD ${direction} the mean`, type: "conceptual",
                    options: [`${Math.abs(z)} SD above the mean`, `${Math.abs(z)} SD below the mean`, "equal to the mean", `${Math.abs(z)} times the mean`],
                    explanation: `z = ${z} means ${Math.abs(z)} standard deviation${Math.abs(z) > 1 ? 's' : ''} ${direction} the mean.` };
            }
        },
        "Unit Circle": () => {
            const type = pick(["coordinates", "quadrant", "reference", "special"]);
            if (type === "coordinates") {
                const angles = [
                    { angle: "0", coords: "(1, 0)" },
                    { angle: "π/6", coords: "(√3/2, 1/2)" },
                    { angle: "π/4", coords: "(√2/2, √2/2)" },
                    { angle: "π/3", coords: "(1/2, √3/2)" },
                    { angle: "π/2", coords: "(0, 1)" },
                    { angle: "π", coords: "(-1, 0)" },
                    { angle: "3π/2", coords: "(0, -1)" }
                ];
                const a = pick(angles);
                return { question: `Point on unit circle at angle ${a.angle}?`, answer: a.coords, type: "procedural",
                    options: ["(1, 0)", "(√2/2, √2/2)", "(1/2, √3/2)", "(0, 1)"],
                    explanation: `At ${a.angle}: (cos(${a.angle}), sin(${a.angle})) = ${a.coords}` };
            } else if (type === "quadrant") {
                const quads = [
                    { q: "I", sin: "+", cos: "+" },
                    { q: "II", sin: "+", cos: "-" },
                    { q: "III", sin: "-", cos: "-" },
                    { q: "IV", sin: "-", cos: "+" }
                ];
                const quad = pick(quads);
                return { question: `In Quadrant ${quad.q}, sin is ${quad.sin} and cos is:`, answer: quad.cos, type: "conceptual",
                    options: ["+", "-"],
                    explanation: `Quadrant ${quad.q}: sin is ${quad.sin}, cos is ${quad.cos}. (Remember: All Students Take Calculus)` };
            } else if (type === "reference") {
                const angles = [
                    { angle: "5π/6", ref: "π/6" },
                    { angle: "3π/4", ref: "π/4" },
                    { angle: "2π/3", ref: "π/3" },
                    { angle: "7π/6", ref: "π/6" },
                    { angle: "5π/4", ref: "π/4" },
                    { angle: "4π/3", ref: "π/3" }
                ];
                const a = pick(angles);
                return { question: `Reference angle for ${a.angle}?`, answer: a.ref, type: "procedural",
                    options: ["π/6", "π/4", "π/3", "π/2"],
                    explanation: `${a.angle} has reference angle ${a.ref} (acute angle to x-axis)` };
            } else {
                const angle = pick(["30°", "45°", "60°"]);
                const sides = { "30°": "1, √3, 2", "45°": "1, 1, √2", "60°": "1, √3, 2" };
                return { question: `Special right triangle with ${angle}: opposite, adjacent, hypotenuse?`, answer: sides[angle], type: "conceptual",
                    options: ["1, √3, 2", "1, 1, √2", "3, 4, 5", "1, 2, √5"],
                    explanation: `${angle} triangle has sides ${sides[angle]}` };
            }
        },
        "Trig Identities": () => {
            const type = pick(["pythagorean", "double_angle", "sum_diff", "verify"]);
            if (type === "pythagorean") {
                const identities = [
                    { q: "sin²θ + cos²θ = ?", a: "1" },
                    { q: "1 + tan²θ = ?", a: "sec²θ" },
                    { q: "1 + cot²θ = ?", a: "csc²θ" }
                ];
                const id = pick(identities);
                return { question: id.q, answer: id.a, type: "procedural",
                    options: ["1", "sec²θ", "csc²θ", "tan²θ"],
                    explanation: `Pythagorean identity: ${id.q.replace('?', id.a)}` };
            } else if (type === "double_angle") {
                const identities = [
                    { q: "sin(2θ) = ?", a: "2sin(θ)cos(θ)" },
                    { q: "cos(2θ) = ? (first form)", a: "cos²θ - sin²θ" }
                ];
                const id = pick(identities);
                return { question: id.q, answer: id.a, type: "procedural",
                    options: ["2sin(θ)cos(θ)", "cos²θ - sin²θ", "sin²θ + cos²θ", "2cos²θ"],
                    explanation: `Double angle formula: ${id.q.replace('?', id.a)}` };
            } else if (type === "sum_diff") {
                return { question: `sin(A + B) = ?`, answer: "sin(A)cos(B) + cos(A)sin(B)", type: "procedural",
                    options: ["sin(A)cos(B) + cos(A)sin(B)", "sin(A)sin(B) + cos(A)cos(B)", "sin(A) + sin(B)", "cos(A)cos(B) - sin(A)sin(B)"],
                    explanation: `Sum formula: sin(A + B) = sin(A)cos(B) + cos(A)sin(B)` };
            } else {
                const sinVal = pick(["3/5", "4/5"]);
                const cosVal = sinVal === "3/5" ? "4/5" : "3/5";
                return { question: `If sin(θ) = ${sinVal} in Q1, find cos(θ).`, answer: cosVal, type: "procedural",
                    options: ["3/5", "4/5", "5/3", "5/4"],
                    explanation: `sin²θ + cos²θ = 1. If sin = ${sinVal}, then cos = ${cosVal} (3-4-5 triangle)` };
            }
        },
        "Graphing Trig Functions": () => {
            const type = pick(["amplitude", "period", "phase_shift", "identify"]);
            if (type === "amplitude") {
                const a = rand(2, 6);
                return { question: `Amplitude of y = ${a}sin(x)?`, answer: a, type: "conceptual",
                    options: [a, a * 2, 1, a - 1],
                    explanation: `Amplitude = |A| in y = Asin(x). Here amplitude = ${a}` };
            } else if (type === "period") {
                const b = pick([2, 3, 4]);
                const period = `2π/${b}`;
                return { question: `Period of y = sin(${b}x)?`, answer: period, type: "procedural",
                    options: [`2π/${b}`, "2π", `${b}π`, `π/${b}`],
                    explanation: `Period = 2π/B. Here B = ${b}, so period = ${period}` };
            } else if (type === "phase_shift") {
                const c = rand(1, 4);
                const dir = pick(["left", "right"]);
                const sign = dir === "right" ? "-" : "+";
                return { question: `Phase shift of y = sin(x ${sign} ${c})?`, answer: `${dir} ${c}`, type: "conceptual",
                    options: [`left ${c}`, `right ${c}`, `up ${c}`, `down ${c}`],
                    explanation: `y = sin(x ${sign} ${c}) shifts ${dir} by ${c} units` };
            } else {
                const func = pick(["sin", "cos", "tan"]);
                const props = {
                    "sin": { period: "2π", zeros: "0, π, 2π" },
                    "cos": { period: "2π", zeros: "π/2, 3π/2" },
                    "tan": { period: "π", zeros: "0, π" }
                };
                return { question: `The period of y = ${func}(x) is:`, answer: props[func].period, type: "conceptual",
                    options: ["π", "2π", "π/2", "4π"],
                    explanation: `${func}(x) has period ${props[func].period}` };
            }
        },
        "Series Convergence": () => {
            const type = pick(["geometric", "harmonic", "p_series", "comparison"]);
            if (type === "geometric") {
                const r = pick(["1/2", "1/3", "2", "3"]);
                const converges = r === "1/2" || r === "1/3";
                return { question: `Geometric series with r = ${r}. Converges?`, answer: converges ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `Geometric series converges when |r| < 1. |${r}| ${converges ? "< 1, converges" : "≥ 1, diverges"}` };
            } else if (type === "harmonic") {
                return { question: `Does the harmonic series Σ(1/n) converge?`, answer: "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `The harmonic series Σ(1/n) diverges (classic result - grows without bound)` };
            } else if (type === "p_series") {
                const p = pick(["1/2", "1", "2", "3"]);
                const converges = p === "2" || p === "3";
                return { question: `P-series Σ(1/n^${p}). Converges?`, answer: converges ? "Yes" : "No", type: "conceptual",
                    options: ["Yes", "No"],
                    explanation: `P-series converges when p > 1. p = ${p} ${converges ? "> 1, converges" : "≤ 1, diverges"}` };
            } else {
                const series = pick(["Σ(1/n²)", "Σ(1/2ⁿ)"]);
                return { question: `${series} converges or diverges?`, answer: "Converges", type: "conceptual",
                    options: ["Converges", "Diverges"],
                    explanation: `${series} converges. (${series === "Σ(1/n²)" ? "p-series with p=2>1" : "geometric with r=1/2<1"})` };
            }
        }
    },

    // TIER 9: Calculus (12+)
    9: {
        Derivatives: () => {
            const type = pick(["power", "trig", "chain"]);
            if (type === "power") {
                const n = rand(2, 6);
                return { question: `d/dx(x${["⁰","¹","²","³","⁴","⁵","⁶"][n]}) = ?`, answer: `${n}x^${n-1}`, type: "procedural",
                    options: [`${n}x^${n-1}`, `x^${n+1}`, `${n}x^${n}`, `x^${n-1}`],
                    explanation: `Power rule: d/dx(x^n) = nx^(n-1). So d/dx(x^${n}) = ${n}x^${n-1}` };
            } else if (type === "trig") {
                const funcs = [
                    { f: "sin(x)", d: "cos(x)" }, { f: "cos(x)", d: "-sin(x)" },
                    { f: "tan(x)", d: "sec²(x)" }
                ];
                const func = pick(funcs);
                return { question: `d/dx(${func.f}) = ?`, answer: func.d, type: "procedural",
                    options: ["cos(x)", "-sin(x)", "sin(x)", "sec²(x)"],
                    explanation: `d/dx(${func.f}) = ${func.d}` };
            } else {
                const a = rand(2, 5);
                return { question: `d/dx(${a}x³) = ?`, answer: `${3*a}x²`, type: "procedural",
                    options: [`${3*a}x²`, `${a}x²`, `${3*a}x³`, `${a}x⁴`],
                    explanation: `Constant multiple + power rule: ${a} × 3x² = ${3*a}x²` };
            }
        },
        Integrals: () => {
            const type = pick(["power", "trig", "definite"]);
            if (type === "power") {
                const n = rand(1, 4);
                return { question: `∫x${["⁰","¹","²","³","⁴"][n]} dx = ?`, answer: `x^${n+1}/${n+1} + C`, type: "procedural",
                    options: [`x^${n+1}/${n+1} + C`, `${n}x^${n-1} + C`, `x^${n+1} + C`, `x^${n}/${n} + C`],
                    explanation: `Power rule: ∫x^n dx = x^(n+1)/(n+1) + C` };
            } else if (type === "trig") {
                const funcs = [
                    { f: "cos(x)", i: "sin(x) + C" }, { f: "sin(x)", i: "-cos(x) + C" }
                ];
                const func = pick(funcs);
                return { question: `∫${func.f} dx = ?`, answer: func.i, type: "procedural",
                    options: ["sin(x) + C", "-cos(x) + C", "cos(x) + C", "-sin(x) + C"],
                    explanation: `∫${func.f} dx = ${func.i}` };
            } else {
                const a = 0, b = rand(2, 4);
                const answer = (b * b) / 2;
                return { question: `∫₀${["⁰","¹","²","³","⁴"][b]} x dx = ?`, answer, type: "procedural",
                    explanation: `[x²/2]₀^${b} = ${b}²/2 - 0 = ${answer}` };
            }
        },
        Limits: () => {
            const type = pick(["fundamental", "lhopital"]);
            if (type === "fundamental") {
                return { question: `lim(x→0) sin(x)/x = ?`, answer: 1, type: "procedural",
                    explanation: `This is a fundamental limit: lim(x→0) sin(x)/x = 1` };
            } else {
                const a = rand(2, 4);
                return { question: `lim(x→0) (e^(${a}x) - 1)/${a}x = ?`, answer: 1, type: "procedural",
                    explanation: `Using L'Hôpital's or substitution: limit = 1` };
            }
        },
        Applications: () => {
            const type = pick(["critical", "maxmin"]);
            if (type === "critical") {
                const a = rand(1, 3);
                return { question: `f(x) = x² - ${2*a}x. Find critical point.`, answer: a, type: "procedural",
                    explanation: `f'(x) = 2x - ${2*a} = 0. x = ${a}` };
            } else {
                return { question: `If f'(c) = 0 and f''(c) > 0, then x = c is a...`, answer: "local minimum", type: "conceptual",
                    options: ["local minimum", "local maximum", "inflection point", "saddle point"],
                    explanation: `Second derivative test: f''(c) > 0 means concave up, so minimum` };
            }
        },
        "Differential Equations": () => {
            const type = pick(["identify", "verify", "separate"]);
            if (type === "identify") {
                const eqs = [
                    { eq: "dy/dx = 2x", order: 1, type: "first-order" },
                    { eq: "d²y/dx² + y = 0", order: 2, type: "second-order" },
                    { eq: "dy/dx = y", order: 1, type: "first-order" }
                ];
                const e = pick(eqs);
                return { question: `What order is ${e.eq}?`, answer: e.type, type: "conceptual",
                    options: ["first-order", "second-order", "third-order"],
                    explanation: `Highest derivative is ${e.order === 1 ? "dy/dx" : "d²y/dx²"}, so it's ${e.type}` };
            } else if (type === "verify") {
                const a = rand(2, 4);
                return { question: `Is y = e^(${a}x) a solution to dy/dx = ${a}y?`, answer: "yes", type: "conceptual",
                    options: ["yes", "no"],
                    explanation: `dy/dx = ${a}e^(${a}x) = ${a}y ✓ Yes, it satisfies the equation.` };
            } else {
                const a = rand(2, 5);
                return { question: `Solve: dy/dx = ${a}. What is y?`, answer: `${a}x + C`, type: "procedural",
                    options: [`${a}x + C`, `${a}x`, `x/${a} + C`, `e^(${a}x)`],
                    explanation: `Integrate both sides: y = ∫${a} dx = ${a}x + C` };
            }
        },
        "Chain Rule": () => {
            const type = pick(["basic", "trig", "exponential"]);
            if (type === "basic") {
                const a = rand(2, 4), n = rand(2, 4);
                return { question: `d/dx(${a}x + 1)^${n} = ?`, answer: `${a * n}(${a}x + 1)^${n - 1}`, type: "procedural",
                    options: [`${a * n}(${a}x + 1)^${n - 1}`, `${n}(${a}x + 1)^${n - 1}`, `${a}(${a}x + 1)^${n}`, `${n}x^${n - 1}`],
                    explanation: `Chain rule: ${n}(${a}x + 1)^${n-1} × ${a} = ${a * n}(${a}x + 1)^${n - 1}` };
            } else if (type === "trig") {
                const a = rand(2, 5);
                return { question: `d/dx[sin(${a}x)] = ?`, answer: `${a}cos(${a}x)`, type: "procedural",
                    options: [`${a}cos(${a}x)`, `cos(${a}x)`, `-${a}cos(${a}x)`, `${a}sin(${a}x)`],
                    explanation: `Chain rule: cos(${a}x) × ${a} = ${a}cos(${a}x)` };
            } else {
                const a = rand(2, 4);
                return { question: `d/dx[e^(${a}x)] = ?`, answer: `${a}e^(${a}x)`, type: "procedural",
                    options: [`${a}e^(${a}x)`, `e^(${a}x)`, `${a}e^x`, `xe^(${a}x)`],
                    explanation: `Chain rule: e^(${a}x) × ${a} = ${a}e^(${a}x)` };
            }
        },
        "Product Rule": () => {
            const type = pick(["basic", "trig"]);
            if (type === "basic") {
                const a = rand(2, 4);
                return { question: `d/dx[x · e^(${a}x)] = ?`, answer: `e^(${a}x) + ${a}xe^(${a}x)`, type: "procedural",
                    options: [`e^(${a}x) + ${a}xe^(${a}x)`, `${a}xe^(${a}x)`, `e^(${a}x)`, `${a}e^(${a}x)`],
                    explanation: `Product rule: (1)·e^(${a}x) + x·(${a}e^(${a}x)) = e^(${a}x) + ${a}xe^(${a}x)` };
            } else {
                return { question: `d/dx[x·sin(x)] = ?`, answer: "sin(x) + x·cos(x)", type: "procedural",
                    options: ["sin(x) + x·cos(x)", "x·cos(x)", "sin(x)", "cos(x)"],
                    explanation: `Product rule: (1)·sin(x) + x·cos(x) = sin(x) + x·cos(x)` };
            }
        },
        "Integration Techniques": () => {
            const type = pick(["substitution", "parts", "trig"]);
            if (type === "substitution") {
                const a = rand(2, 4);
                return { question: `∫${a}x·e^(x²) dx. What substitution?`, answer: "u = x²", type: "procedural",
                    options: ["u = x²", "u = e^(x²)", "u = x", "u = ${a}x"],
                    explanation: `Let u = x², du = 2x dx. Rewrite as (${a}/2)∫e^u du` };
            } else if (type === "parts") {
                return { question: `∫x·e^x dx uses integration by parts. What is u?`, answer: "u = x", type: "procedural",
                    options: ["u = x", "u = e^x", "u = xe^x", "u = 1"],
                    explanation: `LIATE rule: Logarithms, Inverse trig, Algebraic (x), Trig, Exponential. Pick u = x.` };
            } else {
                return { question: `∫sin²(x) dx uses which identity?`, answer: "sin²(x) = (1 - cos(2x))/2", type: "conceptual",
                    options: ["sin²(x) = (1 - cos(2x))/2", "sin²(x) + cos²(x) = 1", "sin(2x) = 2sin(x)cos(x)", "cos²(x) = (1 + cos(2x))/2"],
                    explanation: `Power-reducing: sin²(x) = (1 - cos(2x))/2 makes integration easier.` };
            }
        },
        "Quotient Rule": () => {
            const type = pick(["formula", "apply", "simplify"]);
            if (type === "formula") {
                return { question: `Quotient rule: d/dx[f/g] = ?`, answer: "(f'g - fg')/g²", type: "conceptual",
                    options: ["(f'g - fg')/g²", "(f'g + fg')/g²", "f'/g'", "(fg' - f'g)/g²"],
                    explanation: `Quotient rule: d/dx[f/g] = (f'g - fg')/g² (lo d-hi minus hi d-lo over lo-lo)` };
            } else if (type === "apply") {
                const a = rand(2, 4);
                return { question: `d/dx[x/(x + ${a})] = ?`, answer: `${a}/(x + ${a})²`, type: "procedural",
                    options: [`${a}/(x + ${a})²`, `1/(x + ${a})`, `x/(x + ${a})²`, `-${a}/(x + ${a})²`],
                    explanation: `f=x, g=x+${a}. (1·(x+${a}) - x·1)/(x+${a})² = ${a}/(x + ${a})²` };
            } else {
                return { question: `d/dx[sin(x)/x] at x = π/2 is approximately:`, answer: "-0.21", type: "procedural",
                    options: ["-0.21", "0.21", "0", "1"],
                    explanation: `(cos(x)·x - sin(x)·1)/x². At π/2: (0·π/2 - 1·1)/(π/2)² ≈ -0.21` };
            }
        },
        "Implicit Differentiation": () => {
            const type = pick(["circle", "product", "concept"]);
            if (type === "circle") {
                const r = rand(2, 5);
                return { question: `x² + y² = ${r*r}. Find dy/dx.`, answer: "-x/y", type: "procedural",
                    options: ["-x/y", "x/y", "-y/x", "y/x"],
                    explanation: `Differentiate: 2x + 2y(dy/dx) = 0. Solve: dy/dx = -x/y` };
            } else if (type === "product") {
                return { question: `xy = 6. Find dy/dx.`, answer: "-y/x", type: "procedural",
                    options: ["-y/x", "y/x", "-x/y", "-6/x²"],
                    explanation: `Product rule: y + x(dy/dx) = 0. So dy/dx = -y/x` };
            } else {
                return { question: `When do we use implicit differentiation?`, answer: "When y isn't isolated", type: "conceptual",
                    options: ["When y isn't isolated", "When y = f(x)", "For polynomials only", "When there's no y"],
                    explanation: `Implicit differentiation is used when y cannot be easily solved for as a function of x.` };
            }
        },
        "Related Rates": () => {
            const type = pick(["setup", "circle", "concept"]);
            if (type === "setup") {
                return { question: `Sphere volume V = (4/3)πr³. If dr/dt = 2, what is dV/dt when r = 3?`, answer: "72π", type: "procedural",
                    options: ["72π", "36π", "108π", "24π"],
                    explanation: `dV/dt = 4πr²(dr/dt) = 4π(3)²(2) = 72π` };
            } else if (type === "circle") {
                return { question: `Circle area A = πr². If dr/dt = 3, what is dA/dt when r = 5?`, answer: "30π", type: "procedural",
                    options: ["30π", "15π", "75π", "10π"],
                    explanation: `dA/dt = 2πr(dr/dt) = 2π(5)(3) = 30π` };
            } else {
                return { question: `In related rates, we differentiate with respect to:`, answer: "time (t)", type: "conceptual",
                    options: ["time (t)", "x", "y", "the dependent variable"],
                    explanation: `Related rates problems involve quantities changing with respect to time.` };
            }
        },
        "U-Substitution": () => {
            const type = pick(["identify", "solve", "reverse"]);
            if (type === "identify") {
                const a = rand(2, 4);
                return { question: `∫${a}x(x² + 1)³ dx. Best substitution?`, answer: "u = x² + 1", type: "procedural",
                    options: ["u = x² + 1", "u = x²", "u = ${a}x", "u = (x² + 1)³"],
                    explanation: `u = x² + 1, du = 2x dx. The ${a}x dx can be written as (${a}/2)du.` };
            } else if (type === "solve") {
                return { question: `∫2x·e^(x²) dx = ?`, answer: "e^(x²) + C", type: "procedural",
                    options: ["e^(x²) + C", "2e^(x²) + C", "x²e^(x²) + C", "e^(2x) + C"],
                    explanation: `u = x², du = 2x dx. ∫e^u du = e^u + C = e^(x²) + C` };
            } else {
                return { question: `If u = 3x + 2, then du = ?`, answer: "3 dx", type: "procedural",
                    options: ["3 dx", "dx", "3x dx", "(3x + 2) dx"],
                    explanation: `Differentiate u = 3x + 2: du/dx = 3, so du = 3 dx` };
            }
        },
        "Integration by Parts": () => {
            const type = pick(["formula", "choose_u", "apply"]);
            if (type === "formula") {
                return { question: `Integration by parts formula: ∫u dv = ?`, answer: "uv - ∫v du", type: "conceptual",
                    options: ["uv - ∫v du", "uv + ∫v du", "u dv - v du", "∫u·∫v"],
                    explanation: `Integration by parts: ∫u dv = uv - ∫v du` };
            } else if (type === "choose_u") {
                const funcs = [
                    { integral: "∫x·cos(x) dx", u: "x", reason: "LIATE: Algebraic before Trig" },
                    { integral: "∫x·e^x dx", u: "x", reason: "LIATE: Algebraic before Exponential" },
                    { integral: "∫ln(x) dx", u: "ln(x)", reason: "LIATE: Logarithm first" }
                ];
                const f = pick(funcs);
                return { question: `${f.integral}. What should u be?`, answer: f.u, type: "procedural",
                    options: ["x", "cos(x)", "e^x", "ln(x)"],
                    explanation: `${f.reason}. So u = ${f.u}` };
            } else {
                return { question: `∫x·e^x dx = ?`, answer: "xe^x - e^x + C", type: "procedural",
                    options: ["xe^x - e^x + C", "xe^x + C", "x²e^x/2 + C", "e^x + C"],
                    explanation: `u = x, dv = e^x dx. uv - ∫v du = xe^x - ∫e^x dx = xe^x - e^x + C` };
            }
        }
    },

    // TIER 10: Advanced (College)
    10: {
        "Partial Derivatives": () => {
            const a = rand(2, 5), b = rand(1, 4);
            const type = pick(["x", "y"]);
            if (type === "x") {
                return { question: `∂/∂x(${a}x²y + ${b}xy) = ?`, answer: `${2*a}xy + ${b}y`, type: "procedural",
                    options: [`${2*a}xy + ${b}y`, `${a}x²  + ${b}x`, `${2*a}x + ${b}`, `${a}y + ${b}y`],
                    explanation: `Treat y as constant: ∂/∂x(${a}x²y) = ${2*a}xy, ∂/∂x(${b}xy) = ${b}y` };
            } else {
                return { question: `∂/∂y(${a}x²y + ${b}y²) = ?`, answer: `${a}x² + ${2*b}y`, type: "procedural",
                    options: [`${a}x² + ${2*b}y`, `${2*a}xy + ${b}y`, `${a}x² + ${b}y`, `${2*a}x + ${2*b}y`],
                    explanation: `Treat x as constant: ∂/∂y(${a}x²y) = ${a}x², ∂/∂y(${b}y²) = ${2*b}y` };
            }
        },
        Matrices: () => {
            const type = pick(["determinant", "multiply_size"]);
            if (type === "determinant") {
                const a = rand(1, 4), b = rand(1, 4), c = rand(1, 4), d = rand(1, 4);
                const det = a * d - b * c;
                return { question: `det([${a} ${b}; ${c} ${d}]) = ?`, answer: det, type: "procedural",
                    explanation: `det = ad - bc = ${a}×${d} - ${b}×${c} = ${det}` };
            } else {
                const m = rand(2, 4), n = rand(2, 4), p = rand(2, 4);
                return { question: `(${m}×${n}) × (${n}×${p}) matrix = ?`, answer: `${m}×${p}`, type: "procedural",
                    options: [`${m}×${p}`, `${n}×${n}`, `${m}×${n}`, `${n}×${p}`],
                    explanation: `(m×n)(n×p) = m×p. Result: ${m}×${p}` };
            }
        },
        Series: () => {
            const type = pick(["geometric", "convergence"]);
            if (type === "geometric") {
                const a = rand(1, 3), r = pick([0.5, 0.25, 0.1]);
                const sum = a / (1 - r);
                return { question: `Sum of infinite geometric: a=${a}, r=${r}?`, answer: sum, type: "procedural",
                    explanation: `S = a/(1-r) = ${a}/(1-${r}) = ${a}/${1-r} = ${sum}` };
            } else {
                return { question: `Σ(1/n²) from n=1 to ∞ converges or diverges?`, answer: "converges", type: "conceptual",
                    options: ["converges", "diverges"],
                    explanation: `p-series with p=2 > 1, so it converges` };
            }
        },
        "Discrete Math": () => {
            const type = pick(["subsets", "pigeonhole"]);
            if (type === "subsets") {
                const n = rand(3, 6);
                return { question: `How many subsets of a ${n}-element set?`, answer: Math.pow(2, n), type: "procedural",
                    explanation: `2^n = 2^${n} = ${Math.pow(2, n)} subsets` };
            } else {
                const n = rand(3, 5);
                return { question: `${n*2 + 1} items in ${n} boxes. Min items in one box?`, answer: 3, type: "reasoning",
                    explanation: `Pigeonhole: ⌈${n*2+1}/${n}⌉ = ⌈${(n*2+1)/n}⌉ = 3` };
            }
        },
        "Multivariable Calculus": () => {
            const type = pick(["gradient", "double", "chain"]);
            if (type === "gradient") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `f(x,y) = ${a}x + ${b}y. Find ∇f.`, answer: `⟨${a}, ${b}⟩`, type: "procedural",
                    options: [`⟨${a}, ${b}⟩`, `⟨${b}, ${a}⟩`, `${a} + ${b}`, `⟨${a*b}, 0⟩`],
                    explanation: `∇f = ⟨∂f/∂x, ∂f/∂y⟩ = ⟨${a}, ${b}⟩` };
            } else if (type === "double") {
                const a = rand(2, 4);
                return { question: `∫∫ ${a} dA over unit square [0,1]×[0,1] = ?`, answer: a, type: "procedural",
                    explanation: `∫₀¹∫₀¹ ${a} dx dy = ${a}(1)(1) = ${a}` };
            } else {
                return { question: `If z = f(x,y), x = g(t), y = h(t), then dz/dt uses...`, answer: "chain rule", type: "conceptual",
                    options: ["chain rule", "product rule", "quotient rule", "power rule"],
                    explanation: `dz/dt = (∂z/∂x)(dx/dt) + (∂z/∂y)(dy/dt) - the multivariable chain rule` };
            }
        },
        "Linear Algebra": () => {
            const type = pick(["eigenvalue", "span", "independence"]);
            if (type === "eigenvalue") {
                const a = rand(2, 5);
                return { question: `If Av = ${a}v, then ${a} is called a(n)...`, answer: "eigenvalue", type: "conceptual",
                    options: ["eigenvalue", "eigenvector", "determinant", "trace"],
                    explanation: `When Av = λv, λ (here ${a}) is an eigenvalue and v is an eigenvector.` };
            } else if (type === "span") {
                return { question: `Vectors ⟨1,0⟩ and ⟨0,1⟩ span...`, answer: "ℝ²", type: "conceptual",
                    options: ["ℝ²", "ℝ", "ℝ³", "a line"],
                    explanation: `These two vectors can create any point in the plane, so they span ℝ²` };
            } else {
                return { question: `⟨1,2⟩ and ⟨2,4⟩ are linearly...`, answer: "dependent", type: "conceptual",
                    options: ["dependent", "independent"],
                    explanation: `⟨2,4⟩ = 2⟨1,2⟩, so one is a multiple of the other - linearly dependent` };
            }
        },
        Eigenvalues: () => {
            const type = pick(["definition", "calculate_2x2", "properties", "characteristic"]);
            if (type === "definition") {
                return { question: `In Av = λv, what is λ called?`, answer: "eigenvalue", type: "conceptual",
                    options: ["eigenvalue", "eigenvector", "determinant", "inverse"],
                    explanation: `λ is the eigenvalue. It's the scalar by which the eigenvector v is scaled under transformation A.` };
            } else if (type === "calculate_2x2") {
                // Simple 2x2 diagonal matrix
                const a = rand(1, 4), b = rand(1, 4);
                return { question: `Matrix [${a} 0; 0 ${b}]. Eigenvalues?`, answer: `${a}, ${b}`, type: "procedural",
                    options: [`${a}, ${b}`, `${a+b}, ${a*b}`, `0, ${a+b}`, `${a-b}, ${a+b}`],
                    explanation: `For diagonal matrices, eigenvalues are the diagonal entries: ${a} and ${b}` };
            } else if (type === "properties") {
                return { question: `Sum of eigenvalues equals the matrix's...`, answer: "trace", type: "conceptual",
                    options: ["trace", "determinant", "rank", "norm"],
                    explanation: `Sum of eigenvalues = trace (sum of diagonal elements)` };
            } else {
                return { question: `To find eigenvalues, we solve det(A - λI) = ?`, answer: "0", type: "conceptual",
                    options: ["0", "1", "λ", "det(A)"],
                    explanation: `The characteristic equation det(A - λI) = 0 gives us the eigenvalues.` };
            }
        },
        "Double Integrals": () => {
            const type = pick(["evaluate", "setup", "region", "order"]);
            if (type === "evaluate") {
                const a = rand(2, 4);
                return { question: `∫₀¹∫₀¹ ${a} dx dy = ?`, answer: a, type: "procedural",
                    options: [a, a * 2, a / 2, 1],
                    explanation: `∫₀¹∫₀¹ ${a} dx dy = ${a}∫₀¹ dx ∫₀¹ dy = ${a}(1)(1) = ${a}` };
            } else if (type === "setup") {
                const r = rand(2, 4);
                return { question: `Area of circle radius ${r} using double integral: ∫∫ dA = ?`, answer: `${r*r}π`, type: "procedural",
                    options: [`${r*r}π`, `${2*r}π`, `${r}π`, `${r*r*r}π`],
                    explanation: `∫∫ dA over circle = πr² = π(${r})² = ${r*r}π` };
            } else if (type === "region") {
                return { question: `∫₀²∫₀ˣ dy dx. What is the region?`, answer: "triangle with vertices (0,0), (2,0), (2,2)", type: "conceptual",
                    options: ["triangle with vertices (0,0), (2,0), (2,2)", "square [0,2]×[0,2]", "rectangle", "semicircle"],
                    explanation: `y goes from 0 to x (line y=x), x goes 0 to 2. Triangle below y=x.` };
            } else {
                return { question: `When should we change the order of integration?`, answer: "when one order is easier to evaluate", type: "conceptual",
                    options: ["when one order is easier to evaluate", "never", "always", "only for rectangles"],
                    explanation: `Changing order can simplify the integral if one direction has easier antiderivatives.` };
            }
        },
        "Triple Integrals": () => {
            const type = pick(["evaluate", "volume", "setup", "coordinates"]);
            if (type === "evaluate") {
                const a = rand(2, 4);
                return { question: `∫₀¹∫₀¹∫₀¹ ${a} dx dy dz = ?`, answer: a, type: "procedural",
                    options: [a, a * 3, a / 3, 1],
                    explanation: `∫₀¹∫₀¹∫₀¹ ${a} dx dy dz = ${a}(1)(1)(1) = ${a}` };
            } else if (type === "volume") {
                const s = rand(2, 4);
                return { question: `Volume of cube with side ${s} using ∫∫∫ dV = ?`, answer: s * s * s, type: "procedural",
                    options: [s * s * s, s * s, s * 3, 6 * s * s],
                    explanation: `∫∫∫ dV = s³ = ${s}³ = ${s * s * s}` };
            } else if (type === "setup") {
                return { question: `For sphere of radius R, which coordinates are best?`, answer: "spherical", type: "conceptual",
                    options: ["spherical", "Cartesian", "cylindrical", "polar"],
                    explanation: `Spherical coordinates (ρ, θ, φ) are best for spheres due to symmetry.` };
            } else {
                const r = rand(2, 3), h = rand(3, 5);
                return { question: `Volume of cylinder (radius ${r}, height ${h}) = ∫∫∫ dV = ?`, answer: `${r*r*h}π`, type: "procedural",
                    options: [`${r*r*h}π`, `${2*r*h}π`, `${r*r}π`, `${r*h}π`],
                    explanation: `V = πr²h = π(${r})²(${h}) = ${r*r*h}π` };
            }
        },
        "Vector Calculus": () => {
            const type = pick(["gradient", "divergence", "curl", "line_integral"]);
            if (type === "gradient") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `∇(${a}x² + ${b}y) = ?`, answer: `⟨${2*a}x, ${b}⟩`, type: "procedural",
                    options: [`⟨${2*a}x, ${b}⟩`, `⟨${a}x, ${b}y⟩`, `${2*a}x + ${b}`, `⟨${a}, ${b}⟩`],
                    explanation: `∇f = ⟨∂f/∂x, ∂f/∂y⟩ = ⟨${2*a}x, ${b}⟩` };
            } else if (type === "divergence") {
                const a = rand(2, 4), b = rand(2, 4);
                return { question: `div⟨${a}x, ${b}y⟩ = ∇·F = ?`, answer: a + b, type: "procedural",
                    options: [a + b, a * b, a - b, `${a}x + ${b}y`],
                    explanation: `∇·F = ∂(${a}x)/∂x + ∂(${b}y)/∂y = ${a} + ${b} = ${a + b}` };
            } else if (type === "curl") {
                return { question: `For F = ⟨y, -x, 0⟩, curl F = ∇×F has z-component:`, answer: "-2", type: "procedural",
                    options: ["-2", "2", "0", "1"],
                    explanation: `z-component of curl = ∂(-x)/∂x - ∂y/∂y = -1 - 1 = -2` };
            } else {
                return { question: `∫_C F·dr is called a:`, answer: "line integral", type: "conceptual",
                    options: ["line integral", "surface integral", "double integral", "gradient"],
                    explanation: `∫_C F·dr is a line integral - integrating a vector field along a curve C.` };
            }
        },
        "Real Analysis": () => {
            const type = pick(["limits", "continuity", "sequences", "series"]);
            if (type === "limits") {
                return { question: `The ε-δ definition of limit is: For all ε > 0, there exists δ > 0 such that...`, answer: "|f(x) - L| < ε when |x - a| < δ", type: "conceptual",
                    options: ["|f(x) - L| < ε when |x - a| < δ", "|f(x) - L| < δ when |x - a| < ε", "f(x) = L when x = a", "|f(x)| < ε"],
                    explanation: `The formal ε-δ definition captures that f(x) can be made arbitrarily close to L by making x sufficiently close to a.` };
            } else if (type === "continuity") {
                return { question: `A function f is continuous at a if:`, answer: "lim(x→a) f(x) = f(a)", type: "conceptual",
                    options: ["lim(x→a) f(x) = f(a)", "f(a) exists", "f is differentiable at a", "f has no jumps"],
                    explanation: `Continuity requires: (1) f(a) exists, (2) lim(x→a) f(x) exists, (3) they are equal.` };
            } else if (type === "sequences") {
                return { question: `A sequence (aₙ) is Cauchy if for all ε > 0:`, answer: "|aₘ - aₙ| < ε for large enough m, n", type: "conceptual",
                    options: ["|aₘ - aₙ| < ε for large enough m, n", "aₙ is bounded", "aₙ is increasing", "|aₙ| < ε"],
                    explanation: `A Cauchy sequence has terms that get arbitrarily close to each other as n increases.` };
            } else {
                return { question: `In ℝ, every Cauchy sequence:`, answer: "converges", type: "conceptual",
                    options: ["converges", "diverges", "oscillates", "is bounded"],
                    explanation: `ℝ is complete: every Cauchy sequence of real numbers converges to a real number.` };
            }
        },
        "Complex Analysis": () => {
            const type = pick(["residue", "cauchy", "analytic", "poles"]);
            if (type === "residue") {
                return { question: `The residue of f(z) = 1/z at z = 0 is:`, answer: "1", type: "procedural",
                    options: ["1", "0", "-1", "undefined"],
                    explanation: `For f(z) = 1/z, the Laurent series is just 1/z, so the coefficient of 1/z (residue) is 1.` };
            } else if (type === "cauchy") {
                return { question: `∮ₒ f(z)dz for analytic f on and inside C equals:`, answer: "0", type: "conceptual",
                    options: ["0", "2πi", "1", "πi"],
                    explanation: `Cauchy's theorem: the integral of an analytic function over a closed contour is 0.` };
            } else if (type === "analytic") {
                return { question: `The Cauchy-Riemann equations are:`, answer: "∂u/∂x = ∂v/∂y and ∂u/∂y = -∂v/∂x", type: "conceptual",
                    options: ["∂u/∂x = ∂v/∂y and ∂u/∂y = -∂v/∂x", "∂u/∂x = ∂v/∂x", "u = v", "∇²u = 0"],
                    explanation: `The Cauchy-Riemann equations are necessary conditions for f = u + iv to be analytic.` };
            } else {
                return { question: `f(z) = 1/(z-2) has a pole at z = ?`, answer: "2", type: "procedural",
                    options: ["2", "0", "-2", "1"],
                    explanation: `A pole occurs where the denominator is zero: z - 2 = 0, so z = 2.` };
            }
        },
        "Abstract Algebra": () => {
            const type = pick(["groups", "rings", "homomorphism", "subgroups"]);
            if (type === "groups") {
                const n = rand(2, 6);
                return { question: `Order of (ℤ/${n}ℤ, +)?`, answer: n, type: "procedural",
                    options: [n, n - 1, n + 1, 2 * n],
                    explanation: `ℤ/${n}ℤ has ${n} elements: {0, 1, 2, ..., ${n-1}}, so its order is ${n}.` };
            } else if (type === "rings") {
                return { question: `A ring must have:`, answer: "addition, multiplication, and additive identity", type: "conceptual",
                    options: ["addition, multiplication, and additive identity", "only addition", "a multiplicative inverse for all elements", "commutativity"],
                    explanation: `A ring requires an abelian group under addition, closed multiplication, and distributivity.` };
            } else if (type === "homomorphism") {
                return { question: `A group homomorphism φ: G → H preserves:`, answer: "the group operation", type: "conceptual",
                    options: ["the group operation", "only the identity", "all elements", "cardinality"],
                    explanation: `φ(ab) = φ(a)φ(b) - the operation is preserved. This implies φ(e) = e and φ(a⁻¹) = φ(a)⁻¹.` };
            } else {
                return { question: `Every group G has at least these two subgroups:`, answer: "{e} and G", type: "conceptual",
                    options: ["{e} and G", "ℤ and ℝ", "{0} and {1}", "none"],
                    explanation: `The trivial subgroup {e} and G itself are always subgroups of G.` };
            }
        },
        "Number Theory": () => {
            const type = pick(["prime", "gcd", "modular", "divisibility"]);
            if (type === "prime") {
                const n = pick([17, 19, 23, 29, 31]);
                return { question: `Is ${n} prime?`, answer: "yes", type: "procedural",
                    options: ["yes", "no"],
                    explanation: `${n} has no divisors other than 1 and itself, so it is prime.` };
            } else if (type === "gcd") {
                const a = rand(12, 24), b = rand(6, 18);
                const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
                const result = gcd(a, b);
                return { question: `gcd(${a}, ${b}) = ?`, answer: result, type: "procedural",
                    options: [result, a, b, 1],
                    explanation: `Using Euclidean algorithm: gcd(${a}, ${b}) = ${result}` };
            } else if (type === "modular") {
                const a = rand(10, 20), m = rand(3, 7);
                return { question: `${a} mod ${m} = ?`, answer: a % m, type: "procedural",
                    options: [a % m, (a % m) + 1, m, a],
                    explanation: `${a} = ${Math.floor(a/m)}×${m} + ${a % m}, so ${a} mod ${m} = ${a % m}` };
            } else {
                const a = rand(2, 5), b = rand(3, 8);
                return { question: `${a} | ${a * b} means:`, answer: `${a} divides ${a * b}`, type: "conceptual",
                    options: [`${a} divides ${a * b}`, `${a * b} divides ${a}`, `${a} = ${a * b}`, `${a} > ${a * b}`],
                    explanation: `a | b means "a divides b" - there exists integer k such that b = ak. Here ${a * b} = ${a}×${b}.` };
            }
        },
        "Advanced Number Theory": () => {
            const type = pick(["fermat", "euler", "quadratic_residue", "diophantine"]);
            if (type === "fermat") {
                const p = pick([5, 7, 11, 13]);
                const a = rand(2, p - 1);
                return { question: `By Fermat's Little Theorem, ${a}^${p-1} mod ${p} = ?`, answer: "1", type: "procedural",
                    options: ["1", "0", `${a}`, `${p}`],
                    explanation: `Fermat: aᵖ⁻¹ ≡ 1 (mod p) for prime p and gcd(a,p) = 1. So ${a}^${p-1} ≡ 1 (mod ${p}).` };
            } else if (type === "euler") {
                return { question: `Euler's totient φ(p) for prime p equals:`, answer: "p - 1", type: "conceptual",
                    options: ["p - 1", "p", "p + 1", "1"],
                    explanation: `For prime p, all numbers 1 to p-1 are coprime to p, so φ(p) = p - 1.` };
            } else if (type === "quadratic_residue") {
                return { question: `3 is a quadratic residue mod 7 if:`, answer: "x² ≡ 3 (mod 7) has a solution", type: "conceptual",
                    options: ["x² ≡ 3 (mod 7) has a solution", "3 | 7", "7 | 3", "gcd(3,7) = 1"],
                    explanation: `a is a quadratic residue mod n if x² ≡ a (mod n) is solvable. Here, 3² = 9 ≡ 2 ≠ 3, 5² = 25 ≡ 4 ≠ 3, etc.` };
            } else {
                return { question: `ax + by = gcd(a,b) always has:`, answer: "integer solutions", type: "conceptual",
                    options: ["integer solutions", "no solutions", "unique solutions", "infinite prime solutions"],
                    explanation: `Bézout's identity: For any integers a,b, there exist integers x,y such that ax + by = gcd(a,b).` };
            }
        },
        "Mathematical Logic": () => {
            const type = pick(["propositional", "predicate", "proof", "completeness"]);
            if (type === "propositional") {
                return { question: `p → q is logically equivalent to:`, answer: "¬p ∨ q", type: "conceptual",
                    options: ["¬p ∨ q", "p ∨ q", "p ∧ q", "¬p ∧ q"],
                    explanation: `"If p then q" is false only when p is true and q is false. This matches ¬p ∨ q.` };
            } else if (type === "predicate") {
                return { question: `¬∀x P(x) is equivalent to:`, answer: "∃x ¬P(x)", type: "conceptual",
                    options: ["∃x ¬P(x)", "∀x ¬P(x)", "¬∃x P(x)", "∀x P(x)"],
                    explanation: `"Not all x satisfy P" means "there exists some x that doesn't satisfy P."` };
            } else if (type === "proof") {
                return { question: `To prove "if P then Q" by contrapositive, we prove:`, answer: "if ¬Q then ¬P", type: "conceptual",
                    options: ["if ¬Q then ¬P", "if Q then P", "¬P and ¬Q", "P or ¬Q"],
                    explanation: `The contrapositive ¬Q → ¬P is logically equivalent to P → Q.` };
            } else {
                return { question: `Gödel's Completeness Theorem states:`, answer: "every valid formula is provable", type: "conceptual",
                    options: ["every valid formula is provable", "some true statements are unprovable", "all statements are provable", "logic is inconsistent"],
                    explanation: `Completeness: if a first-order formula is true in all models, it has a formal proof.` };
            }
        },
        "Differential Geometry": () => {
            const type = pick(["curvature", "manifold", "geodesic", "tangent"]);
            if (type === "curvature") {
                const r = rand(2, 5);
                return { question: `Curvature κ of a circle with radius ${r}:`, answer: `1/${r}`, type: "procedural",
                    options: [`1/${r}`, `${r}`, `2π${r}`, `π${r}²`],
                    explanation: `For a circle, curvature κ = 1/r. Smaller radius means higher curvature (tighter turn).` };
            } else if (type === "manifold") {
                return { question: `A 2-dimensional manifold is locally like:`, answer: "ℝ²", type: "conceptual",
                    options: ["ℝ²", "ℝ³", "a sphere", "a circle"],
                    explanation: `An n-manifold is locally homeomorphic to ℝⁿ. A 2-manifold looks like a plane near any point.` };
            } else if (type === "geodesic") {
                return { question: `On a sphere, geodesics are:`, answer: "great circles", type: "conceptual",
                    options: ["great circles", "small circles", "straight lines", "spirals"],
                    explanation: `Geodesics are shortest paths. On a sphere, these are arcs of great circles (like the equator).` };
            } else {
                return { question: `The tangent space TₚM at point p is:`, answer: "a vector space of tangent vectors at p", type: "conceptual",
                    options: ["a vector space of tangent vectors at p", "the manifold itself", "a single vector", "the normal line"],
                    explanation: `TₚM contains all vectors tangent to M at p, forming a vector space of the same dimension as M.` };
            }
        },
        Topology: () => {
            const type = pick(["open_sets", "continuity", "homeomorphism", "compactness"]);
            if (type === "open_sets") {
                return { question: `In a topology, the intersection of two open sets is:`, answer: "open", type: "conceptual",
                    options: ["open", "closed", "neither", "undefined"],
                    explanation: `By definition, a topology must be closed under finite intersections of open sets.` };
            } else if (type === "continuity") {
                return { question: `f: X → Y is continuous if the preimage of every open set is:`, answer: "open", type: "conceptual",
                    options: ["open", "closed", "compact", "connected"],
                    explanation: `Topological continuity: f⁻¹(U) is open in X for every open U in Y.` };
            } else if (type === "homeomorphism") {
                return { question: `A coffee cup and a donut are topologically equivalent because:`, answer: "they have the same number of holes (genus 1)", type: "conceptual",
                    options: ["they have the same number of holes (genus 1)", "they have the same volume", "they are both round", "they can both hold liquid"],
                    explanation: `Both have exactly one hole (handle/hole), so they're homeomorphic - can be continuously deformed into each other.` };
            } else {
                return { question: `[0, 1] is compact in ℝ because:`, answer: "it is closed and bounded", type: "conceptual",
                    options: ["it is closed and bounded", "it contains 0", "it is connected", "it is finite"],
                    explanation: `Heine-Borel: In ℝⁿ, compact ⟺ closed and bounded. [0,1] satisfies both.` };
            }
        },
        "Advanced Statistics": () => {
            const type = pick(["hypothesis", "confidence", "regression", "bayesian"]);
            if (type === "hypothesis") {
                return { question: `In hypothesis testing, the p-value represents:`, answer: "probability of observing data as extreme given H₀ is true", type: "conceptual",
                    options: ["probability of observing data as extreme given H₀ is true", "probability H₀ is true", "probability of Type II error", "the sample mean"],
                    explanation: `p-value = P(data as or more extreme | H₀ true). It's NOT the probability that H₀ is true.` };
            } else if (type === "confidence") {
                return { question: `A 95% confidence interval means:`, answer: "95% of intervals from repeated sampling contain the true parameter", type: "conceptual",
                    options: ["95% of intervals from repeated sampling contain the true parameter", "95% probability the parameter is in this interval", "the parameter is in the interval 95% of the time", "95% of data is in the interval"],
                    explanation: `Frequentist interpretation: 95% of CIs constructed this way would contain the true value.` };
            } else if (type === "regression") {
                return { question: `In linear regression, R² measures:`, answer: "proportion of variance explained by the model", type: "conceptual",
                    options: ["proportion of variance explained by the model", "the slope", "correlation", "standard error"],
                    explanation: `R² = 1 - (SS_residual/SS_total). It ranges from 0 to 1; higher means better fit.` };
            } else {
                return { question: `Bayes' theorem: P(A|B) = ?`, answer: "P(B|A)P(A) / P(B)", type: "conceptual",
                    options: ["P(B|A)P(A) / P(B)", "P(A)P(B)", "P(A) + P(B)", "P(A|B)P(B)"],
                    explanation: `Bayes: P(A|B) = P(B|A)P(A)/P(B). Updates prior P(A) with likelihood P(B|A).` };
            }
        },
        "Applied Mathematics": () => {
            const type = pick(["modeling", "optimization", "numerical", "ode"]);
            if (type === "modeling") {
                return { question: `Population growth P' = kP is called:`, answer: "exponential growth model", type: "conceptual",
                    options: ["exponential growth model", "logistic model", "linear model", "harmonic model"],
                    explanation: `dP/dt = kP has solution P = P₀eᵏᵗ - exponential growth (or decay if k < 0).` };
            } else if (type === "optimization") {
                return { question: `At a local minimum, the gradient ∇f equals:`, answer: "0 (zero vector)", type: "conceptual",
                    options: ["0 (zero vector)", "1", "undefined", "maximum"],
                    explanation: `First-order necessary condition: ∇f = 0 at local extrema. Need second derivatives to classify.` };
            } else if (type === "numerical") {
                return { question: `Euler's method approximates y' = f(x,y) using:`, answer: "yₙ₊₁ = yₙ + hf(xₙ, yₙ)", type: "conceptual",
                    options: ["yₙ₊₁ = yₙ + hf(xₙ, yₙ)", "y'' = f(x,y)", "∫f dx", "y = eˣ"],
                    explanation: `Euler: step forward using the tangent line. yₙ₊₁ = yₙ + h×slope, where slope = f(xₙ, yₙ).` };
            } else {
                return { question: `The heat equation ∂u/∂t = k∂²u/∂x² is a:`, answer: "parabolic PDE", type: "conceptual",
                    options: ["parabolic PDE", "elliptic PDE", "hyperbolic PDE", "ODE"],
                    explanation: `Heat/diffusion equations are parabolic. Wave equations are hyperbolic. Laplace's equation is elliptic.` };
            }
        },
        "Theoretical Mathematics": () => {
            const type = pick(["foundations", "proof_theory", "set_theory", "axioms"]);
            if (type === "foundations") {
                return { question: `ZFC stands for:`, answer: "Zermelo-Fraenkel with Choice", type: "conceptual",
                    options: ["Zermelo-Fraenkel with Choice", "Zero-Free Calculus", "Zorn's Fundamental Conjecture", "Zeros and Functions of C"],
                    explanation: `ZFC is the standard axiomatic system for modern mathematics, including the Axiom of Choice.` };
            } else if (type === "proof_theory") {
                return { question: `Gödel's Incompleteness Theorem states:`, answer: "any consistent system has unprovable true statements", type: "conceptual",
                    options: ["any consistent system has unprovable true statements", "all statements are provable", "mathematics is inconsistent", "proofs are unnecessary"],
                    explanation: `Gödel showed that sufficiently powerful, consistent systems contain true statements that cannot be proved within the system.` };
            } else if (type === "set_theory") {
                return { question: `|ℕ| = |ℤ| = |ℚ| is called:`, answer: "ℵ₀ (aleph-null)", type: "conceptual",
                    options: ["ℵ₀ (aleph-null)", "ℵ₁", "∞", "ω"],
                    explanation: `ℕ, ℤ, and ℚ are all countably infinite with cardinality ℵ₀ (aleph-null).` };
            } else {
                return { question: `The Continuum Hypothesis states:`, answer: "there's no set with cardinality between ℵ₀ and |ℝ|", type: "conceptual",
                    options: ["there's no set with cardinality between ℵ₀ and |ℝ|", "ℝ is countable", "all sets are finite", "ℵ₀ = ℵ₁"],
                    explanation: `CH: |ℝ| = ℵ₁. Gödel and Cohen proved CH is independent of ZFC - it can't be proved or disproved.` };
            }
        },
        "Advanced Computational Methods": () => {
            const type = pick(["complexity", "algorithms", "numerical", "approximation"]);
            if (type === "complexity") {
                return { question: `O(n log n) is the best possible for:`, answer: "comparison-based sorting", type: "conceptual",
                    options: ["comparison-based sorting", "searching", "matrix multiplication", "addition"],
                    explanation: `Information-theoretic lower bound: n! permutations require log(n!) = Ω(n log n) comparisons to distinguish.` };
            } else if (type === "algorithms") {
                return { question: `The Master Theorem solves recurrences of the form:`, answer: "T(n) = aT(n/b) + f(n)", type: "conceptual",
                    options: ["T(n) = aT(n/b) + f(n)", "T(n) = T(n-1) + n", "T(n) = 2ⁿ", "T(n) = n!"],
                    explanation: `Master Theorem handles divide-and-conquer recurrences T(n) = aT(n/b) + f(n).` };
            } else if (type === "numerical") {
                return { question: `Newton's method converges:`, answer: "quadratically (doubles digits each step)", type: "conceptual",
                    options: ["quadratically (doubles digits each step)", "linearly", "logarithmically", "never"],
                    explanation: `Near a root, Newton's method has quadratic convergence: error ≈ C(error)² each iteration.` };
            } else {
                return { question: `Monte Carlo methods use:`, answer: "random sampling to estimate quantities", type: "conceptual",
                    options: ["random sampling to estimate quantities", "exact calculations", "symbolic computation", "recursive calls"],
                    explanation: `Monte Carlo: use randomness to estimate integrals, expectations, or solve problems probabilistically.` };
            }
        }
    }
};

// ========================================
// LESSON GENERATORS FOR LEARNING CENTER
// ========================================
const lessons = {
    1: {
        Counting: () => {
            return {
                goalProblem: `Count the stars: ★ ★ ★ ★ ★ ★`,
                teachingSteps: [
                    {
                        title: "What is counting?",
                        explanation: "Counting means finding out <strong>how many</strong> things there are. We say numbers in order (1, 2, 3, 4...) while pointing to each item.",
                        visual: "1 → 2 → 3 → 4 → 5 → ..."
                    },
                    {
                        title: "The Golden Rule: One touch, one number",
                        explanation: "Point to each item <strong>exactly once</strong>. Don't skip any items, and don't count any item twice!",
                        visual: "★ = 1 count (not 0, not 2)"
                    },
                    {
                        title: "Let's count our stars - Start at the left",
                        explanation: "We always start on the left side and move right. This keeps us organized. Touch the first star and say '1'.",
                        visual: "★(1)  ★  ★  ★  ★  ★"
                    },
                    {
                        title: "Keep going - touch and count each star",
                        explanation: "Move to the next star, say the next number. Keep going until you've touched every star.",
                        visual: "★(1) ★(2) ★(3) ★(4) ★(5) ★(6)"
                    },
                    {
                        title: "The answer is the LAST number you said",
                        explanation: "We stopped at 6. That means there are 6 stars! The last number always tells you the total.",
                        visual: "Last number said = <strong>6</strong>"
                    }
                ],
                finalAnswer: "6 stars",
                answerExplanation: "We counted each star once, from left to right: 1, 2, 3, 4, 5, 6. The last number (6) is our answer!",
                example: { problem: `Count the stars: ★ ★ ★ ★ ★ ★`, steps: [
                    { text: "Start at the left and point to each star", math: "★(1) ★(2) ★(3) ★(4) ★(5) ★(6)" },
                    { text: "Say each number as you touch each star", math: "One... two... three... four... five... six" },
                    { text: "The LAST number you said is your answer", math: "We stopped at 6, so there are <strong>6 stars</strong>" }
                ]},
                keyPoints: [
                    "Point to each item as you count - this keeps you organized",
                    "The LAST number you say tells you the total",
                    "Go slow! It's better to be careful than fast"
                ],
                mistakes: [
                    { wrong: "Counting too fast and skipping items", why: "Touch each item as you count. Say the number out loud." },
                    { wrong: "Counting the same item twice", why: "Move left to right in a line. Mark items if needed." },
                    { wrong: "Stopping before counting all items", why: "Make sure you've touched every single item." }
                ],
                guided: {
                    problem: `Count the dots: ● ● ● ● ●`,
                    steps: [
                        { label: "Touch and count each dot", value: "●(1) ●(2) ●(3) ●(4) ●(5)" },
                        { label: "What was the last number?", value: "?" }
                    ],
                    answer: "5",
                    answerLabel: "How many dots?",
                    interactiveSteps: [
                        {
                            prompt: "When counting, we touch each item and say a number. Start at the first dot - what number do you say?",
                            hint: "We always start counting at...",
                            answer: "1",
                            acceptableAnswers: ["1", "one"],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                "0": "We start counting at 1, not 0! Touch the first dot and say '1'.",
                                "2": "Start at the beginning! The first item is always 1."
                            }
                        },
                        {
                            prompt: "Now count each dot from left to right: ●(1) ●(2) ●(3) ●(4) ●(?). What number goes on the last dot?",
                            hint: "After 4 comes...",
                            answer: "5",
                            acceptableAnswers: ["5", "five"],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                "4": "You stopped too early! After ●(4), there's one more dot.",
                                "6": "Count again - there are only 5 dots, not 6."
                            }
                        },
                        {
                            prompt: "The LAST number you said tells you the total. How many dots are there?",
                            hint: "What was the last number you counted to?",
                            answer: "5",
                            acceptableAnswers: ["5", "five", "5 dots"],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                "1": "That's the first number. The LAST number (5) tells us the total!",
                                "15": "Don't add up the numbers! The last number you said IS the answer."
                            }
                        }
                    ]
                },
                practice: { problem: `Count: ▲ ▲ ▲ ▲ ▲ ▲ ▲`, answer: "7", options: ["5", "6", "7", "8"],
                    mistakeAnalysis: {
                        "5": "You missed 2 triangles. Go slower - point to EACH one: ▲(1) ▲(2) ▲(3) ▲(4) ▲(5) ▲(6) ▲(7)",
                        "6": "You missed 1 triangle. Count again carefully from left to right.",
                        "8": "You counted one triangle twice. Remember: each item gets counted only ONCE."
                    }}
            };
        },
        Addition: () => {
            const a = rand(3, 6), b = rand(2, 4);
            return {
                goalProblem: `What is 5 + 3?`,
                teachingSteps: [
                    {
                        title: "What does addition mean?",
                        explanation: "Addition means <strong>putting two groups together</strong> to find the total. The + sign means 'add' or 'plus'.",
                        visual: "●●● + ●● = ?"
                    },
                    {
                        title: "The counting-up method",
                        explanation: "To add, we <strong>start at the first number</strong> and <strong>count up</strong> by the second number. Where we land is our answer!",
                        visual: "Start → Count up → Land on answer"
                    },
                    {
                        title: "Let's solve 5 + 3 - Start at 5",
                        explanation: "Put your finger on 5. This is where we <strong>start</strong>. Don't count 5 as 'one' - it's our starting point!",
                        visual: "Start at: 5"
                    },
                    {
                        title: "Now count up 3 times",
                        explanation: "Starting from 5, count up 3 numbers: <strong>6, 7, 8</strong>. Use your fingers to keep track - put up 3 fingers and lower one for each count.",
                        visual: "5 → 6 (one) → 7 (two) → 8 (three)"
                    },
                    {
                        title: "Where did we land?",
                        explanation: "We landed on <strong>8</strong>! That's our answer. We can check: 5 dots + 3 dots = 8 dots.",
                        visual: "●●●●● + ●●● = ●●●●●●●●"
                    }
                ],
                finalAnswer: "5 + 3 = 8",
                answerExplanation: "Starting at 5 and counting up 3 times (6, 7, 8), we land on 8!",
                example: { problem: `What is 5 + 3?`, steps: [
                    { text: "Start at the first number", math: "Put your finger on 5" },
                    { text: "Count UP by the second number (3 times)", math: "5... then 6, 7, 8 (that's 3 more)" },
                    { text: "You landed on 8!", math: "5 + 3 = <strong>8</strong>" }
                ]},
                keyPoints: [
                    "Start AT the first number (don't count it as 'one')",
                    "Count up as many times as the second number says",
                    "You can also add by combining: ●●●●● + ●●● = ●●●●●●●● (8 dots)"
                ],
                mistakes: [
                    { wrong: "Counting the first number (5, 6, 7, 8 = wrong!)", why: "START at 5, then count 6, 7, 8. That's adding 3." },
                    { wrong: "Writing 5 + 3 = 53", why: "We're not putting digits next to each other - we're combining amounts!" },
                    { wrong: "Losing track of how many you counted up", why: "Use your fingers to keep track: hold up 3 fingers and put them down one by one." }
                ],
                guided: {
                    problem: `What is ${a} + ${b}?`,
                    steps: [
                        { label: "Start at", value: `${a}` },
                        { label: `Count up ${b} more`, value: `${a}... ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}` },
                        { label: "You landed on", value: "?" }
                    ],
                    answer: String(a + b),
                    answerLabel: `${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `To add ${a} + ${b}, we start at the first number. What number do we start at?`,
                            hint: "Look at the first number in the problem",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `That's the second number. We START at the first number: ${a}`,
                                "1": `Don't start at 1! Start at the first number: ${a}`,
                                "0": `Start at ${a}, not at 0!`
                            }
                        },
                        {
                            prompt: `Now count UP ${b} times from ${a}. Say the numbers out loud: ${a}... then what comes next?`,
                            hint: `What's one more than ${a}?`,
                            answer: String(a + 1),
                            acceptableAnswers: [String(a + 1)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a)]: `${a} is where we started. Now count UP one: ${a + 1}`,
                                [String(a + b)]: `That's the final answer! But let's count up one at a time. After ${a} comes ${a + 1}`
                            }
                        },
                        {
                            prompt: `Keep counting! ${a}, ${a + 1}... After counting up ${b} times total, where do you land?`,
                            hint: `Count: ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}`,
                            answer: String(a + b),
                            acceptableAnswers: [String(a + b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a + b - 1)]: `You stopped one short! Count ${b} full times: ${Array.from({length: b}, (_, i) => a + i + 1).join(', ')}`,
                                [String(a + b + 1)]: `You counted one too many! Only count up ${b} times.`,
                                [String(a)]: `You didn't count up! Starting at ${a}, count up ${b} more.`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1, pb = b; return { problem: `What is ${pa} + ${pb}?`, answer: String(pa + pb),
                    options: shuffle([String(pa + pb), String(pa + pb - 1), String(pa + pb + 1), String(pa + pb - 2)]),
                    mistakeAnalysis: {
                        [String(pa + pb - 1)]: `You undercounted by 1. Start at ${pa}, then count up ${pb}: ${Array.from({length: pb}, (_, i) => pa + i + 1).join(', ')}`,
                        [String(pa + pb + 1)]: "You counted one too many. Make sure you only count up " + pb + " times.",
                        [String(pa + pb - 2)]: `You undercounted by 2. Remember to count up exactly ${pb} times from ${pa}.`
                    }}; })()
            };
        },
        Subtraction: () => {
            const a = rand(8, 12), b = rand(3, 5);
            return {
                goalProblem: `What is 9 - 4?`,
                teachingSteps: [
                    {
                        title: "What does subtraction mean?",
                        explanation: "Subtraction means <strong>taking away</strong> from a group. The − sign (minus) means 'take away' or 'subtract'.",
                        visual: "●●●●●●●●● take away ●●●● = ?"
                    },
                    {
                        title: "The counting-back method",
                        explanation: "To subtract, we <strong>start at the first number</strong> and <strong>count backwards</strong> by the second number. Where we land is our answer!",
                        visual: "Start → Count back → Land on answer"
                    },
                    {
                        title: "Let's solve 9 - 4 - Start at 9",
                        explanation: "Put your finger on 9. This is where we <strong>start</strong>. Don't count 9 as 'one' - it's our starting point!",
                        visual: "Start at: 9"
                    },
                    {
                        title: "Now count BACK 4 times",
                        explanation: "Starting from 9, count backwards 4 numbers: <strong>8, 7, 6, 5</strong>. Use your fingers - put up 4 fingers and lower one for each count back.",
                        visual: "9 → 8 (one) → 7 (two) → 6 (three) → 5 (four)"
                    },
                    {
                        title: "Where did we land?",
                        explanation: "We landed on <strong>5</strong>! That's our answer. Think of it as: 'I had 9 things, I took away 4, now I have 5 left.'",
                        visual: "●●●●●●●●● − ●●●● = ●●●●●"
                    }
                ],
                finalAnswer: "9 - 4 = 5",
                answerExplanation: "Starting at 9 and counting back 4 times (8, 7, 6, 5), we land on 5!",
                example: { problem: `What is 9 - 4?`, steps: [
                    { text: "Start at the first number", math: "Put your finger on 9" },
                    { text: "Count BACK by the second number (4 times)", math: "9... then 8, 7, 6, 5 (that's going back 4)" },
                    { text: "You landed on 5!", math: "9 - 4 = <strong>5</strong>" }
                ]},
                keyPoints: [
                    "Start AT the first number, then count backwards",
                    "Count back as many times as the second number says",
                    "Think: 'I have 9, I take away 4, I have 5 left'"
                ],
                mistakes: [
                    { wrong: "Counting the starting number (9, 8, 7, 6 = wrong!)", why: "START at 9, then go back: 8, 7, 6, 5. The answer is 5." },
                    { wrong: "Adding instead of subtracting", why: "The minus sign (−) means go DOWN, not up!" },
                    { wrong: "Subtracting in the wrong order (4 - 9)", why: "Always start with the FIRST number. 9 - 4 is not the same as 4 - 9." }
                ],
                guided: {
                    problem: `What is ${a} - ${b}?`,
                    steps: [
                        { label: "Start at", value: `${a}` },
                        { label: `Count back ${b}`, value: `${a}... ${Array.from({length: b}, (_, i) => a - i - 1).join(', ')}` },
                        { label: "You landed on", value: "?" }
                    ],
                    answer: String(a - b),
                    answerLabel: `${a} - ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `For ${a} - ${b}, we start at the first number. What number do we start at?`,
                            hint: "Look at the first number in the problem",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `That's the second number. We START at ${a}`,
                                [String(a - b)]: `That's the answer! But first we need to start at ${a}`
                            }
                        },
                        {
                            prompt: `Now count BACK (down) ${b} times. Starting at ${a}, what's the first number when we go back?`,
                            hint: `What's one less than ${a}?`,
                            answer: String(a - 1),
                            acceptableAnswers: [String(a - 1)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a)]: `${a} is where we started. Now go BACK one: ${a - 1}`,
                                [String(a + 1)]: `That's going UP! We need to go DOWN (subtract). One less than ${a} is ${a - 1}`
                            }
                        },
                        {
                            prompt: `Keep counting back! ${a}, ${a - 1}... After counting back ${b} times, where do you land?`,
                            hint: `Count backwards: ${Array.from({length: b}, (_, i) => a - i - 1).join(', ')}`,
                            answer: String(a - b),
                            acceptableAnswers: [String(a - b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a - b + 1)]: `You didn't count back far enough! Go back ${b} full times.`,
                                [String(a - b - 1)]: `You counted back one too many! Only count back ${b} times.`,
                                [String(a + b)]: `You added instead of subtracted! Count BACKWARDS from ${a}.`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1; return { problem: `What is ${pa} - ${b}?`, answer: String(pa - b),
                    options: shuffle([String(pa - b), String(pa - b - 1), String(pa - b + 1), String(pa + b)]),
                    mistakeAnalysis: {
                        [String(pa - b - 1)]: "You went back one too many. Count carefully: start at " + pa + " and go back exactly " + b + " times.",
                        [String(pa - b + 1)]: "You didn't go back enough. Make sure you count back " + b + " full times.",
                        [String(pa + b)]: "Oops! You added instead of subtracted. The − sign means count BACKWARDS."
                    }}; })()
            };
        },
        Shapes: () => ({
            goalProblem: `How many sides does a triangle have?`,
            teachingSteps: [
                {
                    title: "What is a 'side'?",
                    explanation: "A <strong>side</strong> is a straight line on the outside edge of a shape. We count these lines to identify shapes!",
                    visual: "Side = one straight edge"
                },
                {
                    title: "Shape names come from number of sides",
                    explanation: "Each shape has a special name based on how many sides it has. The name gives us a clue!",
                    visual: "TRI = 3 | QUAD = 4 | PENTA = 5 | HEXA = 6"
                },
                {
                    title: "Let's look at a triangle",
                    explanation: "Here's a triangle: △. We need to count how many straight lines make up its edges.",
                    visual: "△"
                },
                {
                    title: "Count each side",
                    explanation: "Go around the triangle and count each straight edge: one on the left, one on the right, one on the bottom.",
                    visual: "Side 1 (left) + Side 2 (right) + Side 3 (bottom)"
                },
                {
                    title: "The answer is in the name!",
                    explanation: "<strong>TRI</strong> means 3. A <strong>TRI</strong>angle has <strong>3 sides</strong>. The name tells us the answer!",
                    visual: "TRI-angle = 3 sides"
                }
            ],
            finalAnswer: "3 sides",
            answerExplanation: "A triangle has 3 sides. 'Tri' means 3, so TRI-angle = 3 angles and 3 sides!",
            example: { problem: `How many sides does a triangle have?`, steps: [
                { text: "Look at the triangle", math: "△" },
                { text: "Count each straight edge around the outside", math: "Side 1 (left) + Side 2 (right) + Side 3 (bottom) = 3" },
                { text: "A triangle has...", math: "<strong>3 sides</strong> (that's why it's called a TRI-angle!)" }
            ]},
            keyPoints: [
                "TRI means 3 → Triangle has 3 sides",
                "QUAD means 4 → Quadrilateral has 4 sides",
                "PENTA means 5 → Pentagon has 5 sides",
                "HEXA means 6 → Hexagon has 6 sides"
            ],
            mistakes: [
                { wrong: "Confusing sides with corners", why: "Sides are the LINES. Corners are where lines MEET." },
                { wrong: "Thinking a circle has 1 side", why: "A circle has 0 straight sides - it's curved all around!" }
            ],
            guided: {
                problem: `How many sides does a square have?`,
                steps: [
                    { label: "Picture the square", value: "□ (it has a top, bottom, left, and right)" },
                    { label: "Count the sides", value: "Top(1) + Right(2) + Bottom(3) + Left(4)" },
                    { label: "Total sides", value: "?" }
                ],
                answer: "4",
                answerLabel: "Number of sides:",
                interactiveSteps: [
                    {
                        prompt: "What is a 'side' of a shape?",
                        hint: "It's one of the straight lines on the edge...",
                        answer: "straight edge",
                        acceptableAnswers: ["straight edge", "straight line", "edge", "line", "a line", "a straight line"],
                        formatHint: "e.g., edge, line",
                        commonMistakes: {
                            "corner": "A corner is where two sides MEET. A side is the straight line itself!",
                            "angle": "An angle is formed where sides meet. A side is the straight edge."
                        }
                    },
                    {
                        prompt: "Look at a square: □. Start at the top and go around. How many straight lines do you count?",
                        hint: "Count: top, right side, bottom, left side...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "2": "You might have only counted top/bottom or left/right. Count ALL four sides!",
                            "8": "Each side is counted ONCE. Go around: top(1), right(2), bottom(3), left(4)."
                        }
                    },
                    {
                        prompt: "A square has 4 sides. What do we call a shape with 4 sides?",
                        hint: "QUAD means 4...",
                        answer: "quadrilateral",
                        acceptableAnswers: ["quadrilateral", "quad", "rectangle", "square"],
                        formatHint: "Name the shape",
                        commonMistakes: {
                            "triangle": "TRI means 3. A shape with 4 sides is a QUADrilateral (QUAD = 4)",
                            "pentagon": "PENTA means 5. A shape with 4 sides is a QUADrilateral."
                        }
                    }
                ]
            },
            practice: { problem: `How many sides does a hexagon have?`, answer: "6", options: ["4", "5", "6", "8"],
                mistakeAnalysis: {
                    "4": "That's a quadrilateral/square. HEXA means 6!",
                    "5": "That's a pentagon. HEXA means 6!",
                    "8": "That's an octagon. HEXA means 6!"
                }}
        }),
        "Place Value": () => {
            const tens = rand(2, 8), ones = rand(1, 9);
            const num = tens * 10 + ones;
            return {
                goalProblem: `In the number 58, what digit is in the tens place?`,
                teachingSteps: [
                    {
                        title: "What is place value?",
                        explanation: "<strong>Place value</strong> tells us what each digit in a number is worth. The same digit can mean different amounts depending on where it sits!",
                        visual: "The 5 in '50' is worth more than the 5 in '5'"
                    },
                    {
                        title: "Two-digit numbers have two places",
                        explanation: "In a 2-digit number, there are two positions: the <strong>tens place</strong> (left) and the <strong>ones place</strong> (right).",
                        visual: "[TENS] [ONES]"
                    },
                    {
                        title: "Let's look at 58",
                        explanation: "The number 58 has two digits. Let's figure out which digit is in which place.",
                        visual: "58 → [?] [?]"
                    },
                    {
                        title: "The LEFT digit is in the tens place",
                        explanation: "In 58, the digit <strong>5</strong> is on the left, so it's in the <strong>tens place</strong>. It's worth 5 × 10 = 50!",
                        visual: "58 → [5=tens] [8]"
                    },
                    {
                        title: "The RIGHT digit is in the ones place",
                        explanation: "The digit <strong>8</strong> is on the right, so it's in the <strong>ones place</strong>. It's worth just 8.",
                        visual: "58 = 50 + 8 = 5 tens + 8 ones"
                    }
                ],
                finalAnswer: "5",
                answerExplanation: "The digit in the tens place is 5. It's on the LEFT side. Remember: LEFT = tens, RIGHT = ones!",
                example: { problem: `In the number 58, what digit is in the tens place?`, steps: [
                    { text: "Write the number and label each place", math: "58 → [5][8]" },
                    { text: "Left digit = tens, Right digit = ones", math: "5 is in tens place, 8 is in ones place" },
                    { text: "The tens digit is...", math: "<strong>5</strong> (worth 50)" }
                ]},
                keyPoints: [
                    "In a 2-digit number: LEFT = tens, RIGHT = ones",
                    "The tens place is worth 10× more than the ones place",
                    "Example: 36 = 3 tens + 6 ones = 30 + 6"
                ],
                mistakes: [
                    { wrong: "Mixing up left and right", why: "Remember: Tens is on the LEFT (like how you read left-to-right, tens comes first)" },
                    { wrong: "Thinking 5 tens = 5", why: "5 tens = 5 × 10 = 50, not 5!" }
                ],
                guided: {
                    problem: `In the number ${num}, what digit is in the tens place?`,
                    steps: [
                        { label: "The number is", value: `${num}` },
                        { label: "Left digit is tens", value: `${tens} is on the left` },
                        { label: "Tens digit is", value: "?" }
                    ],
                    answer: String(tens),
                    answerLabel: "Tens digit:",
                    interactiveSteps: [
                        {
                            prompt: `In a 2-digit number like ${num}, which position is the TENS place - left or right?`,
                            hint: "We read left to right, and tens comes before ones...",
                            answer: "left",
                            acceptableAnswers: ["left", "the left", "on the left"],
                            formatHint: "left or right",
                            commonMistakes: {
                                "right": "The RIGHT digit is the ones place. TENS is on the LEFT!"
                            }
                        },
                        {
                            prompt: `Look at ${num}. What digit is on the LEFT side?`,
                            hint: `The number is ${num}. The left digit is...`,
                            answer: String(tens),
                            acceptableAnswers: [String(tens)],
                            formatHint: "Enter a digit (0-9)",
                            commonMistakes: {
                                [String(ones)]: `That's the ones digit (on the right). The LEFT digit is ${tens}`,
                                [String(num)]: `That's the whole number! We need just the LEFT digit: ${tens}`
                            }
                        },
                        {
                            prompt: `So the digit ${tens} is in the tens place. How much is ${tens} tens worth?`,
                            hint: `${tens} tens = ${tens} × 10 = ?`,
                            answer: String(tens * 10),
                            acceptableAnswers: [String(tens * 10)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(tens)]: `${tens} is the digit, but ${tens} TENS = ${tens} × 10 = ${tens * 10}`,
                                [String(tens + 10)]: `Don't add! Multiply: ${tens} × 10 = ${tens * 10}`
                            }
                        }
                    ]
                },
                practice: { problem: `What number has 7 tens and 2 ones?`, answer: "72", options: ["27", "72", "79", "702"],
                    mistakeAnalysis: {
                        "27": "You switched them! Tens come FIRST (on the left). 7 tens = 70, plus 2 ones = 72",
                        "79": "Close! 7 tens is correct, but we need 2 ones, not 9",
                        "702": "7 tens = 70, not 700. The answer is 72"
                    }}
            };
        },
        Patterns: () => {
            const start = rand(2, 5);
            const step = rand(2, 4);
            return {
                goalProblem: `What comes next? 2, 5, 8, 11, ?`,
                teachingSteps: [
                    {
                        title: "What is a pattern?",
                        explanation: "A <strong>pattern</strong> is a set of numbers that follow a rule. Once we find the rule, we can figure out what comes next!",
                        visual: "Pattern = numbers following a rule"
                    },
                    {
                        title: "Find the 'gap' between numbers",
                        explanation: "To find the rule, look at the <strong>difference</strong> between each pair of numbers. How much do we add to get from one number to the next?",
                        visual: "2 → ? → 5 → ? → 8 → ? → 11"
                    },
                    {
                        title: "Calculate each gap",
                        explanation: "Let's find the gap between each pair: 2 to 5 is +3, 5 to 8 is +3, 8 to 11 is +3. The gap is always the same!",
                        visual: "2 →(+3)→ 5 →(+3)→ 8 →(+3)→ 11"
                    },
                    {
                        title: "The rule is: Add 3 each time",
                        explanation: "Every time we move to the next number, we add 3. This is our rule! A pattern that adds the same number is called an 'arithmetic pattern'.",
                        visual: "Rule: +3"
                    },
                    {
                        title: "Apply the rule to find the answer",
                        explanation: "The last number is 11. Add 3 to get the next number: 11 + 3 = <strong>14</strong>",
                        visual: "11 →(+3)→ 14"
                    }
                ],
                finalAnswer: "14",
                answerExplanation: "The pattern adds 3 each time. Starting from 11, we add 3 to get 14!",
                example: { problem: `What comes next? 2, 5, 8, 11, ?`, steps: [
                    { text: "Find the difference between each pair", math: "2→5 is +3, 5→8 is +3, 8→11 is +3" },
                    { text: "The rule is: add 3 each time", math: "This pattern adds 3" },
                    { text: "Apply the rule to find the next number", math: "11 + 3 = <strong>14</strong>" }
                ]},
                keyPoints: [
                    "Look at the GAPS between numbers, not just the numbers",
                    "Check that your rule works for ALL the numbers in the pattern",
                    "Common patterns: +1, +2, +3, +5, +10, ×2"
                ],
                mistakes: [
                    { wrong: "Just guessing the next number", why: "Find the rule first! What's being added each time?" },
                    { wrong: "Finding a rule that only works for some numbers", why: "Your rule must work for EVERY step in the pattern." }
                ],
                guided: {
                    problem: `What comes next? ${start}, ${start+step}, ${start+2*step}, ${start+3*step}, ?`,
                    steps: [
                        { label: "Find the gap between numbers", value: `${start}→${start+step} is +${step}, ${start+step}→${start+2*step} is +${step}` },
                        { label: "The rule is", value: `Add ${step} each time` },
                        { label: "Next number", value: "?" }
                    ],
                    answer: String(start + 4*step),
                    answerLabel: "What comes next?",
                    interactiveSteps: [
                        {
                            prompt: `Look at ${start}, ${start+step}, ${start+2*step}... What's the difference between ${start} and ${start+step}?`,
                            hint: `${start+step} - ${start} = ?`,
                            answer: String(step),
                            acceptableAnswers: [String(step), `+${step}`],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(start)]: `That's the first number. The DIFFERENCE is ${start+step} - ${start} = ${step}`,
                                [String(start + step)]: `That's the second number. Subtract to find the gap: ${start+step} - ${start} = ${step}`
                            }
                        },
                        {
                            prompt: `The gap is ${step}. Check: is the gap the same between ${start+step} and ${start+2*step}?`,
                            hint: `${start+2*step} - ${start+step} = ?`,
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "yep", String(step), `+${step}`],
                            formatHint: "yes or no",
                            commonMistakes: {
                                "no": `Actually, ${start+2*step} - ${start+step} = ${step}, same as before! The rule is add ${step}.`
                            }
                        },
                        {
                            prompt: `The rule is: add ${step} each time. The last number is ${start+3*step}. What comes next?`,
                            hint: `${start+3*step} + ${step} = ?`,
                            answer: String(start + 4*step),
                            acceptableAnswers: [String(start + 4*step)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(start + 3*step)]: `That's the last number given. Add ${step} more: ${start+3*step} + ${step} = ${start+4*step}`,
                                [String(start + 3*step + 1)]: `You added 1 instead of ${step}. The rule is +${step}, so ${start+3*step} + ${step} = ${start+4*step}`,
                                [String(start + 5*step)]: `You added ${step} twice! Only add it once: ${start+3*step} + ${step} = ${start+4*step}`
                            }
                        }
                    ]
                },
                practice: { problem: `What comes next? 4, 8, 12, 16, ?`, answer: "20", options: ["17", "18", "20", "24"],
                    mistakeAnalysis: {
                        "17": "You added 1 instead of 4. The pattern is +4 each time: 16 + 4 = 20",
                        "18": "You added 2 instead of 4. Check the gaps: 4→8 is +4, 8→12 is +4",
                        "24": "You added 8 instead of 4. The gaps are +4, not +8."
                    }}
            };
        },
        "Skip Counting": () => ({
            goalProblem: `Count by 5s starting at 5. What comes after 20?`,
            teachingSteps: [
                {
                    title: "What is skip counting?",
                    explanation: "<strong>Skip counting</strong> means counting by a number other than 1. Instead of 1, 2, 3, 4... we skip some numbers!",
                    visual: "Regular: 1, 2, 3, 4, 5... | Skip by 2s: 2, 4, 6, 8, 10..."
                },
                {
                    title: "Why skip count?",
                    explanation: "Skip counting helps us count faster! It's also the foundation for <strong>multiplication</strong>. Counting by 5s is the same as the 5 times table!",
                    visual: "5, 10, 15, 20 = 5×1, 5×2, 5×3, 5×4"
                },
                {
                    title: "Let's count by 5s",
                    explanation: "When we count by 5s, we add 5 each time. Start at 5, then 10, then 15, then 20...",
                    visual: "5 →(+5)→ 10 →(+5)→ 15 →(+5)→ 20"
                },
                {
                    title: "What comes after 20?",
                    explanation: "We're at 20 and need to find the next number. Since we're counting by 5s, we add 5!",
                    visual: "20 + 5 = ?"
                },
                {
                    title: "The answer",
                    explanation: "20 + 5 = <strong>25</strong>. The next number when counting by 5s after 20 is 25!",
                    visual: "5, 10, 15, 20, <strong>25</strong>"
                }
            ],
            finalAnswer: "25",
            answerExplanation: "When counting by 5s, we add 5 each time. 20 + 5 = 25!",
            example: { problem: `Count by 5s starting at 5. What comes after 20?`, steps: [
                { text: "List what we know", math: "5, 10, 15, 20, ?" },
                { text: "Each number is 5 more than the last", math: "5+5=10, 10+5=15, 15+5=20, 20+5=?" },
                { text: "Add 5 to find the next number", math: "20 + 5 = <strong>25</strong>" }
            ]},
            keyPoints: [
                "Skip counting by 2s: all even numbers (ends in 0, 2, 4, 6, 8)",
                "Skip counting by 5s: ends in 0 or 5",
                "Skip counting by 10s: always ends in 0"
            ],
            mistakes: [
                { wrong: "Adding 1 instead of the skip number", why: "If counting by 5s, add 5 each time, not 1!" },
                { wrong: "Losing track of the skip amount", why: "Say it out loud: 'plus 5, plus 5, plus 5...'" }
            ],
            guided: {
                problem: `Count by 2s: 2, 4, 6, 8, ?`,
                steps: [
                    { label: "What are we counting by?", value: "2s (adding 2 each time)" },
                    { label: "The last number is", value: "8" },
                    { label: "Add 2 to get", value: "?" }
                ],
                answer: "10",
                answerLabel: "What comes next?",
                interactiveSteps: [
                    {
                        prompt: "We're 'skip counting by 2s'. What number do we add each time?",
                        hint: "Look at the sequence: 2, 4, 6, 8... What's the difference between each number?",
                        answer: "2",
                        acceptableAnswers: ["2", "two", "+2"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "1": "If we added 1 each time, we'd get 2, 3, 4, 5... But we're skipping to 2, 4, 6, 8 (adding 2)",
                            "4": "Check the gaps: 4-2=2, 6-4=2, 8-6=2. We add 2 each time!"
                        }
                    },
                    {
                        prompt: "The last number in our list is 8. What do we add to find the next number?",
                        hint: "We're counting by 2s, so we add...",
                        answer: "2",
                        acceptableAnswers: ["2", "two", "+2"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "8 is the last number. We need to ADD 2 to it!",
                            "1": "We're skip counting by 2, not by 1. Add 2!"
                        }
                    },
                    {
                        prompt: "8 + 2 = ? What's the next number in our sequence?",
                        hint: "Add 2 to 8...",
                        answer: "10",
                        acceptableAnswers: ["10", "ten"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "9": "You added 1 instead of 2. 8 + 2 = 10",
                            "82": "We ADD, not combine digits! 8 + 2 = 10",
                            "6": "You subtracted! We ADD 2: 8 + 2 = 10"
                        }
                    }
                ]
            },
            practice: { problem: `Count by 10s: 30, 40, 50, 60, ?`, answer: "70", options: ["61", "65", "70", "100"],
                mistakeAnalysis: {
                    "61": "You added 1 instead of 10. When counting by 10s, add 10: 60 + 10 = 70",
                    "65": "You added 5 instead of 10. This is counting by 10s, not 5s.",
                    "100": "That's too big of a jump. We're adding 10, not 40."
                }}
        }),
        "Number Lines": () => ({
            goalProblem: `Where is 7 on a number line from 0 to 10?`,
            teachingSteps: [
                {
                    title: "What is a number line?",
                    explanation: "A <strong>number line</strong> is like a ruler for numbers! Numbers are arranged in order from left to right, with smaller numbers on the left and bigger numbers on the right.",
                    visual: "0 ← smaller ... bigger → 10"
                },
                {
                    title: "The number line starts at 0",
                    explanation: "The number line usually starts at <strong>0</strong> on the left. Each mark shows the next number as we move right.",
                    visual: "0--1--2--3--4--5--6--7--8--9--10"
                },
                {
                    title: "Equal spacing is important",
                    explanation: "The marks on a number line are <strong>evenly spaced</strong>. The distance from 0 to 1 is the same as from 1 to 2, 2 to 3, and so on.",
                    visual: "|--|--|--|--| (all spaces equal)"
                },
                {
                    title: "Finding 7 on the number line",
                    explanation: "To find 7, start at 0 and count 7 marks to the right. Or count: 0, 1, 2, 3, 4, 5, 6, <strong>7</strong>!",
                    visual: "0--1--2--3--4--5--6--[7]--8--9--10"
                },
                {
                    title: "Notice: 7 is closer to 10 than to 0",
                    explanation: "Looking at our number line, 7 is past the middle (5). It's only 3 steps from 10, but 7 steps from 0. Number lines help us SEE these relationships!",
                    visual: "0←--7 steps--→[7]←--3 steps--→10"
                }
            ],
            finalAnswer: "7 is at the 7th mark from 0",
            answerExplanation: "Starting at 0, count 7 spaces to the right to find 7. It's between 6 and 8, closer to 10 than to 0.",
            example: { problem: `Where is 7 on a number line from 0 to 10?`, steps: [
                { text: "Start at 0 on the left", math: "0 is our starting point" },
                { text: "Count 7 marks to the right", math: "0, 1, 2, 3, 4, 5, 6, 7" },
                { text: "7 is between 6 and 8", math: "...5--6--<strong>[7]</strong>--8--9..." }
            ]},
            keyPoints: [
                "Number lines go from smaller (left) to bigger (right)",
                "Each mark is evenly spaced - same distance between all numbers",
                "Moving RIGHT means getting bigger, moving LEFT means getting smaller"
            ],
            mistakes: [
                { wrong: "Thinking bigger numbers are on the left", why: "Bigger numbers are always on the RIGHT side of a number line" },
                { wrong: "Uneven spacing between numbers", why: "All spaces must be equal! The jump from 3 to 4 equals the jump from 7 to 8" }
            ],
            guided: {
                problem: `Point to where 4 would be on a number line from 0 to 10`,
                steps: [
                    { label: "Start at 0", value: "The left end" },
                    { label: "Count 4 spaces right", value: "0, 1, 2, 3, 4" },
                    { label: "4 is between", value: "?" }
                ],
                answer: "3 and 5",
                answerLabel: "4 is between which numbers?",
                interactiveSteps: [
                    {
                        prompt: "On a number line, which end has the smaller numbers - left or right?",
                        hint: "Think about how we read: we start on the left and go right...",
                        answer: "left",
                        acceptableAnswers: ["left", "the left"],
                        formatHint: "left or right",
                        commonMistakes: {
                            "right": "Right side has BIGGER numbers. Smaller numbers are on the LEFT."
                        }
                    },
                    {
                        prompt: "To find 4, we start at 0 and move which direction?",
                        hint: "We need to get to a bigger number...",
                        answer: "right",
                        acceptableAnswers: ["right", "to the right"],
                        formatHint: "left or right",
                        commonMistakes: {
                            "left": "Left goes to smaller numbers. We need to go RIGHT to get to 4."
                        }
                    },
                    {
                        prompt: "What number comes right BEFORE 4 on the number line?",
                        hint: "Count: 1, 2, 3, ...",
                        answer: "3",
                        acceptableAnswers: ["3", "three"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "5": "5 comes AFTER 4. Before 4 is 3."
                        }
                    },
                    {
                        prompt: "What number comes right AFTER 4 on the number line?",
                        hint: "After 4 comes...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "3": "3 comes BEFORE 4. After 4 is 5."
                        }
                    }
                ]
            },
            practice: { problem: `On a number line, what number is exactly halfway between 0 and 10?`, answer: "5",
                options: ["4", "5", "6", "7"],
                mistakeAnalysis: {
                    "4": "4 is a bit less than halfway. The middle of 0 to 10 is 5.",
                    "6": "6 is past the middle. Exactly halfway is 5.",
                    "7": "7 is closer to 10 than to 0. Halfway between 0 and 10 is 5."
                }}
        }),
        "Even and Odd": () => ({
            goalProblem: `Is 7 even or odd?`,
            teachingSteps: [
                {
                    title: "What are even and odd numbers?",
                    explanation: "Every whole number is either <strong>EVEN</strong> or <strong>ODD</strong>. They take turns! Even numbers can be split into two equal groups; odd numbers cannot.",
                    visual: "1(odd), 2(even), 3(odd), 4(even), 5(odd)..."
                },
                {
                    title: "Even numbers: Can be split in half",
                    explanation: "<strong>Even numbers</strong> can be divided into 2 equal groups with nothing left over. Try splitting 6 cookies between 2 friends - each gets 3!",
                    visual: "6 = ●●● | ●●● (3 each, fair!)"
                },
                {
                    title: "Odd numbers: One left over",
                    explanation: "<strong>Odd numbers</strong> cannot be split equally in half. If you try to split 7 cookies between 2 friends, there's always 1 left over!",
                    visual: "7 = ●●● | ●●● + ● (one left!)"
                },
                {
                    title: "The easy trick: Look at the last digit!",
                    explanation: "For any number, just look at the <strong>last digit</strong>:<br>• Ends in 0, 2, 4, 6, 8 → <strong>EVEN</strong><br>• Ends in 1, 3, 5, 7, 9 → <strong>ODD</strong>",
                    visual: "Even: 0,2,4,6,8 | Odd: 1,3,5,7,9"
                },
                {
                    title: "Is 7 even or odd?",
                    explanation: "7 ends in 7, which is in our odd list (1,3,5,7,9). Also, we can't split 7 into 2 equal groups. So <strong>7 is ODD</strong>!",
                    visual: "7 → ends in 7 → ODD"
                }
            ],
            finalAnswer: "7 is odd",
            answerExplanation: "7 ends in 7, and 7 is in our odd digits list (1,3,5,7,9). Also, 7 ÷ 2 = 3 remainder 1 - can't split evenly!",
            example: { problem: `Is 7 even or odd?`, steps: [
                { text: "Look at the last digit", math: "7 → last digit is 7" },
                { text: "Is 7 in the even list (0,2,4,6,8) or odd list (1,3,5,7,9)?", math: "7 is in the ODD list" },
                { text: "Try splitting: can 7 be split into 2 equal groups?", math: "7 = 3 + 3 + 1 leftover → NO, can't split evenly" },
                { text: "The answer", math: "<strong>7 is ODD</strong>" }
            ]},
            keyPoints: [
                "Even numbers end in 0, 2, 4, 6, or 8",
                "Odd numbers end in 1, 3, 5, 7, or 9",
                "Even + Even = Even, Odd + Odd = Even, Even + Odd = Odd"
            ],
            mistakes: [
                { wrong: "Thinking 0 is odd", why: "0 is EVEN! You can split 0 things into 2 groups of 0." },
                { wrong: "Confusing 'ends in' with the whole number", why: "For 24: look at the 4, not the 2. 24 ends in 4, so it's EVEN." }
            ],
            guided: {
                problem: `Is 12 even or odd?`,
                steps: [
                    { label: "What is the last digit?", value: "2" },
                    { label: "Is 2 in the even or odd list?", value: "Even (0,2,4,6,8)" },
                    { label: "So 12 is", value: "?" }
                ],
                answer: "even",
                answerLabel: "12 is even or odd?",
                interactiveSteps: [
                    {
                        prompt: "To check if a number is even or odd, we look at what part of the number?",
                        hint: "We only need to check one digit...",
                        answer: "last digit",
                        acceptableAnswers: ["last digit", "the last digit", "ones place", "ones digit"],
                        formatHint: "e.g., last digit",
                        commonMistakes: {
                            "first digit": "No, we look at the LAST digit. For 12, look at the 2, not the 1."
                        }
                    },
                    {
                        prompt: "What is the last digit of 12?",
                        hint: "12 → what's the digit on the right?",
                        answer: "2",
                        acceptableAnswers: ["2", "two"],
                        formatHint: "Enter a digit (0-9)",
                        commonMistakes: {
                            "1": "That's the first digit. The LAST digit of 12 is 2."
                        }
                    },
                    {
                        prompt: "The even digits are 0, 2, 4, 6, 8. Is 2 in this list?",
                        hint: "Look for 2 in the list: 0, 2, 4, 6, 8",
                        answer: "yes",
                        acceptableAnswers: ["yes", "yeah", "yep"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "no": "Look again: 0, 2, 4, 6, 8. The number 2 IS in this list!"
                        }
                    },
                    {
                        prompt: "Since 12 ends in 2 (an even digit), 12 is _____.",
                        hint: "If the last digit is even, the whole number is...",
                        answer: "even",
                        acceptableAnswers: ["even"],
                        formatHint: "even or odd",
                        commonMistakes: {
                            "odd": "Numbers ending in 2 are EVEN. 12 is even."
                        }
                    }
                ]
            },
            practice: { problem: `Is 15 even or odd?`, answer: "odd",
                options: ["even", "odd"],
                mistakeAnalysis: {
                    "even": "15 ends in 5. The digit 5 is in the ODD list (1,3,5,7,9), so 15 is ODD."
                }}
        }),
        "Ordering Numbers": () => {
            const a = rand(3, 8), b = rand(10, 15), c = rand(16, 20);
            const nums = shuffle([a, b, c]);
            const sorted = [a, b, c];
            return {
                goalProblem: `Put these numbers in order from smallest to largest: 8, 3, 5`,
                teachingSteps: [
                    {
                        title: "What does 'ordering numbers' mean?",
                        explanation: "<strong>Ordering numbers</strong> means arranging them from smallest to largest (or largest to smallest). We use what we know about comparing numbers!",
                        visual: "3, 8, 5 → smallest to largest → 3, 5, 8"
                    },
                    {
                        title: "Think of a number line",
                        explanation: "On a number line, smaller numbers are on the LEFT and bigger numbers are on the RIGHT. We can use this to help us order numbers!",
                        visual: "0--1--2--[3]--4--[5]--6--7--[8]--9--10"
                    },
                    {
                        title: "Step 1: Find the SMALLEST number",
                        explanation: "Look at all your numbers: 8, 3, 5. Which comes first when counting?<br>3 comes before 5 and 8, so <strong>3 is smallest</strong>!",
                        visual: "8, 3, 5 → smallest is 3"
                    },
                    {
                        title: "Step 2: Find the next smallest",
                        explanation: "Now look at what's left: 8 and 5. Which is smaller?<br>5 comes before 8 when counting, so <strong>5 is next</strong>.",
                        visual: "Remaining: 8, 5 → 5 is smaller"
                    },
                    {
                        title: "Step 3: The rest goes at the end",
                        explanation: "8 is the only number left, so it must be the <strong>largest</strong>.<br>Our order: <strong>3, 5, 8</strong>",
                        visual: "Smallest → Largest: 3, 5, 8"
                    }
                ],
                finalAnswer: "3, 5, 8",
                answerExplanation: "We found the smallest (3), then the next smallest (5), then the largest (8). In order: 3 < 5 < 8",
                example: { problem: `Put in order from smallest to largest: 8, 3, 5`, steps: [
                    { text: "Find the smallest", math: "Compare 8, 3, 5 → 3 is smallest" },
                    { text: "Find the next smallest from what's left", math: "Compare 8, 5 → 5 is smaller" },
                    { text: "The last one is the largest", math: "8 is largest" },
                    { text: "Write in order", math: "<strong>3, 5, 8</strong>" }
                ]},
                keyPoints: [
                    "Think of the number line to help you compare",
                    "Find the smallest first, then work your way up",
                    "Check your answer: each number should be bigger than the one before it"
                ],
                mistakes: [
                    { wrong: "Putting numbers in the order they were given", why: "You need to REARRANGE them! Find smallest to largest (or largest to smallest)." },
                    { wrong: "Confusing smallest to largest with largest to smallest", why: "Read the question carefully! 'Smallest to largest' means smallest number first." }
                ],
                guided: {
                    problem: `Put in order from smallest to largest: ${nums.join(", ")}`,
                    steps: [
                        { label: "Find the smallest", value: String(a) },
                        { label: "Find the next smallest", value: String(b) },
                        { label: "The largest", value: "?" }
                    ],
                    answer: String(c),
                    answerLabel: "What is the largest number?",
                    interactiveSteps: [
                        {
                            prompt: `Look at these numbers: ${nums.join(", ")}. Which one is the SMALLEST?`,
                            hint: "Which number would come first if you were counting?",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `Compare to the other numbers. ${a} is smaller than ${b}.`,
                                [String(c)]: `${c} is actually the LARGEST. The smallest is ${a}.`
                            }
                        },
                        {
                            prompt: `Good! ${a} is smallest. Now look at the remaining numbers: ${b} and ${c}. Which is smaller?`,
                            hint: "Which comes first when counting?",
                            answer: String(b),
                            acceptableAnswers: [String(b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(c)]: `${c} > ${b}, so ${b} is smaller.`
                            }
                        },
                        {
                            prompt: `So the order from smallest to largest is: ${a}, ${b}, ___`,
                            hint: "What's the only number left?",
                            answer: String(c),
                            acceptableAnswers: [String(c)],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Check: Is ${a} < ${b} < ${c}? Does each number get bigger?`,
                            hint: "Verify the order is correct...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "correct", "true"],
                            formatHint: "yes or no",
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Put in order from smallest to largest: 9, 2, 6`, answer: "2, 6, 9",
                    options: ["2, 6, 9", "9, 6, 2", "6, 2, 9", "2, 9, 6"],
                    mistakeAnalysis: {
                        "9, 6, 2": "That's largest to smallest! We want smallest to largest: 2, 6, 9",
                        "6, 2, 9": "Start with the smallest. 2 is smaller than 6, so 2 comes first: 2, 6, 9",
                        "2, 9, 6": "Close! But 6 < 9, so 6 should come before 9: 2, 6, 9"
                    }}
            };
        },
        Comparison: () => ({
            goalProblem: `Which is greater: 7 or 4?`,
            teachingSteps: [
                {
                    title: "What does 'comparing' mean?",
                    explanation: "<strong>Comparing numbers</strong> means deciding which number is bigger (greater) or smaller (less than). We use special symbols to show this!",
                    visual: "Bigger? Smaller? Or Equal?"
                },
                {
                    title: "The comparison symbols",
                    explanation: "We use three symbols: <strong>></strong> (greater than), <strong><</strong> (less than), and <strong>=</strong> (equals). The open side always faces the BIGGER number!",
                    visual: "> means greater than | < means less than | = means equal"
                },
                {
                    title: "The 'hungry alligator' trick",
                    explanation: "Think of > and < as an alligator's mouth. The alligator is hungry and always wants to eat the BIGGER number! The open mouth faces the bigger one.",
                    visual: "7 > 4 (alligator wants the 7!)"
                },
                {
                    title: "Let's compare 7 and 4",
                    explanation: "Think about counting: 1, 2, 3, 4, 5, 6, 7... Numbers that come later when counting are bigger. 7 comes after 4!",
                    visual: "1, 2, 3, <u>4</u>, 5, 6, <u>7</u> ← 7 is farther along"
                },
                {
                    title: "7 is greater than 4",
                    explanation: "Since 7 is bigger, the open mouth (the 'greater than' symbol) faces 7. We write: <strong>7 > 4</strong>",
                    visual: "7 > 4"
                }
            ],
            finalAnswer: "7 > 4",
            answerExplanation: "7 is greater than 4 because 7 comes after 4 when counting. The > symbol opens toward the bigger number (7).",
            example: { problem: `Which is greater: 7 or 4?`, steps: [
                { text: "Think about counting", math: "When we count, we say: 1, 2, 3, 4, 5, 6, 7..." },
                { text: "Numbers that come later are bigger", math: "7 comes after 4, so 7 is greater" },
                { text: "The answer", math: "<strong>7 > 4</strong> (7 is greater than 4)" }
            ]},
            keyPoints: [
                "Think of a number line: numbers on the RIGHT are bigger",
                "The 'hungry alligator' eats the bigger number: 7 > 4",
                "For 2-digit numbers: compare tens first, then ones"
            ],
            mistakes: [
                { wrong: "Confusing > and <", why: "The symbol points TO the smaller number. The open mouth faces the bigger number." },
                { wrong: "Only looking at one digit in 2-digit numbers", why: "32 > 29 even though 9 > 2, because 3 tens > 2 tens" }
            ],
            guided: {
                problem: `Which is greater: 12 or 8?`,
                steps: [
                    { label: "Count up to find which is bigger", value: "...6, 7, 8, 9, 10, 11, 12" },
                    { label: "12 comes after 8, so", value: "12 is greater" },
                    { label: "Answer", value: "?" }
                ],
                answer: "12",
                answerLabel: "Which is greater?",
                interactiveSteps: [
                    {
                        prompt: "When we count up (1, 2, 3, 4...), which number comes LATER: 12 or 8?",
                        hint: "Numbers that come later when counting are bigger...",
                        answer: "12",
                        acceptableAnswers: ["12", "twelve"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "When counting: ...7, 8, 9, 10, 11, 12. 12 comes LATER, so 12 is greater!"
                        }
                    },
                    {
                        prompt: "If 12 comes after 8, that means 12 is ______ than 8.",
                        hint: "Bigger numbers come later when counting...",
                        answer: "greater",
                        acceptableAnswers: ["greater", "bigger", "larger", "more"],
                        formatHint: "greater or less",
                        commonMistakes: {
                            "less": "Numbers that come LATER are GREATER. 12 comes after 8, so 12 is GREATER.",
                            "smaller": "12 is bigger! Later in counting = greater."
                        }
                    },
                    {
                        prompt: "What symbol shows '12 is greater than 8'? Is it 12 > 8 or 12 < 8?",
                        hint: "The open side of the symbol points to the bigger number...",
                        answer: "12 > 8",
                        acceptableAnswers: ["12 > 8", ">", "12>8"],
                        formatHint: "e.g., 12 > 8",
                        commonMistakes: {
                            "12 < 8": "< means 'less than'. Since 12 is GREATER, we use >: 12 > 8",
                            "<": "< means less than. We want GREATER than, which is >"
                        }
                    }
                ]
            },
            practice: { problem: `Compare: 15 ? 9 (use >, <, or =)`, answer: ">", options: ["<", ">", "="],
                mistakeAnalysis: {
                    "<": "15 is BIGGER than 9, so we need the 'greater than' symbol: 15 > 9",
                    "=": "15 and 9 are not equal. 15 is bigger, so 15 > 9"
                }}
        }),
        "Teen Numbers": () => ({
            goalProblem: `The number 14 has 1 ten and how many ones?`,
            teachingSteps: [
                {
                    title: "What are teen numbers?",
                    explanation: "<strong>Teen numbers</strong> are the numbers from 11 to 19. They all have something special: they're made of 1 ten plus some extra ones!",
                    visual: "11, 12, 13, 14, 15, 16, 17, 18, 19"
                },
                {
                    title: "Every teen number has ONE ten",
                    explanation: "All teen numbers are bigger than 10 but smaller than 20. That means they all have exactly <strong>1 ten</strong> (which equals 10).",
                    visual: "Teen = 10 + some ones"
                },
                {
                    title: "The 'ones' tell us how many extra",
                    explanation: "After the 1 ten, we count the extra ones. For 14: the '4' tells us there are 4 ones. So 14 = 10 + 4.",
                    visual: "14 = 1 ten + 4 ones = 10 + 4"
                },
                {
                    title: "Let's see 14 with dots",
                    explanation: "Watch: 10 dots in a row (that's our 1 ten), plus 4 extra dots (our ones). Count them all: 14!",
                    visual: "●●●●●●●●●● + ●●●● = 14"
                },
                {
                    title: "The answer: 14 has 4 ones",
                    explanation: "14 = 1 ten + <strong>4 ones</strong>. The digit 4 in 14 tells us how many ones after the ten.",
                    visual: "1 4 → 1 ten, 4 ones"
                }
            ],
            finalAnswer: "4 ones",
            answerExplanation: "14 = 1 ten + 4 ones. Every teen number has 1 ten, and the second digit tells us the ones.",
            example: { problem: `The number 14 has 1 ten and how many ones?`, steps: [
                { text: "Teen numbers are 10 plus some ones", math: "14 = 10 + ?" },
                { text: "Count what's left after 10", math: "14 - 10 = 4" },
                { text: "So 14 has 4 ones", math: "14 = 1 ten + <strong>4 ones</strong>" }
            ]},
            keyPoints: [
                "ALL teen numbers (11-19) have exactly 1 ten",
                "The second digit tells you how many ones",
                "Teen numbers = 10 + the ones digit"
            ],
            mistakes: [
                { wrong: "Saying 14 has 14 ones", why: "14 ones would be written as '14' with no tens. 14 has 1 TEN and 4 ones." },
                { wrong: "Confusing tens and ones", why: "The left digit is tens, the right digit is ones. In 14: 1 ten, 4 ones." }
            ],
            guided: {
                problem: `The number 16 has 1 ten and how many ones?`,
                steps: [
                    { label: "16 is a teen number, so it has", value: "1 ten" },
                    { label: "The ones digit is", value: "6" },
                    { label: "So 16 = 10 + ", value: "?" }
                ],
                answer: "6",
                answerLabel: "How many ones?",
                interactiveSteps: [
                    {
                        prompt: "Is 16 a teen number? (Teen numbers are 11-19)",
                        hint: "Is 16 between 11 and 19?",
                        answer: "yes",
                        acceptableAnswers: ["yes", "yeah", "yep", "y"],
                        formatHint: "yes or no",
                        commonMistakes: {
                            "no": "16 IS a teen number! It's between 11 and 19."
                        }
                    },
                    {
                        prompt: "How many tens does 16 have?",
                        hint: "All teen numbers have this many tens...",
                        answer: "1",
                        acceptableAnswers: ["1", "one"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "6": "That's the ones digit. Teen numbers all have 1 ten.",
                            "16": "16 is the whole number. It has 1 TEN and some ones."
                        }
                    },
                    {
                        prompt: "16 = 10 + ?. How many ones does 16 have?",
                        hint: "What number plus 10 equals 16?",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "1": "1 is the tens digit. The ONES digit is 6.",
                            "16": "16 is the whole number. The ones part is just 6."
                        }
                    }
                ]
            },
            practice: { problem: `The number 18 has 1 ten and how many ones?`, answer: "8", options: ["1", "8", "10", "18"],
                mistakeAnalysis: {
                    "1": "1 is the tens digit (1 ten = 10). The ONES digit is 8.",
                    "10": "10 is how much 1 ten is worth. The ones digit is 8.",
                    "18": "18 is the whole number. It has 1 ten and 8 ones."
                }}
        }),
        "Number Bonds": () => {
            const total = pick([5, 10]);
            const part1 = rand(1, total - 1);
            const part2 = total - part1;
            return {
                goalProblem: `6 + ? = 10`,
                teachingSteps: [
                    {
                        title: "What are number bonds?",
                        explanation: "<strong>Number bonds</strong> show how numbers can be broken apart or put together. They're pairs of numbers that make a total!",
                        visual: "Number Bond: 10 = 6 + 4"
                    },
                    {
                        title: "Why are bonds to 10 special?",
                        explanation: "Knowing all the ways to make 10 is <strong>super important</strong> for mental math! It helps with adding bigger numbers quickly.",
                        visual: "10 = 1+9 = 2+8 = 3+7 = 4+6 = 5+5"
                    },
                    {
                        title: "Think: What plus 6 makes 10?",
                        explanation: "We need to find the <strong>missing part</strong>. Start with 10 (the whole) and take away 6 (the part we know). What's left?",
                        visual: "10 - 6 = ?"
                    },
                    {
                        title: "Count up from 6 to 10",
                        explanation: "Another way: start at 6 and count up to 10. How many did you count? 7, 8, 9, 10 - that's <strong>4 more</strong>!",
                        visual: "6 → 7 → 8 → 9 → 10 (4 jumps)"
                    },
                    {
                        title: "The missing part is 4!",
                        explanation: "6 + <strong>4</strong> = 10. We can check: 6, 7, 8, 9, 10 ✓ or 10 - 6 = 4 ✓",
                        visual: "6 + 4 = 10 ✓"
                    }
                ],
                finalAnswer: "4",
                answerExplanation: "6 + 4 = 10. These are number bonds to 10! Memorizing all bonds to 10 makes math easier.",
                example: { problem: `6 + ? = 10`, steps: [
                    { text: "We need the part that goes with 6 to make 10", math: "6 + ? = 10" },
                    { text: "Subtract to find the missing part", math: "10 - 6 = 4" },
                    { text: "Check your answer", math: "6 + 4 = 10 ✓" }
                ]},
                keyPoints: [
                    "Number bonds to 10: 1+9, 2+8, 3+7, 4+6, 5+5",
                    "To find a missing part: subtract from the total",
                    "You can also count up from the known part to the total"
                ],
                mistakes: [
                    { wrong: "Adding instead of finding the missing part", why: "We want what ADDS TO 6 to make 10, not 6+10." },
                    { wrong: "Not knowing bonds to 10", why: "Practice! 1+9, 2+8, 3+7, 4+6, 5+5 all make 10." }
                ],
                guided: {
                    problem: `${part1} + ? = ${total}`,
                    steps: [
                        { label: "The total is", value: String(total) },
                        { label: "One part is", value: String(part1) },
                        { label: "The missing part is", value: "?" }
                    ],
                    answer: String(part2),
                    answerLabel: "What's the missing number?",
                    interactiveSteps: [
                        {
                            prompt: `What is the total we're trying to make?`,
                            hint: "Look at the right side of the equation",
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(part1)]: `${part1} is one part. The TOTAL is ${total}.`
                            }
                        },
                        {
                            prompt: `To find the missing part, we can subtract: ${total} - ${part1} = ?`,
                            hint: `What is ${total} minus ${part1}?`,
                            answer: String(part2),
                            acceptableAnswers: [String(part2)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(total)]: `That's the total. Subtract: ${total} - ${part1} = ${part2}`,
                                [String(part1)]: `That's the known part. We need ${total} - ${part1} = ${part2}`
                            }
                        },
                        {
                            prompt: `Let's check: ${part1} + ${part2} = ?`,
                            hint: "Add the two parts together",
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `7 + ? = 10`, answer: "3", options: ["2", "3", "7", "17"],
                    mistakeAnalysis: {
                        "2": "7 + 2 = 9, not 10. Try 7 + 3 = 10.",
                        "7": "7 + 7 = 14, not 10. We need the number that makes 10.",
                        "17": "You added 7 + 10 = 17. We want what ADDS TO 7 to make 10."
                    }}
            };
        },
        "Comparing Lengths": () => ({
            goalProblem: `Which is longer: a pencil or an eraser?`,
            teachingSteps: [
                {
                    title: "What does 'length' mean?",
                    explanation: "<strong>Length</strong> is how long something is from one end to the other. We can compare lengths to see which is longer or shorter.",
                    visual: "Length = end ←→ end"
                },
                {
                    title: "How to compare lengths",
                    explanation: "To compare, line up objects at one end. The object that sticks out farther on the other end is <strong>longer</strong>!",
                    visual: "|====pencil=====|\n|==eraser==|"
                },
                {
                    title: "Think about real objects",
                    explanation: "Picture a pencil and an eraser. A pencil is usually about 7 inches long. An eraser is usually about 2 inches. Which sticks out more?",
                    visual: "Pencil: ▭▭▭▭▭▭▭\nEraser: ▭▭"
                },
                {
                    title: "The pencil is longer!",
                    explanation: "A pencil is <strong>longer</strong> than an eraser. The eraser is <strong>shorter</strong> than the pencil.",
                    visual: "pencil > eraser (in length)"
                },
                {
                    title: "Words for comparing length",
                    explanation: "Longer/shorter, taller/shorter, bigger/smaller all describe length comparisons. 'Longer' means more length, 'shorter' means less length.",
                    visual: "longer ↔ shorter"
                }
            ],
            finalAnswer: "pencil",
            answerExplanation: "A pencil is longer than an eraser. Pencils are typically 6-7 inches, while erasers are about 2 inches.",
            example: { problem: `Which is longer: a pencil or an eraser?`, steps: [
                { text: "Think about the size of each object", math: "Pencil ≈ 7 inches, Eraser ≈ 2 inches" },
                { text: "Compare: which has more length?", math: "7 inches > 2 inches" },
                { text: "The pencil is longer", math: "Answer: <strong>pencil</strong>" }
            ]},
            keyPoints: [
                "Line up objects at one end to compare fairly",
                "The object that extends further is LONGER",
                "Use words like longer/shorter, taller/shorter to describe"
            ],
            mistakes: [
                { wrong: "Comparing without lining up ends", why: "Always start objects at the same point to compare fairly!" },
                { wrong: "Confusing width with length", why: "Length is how LONG something is (end to end), not how wide." }
            ],
            guided: {
                problem: `Which is longer: a book or a paperclip?`,
                steps: [
                    { label: "Think about a book", value: "About 10 inches long" },
                    { label: "Think about a paperclip", value: "About 1 inch long" },
                    { label: "Which is longer?", value: "?" }
                ],
                answer: "book",
                answerLabel: "Which is longer?",
                interactiveSteps: [
                    {
                        prompt: "Picture a book. Is it about the size of your hand or much bigger?",
                        hint: "Think about a book you've read...",
                        answer: "bigger",
                        acceptableAnswers: ["bigger", "big", "much bigger", "large", "larger"],
                        formatHint: "bigger or smaller",
                        commonMistakes: {
                            "smaller": "Most books are bigger than your hand - about 8-10 inches long!"
                        }
                    },
                    {
                        prompt: "A paperclip is very small - about how long is it?",
                        hint: "Paperclips are tiny...",
                        answer: "1 inch",
                        acceptableAnswers: ["1 inch", "1", "one inch", "small", "very small", "tiny"],
                        formatHint: "Describe the size",
                        commonMistakes: {
                            "10 inches": "That's way too big! Paperclips are tiny - about 1 inch."
                        }
                    },
                    {
                        prompt: "A book is about 10 inches and a paperclip is about 1 inch. Which is longer?",
                        hint: "10 inches vs 1 inch...",
                        answer: "book",
                        acceptableAnswers: ["book", "the book", "a book"],
                        formatHint: "book or paperclip",
                        commonMistakes: {
                            "paperclip": "A paperclip is only 1 inch! A book at 10 inches is much LONGER."
                        }
                    }
                ]
            },
            practice: { problem: `Which is longer: a car or a bicycle?`, answer: "car", options: ["car", "bicycle", "same length"],
                mistakeAnalysis: {
                    "bicycle": "A bicycle is about 6 feet long. A car is about 15 feet! The car is longer.",
                    "same length": "They're very different sizes. A car is about 15 feet, a bicycle about 6 feet."
                }}
        })
    },
    2: {
        Multiplication: () => {
            const a = rand(3, 5), b = rand(2, 4);
            return {
                goalProblem: `What is 4 × 3?`,
                teachingSteps: [
                    {
                        title: "What is multiplication?",
                        explanation: "<strong>Multiplication</strong> is a faster way to add the same number many times. Instead of writing 3+3+3+3, we can write 4×3!",
                        visual: "3 + 3 + 3 + 3 = 4 × 3"
                    },
                    {
                        title: "What does 4 × 3 mean?",
                        explanation: "4 × 3 means '<strong>4 groups of 3</strong>' or '3 added 4 times'. The × symbol means 'groups of'.",
                        visual: "4 × 3 = '4 groups of 3'"
                    },
                    {
                        title: "Let's picture it",
                        explanation: "Imagine 4 groups with 3 dots in each group. We need to count all the dots!",
                        visual: "●●●  ●●●  ●●●  ●●●"
                    },
                    {
                        title: "Add the groups together",
                        explanation: "We have 4 groups of 3. Let's add: 3 + 3 = 6, then 6 + 3 = 9, then 9 + 3 = 12.",
                        visual: "3 + 3 + 3 + 3 = 12"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>4 × 3 = 12</strong>. You can also skip count by 3s four times: 3, 6, 9, 12!",
                        visual: "4 × 3 = 12"
                    }
                ],
                finalAnswer: "4 × 3 = 12",
                answerExplanation: "4 groups of 3 equals 12. We added 3 four times: 3 + 3 + 3 + 3 = 12!",
                example: { problem: `What is 4 × 3?`, steps: [
                    { text: "Read it as: 4 groups of 3", math: "4 × 3 = 3 + 3 + 3 + 3" },
                    { text: "Add step by step", math: "3 + 3 = 6, then 6 + 3 = 9, then 9 + 3 = 12" },
                    { text: "Or visualize 4 groups", math: "●●● ●●● ●●● ●●● = <strong>12</strong>" }
                ]},
                keyPoints: [
                    "× means 'groups of': 5 × 2 = 5 groups of 2",
                    "You can flip them: 4 × 3 = 3 × 4 = 12",
                    "Skip counting helps: 3, 6, 9, 12 (that's counting by 3s, four times)"
                ],
                mistakes: [
                    { wrong: "4 × 3 = 7 (adding instead)", why: "× means multiply, not add. 4 + 3 = 7, but 4 × 3 = 12" },
                    { wrong: "4 × 3 = 43 (putting digits together)", why: "We're making groups, not combining digits!" }
                ],
                guided: {
                    problem: `What is ${a} × ${b}?`,
                    steps: [
                        { label: `Read as "${a} groups of ${b}"`, value: `${Array(a).fill(b).join(' + ')}` },
                        { label: "Add them up", value: `${Array(a).fill(b).reduce((sum, n, i) => i === 0 ? String(n) : sum + ' + ' + n + ' = ' + (parseInt(sum.split(' = ').pop() || sum) + n), '0').split(' = ').pop()}... wait, let's count!` },
                        { label: "Total", value: "?" }
                    ],
                    answer: String(a * b),
                    answerLabel: `${a} × ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `What does ${a} × ${b} mean in words?`,
                            hint: `It means ${a} groups of...`,
                            answer: `${a} groups of ${b}`,
                            acceptableAnswers: [`${a} groups of ${b}`, `${b} added ${a} times`, `${b}+${b}` + (a > 2 ? `+${b}` : '') + (a > 3 ? `+${b}` : '') + (a > 4 ? `+${b}` : '')],
                            formatHint: "e.g., 4 groups of 3",
                            commonMistakes: {
                                [`${a} + ${b}`]: `That's addition! ${a} × ${b} means ${a} GROUPS of ${b}.`,
                                [`${b} groups of ${a}`]: `Close! ${a} × ${b} means ${a} groups of ${b} (first number = how many groups).`
                            }
                        },
                        {
                            prompt: `Let's skip count by ${b}s, ${a} times. Start: ${b}... What comes next?`,
                            hint: `${b} + ${b} = ?`,
                            answer: String(b * 2),
                            acceptableAnswers: [String(b * 2)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b + 1)]: `You added 1. Skip count by ${b}s: ${b}, ${b*2}, ${b*3}...`,
                                [String(b)]: `That's the first number. Next is ${b} + ${b} = ${b * 2}`
                            }
                        },
                        {
                            prompt: `Keep counting by ${b}s: ${Array.from({length: a-1}, (_, i) => b * (i + 1)).join(', ')}... What's the ${a}th number?`,
                            hint: `Count ${a} jumps of ${b}`,
                            answer: String(a * b),
                            acceptableAnswers: [String(a * b)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String((a - 1) * b)]: `That's only ${a - 1} groups. Count one more: ${(a-1)*b} + ${b} = ${a * b}`,
                                [String((a + 1) * b)]: `That's ${a + 1} groups - one too many! We need exactly ${a} groups.`,
                                [String(a + b)]: `You added instead of multiplied! ${a} × ${b} = ${a * b}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 1; return { problem: `What is ${pa} × ${b}?`, answer: String(pa * b),
                    options: shuffle([String(pa * b), String(a * b), String(pa + b), String((pa + 1) * b)]),
                    mistakeAnalysis: {
                        [String(a * b)]: `That's ${a} × ${b}. We need ${pa} groups of ${b}.`,
                        [String(pa + b)]: `You added instead of multiplied. ${pa} × ${b} means ${pa} groups of ${b}.`,
                        [String((pa + 1) * b)]: `That's one group too many. We need exactly ${pa} groups of ${b}.`
                    }}; })()
            };
        },
        Division: () => {
            const ans = rand(3, 6), b = rand(2, 4);
            const a = ans * b;
            return {
                goalProblem: `What is 12 ÷ 4?`,
                teachingSteps: [
                    {
                        title: "What is division?",
                        explanation: "<strong>Division</strong> means splitting things into <strong>equal groups</strong>. The ÷ symbol means 'divided by' or 'split into'.",
                        visual: "12 things ÷ 4 groups = ? in each"
                    },
                    {
                        title: "What does 12 ÷ 4 mean?",
                        explanation: "12 ÷ 4 asks: 'If we split 12 things into 4 equal groups, how many are in each group?'",
                        visual: "12 items → split into 4 groups → how many each?"
                    },
                    {
                        title: "Let's picture it",
                        explanation: "Imagine 12 dots. We want to put them into 4 equal groups. Let's deal them out one at a time to each group.",
                        visual: "●●●●●●●●●●●● → 4 groups"
                    },
                    {
                        title: "Deal them into 4 groups",
                        explanation: "Put one dot in each group, then repeat until all dots are used. Each group ends up with 3 dots!",
                        visual: "●●● | ●●● | ●●● | ●●●"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>12 ÷ 4 = 3</strong>. Each group has 3! You can check: 4 groups × 3 in each = 12 total.",
                        visual: "12 ÷ 4 = 3"
                    }
                ],
                finalAnswer: "12 ÷ 4 = 3",
                answerExplanation: "When we split 12 into 4 equal groups, each group has 3. Division is the opposite of multiplication!",
                example: { problem: `What is 12 ÷ 4?`, steps: [
                    { text: "Read it as: Split 12 into 4 equal groups", math: "12 items → 4 groups → how many each?" },
                    { text: "Draw it out", math: "●●● | ●●● | ●●● | ●●●" },
                    { text: "Count how many in each group", math: "Each group has <strong>3</strong>, so 12 ÷ 4 = <strong>3</strong>" }
                ]},
                keyPoints: [
                    "Division is splitting into EQUAL groups",
                    "Think multiplication backwards: ___ × 4 = 12? Answer: 3",
                    "The first number (12) gets split BY the second number (4)"
                ],
                mistakes: [
                    { wrong: "Dividing in the wrong order (4 ÷ 12)", why: "The big number gets divided BY the small number. 12 ÷ 4 ≠ 4 ÷ 12" },
                    { wrong: "Subtracting instead of dividing", why: "12 - 4 = 8, but 12 ÷ 4 = 3. Division is about equal groups." }
                ],
                guided: {
                    problem: `What is ${a} ÷ ${b}?`,
                    steps: [
                        { label: `Split ${a} into ${b} equal groups`, value: `●●● `.repeat(b).trim() + ` (${ans} in each)` },
                        { label: `Think: ${b} × ___ = ${a}`, value: `${b} × ${ans} = ${a}` },
                        { label: "How many in each group?", value: "?" }
                    ],
                    answer: String(ans),
                    answerLabel: `${a} ÷ ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `${a} ÷ ${b} means: "Split ${a} into ${b} equal groups." What are we trying to find?`,
                            hint: "We want to know how many are in EACH group...",
                            answer: "how many in each group",
                            acceptableAnswers: ["how many in each group", "items per group", "number in each group", "each group", String(ans)],
                            formatHint: "Enter a number or phrase",
                            commonMistakes: {
                                [String(a)]: `${a} is the total we're splitting up. We want to find how many in EACH group.`,
                                [String(b)]: `${b} is the number of groups. We want how many are IN each group.`
                            }
                        },
                        {
                            prompt: `Division is the opposite of multiplication. Think: ${b} × ___ = ${a}. What number times ${b} equals ${a}?`,
                            hint: `Try counting by ${b}s until you reach ${a}...`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `${b} × ${b} = ${b * b}. We need ${b} × ? = ${a}. The answer is ${ans}.`,
                                [String(a)]: `${b} × ${a} = ${b * a}, which is too big! We need ${b} × ${ans} = ${a}.`
                            }
                        },
                        {
                            prompt: `So if ${b} × ${ans} = ${a}, then ${a} ÷ ${b} = ?`,
                            hint: "Division and multiplication are opposites!",
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(b)]: `${b} is the divisor (what we divide BY). The answer is ${ans}.`,
                                [String(a - b)]: `You subtracted! ${a} ÷ ${b} = ${ans}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = (ans + 1) * b; return { problem: `What is ${pa} ÷ ${b}?`, answer: String(ans + 1),
                    options: shuffle([String(ans + 1), String(ans), String(ans + 2), String(b)]),
                    mistakeAnalysis: {
                        [String(ans)]: `That's ${a} ÷ ${b}. With ${pa} total, each group gets more.`,
                        [String(b)]: "You flipped the answer. Think: how many in EACH group?",
                        [String(ans + 2)]: `Too many per group. Check: ${b} × ${ans + 2} = ${b * (ans + 2)}, not ${pa}.`
                    }}; })()
            };
        },
        Time: () => ({
            goalProblem: `What time does the clock show when the short hand is on 3 and long hand is on 6?`,
            teachingSteps: [
                {
                    title: "A clock has two hands",
                    explanation: "Every clock has two hands: a <strong>short hand</strong> and a <strong>long hand</strong>. Each tells us something different!",
                    visual: "Short hand (small) + Long hand (big)"
                },
                {
                    title: "Short hand = HOURS",
                    explanation: "The <strong>short hand</strong> tells us the <strong>hour</strong>. It moves slowly - it only goes around twice a day!",
                    visual: "Short hand → HOUR"
                },
                {
                    title: "Long hand = MINUTES",
                    explanation: "The <strong>long hand</strong> tells us the <strong>minutes</strong>. Each number on the clock = 5 minutes (1=5, 2=10, 3=15...).",
                    visual: "Long hand → MINUTES (each number × 5)"
                },
                {
                    title: "Let's read our clock",
                    explanation: "Short hand is on <strong>3</strong> → Hour is 3. Long hand is on <strong>6</strong> → Minutes = 6 × 5 = 30.",
                    visual: "Hour: 3 | Minutes: 6 × 5 = 30"
                },
                {
                    title: "Put it together",
                    explanation: "Hour is 3, minutes is 30. We write this as <strong>3:30</strong> (said 'three thirty').",
                    visual: "3:30"
                }
            ],
            finalAnswer: "3:30",
            answerExplanation: "Short hand on 3 = hour is 3. Long hand on 6 = 30 minutes (6 × 5). The time is 3:30!",
            example: { problem: `What time does the clock show when the short hand is on 3 and long hand is on 6?`, steps: [
                { text: "Find the hour (short hand)", math: "Short hand points to 3 → Hour is 3" },
                { text: "Find the minutes (long hand)", math: "Long hand points to 6 → 6 × 5 = 30 minutes" },
                { text: "Put them together", math: "Time is <strong>3:30</strong> (three-thirty)" }
            ]},
            keyPoints: [
                "Short hand = hour, Long hand = minutes",
                "Multiply the minute hand's number by 5",
                "1 hour = 60 minutes, Half hour = 30 minutes"
            ],
            mistakes: [
                { wrong: "Mixing up the hands", why: "SHORT = hours (like 'short' word). LONG = minutes (longer word)." },
                { wrong: "Reading 6 as 6 minutes", why: "Multiply by 5! The 6 means 6 × 5 = 30 minutes." }
            ],
            guided: {
                problem: `It's 4:00 now. What time will it be in 2 hours?`,
                steps: [
                    { label: "Start time", value: "4:00" },
                    { label: "Add 2 hours to the hour", value: "4 + 2 = 6" },
                    { label: "New time", value: "?" }
                ],
                answer: "6:00",
                answerLabel: "What time?",
                interactiveSteps: [
                    {
                        prompt: "We start at 4:00. When we add hours, which number changes - the hour or the minutes?",
                        hint: "Hours are before the colon, minutes are after...",
                        answer: "hour",
                        acceptableAnswers: ["hour", "the hour", "hours"],
                        formatHint: "hour or minutes",
                        commonMistakes: {
                            "minutes": "When adding HOURS, the hour changes. The minutes (00) stay the same.",
                            "both": "Only the hour changes when we add hours. 4:00 + 2 hours keeps the :00"
                        }
                    },
                    {
                        prompt: "What is 4 + 2?",
                        hint: "Add 2 to the starting hour...",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "2": "4 + 2 = 6, not 2. Add the hours together!",
                            "42": "We ADD the hours, not combine digits. 4 + 2 = 6"
                        }
                    },
                    {
                        prompt: "The hour is now 6. The minutes stay at 00. What is the full time?",
                        hint: "Write it as hour:minutes",
                        answer: "6:00",
                        acceptableAnswers: ["6:00", "6 o'clock", "6 oclock"],
                        formatHint: "e.g., 6:00",
                        commonMistakes: {
                            "6": "Include the minutes! It's 6:00 (six o'clock)",
                            "600": "Use a colon: 6:00, not 600"
                        }
                    }
                ]
            },
            practice: { problem: `How many minutes are in 1 hour?`, answer: "60", options: ["30", "60", "100", "12"],
                mistakeAnalysis: {
                    "30": "30 is HALF an hour. A full hour has 60 minutes.",
                    "100": "We use 60 for time, not 100. There are 60 minutes in 1 hour.",
                    "12": "12 is the number of hours on a clock face. Each hour has 60 minutes."
                }}
        }),
        Money: () => ({
            goalProblem: `How much is 2 quarters and 1 dime?`,
            teachingSteps: [
                {
                    title: "Know your coins",
                    explanation: "There are 4 main coins. Each has a different value. <strong>Size doesn't equal value!</strong>",
                    visual: "Quarter=25¢ | Dime=10¢ | Nickel=5¢ | Penny=1¢"
                },
                {
                    title: "Quarters are worth 25 cents",
                    explanation: "A <strong>quarter</strong> is the biggest coin and worth <strong>25¢</strong>. It has ridged edges and shows a design on the back.",
                    visual: "Quarter = 25¢"
                },
                {
                    title: "Let's count our quarters first",
                    explanation: "We have 2 quarters. Each is worth 25¢. 2 quarters = 2 × 25¢ = 50¢",
                    visual: "2 × 25¢ = 50¢"
                },
                {
                    title: "Now count the dime",
                    explanation: "We have 1 dime. A <strong>dime</strong> is the smallest coin but worth <strong>10¢</strong>. 1 dime = 10¢",
                    visual: "1 × 10¢ = 10¢"
                },
                {
                    title: "Add them together",
                    explanation: "Quarters: 50¢ + Dime: 10¢ = <strong>60¢</strong>. Always add from biggest to smallest coin!",
                    visual: "50¢ + 10¢ = 60¢"
                }
            ],
            finalAnswer: "60 cents (60¢)",
            answerExplanation: "2 quarters (50¢) + 1 dime (10¢) = 60¢. Remember: Quarter=25¢, Dime=10¢!",
            example: { problem: `How much is 2 quarters and 1 dime?`, steps: [
                { text: "Find the value of quarters", math: "2 quarters = 2 × 25¢ = 50¢" },
                { text: "Find the value of the dime", math: "1 dime = 10¢" },
                { text: "Add them together", math: "50¢ + 10¢ = <strong>60¢</strong>" }
            ]},
            keyPoints: [
                "Start with the biggest coins (quarters first)",
                "Skip count: quarters by 25s, dimes by 10s, nickels by 5s",
                "4 quarters = 100¢ = $1.00"
            ],
            mistakes: [
                { wrong: "Thinking a dime is worth more than a nickel because it's smaller", why: "Size doesn't matter! Dime = 10¢, Nickel = 5¢" },
                { wrong: "Forgetting to count all the coins", why: "Count each type separately, then add them up." }
            ],
            guided: {
                problem: `What is 3 dimes + 2 nickels?`,
                steps: [
                    { label: "Value of 3 dimes", value: "3 × 10¢ = 30¢" },
                    { label: "Value of 2 nickels", value: "2 × 5¢ = 10¢" },
                    { label: "Total", value: "?" }
                ],
                answer: "40",
                answerLabel: "Total cents:",
                interactiveSteps: [
                    {
                        prompt: "How much is ONE dime worth?",
                        hint: "A dime is the small silver coin...",
                        answer: "10",
                        acceptableAnswers: ["10", "10¢", "10 cents", "ten"],
                        formatHint: "Enter cents (e.g., 10)",
                        commonMistakes: {
                            "5": "That's a nickel! A dime = 10¢",
                            "25": "That's a quarter! A dime = 10¢",
                            "1": "That's a penny! A dime = 10¢"
                        }
                    },
                    {
                        prompt: "We have 3 dimes. How much is 3 × 10¢?",
                        hint: "Count by 10s: 10, 20, 30...",
                        answer: "30",
                        acceptableAnswers: ["30", "30¢", "30 cents"],
                        formatHint: "Enter cents (e.g., 30)",
                        commonMistakes: {
                            "13": "You added 10 + 3. Multiply: 3 × 10 = 30",
                            "10": "That's just 1 dime. We have 3 dimes: 3 × 10 = 30"
                        }
                    },
                    {
                        prompt: "How much is ONE nickel worth?",
                        hint: "A nickel is the big silver coin with a face...",
                        answer: "5",
                        acceptableAnswers: ["5", "5¢", "5 cents", "five"],
                        formatHint: "Enter cents (e.g., 5)",
                        commonMistakes: {
                            "10": "That's a dime! A nickel = 5¢",
                            "1": "That's a penny! A nickel = 5¢"
                        }
                    },
                    {
                        prompt: "We have 2 nickels. How much is 2 × 5¢?",
                        hint: "5 + 5 = ?",
                        answer: "10",
                        acceptableAnswers: ["10", "10¢", "10 cents"],
                        formatHint: "Enter cents (e.g., 10)",
                        commonMistakes: {
                            "7": "You added 5 + 2. Multiply: 2 × 5 = 10",
                            "5": "That's just 1 nickel. We have 2: 2 × 5 = 10"
                        }
                    },
                    {
                        prompt: "Now add the totals: 30¢ + 10¢ = ?",
                        hint: "Add the dimes total and nickels total...",
                        answer: "40",
                        acceptableAnswers: ["40", "40¢", "40 cents"],
                        formatHint: "Enter cents (e.g., 40)",
                        commonMistakes: {
                            "20": "You might have added 10 + 10. It's 30 + 10 = 40",
                            "310": "Don't combine digits! Add: 30 + 10 = 40"
                        }
                    }
                ]
            },
            practice: { problem: `1 quarter + 3 nickels = ? cents`, answer: "40", options: ["28", "35", "40", "45"],
                mistakeAnalysis: {
                    "28": "Check your coin values: Quarter = 25¢, Nickel = 5¢",
                    "35": "That's 1 quarter + 2 nickels. We have 3 nickels: 25 + 15 = 40",
                    "45": "That would be 4 nickels. We only have 3: 25 + 15 = 40"
                }}
        }),
        Rounding: () => {
            const num = rand(23, 87);
            const ones = num % 10;
            const rounded = ones >= 5 ? Math.ceil(num/10)*10 : Math.floor(num/10)*10;
            return {
                goalProblem: `Round 67 to the nearest ten`,
                teachingSteps: [
                    {
                        title: "What is rounding?",
                        explanation: "<strong>Rounding</strong> means finding the nearest 'friendly' number - a number that ends in 0, like 10, 20, 30, etc.",
                        visual: "67 → nearest 10 → 60 or 70?"
                    },
                    {
                        title: "Find the neighbors",
                        explanation: "67 sits between two tens: <strong>60</strong> and <strong>70</strong>. Which one is 67 closer to?",
                        visual: "60 ← 67 → 70"
                    },
                    {
                        title: "Look at the ones digit",
                        explanation: "The <strong>ones digit</strong> (the last digit) tells us which way to round. In 67, the ones digit is <strong>7</strong>.",
                        visual: "6<u>7</u> ← ones digit is 7"
                    },
                    {
                        title: "The rounding rule",
                        explanation: "If the ones digit is <strong>5 or more → round UP</strong>. If it's <strong>4 or less → round DOWN</strong>. Since 7 ≥ 5, we round UP!",
                        visual: "5, 6, 7, 8, 9 → UP | 0, 1, 2, 3, 4 → DOWN"
                    },
                    {
                        title: "67 rounds to 70",
                        explanation: "The ones digit is 7 (5 or more), so we round UP from 60 to 70. <strong>67 rounds to 70</strong>!",
                        visual: "67 → 70"
                    }
                ],
                finalAnswer: "70",
                answerExplanation: "67 has a ones digit of 7. Since 7 ≥ 5, we round UP to the next ten: 70.",
                example: { problem: `Round 67 to the nearest ten`, steps: [
                    { text: "Find the neighbors (tens around 67)", math: "67 is between 60 and 70" },
                    { text: "Look at the ones digit", math: "The ones digit is 7" },
                    { text: "Apply the rule: 7 ≥ 5, so round UP", math: "67 rounds to <strong>70</strong>" }
                ]},
                keyPoints: [
                    "5, 6, 7, 8, 9 → round UP",
                    "0, 1, 2, 3, 4 → round DOWN (stay at the lower ten)",
                    "Think: which ten is it CLOSER to?"
                ],
                mistakes: [
                    { wrong: "Rounding 45 down to 40", why: "5 is the special number - it rounds UP! 45 → 50" },
                    { wrong: "Changing the wrong digit", why: "When rounding to tens, only the tens digit changes. 67 → 70 (not 77)" }
                ],
                guided: {
                    problem: `Round ${num} to the nearest ten`,
                    steps: [
                        { label: `${num} is between`, value: `${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}` },
                        { label: "The ones digit is", value: `${ones}` },
                        { label: `${ones} is ${ones >= 5 ? '5 or more, so round UP' : '4 or less, so round DOWN'}`, value: "?" }
                    ],
                    answer: String(rounded),
                    answerLabel: "Rounded to:",
                    interactiveSteps: [
                        {
                            prompt: `When rounding ${num} to the nearest ten, which two tens is ${num} between?`,
                            hint: "Find the ten below and the ten above...",
                            answer: `${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`,
                            acceptableAnswers: [`${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`, `${Math.floor(num/10)*10}, ${Math.ceil(num/10)*10}`, `${Math.floor(num/10)*10}-${Math.ceil(num/10)*10}`],
                            formatHint: "e.g., 60 and 70",
                            commonMistakes: {
                                [String(num)]: `${num} is the number we're rounding. It sits BETWEEN ${Math.floor(num/10)*10} and ${Math.ceil(num/10)*10}`
                            }
                        },
                        {
                            prompt: `What is the ones digit (last digit) of ${num}?`,
                            hint: "The ones digit is the rightmost digit...",
                            answer: String(ones),
                            acceptableAnswers: [String(ones)],
                            formatHint: "Enter a digit (0-9)",
                            commonMistakes: {
                                [String(Math.floor(num/10))]: `That's the tens digit. The ONES digit (last digit) of ${num} is ${ones}`
                            }
                        },
                        {
                            prompt: `Is ${ones} five or more (round UP) or four or less (round DOWN)?`,
                            hint: "5, 6, 7, 8, 9 round UP. 0, 1, 2, 3, 4 round DOWN.",
                            answer: ones >= 5 ? "round up" : "round down",
                            acceptableAnswers: ones >= 5 ? ["round up", "up", "rounds up"] : ["round down", "down", "rounds down"],
                            formatHint: "round up or round down",
                            commonMistakes: ones >= 5 ? {
                                "round down": `${ones} is 5 or more, so we round UP!`
                            } : {
                                "round up": `${ones} is less than 5, so we round DOWN!`
                            }
                        },
                        {
                            prompt: `So ${num} rounded to the nearest ten is?`,
                            hint: ones >= 5 ? `Round UP to ${Math.ceil(num/10)*10}` : `Round DOWN to ${Math.floor(num/10)*10}`,
                            answer: String(rounded),
                            acceptableAnswers: [String(rounded)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(ones >= 5 ? Math.floor(num/10)*10 : Math.ceil(num/10)*10)]: `${ones} is ${ones >= 5 ? '5 or more, so round UP' : 'less than 5, so round DOWN'} to ${rounded}`
                            }
                        }
                    ]
                },
                practice: { problem: `Round 84 to the nearest ten`, answer: "80", options: ["80", "84", "85", "90"],
                    mistakeAnalysis: {
                        "84": "We need to round to a 'tens' number (ending in 0). 84's ones digit is 4, so round DOWN to 80.",
                        "85": "Close, but we round to the nearest TEN (80 or 90), not to 5.",
                        "90": "The ones digit is 4, which is less than 5, so we round DOWN to 80, not up to 90."
                    }}
            };
        },
        Measurement: () => ({
            goalProblem: `How many inches are in 2 feet?`,
            teachingSteps: [
                {
                    title: "Why do we convert measurements?",
                    explanation: "Sometimes we need to change from one unit to another. For example, your height might be in feet, but you need it in inches!",
                    visual: "Feet ↔ Inches"
                },
                {
                    title: "The key conversion: 1 foot = 12 inches",
                    explanation: "Memorize this! There are <strong>12 inches in 1 foot</strong>. A ruler is usually 12 inches long - that's 1 foot!",
                    visual: "1 foot = 12 inches"
                },
                {
                    title: "Going to smaller units? MULTIPLY!",
                    explanation: "Inches are smaller than feet. When converting to smaller units, you get MORE of them, so you <strong>multiply</strong>.",
                    visual: "Bigger → Smaller = MULTIPLY"
                },
                {
                    title: "Let's convert 2 feet to inches",
                    explanation: "We have 2 feet. Each foot has 12 inches. So we multiply: 2 × 12.",
                    visual: "2 feet × 12 inches/foot"
                },
                {
                    title: "Calculate the answer",
                    explanation: "2 × 12 = <strong>24</strong>. There are 24 inches in 2 feet!",
                    visual: "2 feet = 24 inches"
                }
            ],
            finalAnswer: "24 inches",
            answerExplanation: "2 feet × 12 inches per foot = 24 inches. Always multiply when going to smaller units!",
            example: { problem: `How many inches are in 2 feet?`, steps: [
                { text: "Know the conversion", math: "1 foot = 12 inches" },
                { text: "We have 2 feet, so multiply", math: "2 feet × 12 inches/foot" },
                { text: "Calculate", math: "2 × 12 = <strong>24 inches</strong>" }
            ]},
            keyPoints: [
                "1 foot = 12 inches (memorize this!)",
                "Feet → inches: MULTIPLY by 12",
                "Inches → feet: DIVIDE by 12"
            ],
            mistakes: [
                { wrong: "Adding 12 instead of multiplying", why: "2 feet = 2 × 12 = 24 inches, not 2 + 12 = 14" },
                { wrong: "Confusing which way to convert", why: "Smaller units = bigger number. Inches are smaller than feet, so more of them." }
            ],
            guided: {
                problem: `How many inches are in 3 feet?`,
                steps: [
                    { label: "Conversion", value: "1 foot = 12 inches" },
                    { label: "Multiply", value: "3 × 12" },
                    { label: "Answer", value: "?" }
                ],
                answer: "36",
                answerLabel: "Inches:",
                interactiveSteps: [
                    {
                        prompt: "How many inches are in ONE foot?",
                        hint: "Think of a ruler - it's one foot long...",
                        answer: "12",
                        acceptableAnswers: ["12", "twelve", "12 inches"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "1": "1 foot = 12 inches, not 1 inch!",
                            "10": "Close, but 1 foot = 12 inches (not 10).",
                            "3": "We have 3 feet, but 1 foot = 12 inches."
                        }
                    },
                    {
                        prompt: "We have 3 feet. To find the total inches, do we add or multiply?",
                        hint: "3 feet means 3 groups of 12 inches...",
                        answer: "multiply",
                        acceptableAnswers: ["multiply", "multiplication", "×", "times"],
                        formatHint: "add or multiply",
                        commonMistakes: {
                            "add": "Adding gives 3 + 12 = 15. But we need 3 GROUPS of 12, so multiply!",
                            "divide": "Division would give us fewer. We want more inches, so multiply."
                        }
                    },
                    {
                        prompt: "Calculate: 3 × 12 = ?",
                        hint: "3 groups of 12...",
                        answer: "36",
                        acceptableAnswers: ["36", "36 inches"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "15": "You added 3 + 12. Multiply: 3 × 12 = 36",
                            "24": "That's 2 × 12. We need 3 × 12 = 36",
                            "312": "Don't combine digits! 3 × 12 = 36"
                        }
                    }
                ]
            },
            practice: { problem: `24 inches = how many feet?`, answer: "2", options: ["1", "2", "12", "36"],
                mistakeAnalysis: {
                    "1": "24 ÷ 12 = 2, not 1. Check your division.",
                    "12": "You need to DIVIDE 24 by 12, not just use 12 as the answer.",
                    "36": "That's going the wrong way! To get feet from inches, divide: 24 ÷ 12 = 2"
                }}
        }),
        Fractions: () => ({
            goalProblem: `What fraction of the pizza is shaded? ◐◐◐○ (3 of 4 pieces)`,
            teachingSteps: [
                {
                    title: "What is a fraction?",
                    explanation: "A <strong>fraction</strong> represents <strong>part of a whole</strong>. When something is divided into equal pieces, a fraction tells us how many pieces we have.",
                    visual: "Part ÷ Whole = Fraction"
                },
                {
                    title: "The two parts of a fraction",
                    explanation: "A fraction has two numbers: the <strong>numerator</strong> (top) and <strong>denominator</strong> (bottom), separated by a line.",
                    visual: "numerator / denominator"
                },
                {
                    title: "Denominator = total equal parts",
                    explanation: "The <strong>bottom number</strong> (denominator) tells us how many <strong>equal parts</strong> the whole is divided into.",
                    visual: "◐◐◐○ = 4 total pieces → denominator is 4"
                },
                {
                    title: "Numerator = parts we have",
                    explanation: "The <strong>top number</strong> (numerator) tells us how many parts we're talking about (the shaded ones).",
                    visual: "◐◐◐○ = 3 shaded → numerator is 3"
                },
                {
                    title: "Write the fraction",
                    explanation: "Numerator on top (3), denominator on bottom (4). The fraction is <strong>3/4</strong>, read as 'three fourths' or '3 out of 4'.",
                    visual: "3/4 (three-fourths)"
                }
            ],
            finalAnswer: "3/4",
            answerExplanation: "3 out of 4 pieces are shaded. Numerator (what we have) = 3, Denominator (total pieces) = 4. The fraction is 3/4!",
            example: { problem: `What fraction of the pizza is shaded? ◐◐◐○ (3 of 4 pieces shaded)`, steps: [
                { text: "Count the TOTAL pieces", math: "There are 4 pieces total → this is the denominator" },
                { text: "Count the SHADED pieces", math: "3 pieces are shaded → this is the numerator" },
                { text: "Write the fraction", math: "<strong>3/4</strong> (three-fourths)" }
            ]},
            keyPoints: [
                "Denominator (bottom) = total equal parts",
                "Numerator (top) = parts you're counting",
                "The line means 'out of' → 3/4 = '3 out of 4'"
            ],
            mistakes: [
                { wrong: "Writing the numbers upside down", why: "Parts you HAVE go on TOP. Total parts go on BOTTOM." },
                { wrong: "3/4 of a pizza is bigger than 2/4", why: "Correct! More shaded parts = bigger fraction (when denominators are the same)" }
            ],
            guided: {
                problem: `A cake is cut into 8 equal slices. You eat 3. What fraction did you eat?`,
                steps: [
                    { label: "Total slices (denominator)", value: "8" },
                    { label: "Slices you ate (numerator)", value: "3" },
                    { label: "Fraction eaten", value: "?" }
                ],
                answer: "3/8",
                answerLabel: "Fraction:",
                interactiveSteps: [
                    {
                        prompt: "In a fraction, the BOTTOM number (denominator) tells us the TOTAL parts. How many slices is the cake cut into?",
                        hint: "Read the problem - how many equal slices?",
                        answer: "8",
                        acceptableAnswers: ["8", "eight"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "3": "3 is how many you ATE. The total slices = 8",
                            "5": "The cake has 8 slices total, not 5"
                        }
                    },
                    {
                        prompt: "The TOP number (numerator) is the part we're talking about. How many slices did you EAT?",
                        hint: "The problem says 'You eat...'",
                        answer: "3",
                        acceptableAnswers: ["3", "three"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "8": "8 is the total. You only ATE 3 slices.",
                            "5": "You ate 3 slices, not 5"
                        }
                    },
                    {
                        prompt: "Write the fraction: numerator on top, denominator on bottom. What fraction did you eat?",
                        hint: "3 (what you ate) over 8 (total slices)",
                        answer: "3/8",
                        acceptableAnswers: ["3/8", "3 / 8", "three eighths"],
                        formatHint: "e.g., 3/8",
                        commonMistakes: {
                            "8/3": "The numerator (3) goes on TOP, denominator (8) goes on BOTTOM: 3/8",
                            "5/8": "You ate 3 slices, so 3 goes on top: 3/8"
                        }
                    }
                ]
            },
            practice: { problem: `Which is larger: 2/5 or 4/5?`, answer: "4/5", options: ["2/5", "4/5", "They're equal"],
                mistakeAnalysis: {
                    "2/5": "When denominators are the same, compare numerators. 4 > 2, so 4/5 > 2/5",
                    "They're equal": "2 parts is less than 4 parts (out of the same 5). 4/5 is larger."
                }}
        }),
        "Word Problems": () => ({
            goalProblem: `Sam has 12 apples. He gives 5 to his friend. How many are left?`,
            teachingSteps: [
                {
                    title: "What is a word problem?",
                    explanation: "A <strong>word problem</strong> is a math question written as a story. We need to figure out which operation to use (add, subtract, multiply, or divide).",
                    visual: "Story → Find operation → Solve"
                },
                {
                    title: "Look for clue words",
                    explanation: "Certain words tell us which operation to use. In our problem, the word '<strong>left</strong>' is a clue!",
                    visual: "left, remaining = SUBTRACT"
                },
                {
                    title: "Clue words cheat sheet",
                    explanation: "<strong>Add:</strong> total, altogether, combined, sum. <strong>Subtract:</strong> left, remaining, difference, fewer. <strong>Multiply:</strong> each, groups of, times. <strong>Divide:</strong> split, share equally.",
                    visual: "total=ADD | left=SUBTRACT | each=MULTIPLY | split=DIVIDE"
                },
                {
                    title: "Identify the numbers",
                    explanation: "Sam <strong>has 12</strong> apples. He <strong>gives away 5</strong>. These are our two numbers: 12 and 5.",
                    visual: "Started with: 12 | Gave away: 5"
                },
                {
                    title: "Solve it!",
                    explanation: "'Left' means subtract. We take away the 5 apples he gave away from the 12 he started with: 12 - 5 = <strong>7</strong>",
                    visual: "12 - 5 = 7 apples left"
                }
            ],
            finalAnswer: "7 apples",
            answerExplanation: "The word 'left' tells us to subtract. 12 - 5 = 7. Sam has 7 apples left!",
            example: { problem: `Sam has 12 apples. He gives 5 to his friend. How many are left?`, steps: [
                { text: "Find the key word", math: "'Left' means SUBTRACTION" },
                { text: "Identify the numbers", math: "Started with: 12, Gave away: 5" },
                { text: "Set up and solve", math: "12 - 5 = <strong>7 apples left</strong>" }
            ]},
            keyPoints: [
                "Read the whole problem first",
                "Look for clue words to find the operation",
                "Write the number sentence before solving"
            ],
            mistakes: [
                { wrong: "Using the wrong operation", why: "Look for clue words! 'Left' = subtract, 'Total' = add" },
                { wrong: "Not answering what was asked", why: "Re-read the question. What exactly are they asking for?" }
            ],
            guided: {
                problem: `There are 4 boxes with 6 crayons in each box. How many crayons total?`,
                steps: [
                    { label: "Clue words", value: "'each' and 'total' suggest multiplication" },
                    { label: "Set up", value: "4 groups of 6 = 4 × 6" },
                    { label: "Answer", value: "?" }
                ],
                answer: "24",
                answerLabel: "Total crayons:",
                interactiveSteps: [
                    {
                        prompt: "The problem says '4 boxes with 6 crayons in EACH box'. The word 'each' suggests which operation?",
                        hint: "Equal groups usually means...",
                        answer: "multiplication",
                        acceptableAnswers: ["multiplication", "multiply", "times", "×"],
                        formatHint: "e.g., multiplication",
                        commonMistakes: {
                            "addition": "'Each' means equal groups - that's multiplication, not addition!",
                            "subtraction": "We're finding a TOTAL of equal groups, so we multiply.",
                            "division": "Division splits things up. We're combining groups, so multiply."
                        }
                    },
                    {
                        prompt: "How many boxes are there?",
                        hint: "Read the first part of the problem...",
                        answer: "4",
                        acceptableAnswers: ["4", "four"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "6": "6 is the crayons per box. The number of BOXES is 4."
                        }
                    },
                    {
                        prompt: "How many crayons are in EACH box?",
                        hint: "The problem says '6 crayons in each box'",
                        answer: "6",
                        acceptableAnswers: ["6", "six"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "4": "4 is the number of boxes. Each box has 6 crayons."
                        }
                    },
                    {
                        prompt: "Calculate: 4 boxes × 6 crayons = ?",
                        hint: "4 groups of 6...",
                        answer: "24",
                        acceptableAnswers: ["24", "24 crayons"],
                        formatHint: "Enter a number",
                        commonMistakes: {
                            "10": "You added 4 + 6. Multiply: 4 × 6 = 24",
                            "46": "Don't combine digits! 4 × 6 = 24"
                        }
                    }
                ]
            },
            practice: { problem: `Emma has 15 stickers. She gets 8 more. How many does she have now?`, answer: "23", options: ["7", "23", "120", "87"],
                mistakeAnalysis: {
                    "7": "You subtracted! 'Gets more' means ADD: 15 + 8 = 23",
                    "120": "You multiplied! 'Gets more' means ADD: 15 + 8 = 23",
                    "87": "You put the digits together. Add them: 15 + 8 = 23"
                }}
        }),
        "Multi-Digit Addition": () => {
            const a = rand(234, 567), b = rand(345, 456);
            const sum = a + b;
            return {
                goalProblem: `What is 347 + 285?`,
                teachingSteps: [
                    {
                        title: "Why add column by column?",
                        explanation: "When numbers get big, we can't just 'see' the answer. We break it down by <strong>place value</strong>: ones, tens, hundreds.",
                        visual: "347 + 285 → break into columns"
                    },
                    {
                        title: "Line up the numbers",
                        explanation: "Write the numbers vertically, <strong>lining up the ones, tens, and hundreds</strong>. This keeps us organized!",
                        visual: "  347\n+ 285\n-----"
                    },
                    {
                        title: "Step 1: Add the ONES column",
                        explanation: "Start on the right! 7 + 5 = 12. That's more than 9, so we write <strong>2</strong> and <strong>carry the 1</strong> to the tens.",
                        visual: "7 + 5 = 12 → write 2, carry 1"
                    },
                    {
                        title: "Step 2: Add the TENS column (don't forget the carry!)",
                        explanation: "4 + 8 = 12, plus the carried 1 = <strong>13</strong>. Write 3, carry 1 to hundreds.",
                        visual: "4 + 8 + 1 = 13 → write 3, carry 1"
                    },
                    {
                        title: "Step 3: Add the HUNDREDS column",
                        explanation: "3 + 2 = 5, plus the carried 1 = <strong>6</strong>. No more columns, so we're done!",
                        visual: "3 + 2 + 1 = 6"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>347 + 285 = 632</strong>. Always work right to left, carrying when a column adds to 10 or more!",
                        visual: "347 + 285 = 632"
                    }
                ],
                finalAnswer: "632",
                answerExplanation: "Add column by column from right to left: ones (7+5=12, carry 1), tens (4+8+1=13, carry 1), hundreds (3+2+1=6). Answer: 632!",
                example: { problem: `What is 347 + 285?`, steps: [
                    { text: "Line up by place value", math: "  347\n+ 285\n-----" },
                    { text: "Add ones: 7 + 5 = 12", math: "Write 2, carry 1" },
                    { text: "Add tens: 4 + 8 + 1 = 13", math: "Write 3, carry 1" },
                    { text: "Add hundreds: 3 + 2 + 1 = 6", math: "Answer: <strong>632</strong>" }
                ]},
                keyPoints: [
                    "Always start from the RIGHT (ones place)",
                    "When a column adds to 10+, write the ones digit and CARRY the tens digit",
                    "Don't forget to add the carried number to the next column!"
                ],
                mistakes: [
                    { wrong: "Forgetting to carry", why: "If ones add to 12, you must carry the 1 to tens!" },
                    { wrong: "Adding left to right", why: "Always go RIGHT to LEFT so you can carry properly" },
                    { wrong: "Not lining up columns", why: "Ones must be under ones, tens under tens, etc." }
                ],
                guided: {
                    problem: `What is ${a} + ${b}?`,
                    steps: [
                        { label: "Add ones", value: `${a % 10} + ${b % 10} = ?` },
                        { label: "Add tens (+ carry)", value: `${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} + carry = ?` },
                        { label: "Add hundreds (+ carry)", value: `${Math.floor(a/100)} + ${Math.floor(b/100)} + carry = ?` }
                    ],
                    answer: String(sum),
                    answerLabel: `${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `Let's add ${a} + ${b}. Start with the ones column: ${a % 10} + ${b % 10} = ?`,
                            hint: "Add the rightmost digits...",
                            answer: String((a % 10) + (b % 10)),
                            acceptableAnswers: [String((a % 10) + (b % 10))],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a % 10)]: `Add both ones digits: ${a % 10} + ${b % 10} = ${(a % 10) + (b % 10)}`
                            }
                        },
                        {
                            prompt: `${(a % 10) + (b % 10)} in the ones column. ${(a % 10) + (b % 10) >= 10 ? `That's 10 or more! Write ${(a % 10 + b % 10) % 10} and carry ${Math.floor((a % 10 + b % 10) / 10)}. Now add tens: ${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} + ${Math.floor((a % 10 + b % 10) / 10)} = ?` : `Less than 10, no carry needed. Now add tens: ${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} = ?`}`,
                            hint: "Add the tens digits (and any carry)...",
                            answer: String((Math.floor(a/10) % 10) + (Math.floor(b/10) % 10) + Math.floor((a % 10 + b % 10) / 10)),
                            acceptableAnswers: [String((Math.floor(a/10) % 10) + (Math.floor(b/10) % 10) + Math.floor((a % 10 + b % 10) / 10))],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now put it all together. What is ${a} + ${b}?`,
                            hint: "Combine all your column answers...",
                            answer: String(sum),
                            acceptableAnswers: [String(sum)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(a)]: `Don't forget to add! ${a} + ${b} = ${sum}`,
                                [String(sum + 10)]: "Check your carrying - you may have an extra 10"
                            }
                        }
                    ]
                },
                practice: (() => { const pa = rand(400, 550), pb = rand(350, 450); return {
                    problem: `What is ${pa} + ${pb}?`, answer: String(pa + pb),
                    options: shuffle([String(pa + pb), String(pa + pb + 10), String(pa + pb - 10), String(pa + pb + 100)]),
                    mistakeAnalysis: {
                        [String(pa + pb + 10)]: "Check your carrying in the tens column",
                        [String(pa + pb - 10)]: "Did you forget to carry?",
                        [String(pa + pb + 100)]: "Check your carrying in the hundreds column"
                    }}; })()
            };
        },
        "Multi-Digit Subtraction": () => {
            const a = rand(500, 800), b = rand(200, 400);
            const diff = a - b;
            return {
                goalProblem: `What is 532 - 278?`,
                teachingSteps: [
                    {
                        title: "Subtraction with borrowing",
                        explanation: "When subtracting big numbers, sometimes the top digit is <strong>smaller</strong> than the bottom. That's when we <strong>borrow</strong>!",
                        visual: "532 - 278 = ?"
                    },
                    {
                        title: "Line up and start at the right",
                        explanation: "Write vertically, line up place values. Start with the ones: 2 - 8. Uh oh! 2 is less than 8!",
                        visual: "  532\n- 278\n-----\nOnes: 2 - 8 = ??"
                    },
                    {
                        title: "Step 1: Borrow from the tens",
                        explanation: "We need to <strong>borrow 1 ten</strong> from the 3 (making it 2). That 1 ten = 10 ones, so 2 becomes 12. Now: 12 - 8 = <strong>4</strong>",
                        visual: "Borrow: 3→2, ones: 2→12. Now 12 - 8 = 4"
                    },
                    {
                        title: "Step 2: Subtract the tens",
                        explanation: "Tens column: 2 - 7 (remember we borrowed!). 2 < 7, so borrow from hundreds: 5→4, and 2→12. Now: 12 - 7 = <strong>5</strong>",
                        visual: "Borrow: 5→4, tens: 2→12. Now 12 - 7 = 5"
                    },
                    {
                        title: "Step 3: Subtract the hundreds",
                        explanation: "Hundreds: 4 - 2 = <strong>2</strong>. No more borrowing needed!",
                        visual: "4 - 2 = 2"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>532 - 278 = 254</strong>. Borrowing makes the top number bigger so we can subtract!",
                        visual: "532 - 278 = 254"
                    }
                ],
                finalAnswer: "254",
                answerExplanation: "Borrow when needed: ones (12-8=4), tens (12-7=5), hundreds (4-2=2). Answer: 254!",
                example: { problem: `What is 532 - 278?`, steps: [
                    { text: "Ones: 2 - 8? Can't! Borrow from tens", math: "3→2, 2→12. Now 12 - 8 = 4" },
                    { text: "Tens: 2 - 7? Can't! Borrow from hundreds", math: "5→4, 2→12. Now 12 - 7 = 5" },
                    { text: "Hundreds: 4 - 2 = 2", math: "Answer: <strong>254</strong>" }
                ]},
                keyPoints: [
                    "If top < bottom, BORROW from the next column left",
                    "Borrowing: take 1 from the left column, add 10 to current column",
                    "Always subtract: TOP minus BOTTOM"
                ],
                mistakes: [
                    { wrong: "Subtracting smaller from larger (8 - 2 = 6)", why: "Always subtract TOP - BOTTOM! If top is smaller, borrow." },
                    { wrong: "Forgetting you borrowed", why: "After borrowing, the digit you borrowed FROM is 1 less!" },
                    { wrong: "Borrowing when you don't need to", why: "Only borrow if top digit < bottom digit" }
                ],
                guided: {
                    problem: `What is ${a} - ${b}?`,
                    steps: [
                        { label: "Subtract ones (borrow if needed)", value: `${a % 10} - ${b % 10} = ?` },
                        { label: "Subtract tens (borrow if needed)", value: `? - ${Math.floor(b/10) % 10} = ?` },
                        { label: "Subtract hundreds", value: "?" }
                    ],
                    answer: String(diff),
                    answerLabel: `${a} - ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `Let's subtract ${a} - ${b}. Look at the ones: ${a % 10} - ${b % 10}. ${a % 10 < b % 10 ? "Can we do this, or do we need to borrow?" : "Can we do this without borrowing?"}`,
                            hint: a % 10 < b % 10 ? `${a % 10} is less than ${b % 10}, so we need to...` : "Compare the digits...",
                            answer: a % 10 < b % 10 ? "borrow" : "yes",
                            acceptableAnswers: a % 10 < b % 10 ? ["borrow", "no", "need to borrow", "can't"] : ["yes", "no borrowing", "don't need to borrow"],
                            formatHint: "borrow or yes",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Work through the subtraction. What is ${a} - ${b}?`,
                            hint: "Subtract column by column, borrowing when needed...",
                            answer: String(diff),
                            acceptableAnswers: [String(diff)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(diff + 10)]: "Check your borrowing - you may have missed one",
                                [String(diff - 10)]: "Check if you borrowed when you didn't need to"
                            }
                        }
                    ]
                },
                practice: (() => { const pa = rand(600, 900), pb = rand(250, 450); return {
                    problem: `What is ${pa} - ${pb}?`, answer: String(pa - pb),
                    options: shuffle([String(pa - pb), String(pa - pb + 10), String(pa - pb - 10), String(pb - pa + 1000)]),
                    mistakeAnalysis: {
                        [String(pa - pb + 10)]: "Check your borrowing - did you forget to reduce a digit?",
                        [String(pa - pb - 10)]: "Check your borrowing - did you borrow when you didn't need to?"
                    }}; })()
            };
        },
        "Long Division": () => {
            const divisor = rand(3, 7);
            const quotient = rand(12, 25);
            const dividend = divisor * quotient;
            return {
                goalProblem: `What is 84 ÷ 4?`,
                teachingSteps: [
                    {
                        title: "What is long division?",
                        explanation: "<strong>Long division</strong> is a step-by-step method for dividing larger numbers. We work digit by digit from left to right.",
                        visual: "84 ÷ 4 = ? (using long division)"
                    },
                    {
                        title: "Set up the problem",
                        explanation: "Write it in the 'house' format: divisor outside, dividend inside. We'll find the quotient on top.",
                        visual: "    ?\n  -----\n4 | 84"
                    },
                    {
                        title: "Step 1: Divide the first digit",
                        explanation: "How many times does 4 go into 8? <strong>4 × 2 = 8</strong>, so write 2 above the 8.",
                        visual: "    2\n  -----\n4 | 84\n   -8\n    0"
                    },
                    {
                        title: "Step 2: Multiply and subtract",
                        explanation: "2 × 4 = 8. Write 8 under the 8 and subtract: 8 - 8 = 0. Bring down the next digit (4).",
                        visual: "    2\n  -----\n4 | 84\n   -8↓\n    04"
                    },
                    {
                        title: "Step 3: Divide again",
                        explanation: "How many times does 4 go into 4? <strong>4 × 1 = 4</strong>, so write 1 above the 4.",
                        visual: "    21\n  -----\n4 | 84\n   -8\n    04\n    -4\n     0"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>84 ÷ 4 = 21</strong>. The remainder is 0, so it divides evenly!",
                        visual: "84 ÷ 4 = 21"
                    }
                ],
                finalAnswer: "21",
                answerExplanation: "Using long division: 4 into 8 = 2, 4 into 4 = 1. Answer: 21!",
                example: { problem: `What is 84 ÷ 4?`, steps: [
                    { text: "Set up: 4 | 84", math: "Divide 4 into 8: 8 ÷ 4 = 2" },
                    { text: "Multiply and subtract", math: "2 × 4 = 8, then 8 - 8 = 0" },
                    { text: "Bring down 4, divide again", math: "4 ÷ 4 = 1" },
                    { text: "Final answer", math: "<strong>84 ÷ 4 = 21</strong>" }
                ]},
                keyPoints: [
                    "Divide → Multiply → Subtract → Bring down → Repeat",
                    "Work from LEFT to RIGHT",
                    "Check: quotient × divisor should equal dividend"
                ],
                mistakes: [
                    { wrong: "Dividing right to left", why: "Long division goes LEFT to RIGHT!" },
                    { wrong: "Forgetting to bring down", why: "After subtracting, always bring down the next digit" },
                    { wrong: "Wrong multiplication", why: "Double-check: quotient digit × divisor" }
                ],
                guided: {
                    problem: `What is ${dividend} ÷ ${divisor}?`,
                    steps: [
                        { label: `${divisor} into ${Math.floor(dividend/10)}`, value: `${Math.floor(dividend/10)} ÷ ${divisor} = ${Math.floor(Math.floor(dividend/10)/divisor)}` },
                        { label: "Bring down, divide again", value: "?" },
                        { label: "Final quotient", value: "?" }
                    ],
                    answer: String(quotient),
                    answerLabel: `${dividend} ÷ ${divisor} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `Let's divide ${dividend} ÷ ${divisor}. First, how many times does ${divisor} go into ${Math.floor(dividend/10)}?`,
                            hint: `Think: ${divisor} × ? ≤ ${Math.floor(dividend/10)}`,
                            answer: String(Math.floor(Math.floor(dividend/10)/divisor)),
                            acceptableAnswers: [String(Math.floor(Math.floor(dividend/10)/divisor))],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        },
                        {
                            prompt: `Good! Now complete the division. What is ${dividend} ÷ ${divisor}?`,
                            hint: "Continue the long division process...",
                            answer: String(quotient),
                            acceptableAnswers: [String(quotient)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(divisor)]: `That's the divisor. The quotient (answer) is ${quotient}`,
                                [String(dividend)]: `That's the dividend. We're dividing to get ${quotient}`
                            }
                        },
                        {
                            prompt: `Let's check: ${quotient} × ${divisor} = ?`,
                            hint: "Multiply to verify...",
                            answer: String(dividend),
                            acceptableAnswers: [String(dividend)],
                            formatHint: "Enter a number",
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pd = divisor * rand(15, 30); return {
                    problem: `What is ${pd} ÷ ${divisor}?`, answer: String(pd / divisor),
                    options: shuffle([String(pd / divisor), String(pd / divisor + 1), String(pd / divisor - 1), String(divisor)]),
                    mistakeAnalysis: {
                        [String(pd / divisor + 1)]: `Check: ${pd / divisor + 1} × ${divisor} = ${(pd / divisor + 1) * divisor}, not ${pd}`,
                        [String(pd / divisor - 1)]: `Check: ${pd / divisor - 1} × ${divisor} = ${(pd / divisor - 1) * divisor}, not ${pd}`,
                        [String(divisor)]: "That's the divisor, not the quotient!"
                    }}; })()
            };
        },
        "Equivalent Fractions": () => {
            const n = rand(1, 3), d = rand(n + 1, 5);
            const mult = rand(2, 4);
            return {
                goalProblem: `Find a fraction equivalent to 2/3`,
                teachingSteps: [
                    {
                        title: "What are equivalent fractions?",
                        explanation: "<strong>Equivalent fractions</strong> are different fractions that represent the <strong>same amount</strong>. Like 1/2 and 2/4 - they're both 'half'!",
                        visual: "1/2 = 2/4 = 3/6 (all equal half)"
                    },
                    {
                        title: "The golden rule",
                        explanation: "To make an equivalent fraction, <strong>multiply (or divide) BOTH the top AND bottom by the same number</strong>.",
                        visual: "× same number on top AND bottom"
                    },
                    {
                        title: "Let's find a fraction equal to 2/3",
                        explanation: "We'll multiply both parts by 2. This is like cutting each piece in half - more pieces, but same total amount!",
                        visual: "2/3 → multiply both by 2"
                    },
                    {
                        title: "Multiply the numerator",
                        explanation: "Top (numerator): 2 × 2 = <strong>4</strong>",
                        visual: "2 × 2 = 4 (new numerator)"
                    },
                    {
                        title: "Multiply the denominator",
                        explanation: "Bottom (denominator): 3 × 2 = <strong>6</strong>",
                        visual: "3 × 2 = 6 (new denominator)"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>2/3 = 4/6</strong>. They're the same amount! You can also multiply by 3 to get 6/9, or by 4 to get 8/12.",
                        visual: "2/3 = 4/6 ✓"
                    }
                ],
                finalAnswer: "4/6",
                answerExplanation: "Multiply both numerator and denominator by 2: (2×2)/(3×2) = 4/6. The fractions are equivalent!",
                example: { problem: `Find a fraction equivalent to 2/3`, steps: [
                    { text: "Choose a multiplier (let's use 2)", math: "Multiply BOTH parts by 2" },
                    { text: "Multiply numerator", math: "2 × 2 = 4" },
                    { text: "Multiply denominator", math: "3 × 2 = 6" },
                    { text: "Equivalent fraction", math: "2/3 = <strong>4/6</strong>" }
                ]},
                keyPoints: [
                    "Multiply BOTH top and bottom by the SAME number",
                    "This doesn't change the VALUE, just how it looks",
                    "You can also DIVIDE both by the same number to simplify"
                ],
                mistakes: [
                    { wrong: "Only multiplying the top", why: "Must multiply BOTH! 2×2/3 = 4/3 is NOT equal to 2/3" },
                    { wrong: "Adding instead of multiplying", why: "(2+2)/(3+2) = 4/5 ≠ 2/3. You must MULTIPLY!" },
                    { wrong: "Multiplying by different numbers", why: "Both parts must be multiplied by the SAME number" }
                ],
                guided: {
                    problem: `Find a fraction equivalent to ${n}/${d} (multiply by ${mult})`,
                    steps: [
                        { label: `Multiply numerator: ${n} × ${mult}`, value: `${n * mult}` },
                        { label: `Multiply denominator: ${d} × ${mult}`, value: `${d * mult}` },
                        { label: "New equivalent fraction", value: "?" }
                    ],
                    answer: `${n * mult}/${d * mult}`,
                    answerLabel: "Equivalent fraction:",
                    interactiveSteps: [
                        {
                            prompt: `To find an equivalent fraction, we multiply BOTH parts by the same number. What is ${n} × ${mult} (the new numerator)?`,
                            hint: `Multiply the top: ${n} × ${mult} = ?`,
                            answer: String(n * mult),
                            acceptableAnswers: [String(n * mult)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(n + mult)]: `You added! Multiply: ${n} × ${mult} = ${n * mult}`,
                                [String(n)]: `Don't forget to multiply! ${n} × ${mult} = ${n * mult}`
                            }
                        },
                        {
                            prompt: `Now multiply the denominator: ${d} × ${mult} = ?`,
                            hint: `Multiply the bottom by the same number...`,
                            answer: String(d * mult),
                            acceptableAnswers: [String(d * mult)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(d + mult)]: `You added! Multiply: ${d} × ${mult} = ${d * mult}`,
                                [String(d)]: `Multiply the bottom too! ${d} × ${mult} = ${d * mult}`
                            }
                        },
                        {
                            prompt: `So ${n}/${d} is equivalent to what fraction?`,
                            hint: `Put your new numerator over your new denominator...`,
                            answer: `${n * mult}/${d * mult}`,
                            acceptableAnswers: [`${n * mult}/${d * mult}`, `${n*mult}/${d*mult}`],
                            formatHint: "e.g., 4/6",
                            commonMistakes: {
                                [`${n}/${d * mult}`]: `You only multiplied the bottom! The numerator should be ${n * mult}`,
                                [`${n * mult}/${d}`]: `You only multiplied the top! The denominator should be ${d * mult}`
                            }
                        }
                    ]
                },
                practice: { problem: `Which fraction is equivalent to 3/4?`, answer: "6/8",
                    options: ["6/8", "6/4", "3/8", "4/6"],
                    mistakeAnalysis: {
                        "6/4": "You only multiplied the top! 3/4 × 2/2 = 6/8",
                        "3/8": "You only multiplied the bottom! 3/4 × 2/2 = 6/8",
                        "4/6": "That's not equivalent. 3/4 × 2/2 = 6/8"
                    }}
            };
        },
        "Mixed Numbers": () => {
            const whole = rand(1, 4), n = rand(1, 3), d = rand(n + 1, 5);
            const improper = whole * d + n;
            return {
                goalProblem: `Convert 2 3/4 to an improper fraction`,
                teachingSteps: [
                    {
                        title: "Mixed numbers vs. improper fractions",
                        explanation: "A <strong>mixed number</strong> has a whole part and a fraction part (like 2 3/4). An <strong>improper fraction</strong> has a numerator bigger than the denominator (like 11/4).",
                        visual: "2 3/4 (mixed) = 11/4 (improper)"
                    },
                    {
                        title: "Converting mixed → improper",
                        explanation: "To convert, we need to figure out <strong>how many pieces total</strong>. Think: the whole parts become pieces too!",
                        visual: "2 wholes + 3/4 = how many fourths total?"
                    },
                    {
                        title: "Step 1: Multiply whole × denominator",
                        explanation: "Each whole has 4 fourths. We have 2 wholes: 2 × 4 = <strong>8 fourths</strong> from the whole part.",
                        visual: "2 × 4 = 8 fourths"
                    },
                    {
                        title: "Step 2: Add the numerator",
                        explanation: "We also have 3 more fourths from the fraction part. Total: 8 + 3 = <strong>11 fourths</strong>.",
                        visual: "8 + 3 = 11 fourths"
                    },
                    {
                        title: "Step 3: Keep the same denominator",
                        explanation: "The denominator stays the same (4). We're still counting fourths!",
                        visual: "11 fourths = 11/4"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>2 3/4 = 11/4</strong>. Formula: (whole × denominator + numerator) / denominator",
                        visual: "2 3/4 = 11/4"
                    }
                ],
                finalAnswer: "11/4",
                answerExplanation: "(2 × 4) + 3 = 11, denominator stays 4. So 2 3/4 = 11/4!",
                example: { problem: `Convert 2 3/4 to an improper fraction`, steps: [
                    { text: "Multiply whole × denominator", math: "2 × 4 = 8" },
                    { text: "Add the numerator", math: "8 + 3 = 11" },
                    { text: "Keep the denominator", math: "11/4" },
                    { text: "Final answer", math: "2 3/4 = <strong>11/4</strong>" }
                ]},
                keyPoints: [
                    "Formula: (whole × denominator + numerator) / denominator",
                    "The denominator NEVER changes",
                    "To go the other way: divide numerator by denominator"
                ],
                mistakes: [
                    { wrong: "Forgetting to add the numerator", why: "Don't forget the extra pieces! 2 × 4 = 8, then 8 + 3 = 11" },
                    { wrong: "Changing the denominator", why: "The denominator stays the same - we're counting the same size pieces" },
                    { wrong: "Adding instead of multiplying first", why: "Multiply first (whole × denominator), THEN add the numerator" }
                ],
                guided: {
                    problem: `Convert ${whole} ${n}/${d} to an improper fraction`,
                    steps: [
                        { label: `Multiply whole × denominator: ${whole} × ${d}`, value: `${whole * d}` },
                        { label: `Add numerator: ${whole * d} + ${n}`, value: `${improper}` },
                        { label: `Keep denominator: ?/${d}`, value: "?" }
                    ],
                    answer: `${improper}/${d}`,
                    answerLabel: "Improper fraction:",
                    interactiveSteps: [
                        {
                            prompt: `First, multiply the whole number by the denominator: ${whole} × ${d} = ?`,
                            hint: "This tells us how many pieces are in the whole parts...",
                            answer: String(whole * d),
                            acceptableAnswers: [String(whole * d)],
                            commonMistakes: {
                                [String(whole + d)]: `You added! Multiply: ${whole} × ${d} = ${whole * d}`
                            }
                        },
                        {
                            prompt: `Now add the numerator: ${whole * d} + ${n} = ?`,
                            hint: "Add the extra pieces from the fraction part...",
                            answer: String(improper),
                            acceptableAnswers: [String(improper)],
                            commonMistakes: {
                                [String(whole * d)]: `Don't forget to add ${n}! ${whole * d} + ${n} = ${improper}`
                            }
                        },
                        {
                            prompt: `The denominator stays ${d}. What is ${whole} ${n}/${d} as an improper fraction?`,
                            hint: "Put your total over the original denominator...",
                            answer: `${improper}/${d}`,
                            acceptableAnswers: [`${improper}/${d}`, `${improper} / ${d}`],
                            commonMistakes: {
                                [`${improper}/${improper}`]: `The denominator stays the same! It should be ${d}`,
                                [`${n}/${d}`]: `That's just the fraction part. The full answer is ${improper}/${d}`
                            }
                        }
                    ]
                },
                practice: { problem: `Convert 3 1/2 to an improper fraction`, answer: "7/2",
                    options: ["7/2", "4/2", "6/2", "3/2"],
                    mistakeAnalysis: {
                        "4/2": "You forgot to add the numerator! (3 × 2) + 1 = 7",
                        "6/2": "That's just 3 × 2. Don't forget to add the 1!",
                        "3/2": "That's less than the original! (3 × 2) + 1 = 7, so it's 7/2"
                    }}
            };
        },
        Estimation: () => {
            const a = rand(28, 77), b = rand(23, 68);
            const roundA = Math.round(a / 10) * 10, roundB = Math.round(b / 10) * 10;
            const estimate = roundA + roundB;
            return {
                goalProblem: `Estimate 47 + 32 by rounding to the nearest ten`,
                teachingSteps: [
                    {
                        title: "What is estimation?",
                        explanation: "<strong>Estimation</strong> means finding an <strong>approximate answer</strong> quickly. It's useful for checking work or making quick decisions!",
                        visual: "47 + 32 ≈ ? (close to what?)"
                    },
                    {
                        title: "Why round to estimate?",
                        explanation: "Numbers ending in 0 are easy to add mentally! Rounding gives us 'friendly numbers' to work with.",
                        visual: "47 → 50, 32 → 30 (easier!)"
                    },
                    {
                        title: "Step 1: Round the first number",
                        explanation: "Round 47 to the nearest ten. The ones digit is 7 (5 or more → round UP). <strong>47 → 50</strong>",
                        visual: "47 → 50"
                    },
                    {
                        title: "Step 2: Round the second number",
                        explanation: "Round 32 to the nearest ten. The ones digit is 2 (less than 5 → round DOWN). <strong>32 → 30</strong>",
                        visual: "32 → 30"
                    },
                    {
                        title: "Step 3: Add the rounded numbers",
                        explanation: "Now add the friendly numbers: 50 + 30 = <strong>80</strong>. That's our estimate!",
                        visual: "50 + 30 = 80"
                    },
                    {
                        title: "Check: Is our estimate close?",
                        explanation: "Actual answer: 47 + 32 = 79. Our estimate of 80 is very close! Estimation works!",
                        visual: "Estimate: 80 | Actual: 79 ✓"
                    }
                ],
                finalAnswer: "80",
                answerExplanation: "Round 47 → 50, round 32 → 30. Then 50 + 30 = 80. The actual answer (79) is very close!",
                example: { problem: `Estimate 47 + 32 by rounding to the nearest ten`, steps: [
                    { text: "Round first number", math: "47 → 50 (7 ≥ 5, round up)" },
                    { text: "Round second number", math: "32 → 30 (2 < 5, round down)" },
                    { text: "Add rounded numbers", math: "50 + 30 = <strong>80</strong>" },
                    { text: "Verify", math: "Actual: 47 + 32 = 79 (close to 80!)" }
                ]},
                keyPoints: [
                    "Round each number first, then calculate",
                    "Estimates are APPROXIMATE - they won't be exact",
                    "Use estimation to check if your exact answer makes sense"
                ],
                mistakes: [
                    { wrong: "Rounding and then forgetting to add", why: "After rounding, you still need to do the operation!" },
                    { wrong: "Rounding incorrectly", why: "Remember: 5+ rounds UP, 4 or less rounds DOWN" },
                    { wrong: "Expecting an exact answer", why: "Estimates are approximate! Close is good enough." }
                ],
                guided: {
                    problem: `Estimate ${a} + ${b} by rounding to the nearest ten`,
                    steps: [
                        { label: `Round ${a}`, value: `${roundA}` },
                        { label: `Round ${b}`, value: `${roundB}` },
                        { label: "Add rounded numbers", value: "?" }
                    ],
                    answer: String(estimate),
                    answerLabel: "Estimate:",
                    interactiveSteps: [
                        {
                            prompt: `Round ${a} to the nearest ten. The ones digit is ${a % 10}. Does it round up or down?`,
                            hint: `${a % 10} is ${a % 10 >= 5 ? "5 or more, so..." : "less than 5, so..."}`,
                            answer: a % 10 >= 5 ? "up" : "down",
                            acceptableAnswers: a % 10 >= 5 ? ["up", "round up"] : ["down", "round down"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `So ${a} rounds to what?`,
                            hint: `Round ${a % 10 >= 5 ? "up" : "down"} to the nearest ten...`,
                            answer: String(roundA),
                            acceptableAnswers: [String(roundA)],
                            commonMistakes: {
                                [String(a)]: `That's the original number! Round to the nearest ten: ${roundA}`
                            }
                        },
                        {
                            prompt: `Round ${b} to the nearest ten.`,
                            hint: `The ones digit is ${b % 10}...`,
                            answer: String(roundB),
                            acceptableAnswers: [String(roundB)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now add your rounded numbers: ${roundA} + ${roundB} = ?`,
                            hint: "Add the friendly numbers...",
                            answer: String(estimate),
                            acceptableAnswers: [String(estimate)],
                            commonMistakes: {
                                [String(a + b)]: `That's the exact answer! We want the estimate: ${roundA} + ${roundB} = ${estimate}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = rand(35, 65), pb = rand(25, 55); const pra = Math.round(pa/10)*10, prb = Math.round(pb/10)*10; return {
                    problem: `Estimate ${pa} + ${pb}`, answer: String(pra + prb),
                    options: shuffle([String(pra + prb), String(pa + pb), String(pra + prb + 10), String(pra + prb - 10)]),
                    mistakeAnalysis: {
                        [String(pa + pb)]: "That's the exact answer! For estimation, round first, then add.",
                        [String(pra + prb + 10)]: "Check your rounding - one number may have rounded wrong.",
                        [String(pra + prb - 10)]: "Check your rounding - one number may have rounded wrong."
                    }}; })()
            };
        },
        Perimeter: () => {
            const length = rand(6, 12), width = rand(4, 8);
            const perimeter = 2 * (length + width);
            return {
                goalProblem: `Find the perimeter of a rectangle with length 8 and width 5`,
                teachingSteps: [
                    {
                        title: "What is perimeter?",
                        explanation: "<strong>Perimeter</strong> is the <strong>distance around</strong> ANY shape - like walking along all the edges. Whether it's a rectangle, triangle, hexagon, or any other shape, you just add up all the sides!",
                        visual: "Perimeter = total distance around (works for ALL shapes!)"
                    },
                    {
                        title: "The Universal Rule",
                        explanation: "For <strong>ANY shape</strong>, perimeter = <strong>add all the sides together</strong>. That's it! This works for triangles, rectangles, pentagons - everything!",
                        visual: "Triangle: a + b + c | Rectangle: L + W + L + W | Pentagon: add all 5 sides"
                    },
                    {
                        title: "Triangle Example",
                        explanation: "A triangle has 3 sides. If the sides are 3, 4, and 5:<br>Perimeter = 3 + 4 + 5 = <strong>12</strong>",
                        visual: "Triangle: 3 + 4 + 5 = 12"
                    },
                    {
                        title: "Square Shortcut",
                        explanation: "A square has 4 <strong>equal</strong> sides. Instead of adding 4 times, multiply!<br>Side = 6: P = 6 + 6 + 6 + 6 = 4 × 6 = <strong>24</strong>",
                        visual: "Square: P = 4 × side"
                    },
                    {
                        title: "Rectangle: Method 1 (Add all sides)",
                        explanation: "A rectangle has 2 lengths and 2 widths. For length 8, width 5:<br>Add: 8 + 5 + 8 + 5 = <strong>26</strong>",
                        visual: "8 + 5 + 8 + 5 = 26"
                    },
                    {
                        title: "Rectangle: Method 2 (Formula shortcut)",
                        explanation: "Since opposite sides are equal, use: P = 2 × (length + width)<br>P = 2 × (8 + 5) = 2 × 13 = <strong>26</strong>",
                        visual: "P = 2 × (L + W) = 2 × 13 = 26"
                    },
                    {
                        title: "The answer!",
                        explanation: "The perimeter is <strong>26 units</strong>. Don't forget the units (cm, ft, m, etc.) if given!",
                        visual: "Perimeter = 26 units"
                    }
                ],
                finalAnswer: "26 units",
                answerExplanation: "Perimeter = 2 × (length + width) = 2 × (8 + 5) = 2 × 13 = 26 units!",
                example: { problem: `Find the perimeter of a rectangle with length 8 and width 5`, steps: [
                    { text: "Identify the sides", math: "Length = 8, Width = 5" },
                    { text: "Use the formula", math: "P = 2 × (L + W)" },
                    { text: "Substitute and calculate", math: "P = 2 × (8 + 5) = 2 × 13 = <strong>26</strong>" }
                ]},
                keyPoints: [
                    "Perimeter = distance AROUND any shape (add all sides!)",
                    "Universal rule: add all the sides together (works for ANY shape)",
                    "Triangle: P = side₁ + side₂ + side₃ (add all 3 sides)",
                    "Square shortcut: P = 4 × side (all sides equal)",
                    "Rectangle shortcut: P = 2 × (length + width)"
                ],
                mistakes: [
                    { wrong: "Multiplying length × width", why: "That's AREA! Perimeter is adding the sides together." },
                    { wrong: "Only adding two sides", why: "Count ALL sides - rectangles have 4, triangles have 3!" },
                    { wrong: "Forgetting to multiply by 2 for rectangles", why: "Two lengths AND two widths: 2 × (L + W)" }
                ],
                guided: {
                    problem: `Find the perimeter of a rectangle with length ${length} and width ${width}`,
                    steps: [
                        { label: `Add length + width: ${length} + ${width}`, value: `${length + width}` },
                        { label: "Multiply by 2 (for all 4 sides)", value: "?" },
                        { label: "Perimeter", value: "?" }
                    ],
                    answer: String(perimeter),
                    answerLabel: "Perimeter:",
                    interactiveSteps: [
                        {
                            prompt: `First, add the length and width: ${length} + ${width} = ?`,
                            hint: "Add one length and one width... (enter just the number)",
                            answer: String(length + width),
                            acceptableAnswers: [String(length + width)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(length * width)]: `You multiplied! Add: ${length} + ${width} = ${length + width}`
                            }
                        },
                        {
                            prompt: `Now multiply by 2 (because there are 2 lengths and 2 widths): 2 × ${length + width} = ?`,
                            hint: "Double your sum to account for all 4 sides... (enter just the number)",
                            answer: String(perimeter),
                            acceptableAnswers: [String(perimeter)],
                            formatHint: "Enter a number",
                            commonMistakes: {
                                [String(length + width)]: `You need to multiply by 2! 2 × ${length + width} = ${perimeter}`
                            }
                        },
                        {
                            prompt: `What is the final perimeter? (enter a number, with or without "units")`,
                            hint: "What's the total distance around?",
                            answer: String(perimeter),
                            acceptableAnswers: [String(perimeter), `${perimeter} units`, `${perimeter}units`],
                            formatHint: "e.g., 26 or 26 units",
                            commonMistakes: {
                                [String(length * width)]: `That's the area! Perimeter = 2 × (${length} + ${width}) = ${perimeter}`
                            }
                        }
                    ]
                },
                practice: (() => { const pl = rand(7, 15), pw = rand(4, 10); return {
                    problem: `Find the perimeter of a rectangle: length = ${pl}, width = ${pw}`, answer: String(2 * (pl + pw)),
                    options: shuffle([String(2 * (pl + pw)), String(pl * pw), String(pl + pw), String(4 * pl)]),
                    mistakeAnalysis: {
                        [String(pl * pw)]: "You found the area! Perimeter = 2 × (L + W), not L × W",
                        [String(pl + pw)]: "You only counted two sides! Multiply by 2 for all 4 sides.",
                        [String(4 * pl)]: "That would be a square! Use 2 × (L + W) for rectangles."
                    }}; })()
            };
        },
        "Arrays and Area Models": () => {
            const rows = rand(3, 5), cols = rand(4, 7);
            const product = rows * cols;
            return {
                goalProblem: `Use an array to find 4 × 6`,
                teachingSteps: [
                    {
                        title: "What is an array?",
                        explanation: "An <strong>array</strong> is a way to arrange objects in equal <strong>rows</strong> and <strong>columns</strong>. It helps us visualize multiplication!",
                        visual: "●●●●●●\n●●●●●●\n●●●●●●\n●●●●●● (4 rows, 6 columns)"
                    },
                    {
                        title: "Rows × Columns = Total",
                        explanation: "An array shows <strong>rows × columns</strong>. Our array has 4 rows of 6, so we're finding 4 × 6.",
                        visual: "4 rows × 6 in each row"
                    },
                    {
                        title: "Count the total",
                        explanation: "We can count all the dots: 6 + 6 + 6 + 6 = 24. Or multiply: 4 × 6 = <strong>24</strong>!",
                        visual: "6 + 6 + 6 + 6 = 24"
                    },
                    {
                        title: "The area model",
                        explanation: "An <strong>area model</strong> is like an array, but drawn as a rectangle. Length × Width = Area, just like rows × columns!",
                        visual: "[Rectangle: 4 tall, 6 wide] Area = 4 × 6"
                    },
                    {
                        title: "Breaking apart with area models",
                        explanation: "We can split numbers to make multiplication easier: 4 × 6 = 4 × (5 + 1) = (4 × 5) + (4 × 1) = 20 + 4 = 24",
                        visual: "4 × 5 = 20, 4 × 1 = 4, Total = 24"
                    },
                    {
                        title: "Arrays and area models show the same thing!",
                        explanation: "<strong>4 × 6 = 24</strong>. Arrays and area models both help us see WHY multiplication works!",
                        visual: "4 × 6 = 24"
                    }
                ],
                finalAnswer: "24",
                answerExplanation: "4 rows × 6 columns = 24 total. Arrays help us visualize multiplication!",
                example: { problem: `Use an array to find 4 × 6`, steps: [
                    { text: "Draw the array", math: "4 rows of 6 dots each" },
                    { text: "Count or multiply", math: "4 × 6 = 24" },
                    { text: "Or break apart", math: "4 × 6 = 4×5 + 4×1 = 20 + 4 = <strong>24</strong>" }
                ]},
                keyPoints: [
                    "Array: rows × columns = total",
                    "Area model: length × width = area",
                    "Breaking apart makes big multiplications easier"
                ],
                mistakes: [
                    { wrong: "Confusing rows and columns", why: "Rows go across (horizontal), columns go up/down (vertical). But 4×6 = 6×4!" },
                    { wrong: "Adding instead of multiplying", why: "4 rows of 6 means 4 × 6, not 4 + 6" },
                    { wrong: "Miscounting the array", why: "Multiply: rows × columns. Don't count one by one!" }
                ],
                guided: {
                    problem: `An array has ${rows} rows and ${cols} columns. How many total?`,
                    steps: [
                        { label: "Number of rows", value: `${rows}` },
                        { label: "Number of columns", value: `${cols}` },
                        { label: "Total (rows × columns)", value: "?" }
                    ],
                    answer: String(product),
                    answerLabel: "Total:",
                    interactiveSteps: [
                        {
                            prompt: `The array has ${rows} rows. Each row has ${cols} items. What operation do we use to find the total?`,
                            hint: "Equal groups means...",
                            answer: "multiplication",
                            acceptableAnswers: ["multiplication", "multiply", "times", "×"],
                            commonMistakes: {
                                "addition": "We could add ${rows} groups of ${cols}, but multiplication is faster!",
                                "division": "Division splits things up. We're combining equal groups."
                            }
                        },
                        {
                            prompt: `Calculate: ${rows} × ${cols} = ?`,
                            hint: `${rows} groups of ${cols}...`,
                            answer: String(product),
                            acceptableAnswers: [String(product)],
                            commonMistakes: {
                                [String(rows + cols)]: `You added! Multiply: ${rows} × ${cols} = ${product}`,
                                [String(rows)]: `That's just the rows. Multiply: ${rows} × ${cols} = ${product}`
                            }
                        },
                        {
                            prompt: `So an array with ${rows} rows and ${cols} columns has how many total items?`,
                            hint: "What was your multiplication result?",
                            answer: String(product),
                            acceptableAnswers: [String(product), `${product} items`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pr = rand(3, 6), pc = rand(5, 8); return {
                    problem: `An array has ${pr} rows and ${pc} columns. Find the total.`, answer: String(pr * pc),
                    options: shuffle([String(pr * pc), String(pr + pc), String(pr * pc + pr), String(pr * pc - pc)]),
                    mistakeAnalysis: {
                        [String(pr + pc)]: "You added! Arrays show multiplication: rows × columns",
                        [String(pr * pc + pr)]: "Check your multiplication - you added an extra row",
                        [String(pr * pc - pc)]: "Check your multiplication - you're missing a row"
                    }}; })()
            };
        }
    },
    3: {
        Percents: () => {
            const pct = pick([10, 20, 25, 50]);
            const base = pick([20, 40, 50, 100]);
            const ans = (pct / 100) * base;
            return {
                goalProblem: `What is 25% of 80?`,
                teachingSteps: [
                    {
                        title: "What does percent mean?",
                        explanation: "<strong>Percent</strong> means 'per hundred' or 'out of 100'. The symbol % tells us we're working with parts of 100.",
                        visual: "25% = 25 out of 100"
                    },
                    {
                        title: "Common percents to memorize",
                        explanation: "50% = half, 25% = quarter, 10% = tenth, 100% = all of it. These shortcuts make calculations faster!",
                        visual: "100%=all | 50%=half | 25%=quarter | 10%=tenth"
                    },
                    {
                        title: "Step 1: Convert percent to decimal",
                        explanation: "To calculate with percents, divide by 100 (move decimal 2 places left). 25% = 25 ÷ 100 = <strong>0.25</strong>",
                        visual: "25% → 25. → 2.5 → 0.25"
                    },
                    {
                        title: "Step 2: 'Of' means multiply",
                        explanation: "In math, 'of' means multiply. '25% of 80' becomes 0.25 × 80.",
                        visual: "25% OF 80 = 0.25 × 80"
                    },
                    {
                        title: "Step 3: Calculate the answer",
                        explanation: "0.25 × 80 = <strong>20</strong>. Quick check: 25% is a quarter, and 80 ÷ 4 = 20 ✓",
                        visual: "0.25 × 80 = 20"
                    }
                ],
                finalAnswer: "20",
                answerExplanation: "25% = 0.25, and 0.25 × 80 = 20. Since 25% is a quarter, we're finding a quarter of 80!",
                example: { problem: `What is 25% of 80?`, steps: [
                    { text: "Convert percent to decimal", math: "25% = 25 ÷ 100 = 0.25" },
                    { text: "Set up the multiplication", math: "25% of 80 means 0.25 × 80" },
                    { text: "Multiply step by step", math: "0.25 × 80 = 25 × 80 ÷ 100 = 2000 ÷ 100 = <strong>20</strong>" },
                    { text: "Check: Is 20 about 1/4 of 80?", math: "Yes! 80 ÷ 4 = 20 ✓" }
                ]},
                keyPoints: [
                    "Percent to decimal: move decimal point 2 places LEFT (25% → 0.25)",
                    "50% = ×0.5 = ÷2 (half), 25% = ×0.25 = ÷4 (quarter), 10% = ×0.1 = ÷10",
                    "To find 10% of any number, just move the decimal one place left: 10% of 80 = 8"
                ],
                mistakes: [
                    { wrong: "25% of 80 = 25 + 80 = 105", why: "'Of' in math means MULTIPLY, not add. 25% OF 80 = 0.25 × 80" },
                    { wrong: "25% = 2.5 or 0.025", why: "Move decimal 2 places LEFT: 25.0% → 0.25 (not 1 or 3 places)" },
                    { wrong: "Thinking 25% of 80 should be bigger than 80", why: "A percent less than 100% gives you a SMALLER answer" }
                ],
                guided: {
                    problem: `What is ${pct}% of ${base}?`,
                    steps: [
                        { label: `Convert ${pct}% to decimal`, value: `${pct}% = ${pct} ÷ 100 = ${pct/100}` },
                        { label: `Multiply by ${base}`, value: `${pct/100} × ${base} = ?` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(ans),
                    answerLabel: `${pct}% of ${base} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "To use a percent in calculations, we first convert it to a decimal. How do we convert a percent to a decimal?",
                            hint: "Move the decimal point or divide by...",
                            answer: "divide by 100",
                            acceptableAnswers: ["divide by 100", "÷ 100", "move decimal 2 places left", "move decimal left 2"],
                            commonMistakes: {
                                "divide by 10": "Divide by 100, not 10 (percent means 'per hundred')",
                                "multiply by 100": "That's decimal → percent. For percent → decimal, DIVIDE by 100."
                            }
                        },
                        {
                            prompt: `Convert ${pct}% to a decimal: ${pct} ÷ 100 = ?`,
                            hint: `Move the decimal point 2 places left: ${pct}.0 → ?`,
                            answer: String(pct / 100),
                            acceptableAnswers: [String(pct / 100)],
                            commonMistakes: {
                                [String(pct)]: `Don't forget to divide! ${pct} ÷ 100 = ${pct / 100}`,
                                [String(pct * 100)]: `You multiplied instead of divided. ${pct} ÷ 100 = ${pct / 100}`
                            }
                        },
                        {
                            prompt: `Now multiply: ${pct / 100} × ${base} = ?`,
                            hint: `${pct}% of ${base} means ${pct / 100} × ${base}`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(pct + base)]: `You added instead of multiplied! ${pct / 100} × ${base} = ${ans}`,
                                [String(pct / 100 + base)]: `Add the decimal? No - MULTIPLY it: ${pct / 100} × ${base} = ${ans}`
                            }
                        }
                    ]
                },
                practice: (() => { const newBase = base * 2; const newAns = (pct / 100) * newBase; return {
                    problem: `What is ${pct}% of ${newBase}?`, answer: String(newAns),
                    options: shuffle([String(newAns), String(ans), String(pct + newBase), String(newAns * 2)]),
                    mistakeAnalysis: {
                        [String(ans)]: `You used ${base} instead of ${newBase}. With ${newBase}, the answer is ${pct/100} × ${newBase} = ${newAns}`,
                        [String(pct + newBase)]: `You added instead of multiplied. '${pct}% OF ${newBase}' means ${pct/100} × ${newBase}`,
                        [String(newAns * 2)]: `Check your calculation: ${pct}% = ${pct/100}, and ${pct/100} × ${newBase} = ${newAns}`
                    }}; })()
            };
        },
        Integers: () => {
            const a = rand(3, 10), b = rand(a + 2, 15);
            return {
                goalProblem: `What is -5 + 8?`,
                teachingSteps: [
                    {
                        title: "What are integers?",
                        explanation: "<strong>Integers</strong> are whole numbers including positive numbers, negative numbers, and zero. No fractions or decimals!",
                        visual: "...-3, -2, -1, 0, 1, 2, 3..."
                    },
                    {
                        title: "The number line",
                        explanation: "Imagine a number line: zero is in the middle, positive numbers go right, negative numbers go left.",
                        visual: "← -5 -4 -3 -2 -1 [0] 1 2 3 4 5 →"
                    },
                    {
                        title: "Adding integers: the direction rule",
                        explanation: "Adding a <strong>positive</strong> = move <strong>right</strong>. Adding a <strong>negative</strong> = move <strong>left</strong>.",
                        visual: "Add positive → go RIGHT | Add negative → go LEFT"
                    },
                    {
                        title: "Let's solve -5 + 8",
                        explanation: "Start at -5 on the number line. We're adding +8 (positive), so move <strong>RIGHT</strong> 8 spaces.",
                        visual: "-5 → -4 → -3 → -2 → -1 → 0 → 1 → 2 → 3"
                    },
                    {
                        title: "We landed on 3!",
                        explanation: "<strong>-5 + 8 = 3</strong>. Shortcut: different signs means subtract (8-5=3), then keep the sign of the bigger number (8 is bigger and positive).",
                        visual: "-5 + 8 = 3"
                    }
                ],
                finalAnswer: "3",
                answerExplanation: "Starting at -5 and moving right 8 spaces lands us at 3. Or use the shortcut: 8-5=3, positive wins!",
                example: { problem: `What is -5 + 8?`, steps: [
                    { text: "Start at -5 on the number line", math: "Put your finger on -5" },
                    { text: "We're adding +8, so move RIGHT 8 spaces", math: "-5 → -4 → -3 → -2 → -1 → 0 → 1 → 2 → 3" },
                    { text: "We landed on 3!", math: "-5 + 8 = <strong>3</strong>" },
                    { text: "Check using the shortcut", math: "8 - 5 = 3, positive wins (8 > 5) ✓" }
                ]},
                keyPoints: [
                    "Number line: LEFT = smaller, RIGHT = bigger",
                    "Different signs: subtract the numbers, keep the sign of the larger absolute value",
                    "Same signs: add the numbers, keep the same sign (-3 + -5 = -8)"
                ],
                mistakes: [
                    { wrong: "-5 + 8 = -13 (adding both numbers)", why: "Different signs means SUBTRACT! 8 - 5 = 3, and +8 is stronger, so answer is +3" },
                    { wrong: "-5 + 8 = -3 (wrong sign)", why: "8 is bigger than 5, and 8 is positive, so the answer is positive 3" },
                    { wrong: "Moving left when adding a positive", why: "Adding POSITIVE always moves RIGHT. Adding NEGATIVE moves left." }
                ],
                guided: {
                    problem: `What is -${a} + ${b}?`,
                    steps: [
                        { label: "Start at", value: `-${a}` },
                        { label: `Move RIGHT ${b} spaces`, value: `-${a} → ${b - a > 0 ? '... → 0 → ... →' : '...'} ${b - a}` },
                        { label: `Or use the shortcut: ${b} - ${a} =`, value: `${b - a}, positive wins` },
                        { label: "Answer", value: "?" }
                    ],
                    answer: String(b - a),
                    answerLabel: `-${a} + ${b} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `We have -${a} + ${b}. Do the numbers have the SAME sign or DIFFERENT signs?`,
                            hint: `-${a} is negative, ${b} is positive...`,
                            answer: "different",
                            acceptableAnswers: ["different", "different signs", "opposite"],
                            commonMistakes: {
                                "same": `-${a} is NEGATIVE and ${b} is POSITIVE - that's different signs!`
                            }
                        },
                        {
                            prompt: "When adding numbers with DIFFERENT signs, do we add or subtract their absolute values?",
                            hint: "Different signs means we find the difference...",
                            answer: "subtract",
                            acceptableAnswers: ["subtract", "subtraction"],
                            commonMistakes: {
                                "add": "Add for SAME signs. For DIFFERENT signs, we SUBTRACT!"
                            }
                        },
                        {
                            prompt: `Subtract the absolute values: ${b} - ${a} = ?`,
                            hint: `Ignore the signs and subtract: ${b} - ${a}`,
                            answer: String(b - a),
                            acceptableAnswers: [String(b - a)],
                            commonMistakes: {
                                [String(a + b)]: `You added! With different signs, SUBTRACT: ${b} - ${a} = ${b - a}`,
                                [String(a - b)]: `Subtract the smaller from the larger: ${b} - ${a} = ${b - a}`
                            }
                        },
                        {
                            prompt: `Which number has the larger absolute value: ${a} or ${b}? That determines the sign of our answer.`,
                            hint: `|${b}| = ${b}, |-${a}| = ${a}. Which is bigger?`,
                            answer: String(b),
                            acceptableAnswers: [String(b), "positive"],
                            commonMistakes: {
                                [String(a)]: `${b} > ${a}, so ${b} has the larger absolute value. Answer takes the positive sign!`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = a + 2; return {
                    problem: `What is -${pa} + ${b}?`, answer: String(b - pa),
                    options: shuffle([String(b - pa), String(-(pa + b)), String(pa + b), String(-(b - pa))]),
                    mistakeAnalysis: {
                        [String(-(pa + b))]: `You added both numbers. With different signs, SUBTRACT: ${b} - ${pa} = ${b - pa}`,
                        [String(pa + b)]: `Same mistake - subtract don't add. Also, since ${b > pa ? 'positive is bigger' : 'negative is bigger'}, answer is ${b - pa}`,
                        [String(-(b - pa))]: `Right calculation, wrong sign! ${b} > ${pa}, so positive wins. Answer is +${b - pa}`
                    }}; })()
            };
        },
        "Mean Median Mode": () => {
            const data = [rand(2, 5), rand(3, 6), rand(4, 8), rand(5, 9), rand(3, 6)];
            const sorted = [...data].sort((a, b) => a - b);
            const median = sorted[2];
            const sum = data.reduce((a, b) => a + b, 0);
            const mean = sum / data.length;
            return {
                goalProblem: `Find the mean, median, and mode of: 3, 7, 5, 9, 1`,
                teachingSteps: [
                    {
                        title: "Three types of 'average'",
                        explanation: "Mean, median, and mode are all ways to describe the 'center' or typical value of a data set. They each tell us something different!",
                        visual: "Mean = math average | Median = middle | Mode = most common"
                    },
                    {
                        title: "MEAN: Add all, then divide",
                        explanation: "The <strong>mean</strong> is what most people call 'the average'. Add all numbers, then divide by how many there are.",
                        visual: "Mean = (sum of all) ÷ (count)"
                    },
                    {
                        title: "Let's find the mean",
                        explanation: "Add: 3 + 7 + 5 + 9 + 1 = 25. There are 5 numbers, so divide: 25 ÷ 5 = <strong>5</strong>. The mean is 5!",
                        visual: "25 ÷ 5 = 5 (Mean)"
                    },
                    {
                        title: "MEDIAN: Sort first, then find middle",
                        explanation: "The <strong>median</strong> is the middle number when sorted. ALWAYS sort first! 3,7,5,9,1 becomes 1,3,5,7,9",
                        visual: "1, 3, [5], 7, 9 → Median = 5"
                    },
                    {
                        title: "MODE: Most frequent number",
                        explanation: "The <strong>mode</strong> is the number that appears most often. Here, each number appears once, so there's <strong>no mode</strong>.",
                        visual: "No repeats → No mode"
                    }
                ],
                finalAnswer: "Mean = 5, Median = 5, No mode",
                answerExplanation: "Mean: 25÷5=5. Median: middle of 1,3,5,7,9 is 5. Mode: no repeats, so no mode!",
                example: { problem: `Find the mean, median, and mode of: 3, 7, 5, 9, 1`, steps: [
                    { text: "MEAN: Add all numbers", math: "3 + 7 + 5 + 9 + 1 = 25" },
                    { text: "Divide by count (5 numbers)", math: "25 ÷ 5 = <strong>Mean = 5</strong>" },
                    { text: "MEDIAN: First, put in order", math: "1, 3, 5, 7, 9" },
                    { text: "Find the middle number", math: "1, 3, <strong>5</strong>, 7, 9 → <strong>Median = 5</strong>" },
                    { text: "MODE: Which number appears most?", math: "Each number appears once → <strong>No mode</strong>" }
                ]},
                keyPoints: [
                    "Mean = Sum ÷ Count (the 'average')",
                    "Median = SORT first, then find middle (with even count, average the two middle numbers)",
                    "Mode = Most frequent (can have no mode, one mode, or multiple modes)"
                ],
                mistakes: [
                    { wrong: "Finding median without sorting", why: "ALWAYS put in order first! 3, 7, 5, 9, 1 → 1, 3, 5, 7, 9" },
                    { wrong: "Dividing by wrong number for mean", why: "Count ALL numbers. 5 numbers means divide by 5." },
                    { wrong: "Confusing mean and median", why: "Mean = math (add & divide). Median = just find middle." }
                ],
                guided: {
                    problem: `Find the median of: ${data.join(', ')}`,
                    steps: [
                        { label: "First, sort the numbers", value: `${sorted.join(', ')}` },
                        { label: "Count: 5 numbers, so middle is the 3rd", value: `${sorted[0]}, ${sorted[1]}, ?, ${sorted[3]}, ${sorted[4]}` },
                        { label: "Median", value: "?" }
                    ],
                    answer: String(median),
                    answerLabel: "Median = ?",
                    interactiveSteps: [
                        {
                            prompt: "To find the median, what must we do FIRST?",
                            hint: "The numbers might not be in order yet...",
                            answer: "sort",
                            acceptableAnswers: ["sort", "put in order", "order them", "arrange", "sort them"],
                            commonMistakes: {
                                "add": "Adding is for MEAN. For MEDIAN, we first SORT the numbers!",
                                "find middle": "Finding the middle comes AFTER sorting. First, put them in order."
                            }
                        },
                        {
                            prompt: `Sort these numbers from smallest to largest: ${data.join(', ')}`,
                            hint: "Start with the smallest number...",
                            answer: sorted.join(', '),
                            acceptableAnswers: [sorted.join(', '), sorted.join(','), sorted.join(' ')],
                            commonMistakes: {
                                [data.join(', ')]: "Those aren't sorted! Put them in order from smallest to largest."
                            }
                        },
                        {
                            prompt: `Sorted: ${sorted.join(', ')}. We have 5 numbers. Which position is the middle?`,
                            hint: "With 5 items, the middle is position 1, 2, 3, 4, or 5?",
                            answer: "3",
                            acceptableAnswers: ["3", "3rd", "third", "position 3"],
                            commonMistakes: {
                                "2": "With 5 numbers, there are 2 numbers on each side of the middle. Position 3 is the middle!",
                                "5": "5 is the last position. The MIDDLE of 5 items is position 3."
                            }
                        },
                        {
                            prompt: `The 3rd number in ${sorted.join(', ')} is the median. What is it?`,
                            hint: "Count: 1st, 2nd, 3rd...",
                            answer: String(median),
                            acceptableAnswers: [String(median)],
                            commonMistakes: {
                                [String(sorted[0])]: `That's the 1st number. The median is the 3rd: ${median}`,
                                [String(sorted[1])]: `That's the 2nd number. The median is the 3rd: ${median}`,
                                [String(sorted[3])]: `That's the 4th number. The median is the 3rd: ${median}`
                            }
                        }
                    ]
                },
                practice: (() => { const pdata = [4, 8, 2, 6, 10]; const psorted = [2, 4, 6, 8, 10]; return {
                    problem: `Find the median: ${pdata.join(', ')}`, answer: "6",
                    options: ["4", "6", "8", "10"],
                    mistakeAnalysis: {
                        "4": `Sort first: ${psorted.join(', ')}. The MIDDLE (3rd) number is 6, not the 2nd.`,
                        "8": `Close! But with 5 numbers, the middle is the 3rd. Sorted: ${psorted.join(', ')}. Middle = 6`,
                        "10": "That's the last number when sorted. Middle of 2, 4, 6, 8, 10 is 6."
                    }}; })()
            };
        },
        "Unit Conversion": () => {
            const feet = rand(2, 5);
            const inches = feet * 12;
            return {
                concept: `<strong>Unit Conversion</strong> means changing measurements from one unit to another.<br><br>
                <strong>Key conversions to memorize:</strong><br>
                • <strong>Length:</strong> 1 foot = 12 inches, 1 yard = 3 feet, 1 mile = 5,280 feet<br>
                • <strong>Weight:</strong> 1 pound = 16 ounces, 1 ton = 2,000 pounds<br>
                • <strong>Volume:</strong> 1 gallon = 4 quarts, 1 quart = 2 pints, 1 pint = 2 cups<br><br>
                <strong>The Rule:</strong><br>
                • Bigger → Smaller units: <strong>MULTIPLY</strong> (more of the smaller unit)<br>
                • Smaller → Bigger units: <strong>DIVIDE</strong> (fewer of the bigger unit)`,
                example: { problem: `Convert 3 feet to inches`, steps: [
                    { text: "Find the conversion", math: "1 foot = 12 inches" },
                    { text: "Are we going bigger → smaller or smaller → bigger?", math: "Feet → inches = Bigger → Smaller = MULTIPLY" },
                    { text: "Multiply: 3 feet × 12 inches/foot", math: "3 × 12 = 36" },
                    { text: "Add the unit", math: "3 feet = <strong>36 inches</strong>" }
                ]},
                keyPoints: [
                    "Bigger → Smaller = MULTIPLY (feet to inches: more inches)",
                    "Smaller → Bigger = DIVIDE (inches to feet: fewer feet)",
                    "Always check: Does your answer make sense? More inches than feet!"
                ],
                mistakes: [
                    { wrong: "3 feet = 3 + 12 = 15 inches", why: "You MULTIPLY, not add! 3 × 12 = 36" },
                    { wrong: "Dividing when going to smaller units", why: "Smaller units = MORE of them. 3 feet is MANY inches, so multiply." },
                    { wrong: "Forgetting the conversion factor", why: "Memorize key ones: 12 in/ft, 16 oz/lb, 4 qt/gal" }
                ],
                guided: {
                    problem: `Convert ${feet} feet to inches`,
                    steps: [
                        { label: "Conversion factor", value: "1 foot = 12 inches" },
                        { label: "Going bigger → smaller, so", value: "MULTIPLY" },
                        { label: `${feet} feet × 12 =`, value: "?" }
                    ],
                    answer: String(inches),
                    answerLabel: "Inches:",
                    interactiveSteps: [
                        {
                            prompt: "How many inches are in 1 foot?",
                            hint: "Think of a ruler...",
                            answer: "12",
                            acceptableAnswers: ["12", "twelve", "12 inches"],
                            commonMistakes: {
                                "10": "It's 12 inches in a foot, not 10.",
                                "3": "That's feet in a yard. Inches in a foot = 12."
                            }
                        },
                        {
                            prompt: "We're converting from feet (bigger) to inches (smaller). Do we multiply or divide?",
                            hint: "Going to smaller units means we'll have MORE of them...",
                            answer: "multiply",
                            acceptableAnswers: ["multiply", "multiplication", "×", "times"],
                            commonMistakes: {
                                "divide": "Divide for bigger → smaller? No! Smaller units = more of them, so MULTIPLY.",
                                "add": "We need to multiply by the conversion factor, not add."
                            }
                        },
                        {
                            prompt: `Calculate: ${feet} feet × 12 inches/foot = ?`,
                            hint: `${feet} × 12 = ?`,
                            answer: String(inches),
                            acceptableAnswers: [String(inches), `${inches} inches`],
                            commonMistakes: {
                                [String(feet + 12)]: `You added! Multiply: ${feet} × 12 = ${inches}`,
                                [String(feet)]: `Don't forget to convert! ${feet} × 12 = ${inches}`
                            }
                        }
                    ]
                },
                practice: (() => { const lbs = 3; const oz = lbs * 16; return {
                    problem: `How many ounces are in ${lbs} pounds?`, answer: String(oz),
                    options: [String(lbs + 16), String(lbs * 8), String(oz), String(oz + 16)],
                    mistakeAnalysis: {
                        [String(lbs + 16)]: `You added instead of multiplied! ${lbs} × 16 = ${oz}`,
                        [String(lbs * 8)]: `Wrong conversion: 1 pound = 16 ounces (not 8). ${lbs} × 16 = ${oz}`,
                        [String(oz + 16)]: `Close, but check your multiplication: ${lbs} × 16 = ${oz}`
                    }}; })()
            };
        },
        "Basic Graphing": () => {
            const x = rand(1, 5), y = rand(1, 5);
            return {
                concept: `<strong>Coordinate Graphing</strong> uses ordered pairs (x, y) to locate points on a grid.<br><br>
                <strong>The coordinate plane:</strong><br>
                • <strong>x-axis:</strong> horizontal line (left-right) →<br>
                • <strong>y-axis:</strong> vertical line (up-down) ↑<br>
                • <strong>Origin:</strong> (0, 0) - where the axes cross<br><br>
                <strong>Reading coordinates (x, y):</strong><br>
                • <strong>x comes first:</strong> how far LEFT or RIGHT<br>
                • <strong>y comes second:</strong> how far UP or DOWN<br><br>
                <strong>The Four Quadrants:</strong><br>
                • Quadrant I: (+, +) upper right<br>
                • Quadrant II: (-, +) upper left<br>
                • Quadrant III: (-, -) lower left<br>
                • Quadrant IV: (+, -) lower right`,
                example: { problem: `Plot the point (3, 2) and identify its quadrant`, steps: [
                    { text: "Start at the origin (0, 0)", math: "This is where the x and y axes cross" },
                    { text: "x = 3: Move RIGHT 3 units", math: "→ → → (now at x = 3)" },
                    { text: "y = 2: Move UP 2 units", math: "↑ ↑ (now at y = 2)" },
                    { text: "Mark the point (3, 2)", math: "Both coordinates are positive → <strong>Quadrant I</strong>" }
                ]},
                keyPoints: [
                    "Remember: (x, y) - 'x' comes before 'y' in the alphabet!",
                    "x = horizontal (like the horizon), y = vertical",
                    "Positive x = right, Negative x = left, Positive y = up, Negative y = down"
                ],
                mistakes: [
                    { wrong: "Plotting (3, 2) by going up 3, right 2", why: "x comes FIRST! Go right 3, THEN up 2." },
                    { wrong: "Confusing (2, 5) and (5, 2)", why: "These are different points! (2, 5) is right 2, up 5. (5, 2) is right 5, up 2." },
                    { wrong: "Saying (-3, 4) is in Quadrant IV", why: "x is negative (left), y is positive (up) = Quadrant II" }
                ],
                guided: {
                    problem: `What are the coordinates of a point that is ${x} units right and ${y} units up from the origin?`,
                    steps: [
                        { label: "Right means positive x", value: `x = ${x}` },
                        { label: "Up means positive y", value: `y = ${y}` },
                        { label: "Write as (x, y)", value: "?" }
                    ],
                    answer: `(${x}, ${y})`,
                    answerLabel: "Coordinates:",
                    interactiveSteps: [
                        {
                            prompt: "In coordinates (x, y), which direction does x represent?",
                            hint: "x is horizontal, like the horizon...",
                            answer: "horizontal",
                            acceptableAnswers: ["horizontal", "left-right", "left right", "right-left"],
                            commonMistakes: {
                                "vertical": "x is HORIZONTAL (left-right). y is vertical (up-down).",
                                "up-down": "That's y! x is horizontal (left-right)."
                            }
                        },
                        {
                            prompt: `Moving ${x} units RIGHT means x is positive or negative?`,
                            hint: "Right is the positive direction on a number line...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "+", "plus"],
                            commonMistakes: {
                                "negative": "RIGHT is positive. LEFT would be negative."
                            }
                        },
                        {
                            prompt: `Moving ${y} units UP means y is positive or negative?`,
                            hint: "Up is like going higher on a number line...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "+", "plus"],
                            commonMistakes: {
                                "negative": "UP is positive. DOWN would be negative."
                            }
                        },
                        {
                            prompt: `So x = ${x} and y = ${y}. Write the coordinates in (x, y) format:`,
                            hint: "Put x first, then y, in parentheses...",
                            answer: `(${x}, ${y})`,
                            acceptableAnswers: [`(${x}, ${y})`, `(${x},${y})`, `${x}, ${y}`],
                            commonMistakes: {
                                [`(${y}, ${x})`]: "x comes FIRST! It's (x, y), not (y, x)."
                            }
                        }
                    ]
                },
                practice: { problem: `The point (-4, 3) is in which quadrant?`, answer: "II",
                    options: ["I", "II", "III", "IV"],
                    mistakeAnalysis: {
                        "I": "x is negative (-4), so we're on the LEFT side, not right. Left + up = Quadrant II",
                        "III": "y is positive (3), so we're UP, not down. Left + up = Quadrant II",
                        "IV": "Both conditions wrong: x is negative (left) and y is positive (up) = Quadrant II"
                    }}
            };
        },
        "Data Collection": () => ({
            concept: `<strong>Data Collection</strong> means gathering and organizing information.<br><br>
            <strong>Ways to collect data:</strong><br>
            • <strong>Surveys:</strong> Ask people questions<br>
            • <strong>Observations:</strong> Watch and record what happens<br>
            • <strong>Experiments:</strong> Test something and record results<br><br>
            <strong>Ways to organize data:</strong><br>
            • <strong>Tally marks:</strong> |||| = 4, <s>||||</s> = 5 (cross every 5)<br>
            • <strong>Frequency tables:</strong> List items and count them<br>
            • <strong>Bar graphs:</strong> Show amounts with bars<br>
            • <strong>Pictographs:</strong> Use pictures to represent data`,
            example: { problem: `A tally chart shows: Pizza ||||  |||, Burgers ||||  ||, Tacos ||||. What's the total surveyed?`, steps: [
                { text: "Count Pizza", math: "|||| ||| = 5 + 3 = 8" },
                { text: "Count Burgers", math: "|||| || = 5 + 2 = 7" },
                { text: "Count Tacos", math: "|||| = 5" },
                { text: "Add all categories", math: "8 + 7 + 5 = <strong>20 people surveyed</strong>" }
            ]},
            keyPoints: [
                "Tally groups of 5: ||||  means the 5th mark crosses through the first 4",
                "Total = add up ALL categories",
                "Labels are important - what does each tally represent?"
            ],
            mistakes: [
                { wrong: "Counting |||| as 4 instead of 5", why: "When you see 4 marks with a line through, that's 5!" },
                { wrong: "Forgetting to add all categories", why: "Make sure to count EVERY category in the data set" },
                { wrong: "Miscounting the extra marks after 5s", why: "Count groups of 5 first, then add remaining marks: ||||  ||| = 5 + 3 = 8" }
            ],
            guided: {
                problem: `Tally: Red |||| ||||, Blue |||| |||, Green ||||. How many total?`,
                steps: [
                    { label: "Red: |||| |||| =", value: "5 + 5 = 10" },
                    { label: "Blue: |||| ||| =", value: "5 + 3 = 8" },
                    { label: "Green: |||| =", value: "5" },
                    { label: "Total", value: "?" }
                ],
                answer: "23",
                answerLabel: "Total:",
                interactiveSteps: [
                    {
                        prompt: "In tally marks, what does |||| (4 marks with a line through) represent?",
                        hint: "The fifth mark crosses through the first four...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "4": "When a line crosses through 4 marks, it makes 5! |||| = 5"
                        }
                    },
                    {
                        prompt: "Count Red: |||| |||| (two groups of crossed tallies). How many?",
                        hint: "Each |||| = 5, so two groups is...",
                        answer: "10",
                        acceptableAnswers: ["10", "ten"],
                        commonMistakes: {
                            "8": "Each |||| = 5, not 4. So |||| |||| = 5 + 5 = 10",
                            "5": "There are TWO groups of 5: 5 + 5 = 10"
                        }
                    },
                    {
                        prompt: "Count Blue: |||| ||| (one crossed group plus 3 marks). How many?",
                        hint: "|||| = 5, plus ||| = 3 more...",
                        answer: "8",
                        acceptableAnswers: ["8", "eight"],
                        commonMistakes: {
                            "7": "|||| = 5 (not 4), plus 3 = 8",
                            "53": "Add them: 5 + 3 = 8"
                        }
                    },
                    {
                        prompt: "Count Green: |||| (one crossed group). How many?",
                        hint: "One group of crossed tallies...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "4": "|||| (with cross) = 5, not 4!"
                        }
                    },
                    {
                        prompt: "Now add all colors: Red (10) + Blue (8) + Green (5) = ?",
                        hint: "10 + 8 + 5 = ?",
                        answer: "23",
                        acceptableAnswers: ["23", "twenty-three"],
                        commonMistakes: {
                            "18": "Don't forget all three! 10 + 8 + 5 = 23",
                            "13": "You missed one color. 10 + 8 + 5 = 23"
                        }
                    }
                ]
            },
            practice: { problem: `Survey: 5 like pizza, 8 like burgers, 3 like tacos, 4 like salad. Total surveyed?`, answer: "20",
                options: ["16", "18", "20", "22"],
                mistakeAnalysis: {
                    "16": "You missed one category! Add ALL: 5 + 8 + 3 + 4 = 20",
                    "18": "Check your addition: 5 + 8 = 13, 13 + 3 = 16, 16 + 4 = 20",
                    "22": "Double-check: 5 + 8 + 3 + 4 = 20, not 22"
                }}
        }),
        Fractions: () => {
            const num = rand(1, 5), denom = rand(num + 1, 8);
            return {
                concept: `<strong>Fractions</strong> represent parts of a whole or a division problem.<br><br>
                <strong>Parts of a fraction:</strong><br>
                • <strong>Numerator</strong> (top): How many parts you HAVE<br>
                • <strong>Denominator</strong> (bottom): How many EQUAL parts in the whole<br><br>
                <strong>Comparing fractions with same denominator:</strong><br>
                Bigger numerator = bigger fraction (3/5 > 2/5)<br><br>
                <strong>Comparing fractions with same numerator:</strong><br>
                Smaller denominator = bigger fraction (1/2 > 1/4)`,
                example: { problem: `Which is larger: 3/8 or 5/8?`, steps: [
                    { text: "Check if denominators are the same", math: "Both are eighths (8) ✓" },
                    { text: "With same denominators, compare numerators", math: "5 > 3" },
                    { text: "Larger numerator = larger fraction", math: "<strong>5/8 > 3/8</strong>" },
                    { text: "Think of it as pizza", math: "5 slices of pizza is more than 3 slices!" }
                ]},
                keyPoints: [
                    "Same denominator? Compare numerators - bigger numerator wins",
                    "Same numerator? Compare denominators - SMALLER denominator wins (1/2 > 1/4)",
                    "Visualize: more pieces of same-sized pizza = more pizza"
                ],
                mistakes: [
                    { wrong: "Thinking 1/4 > 1/2 because 4 > 2", why: "The denominator tells size of pieces. 4 pieces means smaller pieces than 2 pieces!" },
                    { wrong: "Adding numerators and denominators: 1/2 + 1/3 = 2/5", why: "You can only add fractions with the same denominator" },
                    { wrong: "Confusing numerator and denominator", why: "Top = how many you have. Bottom = size of pieces." }
                ],
                guided: {
                    problem: `Compare ${num}/${denom} and ${num + 1}/${denom}. Which is larger?`,
                    steps: [
                        { label: "Same denominator?", value: `Yes, both are ${denom}ths` },
                        { label: "Compare numerators", value: `${num + 1} > ${num}` },
                        { label: "Larger fraction is", value: "?" }
                    ],
                    answer: `${num + 1}/${denom}`,
                    answerLabel: "Larger fraction:",
                    interactiveSteps: [
                        {
                            prompt: `Look at ${num}/${denom} and ${num + 1}/${denom}. Are the denominators (bottom numbers) the same?`,
                            hint: "Compare the bottom numbers of both fractions...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "yeah", "yep", "same"],
                            commonMistakes: {
                                "no": `Both denominators are ${denom}. They're the same!`
                            }
                        },
                        {
                            prompt: "When denominators are the same, how do we compare fractions?",
                            hint: "If pieces are the same size, just count how many pieces...",
                            answer: "compare numerators",
                            acceptableAnswers: ["compare numerators", "look at numerators", "bigger numerator", "numerators"],
                            commonMistakes: {
                                "compare denominators": "Denominators are already the same! Compare the numerators (top numbers)."
                            }
                        },
                        {
                            prompt: `Which numerator is larger: ${num} or ${num + 1}?`,
                            hint: `${num + 1} is one more than ${num}...`,
                            answer: String(num + 1),
                            acceptableAnswers: [String(num + 1)],
                            commonMistakes: {
                                [String(num)]: `${num + 1} > ${num}. ${num + 1} is larger!`
                            }
                        },
                        {
                            prompt: `So which fraction is larger: ${num}/${denom} or ${num + 1}/${denom}?`,
                            hint: "Bigger numerator = bigger fraction (when denominators match)",
                            answer: `${num + 1}/${denom}`,
                            acceptableAnswers: [`${num + 1}/${denom}`, `${num+1}/${denom}`],
                            commonMistakes: {
                                [`${num}/${denom}`]: `${num + 1} > ${num}, so ${num + 1}/${denom} is larger!`
                            }
                        }
                    ]
                },
                practice: { problem: `Which is larger: 2/5 or 2/3?`, answer: "2/3",
                    options: ["2/5", "2/3", "They're equal"],
                    mistakeAnalysis: {
                        "2/5": "Same numerator (2), so compare denominators. Smaller denominator = bigger pieces. 2/3 has bigger pieces!",
                        "They're equal": "With same numerator, the smaller denominator means bigger pieces. 2/3 > 2/5"
                    }}
            };
        },
        Decimals: () => {
            const whole = rand(1, 5);
            const tenths = rand(1, 9);
            const hundredths = rand(1, 9);
            return {
                concept: `<strong>Decimals</strong> are another way to write fractions with denominators of 10, 100, 1000, etc.<br><br>
                <strong>Place values after the decimal point:</strong><br>
                • <strong>Tenths</strong> (0.1) = 1/10 - first place after decimal<br>
                • <strong>Hundredths</strong> (0.01) = 1/100 - second place after decimal<br>
                • <strong>Thousandths</strong> (0.001) = 1/1000 - third place after decimal<br><br>
                <strong>Reading decimals:</strong><br>
                3.75 = "three and seventy-five hundredths"`,
                example: { problem: `Convert 3/4 to a decimal`, steps: [
                    { text: "Fractions are division problems", math: "3/4 means 3 ÷ 4" },
                    { text: "Divide 3 by 4", math: "3 ÷ 4 = 0.75" },
                    { text: "Check: 0.75 = 75/100 = 3/4 ✓", math: "<strong>3/4 = 0.75</strong>" }
                ]},
                keyPoints: [
                    "Decimal point separates whole numbers from parts",
                    "Each place to the right is 10× smaller (tenths, hundredths, thousandths)",
                    "Common decimals: 1/2 = 0.5, 1/4 = 0.25, 3/4 = 0.75, 1/5 = 0.2"
                ],
                mistakes: [
                    { wrong: "0.5 > 0.25 but thinking 0.5 < 0.25 because 5 < 25", why: "Compare place by place: 0.5 = 0.50, and 50 hundredths > 25 hundredths" },
                    { wrong: "Writing 'three tenths' as 0.03", why: "Tenths is the FIRST place: 0.3 (not 0.03, which is hundredths)" },
                    { wrong: "0.1 + 0.2 = 0.3 but writing 0.12", why: "Line up decimal points and add like regular numbers: 0.1 + 0.2 = 0.3" }
                ],
                guided: {
                    problem: `Write 0.${tenths}${hundredths} as a fraction`,
                    steps: [
                        { label: "Count decimal places", value: "2 places = hundredths" },
                        { label: "Write over 100", value: `${tenths}${hundredths}/100` },
                        { label: "Simplify if possible", value: "?" }
                    ],
                    answer: `${tenths}${hundredths}/100`,
                    answerLabel: "Fraction:",
                    interactiveSteps: [
                        {
                            prompt: `In 0.${tenths}${hundredths}, how many digits are after the decimal point?`,
                            hint: "Count the digits to the right of the decimal...",
                            answer: "2",
                            acceptableAnswers: ["2", "two"],
                            commonMistakes: {
                                "1": `There are 2 digits: ${tenths} and ${hundredths}`,
                                "3": "Only count digits AFTER the decimal, not the 0 before it."
                            }
                        },
                        {
                            prompt: "2 decimal places means the denominator is 10, 100, or 1000?",
                            hint: "1 place = tenths (10), 2 places = hundredths (?), 3 places = thousandths (1000)",
                            answer: "100",
                            acceptableAnswers: ["100", "hundredths"],
                            commonMistakes: {
                                "10": "That's for 1 decimal place. 2 places = 100",
                                "1000": "That's for 3 decimal places. 2 places = 100"
                            }
                        },
                        {
                            prompt: `The digits after the decimal are ${tenths}${hundredths}. What is the numerator of our fraction?`,
                            hint: "Just read the digits as a number...",
                            answer: `${tenths}${hundredths}`,
                            acceptableAnswers: [`${tenths}${hundredths}`, String(parseInt(`${tenths}${hundredths}`))],
                            commonMistakes: {
                                [String(tenths)]: `Include both digits: ${tenths}${hundredths}`,
                                [String(hundredths)]: `Include both digits: ${tenths}${hundredths}`
                            }
                        },
                        {
                            prompt: `So 0.${tenths}${hundredths} = ?/100`,
                            hint: `Numerator is ${tenths}${hundredths}, denominator is 100`,
                            answer: `${tenths}${hundredths}/100`,
                            acceptableAnswers: [`${tenths}${hundredths}/100`, `${tenths}${hundredths} / 100`],
                            commonMistakes: {
                                [`${tenths}${hundredths}/10`]: "2 decimal places means /100, not /10"
                            }
                        }
                    ]
                },
                practice: { problem: `Which is greater: 0.4 or 0.38?`, answer: "0.4",
                    options: ["0.4", "0.38", "They're equal"],
                    mistakeAnalysis: {
                        "0.38": "Compare place by place: 0.4 = 0.40. Tenths: 4 = 4 ✓. Hundredths: 0 < 8... wait, 40 > 38!",
                        "They're equal": "0.4 = 0.40. Compare to 0.38: 40 hundredths > 38 hundredths"
                    }}
            };
        },
        Ratios: () => {
            const a = rand(2, 5), b = rand(3, 6);
            return {
                concept: `<strong>Ratios</strong> compare two quantities. They can be written three ways:<br><br>
                • <strong>With a colon:</strong> 3:2<br>
                • <strong>As a fraction:</strong> 3/2<br>
                • <strong>With words:</strong> "3 to 2"<br><br>
                <strong>Equivalent ratios:</strong><br>
                Just like equivalent fractions! Multiply or divide both parts by the same number.<br>
                3:2 = 6:4 = 9:6 = 12:8 (all the same ratio!)`,
                example: { problem: `A recipe uses 2 cups flour for every 3 cups sugar. If you use 6 cups flour, how much sugar?`, steps: [
                    { text: "Write the ratio", math: "Flour : Sugar = 2 : 3" },
                    { text: "How did flour change? 2 → 6", math: "2 × 3 = 6 (multiplied by 3)" },
                    { text: "Do the same to sugar", math: "3 × 3 = 9" },
                    { text: "New ratio", math: "6 : 9, so <strong>9 cups sugar</strong>" }
                ]},
                keyPoints: [
                    "Ratios compare two amounts (part to part OR part to whole)",
                    "Equivalent ratios: multiply/divide BOTH parts by the same number",
                    "Order matters! 2:3 is different from 3:2"
                ],
                mistakes: [
                    { wrong: "2:3 is the same as 3:2", why: "Order matters! 2:3 means 2 for every 3, not 3 for every 2" },
                    { wrong: "Only multiplying one part of the ratio", why: "Whatever you do to one part, do to BOTH parts" },
                    { wrong: "Adding instead of multiplying to find equivalent ratios", why: "2:3 → 4:6 (multiply by 2), not 4:5 (add 2)" }
                ],
                guided: {
                    problem: `Write an equivalent ratio: ${a}:${b} = ?:${b * 2}`,
                    steps: [
                        { label: `${b} was multiplied by what to get ${b * 2}?`, value: `${b} × 2 = ${b * 2}` },
                        { label: `Do the same to ${a}`, value: `${a} × 2 = ?` }
                    ],
                    answer: String(a * 2),
                    answerLabel: `${a}:${b} = ?:${b * 2}`,
                    interactiveSteps: [
                        {
                            prompt: `In ${a}:${b} = ?:${b * 2}, the second number changed from ${b} to ${b * 2}. What did we multiply by?`,
                            hint: `${b} × ? = ${b * 2}`,
                            answer: "2",
                            acceptableAnswers: ["2", "two", "× 2", "×2"],
                            commonMistakes: {
                                [String(b)]: `${b} × ${b} = ${b * b}, not ${b * 2}. We multiplied by 2.`,
                                [String(b * 2)]: `That's the result. ${b} × 2 = ${b * 2}, so we multiplied by 2.`
                            }
                        },
                        {
                            prompt: "In equivalent ratios, what you do to one part, you must do to the other. What do we do to the first number?",
                            hint: "We multiplied the second by 2, so...",
                            answer: "multiply by 2",
                            acceptableAnswers: ["multiply by 2", "× 2", "times 2", "multiply it by 2"],
                            commonMistakes: {
                                "add 2": "We MULTIPLY, not add. Whatever we did to ${b}, do to ${a}."
                            }
                        },
                        {
                            prompt: `Calculate: ${a} × 2 = ?`,
                            hint: "Double ${a}...",
                            answer: String(a * 2),
                            acceptableAnswers: [String(a * 2)],
                            commonMistakes: {
                                [String(a + 2)]: `You added 2 instead of multiplying! ${a} × 2 = ${a * 2}`,
                                [String(a)]: `Don't forget to multiply! ${a} × 2 = ${a * 2}`
                            }
                        },
                        {
                            prompt: `So ${a}:${b} = ?:${b * 2}. What is the missing number?`,
                            hint: `We found ${a} × 2 = ${a * 2}`,
                            answer: String(a * 2),
                            acceptableAnswers: [String(a * 2)],
                            commonMistakes: {
                                [String(a)]: `That's the original. The equivalent ratio is ${a * 2}:${b * 2}`
                            }
                        }
                    ]
                },
                practice: { problem: `If the ratio of cats to dogs is 3:5, and there are 15 dogs, how many cats?`, answer: "9",
                    options: ["5", "9", "12", "15"],
                    mistakeAnalysis: {
                        "5": "5 is from the original ratio. We need to scale up: 5 × 3 = 15 dogs, so 3 × 3 = 9 cats",
                        "12": "Check your multiplication: 5 → 15 is ×3, so 3 × 3 = 9, not 12",
                        "15": "15 is the number of dogs. For cats: 5 × 3 = 15, so cats = 3 × 3 = 9"
                    }}
            };
        },
        Proportions: () => {
            const a = rand(2, 5), b = rand(3, 6), mult = rand(2, 4);
            const c = a * mult, d = b * mult;
            return {
                goalProblem: `Solve the proportion: 3/4 = x/12`,
                teachingSteps: [
                    {
                        title: "What is a proportion?",
                        explanation: "A <strong>proportion</strong> is an equation showing two ratios that are equal. If 3/4 = x/12, we need to find what x makes this true.",
                        visual: "3/4 = x/12 (these fractions are equal)"
                    },
                    {
                        title: "Method 1: Scale factor",
                        explanation: "Look at the denominators: 4 and 12. Ask: what times 4 equals 12? The answer is 3!",
                        visual: "4 × 3 = 12"
                    },
                    {
                        title: "Apply the same scale factor",
                        explanation: "Since we multiplied the denominator by 3, we must multiply the numerator by 3 too: 3 × 3 = <strong>9</strong>",
                        visual: "3 × 3 = 9, so x = 9"
                    },
                    {
                        title: "Method 2: Cross multiply",
                        explanation: "Another way: multiply diagonally! 3 × 12 = 4 × x. This gives us: 36 = 4x",
                        visual: "3 × 12 = 36 | 4 × x = 4x | So 36 = 4x"
                    },
                    {
                        title: "Solve for x",
                        explanation: "Divide both sides by 4: 36 ÷ 4 = x, so x = <strong>9</strong>. Same answer!",
                        visual: "36 ÷ 4 = 9 ✓"
                    }
                ],
                finalAnswer: "x = 9",
                answerExplanation: "Using scale factor: 4 × 3 = 12, so 3 × 3 = 9. Or cross multiply: 3 × 12 = 4x, 36 = 4x, x = 9!",
                example: { problem: `Solve: 3/4 = x/12`, steps: [
                    { text: "Find the scale factor", math: "4 → 12 means × 3" },
                    { text: "Apply to numerator", math: "3 × 3 = 9" },
                    { text: "Or cross multiply", math: "3 × 12 = 4x → 36 = 4x → x = 9" },
                    { text: "Answer", math: "<strong>x = 9</strong>" }
                ]},
                keyPoints: [
                    "Two methods: Scale factor OR Cross multiplication",
                    "Cross multiply: multiply diagonals, then solve",
                    "Check your answer: 3/4 = 9/12 → both simplify to 3/4 ✓"
                ],
                mistakes: [
                    { wrong: "Only multiplying one part", why: "If bottom × 3, then top × 3 too!" },
                    { wrong: "Adding instead of multiplying in cross multiplication", why: "It's multiply, not add: 3 × 12 = 36" },
                    { wrong: "Cross multiplying wrong diagonals", why: "3/4 = x/12 → 3×12 = 4×x (numerator times opposite denominator)" }
                ],
                guided: {
                    problem: `Solve: ${a}/${b} = x/${d}`,
                    steps: [
                        { label: `Scale factor: ${b} × ? = ${d}`, value: `${mult}` },
                        { label: `Apply to numerator: ${a} × ${mult}`, value: "?" }
                    ],
                    answer: String(c),
                    answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}/${b} = x/${d}, what number times ${b} equals ${d}?`,
                            hint: `${b} × ? = ${d}`,
                            answer: String(mult),
                            acceptableAnswers: [String(mult)],
                            commonMistakes: {
                                [String(d)]: `That's the result. ${b} × ${mult} = ${d}, so the scale factor is ${mult}`,
                                [String(d - b)]: `You subtracted! We need to multiply: ${b} × ${mult} = ${d}`
                            }
                        },
                        {
                            prompt: `Now apply the same scale factor to the numerator: ${a} × ${mult} = ?`,
                            hint: "Multiply top by the same number...",
                            answer: String(c),
                            acceptableAnswers: [String(c)],
                            commonMistakes: {
                                [String(a + mult)]: `You added! Multiply: ${a} × ${mult} = ${c}`,
                                [String(a)]: `Don't forget to multiply! ${a} × ${mult} = ${c}`
                            }
                        },
                        {
                            prompt: `So in ${a}/${b} = x/${d}, x = ?`,
                            hint: "What value makes the fractions equal?",
                            answer: String(c),
                            acceptableAnswers: [String(c)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pa = rand(2, 4), pb = rand(5, 8), pm = rand(3, 5); return {
                    problem: `Solve: ${pa}/${pb} = ${pa * pm}/x`, answer: String(pb * pm),
                    options: shuffle([String(pb * pm), String(pb + pm), String(pa * pm), String(pb)]),
                    mistakeAnalysis: {
                        [String(pb + pm)]: `You added! Scale factor: ${pa} × ${pm} = ${pa * pm}, so ${pb} × ${pm} = ${pb * pm}`,
                        [String(pa * pm)]: `That's the numerator on the right. We need the denominator: ${pb} × ${pm} = ${pb * pm}`,
                        [String(pb)]: `That's the original denominator. We need to scale: ${pb} × ${pm} = ${pb * pm}`
                    }}; })()
            };
        },
        Statistics: () => {
            const data = [rand(10, 25), rand(15, 30), rand(20, 35), rand(25, 40), rand(30, 45)];
            const sorted = [...data].sort((a, b) => a - b);
            const range = sorted[4] - sorted[0];
            return {
                goalProblem: `Find the range of: 12, 8, 15, 6, 10`,
                teachingSteps: [
                    {
                        title: "What is statistics?",
                        explanation: "<strong>Statistics</strong> is the study of collecting, organizing, and analyzing data. We use it to make sense of numbers and find patterns!",
                        visual: "Data → Organize → Analyze → Understand"
                    },
                    {
                        title: "The Range: Measuring spread",
                        explanation: "The <strong>range</strong> tells us how spread out the data is. It's the difference between the largest and smallest values.",
                        visual: "Range = Maximum - Minimum"
                    },
                    {
                        title: "Step 1: Find the maximum",
                        explanation: "Look at the data: 12, 8, 15, 6, 10. The <strong>maximum</strong> (largest number) is 15.",
                        visual: "Max = 15"
                    },
                    {
                        title: "Step 2: Find the minimum",
                        explanation: "The <strong>minimum</strong> (smallest number) is 6.",
                        visual: "Min = 6"
                    },
                    {
                        title: "Step 3: Subtract",
                        explanation: "Range = Maximum - Minimum = 15 - 6 = <strong>9</strong>. The data spans 9 units!",
                        visual: "15 - 6 = 9"
                    }
                ],
                finalAnswer: "Range = 9",
                answerExplanation: "Maximum is 15, minimum is 6. Range = 15 - 6 = 9. The data is spread across 9 units!",
                example: { problem: `Find the range of: 12, 8, 15, 6, 10`, steps: [
                    { text: "Find maximum", math: "Max = 15" },
                    { text: "Find minimum", math: "Min = 6" },
                    { text: "Calculate range", math: "Range = 15 - 6 = <strong>9</strong>" }
                ]},
                keyPoints: [
                    "Range = Maximum - Minimum (largest minus smallest)",
                    "A larger range means data is more spread out",
                    "Range is affected by outliers (extreme values)"
                ],
                mistakes: [
                    { wrong: "Adding max and min instead of subtracting", why: "Range is the DIFFERENCE: max - min, not max + min" },
                    { wrong: "Subtracting in the wrong order (min - max)", why: "Always max - min for a positive range" },
                    { wrong: "Using the middle value instead of extremes", why: "Range only uses the largest and smallest values" }
                ],
                guided: {
                    problem: `Find the range of: ${data.join(', ')}`,
                    steps: [
                        { label: "Find maximum", value: `${sorted[4]}` },
                        { label: "Find minimum", value: `${sorted[0]}` },
                        { label: "Range = Max - Min", value: "?" }
                    ],
                    answer: String(range),
                    answerLabel: "Range = ?",
                    interactiveSteps: [
                        {
                            prompt: `Look at the data: ${data.join(', ')}. What is the maximum (largest) value?`,
                            hint: "Find the biggest number...",
                            answer: String(sorted[4]),
                            acceptableAnswers: [String(sorted[4])],
                            commonMistakes: {
                                [String(sorted[0])]: `That's the minimum (smallest). The maximum is ${sorted[4]}`,
                                [String(sorted[2])]: `That's somewhere in the middle. Look for the LARGEST number: ${sorted[4]}`
                            }
                        },
                        {
                            prompt: `What is the minimum (smallest) value in: ${data.join(', ')}?`,
                            hint: "Find the smallest number...",
                            answer: String(sorted[0]),
                            acceptableAnswers: [String(sorted[0])],
                            commonMistakes: {
                                [String(sorted[4])]: `That's the maximum (largest). The minimum is ${sorted[0]}`
                            }
                        },
                        {
                            prompt: `Calculate the range: ${sorted[4]} - ${sorted[0]} = ?`,
                            hint: "Subtract minimum from maximum...",
                            answer: String(range),
                            acceptableAnswers: [String(range)],
                            commonMistakes: {
                                [String(sorted[4] + sorted[0])]: `You added! Range = max MINUS min: ${sorted[4]} - ${sorted[0]} = ${range}`
                            }
                        }
                    ]
                },
                practice: (() => { const pd = [5, 12, 8, 20, 3]; return {
                    problem: `Find the range of: ${pd.join(', ')}`, answer: "17",
                    options: ["15", "17", "20", "23"],
                    mistakeAnalysis: {
                        "15": "Check your subtraction: Max = 20, Min = 3, Range = 20 - 3 = 17",
                        "20": "That's just the maximum. Range = Max - Min = 20 - 3 = 17",
                        "23": "You added instead of subtracted! Range = 20 - 3 = 17"
                    }}; })()
            };
        },
        "Absolute Value": () => {
            const n = rand(3, 12);
            const neg = -rand(4, 15);
            return {
                goalProblem: `What is |-7|?`,
                teachingSteps: [
                    {
                        title: "What is absolute value?",
                        explanation: "<strong>Absolute value</strong> measures the <strong>distance</strong> from zero on a number line. Distance is always positive!",
                        visual: "|x| = distance from 0"
                    },
                    {
                        title: "The absolute value bars",
                        explanation: "The bars | | around a number mean 'find the absolute value.' Think of them as 'distance from zero' bars.",
                        visual: "|-7| means 'distance of -7 from 0'"
                    },
                    {
                        title: "Visualize it on a number line",
                        explanation: "-7 is 7 units away from 0 on the number line. It doesn't matter which direction!",
                        visual: "← -7 -6 -5 -4 -3 -2 -1 [0] → (7 steps)"
                    },
                    {
                        title: "The rule for absolute value",
                        explanation: "If the number is positive or zero, keep it. If negative, make it positive (drop the negative sign).",
                        visual: "|positive| = positive | |negative| = positive"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>|-7| = 7</strong>. The distance from -7 to 0 is 7 units.",
                        visual: "|-7| = 7"
                    }
                ],
                finalAnswer: "7",
                answerExplanation: "-7 is 7 units from zero on the number line. Absolute value is always positive!",
                example: { problem: `What is |-7|?`, steps: [
                    { text: "Identify what's inside the bars", math: "-7 (a negative number)" },
                    { text: "Ask: How far is -7 from 0?", math: "Count: 7 units" },
                    { text: "Since distance is positive", math: "<strong>|-7| = 7</strong>" }
                ]},
                keyPoints: [
                    "Absolute value = distance from zero",
                    "Distance is ALWAYS positive (or zero)",
                    "|positive| = positive, |negative| = positive, |0| = 0"
                ],
                mistakes: [
                    { wrong: "|-7| = -7 (keeping the negative)", why: "Absolute value is DISTANCE, which can't be negative! |-7| = 7" },
                    { wrong: "Thinking |7| and |-7| are different", why: "Both are 7 units from zero! |7| = |-7| = 7" },
                    { wrong: "|-7| = -(-7) = 7 by 'double negative'", why: "While the answer is right, the concept is distance, not double negatives" }
                ],
                guided: {
                    problem: `What is |${neg}|?`,
                    steps: [
                        { label: `${neg} is a negative number`, value: "Make it positive" },
                        { label: `Distance from 0`, value: "?" }
                    ],
                    answer: String(Math.abs(neg)),
                    answerLabel: `|${neg}| = ?`,
                    interactiveSteps: [
                        {
                            prompt: "What does absolute value measure?",
                            hint: "Think about how far a number is from zero...",
                            answer: "distance from zero",
                            acceptableAnswers: ["distance from zero", "distance", "distance from 0", "how far from zero", "how far from 0"],
                            commonMistakes: {
                                "the negative": "Absolute value measures DISTANCE from zero, not negativity",
                                "sign": "It's not about the sign - it's about distance from zero"
                            }
                        },
                        {
                            prompt: `How many units is ${neg} from 0 on a number line?`,
                            hint: `Count the spaces from ${neg} to 0...`,
                            answer: String(Math.abs(neg)),
                            acceptableAnswers: [String(Math.abs(neg))],
                            commonMistakes: {
                                [String(neg)]: `Distance can't be negative! ${neg} is ${Math.abs(neg)} units from zero.`
                            }
                        },
                        {
                            prompt: `So |${neg}| = ?`,
                            hint: "Distance is always positive...",
                            answer: String(Math.abs(neg)),
                            acceptableAnswers: [String(Math.abs(neg))],
                            commonMistakes: {
                                [String(neg)]: `Absolute value is always positive! |${neg}| = ${Math.abs(neg)}`
                            }
                        }
                    ]
                },
                practice: { problem: `Evaluate: |-12| + |5|`, answer: "17",
                    options: ["-7", "7", "17", "-17"],
                    mistakeAnalysis: {
                        "-7": "You subtracted and kept a negative. |-12| = 12, |5| = 5, so 12 + 5 = 17",
                        "7": "You subtracted instead of adding. |-12| = 12, |5| = 5, 12 + 5 = 17",
                        "-17": "Absolute values are positive! |-12| = 12, |5| = 5, 12 + 5 = 17"
                    }}
            };
        },
        "Scientific Notation": () => {
            const coef = rand(2, 9);
            const exp = rand(3, 7);
            const num = coef * Math.pow(10, exp);
            return {
                goalProblem: `Write 3,500,000 in scientific notation`,
                teachingSteps: [
                    {
                        title: "Why scientific notation?",
                        explanation: "<strong>Scientific notation</strong> is a way to write very large or very small numbers in a compact form. It's used by scientists, engineers, and mathematicians!",
                        visual: "3,500,000 → shorter form?"
                    },
                    {
                        title: "The format",
                        explanation: "Scientific notation: <strong>a × 10ⁿ</strong>, where 'a' is between 1 and 10, and 'n' is the exponent.",
                        visual: "a × 10ⁿ (1 ≤ a < 10)"
                    },
                    {
                        title: "Step 1: Move the decimal point",
                        explanation: "Start with 3,500,000. Move the decimal point until you have a number between 1 and 10: 3.500000",
                        visual: "3,500,000 → 3.5"
                    },
                    {
                        title: "Step 2: Count the moves",
                        explanation: "We moved the decimal <strong>6 places</strong> to the left. This becomes our exponent!",
                        visual: "3.500000 (moved 6 places) → exponent = 6"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>3,500,000 = 3.5 × 10⁶</strong>. The 6 means 'move decimal 6 places right to get back.'",
                        visual: "3.5 × 10⁶"
                    }
                ],
                finalAnswer: "3.5 × 10⁶",
                answerExplanation: "Move decimal 6 places left to get 3.5 (between 1 and 10). Exponent is 6. Answer: 3.5 × 10⁶",
                example: { problem: `Write 3,500,000 in scientific notation`, steps: [
                    { text: "Move decimal to get 1 ≤ a < 10", math: "3,500,000 → 3.5" },
                    { text: "Count decimal moves", math: "Moved 6 places left" },
                    { text: "Write with 10^n", math: "<strong>3.5 × 10⁶</strong>" }
                ]},
                keyPoints: [
                    "First number must be between 1 and 10 (like 3.5, not 35 or 0.35)",
                    "Positive exponent = big number, Negative exponent = small decimal",
                    "The exponent tells you how many places to move the decimal"
                ],
                mistakes: [
                    { wrong: "35 × 10⁵ (first number > 10)", why: "First number must be between 1 and 10. Use 3.5 × 10⁶" },
                    { wrong: "3.5 × 10⁵ (wrong exponent)", why: "Count carefully: 3,500,000 has 6 zeros after 3.5, so 10⁶" },
                    { wrong: "Using negative exponent for large numbers", why: "Negative exponents are for small decimals like 0.00035" }
                ],
                guided: {
                    problem: `Write ${num.toLocaleString()} in scientific notation`,
                    steps: [
                        { label: "Move decimal to get 1 ≤ a < 10", value: `${coef}.0` },
                        { label: "Count the moves", value: `${exp} places` },
                        { label: "Scientific notation", value: "?" }
                    ],
                    answer: `${coef} × 10^${exp}`,
                    answerLabel: "Scientific notation:",
                    interactiveSteps: [
                        {
                            prompt: "In scientific notation, the first number must be between what values?",
                            hint: "It should be at least 1 but less than 10...",
                            answer: "1 and 10",
                            acceptableAnswers: ["1 and 10", "1-10", "between 1 and 10", "1 to 10"],
                            commonMistakes: {
                                "0 and 10": "Close! It must be at LEAST 1. So between 1 and 10.",
                                "1 and 100": "The range is smaller: between 1 and 10."
                            }
                        },
                        {
                            prompt: `To write ${num.toLocaleString()} in scientific notation, what will 'a' (the first number) be?`,
                            hint: "Move the decimal until you have a number between 1 and 10...",
                            answer: String(coef),
                            acceptableAnswers: [String(coef), `${coef}.0`],
                            commonMistakes: {
                                [String(coef * 10)]: `That's greater than 10! Move the decimal more to get ${coef}`,
                                [String(num)]: "You need to convert it! Move decimal to get a number between 1 and 10."
                            }
                        },
                        {
                            prompt: `How many places did you move the decimal to get from ${num.toLocaleString()} to ${coef}?`,
                            hint: `Count the places from ${coef}.0 to ${num.toLocaleString()}...`,
                            answer: String(exp),
                            acceptableAnswers: [String(exp)],
                            commonMistakes: {
                                [String(exp - 1)]: `Count again! ${num.toLocaleString()} → ${coef}.0 is ${exp} places`,
                                [String(exp + 1)]: `Too many! ${num.toLocaleString()} → ${coef}.0 is ${exp} places`
                            }
                        },
                        {
                            prompt: `So ${num.toLocaleString()} = ? × 10^${exp}`,
                            hint: "Put together a × 10^n...",
                            answer: `${coef} × 10^${exp}`,
                            acceptableAnswers: [`${coef} × 10^${exp}`, `${coef}×10^${exp}`, `${coef} x 10^${exp}`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: (() => { const pc = rand(2, 8), pe = rand(4, 8); return {
                    problem: `Write ${pc} × 10^${pe} in standard form`, answer: String(pc * Math.pow(10, pe)),
                    options: shuffle([String(pc * Math.pow(10, pe)), String(pc * Math.pow(10, pe - 1)), String(pc * Math.pow(10, pe + 1)), String(pc * pe)]),
                    mistakeAnalysis: {
                        [String(pc * Math.pow(10, pe - 1))]: "Check your exponent! 10^" + pe + " has " + pe + " zeros",
                        [String(pc * Math.pow(10, pe + 1))]: "That's one too many zeros. 10^" + pe + " = 1" + "0".repeat(pe),
                        [String(pc * pe)]: "Don't multiply by the exponent! 10^" + pe + " means 1" + "0".repeat(pe)
                    }}; })()
            };
        },
        "Square Roots": () => {
            const perfect = pick([4, 9, 16, 25, 36, 49, 64, 81, 100]);
            const root = Math.sqrt(perfect);
            return {
                goalProblem: `What is √49?`,
                teachingSteps: [
                    {
                        title: "What is a square root?",
                        explanation: "A <strong>square root</strong> is the opposite of squaring. If 7² = 49, then √49 = 7. It asks: 'What number times itself equals 49?'",
                        visual: "√49 = ? → ? × ? = 49"
                    },
                    {
                        title: "The square root symbol",
                        explanation: "The √ symbol is called the <strong>radical sign</strong>. It means 'find the number that, when multiplied by itself, gives this.'",
                        visual: "√ = radical sign"
                    },
                    {
                        title: "Perfect squares",
                        explanation: "Some numbers are <strong>perfect squares</strong> because they come from whole numbers squared: 1, 4, 9, 16, 25, 36, 49, 64, 81, 100...",
                        visual: "1²=1, 2²=4, 3²=9, 4²=16, 5²=25, 6²=36, 7²=49..."
                    },
                    {
                        title: "Finding √49",
                        explanation: "What number times itself equals 49? Let's check: 7 × 7 = 49. Yes! So √49 = <strong>7</strong>.",
                        visual: "7 × 7 = 49, so √49 = 7"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>√49 = 7</strong> because 7² = 49. Squaring and square roots are inverse operations!",
                        visual: "√49 = 7"
                    }
                ],
                finalAnswer: "7",
                answerExplanation: "√49 asks: what × what = 49? Since 7 × 7 = 49, √49 = 7!",
                example: { problem: `What is √49?`, steps: [
                    { text: "Ask: what times itself = 49?", math: "? × ? = 49" },
                    { text: "Check: 7 × 7 = 49 ✓", math: "7² = 49" },
                    { text: "So the square root is", math: "<strong>√49 = 7</strong>" }
                ]},
                keyPoints: [
                    "√n asks 'what number squared equals n?'",
                    "Memorize perfect squares: 1, 4, 9, 16, 25, 36, 49, 64, 81, 100",
                    "Square root and squaring are opposites: √(n²) = n"
                ],
                mistakes: [
                    { wrong: "√49 = 49/2 = 24.5", why: "Square root is NOT dividing by 2! √49 = 7 because 7 × 7 = 49" },
                    { wrong: "√49 = 7 × 7 = 49", why: "That's squaring, not square rooting. √49 = 7, not 49" },
                    { wrong: "Confusing √ with ÷2", why: "Different operations! √4 = 2 (because 2×2=4), but 4÷2 = 2 (coincidence!)" }
                ],
                guided: {
                    problem: `What is √${perfect}?`,
                    steps: [
                        { label: "Find: ? × ? = " + perfect, value: "Think of perfect squares..." },
                        { label: `${root} × ${root} = ${perfect}`, value: "✓" }
                    ],
                    answer: String(root),
                    answerLabel: `√${perfect} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "What does the square root (√) ask us to find?",
                            hint: "What number times ITSELF equals the number under the radical?",
                            answer: "what times itself",
                            acceptableAnswers: ["what times itself", "number times itself", "a number squared", "what squared"],
                            commonMistakes: {
                                "divide by 2": "Square root is NOT dividing by 2! It's finding what times itself gives the number.",
                                "half": "That's division! Square root asks: ? × ? = n"
                            }
                        },
                        {
                            prompt: `What number times itself equals ${perfect}?`,
                            hint: "Think: ? × ? = " + perfect,
                            answer: String(root),
                            acceptableAnswers: [String(root)],
                            commonMistakes: {
                                [String(perfect / 2)]: `${perfect / 2} × 2 = ${perfect}, but we need ? × ? (same number twice). ${root} × ${root} = ${perfect}`,
                                [String(perfect)]: `We need a number that MULTIPLIED BY ITSELF gives ${perfect}. That's ${root}.`
                            }
                        },
                        {
                            prompt: `Verify: ${root} × ${root} = ?`,
                            hint: "Check your answer by squaring...",
                            answer: String(perfect),
                            acceptableAnswers: [String(perfect)],
                            commonMistakes: {
                                [String(root * 2)]: `You added or doubled! ${root} × ${root} = ${perfect}`
                            }
                        },
                        {
                            prompt: `So √${perfect} = ?`,
                            hint: "What number did you find?",
                            answer: String(root),
                            acceptableAnswers: [String(root)],
                            commonMistakes: {
                                [String(perfect)]: `${perfect} is under the radical. The answer is ${root} because ${root}² = ${perfect}`
                            }
                        }
                    ]
                },
                practice: (() => { const pp = pick([16, 25, 64, 81, 100]); const pr = Math.sqrt(pp); return {
                    problem: `What is √${pp}?`, answer: String(pr),
                    options: shuffle([String(pr), String(pr + 1), String(pr - 1), String(pp / 2)]),
                    mistakeAnalysis: {
                        [String(pr + 1)]: `Check: ${pr + 1} × ${pr + 1} = ${(pr + 1) * (pr + 1)}, not ${pp}. √${pp} = ${pr}`,
                        [String(pr - 1)]: `Check: ${pr - 1} × ${pr - 1} = ${(pr - 1) * (pr - 1)}, not ${pp}. √${pp} = ${pr}`,
                        [String(pp / 2)]: `Square root is NOT dividing by 2! √${pp} = ${pr} because ${pr} × ${pr} = ${pp}`
                    }}; })()
            };
        }
    },
    4: {
        Equations: () => {
            const x = rand(3, 12), b = rand(2, 10);
            return {
                goalProblem: `Solve: x + 5 = 12`,
                teachingSteps: [
                    {
                        title: "What does 'solving an equation' mean?",
                        explanation: "We need to find the value of <strong>x</strong> that makes the equation true. Think of x as a mystery number we're trying to discover!",
                        visual: "x + 5 = 12 → What is x?"
                    },
                    {
                        title: "The balance scale rule",
                        explanation: "An equation is like a balance scale. Whatever you do to one side, you <strong>MUST</strong> do to the other side to keep it balanced!",
                        visual: "Left side = Right side (always!)"
                    },
                    {
                        title: "Identify what's being done to x",
                        explanation: "Look at the left side: x + 5. The number 5 is being <strong>added</strong> to x. To get x alone, we need to undo this.",
                        visual: "x + 5 → 5 is ADDED to x"
                    },
                    {
                        title: "Do the opposite to both sides",
                        explanation: "Since 5 is added to x, we do the opposite (subtract 5) from <strong>both sides</strong>: x + 5 - 5 = 12 - 5",
                        visual: "x + 5 - 5 = 12 - 5"
                    },
                    {
                        title: "Simplify to get the answer",
                        explanation: "On the left: x + 5 - 5 = x. On the right: 12 - 5 = 7. So <strong>x = 7</strong>! Check: 7 + 5 = 12 ✓",
                        visual: "x = 7"
                    }
                ],
                finalAnswer: "x = 7",
                answerExplanation: "By subtracting 5 from both sides, we isolated x. Always check: 7 + 5 = 12 ✓",
                example: { problem: `Solve: x + 5 = 12`, steps: [
                    { text: "What's being done to x?", math: "5 is being ADDED to x" },
                    { text: "Do the opposite (subtract 5) from BOTH sides", math: "x + 5 - 5 = 12 - 5" },
                    { text: "Simplify both sides", math: "x = 7" },
                    { text: "Check: Does 7 + 5 = 12?", math: "7 + 5 = 12 ✓ <strong>x = 7</strong>" }
                ]},
                keyPoints: [
                    "Opposite operations: + ↔ −, × ↔ ÷",
                    "Think of an equation like a balance scale - keep both sides equal",
                    "ALWAYS check your answer by plugging it back in"
                ],
                mistakes: [
                    { wrong: "Only operating on one side", why: "If you subtract 5 from the left, you MUST subtract 5 from the right too!" },
                    { wrong: "x + 5 = 12 → x = 12 + 5 = 17", why: "You need to UNDO the addition, which means SUBTRACT. x = 12 - 5 = 7" },
                    { wrong: "Forgetting to check your answer", why: "Checking catches mistakes! If x = 7, then 7 + 5 should equal 12." }
                ],
                guided: { problem: `Solve: x + ${b} = ${x + b}`, steps: [
                    { label: "What operation is on x?", value: `Adding ${b}` },
                    { label: "Do the opposite to both sides", value: `Subtract ${b} from both sides` },
                    { label: `x + ${b} - ${b} = ${x + b} - ${b}`, value: `x = ?` }
                ], answer: String(x), answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In the equation x + ${b} = ${x + b}, what operation is being done to x?`,
                            hint: "Look at the left side. What's happening to x?",
                            answer: "addition",
                            acceptableAnswers: ["addition", "adding", "add", "plus", `adding ${b}`, "+ " + b],
                            commonMistakes: {
                                "subtraction": `Look again: x + ${b}. The + sign means addition!`,
                                "multiplication": "There's no × sign. x + ${b} uses addition."
                            }
                        },
                        {
                            prompt: "To get x alone, we do the OPPOSITE. What's the opposite of addition?",
                            hint: "If adding makes it bigger, what makes it smaller?",
                            answer: "subtraction",
                            acceptableAnswers: ["subtraction", "subtract", "minus", "-"],
                            commonMistakes: {
                                "division": "Division is the opposite of multiplication. The opposite of addition is subtraction.",
                                "addition": "We need to UNDO the addition, so we do the opposite."
                            }
                        },
                        {
                            prompt: `We'll subtract ${b} from BOTH sides. What is ${x + b} - ${b}?`,
                            hint: `Start with ${x + b} and subtract ${b}...`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String(x + b)]: `You need to subtract! ${x + b} - ${b} = ${x}`,
                                [String(x + b + b)]: `Subtract, not add! ${x + b} - ${b} = ${x}`
                            }
                        },
                        {
                            prompt: `So x + ${b} - ${b} = ${x}. This simplifies to x = ?`,
                            hint: `x + ${b} - ${b} = x + 0 = x. And we found that equals ${x}`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String(x + b)]: `Remember, we subtracted ${b} from both sides. x = ${x}`
                            }
                        }
                    ]
                },
                practice: (() => { const newB = b + 2; return {
                    problem: `Solve: x + ${newB} = ${x + newB}`, answer: String(x),
                    options: shuffle([String(x), String(x + newB), String(2 * newB), String(newB)]),
                    mistakeAnalysis: {
                        [String(x + newB)]: `You kept the right side unchanged. Subtract ${newB} from both sides: ${x + newB} - ${newB} = ${x}`,
                        [String(2 * newB)]: `That's not how equations work. Subtract ${newB} from ${x + newB} to isolate x.`,
                        [String(newB)]: `That's just the number being added. To find x, subtract ${newB} from ${x + newB}.`
                    }}; })()
            };
        },
        Exponents: () => {
            const base = rand(2, 4), exp = rand(2, 3);
            const ans = Math.pow(base, exp);
            return {
                goalProblem: `What is 2³?`,
                teachingSteps: [
                    {
                        title: "What are exponents?",
                        explanation: "<strong>Exponents</strong> are shorthand for repeated multiplication. Instead of writing 2 × 2 × 2, we can write 2³!",
                        visual: "2 × 2 × 2 = 2³"
                    },
                    {
                        title: "The two parts: base and exponent",
                        explanation: "In 2³, the <strong>2</strong> is the 'base' (the number being multiplied) and the <strong>3</strong> is the 'exponent' (how many times).",
                        visual: "2³ → base=2, exponent=3"
                    },
                    {
                        title: "Read it as: 'multiply base by itself exponent times'",
                        explanation: "2³ means: multiply 2 by itself <strong>3 times</strong>. NOT 2 × 3! The exponent tells us how many 2s to multiply.",
                        visual: "2³ = 2 × 2 × 2 (three 2s)"
                    },
                    {
                        title: "Calculate step by step",
                        explanation: "Start with the first two: 2 × 2 = 4. Then multiply by the next 2: 4 × 2 = 8.",
                        visual: "2 × 2 = 4 → 4 × 2 = 8"
                    },
                    {
                        title: "The answer",
                        explanation: "<strong>2³ = 8</strong>. Remember: the exponent is NOT a multiplier, it's a counter of how many times!",
                        visual: "2³ = 8"
                    }
                ],
                finalAnswer: "8",
                answerExplanation: "2³ means 2 × 2 × 2 = 8. The exponent (3) tells us to multiply the base (2) by itself 3 times!",
                example: { problem: `What is 2³?`, steps: [
                    { text: "Identify: base = 2, exponent = 3", math: "Multiply 2 by itself 3 times" },
                    { text: "Write out the multiplication", math: "2³ = 2 × 2 × 2" },
                    { text: "Calculate step by step", math: "2 × 2 = 4" },
                    { text: "Then multiply by the next 2", math: "4 × 2 = <strong>8</strong>" }
                ]},
                keyPoints: [
                    "The exponent tells you HOW MANY times to multiply the base",
                    "2³ = 2 × 2 × 2 = 8 (NOT 2 × 3 = 6!)",
                    "The bigger the exponent, the faster the number grows: 2¹ = 2, 2² = 4, 2³ = 8, 2⁴ = 16"
                ],
                mistakes: [
                    { wrong: "2³ = 2 × 3 = 6", why: "Don't multiply base times exponent! 2³ means 2 × 2 × 2 = 8" },
                    { wrong: "3² = 6", why: "3² means 3 × 3 = 9, not 3 × 2" },
                    { wrong: "5⁰ = 0", why: "Any number (except 0) to the power of 0 equals 1. 5⁰ = 1" }
                ],
                guided: { problem: `What is ${base}${['⁰','¹','²','³'][exp]}?`, steps: [
                    { label: "Identify base and exponent", value: `Base = ${base}, Exponent = ${exp}` },
                    { label: "Write as repeated multiplication", value: `${Array(exp).fill(base).join(' × ')}` },
                    { label: "Calculate", value: "?" }
                ], answer: String(ans), answerLabel: `${base}${['⁰','¹','²','³'][exp]} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `In ${base}${['⁰','¹','²','³'][exp]}, what is the BASE (the number being multiplied)?`,
                            hint: "The base is the big number at the bottom...",
                            answer: String(base),
                            acceptableAnswers: [String(base)],
                            commonMistakes: {
                                [String(exp)]: `${exp} is the exponent (the small number). The base is ${base}.`
                            }
                        },
                        {
                            prompt: `In ${base}${['⁰','¹','²','³'][exp]}, what is the EXPONENT (how many times to multiply)?`,
                            hint: "The exponent is the small raised number...",
                            answer: String(exp),
                            acceptableAnswers: [String(exp)],
                            commonMistakes: {
                                [String(base)]: `${base} is the base. The exponent is the small raised number: ${exp}`
                            }
                        },
                        {
                            prompt: `So ${base}${['⁰','¹','²','³'][exp]} means: multiply ${base} by itself how many times?`,
                            hint: "The exponent tells us how many times...",
                            answer: String(exp),
                            acceptableAnswers: [String(exp), exp === 2 ? "twice" : "three times", exp === 2 ? "two" : "three"],
                            commonMistakes: {
                                [String(base * exp)]: `That's ${base} × ${exp}. The exponent tells us HOW MANY times to multiply, which is ${exp}.`
                            }
                        },
                        {
                            prompt: `Write it out: ${base}${['⁰','¹','²','³'][exp]} = ${base} × ${base}${exp === 3 ? ` × ${base}` : ''}. What is ${base} × ${base}?`,
                            hint: `${base} times ${base}...`,
                            answer: String(base * base),
                            acceptableAnswers: [String(base * base)],
                            commonMistakes: {
                                [String(base + base)]: `You added! ${base} × ${base} = ${base * base}, not ${base} + ${base} = ${base + base}`,
                                [String(base)]: `${base} × ${base} = ${base * base}`
                            }
                        },
                        {
                            prompt: exp === 2 ? `So ${base}² = ?` : `Now: ${base * base} × ${base} = ?`,
                            hint: exp === 2 ? `${base} × ${base} = ?` : `${base * base} × ${base}...`,
                            answer: String(ans),
                            acceptableAnswers: [String(ans)],
                            commonMistakes: {
                                [String(base * exp)]: `Remember, we multiply ${base} by itself ${exp} times, not ${base} × ${exp}. The answer is ${ans}.`
                            }
                        }
                    ]
                },
                practice: (() => { const pe = exp === 3 ? 2 : 3; const pa = Math.pow(base, pe); return {
                    problem: `What is ${base}${['⁰','¹','²','³'][pe]}?`, answer: String(pa),
                    options: shuffle([String(pa), String(base * pe), String(Math.pow(base, exp)), String(base + pe)]),
                    mistakeAnalysis: {
                        [String(base * pe)]: `You multiplied ${base} × ${pe} = ${base * pe}. But ${base}${['⁰','¹','²','³'][pe]} means ${Array(pe).fill(base).join(' × ')} = ${pa}`,
                        [String(Math.pow(base, exp))]: `That's ${base}${['⁰','¹','²','³'][exp]}. For ${base}${['⁰','¹','²','³'][pe]}, multiply ${base} by itself ${pe} times.`,
                        [String(base + pe)]: `You added! Exponents mean repeated multiplication: ${Array(pe).fill(base).join(' × ')} = ${pa}`
                    }}; })()
            };
        },
        "Angles and Lines": () => {
            const angle1 = rand(30, 70);
            const complement = 90 - angle1;
            const supplement = 180 - angle1;
            return {
                concept: `<strong>Angles</strong> are formed when two lines or rays meet at a point.<br><br>
                <strong>Types of angles:</strong><br>
                • <strong>Acute:</strong> less than 90° (sharp angle)<br>
                • <strong>Right:</strong> exactly 90° (square corner)<br>
                • <strong>Obtuse:</strong> between 90° and 180° (wide angle)<br>
                • <strong>Straight:</strong> exactly 180° (a line)<br><br>
                <strong>Special angle pairs:</strong><br>
                • <strong>Complementary:</strong> Two angles that add to 90°<br>
                • <strong>Supplementary:</strong> Two angles that add to 180°<br>
                • <strong>Vertical:</strong> Opposite angles formed by intersecting lines (they're EQUAL!)`,
                example: { problem: `Two angles are supplementary. One is 120°. Find the other.`, steps: [
                    { text: "Recall: supplementary means the angles add to 180°", math: "angle₁ + angle₂ = 180°" },
                    { text: "Substitute the known angle", math: "120° + angle₂ = 180°" },
                    { text: "Subtract 120° from both sides", math: "angle₂ = 180° - 120°" },
                    { text: "Calculate", math: "angle₂ = <strong>60°</strong>" },
                    { text: "Check: 120° + 60° = 180° ✓", math: "" }
                ]},
                keyPoints: [
                    "Complementary = 90° (think: C for Corner, which is 90°)",
                    "Supplementary = 180° (think: S for Straight line, which is 180°)",
                    "Vertical angles are always EQUAL to each other"
                ],
                mistakes: [
                    { wrong: "Confusing complementary (90°) and supplementary (180°)", why: "Remember: Complementary → Corner (90°), Supplementary → Straight (180°)" },
                    { wrong: "Subtracting from the wrong total", why: "Complementary: subtract from 90. Supplementary: subtract from 180." },
                    { wrong: "Thinking a 100° angle is complementary to something", why: "Complementary angles are each LESS than 90°. 100° is already bigger than 90°!" }
                ],
                guided: { problem: `Two complementary angles: one is ${angle1}°. Find the other.`, steps: [
                    { label: "Complementary means they add to", value: "90°" },
                    { label: `${angle1}° + ? = 90°`, value: `? = 90° - ${angle1}°` },
                    { label: "Calculate", value: "?" }
                ], answer: String(complement), answerLabel: "Other angle:",
                    interactiveSteps: [
                        {
                            prompt: "Complementary angles add up to what total?",
                            hint: "Think: C for Complementary = C for Corner (a right angle)...",
                            answer: "90",
                            acceptableAnswers: ["90", "90°", "90 degrees", "ninety"],
                            commonMistakes: {
                                "180": "That's supplementary! Complementary = 90° (think: Corner)",
                                "360": "That's a full circle. Complementary angles add to 90°"
                            }
                        },
                        {
                            prompt: `If the two angles add to 90°, and one is ${angle1}°, what equation can we write?`,
                            hint: `${angle1} + ? = 90`,
                            answer: `${angle1} + ? = 90`,
                            acceptableAnswers: [`${angle1} + ? = 90`, `${angle1}° + ? = 90°`, "90 - " + angle1, `? = 90 - ${angle1}`],
                            commonMistakes: {
                                [`${angle1} + ? = 180`]: "Complementary angles add to 90°, not 180°!"
                            }
                        },
                        {
                            prompt: `To find the missing angle, calculate: 90 - ${angle1} = ?`,
                            hint: `90 minus ${angle1}...`,
                            answer: String(complement),
                            acceptableAnswers: [String(complement), complement + "°"],
                            commonMistakes: {
                                [String(180 - angle1)]: `You subtracted from 180. For complementary, subtract from 90: 90 - ${angle1} = ${complement}`,
                                [String(angle1)]: `You need to subtract! 90 - ${angle1} = ${complement}`
                            }
                        },
                        {
                            prompt: `Check: Does ${angle1}° + ${complement}° = 90°?`,
                            hint: "Add them together...",
                            answer: "yes",
                            acceptableAnswers: ["yes", "90", "90°", "correct", "true"],
                            commonMistakes: {
                                "no": `${angle1} + ${complement} = 90 ✓ It does equal 90°!`
                            }
                        }
                    ]
                },
                practice: { problem: `Find the supplement of ${angle1}°`, answer: String(supplement),
                    options: [String(complement), String(supplement), String(180), String(angle1)],
                    mistakeAnalysis: {
                        [String(complement)]: `That's the COMPLEMENT (adds to 90°). The SUPPLEMENT adds to 180°: 180° - ${angle1}° = ${supplement}°`,
                        [String(180)]: "180° is what supplementary angles add TO, not the missing angle.",
                        [String(angle1)]: `The supplement is 180° - ${angle1}° = ${supplement}°, not the same angle.`
                    }}
            };
        },
        "Algebraic Expressions": () => {
            const coef1 = rand(2, 5), coef2 = rand(2, 4);
            const const1 = rand(1, 6), const2 = rand(1, 5);
            const xVal = rand(2, 6);
            return {
                concept: `<strong>Algebraic Expressions</strong> use letters (variables) to represent unknown numbers.<br><br>
                <strong>Key vocabulary:</strong><br>
                • <strong>Variable:</strong> A letter representing a number (like x, y, n)<br>
                • <strong>Coefficient:</strong> The number in front of a variable (in 3x, the 3 is the coefficient)<br>
                • <strong>Constant:</strong> A number without a variable (just a plain number like 5)<br>
                • <strong>Like terms:</strong> Terms with the same variable (3x and 5x are like terms)<br><br>
                <strong>Simplifying:</strong> Combine like terms by adding/subtracting their coefficients`,
                example: { problem: `Simplify: 4x + 3 + 2x + 5`, steps: [
                    { text: "Identify like terms", math: "Variable terms: 4x and 2x | Constants: 3 and 5" },
                    { text: "Combine the x terms", math: "4x + 2x = 6x (add coefficients: 4 + 2 = 6)" },
                    { text: "Combine the constants", math: "3 + 5 = 8" },
                    { text: "Write the simplified expression", math: "<strong>6x + 8</strong>" }
                ]},
                keyPoints: [
                    "Like terms have the SAME variable part: 3x + 5x = 8x, but 3x + 5y stays as 3x + 5y",
                    "When simplifying, only combine coefficients - the variable stays the same",
                    "To evaluate: replace the variable with a number and calculate"
                ],
                mistakes: [
                    { wrong: "3x + 5 = 8x", why: "3x and 5 are NOT like terms! 5 has no x. Answer stays: 3x + 5" },
                    { wrong: "3x means 3 + x", why: "3x means 3 TIMES x. If x = 4, then 3x = 3 × 4 = 12, not 3 + 4 = 7" },
                    { wrong: "3x + 2x = 5x²", why: "Adding like terms doesn't change the exponent. 3x + 2x = 5x (not 5x²)" }
                ],
                guided: { problem: `Simplify: ${coef1}x + ${const1} + ${coef2}x + ${const2}`, steps: [
                    { label: "Combine x terms", value: `${coef1}x + ${coef2}x = ${coef1 + coef2}x` },
                    { label: "Combine constants", value: `${const1} + ${const2} = ${const1 + const2}` },
                    { label: "Final expression", value: "?" }
                ], answer: `${coef1 + coef2}x + ${const1 + const2}`, answerLabel: "Simplified:",
                    interactiveSteps: [
                        {
                            prompt: `In ${coef1}x + ${const1} + ${coef2}x + ${const2}, which terms have the variable x?`,
                            hint: "Look for terms with 'x' in them...",
                            answer: `${coef1}x and ${coef2}x`,
                            acceptableAnswers: [`${coef1}x and ${coef2}x`, `${coef1}x, ${coef2}x`, `${coef1}x ${coef2}x`],
                            commonMistakes: {
                                [`${const1} and ${const2}`]: "Those are constants (plain numbers). The x terms are ${coef1}x and ${coef2}x."
                            }
                        },
                        {
                            prompt: `Combine the x terms: ${coef1}x + ${coef2}x = ?`,
                            hint: `Add the coefficients: ${coef1} + ${coef2} = ? Then keep the x`,
                            answer: `${coef1 + coef2}x`,
                            acceptableAnswers: [`${coef1 + coef2}x`, String(coef1 + coef2) + "x"],
                            commonMistakes: {
                                [String(coef1 + coef2)]: `Don't forget the x! ${coef1}x + ${coef2}x = ${coef1 + coef2}x`,
                                [`${coef1 + coef2}x²`]: "When adding like terms, the exponent stays the same: ${coef1 + coef2}x, not x²"
                            }
                        },
                        {
                            prompt: `Now combine the constants (numbers without x): ${const1} + ${const2} = ?`,
                            hint: "Just add the plain numbers...",
                            answer: String(const1 + const2),
                            acceptableAnswers: [String(const1 + const2)],
                            commonMistakes: {
                                [`${const1 + const2}x`]: "Constants don't have x! Just ${const1} + ${const2} = ${const1 + const2}"
                            }
                        },
                        {
                            prompt: `Write the simplified expression: ${coef1 + coef2}x + ?`,
                            hint: `We found the x terms combine to ${coef1 + coef2}x and constants to ${const1 + const2}`,
                            answer: `${coef1 + coef2}x + ${const1 + const2}`,
                            acceptableAnswers: [`${coef1 + coef2}x + ${const1 + const2}`, `${coef1 + coef2}x+${const1 + const2}`],
                            commonMistakes: {
                                [`${coef1 + coef2 + const1 + const2}x`]: "You can't combine x terms with constants! Keep them separate: ${coef1 + coef2}x + ${const1 + const2}"
                            }
                        }
                    ]
                },
                practice: (() => { const expr = coef1 + 1; return {
                    problem: `Evaluate ${expr}x + ${const1} when x = ${xVal}`, answer: String(expr * xVal + const1),
                    options: shuffle([String(expr * xVal + const1), String(expr + xVal + const1), String(expr * xVal), String(expr + const1)]),
                    mistakeAnalysis: {
                        [String(expr + xVal + const1)]: `${expr}x means ${expr} TIMES x. So ${expr} × ${xVal} + ${const1} = ${expr * xVal} + ${const1} = ${expr * xVal + const1}`,
                        [String(expr * xVal)]: `You forgot to add the constant! ${expr} × ${xVal} = ${expr * xVal}, then add ${const1} to get ${expr * xVal + const1}`,
                        [String(expr + const1)]: `You didn't substitute x = ${xVal}. Replace x with ${xVal}: ${expr} × ${xVal} + ${const1} = ${expr * xVal + const1}`
                    }}; })()
            };
        },
        "Order of Operations": () => {
            const a = rand(2, 5), b = rand(3, 6), c = rand(1, 4);
            return {
                concept: `<strong>Order of Operations</strong> tells us which operations to do first.<br><br>
                <strong>PEMDAS (Please Excuse My Dear Aunt Sally):</strong><br>
                1. <strong>P</strong>arentheses - Do what's inside first<br>
                2. <strong>E</strong>xponents - Powers next<br>
                3. <strong>M</strong>ultiplication & <strong>D</strong>ivision - Left to right<br>
                4. <strong>A</strong>ddition & <strong>S</strong>ubtraction - Left to right<br><br>
                <strong>Important:</strong> Multiplication/Division are done together (left to right), same for Addition/Subtraction`,
                example: { problem: `Evaluate: 3 + 4 × 2`, steps: [
                    { text: "Check for parentheses", math: "None" },
                    { text: "Check for exponents", math: "None" },
                    { text: "Do multiplication BEFORE addition", math: "4 × 2 = 8" },
                    { text: "Then add", math: "3 + 8 = <strong>11</strong>" },
                    { text: "NOT: 3 + 4 = 7, then 7 × 2 = 14", math: "(That's wrong!)" }
                ]},
                keyPoints: [
                    "Multiplication and division come BEFORE addition and subtraction",
                    "When you have × and ÷ together, go left to right",
                    "Parentheses first, always!"
                ],
                mistakes: [
                    { wrong: "3 + 4 × 2 = 14 (adding first)", why: "Multiplication comes before addition! Do 4 × 2 = 8 first, then 3 + 8 = 11" },
                    { wrong: "10 - 3 + 2 = 5 (doing subtraction first always)", why: "Addition and subtraction: go LEFT to RIGHT. 10 - 3 = 7, then 7 + 2 = 9" }
                ],
                guided: { problem: `Evaluate: ${a} + ${b} × ${c}`, steps: [
                    { label: "Which operation first?", value: "Multiplication (PEMDAS)" },
                    { label: `${b} × ${c} =`, value: `${b * c}` },
                    { label: `Then: ${a} + ${b * c} =`, value: "?" }
                ], answer: String(a + b * c), answerLabel: "Answer:",
                    interactiveSteps: [
                        {
                            prompt: `In ${a} + ${b} × ${c}, we have addition and multiplication. Which do we do FIRST according to PEMDAS?`,
                            hint: "PEMDAS: Parentheses, Exponents, Multiplication/Division, Addition/Subtraction",
                            answer: "multiplication",
                            acceptableAnswers: ["multiplication", "multiply", "×", "the multiplication", `${b} × ${c}`],
                            commonMistakes: {
                                "addition": "Multiplication comes BEFORE addition in PEMDAS! Do ${b} × ${c} first."
                            }
                        },
                        {
                            prompt: `Do the multiplication first: ${b} × ${c} = ?`,
                            hint: `${b} times ${c}...`,
                            answer: String(b * c),
                            acceptableAnswers: [String(b * c)],
                            commonMistakes: {
                                [String(b + c)]: `That's ${b} + ${c}. We need ${b} × ${c} = ${b * c}`,
                                [String(a + b)]: `Do ${b} × ${c} first, not add ${a}. ${b} × ${c} = ${b * c}`
                            }
                        },
                        {
                            prompt: `Now we have: ${a} + ${b * c}. Calculate this:`,
                            hint: `${a} + ${b * c} = ?`,
                            answer: String(a + b * c),
                            acceptableAnswers: [String(a + b * c)],
                            commonMistakes: {
                                [String((a + b) * c)]: `That's (${a}+${b})×${c}. We already did the multiplication: ${a} + ${b * c} = ${a + b * c}`
                            }
                        },
                        {
                            prompt: `So ${a} + ${b} × ${c} = ?`,
                            hint: `Multiplication first (${b * c}), then add ${a}`,
                            answer: String(a + b * c),
                            acceptableAnswers: [String(a + b * c)],
                            commonMistakes: {
                                [String((a + b) * c)]: `Remember PEMDAS: multiply first! ${b} × ${c} = ${b * c}, then ${a} + ${b * c} = ${a + b * c}`
                            }
                        }
                    ]
                },
                practice: { problem: `Evaluate: 8 ÷ 2 + 3 × 4`, answer: "16",
                    options: ["16", "20", "7", "28"],
                    mistakeAnalysis: {
                        "20": "Check order: 8÷2=4, 3×4=12, then 4+12=16. Did you do 8÷(2+3)×4?",
                        "7": "Do × and ÷ first (left to right), then add: 8÷2=4, 3×4=12, 4+12=16",
                        "28": "Division and multiplication go left to right BEFORE adding: 4+12=16, not 8÷2×14"
                    }}
            };
        },
        Slope: () => {
            const rise = rand(1, 4), run = rand(2, 5);
            return {
                concept: `<strong>Slope</strong> measures how steep a line is - how much it rises or falls as you move right.<br><br>
                <strong>The formula:</strong><br>
                slope = rise/run = (change in y)/(change in x) = (y₂ - y₁)/(x₂ - x₁)<br><br>
                <strong>Types of slope:</strong><br>
                • <strong>Positive slope:</strong> Line goes UP as you move right ↗<br>
                • <strong>Negative slope:</strong> Line goes DOWN as you move right ↘<br>
                • <strong>Zero slope:</strong> Horizontal line (flat) →<br>
                • <strong>Undefined slope:</strong> Vertical line (straight up) ↑`,
                example: { problem: `Find the slope of the line through (1, 2) and (4, 8)`, steps: [
                    { text: "Identify the points", math: "(x₁, y₁) = (1, 2) and (x₂, y₂) = (4, 8)" },
                    { text: "Find the rise (change in y)", math: "rise = y₂ - y₁ = 8 - 2 = 6" },
                    { text: "Find the run (change in x)", math: "run = x₂ - x₁ = 4 - 1 = 3" },
                    { text: "Calculate slope = rise/run", math: "slope = 6/3 = <strong>2</strong>" },
                    { text: "Interpret: For every 1 unit right, the line goes up 2 units", math: "" }
                ]},
                keyPoints: [
                    "Slope = rise/run = vertical change / horizontal change",
                    "Positive slope: line goes up; Negative slope: line goes down",
                    "Slope of 2 means 'for every 1 right, go up 2'"
                ],
                mistakes: [
                    { wrong: "Putting run over rise (run/rise)", why: "Remember: RISE over RUN. The y-change (vertical) goes on TOP." },
                    { wrong: "Subtracting in different orders: (y₂-y₁)/(x₁-x₂)", why: "Use the SAME order: (y₂-y₁)/(x₂-x₁) OR (y₁-y₂)/(x₁-x₂)" },
                    { wrong: "Confusing which is rise and which is run", why: "Rise = up/down (y-values). Run = left/right (x-values)." }
                ],
                guided: { problem: `Find the slope of the line through (2, 3) and (${2 + run}, ${3 + rise})`, steps: [
                    { label: "Rise (change in y)", value: `${3 + rise} - 3 = ${rise}` },
                    { label: "Run (change in x)", value: `${2 + run} - 2 = ${run}` },
                    { label: "Slope = rise/run", value: "?" }
                ], answer: `${rise}/${run}`, answerLabel: "Slope:",
                    interactiveSteps: [
                        {
                            prompt: "Slope is calculated as rise over run. Which values give us the RISE (change in y)?",
                            hint: "Rise = vertical change = y-values (the second number in each point)",
                            answer: "y values",
                            acceptableAnswers: ["y values", "y", "the y values", "y-values", "3 and " + (3 + rise), (3 + rise) + " and 3"],
                            commonMistakes: {
                                "x values": "X-values give us the RUN (horizontal). Y-values give us the RISE (vertical)."
                            }
                        },
                        {
                            prompt: `Find the rise: y₂ - y₁ = ${3 + rise} - 3 = ?`,
                            hint: `${3 + rise} minus 3...`,
                            answer: String(rise),
                            acceptableAnswers: [String(rise)],
                            commonMistakes: {
                                [String(3 + rise)]: `You need to subtract! ${3 + rise} - 3 = ${rise}`,
                                [String(3 - (3 + rise))]: `Subtract in the right order: y₂ - y₁ = ${3 + rise} - 3 = ${rise}`
                            }
                        },
                        {
                            prompt: `Now find the run: x₂ - x₁ = ${2 + run} - 2 = ?`,
                            hint: `${2 + run} minus 2...`,
                            answer: String(run),
                            acceptableAnswers: [String(run)],
                            commonMistakes: {
                                [String(2 + run)]: `You need to subtract! ${2 + run} - 2 = ${run}`
                            }
                        },
                        {
                            prompt: `Slope = rise/run. With rise = ${rise} and run = ${run}, what is the slope?`,
                            hint: `Put rise over run: ${rise}/${run}`,
                            answer: `${rise}/${run}`,
                            acceptableAnswers: [`${rise}/${run}`, `${rise} / ${run}`, Number.isInteger(rise/run) ? String(rise/run) : `${rise}/${run}`],
                            commonMistakes: {
                                [`${run}/${rise}`]: `You put run over rise! Remember: RISE over RUN. The slope is ${rise}/${run}`
                            }
                        }
                    ]
                },
                practice: { problem: `Find the slope through (0, 0) and (4, 12)`, answer: "3",
                    options: ["1/3", "3", "4", "12"],
                    mistakeAnalysis: {
                        "1/3": "You put run over rise. Slope = rise/run = 12/4 = 3",
                        "4": "That's the x-coordinate. Slope = rise/run = (12-0)/(4-0) = 12/4 = 3",
                        "12": "That's the rise. Divide by the run: 12/4 = 3"
                    }}
            };
        },
        Pythagorean: () => {
            const a = rand(3, 5), b = rand(4, 8);
            const c = Math.sqrt(a * a + b * b);
            const cRounded = Math.round(c * 10) / 10;
            return {
                concept: `<strong>The Pythagorean Theorem</strong> applies to RIGHT triangles (triangles with a 90° angle).<br><br>
                <strong>The formula:</strong> a² + b² = c²<br><br>
                Where:<br>
                • <strong>a</strong> and <strong>b</strong> are the two shorter sides (legs)<br>
                • <strong>c</strong> is the longest side (hypotenuse) - ALWAYS opposite the right angle<br><br>
                <strong>Common Pythagorean triples (memorize these!):</strong><br>
                • 3, 4, 5<br>
                • 5, 12, 13<br>
                • 8, 15, 17`,
                example: { problem: `A right triangle has legs of 3 and 4. Find the hypotenuse.`, steps: [
                    { text: "Write the Pythagorean theorem", math: "a² + b² = c²" },
                    { text: "Substitute the known values", math: "3² + 4² = c²" },
                    { text: "Calculate the squares", math: "9 + 16 = c²" },
                    { text: "Add", math: "25 = c²" },
                    { text: "Take the square root", math: "c = √25 = <strong>5</strong>" }
                ]},
                keyPoints: [
                    "a² + b² = c² where c is the LONGEST side (hypotenuse)",
                    "Only works for RIGHT triangles (with a 90° angle)",
                    "Common triples: 3-4-5, 5-12-13, 8-15-17"
                ],
                mistakes: [
                    { wrong: "Adding sides instead of squaring: 3 + 4 = 7", why: "You must SQUARE each leg first: 3² + 4² = 9 + 16 = 25, then √25 = 5" },
                    { wrong: "Putting the hypotenuse on the left: c² + a² = b²", why: "The hypotenuse (c) MUST be alone on one side: a² + b² = c²" },
                    { wrong: "Forgetting to take the square root at the end", why: "c² = 25 means c = √25 = 5, not c = 25" }
                ],
                guided: { problem: `A right triangle has legs ${a} and ${b}. Find the hypotenuse.`, steps: [
                    { label: "a² + b² = c²", value: `${a}² + ${b}² = c²` },
                    { label: "Calculate squares", value: `${a*a} + ${b*b} = ${a*a + b*b}` },
                    { label: "c = √${a*a + b*b} =", value: "?" }
                ], answer: Number.isInteger(c) ? String(c) : String(cRounded), answerLabel: "Hypotenuse:",
                    interactiveSteps: [
                        {
                            prompt: "What is the Pythagorean theorem formula? (use a, b, c)",
                            hint: "The squares of the two legs equal the square of the hypotenuse... Format: a² + b² = c² or a^2 + b^2 = c^2",
                            answer: "a² + b² = c²",
                            acceptableAnswers: ["a² + b² = c²", "a^2 + b^2 = c^2", "a2 + b2 = c2", "a^2+b^2=c^2", "a2+b2=c2", "a squared + b squared = c squared", "a squared plus b squared equals c squared", "c² = a² + b²", "c^2 = a^2 + b^2", "c2 = a2 + b2"],
                            formatHint: "e.g., a^2 + b^2 = c^2 or a² + b² = c²",
                            commonMistakes: {
                                "a + b = c": "You need to SQUARE each side! a² + b² = c²",
                                "a × b = c": "Multiply? No, it's the SUM of the SQUARES: a² + b² = c²"
                            }
                        },
                        {
                            prompt: `Calculate ${a}² (${a} squared):`,
                            hint: `${a} × ${a} = ?`,
                            answer: String(a * a),
                            acceptableAnswers: [String(a * a)],
                            commonMistakes: {
                                [String(a * 2)]: `That's ${a} × 2. Squaring means ${a} × ${a} = ${a * a}`,
                                [String(a)]: `You need to square it! ${a}² = ${a} × ${a} = ${a * a}`
                            }
                        },
                        {
                            prompt: `Calculate ${b}² (${b} squared):`,
                            hint: `${b} × ${b} = ?`,
                            answer: String(b * b),
                            acceptableAnswers: [String(b * b)],
                            commonMistakes: {
                                [String(b * 2)]: `That's ${b} × 2. Squaring means ${b} × ${b} = ${b * b}`
                            }
                        },
                        {
                            prompt: `Add the squares: ${a * a} + ${b * b} = ?`,
                            hint: `This gives us c²...`,
                            answer: String(a * a + b * b),
                            acceptableAnswers: [String(a * a + b * b)],
                            commonMistakes: {
                                [String(a * a * b * b)]: `Add, don't multiply! ${a * a} + ${b * b} = ${a * a + b * b}`
                            }
                        },
                        {
                            prompt: `c² = ${a * a + b * b}. To find c, take the square root: √${a * a + b * b} = ?`,
                            hint: `What number times itself equals ${a * a + b * b}?`,
                            answer: Number.isInteger(c) ? String(c) : String(cRounded),
                            acceptableAnswers: Number.isInteger(c) ? [String(c)] : [String(cRounded), String(Math.round(c)), c.toFixed(1), c.toFixed(2)],
                            commonMistakes: {
                                [String(a * a + b * b)]: `That's c². You need to take the square root to find c. √${a * a + b * b} ≈ ${cRounded}`
                            }
                        }
                    ]
                },
                practice: { problem: `A right triangle has legs 6 and 8. Find the hypotenuse.`, answer: "10",
                    options: ["10", "14", "48", "100"],
                    mistakeAnalysis: {
                        "14": "You added 6 + 8 = 14. You must square first: 6² + 8² = 36 + 64 = 100, then √100 = 10",
                        "48": "That's 6 × 8. Use a² + b² = c²: 36 + 64 = 100, c = √100 = 10",
                        "100": "That's c². Take the square root: √100 = 10"
                    }}
            };
        },
        "Surface Area": () => {
            const l = rand(3, 6), w = rand(2, 5), h = rand(2, 4);
            const sa = 2 * (l * w + l * h + w * h);
            return {
                goalProblem: `Find the surface area of a rectangular prism: length = 4, width = 3, height = 2`,
                teachingSteps: [
                    {
                        title: "What is surface area?",
                        explanation: "<strong>Surface area</strong> is the total area of ALL the faces (outside surfaces) of a 3D shape. Imagine wrapping the shape in paper - how much paper do you need?",
                        visual: "Surface Area = area of all outside faces"
                    },
                    {
                        title: "A rectangular prism has 6 faces",
                        explanation: "A box shape has 6 rectangular faces: <strong>top/bottom</strong>, <strong>front/back</strong>, and <strong>left/right</strong>. Opposite faces are identical!",
                        visual: "6 faces: 2 top/bottom, 2 front/back, 2 left/right"
                    },
                    {
                        title: "Find the area of each pair",
                        explanation: "• Top/Bottom: length × width = 4 × 3 = 12 (×2 = 24)<br>• Front/Back: length × height = 4 × 2 = 8 (×2 = 16)<br>• Left/Right: width × height = 3 × 2 = 6 (×2 = 12)",
                        visual: "2(l×w) + 2(l×h) + 2(w×h)"
                    },
                    {
                        title: "The formula",
                        explanation: "<strong>SA = 2lw + 2lh + 2wh</strong> or SA = 2(lw + lh + wh). Both give the same answer!",
                        visual: "SA = 2(lw + lh + wh)"
                    },
                    {
                        title: "Calculate!",
                        explanation: "SA = 2(4×3 + 4×2 + 3×2) = 2(12 + 8 + 6) = 2(26) = <strong>52 square units</strong>",
                        visual: "SA = 52 square units"
                    }
                ],
                finalAnswer: "52 square units",
                answerExplanation: "SA = 2(lw + lh + wh) = 2(12 + 8 + 6) = 2(26) = 52 square units",
                example: { problem: `Find the surface area: l=4, w=3, h=2`, steps: [
                    { text: "Identify the three different face types", math: "top/bottom, front/back, left/right" },
                    { text: "Calculate each face area", math: "l×w=12, l×h=8, w×h=6" },
                    { text: "Double each (opposite faces)", math: "24 + 16 + 12" },
                    { text: "Add all faces", math: "<strong>SA = 52 sq units</strong>" }
                ]},
                keyPoints: [
                    "Surface area = total area of ALL outside faces",
                    "Rectangular prism: SA = 2lw + 2lh + 2wh",
                    "Cube: SA = 6s² (all faces are identical squares)"
                ],
                mistakes: [
                    { wrong: "Finding volume instead: l × w × h = 24", why: "That's VOLUME (inside space). Surface area is the OUTSIDE area of all faces." },
                    { wrong: "Forgetting to multiply by 2", why: "Each face type appears TWICE (front/back, top/bottom, left/right)." },
                    { wrong: "Only finding one face: 4 × 3 = 12", why: "There are 6 faces total! Add all pairs: 2(12) + 2(8) + 2(6) = 52" }
                ],
                guided: {
                    problem: `Find the surface area of a rectangular prism: l=${l}, w=${w}, h=${h}`,
                    steps: [
                        { label: "Top/Bottom area (l×w)", value: `${l} × ${w} = ${l * w}` },
                        { label: "Front/Back area (l×h)", value: `${l} × ${h} = ${l * h}` },
                        { label: "Left/Right area (w×h)", value: `${w} × ${h} = ${w * h}` },
                        { label: "Total SA = 2(all three)", value: "?" }
                    ],
                    answer: String(sa),
                    answerLabel: "Surface Area:",
                    interactiveSteps: [
                        {
                            prompt: "How many faces does a rectangular prism (box) have?",
                            hint: "Count: top, bottom, front, back, left, right...",
                            answer: "6",
                            acceptableAnswers: ["6", "six"],
                            commonMistakes: {
                                "4": "That's a rectangle! A 3D box has 6 faces.",
                                "8": "That's the number of corners (vertices). Faces = 6."
                            }
                        },
                        {
                            prompt: `Calculate the top/bottom face area: ${l} × ${w} = ?`,
                            hint: "Length times width...",
                            answer: String(l * w),
                            acceptableAnswers: [String(l * w)],
                            commonMistakes: {
                                [String(l + w)]: `Multiply, not add! ${l} × ${w} = ${l * w}`
                            }
                        },
                        {
                            prompt: `Calculate the front/back face area: ${l} × ${h} = ?`,
                            hint: "Length times height...",
                            answer: String(l * h),
                            acceptableAnswers: [String(l * h)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate the left/right face area: ${w} × ${h} = ?`,
                            hint: "Width times height...",
                            answer: String(w * h),
                            acceptableAnswers: [String(w * h)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now find total SA: 2(${l * w} + ${l * h} + ${w * h}) = 2(${l * w + l * h + w * h}) = ?`,
                            hint: "Multiply the sum by 2...",
                            answer: String(sa),
                            acceptableAnswers: [String(sa), sa + " square units"],
                            commonMistakes: {
                                [String(l * w + l * h + w * h)]: `Don't forget to multiply by 2! Each face type appears twice: 2 × ${l * w + l * h + w * h} = ${sa}`,
                                [String(l * w * h)]: `That's volume! Surface area = 2(lw + lh + wh) = ${sa}`
                            }
                        }
                    ]
                },
                practice: (() => { const pl = 5, pw = 4, ph = 3, psa = 2 * (pl * pw + pl * ph + pw * ph); return {
                    problem: `Find the surface area: l=${pl}, w=${pw}, h=${ph}`, answer: String(psa),
                    options: shuffle([String(psa), String(pl * pw * ph), String(pl * pw + pl * ph + pw * ph), String(2 * pl * pw)]),
                    mistakeAnalysis: {
                        [String(pl * pw * ph)]: "That's VOLUME (l×w×h). Surface area = 2(lw + lh + wh)",
                        [String(pl * pw + pl * ph + pw * ph)]: "Close! But you forgot to multiply by 2. Each face appears twice.",
                        [String(2 * pl * pw)]: "That's just the top and bottom. Include all 6 faces!"
                    }}; })()
            };
        },
        "Two-Way Tables": () => {
            const a = rand(10, 20), b = rand(15, 25), c = rand(12, 22), d = rand(8, 18);
            const total = a + b + c + d;
            return {
                goalProblem: `Use the two-way table to find how many students play sports`,
                teachingSteps: [
                    {
                        title: "What is a two-way table?",
                        explanation: "A <strong>two-way table</strong> displays data for TWO categorical variables. It shows how data falls into different combinations of categories.",
                        visual: "Rows = one variable, Columns = another variable"
                    },
                    {
                        title: "Reading a two-way table",
                        explanation: "Example: Students surveyed about sports and music.<br><table border='1' style='border-collapse:collapse;margin:10px 0'><tr><th></th><th>Plays Sports</th><th>No Sports</th></tr><tr><td>Plays Music</td><td>15</td><td>10</td></tr><tr><td>No Music</td><td>20</td><td>5</td></tr></table>",
                        visual: "Each cell shows count for that combination"
                    },
                    {
                        title: "Finding row/column totals",
                        explanation: "Add across for row totals, add down for column totals.<br>• Plays Sports total: 15 + 20 = 35<br>• Plays Music total: 15 + 10 = 25",
                        visual: "Row totals: add across | Column totals: add down"
                    },
                    {
                        title: "Finding the grand total",
                        explanation: "Add ALL cells: 15 + 10 + 20 + 5 = <strong>50 students</strong>. Or add row totals: 25 + 25 = 50.",
                        visual: "Grand Total = 50"
                    },
                    {
                        title: "Answering questions",
                        explanation: "How many play sports? Add the 'Plays Sports' column: 15 + 20 = <strong>35 students</strong>.",
                        visual: "35 students play sports"
                    }
                ],
                finalAnswer: "35 students",
                answerExplanation: "Add the 'Plays Sports' column: 15 + 20 = 35 students play sports.",
                example: { problem: `How many students play sports?`, steps: [
                    { text: "Find the 'Plays Sports' column", math: "Values: 15 and 20" },
                    { text: "Add the column", math: "15 + 20 = 35" },
                    { text: "Answer", math: "<strong>35 students play sports</strong>" }
                ]},
                keyPoints: [
                    "Two-way tables show data for two categorical variables",
                    "Row totals = add across, Column totals = add down",
                    "Grand total = sum of all cells (or sum of all row totals)"
                ],
                mistakes: [
                    { wrong: "Reading the wrong cell", why: "Check both the row AND column headers to find the right cell." },
                    { wrong: "Confusing row and column totals", why: "Row totals are at the END of rows; column totals are at the BOTTOM of columns." },
                    { wrong: "Only counting one cell for a total", why: "Totals require adding ALL cells in that row or column." }
                ],
                guided: {
                    problem: `<table border='1' style='border-collapse:collapse;margin:10px auto;'><tr><th></th><th>Cat</th><th>Dog</th></tr><tr><td>Boy</td><td>${a}</td><td>${b}</td></tr><tr><td>Girl</td><td>${c}</td><td>${d}</td></tr></table><br>How many students have dogs?`,
                    steps: [
                        { label: "Find the 'Dog' column", value: `${b} and ${d}` },
                        { label: "Add them", value: "?" }
                    ],
                    answer: String(b + d),
                    answerLabel: "Students with dogs:",
                    interactiveSteps: [
                        {
                            prompt: "To find how many have dogs, click the column we need to look at:",
                            hint: "Click on the column header that matches what we're looking for...",
                            answer: "Dog",
                            acceptableAnswers: ["Dog", "dog", "the dog column", "dogs"],
                            selectOptions: [
                                { label: "Cat Column", value: "Cat" },
                                { label: "Dog Column", value: "Dog" }
                            ],
                            commonMistakes: {
                                "Cat": "We want dogs, not cats! The question asks about dogs."
                            }
                        },
                        {
                            prompt: `In the Dog column, what are the two values? (Click the values)`,
                            hint: "One for boys, one for girls...",
                            answer: `${b} and ${d}`,
                            acceptableAnswers: [`${b} and ${d}`, `${d} and ${b}`, `${b}, ${d}`, `${b} ${d}`],
                            selectOptions: [
                                { label: `${a} and ${b} (Boy row)`, value: `${a} and ${b}` },
                                { label: `${b} and ${d} (Dog column)`, value: `${b} and ${d}` },
                                { label: `${c} and ${d} (Girl row)`, value: `${c} and ${d}` },
                                { label: `${a} and ${c} (Cat column)`, value: `${a} and ${c}` }
                            ],
                            commonMistakes: {
                                [`${a} and ${b}`]: `That's the Boy row. The Dog column has ${b} and ${d}.`,
                                [`${c} and ${d}`]: `That's the Girl row. The Dog column has ${b} and ${d}.`,
                                [`${a} and ${c}`]: `That's the Cat column. We need the Dog column: ${b} and ${d}.`
                            }
                        },
                        {
                            prompt: `Add the Dog column: ${b} + ${d} = ?`,
                            hint: "Add the two values...",
                            answer: String(b + d),
                            acceptableAnswers: [String(b + d)],
                            commonMistakes: {
                                [String(a + b + c + d)]: `That's the grand total. Just the Dog column: ${b} + ${d} = ${b + d}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = 12, pb = 18, pc = 15, pd = 10; return {
                    problem: `<table border='1' style='border-collapse:collapse'><tr><th></th><th>Pizza</th><th>Tacos</th></tr><tr><td>6th Grade</td><td>${pa}</td><td>${pb}</td></tr><tr><td>7th Grade</td><td>${pc}</td><td>${pd}</td></tr></table><br>How many students prefer pizza?`, answer: String(pa + pc),
                    options: shuffle([String(pa + pc), String(pb + pd), String(pa + pb), String(pa + pb + pc + pd)]),
                    mistakeAnalysis: {
                        [String(pb + pd)]: "That's tacos! Pizza column: " + pa + " + " + pc + " = " + (pa + pc),
                        [String(pa + pb)]: "That's the 6th grade row. Pizza column: " + pa + " + " + pc + " = " + (pa + pc),
                        [String(pa + pb + pc + pd)]: "That's everyone! Just Pizza column: " + pa + " + " + pc + " = " + (pa + pc)
                    }}; })()
            };
        },
        "Scatter Plots": () => {
            return {
                goalProblem: `Describe the correlation shown in a scatter plot`,
                teachingSteps: [
                    {
                        title: "What is a scatter plot?",
                        explanation: "A <strong>scatter plot</strong> shows the relationship between two numerical variables. Each point represents one data pair (x, y).",
                        visual: "Points on a graph showing relationship"
                    },
                    {
                        title: "Types of correlation",
                        explanation: "<strong>Positive correlation:</strong> As x increases, y increases (points go up-right ↗)<br><strong>Negative correlation:</strong> As x increases, y decreases (points go down-right ↘)<br><strong>No correlation:</strong> No clear pattern (scattered randomly)",
                        visual: "↗ positive | ↘ negative | • • scattered = none"
                    },
                    {
                        title: "Strength of correlation",
                        explanation: "<strong>Strong:</strong> Points closely follow a line<br><strong>Weak:</strong> Points loosely follow a pattern<br><strong>None:</strong> No pattern at all",
                        visual: "Close together = strong | Spread out = weak"
                    },
                    {
                        title: "Line of best fit",
                        explanation: "A <strong>line of best fit</strong> is a straight line that comes closest to all the points. It helps us make predictions.",
                        visual: "Line through the 'middle' of the points"
                    },
                    {
                        title: "Making predictions",
                        explanation: "Use the line of best fit to predict y-values for x-values not in your data. But be careful about extrapolating too far!",
                        visual: "Use the line to estimate unknown values"
                    }
                ],
                finalAnswer: "Identify correlation type and strength",
                answerExplanation: "Look at the overall pattern: up-right = positive, down-right = negative, random = none. Closeness to a line = strength.",
                example: { problem: `A scatter plot shows study hours vs test scores. Points trend upward from left to right.`, steps: [
                    { text: "Direction of points?", math: "Upward from left to right ↗" },
                    { text: "This indicates", math: "Positive correlation" },
                    { text: "Interpretation", math: "More study hours → higher scores" },
                    { text: "If points are close together", math: "<strong>Strong positive correlation</strong>" }
                ]},
                keyPoints: [
                    "Positive: both variables increase together",
                    "Negative: one increases as the other decreases",
                    "Correlation does NOT mean causation!"
                ],
                mistakes: [
                    { wrong: "Confusing positive and negative", why: "Positive goes UP (↗) as you move right. Negative goes DOWN (↘)." },
                    { wrong: "Assuming correlation means causation", why: "Just because two things correlate doesn't mean one CAUSES the other!" },
                    { wrong: "Ignoring outliers", why: "Outliers (points far from the pattern) can affect the line of best fit." }
                ],
                guided: {
                    problem: `A scatter plot shows hours of sleep vs energy level. As sleep increases, energy increases. The points are close to a line.`,
                    steps: [
                        { label: "Both variables increase together", value: "Positive correlation" },
                        { label: "Points close to a line", value: "Strong correlation" },
                        { label: "Full description", value: "?" }
                    ],
                    answer: "strong positive correlation",
                    answerLabel: "Correlation type:",
                    interactiveSteps: [
                        {
                            prompt: "If both variables INCREASE together, is this positive or negative correlation?",
                            hint: "Positive means they move in the same direction...",
                            answer: "positive",
                            acceptableAnswers: ["positive", "positive correlation"],
                            commonMistakes: {
                                "negative": "Negative means one goes up while the other goes down. Both increasing = positive!"
                            }
                        },
                        {
                            prompt: "If the points are close to a line (not scattered), is the correlation strong or weak?",
                            hint: "Close together means a clearer pattern...",
                            answer: "strong",
                            acceptableAnswers: ["strong", "strong correlation"],
                            commonMistakes: {
                                "weak": "Weak means points are spread out. Close to a line = strong!"
                            }
                        },
                        {
                            prompt: "Describe the correlation: _____ _____ correlation",
                            hint: "Combine strength and direction...",
                            answer: "strong positive",
                            acceptableAnswers: ["strong positive", "strong positive correlation"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A scatter plot shows age vs shoe size for children. Points trend upward and are fairly close together. What type of correlation?`, answer: "strong positive",
                    options: ["strong positive", "weak positive", "strong negative", "no correlation"],
                    mistakeAnalysis: {
                        "weak positive": "The points are close together, so it's STRONG, not weak.",
                        "strong negative": "Upward trend means POSITIVE. Negative would trend downward.",
                        "no correlation": "There IS a pattern (upward trend). No correlation means random scatter."
                    }}
            };
        },
        "Box Plots": () => {
            const min = rand(10, 20), q1 = min + rand(5, 10), med = q1 + rand(5, 10), q3 = med + rand(5, 10), max = q3 + rand(5, 10);
            const iqr = q3 - q1;
            return {
                goalProblem: `Find the IQR from a box plot with Q1 = 25 and Q3 = 45`,
                teachingSteps: [
                    {
                        title: "What is a box plot?",
                        explanation: "A <strong>box plot</strong> (box-and-whisker plot) shows how data is spread out using 5 key values: minimum, Q1, median, Q3, and maximum.",
                        visual: "Shows spread of data with box and whiskers"
                    },
                    {
                        title: "The five-number summary",
                        explanation: "• <strong>Minimum:</strong> Smallest value<br>• <strong>Q1:</strong> 25th percentile (25% below)<br>• <strong>Median:</strong> Middle value (50%)<br>• <strong>Q3:</strong> 75th percentile (75% below)<br>• <strong>Maximum:</strong> Largest value",
                        visual: "Min---[Q1---Median---Q3]---Max"
                    },
                    {
                        title: "Reading a box plot",
                        explanation: "The <strong>box</strong> contains the middle 50% of data (from Q1 to Q3). The <strong>whiskers</strong> extend to the min and max. The line inside the box is the median.",
                        visual: "Box = middle 50% | Whiskers = rest"
                    },
                    {
                        title: "Interquartile Range (IQR)",
                        explanation: "The <strong>IQR</strong> measures spread of the middle 50%. <strong>IQR = Q3 - Q1</strong>. For Q1=25 and Q3=45: IQR = 45 - 25 = <strong>20</strong>",
                        visual: "IQR = Q3 - Q1 = 45 - 25 = 20"
                    },
                    {
                        title: "Why IQR matters",
                        explanation: "IQR shows how spread out the middle data is. A larger IQR means more variability. IQR is not affected by outliers!",
                        visual: "IQR = 20"
                    }
                ],
                finalAnswer: "IQR = 20",
                answerExplanation: "IQR = Q3 - Q1 = 45 - 25 = 20. The middle 50% of data spans 20 units.",
                example: { problem: `Find the IQR: Q1 = 25, Q3 = 45`, steps: [
                    { text: "Recall the formula", math: "IQR = Q3 - Q1" },
                    { text: "Substitute the values", math: "IQR = 45 - 25" },
                    { text: "Calculate", math: "<strong>IQR = 20</strong>" }
                ]},
                keyPoints: [
                    "Five-number summary: Min, Q1, Median, Q3, Max",
                    "IQR = Q3 - Q1 (measures spread of middle 50%)",
                    "Box = middle 50%, Whiskers = min to Q1 and Q3 to max"
                ],
                mistakes: [
                    { wrong: "IQR = Q1 - Q3 (subtracting wrong way)", why: "Always Q3 - Q1 (larger minus smaller) for a positive IQR." },
                    { wrong: "Using min and max for IQR", why: "That's the RANGE. IQR uses Q1 and Q3 only." },
                    { wrong: "Confusing median with mean", why: "Median is the middle VALUE. Mean is the average (add all, divide by count)." }
                ],
                guided: {
                    problem: `A box plot shows: Min=${min}, Q1=${q1}, Median=${med}, Q3=${q3}, Max=${max}. Find the IQR.`,
                    steps: [
                        { label: "IQR formula", value: "IQR = Q3 - Q1" },
                        { label: "Substitute", value: `IQR = ${q3} - ${q1}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(iqr),
                    answerLabel: "IQR =",
                    interactiveSteps: [
                        {
                            prompt: "What does IQR stand for?",
                            hint: "It's about the range between quartiles...",
                            answer: "interquartile range",
                            acceptableAnswers: ["interquartile range", "inter-quartile range", "iqr", "inter quartile range", "the interquartile range"],
                            formatHint: "e.g., interquartile range",
                            commonMistakes: {
                                "range": "Just 'range' is max - min. IQR is specifically Inter-QUARTILE Range (Q3 - Q1)."
                            }
                        },
                        {
                            prompt: "The IQR formula is: IQR = ___ - ___",
                            hint: "Which two quartiles? (enter like: Q3 - Q1)",
                            answer: "Q3 - Q1",
                            acceptableAnswers: ["Q3 - Q1", "q3 - q1", "Q3-Q1", "q3-q1", "q3 minus q1", "Q3 minus Q1", "third quartile - first quartile", "third quartile minus first quartile"],
                            formatHint: "e.g., Q3 - Q1",
                            commonMistakes: {
                                "Q1 - Q3": "Order matters! It's Q3 - Q1 (larger minus smaller).",
                                "max - min": "That's the full range. IQR = Q3 - Q1."
                            }
                        },
                        {
                            prompt: `Calculate: ${q3} - ${q1} = ?`,
                            hint: "Subtract Q1 from Q3...",
                            answer: String(iqr),
                            acceptableAnswers: [String(iqr)],
                            commonMistakes: {
                                [String(q3 + q1)]: `Subtract, not add! ${q3} - ${q1} = ${iqr}`,
                                [String(max - min)]: `That's the full range. IQR = ${q3} - ${q1} = ${iqr}`
                            }
                        }
                    ]
                },
                practice: (() => { const pq1 = 30, pq3 = 55; return {
                    problem: `A box plot has Q1 = ${pq1} and Q3 = ${pq3}. Find the IQR.`, answer: String(pq3 - pq1),
                    options: shuffle([String(pq3 - pq1), String(pq1 + pq3), String(pq3), String(pq1)]),
                    mistakeAnalysis: {
                        [String(pq1 + pq3)]: `You added! IQR = Q3 - Q1 = ${pq3} - ${pq1} = ${pq3 - pq1}`,
                        [String(pq3)]: `That's just Q3. IQR = Q3 - Q1 = ${pq3} - ${pq1} = ${pq3 - pq1}`,
                        [String(pq1)]: `That's just Q1. IQR = Q3 - Q1 = ${pq3} - ${pq1} = ${pq3 - pq1}`
                    }}; })()
            };
        },
        "Probability Basics": () => {
            const favorable = rand(2, 5), total = rand(8, 12);
            return {
                goalProblem: `A bag has 3 red and 5 blue marbles. What's the probability of picking red?`,
                teachingSteps: [
                    {
                        title: "What is probability?",
                        explanation: "<strong>Probability</strong> measures how likely an event is to happen. It's always between 0 (impossible) and 1 (certain).",
                        visual: "0 = impossible | 1 = certain"
                    },
                    {
                        title: "The probability formula",
                        explanation: "<strong>P(event) = favorable outcomes / total outcomes</strong><br>Favorable = what you WANT to happen<br>Total = ALL possible outcomes",
                        visual: "P = favorable / total"
                    },
                    {
                        title: "Apply to our problem",
                        explanation: "Bag has 3 red + 5 blue = 8 total marbles.<br>Favorable (red) = 3<br>Total = 8",
                        visual: "3 red out of 8 total"
                    },
                    {
                        title: "Calculate the probability",
                        explanation: "P(red) = favorable/total = 3/8. This can also be written as 0.375 or 37.5%",
                        visual: "P(red) = 3/8 = 0.375 = 37.5%"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>P(red) = 3/8</strong>. There's a 3 in 8 chance of picking a red marble.",
                        visual: "P(red) = 3/8"
                    }
                ],
                finalAnswer: "3/8",
                answerExplanation: "P(red) = favorable/total = 3 red / 8 total = 3/8",
                example: { problem: `3 red and 5 blue marbles. P(red)?`, steps: [
                    { text: "Count favorable outcomes", math: "3 red marbles" },
                    { text: "Count total outcomes", math: "3 + 5 = 8 marbles" },
                    { text: "Apply formula", math: "P(red) = 3/8" },
                    { text: "Answer", math: "<strong>P(red) = 3/8</strong>" }
                ]},
                keyPoints: [
                    "P(event) = favorable outcomes / total outcomes",
                    "Probability is always between 0 and 1 (or 0% to 100%)",
                    "P(not A) = 1 - P(A)"
                ],
                mistakes: [
                    { wrong: "P(red) = 3/5 (using other outcome as total)", why: "Total is ALL outcomes: 3 + 5 = 8. P(red) = 3/8" },
                    { wrong: "Probability > 1", why: "Probability can NEVER exceed 1. Check your fraction!" },
                    { wrong: "Confusing favorable and total", why: "Favorable = what you want. Total = everything possible." }
                ],
                guided: {
                    problem: `A spinner has ${favorable} green and ${total - favorable} yellow sections. What's P(green)?`,
                    steps: [
                        { label: "Favorable (green sections)", value: String(favorable) },
                        { label: "Total sections", value: `${favorable} + ${total - favorable} = ${total}` },
                        { label: "P(green) = favorable/total", value: "?" }
                    ],
                    answer: `${favorable}/${total}`,
                    answerLabel: "P(green) =",
                    interactiveSteps: [
                        {
                            prompt: "What is the probability formula?",
                            hint: "P = something / something...",
                            answer: "favorable / total",
                            acceptableAnswers: ["favorable / total", "favorable/total", "favorable outcomes / total outcomes"],
                            commonMistakes: {
                                "total / favorable": "It's FAVORABLE over TOTAL, not the other way around!"
                            }
                        },
                        {
                            prompt: `How many favorable outcomes (green sections)?`,
                            hint: "Count the green sections...",
                            answer: String(favorable),
                            acceptableAnswers: [String(favorable)],
                            commonMistakes: {
                                [String(total - favorable)]: `That's yellow! Green = ${favorable}`
                            }
                        },
                        {
                            prompt: `How many total sections?`,
                            hint: "Add green + yellow...",
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            commonMistakes: {
                                [String(favorable)]: `That's just green. Total = ${favorable} + ${total - favorable} = ${total}`
                            }
                        },
                        {
                            prompt: `Calculate P(green) = ${favorable}/${total}. Express as a fraction.`,
                            hint: "Favorable over total...",
                            answer: `${favorable}/${total}`,
                            acceptableAnswers: [`${favorable}/${total}`, `${favorable} / ${total}`],
                            commonMistakes: {
                                [`${total}/${favorable}`]: `Flip it! P = favorable/total = ${favorable}/${total}`
                            }
                        }
                    ]
                },
                practice: (() => { const pf = 4, pt = 10; return {
                    problem: `A bag has ${pf} red and ${pt - pf} blue marbles. P(red)?`, answer: `${pf}/${pt}`,
                    options: [`${pf}/${pt}`, `${pt - pf}/${pt}`, `${pf}/${pt - pf}`, `${pt}/${pf}`],
                    mistakeAnalysis: {
                        [`${pt - pf}/${pt}`]: `That's P(blue)! P(red) = ${pf}/${pt}`,
                        [`${pf}/${pt - pf}`]: `Total is ${pt}, not ${pt - pf}. P(red) = ${pf}/${pt}`,
                        [`${pt}/${pf}`]: `Flip it! P = favorable/total = ${pf}/${pt}`
                    }}; })()
            };
        }
    },
    5: {
        "Linear Equations": () => {
            const x = rand(2, 8), a = rand(2, 5), b = rand(3, 12);
            const c = a * x + b;
            return {
                goalProblem: `Solve: 3x + 7 = 22`,
                teachingSteps: [
                    {
                        title: "This is a two-step equation",
                        explanation: "Two-step equations require <strong>two operations</strong> to isolate x. We need to undo what's being done to x, one step at a time.",
                        visual: "3x + 7 = 22 → need 2 steps to find x"
                    },
                    {
                        title: "Identify operations on x",
                        explanation: "Look at the left side: x is being <strong>multiplied by 3</strong>, then <strong>7 is added</strong>. We'll undo these in reverse order.",
                        visual: "x → ×3 → +7 → result"
                    },
                    {
                        title: "Step 1: Undo the addition first",
                        explanation: "The outer operation is +7. Undo it by <strong>subtracting 7</strong> from both sides: 3x + 7 - 7 = 22 - 7",
                        visual: "3x + 7 - 7 = 22 - 7 → 3x = 15"
                    },
                    {
                        title: "Step 2: Undo the multiplication",
                        explanation: "Now we have 3x = 15. Undo the ×3 by <strong>dividing both sides by 3</strong>: 3x ÷ 3 = 15 ÷ 3",
                        visual: "3x ÷ 3 = 15 ÷ 3 → x = 5"
                    },
                    {
                        title: "Check your answer!",
                        explanation: "Substitute x = 5 back into the original: 3(5) + 7 = 15 + 7 = 22 ✓ It works!",
                        visual: "x = 5"
                    }
                ],
                finalAnswer: "x = 5",
                answerExplanation: "First subtract 7 from both sides (3x = 15), then divide by 3 (x = 5). Always check: 3(5) + 7 = 22 ✓",
                example: { problem: `Solve: 3x + 7 = 22`, steps: [
                    { text: "Identify operations on x", math: "x is multiplied by 3, then 7 is added" },
                    { text: "Step 1: Undo addition (subtract 7 from both sides)", math: "3x + 7 - 7 = 22 - 7" },
                    { text: "Simplify", math: "3x = 15" },
                    { text: "Step 2: Undo multiplication (divide both sides by 3)", math: "3x ÷ 3 = 15 ÷ 3" },
                    { text: "Simplify", math: "x = <strong>5</strong>" },
                    { text: "Check: 3(5) + 7 = 15 + 7 = 22 ✓", math: "" }
                ]},
                keyPoints: [
                    "Undo addition/subtraction FIRST, then multiplication/division",
                    "Whatever you do to one side, you MUST do to the other",
                    "Always check your answer by substituting it back into the original equation"
                ],
                mistakes: [
                    { wrong: "Dividing before subtracting: 3x + 7 = 22 → x + 7 = 22/3", why: "You must undo the outer operation first. Subtract 7, THEN divide by 3." },
                    { wrong: "Only operating on part of a side: 3x + 7 = 22 → 3x = 22 - 7 but forgetting to simplify", why: "Always simplify: 22 - 7 = 15, so 3x = 15" },
                    { wrong: "Dividing only one term: 3x + 7 = 22 → x + 7 = 22/3", why: "When dividing, EVERY term on the left would need to be divided. That's why we subtract first!" }
                ],
                guided: { problem: `Solve: ${a}x + ${b} = ${c}`, steps: [
                    { label: `Step 1: Subtract ${b} from both sides`, value: `${a}x = ${c} - ${b} = ${c - b}` },
                    { label: `Step 2: Divide both sides by ${a}`, value: `x = ${c - b} ÷ ${a} = ?` },
                    { label: "Check your answer", value: `${a}(?) + ${b} should equal ${c}` }
                ], answer: String(x), answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}x + ${b} = ${c}, we need to isolate x. What should we undo FIRST - the multiplication or the addition?`,
                            hint: "Think about order of operations in reverse. Undo the OUTER operation first.",
                            answer: "addition",
                            acceptableAnswers: ["addition", "add", "the addition", "+ " + b, "adding"],
                            commonMistakes: {
                                "multiplication": "Undo operations in REVERSE order. Addition was done last, so undo it first by subtracting."
                            }
                        },
                        {
                            prompt: `Subtract ${b} from both sides. What is ${c} - ${b}?`,
                            hint: `${c} minus ${b}...`,
                            answer: String(c - b),
                            acceptableAnswers: [String(c - b)],
                            commonMistakes: {
                                [String(c + b)]: `Subtract, not add! ${c} - ${b} = ${c - b}`,
                                [String(c)]: `You need to subtract ${b}: ${c} - ${b} = ${c - b}`
                            }
                        },
                        {
                            prompt: `Now we have ${a}x = ${c - b}. To get x alone, we need to undo the multiplication. Divide both sides by what?`,
                            hint: `x is being multiplied by ${a}...`,
                            answer: String(a),
                            acceptableAnswers: [String(a), "by " + a],
                            commonMistakes: {
                                [String(c - b)]: `We divide by the coefficient of x, which is ${a}`,
                                [String(x)]: `We don't know x yet! Divide by ${a} to find it.`
                            }
                        },
                        {
                            prompt: `Calculate: ${c - b} ÷ ${a} = ?`,
                            hint: `${c - b} divided by ${a}...`,
                            answer: String(x),
                            acceptableAnswers: [String(x)],
                            commonMistakes: {
                                [String((c - b) * a)]: `Divide, not multiply! ${c - b} ÷ ${a} = ${x}`,
                                [String(c - b)]: `You still need to divide: ${c - b} ÷ ${a} = ${x}`
                            }
                        },
                        {
                            prompt: `Check: Does ${a}(${x}) + ${b} = ${c}?`,
                            hint: `Calculate ${a} × ${x} + ${b}...`,
                            answer: "yes",
                            acceptableAnswers: ["yes", String(c), "correct", "true"],
                            commonMistakes: {
                                "no": `${a} × ${x} = ${a * x}, then ${a * x} + ${b} = ${c} ✓ It works!`
                            }
                        }
                    ]
                },
                practice: (() => { const newB = b + 3; const newC = a * x + newB; return {
                    problem: `Solve: ${a}x + ${newB} = ${newC}`, answer: String(x),
                    options: shuffle([String(x), String(Math.floor(newC / a)), String(newC), String(newC - newB)]),
                    mistakeAnalysis: {
                        [String(Math.floor(newC / a))]: `You divided ${newC} by ${a} without subtracting ${newB} first. Do: ${newC} - ${newB} = ${newC - newB}, then ${newC - newB} ÷ ${a} = ${x}`,
                        [String(newC)]: `That's the right side of the equation, not x. First subtract ${newB}, then divide by ${a}.`,
                        [String(newC - newB)]: `That's ${a}x, not x. You need to divide by ${a}: ${newC - newB} ÷ ${a} = ${x}`
                    }}; })()
            };
        },
        Factoring: () => {
            const r1 = rand(1, 5), r2 = rand(1, 5);
            const sum = r1 + r2, prod = r1 * r2;
            return {
                goalProblem: `Factor: x² + 7x + 12`,
                teachingSteps: [
                    {
                        title: "What is factoring?",
                        explanation: "<strong>Factoring</strong> means writing an expression as a product of simpler expressions. We're going 'backwards' from multiplying.",
                        visual: "x² + 7x + 12 = (? + ?)(? + ?)"
                    },
                    {
                        title: "Identify the key numbers",
                        explanation: "In x² + 7x + 12: <strong>b = 7</strong> (coefficient of x) and <strong>c = 12</strong> (constant term). We need two numbers that work with these.",
                        visual: "b = 7, c = 12"
                    },
                    {
                        title: "The magic conditions",
                        explanation: "We need two numbers p and q where: p × q = c (multiply to 12) AND p + q = b (add to 7). Both conditions must be true!",
                        visual: "p × q = 12 AND p + q = 7"
                    },
                    {
                        title: "Find the factor pair",
                        explanation: "List pairs that multiply to 12: 1×12, 2×6, 3×4. Which adds to 7? 1+12=13✗, 2+6=8✗, <strong>3+4=7✓</strong>",
                        visual: "3 × 4 = 12 ✓ AND 3 + 4 = 7 ✓"
                    },
                    {
                        title: "Write the answer and check",
                        explanation: "Use p=3 and q=4: <strong>(x + 3)(x + 4)</strong>. Check with FOIL: x² + 4x + 3x + 12 = x² + 7x + 12 ✓",
                        visual: "(x + 3)(x + 4)"
                    }
                ],
                finalAnswer: "(x + 3)(x + 4)",
                answerExplanation: "We found 3 and 4 because 3×4=12 and 3+4=7. Always verify by FOILing!",
                example: { problem: `Factor: x² + 7x + 12`, steps: [
                    { text: "Identify b and c", math: "b = 7 (coefficient of x), c = 12 (constant)" },
                    { text: "List factor pairs of 12", math: "1×12, 2×6, 3×4" },
                    { text: "Find the pair that adds to 7", math: "1+12=13✗, 2+6=8✗, 3+4=7✓" },
                    { text: "Write the factors", math: "<strong>(x + 3)(x + 4)</strong>" },
                    { text: "Check by FOIL", math: "x² + 4x + 3x + 12 = x² + 7x + 12 ✓" }
                ]},
                keyPoints: [
                    "Two numbers must MULTIPLY to c AND ADD to b",
                    "FOIL = First, Outer, Inner, Last (for checking)",
                    "If the signs in the trinomial are both positive, both factors are positive"
                ],
                mistakes: [
                    { wrong: "Only checking multiplication: using 1 and 12 because 1×12=12", why: "1+12=13, not 7. Both conditions must be satisfied!" },
                    { wrong: "Writing (x + 7)(x + 12)", why: "7+12=19 and 7×12=84, neither matches. We need numbers that add to 7 AND multiply to 12." },
                    { wrong: "Forgetting to check with FOIL", why: "Always FOIL your answer to verify: (x+3)(x+4) = x² + 4x + 3x + 12 = x² + 7x + 12 ✓" }
                ],
                guided: { problem: `Factor: x² + ${sum}x + ${prod}`, steps: [
                    { label: "Need two numbers that multiply to", value: `${prod}` },
                    { label: "And add to", value: `${sum}` },
                    { label: `Factor pairs of ${prod}:`, value: `Think: what × what = ${prod} AND + = ${sum}?` },
                    { label: `${r1} × ${r2} = ${prod} and ${r1} + ${r2} = ${sum} ✓`, value: "So the factors are..." }
                ], answer: `(x+${r1})(x+${r2})`, answerLabel: "Factored form:",
                    interactiveSteps: [
                        {
                            prompt: `In x² + ${sum}x + ${prod}, the constant term is ${prod}. We need two numbers that MULTIPLY to what?`,
                            hint: "The constant term is the number at the end...",
                            answer: String(prod),
                            acceptableAnswers: [String(prod)],
                            commonMistakes: {
                                [String(sum)]: `${sum} is the coefficient of x (what we ADD to). We multiply to ${prod}.`
                            }
                        },
                        {
                            prompt: `The coefficient of x is ${sum}. We need two numbers that ADD to what?`,
                            hint: "The number in front of x...",
                            answer: String(sum),
                            acceptableAnswers: [String(sum)],
                            commonMistakes: {
                                [String(prod)]: `${prod} is what we multiply to. We add to ${sum}.`
                            }
                        },
                        {
                            prompt: `Find two numbers: ___ × ___ = ${prod} AND ___ + ___ = ${sum}. What are the two numbers?`,
                            hint: `Think of factor pairs of ${prod}: what two numbers multiply to ${prod}?`,
                            answer: `${r1} and ${r2}`,
                            acceptableAnswers: [`${r1} and ${r2}`, `${r2} and ${r1}`, `${r1}, ${r2}`, `${r2}, ${r1}`, `${r1} ${r2}`],
                            commonMistakes: {
                                [`1 and ${prod}`]: `1 × ${prod} = ${prod} ✓, but 1 + ${prod} = ${1 + prod}, not ${sum}. Try ${r1} and ${r2}.`,
                                [String(sum)]: `That's one number. We need TWO numbers: ${r1} and ${r2} (multiply to ${prod}, add to ${sum})`
                            }
                        },
                        {
                            prompt: `Verify: ${r1} × ${r2} = ? and ${r1} + ${r2} = ?`,
                            hint: "Check both conditions...",
                            answer: `${prod} and ${sum}`,
                            acceptableAnswers: [`${prod} and ${sum}`, `${prod}, ${sum}`, "yes", "correct"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Write the factored form using ${r1} and ${r2}: (x + ___)(x + ___)`,
                            hint: "Put each number in a factor...",
                            answer: `(x+${r1})(x+${r2})`,
                            acceptableAnswers: [`(x+${r1})(x+${r2})`, `(x+${r2})(x+${r1})`, `(x + ${r1})(x + ${r2})`, `(x + ${r2})(x + ${r1})`],
                            commonMistakes: {
                                [`(x+${sum})(x+${prod})`]: `Use the two numbers we found (${r1} and ${r2}), not the sum and product!`
                            }
                        }
                    ]
                },
                practice: (() => { const nr1 = r1 + 1, nr2 = r2 + 1; const nsum = nr1 + nr2; const nprod = nr1 * nr2; return {
                    problem: `Factor: x² + ${nsum}x + ${nprod}`, answer: `(x+${nr1})(x+${nr2})`,
                    options: [`(x+${nr1})(x+${nr2})`, `(x+1)(x+${nprod})`, `(x+${nsum})(x+1)`, `(x+${nr1})(x+${nr1})`],
                    mistakeAnalysis: {
                        [`(x+1)(x+${nprod})`]: `1 × ${nprod} = ${nprod} ✓, but 1 + ${nprod} = ${1+nprod}, not ${nsum}. Need ${nr1} + ${nr2} = ${nsum}.`,
                        [`(x+${nsum})(x+1)`]: `These add to ${nsum+1}, not ${nsum}. Also ${nsum} × 1 = ${nsum}, not ${nprod}.`,
                        [`(x+${nr1})(x+${nr1})`]: `${nr1} × ${nr1} = ${nr1*nr1}, not ${nprod}. You need two DIFFERENT numbers: ${nr1} and ${nr2}.`
                    }}; })()
            };
        },
        Systems: () => {
            const x = rand(1, 5), y = rand(1, 5);
            const a1 = 1, b1 = 1, c1 = x + y;
            const a2 = 1, b2 = -1, c2 = x - y;
            return {
                goalProblem: `Solve: x + y = 7 and x - y = 3`,
                teachingSteps: [
                    {
                        title: "What is a system of equations?",
                        explanation: "A <strong>system</strong> is two or more equations that must both be true at the same time. We find values that work in ALL equations.",
                        visual: "x + y = 7 AND x - y = 3"
                    },
                    {
                        title: "Choose a method: Elimination",
                        explanation: "Notice one equation has +y and the other has -y. If we <strong>add</strong> the equations, the y terms will cancel out!",
                        visual: "+y + (-y) = 0 (they cancel!)"
                    },
                    {
                        title: "Add the equations together",
                        explanation: "Add left sides: (x + y) + (x - y) = 2x. Add right sides: 7 + 3 = 10. We get: 2x = 10",
                        visual: "(x + y) + (x - y) = 7 + 3 → 2x = 10"
                    },
                    {
                        title: "Solve for x",
                        explanation: "From 2x = 10, divide both sides by 2: <strong>x = 5</strong>. We found x! Now we need y.",
                        visual: "x = 5"
                    },
                    {
                        title: "Find y and check both equations",
                        explanation: "Substitute x=5 into equation 1: 5 + y = 7, so y = 2. Check: 5+2=7✓ and 5-2=3✓ Both work!",
                        visual: "Solution: (5, 2)"
                    }
                ],
                finalAnswer: "x = 5, y = 2 or (5, 2)",
                answerExplanation: "By adding the equations, y cancelled. We found x=5, then substituted to find y=2. Always check in BOTH equations!",
                example: { problem: `Solve: x + y = 7 and x - y = 3`, steps: [
                    { text: "Use elimination: add the equations", math: "(x + y) + (x - y) = 7 + 3" },
                    { text: "The y terms cancel", math: "2x = 10" },
                    { text: "Solve for x", math: "x = 5" },
                    { text: "Substitute x = 5 into first equation", math: "5 + y = 7" },
                    { text: "Solve for y", math: "y = 2" },
                    { text: "Solution: (5, 2). Check in both equations:", math: "5+2=7✓, 5-2=3✓" }
                ]},
                keyPoints: [
                    "The solution must satisfy BOTH equations",
                    "Elimination works great when coefficients are opposites (+y and -y)",
                    "Always check your answer in both original equations"
                ],
                mistakes: [
                    { wrong: "Only checking the solution in one equation", why: "The solution must work in BOTH equations!" },
                    { wrong: "Adding when you should subtract (or vice versa)", why: "Look at the signs. +y and -y: ADD to eliminate. +y and +y: SUBTRACT to eliminate." },
                    { wrong: "Forgetting to find the second variable", why: "A system has TWO variables. Once you find x, substitute to find y." }
                ],
                guided: { problem: `Solve: x + y = ${c1} and x - y = ${c2}`, steps: [
                    { label: "Add the equations to eliminate y", value: `(x + y) + (x - y) = ${c1} + ${c2}` },
                    { label: "Simplify", value: `2x = ${c1 + c2}` },
                    { label: "Solve for x", value: `x = ${x}` },
                    { label: "Find y using x + y = " + c1, value: "y = ?" }
                ], answer: String(y), answerLabel: "y = ?",
                    interactiveSteps: [
                        {
                            prompt: "We have +y in the first equation and -y in the second. To eliminate y, should we ADD or SUBTRACT the equations?",
                            hint: "+y + (-y) = 0... what operation makes them cancel?",
                            answer: "add",
                            acceptableAnswers: ["add", "addition", "adding"],
                            commonMistakes: {
                                "subtract": "If we subtract, we'd get y - (-y) = 2y. Adding gives +y + (-y) = 0, which eliminates y!"
                            }
                        },
                        {
                            prompt: `Add the left sides: (x + y) + (x - y) = ?`,
                            hint: "The y terms cancel. What's left?",
                            answer: "2x",
                            acceptableAnswers: ["2x", "x + x"],
                            commonMistakes: {
                                "2x + 2y": "The +y and -y cancel! (x + y) + (x - y) = x + x = 2x",
                                "0": "x + x = 2x. Only the y terms cancel."
                            }
                        },
                        {
                            prompt: `Add the right sides: ${c1} + ${c2} = ?`,
                            hint: `${c1} plus ${c2}...`,
                            answer: String(c1 + c2),
                            acceptableAnswers: [String(c1 + c2)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `So we have 2x = ${c1 + c2}. Solve for x:`,
                            hint: `Divide both sides by 2...`,
                            answer: String(x),
                            acceptableAnswers: [String(x), "x = " + x],
                            commonMistakes: {
                                [String(c1 + c2)]: `That's 2x. Divide by 2: ${c1 + c2} ÷ 2 = ${x}`,
                                [String(2 * (c1 + c2))]: `Divide, not multiply! ${c1 + c2} ÷ 2 = ${x}`
                            }
                        },
                        {
                            prompt: `Now substitute x = ${x} into x + y = ${c1}. What is ${x} + y = ${c1}, solved for y?`,
                            hint: `${c1} - ${x} = ?`,
                            answer: String(y),
                            acceptableAnswers: [String(y), "y = " + y],
                            commonMistakes: {
                                [String(c1)]: `You need to solve for y: ${c1} - ${x} = ${y}`,
                                [String(x)]: `That's x. For y: ${c1} - ${x} = ${y}`
                            }
                        }
                    ]
                },
                practice: { problem: `Solve: x + y = 8 and x - y = 2. What is x?`, answer: "5",
                    options: ["3", "5", "6", "8"],
                    mistakeAnalysis: {
                        "3": "That's y! Adding: 2x = 10, so x = 5. Then 5 + y = 8, so y = 3.",
                        "6": "Check: Adding x+y=8 and x-y=2 gives 2x=10, so x=5.",
                        "8": "That's the sum x+y. Add the equations: 2x = 10, so x = 5."
                    }}
            };
        },
        Functions: () => {
            const a = rand(2, 4), b = rand(1, 5), xVal = rand(2, 5);
            const fx = a * xVal + b;
            return {
                goalProblem: `If f(x) = 3x + 2, find f(5)`,
                teachingSteps: [
                    {
                        title: "What is a function?",
                        explanation: "A <strong>function</strong> is a rule that takes an input and gives exactly one output. Think of it like a machine: put something in, get something out.",
                        visual: "Input → [Function Machine] → Output"
                    },
                    {
                        title: "Understanding function notation",
                        explanation: "f(x) = 3x + 2 means 'the function f takes input x and outputs 3x + 2'. The f(x) is read as 'f of x', NOT 'f times x'!",
                        visual: "f(x) = 3x + 2 ('f of x equals...')"
                    },
                    {
                        title: "What does f(5) mean?",
                        explanation: "f(5) means 'find the output when the input is 5'. We <strong>replace every x with 5</strong> in the function rule.",
                        visual: "f(5) → plug in x = 5"
                    },
                    {
                        title: "Substitute x = 5",
                        explanation: "Take f(x) = 3x + 2 and replace x with 5: f(5) = 3(5) + 2",
                        visual: "f(5) = 3(5) + 2"
                    },
                    {
                        title: "Calculate the answer",
                        explanation: "3(5) = 15, then 15 + 2 = 17. So <strong>f(5) = 17</strong>. When we put in 5, we get out 17!",
                        visual: "f(5) = 17"
                    }
                ],
                finalAnswer: "f(5) = 17",
                answerExplanation: "f(5) means substitute 5 for x: f(5) = 3(5) + 2 = 15 + 2 = 17",
                example: { problem: `If f(x) = 3x + 2, find f(5)`, steps: [
                    { text: "Identify what we're finding", math: "f(5) means 'replace x with 5'" },
                    { text: "Write the function", math: "f(x) = 3x + 2" },
                    { text: "Substitute x = 5", math: "f(5) = 3(5) + 2" },
                    { text: "Calculate", math: "f(5) = 15 + 2 = <strong>17</strong>" }
                ]},
                keyPoints: [
                    "f(x) is 'f of x' - the output when input is x",
                    "f(3) means substitute 3 for every x in the function",
                    "A function gives exactly ONE output for each input"
                ],
                mistakes: [
                    { wrong: "f(x) = f × x (multiplying f and x)", why: "f(x) is function notation, not multiplication! f(5) means 'plug in 5 for x'" },
                    { wrong: "f(5) = 5 (just using the input as output)", why: "You must apply the function rule: f(5) = 3(5) + 2 = 17" },
                    { wrong: "Adding the input to the function: f(5) = 3x + 2 + 5", why: "Replace x WITH 5, don't add 5. f(5) = 3(5) + 2" }
                ],
                guided: { problem: `If f(x) = ${a}x + ${b}, find f(${xVal})`, steps: [
                    { label: "The function rule is", value: `f(x) = ${a}x + ${b}` },
                    { label: `Substitute x = ${xVal}`, value: `f(${xVal}) = ${a}(${xVal}) + ${b}` },
                    { label: "Calculate", value: `f(${xVal}) = ${a * xVal} + ${b} = ?` }
                ], answer: String(fx), answerLabel: `f(${xVal}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `f(${xVal}) means we plug in what value for x?`,
                            hint: "The number inside the parentheses is what we substitute...",
                            answer: String(xVal),
                            acceptableAnswers: [String(xVal), "x = " + xVal],
                            commonMistakes: {
                                [String(a)]: `${a} is the coefficient in the function. We're substituting x = ${xVal}.`,
                                [String(b)]: `${b} is the constant. The ${xVal} in f(${xVal}) is what we plug in for x.`
                            }
                        },
                        {
                            prompt: `Replace x with ${xVal} in f(x) = ${a}x + ${b}. What is ${a} × ${xVal}?`,
                            hint: `${a} times ${xVal}...`,
                            answer: String(a * xVal),
                            acceptableAnswers: [String(a * xVal)],
                            commonMistakes: {
                                [String(a + xVal)]: `Multiply, not add! ${a} × ${xVal} = ${a * xVal}`,
                                [String(xVal)]: `Don't forget to multiply by ${a}! ${a} × ${xVal} = ${a * xVal}`
                            }
                        },
                        {
                            prompt: `Now add the constant: ${a * xVal} + ${b} = ?`,
                            hint: `${a * xVal} plus ${b}...`,
                            answer: String(fx),
                            acceptableAnswers: [String(fx)],
                            commonMistakes: {
                                [String(a * xVal)]: `Don't forget to add ${b}! ${a * xVal} + ${b} = ${fx}`
                            }
                        },
                        {
                            prompt: `So f(${xVal}) = ?`,
                            hint: `We calculated ${a}(${xVal}) + ${b}...`,
                            answer: String(fx),
                            acceptableAnswers: [String(fx), "f(" + xVal + ") = " + fx],
                            commonMistakes: {
                                [String(xVal)]: `That's the input. The output is f(${xVal}) = ${fx}`
                            }
                        }
                    ]
                },
                practice: (() => { const newX = xVal + 1; const newFx = a * newX + b; return {
                    problem: `If f(x) = ${a}x + ${b}, find f(${newX})`, answer: String(newFx),
                    options: shuffle([String(newFx), String(a + newX + b), String(a * newX), String(newX)]),
                    mistakeAnalysis: {
                        [String(a + newX + b)]: `You added instead of multiplied. f(${newX}) = ${a} × ${newX} + ${b} = ${a * newX} + ${b} = ${newFx}`,
                        [String(a * newX)]: `You forgot to add ${b}. f(${newX}) = ${a}(${newX}) + ${b} = ${a * newX} + ${b} = ${newFx}`,
                        [String(newX)]: `${newX} is the INPUT. Apply the function: f(${newX}) = ${a}(${newX}) + ${b} = ${newFx}`
                    }}; })()
            };
        },
        Inequalities: () => {
            const a = rand(2, 4), b = rand(3, 8);
            const threshold = rand(10, 20);
            const solution = Math.ceil((threshold - b) / a);
            return {
                goalProblem: `Solve: 2x + 3 < 11`,
                teachingSteps: [
                    {
                        title: "What is an inequality?",
                        explanation: "An <strong>inequality</strong> compares two expressions using <, >, ≤, or ≥ instead of =. The solution is a range of values, not just one number!",
                        visual: "< less than | > greater than | ≤ at most | ≥ at least"
                    },
                    {
                        title: "Solving is like equations... mostly",
                        explanation: "We solve inequalities the same way as equations - isolate the variable. But there's ONE big difference we'll learn!",
                        visual: "2x + 3 < 11 → isolate x"
                    },
                    {
                        title: "Step 1: Subtract 3 from both sides",
                        explanation: "Undo the +3 by subtracting 3 from both sides: 2x + 3 - 3 < 11 - 3, which gives us 2x < 8",
                        visual: "2x + 3 - 3 < 11 - 3 → 2x < 8"
                    },
                    {
                        title: "Step 2: Divide both sides by 2",
                        explanation: "Divide both sides by 2 to get x alone: 2x ÷ 2 < 8 ÷ 2, which gives us <strong>x < 4</strong>",
                        visual: "2x ÷ 2 < 8 ÷ 2 → x < 4"
                    },
                    {
                        title: "The critical rule!",
                        explanation: "When dividing/multiplying by a <strong>NEGATIVE</strong> number, FLIP the inequality sign! (Here we divided by +2, so no flip needed.)",
                        visual: "x < 4 means x can be 3, 2, 1, 0, -1, ..."
                    }
                ],
                finalAnswer: "x < 4",
                answerExplanation: "x < 4 means any number less than 4 works. Remember: flip the sign when multiplying/dividing by negatives!",
                example: { problem: `Solve: 2x + 3 < 11`, steps: [
                    { text: "Subtract 3 from both sides", math: "2x + 3 - 3 < 11 - 3" },
                    { text: "Simplify", math: "2x < 8" },
                    { text: "Divide both sides by 2", math: "2x ÷ 2 < 8 ÷ 2" },
                    { text: "Solution", math: "<strong>x < 4</strong>" },
                    { text: "This means x can be any number less than 4", math: "Like 3, 2, 1, 0, -1, ..." }
                ]},
                keyPoints: [
                    "Solve like an equation - isolate the variable",
                    "FLIP the sign when multiplying/dividing by a NEGATIVE",
                    "< or > means 'not including' (open circle), ≤ or ≥ means 'including' (closed circle)"
                ],
                mistakes: [
                    { wrong: "Forgetting to flip the sign when dividing by a negative", why: "-2x > 6 becomes x < -3 (flip the >). Test: -2(-4) = 8 > 6 ✓" },
                    { wrong: "Writing the solution as a single number", why: "Inequalities have MANY solutions. x < 4 means ALL numbers less than 4." },
                    { wrong: "Confusing open and closed circles", why: "< or > = open (not including). ≤ or ≥ = closed (including)." }
                ],
                guided: { problem: `Solve: ${a}x + ${b} ≥ ${threshold}`, steps: [
                    { label: `Subtract ${b} from both sides`, value: `${a}x ≥ ${threshold - b}` },
                    { label: `Divide both sides by ${a}`, value: `x ≥ ${(threshold - b) / a}` },
                    { label: "What is x greater than or equal to?", value: "?" }
                ], answer: String(solution), answerLabel: "x ≥ ?",
                    interactiveSteps: [
                        {
                            prompt: `In ${a}x + ${b} ≥ ${threshold}, what should we do first to isolate x?`,
                            hint: "Undo the outer operation first (the addition)...",
                            answer: `subtract ${b}`,
                            acceptableAnswers: [`subtract ${b}`, "subtract", `- ${b}`, "subtraction"],
                            commonMistakes: {
                                [`divide by ${a}`]: "Undo addition/subtraction first, then multiplication/division. Subtract ${b} first."
                            }
                        },
                        {
                            prompt: `Subtract ${b} from both sides: ${threshold} - ${b} = ?`,
                            hint: `${threshold} minus ${b}...`,
                            answer: String(threshold - b),
                            acceptableAnswers: [String(threshold - b)],
                            commonMistakes: {
                                [String(threshold + b)]: `Subtract, not add! ${threshold} - ${b} = ${threshold - b}`,
                                [String(threshold)]: `You need to subtract ${b}: ${threshold} - ${b} = ${threshold - b}`
                            }
                        },
                        {
                            prompt: `Now we have ${a}x ≥ ${threshold - b}. We need to divide by ${a}. When we divide by a POSITIVE number, does the inequality sign flip?`,
                            hint: "The sign only flips when dividing by a negative...",
                            answer: "no",
                            acceptableAnswers: ["no", "it doesn't", "doesn't flip", "stays same"],
                            commonMistakes: {
                                "yes": "Only flip when dividing by a NEGATIVE. ${a} is positive, so the sign stays ≥."
                            }
                        },
                        {
                            prompt: `Calculate: ${threshold - b} ÷ ${a} = ?`,
                            hint: `${threshold - b} divided by ${a}...`,
                            answer: String((threshold - b) / a),
                            acceptableAnswers: [String((threshold - b) / a), String(solution)],
                            commonMistakes: {
                                [String((threshold - b) * a)]: `Divide, not multiply! ${threshold - b} ÷ ${a} = ${(threshold - b) / a}`
                            }
                        },
                        {
                            prompt: `So x ≥ ?`,
                            hint: `We found ${threshold - b} ÷ ${a}...`,
                            answer: String(solution),
                            acceptableAnswers: [String(solution), "x ≥ " + solution],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Solve: 3x - 4 > 11. What values can x be?`, answer: "x > 5",
                    options: ["x > 5", "x < 5", "x > 7", "x = 5"],
                    mistakeAnalysis: {
                        "x < 5": "The inequality sign doesn't flip here (we divided by positive 3). 3x > 15, so x > 5.",
                        "x > 7": "Check your arithmetic: 3x > 11 + 4 = 15, so x > 15/3 = 5",
                        "x = 5": "This is an inequality (>) not an equation. x can be any number GREATER than 5."
                    }}
            };
        },
        Radicals: () => {
            const outside = rand(2, 5), inside = rand(2, 7);
            const radicand = outside * outside * inside;
            return {
                goalProblem: `Simplify: √72`,
                teachingSteps: [
                    {
                        title: "What is a radical?",
                        explanation: "A <strong>radical</strong> is a root expression, like √ (square root). Simplifying means rewriting it in its simplest form.",
                        visual: "√72 → simplest form?"
                    },
                    {
                        title: "Find perfect square factors",
                        explanation: "To simplify √72, find a <strong>perfect square</strong> that divides 72 evenly. Perfect squares: 4, 9, 16, 25, 36...",
                        visual: "72 = 36 × 2 (36 is a perfect square!)"
                    },
                    {
                        title: "Split the radical",
                        explanation: "Use the rule √(a×b) = √a × √b. So √72 = √(36 × 2) = √36 × √2",
                        visual: "√72 = √36 × √2"
                    },
                    {
                        title: "Simplify the perfect square",
                        explanation: "√36 = 6 (because 6 × 6 = 36). So √72 = 6 × √2 = <strong>6√2</strong>",
                        visual: "√36 = 6, so √72 = 6√2"
                    },
                    {
                        title: "The simplified form!",
                        explanation: "<strong>√72 = 6√2</strong>. The 6 'comes out' of the radical, and √2 stays inside because 2 has no perfect square factors.",
                        visual: "√72 = 6√2"
                    }
                ],
                finalAnswer: "6√2",
                answerExplanation: "72 = 36 × 2, √36 = 6, so √72 = 6√2. Always look for the largest perfect square factor!",
                example: { problem: `Simplify: √72`, steps: [
                    { text: "Find perfect square factor of 72", math: "72 = 36 × 2" },
                    { text: "Split the radical", math: "√72 = √(36 × 2) = √36 × √2" },
                    { text: "Simplify √36", math: "√36 = 6" },
                    { text: "Final answer", math: "<strong>√72 = 6√2</strong>" }
                ]},
                keyPoints: [
                    "√(a×b) = √a × √b (product rule for radicals)",
                    "Look for the LARGEST perfect square factor",
                    "Perfect squares: 4, 9, 16, 25, 36, 49, 64, 81, 100..."
                ],
                mistakes: [
                    { wrong: "√72 = 36 (just dividing by 2)", why: "We need √72, not 72÷2. √72 = 6√2 ≈ 8.49" },
                    { wrong: "√72 = 8.something (leaving as decimal)", why: "Simplified radical form keeps the √: 6√2, not 8.485..." },
                    { wrong: "Using a smaller perfect square: √72 = √(4×18) = 2√18", why: "2√18 can be simplified further! Use 36: √72 = 6√2" }
                ],
                guided: {
                    problem: `Simplify: √${radicand}`,
                    steps: [
                        { label: `Find perfect square factor of ${radicand}`, value: `${radicand} = ${outside * outside} × ${inside}` },
                        { label: `√${outside * outside} = ${outside}`, value: "Take the square root" },
                        { label: "Simplified form", value: "?" }
                    ],
                    answer: `${outside}√${inside}`,
                    answerLabel: `√${radicand} = ?`,
                    interactiveSteps: [
                        {
                            prompt: `To simplify √${radicand}, we need to find a perfect square that divides ${radicand}. What is ${outside}²?`,
                            hint: `${outside} × ${outside} = ?`,
                            answer: String(outside * outside),
                            acceptableAnswers: [String(outside * outside)],
                            commonMistakes: {
                                [String(outside * 2)]: `That's ${outside} × 2. We need ${outside}². ${outside} × ${outside} = ${outside * outside}`
                            }
                        },
                        {
                            prompt: `${radicand} ÷ ${outside * outside} = ?`,
                            hint: "Divide to find what's left inside the radical...",
                            answer: String(inside),
                            acceptableAnswers: [String(inside)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `So √${radicand} = √(${outside * outside} × ${inside}) = √${outside * outside} × √${inside}. What is √${outside * outside}?`,
                            hint: `What number times itself equals ${outside * outside}?`,
                            answer: String(outside),
                            acceptableAnswers: [String(outside)],
                            commonMistakes: {
                                [String(outside * outside)]: `We need the square ROOT: √${outside * outside} = ${outside}`
                            }
                        },
                        {
                            prompt: `Write the simplified form: ${outside} × √${inside} = ?`,
                            hint: "Put the number outside the radical...",
                            answer: `${outside}√${inside}`,
                            acceptableAnswers: [`${outside}√${inside}`, `${outside}*√${inside}`, `${outside} √${inside}`],
                            commonMistakes: {
                                [String(radicand)]: `That's the original radicand. The simplified form is ${outside}√${inside}`
                            }
                        }
                    ]
                },
                practice: (() => { const po = 3, pi = 5, pr = po * po * pi; return {
                    problem: `Simplify: √${pr}`, answer: `${po}√${pi}`,
                    options: [`${po}√${pi}`, `${pi}√${po}`, `√${pr}`, `${po * pi}`],
                    mistakeAnalysis: {
                        [`${pi}√${po}`]: `You swapped them! ${pr} = ${po*po} × ${pi}, so √${pr} = ${po}√${pi}`,
                        [`√${pr}`]: `This can be simplified! ${pr} = 9 × ${pi}, so √${pr} = 3√${pi}`,
                        [`${po * pi}`]: `That's ${po} × ${pi}. We need √${pr} = ${po}√${pi}`
                    }}; })()
            };
        },
        "Exponential Functions": () => {
            const base = rand(2, 4), x = rand(2, 4);
            const result = Math.pow(base, x);
            return {
                goalProblem: `If f(x) = 2^x, find f(5)`,
                teachingSteps: [
                    {
                        title: "What is an exponential function?",
                        explanation: "An <strong>exponential function</strong> has the variable in the exponent: f(x) = b^x. The base 'b' is a constant, and x is the exponent.",
                        visual: "f(x) = 2^x (2 is the base, x is the exponent)"
                    },
                    {
                        title: "Growth vs Decay",
                        explanation: "If base > 1, the function shows <strong>growth</strong> (gets bigger fast). If 0 < base < 1, it shows <strong>decay</strong> (gets smaller).",
                        visual: "b > 1 → growth | 0 < b < 1 → decay"
                    },
                    {
                        title: "Evaluating f(5)",
                        explanation: "f(5) means substitute x = 5: f(5) = 2^5. We need to calculate 2 to the 5th power.",
                        visual: "f(5) = 2^5 = 2 × 2 × 2 × 2 × 2"
                    },
                    {
                        title: "Calculate the power",
                        explanation: "2^5 = 2 × 2 × 2 × 2 × 2 = 4 × 4 × 2 = 16 × 2 = <strong>32</strong>",
                        visual: "2^5 = 32"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>f(5) = 32</strong>. Exponential functions grow very quickly - 2^10 would be 1024!",
                        visual: "f(5) = 32"
                    }
                ],
                finalAnswer: "f(5) = 32",
                answerExplanation: "f(5) = 2^5 = 2×2×2×2×2 = 32. Exponential functions grow rapidly!",
                example: { problem: `If f(x) = 2^x, find f(5)`, steps: [
                    { text: "Substitute x = 5", math: "f(5) = 2^5" },
                    { text: "Calculate the power", math: "2^5 = 2 × 2 × 2 × 2 × 2" },
                    { text: "Multiply step by step", math: "= 4 × 4 × 2 = 32" },
                    { text: "Final answer", math: "<strong>f(5) = 32</strong>" }
                ]},
                keyPoints: [
                    "Exponential: variable is in the exponent (2^x not x^2)",
                    "Base > 1 means growth, 0 < base < 1 means decay",
                    "These functions grow/decay VERY fast"
                ],
                mistakes: [
                    { wrong: "2^5 = 10 (multiplying base × exponent)", why: "2^5 means 2×2×2×2×2, not 2×5. Answer is 32." },
                    { wrong: "Confusing 2^5 with 5^2", why: "2^5 = 32 but 5^2 = 25. The position matters!" },
                    { wrong: "f(5) = 2 × 5 = 10", why: "The x is an exponent, not a multiplier. f(5) = 2^5 = 32" }
                ],
                guided: {
                    problem: `If f(x) = ${base}^x, find f(${x})`,
                    steps: [
                        { label: `Substitute x = ${x}`, value: `f(${x}) = ${base}^${x}` },
                        { label: `Calculate ${base}^${x}`, value: "?" }
                    ],
                    answer: String(result),
                    answerLabel: `f(${x}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `In an exponential function like ${base}^x, where is the variable located?`,
                            hint: "Look at where x appears in the expression...",
                            answer: "exponent",
                            acceptableAnswers: ["exponent", "the exponent", "in the exponent", "power"],
                            commonMistakes: {
                                "base": "The base is ${base} (a constant). The variable x is in the exponent position."
                            }
                        },
                        {
                            prompt: `f(${x}) means we substitute ${x} for x. What is ${base}^${x}?`,
                            hint: `${base} multiplied by itself ${x} times...`,
                            answer: String(result),
                            acceptableAnswers: [String(result)],
                            commonMistakes: {
                                [String(base * x)]: `You multiplied ${base} × ${x}. We need ${base}^${x} = ${base} × ${base}... (${x} times) = ${result}`,
                                [String(base + x)]: `You added! ${base}^${x} means ${base} multiplied by itself ${x} times = ${result}`
                            }
                        },
                        {
                            prompt: `Is f(x) = ${base}^x a growth or decay function?`,
                            hint: `The base ${base} is greater than 1...`,
                            answer: "growth",
                            acceptableAnswers: ["growth", "exponential growth"],
                            commonMistakes: {
                                "decay": `Base ${base} > 1, so this is GROWTH. Decay happens when 0 < base < 1.`
                            }
                        }
                    ]
                },
                practice: (() => { const pb = 3, px = 4, pr = Math.pow(pb, px); return {
                    problem: `If f(x) = ${pb}^x, find f(${px})`, answer: String(pr),
                    options: shuffle([String(pr), String(pb * px), String(Math.pow(px, pb)), String(pb + px)]),
                    mistakeAnalysis: {
                        [String(pb * px)]: `You multiplied base × exponent. ${pb}^${px} means ${pb}×${pb}×${pb}×${pb} = ${pr}`,
                        [String(Math.pow(px, pb))]: `You swapped them! ${pb}^${px} = ${pr}, not ${px}^${pb} = ${Math.pow(px, pb)}`,
                        [String(pb + px)]: `You added! ${pb}^${px} = ${pr}`
                    }}; })()
            };
        },
        "Arithmetic Sequences": () => {
            const a1 = rand(2, 10), d = rand(2, 6), n = rand(5, 8);
            const an = a1 + (n - 1) * d;
            return {
                goalProblem: `Find the 10th term: 3, 7, 11, 15, ...`,
                teachingSteps: [
                    {
                        title: "What is an arithmetic sequence?",
                        explanation: "An <strong>arithmetic sequence</strong> adds the same number each time. This number is called the <strong>common difference (d)</strong>.",
                        visual: "3, 7, 11, 15... (+4 each time)"
                    },
                    {
                        title: "Find the common difference",
                        explanation: "Subtract consecutive terms: 7 - 3 = 4, 11 - 7 = 4, 15 - 11 = 4. The common difference d = <strong>4</strong>.",
                        visual: "d = 7 - 3 = 4"
                    },
                    {
                        title: "The formula for any term",
                        explanation: "The nth term formula is: <strong>aₙ = a₁ + (n-1)d</strong>. a₁ is the first term, d is the common difference, n is which term.",
                        visual: "aₙ = a₁ + (n-1)d"
                    },
                    {
                        title: "Find the 10th term",
                        explanation: "Plug in: a₁ = 3, d = 4, n = 10. a₁₀ = 3 + (10-1)(4) = 3 + 9(4) = 3 + 36 = <strong>39</strong>",
                        visual: "a₁₀ = 3 + 9(4) = 39"
                    },
                    {
                        title: "The answer!",
                        explanation: "The 10th term is <strong>39</strong>. We can verify: 3, 7, 11, 15, 19, 23, 27, 31, 35, 39 ✓",
                        visual: "a₁₀ = 39"
                    }
                ],
                finalAnswer: "39",
                answerExplanation: "Using aₙ = a₁ + (n-1)d: a₁₀ = 3 + (10-1)(4) = 3 + 36 = 39",
                example: { problem: `Find the 10th term: 3, 7, 11, 15, ...`, steps: [
                    { text: "Identify a₁ and find d", math: "a₁ = 3, d = 7 - 3 = 4" },
                    { text: "Use the formula aₙ = a₁ + (n-1)d", math: "a₁₀ = 3 + (10-1)(4)" },
                    { text: "Simplify", math: "a₁₀ = 3 + 9(4) = 3 + 36" },
                    { text: "Final answer", math: "<strong>a₁₀ = 39</strong>" }
                ]},
                keyPoints: [
                    "Arithmetic = adding the SAME amount each time",
                    "d = any term minus the previous term",
                    "Formula: aₙ = a₁ + (n-1)d"
                ],
                mistakes: [
                    { wrong: "Using n instead of (n-1): a₁₀ = 3 + 10(4) = 43", why: "The formula has (n-1) because we ADD to the first term. a₁₀ = 3 + 9(4) = 39" },
                    { wrong: "Multiplying a₁ by d: 3 × 4 = 12", why: "We ADD (n-1)d to a₁, not multiply. a₁₀ = 3 + 36 = 39" },
                    { wrong: "Forgetting to subtract 1 from n", why: "(n-1) accounts for the first term. For the 10th term, we add d nine times." }
                ],
                guided: {
                    problem: `Find the ${n}th term of the arithmetic sequence where a₁ = ${a1} and d = ${d}`,
                    steps: [
                        { label: "Formula", value: "aₙ = a₁ + (n-1)d" },
                        { label: `Substitute: a₁ = ${a1}, d = ${d}, n = ${n}`, value: `a${n} = ${a1} + (${n}-1)(${d})` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(an),
                    answerLabel: `a${n} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "In an arithmetic sequence, what do we call the constant added each time?",
                            hint: "It's the 'common ___'",
                            answer: "common difference",
                            acceptableAnswers: ["common difference", "difference", "d"],
                            commonMistakes: {
                                "common ratio": "That's for GEOMETRIC sequences! Arithmetic sequences have a common DIFFERENCE."
                            }
                        },
                        {
                            prompt: `Using aₙ = a₁ + (n-1)d, what is (${n} - 1)?`,
                            hint: "Subtract 1 from n...",
                            answer: String(n - 1),
                            acceptableAnswers: [String(n - 1)],
                            commonMistakes: {
                                [String(n)]: `Subtract 1! ${n} - 1 = ${n - 1}`
                            }
                        },
                        {
                            prompt: `Now multiply: ${n - 1} × ${d} = ?`,
                            hint: `${n - 1} times ${d}...`,
                            answer: String((n - 1) * d),
                            acceptableAnswers: [String((n - 1) * d)],
                            commonMistakes: {
                                [String(n * d)]: `Use (n-1), not n! ${n - 1} × ${d} = ${(n - 1) * d}`
                            }
                        },
                        {
                            prompt: `Finally, add a₁: ${a1} + ${(n - 1) * d} = ?`,
                            hint: "Add the first term to your result...",
                            answer: String(an),
                            acceptableAnswers: [String(an)],
                            commonMistakes: {
                                [String((n - 1) * d)]: `Don't forget to add a₁! ${a1} + ${(n - 1) * d} = ${an}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = 5, pd = 3, pn = 8, pan = pa + (pn - 1) * pd; return {
                    problem: `Find the ${pn}th term: ${pa}, ${pa + pd}, ${pa + 2*pd}, ...`, answer: String(pan),
                    options: shuffle([String(pan), String(pa + pn * pd), String(pa * pn), String(pan - pd)]),
                    mistakeAnalysis: {
                        [String(pa + pn * pd)]: `Use (n-1), not n! a${pn} = ${pa} + (${pn}-1)(${pd}) = ${pa} + ${(pn-1)*pd} = ${pan}`,
                        [String(pa * pn)]: `Arithmetic sequences ADD, not multiply. a${pn} = ${pa} + ${(pn-1)*pd} = ${pan}`,
                        [String(pan - pd)]: `That's the ${pn - 1}th term. The ${pn}th term is ${pan}.`
                    }}; })()
            };
        },
        "Geometric Sequences": () => {
            const a1 = rand(2, 5), r = rand(2, 3), n = rand(4, 5);
            const an = a1 * Math.pow(r, n - 1);
            return {
                goalProblem: `Find the 5th term: 2, 6, 18, 54, ...`,
                teachingSteps: [
                    {
                        title: "What is a geometric sequence?",
                        explanation: "A <strong>geometric sequence</strong> multiplies by the same number each time. This number is called the <strong>common ratio (r)</strong>.",
                        visual: "2, 6, 18, 54... (×3 each time)"
                    },
                    {
                        title: "Find the common ratio",
                        explanation: "Divide consecutive terms: 6 ÷ 2 = 3, 18 ÷ 6 = 3, 54 ÷ 18 = 3. The common ratio r = <strong>3</strong>.",
                        visual: "r = 6 ÷ 2 = 3"
                    },
                    {
                        title: "The formula for any term",
                        explanation: "The nth term formula is: <strong>aₙ = a₁ × r^(n-1)</strong>. a₁ is the first term, r is the common ratio.",
                        visual: "aₙ = a₁ × r^(n-1)"
                    },
                    {
                        title: "Find the 5th term",
                        explanation: "Plug in: a₁ = 2, r = 3, n = 5. a₅ = 2 × 3^(5-1) = 2 × 3^4 = 2 × 81 = <strong>162</strong>",
                        visual: "a₅ = 2 × 3^4 = 2 × 81 = 162"
                    },
                    {
                        title: "The answer!",
                        explanation: "The 5th term is <strong>162</strong>. Sequence: 2, 6, 18, 54, 162 ✓",
                        visual: "a₅ = 162"
                    }
                ],
                finalAnswer: "162",
                answerExplanation: "Using aₙ = a₁ × r^(n-1): a₅ = 2 × 3^4 = 2 × 81 = 162",
                example: { problem: `Find the 5th term: 2, 6, 18, 54, ...`, steps: [
                    { text: "Identify a₁ and find r", math: "a₁ = 2, r = 6 ÷ 2 = 3" },
                    { text: "Use the formula aₙ = a₁ × r^(n-1)", math: "a₅ = 2 × 3^(5-1)" },
                    { text: "Simplify the exponent", math: "a₅ = 2 × 3^4 = 2 × 81" },
                    { text: "Final answer", math: "<strong>a₅ = 162</strong>" }
                ]},
                keyPoints: [
                    "Geometric = MULTIPLYING by the same amount each time",
                    "r = any term DIVIDED BY the previous term",
                    "Formula: aₙ = a₁ × r^(n-1)"
                ],
                mistakes: [
                    { wrong: "Using n instead of (n-1) in exponent: 2 × 3^5 = 486", why: "The formula uses r^(n-1). For the 5th term: 3^4, not 3^5." },
                    { wrong: "Adding instead of multiplying: 2 + 3(4) = 14", why: "Geometric sequences MULTIPLY. a₅ = 2 × 3^4 = 162" },
                    { wrong: "Confusing with arithmetic: 2 + 4(3) = 14", why: "This is geometric (multiply), not arithmetic (add)." }
                ],
                guided: {
                    problem: `Find the ${n}th term of the geometric sequence where a₁ = ${a1} and r = ${r}`,
                    steps: [
                        { label: "Formula", value: "aₙ = a₁ × r^(n-1)" },
                        { label: `Substitute: a₁ = ${a1}, r = ${r}, n = ${n}`, value: `a${n} = ${a1} × ${r}^(${n}-1)` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(an),
                    answerLabel: `a${n} = ?`,
                    interactiveSteps: [
                        {
                            prompt: "In a geometric sequence, what do we call the constant we multiply by each time?",
                            hint: "It's the 'common ___'",
                            answer: "common ratio",
                            acceptableAnswers: ["common ratio", "ratio", "r"],
                            commonMistakes: {
                                "common difference": "That's for ARITHMETIC sequences! Geometric sequences have a common RATIO."
                            }
                        },
                        {
                            prompt: `Using aₙ = a₁ × r^(n-1), what is the exponent when n = ${n}?`,
                            hint: "Calculate n - 1...",
                            answer: String(n - 1),
                            acceptableAnswers: [String(n - 1)],
                            commonMistakes: {
                                [String(n)]: `The exponent is (n-1), not n! ${n} - 1 = ${n - 1}`
                            }
                        },
                        {
                            prompt: `Calculate ${r}^${n - 1} = ?`,
                            hint: `${r} multiplied by itself ${n - 1} times...`,
                            answer: String(Math.pow(r, n - 1)),
                            acceptableAnswers: [String(Math.pow(r, n - 1))],
                            commonMistakes: {
                                [String(r * (n - 1))]: `That's ${r} × ${n - 1}. We need ${r}^${n - 1} = ${Math.pow(r, n - 1)}`
                            }
                        },
                        {
                            prompt: `Finally, multiply by a₁: ${a1} × ${Math.pow(r, n - 1)} = ?`,
                            hint: "Multiply the first term by your result...",
                            answer: String(an),
                            acceptableAnswers: [String(an)],
                            commonMistakes: {
                                [String(Math.pow(r, n - 1))]: `Don't forget to multiply by a₁! ${a1} × ${Math.pow(r, n - 1)} = ${an}`
                            }
                        }
                    ]
                },
                practice: (() => { const pa = 3, pr = 2, pn = 5, pan = pa * Math.pow(pr, pn - 1); return {
                    problem: `Find the ${pn}th term: ${pa}, ${pa * pr}, ${pa * pr * pr}, ...`, answer: String(pan),
                    options: shuffle([String(pan), String(pa * Math.pow(pr, pn)), String(pa + (pn - 1) * pr), String(pa * pn * pr)]),
                    mistakeAnalysis: {
                        [String(pa * Math.pow(pr, pn))]: `Exponent is (n-1), not n! a${pn} = ${pa} × ${pr}^${pn - 1} = ${pan}`,
                        [String(pa + (pn - 1) * pr)]: `That's arithmetic formula! Geometric uses aₙ = a₁ × r^(n-1) = ${pan}`,
                        [String(pa * pn * pr)]: `Use the formula: a${pn} = ${pa} × ${pr}^${pn - 1} = ${pan}`
                    }}; })()
            };
        },
        "Compound Interest": () => {
            const P = pick([100, 200, 500, 1000]);
            const r = pick([5, 6, 8, 10]);
            const t = rand(2, 3);
            const A = Math.round(P * Math.pow(1 + r/100, t));
            return {
                goalProblem: `$1000 at 5% interest compounded annually for 3 years. Find the final amount.`,
                teachingSteps: [
                    {
                        title: "What is compound interest?",
                        explanation: "<strong>Compound interest</strong> means you earn interest on your interest! Each year, the interest is added to your balance, and next year you earn interest on the bigger amount.",
                        visual: "Interest on principal AND previous interest"
                    },
                    {
                        title: "The compound interest formula",
                        explanation: "A = P(1 + r)^t where: A = final amount, P = principal (starting amount), r = rate (as decimal), t = time (years)",
                        visual: "A = P(1 + r)^t"
                    },
                    {
                        title: "Identify the values",
                        explanation: "P = $1000 (starting amount), r = 5% = 0.05 (as decimal), t = 3 years",
                        visual: "P = 1000, r = 0.05, t = 3"
                    },
                    {
                        title: "Plug into the formula",
                        explanation: "A = 1000(1 + 0.05)^3 = 1000(1.05)^3 = 1000 × 1.157625 ≈ <strong>$1157.63</strong>",
                        visual: "A = 1000(1.05)^3 ≈ $1157.63"
                    },
                    {
                        title: "Compare to simple interest",
                        explanation: "Simple interest would give: 1000 + (1000 × 0.05 × 3) = $1150. Compound interest gives $1157.63 - that's $7.63 more!",
                        visual: "Compound: $1157.63 > Simple: $1150"
                    }
                ],
                finalAnswer: "$1157.63",
                answerExplanation: "A = P(1+r)^t = 1000(1.05)^3 = 1000 × 1.157625 ≈ $1157.63. Compound interest earns more than simple interest!",
                example: { problem: `$1000 at 5% compounded annually for 3 years`, steps: [
                    { text: "Identify values", math: "P = 1000, r = 0.05, t = 3" },
                    { text: "Use formula A = P(1+r)^t", math: "A = 1000(1 + 0.05)^3" },
                    { text: "Simplify inside parentheses", math: "A = 1000(1.05)^3" },
                    { text: "Calculate 1.05^3", math: "1.05^3 ≈ 1.1576" },
                    { text: "Multiply", math: "<strong>A ≈ $1157.63</strong>" }
                ]},
                keyPoints: [
                    "Convert percent to decimal: 5% = 0.05",
                    "Formula: A = P(1 + r)^t for annual compounding",
                    "Compound interest > Simple interest (earns interest on interest)"
                ],
                mistakes: [
                    { wrong: "Using r = 5 instead of r = 0.05", why: "Must convert percent to decimal! 5% = 5/100 = 0.05" },
                    { wrong: "Adding instead of using exponent: P + Prt = simple interest", why: "That's simple interest. Compound uses (1+r)^t with an exponent." },
                    { wrong: "Forgetting to add 1 to r: 1000(0.05)^3", why: "It's (1 + r)^t, not r^t. The 1 represents keeping your principal!" }
                ],
                guided: {
                    problem: `$${P} at ${r}% interest compounded annually for ${t} years. Find the final amount.`,
                    steps: [
                        { label: "Convert rate to decimal", value: `${r}% = ${r/100}` },
                        { label: "Use A = P(1+r)^t", value: `A = ${P}(1 + ${r/100})^${t}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(A),
                    answerLabel: "A = $?",
                    interactiveSteps: [
                        {
                            prompt: `First, convert ${r}% to a decimal. What is ${r} ÷ 100?`,
                            hint: "Move the decimal point two places left...",
                            answer: String(r/100),
                            acceptableAnswers: [String(r/100), "0." + (r < 10 ? "0" + r : r)],
                            commonMistakes: {
                                [String(r)]: `${r} is the percent. As a decimal: ${r} ÷ 100 = ${r/100}`,
                                [String(r/10)]: `Divide by 100, not 10! ${r} ÷ 100 = ${r/100}`
                            }
                        },
                        {
                            prompt: `What is 1 + ${r/100}?`,
                            hint: "Add 1 to the decimal rate...",
                            answer: String(1 + r/100),
                            acceptableAnswers: [String(1 + r/100)],
                            commonMistakes: {
                                [String(r/100)]: `Don't forget the 1! 1 + ${r/100} = ${1 + r/100}`
                            }
                        },
                        {
                            prompt: `Now calculate (${1 + r/100})^${t} ≈ ?`,
                            hint: `${1 + r/100} multiplied by itself ${t} times...`,
                            answer: String(Math.pow(1 + r/100, t).toFixed(4)),
                            acceptableAnswers: [String(Math.pow(1 + r/100, t).toFixed(4)), String(Math.pow(1 + r/100, t).toFixed(2)), String(Math.pow(1 + r/100, t).toFixed(3))],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Finally, multiply: ${P} × ${Math.pow(1 + r/100, t).toFixed(4)} ≈ $?`,
                            hint: "Round to the nearest dollar...",
                            answer: String(A),
                            acceptableAnswers: [String(A), String(Math.round(P * Math.pow(1 + r/100, t)))],
                            commonMistakes: {
                                [String(P)]: `You need to multiply! ${P} × ${Math.pow(1 + r/100, t).toFixed(2)} ≈ $${A}`
                            }
                        }
                    ]
                },
                practice: (() => { const pp = 500, pr = 10, pt = 2, pa = Math.round(pp * Math.pow(1 + pr/100, pt)); return {
                    problem: `$${pp} at ${pr}% compounded annually for ${pt} years`, answer: String(pa),
                    options: shuffle([String(pa), String(pp + pp * pr/100 * pt), String(pp * pr/100 * pt), String(Math.round(pp * Math.pow(pr/100, pt)))]),
                    mistakeAnalysis: {
                        [String(pp + pp * pr/100 * pt)]: `That's simple interest! Compound: A = ${pp}(1.${pr})^${pt} = $${pa}`,
                        [String(pp * pr/100 * pt)]: `That's just the interest from simple interest. Compound gives $${pa}`,
                        [String(Math.round(pp * Math.pow(pr/100, pt)))]: `You forgot the 1! Use (1 + r)^t, not r^t. Answer is $${pa}`
                    }}; })()
            };
        },
        "Domain and Range": () => {
            const a = rand(2, 5);
            const vertex = rand(-3, 3);
            return {
                goalProblem: `Find the domain and range of f(x) = x²`,
                teachingSteps: [
                    {
                        title: "What are domain and range?",
                        explanation: "<strong>Domain</strong> = all possible INPUT values (x). <strong>Range</strong> = all possible OUTPUT values (y or f(x)).",
                        visual: "Domain: What can go IN? | Range: What can come OUT?"
                    },
                    {
                        title: "Finding the domain",
                        explanation: "Ask: 'What x-values can I plug in?' For f(x) = x², we can square ANY real number. No restrictions!",
                        visual: "Domain of x² = all real numbers"
                    },
                    {
                        title: "Finding the range",
                        explanation: "Ask: 'What y-values can come out?' When we square any number, the result is always 0 or positive. Can't get negative outputs!",
                        visual: "(-3)² = 9, (0)² = 0, (3)² = 9... all ≥ 0"
                    },
                    {
                        title: "Visualize the parabola",
                        explanation: "f(x) = x² is a U-shaped parabola opening UP with vertex at (0,0). It never goes below the x-axis.",
                        visual: "Parabola: lowest point at y = 0"
                    },
                    {
                        title: "The answer!",
                        explanation: "<strong>Domain: all real numbers (or ℝ or (-∞, ∞))</strong><br><strong>Range: y ≥ 0 (or [0, ∞))</strong>",
                        visual: "Domain: all reals | Range: y ≥ 0"
                    }
                ],
                finalAnswer: "Domain: all real numbers, Range: y ≥ 0",
                answerExplanation: "Any number can be squared (domain = all reals), but squares are never negative (range = y ≥ 0).",
                example: { problem: `Find the domain and range of f(x) = x²`, steps: [
                    { text: "Domain: What x-values work?", math: "Any real number can be squared" },
                    { text: "Domain answer", math: "<strong>All real numbers</strong>" },
                    { text: "Range: What y-values come out?", math: "Squares are always ≥ 0" },
                    { text: "Range answer", math: "<strong>y ≥ 0</strong>" }
                ]},
                keyPoints: [
                    "Domain = inputs (x), Range = outputs (y)",
                    "Look for restrictions: square roots need ≥ 0 inside, fractions can't have 0 in denominator",
                    "For parabolas: domain is usually all reals, range depends on vertex and direction"
                ],
                mistakes: [
                    { wrong: "Confusing domain and range", why: "Domain = inputs (x-values), Range = outputs (y-values). Don't mix them!" },
                    { wrong: "Range of x² is 'all real numbers'", why: "x² can never output a negative! The range is y ≥ 0." },
                    { wrong: "Domain of √x is all real numbers", why: "Can't take √ of negatives (in reals). Domain of √x is x ≥ 0." }
                ],
                guided: {
                    problem: `Find the domain of f(x) = 1/(x - ${a})`,
                    steps: [
                        { label: "What restriction exists?", value: "Can't divide by zero" },
                        { label: `When does x - ${a} = 0?`, value: `x = ${a}` },
                        { label: "Domain", value: "?" }
                    ],
                    answer: `x ≠ ${a}`,
                    answerLabel: "Domain:",
                    interactiveSteps: [
                        {
                            prompt: "For a fraction like 1/(x-a), what value CAN'T the denominator be?",
                            hint: "Division by this number is undefined...",
                            answer: "0",
                            acceptableAnswers: ["0", "zero"],
                            commonMistakes: {
                                "1": "We can divide by 1. We CAN'T divide by 0!"
                            }
                        },
                        {
                            prompt: `For 1/(x - ${a}), when does the denominator equal 0? Solve: x - ${a} = 0`,
                            hint: `Add ${a} to both sides...`,
                            answer: String(a),
                            acceptableAnswers: [String(a), "x = " + a],
                            commonMistakes: {
                                [String(-a)]: `If x - ${a} = 0, then x = ${a} (add ${a} to both sides)`,
                                "0": `Solve x - ${a} = 0: x = ${a}`
                            }
                        },
                        {
                            prompt: `Since x = ${a} makes the denominator 0, what is the domain?`,
                            hint: "x can be anything EXCEPT...",
                            answer: `x ≠ ${a}`,
                            acceptableAnswers: [`x ≠ ${a}`, `all real numbers except ${a}`, `x not equal to ${a}`],
                            commonMistakes: {
                                "all real numbers": `Not quite! x = ${a} would make the denominator 0. Domain: x ≠ ${a}`,
                                [`x = ${a}`]: `That's the EXCLUDED value. Domain is x ≠ ${a} (all reals except ${a})`
                            }
                        }
                    ]
                },
                practice: { problem: `What is the domain of f(x) = √(x - 3)?`, answer: "x ≥ 3",
                    options: ["x ≥ 3", "x > 3", "x ≤ 3", "all real numbers"],
                    mistakeAnalysis: {
                        "x > 3": "Close! But x = 3 works too: √(3-3) = √0 = 0. So x ≥ 3.",
                        "x ≤ 3": "That would give negative values inside √, which isn't allowed. Need x ≥ 3.",
                        "all real numbers": "Can't take √ of negatives! Need x - 3 ≥ 0, so x ≥ 3."
                    }}
            };
        }
    },
    6: {
        Area: () => {
            const l = rand(4, 10), w = rand(3, 8);
            const area = l * w;
            return {
                goalProblem: `Find the area of a rectangle with length 8 ft and width 5 ft`,
                teachingSteps: [
                    {
                        title: "What is Area?",
                        explanation: "<strong>Area</strong> measures how much <strong>space is inside</strong> a flat (2D) shape.<br><br>Think of it like: <em>\"How many square tiles would fit inside this shape?\"</em>",
                        visual: "📐 Area = Inside space of a shape"
                    },
                    {
                        title: "Common Area Formulas",
                        explanation: "Different shapes have different formulas:<br><br>• <strong>Rectangle:</strong> A = length × width<br>• <strong>Square:</strong> A = side × side = s²<br>• <strong>Triangle:</strong> A = ½ × base × height<br>• <strong>Circle:</strong> A = π × radius²",
                        visual: "Rectangle: l × w | Square: s² | Triangle: ½bh | Circle: πr²"
                    },
                    {
                        title: "Step 1: Identify the Shape and Formula",
                        explanation: "We have a <strong>rectangle</strong>, so we use:<br><br><strong>Area = length × width</strong>",
                        visual: "Rectangle → A = l × w"
                    },
                    {
                        title: "Step 2: Plug in the Numbers",
                        explanation: "Our length is <strong>8 ft</strong> and width is <strong>5 ft</strong>:<br><br>A = 8 × 5",
                        visual: "A = 8 ft × 5 ft"
                    },
                    {
                        title: "Step 3: Calculate and Add Units",
                        explanation: "Multiply: 8 × 5 = <strong>40</strong><br><br>Area is always in <strong>SQUARE units</strong> (because we're measuring 2D space):<br><br><strong>A = 40 ft²</strong>",
                        visual: "8 × 5 = 40 → 40 ft² (square feet)"
                    }
                ],
                finalAnswer: "40 ft²",
                answerExplanation: "We multiplied length × width (8 × 5 = 40) and used square units because area measures 2D space.",
                example: { problem: `Find the area of a rectangle with length 8 ft and width 5 ft`, steps: [
                    { text: "Identify the formula", math: "Area = length × width" },
                    { text: "Substitute the values", math: "A = 8 × 5" },
                    { text: "Calculate", math: "A = 40" },
                    { text: "Add square units", math: "<strong>A = 40 ft²</strong>" }
                ]},
                keyPoints: [
                    "Area = space INSIDE a shape",
                    "Always use SQUARE units (ft², in², cm²)",
                    "For triangles, don't forget the ½!"
                ],
                mistakes: [
                    { wrong: "Confusing area and perimeter", why: "Area = inside space (square units). Perimeter = distance around (regular units)." },
                    { wrong: "Forgetting ½ for triangles", why: "Triangle area = ½ × base × height. The ½ is essential!" },
                    { wrong: "Using diameter instead of radius for circles", why: "A = πr², where r is RADIUS (half the diameter)." }
                ],
                guided: {
                    problem: `Find the area of a rectangle: length = ${l} cm, width = ${w} cm`,
                    steps: [
                        { label: "Formula", value: "A = l × w" },
                        { label: "Substitute", value: `A = ${l} × ${w}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(area),
                    answerLabel: "Area in cm²:",
                    interactiveSteps: [
                        {
                            prompt: "What formula do we use for the area of a rectangle?",
                            hint: "Area equals what times what?",
                            answer: "l × w",
                            acceptableAnswers: ["l × w", "l*w", "lxw", "length × width", "length * width", "length x width", "l x w", "A = l × w", "A=l×w"],
                            commonMistakes: {
                                "l + w": "That's for perimeter! Area uses multiplication (×), not addition (+).",
                                "2l + 2w": "That's the perimeter formula. For area, we multiply length × width.",
                                "l × w × h": "That's for volume (3D). Area only needs length × width (2D)."
                            }
                        },
                        {
                            prompt: `Now plug in the numbers: ${l} × ${w} = ?`,
                            hint: `Multiply ${l} times ${w}`,
                            answer: String(area),
                            acceptableAnswers: [String(area), `${area} cm²`, `${area}cm²`],
                            commonMistakes: {
                                [String(l + w)]: `You added instead of multiplied! ${l} × ${w} = ${area}, not ${l} + ${w} = ${l + w}`,
                                [String(l * w * 2)]: "You multiplied by 2 - that's not needed for area. Just multiply length × width.",
                                [String(2 * l + 2 * w)]: "That's the perimeter! For area, just multiply: length × width."
                            }
                        }
                    ]
                },
                practice: { problem: `A triangle has base 10 in and height 6 in. What is its area?`, answer: "30",
                    options: ["30", "60", "16", "32"],
                    mistakeAnalysis: {
                        "60": "You forgot the ½! Triangle area = ½ × 10 × 6 = 30 in²",
                        "16": "That's 10 + 6 (perimeter pieces). Area = ½ × base × height = 30",
                        "32": "Check your calculation: ½ × 10 × 6 = 5 × 6 = 30"
                    }}
            };
        },
        Volume: () => {
            const l = rand(3, 7), w = rand(2, 5), h = rand(2, 6);
            const vol = l * w * h;
            return {
                goalProblem: `Find the volume of a box: 4 cm × 3 cm × 5 cm`,
                teachingSteps: [
                    {
                        title: "What is Volume?",
                        explanation: "<strong>Volume</strong> measures how much <strong>space is inside</strong> a 3D (three-dimensional) shape.<br><br>Think of it like: <em>\"How many little cubes would fit inside this shape?\"</em>",
                        visual: "📦 Volume = Space inside a 3D shape"
                    },
                    {
                        title: "Area vs. Volume",
                        explanation: "<strong>Area</strong> is 2D (flat): length × width → square units (cm²)<br><br><strong>Volume</strong> is 3D (solid): length × width × height → cubic units (cm³)<br><br>Volume adds that third dimension!",
                        visual: "2D: □ → cm² | 3D: 📦 → cm³"
                    },
                    {
                        title: "Common Volume Formulas",
                        explanation: "• <strong>Box (rectangular prism):</strong> V = l × w × h<br>• <strong>Cube:</strong> V = s³ (side × side × side)<br>• <strong>Cylinder:</strong> V = πr²h<br>• <strong>Sphere:</strong> V = (4/3)πr³",
                        visual: "Box: lwh | Cube: s³ | Cylinder: πr²h | Sphere: (4/3)πr³"
                    },
                    {
                        title: "Step 1: Identify the Formula",
                        explanation: "We have a <strong>box (rectangular prism)</strong>, so we use:<br><br><strong>Volume = length × width × height</strong>",
                        visual: "Box → V = l × w × h"
                    },
                    {
                        title: "Step 2: Plug in the Numbers",
                        explanation: "Our dimensions are: length = <strong>4 cm</strong>, width = <strong>3 cm</strong>, height = <strong>5 cm</strong><br><br>V = 4 × 3 × 5",
                        visual: "V = 4 cm × 3 cm × 5 cm"
                    },
                    {
                        title: "Step 3: Calculate Step by Step",
                        explanation: "Work left to right:<br><br>First: 4 × 3 = <strong>12</strong><br>Then: 12 × 5 = <strong>60</strong><br><br>Volume = 60, and we use <strong>CUBIC units</strong>: <strong>60 cm³</strong>",
                        visual: "4 × 3 = 12 → 12 × 5 = 60 → 60 cm³"
                    }
                ],
                finalAnswer: "60 cm³",
                answerExplanation: "We multiplied all three dimensions (4 × 3 × 5 = 60) and used cubic units because volume measures 3D space.",
                example: { problem: `Find the volume of a box: 4 cm × 3 cm × 5 cm`, steps: [
                    { text: "Identify the formula", math: "Volume = l × w × h" },
                    { text: "Substitute the values", math: "V = 4 × 3 × 5" },
                    { text: "Calculate step by step", math: "V = 12 × 5 = 60" },
                    { text: "Add cubic units", math: "<strong>V = 60 cm³</strong>" }
                ]},
                keyPoints: [
                    "Volume = space INSIDE a 3D shape",
                    "Always use CUBIC units (ft³, in³, cm³)",
                    "Think: how many unit cubes fit inside?"
                ],
                mistakes: [
                    { wrong: "Using square units instead of cubic", why: "Volume needs CUBIC units because it's 3D (length × width × height)" },
                    { wrong: "Finding area instead of volume", why: "Area is 2D (l × w). Volume is 3D (l × w × h)." },
                    { wrong: "Forgetting to cube the radius for spheres", why: "Sphere volume = (4/3)πr³, not (4/3)πr" }
                ],
                guided: {
                    problem: `Find the volume of a box: ${l} × ${w} × ${h} inches`,
                    steps: [
                        { label: "Formula", value: "V = l × w × h" },
                        { label: "Substitute", value: `V = ${l} × ${w} × ${h}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(vol),
                    answerLabel: "Volume in in³:",
                    interactiveSteps: [
                        {
                            prompt: "What formula do we use for the volume of a rectangular box?",
                            hint: "Volume equals length times width times... what?",
                            answer: "l × w × h",
                            acceptableAnswers: ["l × w × h", "l*w*h", "lwh", "l x w x h", "length × width × height", "V = l × w × h", "V=lwh"],
                            commonMistakes: {
                                "l × w": "That's the formula for AREA (2D). Volume needs all THREE dimensions: l × w × h",
                                "l + w + h": "That's adding the dimensions. Volume MULTIPLIES them: l × w × h",
                                "2(l + w + h)": "That's related to perimeter/surface area. Volume = l × w × h"
                            }
                        },
                        {
                            prompt: `First, multiply the first two dimensions: ${l} × ${w} = ?`,
                            hint: `What's ${l} times ${w}?`,
                            answer: String(l * w),
                            acceptableAnswers: [String(l * w)],
                            commonMistakes: {
                                [String(l + w)]: `You added instead of multiplied! ${l} × ${w} = ${l * w}`,
                                [String(l * w * h)]: `That's the final answer! We're just doing the first step: ${l} × ${w} = ${l * w}`
                            }
                        },
                        {
                            prompt: `Now multiply that result by the height: ${l * w} × ${h} = ?`,
                            hint: `What's ${l * w} times ${h}?`,
                            answer: String(vol),
                            acceptableAnswers: [String(vol), `${vol} in³`, `${vol}in³`, `${vol} cubic inches`],
                            commonMistakes: {
                                [String(l * w + h)]: `You added the height instead of multiplying! ${l * w} × ${h} = ${vol}`,
                                [String(l * w)]: `Don't forget to multiply by the height! ${l * w} × ${h} = ${vol}`
                            }
                        }
                    ]
                },
                practice: { problem: `A cube has sides of 4 cm. What is its volume?`, answer: "64",
                    options: ["12", "16", "64", "256"],
                    mistakeAnalysis: {
                        "12": "That's 4 + 4 + 4 (adding). Volume of cube = 4 × 4 × 4 = 64",
                        "16": "That's 4 × 4 (area of one face). Volume = 4 × 4 × 4 = 64",
                        "256": "That's 4⁴, but cube volume is s³ = 4³ = 64"
                    }}
            };
        },
        Triangles: () => {
            const a = rand(30, 60), b = rand(40, 70);
            const c = 180 - a - b;
            return {
                goalProblem: `A triangle has angles 50° and 70°. Find the third angle.`,
                teachingSteps: [
                    {
                        title: "The Most Important Triangle Rule",
                        explanation: "The <strong>most important fact</strong> about triangles:<br><br>📐 <strong>All three angles ALWAYS add up to 180°</strong><br><br>This works for EVERY triangle, no matter what shape!",
                        visual: "Angle 1 + Angle 2 + Angle 3 = 180° (always!)"
                    },
                    {
                        title: "Types of Triangles by Angles",
                        explanation: "• <strong>Acute:</strong> All angles less than 90°<br>• <strong>Right:</strong> One angle equals exactly 90°<br>• <strong>Obtuse:</strong> One angle greater than 90°",
                        visual: "Acute: all < 90° | Right: one = 90° | Obtuse: one > 90°"
                    },
                    {
                        title: "Types of Triangles by Sides",
                        explanation: "• <strong>Equilateral:</strong> All 3 sides equal → all angles are 60°<br>• <strong>Isosceles:</strong> 2 sides equal → 2 angles equal<br>• <strong>Scalene:</strong> No sides equal → no angles equal",
                        visual: "Equilateral: 60°-60°-60° | Isosceles: 2 equal | Scalene: all different"
                    },
                    {
                        title: "Step 1: What Do We Know?",
                        explanation: "We're given two angles: <strong>50°</strong> and <strong>70°</strong><br><br>We need to find the third angle using our rule.",
                        visual: "Known: 50° and 70° | Unknown: third angle"
                    },
                    {
                        title: "Step 2: Add the Known Angles",
                        explanation: "First, add the two angles we know:<br><br><strong>50° + 70° = 120°</strong><br><br>So the two known angles use up 120° of our 180° total.",
                        visual: "50° + 70° = 120°"
                    },
                    {
                        title: "Step 3: Subtract from 180°",
                        explanation: "The third angle is whatever's left to reach 180°:<br><br><strong>180° - 120° = 60°</strong><br><br>The third angle is <strong>60°</strong>!",
                        visual: "180° - 120° = 60°"
                    }
                ],
                finalAnswer: "60°",
                answerExplanation: "We added the two known angles (50° + 70° = 120°), then subtracted from 180° to find the third angle (180° - 120° = 60°).",
                example: { problem: `Triangle has angles 50° and 70°. Find the third angle.`, steps: [
                    { text: "Use the angle sum property", math: "All angles sum to 180°" },
                    { text: "Add known angles", math: "50° + 70° = 120°" },
                    { text: "Subtract from 180°", math: "180° - 120° = 60°" },
                    { text: "The third angle is", math: "<strong>60°</strong>" }
                ]},
                keyPoints: [
                    "Triangle angle sum = 180° (always!)",
                    "Third angle = 180° - (first angle + second angle)",
                    "Equilateral triangles have all 60° angles"
                ],
                mistakes: [
                    { wrong: "Forgetting that angles sum to 180°", why: "This is the fundamental triangle property: a + b + c = 180°" },
                    { wrong: "Thinking angles sum to 360°", why: "360° is for quadrilaterals. Triangles = 180°." }
                ],
                guided: {
                    problem: `A triangle has angles ${a}° and ${b}°. Find the third angle.`,
                    steps: [
                        { label: "Sum of first two angles", value: `${a}° + ${b}° = ${a + b}°` },
                        { label: "Third angle = 180° - sum", value: `180° - ${a + b}° = ?` }
                    ],
                    answer: String(c),
                    answerLabel: "Third angle:",
                    interactiveSteps: [
                        {
                            prompt: "What do all angles in a triangle add up to?",
                            hint: "This is the fundamental triangle rule...",
                            answer: "180",
                            acceptableAnswers: ["180", "180°", "180 degrees"],
                            commonMistakes: {
                                "360": "360° is for quadrilaterals (4 sides). Triangles only have 180°!",
                                "90": "90° is a right angle. All THREE angles together = 180°.",
                                "100": "Not quite. The sum of all angles in a triangle is always 180°."
                            }
                        },
                        {
                            prompt: `Add the two known angles: ${a}° + ${b}° = ?`,
                            hint: `Add ${a} and ${b} together`,
                            answer: String(a + b),
                            acceptableAnswers: [String(a + b), `${a + b}°`],
                            commonMistakes: {
                                [String(a * b)]: `You multiplied! We need to ADD: ${a} + ${b} = ${a + b}`,
                                [String(Math.abs(a - b))]: `You subtracted. We need to ADD the angles: ${a} + ${b} = ${a + b}`
                            }
                        },
                        {
                            prompt: `Now subtract from 180°: 180° - ${a + b}° = ?`,
                            hint: `What's left when you subtract ${a + b} from 180?`,
                            answer: String(c),
                            acceptableAnswers: [String(c), `${c}°`],
                            commonMistakes: {
                                [String(180 + (a + b))]: "You added instead of subtracted! 180 - sum, not 180 + sum.",
                                [String(a + b)]: `That's the sum of the two angles. We need 180 - ${a + b} = ${c}`
                            }
                        }
                    ]
                },
                practice: { problem: `One angle of an isosceles triangle is 40°. If this is one of the equal angles, what are the other angles?`, answer: "40° and 100°",
                    options: ["40° and 100°", "70° and 70°", "40° and 40°", "60° and 80°"],
                    mistakeAnalysis: {
                        "70° and 70°": "If 40° is one of the equal angles, the other equal angle is also 40°. Third = 180° - 80° = 100°",
                        "40° and 40°": "That would give 120° total. The third angle = 180° - 80° = 100°",
                        "60° and 80°": "In isosceles, two angles are equal. If one equal angle is 40°, so is the other."
                    }}
            };
        },
        Circles: () => {
            const r = rand(3, 8);
            const circumference = 2 * Math.PI * r;
            return {
                goalProblem: `Find the circumference of a circle with radius 5 cm`,
                teachingSteps: [
                    {
                        title: "Circle Vocabulary",
                        explanation: "Key parts of a circle:<br><br>• <strong>Radius (r):</strong> Distance from <em>center</em> to the <em>edge</em><br>• <strong>Diameter (d):</strong> Distance <em>across</em> the circle through the center<br><br>Important: <strong>Diameter = 2 × Radius</strong>",
                        visual: "r = center to edge | d = across = 2r"
                    },
                    {
                        title: "What is π (Pi)?",
                        explanation: "<strong>π (pi)</strong> is a special number that shows up in ALL circle calculations.<br><br>π ≈ <strong>3.14159...</strong> (it goes on forever!)<br><br>For calculations, we often use π ≈ <strong>3.14</strong>",
                        visual: "π ≈ 3.14 (approximately)"
                    },
                    {
                        title: "Circle Formulas",
                        explanation: "• <strong>Circumference</strong> (distance around): <strong>C = 2πr</strong> or C = πd<br><br>• <strong>Area</strong> (space inside): <strong>A = πr²</strong><br><br>Circumference is around, Area is inside!",
                        visual: "Circumference: C = 2πr | Area: A = πr²"
                    },
                    {
                        title: "Step 1: Identify What We're Finding",
                        explanation: "We need the <strong>circumference</strong> (distance AROUND the circle).<br><br>Formula: <strong>C = 2πr</strong>",
                        visual: "Circumference = distance around → C = 2πr"
                    },
                    {
                        title: "Step 2: Plug in the Values",
                        explanation: "Our radius is <strong>5 cm</strong>.<br><br>C = 2 × π × 5<br>C = 2 × 3.14 × 5",
                        visual: "C = 2 × 3.14 × 5"
                    },
                    {
                        title: "Step 3: Calculate",
                        explanation: "Work through the multiplication:<br><br>2 × 3.14 = <strong>6.28</strong><br>6.28 × 5 = <strong>31.4</strong><br><br>The circumference is <strong>31.4 cm</strong> (or 10π cm as an exact answer)",
                        visual: "2 × 3.14 = 6.28 → 6.28 × 5 = 31.4 cm"
                    }
                ],
                finalAnswer: "31.4 cm (or 10π cm)",
                answerExplanation: "Using C = 2πr with r = 5, we get C = 2 × 3.14 × 5 = 31.4 cm.",
                example: { problem: `Find the circumference of a circle with radius 5 cm`, steps: [
                    { text: "Identify the formula", math: "C = 2πr" },
                    { text: "Substitute r = 5", math: "C = 2 × π × 5" },
                    { text: "Calculate", math: "C = 10π ≈ 31.4 cm" }
                ]},
                keyPoints: [
                    "Radius = half the diameter, Diameter = twice the radius",
                    "Circumference uses 2πr (or πd), Area uses πr²",
                    "π ≈ 3.14 is often used for approximate answers"
                ],
                mistakes: [
                    { wrong: "Confusing circumference and area formulas", why: "Circumference = 2πr (around). Area = πr² (inside)." },
                    { wrong: "Using diameter when radius is needed", why: "Most formulas use RADIUS. If given diameter, divide by 2 first." }
                ],
                guided: {
                    problem: `Find the circumference of a circle with radius ${r} cm (use π ≈ 3.14)`,
                    steps: [
                        { label: "Formula", value: "C = 2πr" },
                        { label: "Substitute", value: `C = 2 × 3.14 × ${r}` },
                        { label: "Calculate", value: "?" }
                    ],
                    answer: String(Math.round(circumference * 100) / 100),
                    answerLabel: "Circumference:",
                    interactiveSteps: (() => {
                        const step1 = 2 * 3.14;
                        const finalC = Math.round(step1 * r * 100) / 100;
                        return [
                            {
                                prompt: "What formula do we use for circumference of a circle?",
                                hint: "It involves 2, π, and the radius...",
                                answer: "C = 2πr",
                                acceptableAnswers: ["C = 2πr", "2πr", "2*pi*r", "2pir", "C=2πr", "πd", "C = πd"],
                                commonMistakes: {
                                    "πr²": "That's the AREA formula! Circumference = 2πr (around), Area = πr² (inside)",
                                    "πr": "Close! But circumference needs 2πr, not just πr",
                                    "2r": "You forgot π! The formula is 2πr"
                                }
                            },
                            {
                                prompt: `Calculate: 2 × 3.14 = ?`,
                                hint: "Multiply 2 times 3.14",
                                answer: "6.28",
                                acceptableAnswers: ["6.28"],
                                commonMistakes: {
                                    "5.14": "That's 2 + 3.14 (addition). We need 2 × 3.14 = 6.28",
                                    "1.57": "That's 3.14 ÷ 2. We need 2 × 3.14 = 6.28",
                                    "3.14": "You need to multiply by 2: 2 × 3.14 = 6.28"
                                }
                            },
                            {
                                prompt: `Now multiply: 6.28 × ${r} = ?`,
                                hint: `What's 6.28 times ${r}?`,
                                answer: String(finalC),
                                acceptableAnswers: [String(finalC), `${finalC} cm`, `${finalC}cm`],
                                commonMistakes: {
                                    [String(6.28 + r)]: `You added instead of multiplied! 6.28 × ${r} = ${finalC}`,
                                    [String(3.14 * r)]: `You used πr instead of 2πr. The answer is 6.28 × ${r} = ${finalC}`
                                }
                            }
                        ];
                    })()
                },
                practice: { problem: `A circle has diameter 10 cm. What is its radius?`, answer: "5",
                    options: ["5", "10", "20", "31.4"],
                    mistakeAnalysis: {
                        "10": "That's the diameter. Radius = diameter ÷ 2 = 10 ÷ 2 = 5",
                        "20": "You doubled instead of halved. Radius = diameter ÷ 2",
                        "31.4": "That's the circumference (πd). Radius = d ÷ 2 = 5"
                    }}
            };
        },
        Trigonometry: () => ({
            goalProblem: `In a right triangle, angle θ has opposite = 3, hypotenuse = 5. Find sin(θ).`,
            teachingSteps: [
                {
                    title: "What is Trigonometry?",
                    explanation: "<strong>Trigonometry</strong> connects <strong>angles</strong> to <strong>side lengths</strong> in right triangles.<br><br>It lets you find missing sides or angles using special ratios!",
                    visual: "Angles ↔ Side Lengths (in right triangles)"
                },
                {
                    title: "The Three Sides in a Right Triangle",
                    explanation: "For any angle (θ) in a right triangle:<br><br>• <strong>Opposite:</strong> The side ACROSS from the angle<br>• <strong>Adjacent:</strong> The side NEXT TO the angle (not the hypotenuse)<br>• <strong>Hypotenuse:</strong> The LONGEST side (opposite the 90° angle)",
                    visual: "Opposite = across | Adjacent = next to | Hypotenuse = longest"
                },
                {
                    title: "SOH CAH TOA - The Magic Memory Trick!",
                    explanation: "<strong>SOH:</strong> sin(θ) = Opposite / Hypotenuse<br><strong>CAH:</strong> cos(θ) = Adjacent / Hypotenuse<br><strong>TOA:</strong> tan(θ) = Opposite / Adjacent<br><br>Say it: \"SOH CAH TOA\" (sounds like \"so-kah-toe-ah\")",
                    visual: "SOH: sin = O/H | CAH: cos = A/H | TOA: tan = O/A"
                },
                {
                    title: "Step 1: What Are We Finding?",
                    explanation: "We need <strong>sin(θ)</strong>.<br><br>Using SOH: <strong>sin = Opposite / Hypotenuse</strong>",
                    visual: "sin(θ) = O/H"
                },
                {
                    title: "Step 2: Identify the Sides",
                    explanation: "From our problem:<br><br>• Opposite side = <strong>3</strong><br>• Hypotenuse = <strong>5</strong>",
                    visual: "O = 3, H = 5"
                },
                {
                    title: "Step 3: Plug In and Calculate",
                    explanation: "sin(θ) = Opposite / Hypotenuse<br>sin(θ) = 3 / 5<br>sin(θ) = <strong>0.6</strong>",
                    visual: "sin(θ) = 3/5 = 0.6"
                }
            ],
            finalAnswer: "sin(θ) = 0.6",
            answerExplanation: "Using SOH (sin = Opposite/Hypotenuse), we divided 3 by 5 to get 0.6.",
            example: { problem: `In a right triangle, angle θ has opposite = 3, hypotenuse = 5. Find sin(θ).`, steps: [
                { text: "Recall SOH: sin = Opposite/Hypotenuse", math: "sin(θ) = O/H" },
                { text: "Substitute values", math: "sin(θ) = 3/5" },
                { text: "Calculate", math: "<strong>sin(θ) = 0.6</strong>" }
            ]},
            keyPoints: [
                "SOH CAH TOA helps remember the ratios",
                "Always identify which side is opposite, adjacent, or hypotenuse relative to your angle",
                "The hypotenuse is ALWAYS the longest side"
            ],
            mistakes: [
                { wrong: "Mixing up opposite and adjacent", why: "Opposite is ACROSS from the angle. Adjacent is NEXT TO the angle." },
                { wrong: "Using wrong sides for the ratio", why: "Sin = O/H, Cos = A/H, Tan = O/A. Check SOH CAH TOA." }
            ],
            guided: {
                problem: `In a right triangle, the side opposite angle A is 4, and the adjacent side is 3. Find tan(A).`,
                steps: [
                    { label: "Recall TOA: tan = Opposite/Adjacent", value: "tan(A) = O/A" },
                    { label: "Substitute", value: "tan(A) = 4/3" },
                    { label: "As a decimal", value: "?" }
                ],
                answer: "1.33",
                answerLabel: "tan(A) ≈",
                interactiveSteps: [
                    {
                        prompt: "What memory trick helps us remember the trig ratios?",
                        hint: "It sounds like \"so-kah-toe-ah\"...",
                        answer: "SOH CAH TOA",
                        acceptableAnswers: ["SOH CAH TOA", "SOHCAHTOA", "soh cah toa", "sohcahtoa"],
                        commonMistakes: {
                            "sin cos tan": "Those are the functions, but the memory trick is SOH CAH TOA!",
                            "PEMDAS": "That's for order of operations. For trig ratios, use SOH CAH TOA!"
                        }
                    },
                    {
                        prompt: "For tan (TOA), what's the formula? tan = ___ / ___",
                        hint: "TOA: Tan = O... / A...",
                        answer: "O/A",
                        acceptableAnswers: ["O/A", "opposite/adjacent", "opposite / adjacent", "opp/adj"],
                        commonMistakes: {
                            "O/H": "That's SOH (sin = O/H). Tan uses TOA: tan = O/A",
                            "A/H": "That's CAH (cos = A/H). Tan uses TOA: tan = O/A",
                            "A/O": "You have it upside down! TOA means tan = Opposite/Adjacent, not Adjacent/Opposite"
                        }
                    },
                    {
                        prompt: "Plug in the values: 4/3 = ? (round to 2 decimal places)",
                        hint: "Divide 4 by 3 and round to two decimal places",
                        answer: "1.33",
                        acceptableAnswers: ["1.33", "1.3", "1.333"],
                        commonMistakes: {
                            "0.75": "You divided 3/4 instead of 4/3. The opposite (4) goes on TOP!",
                            "7": "You added 4 + 3. We need to DIVIDE: 4 ÷ 3 = 1.33",
                            "12": "You multiplied 4 × 3. We need to DIVIDE: 4 ÷ 3 = 1.33"
                        }
                    }
                ]
            },
            practice: { problem: `sin(θ) = opposite/hypotenuse. If sin(θ) = 0.5, and the hypotenuse is 10, what is the opposite side?`, answer: "5",
                options: ["5", "10", "20", "0.05"],
                mistakeAnalysis: {
                    "10": "sin(θ) = O/H. If sin(θ) = 0.5, then O = 0.5 × H = 0.5 × 10 = 5",
                    "20": "You multiplied 10 × 2 instead of 10 × 0.5",
                    "0.05": "You divided 0.5 by 10. You should multiply: O = sin(θ) × H = 5"
                }}
        }),
        Transformations: () => {
            const x = rand(2, 6), y = rand(2, 5);
            const dx = rand(3, 6), dy = rand(2, 5);
            return {
                goalProblem: `Point A(3, 2) is translated 4 units right and 3 units up. What are the new coordinates?`,
                teachingSteps: [
                    {
                        title: "What are Transformations?",
                        explanation: "<strong>Transformations</strong> are ways to move or change shapes while keeping them recognizable.<br><br>The four main types are:<br>• Translation (slide)<br>• Rotation (turn)<br>• Reflection (flip)<br>• Dilation (resize)",
                        visual: "Translate: slide | Rotate: turn | Reflect: flip | Dilate: resize"
                    },
                    {
                        title: "Translation (Sliding)",
                        explanation: "<strong>Translation</strong> moves every point the SAME distance in the SAME direction.<br><br>Think of it like sliding a piece of paper across a desk - the shape stays exactly the same, just in a new location!<br><br>To translate: add (or subtract) the same values to ALL coordinates.",
                        visual: "Original → Same shape, new location"
                    },
                    {
                        title: "Rotation (Turning)",
                        explanation: "<strong>Rotation</strong> turns a shape around a fixed point (usually the origin).<br><br>Common rotations:<br>• 90° counterclockwise: (x, y) → (-y, x)<br>• 180°: (x, y) → (-x, -y)<br>• 270° counterclockwise: (x, y) → (y, -x)",
                        visual: "90°: (x,y)→(-y,x) | 180°: (x,y)→(-x,-y) | 270°: (x,y)→(y,-x)"
                    },
                    {
                        title: "Reflection (Flipping)",
                        explanation: "<strong>Reflection</strong> creates a mirror image across a line.<br><br>• Reflect over x-axis: (x, y) → (x, -y)<br>• Reflect over y-axis: (x, y) → (-x, y)<br>• Reflect over y = x: (x, y) → (y, x)",
                        visual: "Over x-axis: flip y | Over y-axis: flip x | Over y=x: swap"
                    },
                    {
                        title: "Step 1: Understand the Translation",
                        explanation: "We're moving point A(3, 2):<br><br>• <strong>4 units right</strong> = add 4 to x-coordinate<br>• <strong>3 units up</strong> = add 3 to y-coordinate<br><br>Right/Up = ADD, Left/Down = SUBTRACT",
                        visual: "Right +x | Left -x | Up +y | Down -y"
                    },
                    {
                        title: "Step 2: Calculate the New Coordinates",
                        explanation: "Starting point: (3, 2)<br><br>New x: 3 + 4 = <strong>7</strong><br>New y: 2 + 3 = <strong>5</strong><br><br>The new coordinates are <strong>(7, 5)</strong>",
                        visual: "(3, 2) → (3+4, 2+3) → (7, 5)"
                    }
                ],
                finalAnswer: "(7, 5)",
                answerExplanation: "We added 4 to the x-coordinate (right) and 3 to the y-coordinate (up): (3+4, 2+3) = (7, 5).",
                example: { problem: `Translate point A(3, 2) right 4 and up 3`, steps: [
                    { text: "Identify the movement", math: "Right 4, Up 3" },
                    { text: "Add to x for right", math: "3 + 4 = 7" },
                    { text: "Add to y for up", math: "2 + 3 = 5" },
                    { text: "New coordinates", math: "<strong>(7, 5)</strong>" }
                ]},
                keyPoints: [
                    "Translation: slide without rotating or flipping",
                    "Right/Up = ADD to coordinates",
                    "Left/Down = SUBTRACT from coordinates"
                ],
                mistakes: [
                    { wrong: "Subtracting for 'right' movement", why: "Moving RIGHT means ADDING to x-coordinate, not subtracting" },
                    { wrong: "Confusing x and y directions", why: "x-coordinate is horizontal (left/right), y-coordinate is vertical (up/down)" }
                ],
                guided: {
                    problem: `Point P(${x}, ${y}) is translated ${dx} units right and ${dy} units up. Find the new coordinates.`,
                    steps: [
                        { label: "Original point", value: `(${x}, ${y})` },
                        { label: "Translation", value: `Right ${dx}, Up ${dy}` },
                        { label: "New coordinates", value: "?" }
                    ],
                    answer: `(${x + dx}, ${y + dy})`,
                    answerLabel: "New point:",
                    interactiveSteps: [
                        {
                            prompt: "When translating RIGHT, what do we do to the x-coordinate?",
                            hint: "Right means positive direction on the x-axis...",
                            answer: "add",
                            acceptableAnswers: ["add", "add to it", "increase", "+", "plus"],
                            commonMistakes: {
                                "subtract": "Subtract is for moving LEFT. Right = ADD!",
                                "multiply": "Translation uses addition/subtraction, not multiplication"
                            }
                        },
                        {
                            prompt: `Calculate the new x-coordinate: ${x} + ${dx} = ?`,
                            hint: `Add ${dx} to ${x}`,
                            answer: String(x + dx),
                            acceptableAnswers: [String(x + dx)],
                            commonMistakes: {
                                [String(x - dx)]: `You subtracted! For right, ADD: ${x} + ${dx} = ${x + dx}`,
                                [String(x * dx)]: `You multiplied! Just add: ${x} + ${dx} = ${x + dx}`
                            }
                        },
                        {
                            prompt: `Calculate the new y-coordinate: ${y} + ${dy} = ?`,
                            hint: `Add ${dy} to ${y}`,
                            answer: String(y + dy),
                            acceptableAnswers: [String(y + dy)],
                            commonMistakes: {
                                [String(y - dy)]: `You subtracted! For up, ADD: ${y} + ${dy} = ${y + dy}`,
                                [String(y * dy)]: `You multiplied! Just add: ${y} + ${dy} = ${y + dy}`
                            }
                        }
                    ]
                },
                practice: { problem: `Point (5, 3) is reflected over the y-axis. What are the new coordinates?`, answer: "(-5, 3)",
                    options: ["(-5, 3)", "(5, -3)", "(-5, -3)", "(3, 5)"],
                    mistakeAnalysis: {
                        "(5, -3)": "That's reflection over the x-axis (flip y). Over y-axis flips x: (-5, 3)",
                        "(-5, -3)": "That's reflection over both axes (or 180° rotation). Over y-axis only flips x.",
                        "(3, 5)": "You swapped x and y. That's reflection over y = x. Over y-axis gives (-5, 3)"
                    }}
            };
        },
        Similarity: () => {
            const side1 = rand(4, 8), side2 = rand(6, 12);
            const scale = rand(2, 4);
            const newSide1 = side1 * scale;
            return {
                goalProblem: `Two triangles are similar. Triangle A has sides 3, 4, 5. Triangle B has a shortest side of 6. Find the longest side of Triangle B.`,
                teachingSteps: [
                    {
                        title: "What Does Similar Mean?",
                        explanation: "<strong>Similar shapes</strong> have the same SHAPE but different SIZES.<br><br>• All corresponding <strong>angles are equal</strong><br>• All corresponding <strong>sides are proportional</strong> (same ratio)<br><br>Think of similar shapes like a photo and its enlarged copy!",
                        visual: "Same shape + Same angles + Proportional sides = SIMILAR"
                    },
                    {
                        title: "The Scale Factor",
                        explanation: "The <strong>scale factor</strong> tells us how much bigger or smaller the similar shape is.<br><br>Scale factor = (side of new shape) ÷ (corresponding side of original)<br><br>Every side is multiplied by the SAME scale factor!",
                        visual: "Scale factor = new side ÷ original side"
                    },
                    {
                        title: "Using Proportions",
                        explanation: "Since all sides have the same ratio, we can set up proportions:<br><br>side₁(A) / side₁(B) = side₂(A) / side₂(B)<br><br>Cross-multiply to solve for unknowns!",
                        visual: "a₁/b₁ = a₂/b₂ → Cross multiply!"
                    },
                    {
                        title: "Step 1: Find the Scale Factor",
                        explanation: "Triangle A's shortest side: <strong>3</strong><br>Triangle B's shortest side: <strong>6</strong><br><br>Scale factor = 6 ÷ 3 = <strong>2</strong><br><br>Triangle B is 2 times bigger!",
                        visual: "6 ÷ 3 = 2 (scale factor)"
                    },
                    {
                        title: "Step 2: Apply to the Longest Side",
                        explanation: "Triangle A's longest side: <strong>5</strong><br><br>Triangle B's longest side = 5 × scale factor<br>= 5 × 2 = <strong>10</strong>",
                        visual: "5 × 2 = 10"
                    }
                ],
                finalAnswer: "10",
                answerExplanation: "The scale factor is 6÷3=2. Multiplying the longest side (5) by 2 gives 10.",
                example: { problem: `Similar triangles A (3,4,5) and B (6,?,?). Find longest side of B.`, steps: [
                    { text: "Find scale factor", math: "6 ÷ 3 = 2" },
                    { text: "Identify longest side of A", math: "5" },
                    { text: "Multiply by scale factor", math: "5 × 2 = 10" },
                    { text: "Longest side of B", math: "<strong>10</strong>" }
                ]},
                keyPoints: [
                    "Similar = same shape, different size",
                    "Corresponding angles are equal",
                    "Corresponding sides have the same ratio (scale factor)"
                ],
                mistakes: [
                    { wrong: "Adding instead of multiplying by scale factor", why: "Scale factor MULTIPLIES all sides, doesn't add to them" },
                    { wrong: "Finding different scale factors for different sides", why: "ALL sides use the SAME scale factor in similar shapes" }
                ],
                guided: {
                    problem: `Two similar rectangles: Rectangle A has sides ${side1} and ${side2}. Rectangle B has its shorter side equal to ${newSide1}. Find the longer side of B.`,
                    steps: [
                        { label: "Scale factor", value: `${newSide1} ÷ ${side1} = ${scale}` },
                        { label: "Longer side of B", value: `${side2} × ${scale} = ?` }
                    ],
                    answer: String(side2 * scale),
                    answerLabel: "Longer side:",
                    interactiveSteps: [
                        {
                            prompt: `What is the scale factor? ${newSide1} ÷ ${side1} = ?`,
                            hint: `Divide ${newSide1} by ${side1}`,
                            answer: String(scale),
                            acceptableAnswers: [String(scale)],
                            commonMistakes: {
                                [String(newSide1 - side1)]: `You subtracted! Scale factor = ${newSide1} ÷ ${side1} = ${scale}`,
                                [String(newSide1 + side1)]: "You added! Scale factor is found by DIVIDING corresponding sides."
                            }
                        },
                        {
                            prompt: `Now multiply the longer side by the scale factor: ${side2} × ${scale} = ?`,
                            hint: `What's ${side2} times ${scale}?`,
                            answer: String(side2 * scale),
                            acceptableAnswers: [String(side2 * scale)],
                            commonMistakes: {
                                [String(side2 + scale)]: `You added! Multiply: ${side2} × ${scale} = ${side2 * scale}`,
                                [String(side2)]: `Don't forget to apply the scale factor! ${side2} × ${scale} = ${side2 * scale}`
                            }
                        }
                    ]
                },
                practice: { problem: `A 3-inch photo is enlarged with scale factor 4. What is the new width?`, answer: "12",
                    options: ["7", "12", "16", "1"],
                    mistakeAnalysis: {
                        "7": "You added 3 + 4. Scale factor MULTIPLIES: 3 × 4 = 12",
                        "16": "You might have used 4² = 16. Just multiply: 3 × 4 = 12",
                        "1": "You divided 4 ÷ 4 or something similar. Multiply: 3 × 4 = 12"
                    }}
            };
        },
        Congruence: () => {
            const side = rand(5, 10);
            return {
                goalProblem: `Triangle ABC ≅ Triangle DEF. If AB = 7 cm, what is DE?`,
                teachingSteps: [
                    {
                        title: "What Does Congruent Mean?",
                        explanation: "<strong>Congruent</strong> shapes are EXACTLY the same - same shape AND same size!<br><br>The symbol <strong>≅</strong> means 'is congruent to'<br><br>If two shapes are congruent:<br>• All corresponding sides are EQUAL<br>• All corresponding angles are EQUAL",
                        visual: "Congruent (≅) = Same shape AND same size"
                    },
                    {
                        title: "Congruent vs. Similar",
                        explanation: "<strong>Similar:</strong> Same shape, different size (proportional sides)<br><br><strong>Congruent:</strong> Same shape, SAME size (equal sides)<br><br>Congruent shapes are like identical twins - exactly the same!",
                        visual: "Similar: same shape | Congruent: exact copies"
                    },
                    {
                        title: "Congruence Statements",
                        explanation: "When we write △ABC ≅ △DEF, the ORDER matters!<br><br>• A corresponds to D<br>• B corresponds to E<br>• C corresponds to F<br><br>AB corresponds to DE, BC to EF, AC to DF",
                        visual: "ABC ≅ DEF → A↔D, B↔E, C↔F"
                    },
                    {
                        title: "Triangle Congruence Rules",
                        explanation: "To prove triangles are congruent, use:<br><br>• <strong>SSS:</strong> Side-Side-Side (all 3 sides equal)<br>• <strong>SAS:</strong> Side-Angle-Side (2 sides + included angle)<br>• <strong>ASA:</strong> Angle-Side-Angle (2 angles + included side)<br>• <strong>AAS:</strong> Angle-Angle-Side<br>• <strong>HL:</strong> Hypotenuse-Leg (right triangles only)",
                        visual: "SSS | SAS | ASA | AAS | HL"
                    },
                    {
                        title: "Solving Our Problem",
                        explanation: "△ABC ≅ △DEF<br><br>AB corresponds to DE (same position in each triangle name).<br><br>Since congruent shapes have <strong>equal</strong> corresponding parts:<br><br><strong>DE = AB = 7 cm</strong>",
                        visual: "AB ↔ DE → DE = 7 cm"
                    }
                ],
                finalAnswer: "7 cm",
                answerExplanation: "In congruent triangles, corresponding sides are equal. Since AB corresponds to DE and AB = 7 cm, DE = 7 cm.",
                example: { problem: `△ABC ≅ △DEF. If AB = 7 cm, find DE.`, steps: [
                    { text: "Identify corresponding sides", math: "AB corresponds to DE" },
                    { text: "Apply congruence property", math: "Corresponding sides are equal" },
                    { text: "Therefore", math: "<strong>DE = 7 cm</strong>" }
                ]},
                keyPoints: [
                    "Congruent = same shape AND same size",
                    "Corresponding parts of congruent triangles are equal (CPCTC)",
                    "Order of letters in congruence statement shows correspondence"
                ],
                mistakes: [
                    { wrong: "Matching wrong letters", why: "Match letters by POSITION: 1st↔1st, 2nd↔2nd, 3rd↔3rd" },
                    { wrong: "Confusing similar and congruent", why: "Similar = proportional, Congruent = EQUAL" }
                ],
                guided: {
                    problem: `△PQR ≅ △XYZ. If PQ = ${side} cm and QR = ${side + 3} cm, what is XY?`,
                    steps: [
                        { label: "PQ corresponds to", value: "XY" },
                        { label: "Congruent sides are", value: "equal" },
                        { label: "XY =", value: "?" }
                    ],
                    answer: String(side),
                    answerLabel: "XY =",
                    interactiveSteps: [
                        {
                            prompt: "In △PQR ≅ △XYZ, which side corresponds to PQ?",
                            hint: "Match by position: P↔X, Q↔Y, R↔Z. So PQ↔...",
                            answer: "XY",
                            acceptableAnswers: ["XY", "xy"],
                            commonMistakes: {
                                "YZ": "YZ corresponds to QR, not PQ. P↔X and Q↔Y, so PQ↔XY",
                                "XZ": "XZ corresponds to PR. PQ corresponds to XY"
                            }
                        },
                        {
                            prompt: `Since congruent sides are equal, and PQ = ${side}, what is XY?`,
                            hint: "Congruent means equal in length...",
                            answer: String(side),
                            acceptableAnswers: [String(side), `${side} cm`, `${side}cm`],
                            commonMistakes: {
                                [String(side + 3)]: `That's the length of QR, not PQ. XY = PQ = ${side}`,
                                [String(side * 2)]: `No need to multiply! Congruent means EQUAL: XY = ${side}`
                            }
                        }
                    ]
                },
                practice: { problem: `△ABC ≅ △DEF. Angle B = 45°. What is angle E?`, answer: "45°",
                    options: ["45°", "90°", "135°", "Cannot determine"],
                    mistakeAnalysis: {
                        "90°": "Corresponding angles in congruent triangles are EQUAL, not complementary. E = B = 45°",
                        "135°": "Corresponding angles are equal, not supplementary. E = B = 45°",
                        "Cannot determine": "We CAN determine! B corresponds to E (2nd letter), and congruent means equal."
                    }}
            };
        },
        Proofs: () => ({
            goalProblem: `Given: Lines AB and CD are parallel, cut by transversal EF. Prove: Alternate interior angles are equal.`,
            teachingSteps: [
                {
                    title: "What is a Geometric Proof?",
                    explanation: "A <strong>proof</strong> is a logical argument that uses:<br><br>• <strong>Given information</strong> (what we start with)<br>• <strong>Definitions and properties</strong> (things we know are true)<br>• <strong>Logical steps</strong> (connecting ideas)<br><br>...to <strong>prove a conclusion</strong> must be true.",
                    visual: "Given → Logical Steps → Conclusion"
                },
                {
                    title: "Two-Column Proofs",
                    explanation: "The most common format:<br><br><strong>Statement | Reason</strong><br>1. What you know | Why you know it<br>2. Next fact | Why it's true<br>...<br>Final: Conclusion | Final reason<br><br>Every statement needs a reason!",
                    visual: "Statement | Reason (every step justified)"
                },
                {
                    title: "Common Reasons in Proofs",
                    explanation: "• <strong>Given</strong> - stated in the problem<br>• <strong>Definition</strong> - what a term means<br>• <strong>Postulate/Axiom</strong> - accepted without proof<br>• <strong>Theorem</strong> - previously proven<br>• <strong>Substitution</strong> - replacing equals<br>• <strong>Transitive property</strong> - if a=b and b=c, then a=c",
                    visual: "Given | Definition | Postulate | Theorem | Substitution | Transitive"
                },
                {
                    title: "Parallel Line Angle Relationships",
                    explanation: "When a transversal crosses parallel lines:<br><br>• <strong>Corresponding angles</strong> are equal (same position)<br>• <strong>Alternate interior angles</strong> are equal (opposite sides, between lines)<br>• <strong>Co-interior (same-side)</strong> angles sum to 180°",
                    visual: "Corresponding: = | Alt. interior: = | Co-interior: sum to 180°"
                },
                {
                    title: "Our Proof Strategy",
                    explanation: "We'll use these facts:<br><br>1. Corresponding angles are equal (postulate)<br>2. Vertical angles are equal (theorem)<br>3. Use transitive property to connect alternate interior angles<br><br>This shows WHY alternate interior angles must be equal!",
                    visual: "Corresponding → Vertical → Alternate Interior"
                },
                {
                    title: "The Two-Column Proof",
                    explanation: "<strong>1.</strong> AB ∥ CD | Given<br><strong>2.</strong> ∠1 ≅ ∠3 | Corresponding angles (parallel lines)<br><strong>3.</strong> ∠3 ≅ ∠2 | Vertical angles are equal<br><strong>4.</strong> ∠1 ≅ ∠2 | Transitive property<br><br>∠1 and ∠2 are alternate interior angles ✓",
                    visual: "Corresponding = Vertical → Alternate Interior equal!"
                }
            ],
            finalAnswer: "Alternate interior angles are equal (proven via corresponding and vertical angles)",
            answerExplanation: "Using the transitive property, we connected corresponding angles (equal by postulate) and vertical angles (equal by theorem) to prove alternate interior angles must be equal.",
            example: { problem: `Prove: Alternate interior angles are equal`, steps: [
                { text: "Corresponding angles are equal", math: "∠1 = ∠3 (postulate)" },
                { text: "Vertical angles are equal", math: "∠3 = ∠2 (theorem)" },
                { text: "By transitive property", math: "∠1 = ∠2" },
                { text: "Conclusion", math: "<strong>Alternate interior angles are equal</strong>" }
            ]},
            keyPoints: [
                "Every statement in a proof needs a reason",
                "Use given info, definitions, postulates, and theorems",
                "Transitive property connects equal quantities"
            ],
            mistakes: [
                { wrong: "Skipping steps or reasons", why: "Every statement must be justified - no jumping to conclusions!" },
                { wrong: "Using what you're trying to prove", why: "That's circular reasoning! Use known facts to reach the conclusion." }
            ],
            guided: {
                problem: `Given: ∠A and ∠B are supplementary. ∠B and ∠C are supplementary. Prove: ∠A = ∠C`,
                steps: [
                    { label: "Supplementary means", value: "angles sum to 180°" },
                    { label: "∠A + ∠B =", value: "180°" },
                    { label: "∠B + ∠C =", value: "180°" },
                    { label: "Therefore ∠A =", value: "?" }
                ],
                answer: "∠C",
                answerLabel: "∠A equals:",
                interactiveSteps: [
                    {
                        prompt: "What does 'supplementary' mean?",
                        hint: "Supplementary angles add up to...",
                        answer: "180",
                        acceptableAnswers: ["180", "180°", "180 degrees", "add to 180", "sum to 180"],
                        commonMistakes: {
                            "90": "That's COMPLEMENTARY (add to 90°). Supplementary = 180°",
                            "360": "That's angles in a circle. Supplementary angles sum to 180°"
                        }
                    },
                    {
                        prompt: "If ∠A + ∠B = 180° and ∠B + ∠C = 180°, then ∠A + ∠B = ∠B + ∠C. What property lets us say ∠A = ∠C?",
                        hint: "When we subtract the same thing from both sides...",
                        answer: "subtraction property",
                        acceptableAnswers: ["subtraction property", "subtraction", "subtract ∠B", "subtracting ∠B from both sides"],
                        commonMistakes: {
                            "addition": "We're removing ∠B from both sides, so it's SUBTRACTION property",
                            "transitive": "Transitive is for a=b, b=c → a=c. Here we subtract ∠B from both sides."
                        }
                    }
                ]
            },
            practice: { problem: `In a proof, what is the reason for "∠A = ∠A"?`, answer: "Reflexive property",
                options: ["Reflexive property", "Transitive property", "Given", "Substitution"],
                mistakeAnalysis: {
                    "Transitive property": "Transitive is for a=b and b=c → a=c. 'A thing equals itself' is reflexive.",
                    "Given": "'Given' is for info stated in the problem. A=A is always true (reflexive property).",
                    "Substitution": "Substitution is replacing one thing with an equal thing. A=A is reflexive."
                }}
        }),
        "Law of Sines": () => {
            const A = rand(35, 55), B = rand(45, 65);
            const C = 180 - A - B;
            const a = rand(8, 15);
            const b = Math.round(a * Math.sin(B * Math.PI / 180) / Math.sin(A * Math.PI / 180) * 10) / 10;
            return {
                goalProblem: `In triangle ABC: A = 40°, B = 60°, a = 10. Find side b.`,
                teachingSteps: [
                    {
                        title: "What is the Law of Sines?",
                        explanation: "The <strong>Law of Sines</strong> relates sides and angles in ANY triangle:<br><br><strong>a/sin(A) = b/sin(B) = c/sin(C)</strong><br><br>Side 'a' is opposite angle A, side 'b' is opposite angle B, etc.",
                        visual: "a/sin(A) = b/sin(B) = c/sin(C)"
                    },
                    {
                        title: "When to Use Law of Sines",
                        explanation: "Use Law of Sines when you know:<br><br>• <strong>AAS</strong> - Two angles and a non-included side<br>• <strong>ASA</strong> - Two angles and the included side<br>• <strong>SSA</strong> - Two sides and an angle opposite one of them<br><br>It's for angle-side pairs!",
                        visual: "AAS, ASA, or SSA → Law of Sines"
                    },
                    {
                        title: "Setting Up the Proportion",
                        explanation: "We know: A = 40°, B = 60°, a = 10, and need b.<br><br>Use the pairs with known info:<br><br><strong>a/sin(A) = b/sin(B)</strong><br>10/sin(40°) = b/sin(60°)",
                        visual: "10/sin(40°) = b/sin(60°)"
                    },
                    {
                        title: "Step 1: Find the Sine Values",
                        explanation: "Using a calculator (or table):<br><br>sin(40°) ≈ <strong>0.643</strong><br>sin(60°) ≈ <strong>0.866</strong>",
                        visual: "sin(40°) ≈ 0.643 | sin(60°) ≈ 0.866"
                    },
                    {
                        title: "Step 2: Cross-Multiply and Solve",
                        explanation: "10/0.643 = b/0.866<br><br>Cross-multiply:<br>10 × 0.866 = b × 0.643<br>8.66 = 0.643b<br><br>b = 8.66 / 0.643 ≈ <strong>13.5</strong>",
                        visual: "b = (10 × 0.866) / 0.643 ≈ 13.5"
                    }
                ],
                finalAnswer: "b ≈ 13.5",
                answerExplanation: "Using Law of Sines: b = a × sin(B)/sin(A) = 10 × sin(60°)/sin(40°) ≈ 13.5",
                example: { problem: `A = 40°, B = 60°, a = 10. Find b.`, steps: [
                    { text: "Write Law of Sines", math: "a/sin(A) = b/sin(B)" },
                    { text: "Substitute known values", math: "10/sin(40°) = b/sin(60°)" },
                    { text: "Solve for b", math: "b = 10 × sin(60°)/sin(40°)" },
                    { text: "Calculate", math: "<strong>b ≈ 13.5</strong>" }
                ]},
                keyPoints: [
                    "Law of Sines: a/sin(A) = b/sin(B) = c/sin(C)",
                    "Side 'a' is OPPOSITE angle A",
                    "Use when you have angle-side pairs"
                ],
                mistakes: [
                    { wrong: "Matching side to wrong angle", why: "Each side is opposite its corresponding angle (a opposite A)" },
                    { wrong: "Using degrees in calculator set to radians", why: "Make sure calculator is in DEGREE mode for degree problems!" }
                ],
                guided: {
                    problem: `In triangle ABC: A = ${A}°, B = ${B}°, a = ${a}. Find side b (round to 1 decimal).`,
                    steps: [
                        { label: "Law of Sines setup", value: `${a}/sin(${A}°) = b/sin(${B}°)` },
                        { label: "sin(${A}°) ≈", value: String(Math.round(Math.sin(A * Math.PI / 180) * 1000) / 1000) },
                        { label: "sin(${B}°) ≈", value: String(Math.round(Math.sin(B * Math.PI / 180) * 1000) / 1000) }
                    ],
                    answer: String(b),
                    answerLabel: "b ≈",
                    interactiveSteps: [
                        {
                            prompt: "What is the Law of Sines formula?",
                            hint: "It relates sides a, b, c to angles A, B, C using sine...",
                            answer: "a/sin(A) = b/sin(B)",
                            acceptableAnswers: ["a/sin(A) = b/sin(B)", "a/sinA = b/sinB", "a/sin(A)=b/sin(B)=c/sin(C)", "a/sin A = b/sin B = c/sin C"],
                            commonMistakes: {
                                "a² + b² = c²": "That's the Pythagorean theorem (right triangles only). Law of Sines works for ALL triangles.",
                                "sin = opp/hyp": "That's SOH CAH TOA for right triangles. Law of Sines is a/sin(A) = b/sin(B)"
                            }
                        },
                        {
                            prompt: `To find b, we rearrange to: b = a × sin(B)/sin(A). Plug in: b = ${a} × sin(${B}°)/sin(${A}°). Calculate b (round to 1 decimal).`,
                            hint: `Use sin(${A}°) ≈ ${Math.round(Math.sin(A * Math.PI / 180) * 1000) / 1000} and sin(${B}°) ≈ ${Math.round(Math.sin(B * Math.PI / 180) * 1000) / 1000}`,
                            answer: String(b),
                            acceptableAnswers: [String(b), String(Math.round(b)), String(Math.round(b * 10) / 10)],
                            commonMistakes: {
                                [String(a)]: `You need to multiply ${a} by sin(${B}°)/sin(${A}°), not just use ${a}`
                            }
                        }
                    ]
                },
                practice: { problem: `In Law of Sines, side 'b' is opposite which angle?`, answer: "Angle B",
                    options: ["Angle A", "Angle B", "Angle C", "The largest angle"],
                    mistakeAnalysis: {
                        "Angle A": "Side a is opposite angle A. Side b is opposite angle B.",
                        "Angle C": "Side c is opposite angle C. Each side is opposite its matching letter.",
                        "The largest angle": "Not necessarily! b is always opposite B, regardless of size."
                    }}
            };
        },
        "Law of Cosines": () => {
            const a = rand(5, 9), b = rand(6, 10), C = rand(40, 80);
            const cSquared = a*a + b*b - 2*a*b*Math.cos(C * Math.PI / 180);
            const c = Math.round(Math.sqrt(cSquared) * 10) / 10;
            return {
                goalProblem: `Find side c: a = 8, b = 6, C = 60°`,
                teachingSteps: [
                    {
                        title: "What is the Law of Cosines?",
                        explanation: "The <strong>Law of Cosines</strong> is like an upgraded Pythagorean theorem that works for ALL triangles:<br><br><strong>c² = a² + b² - 2ab·cos(C)</strong><br><br>It connects two sides and the angle BETWEEN them to the third side.",
                        visual: "c² = a² + b² - 2ab·cos(C)"
                    },
                    {
                        title: "When to Use Law of Cosines",
                        explanation: "Use Law of Cosines when you know:<br><br>• <strong>SAS</strong> - Two sides and the INCLUDED angle (the angle between them)<br>• <strong>SSS</strong> - All three sides (to find an angle)<br><br>It's for when you have the angle BETWEEN two known sides!",
                        visual: "SAS or SSS → Law of Cosines"
                    },
                    {
                        title: "Law of Cosines vs. Pythagorean Theorem",
                        explanation: "Notice: if C = 90°, then cos(90°) = 0<br><br>c² = a² + b² - 2ab(0)<br>c² = a² + b²<br><br>The Pythagorean theorem is a SPECIAL CASE of Law of Cosines!",
                        visual: "When C = 90°: c² = a² + b² (Pythagorean!)"
                    },
                    {
                        title: "Step 1: Identify the Known Values",
                        explanation: "We have: a = 8, b = 6, C = 60°<br><br>We're looking for side c (opposite angle C).<br><br>Since we have SAS (two sides and included angle), use Law of Cosines!",
                        visual: "a = 8, b = 6, C = 60° → Find c"
                    },
                    {
                        title: "Step 2: Plug into the Formula",
                        explanation: "c² = a² + b² - 2ab·cos(C)<br>c² = 8² + 6² - 2(8)(6)·cos(60°)<br>c² = 64 + 36 - 96·(0.5)<br>c² = 100 - 48<br>c² = 52",
                        visual: "c² = 64 + 36 - 96(0.5) = 52"
                    },
                    {
                        title: "Step 3: Take the Square Root",
                        explanation: "c² = 52<br>c = √52<br>c ≈ <strong>7.2</strong>",
                        visual: "c = √52 ≈ 7.2"
                    }
                ],
                finalAnswer: "c ≈ 7.2",
                answerExplanation: "Using c² = a² + b² - 2ab·cos(C) with a=8, b=6, C=60°, we get c² = 52, so c ≈ 7.2",
                example: { problem: `a = 8, b = 6, C = 60°. Find c.`, steps: [
                    { text: "Write Law of Cosines", math: "c² = a² + b² - 2ab·cos(C)" },
                    { text: "Substitute values", math: "c² = 64 + 36 - 96·cos(60°)" },
                    { text: "Calculate (cos 60° = 0.5)", math: "c² = 100 - 48 = 52" },
                    { text: "Take square root", math: "<strong>c ≈ 7.2</strong>" }
                ]},
                keyPoints: [
                    "c² = a² + b² - 2ab·cos(C)",
                    "Use when you know SAS (two sides + included angle) or SSS",
                    "The angle in the formula is BETWEEN the two known sides"
                ],
                mistakes: [
                    { wrong: "Using the wrong angle", why: "The angle C must be BETWEEN sides a and b (the included angle)" },
                    { wrong: "Forgetting to take the square root", why: "The formula gives c², so you must take √ to get c" }
                ],
                guided: {
                    problem: `Find side c: a = ${a}, b = ${b}, C = ${C}°`,
                    steps: [
                        { label: "Formula", value: "c² = a² + b² - 2ab·cos(C)" },
                        { label: "a² + b²", value: `${a*a} + ${b*b} = ${a*a + b*b}` },
                        { label: "cos(${C}°)", value: String(Math.round(Math.cos(C * Math.PI / 180) * 1000) / 1000) }
                    ],
                    answer: String(c),
                    answerLabel: "c ≈",
                    interactiveSteps: [
                        {
                            prompt: `First, calculate a² + b² = ${a}² + ${b}² = ?`,
                            hint: `Square each number and add: ${a}×${a} + ${b}×${b}`,
                            answer: String(a*a + b*b),
                            acceptableAnswers: [String(a*a + b*b)],
                            commonMistakes: {
                                [String(a + b)]: `You just added! We need squares: ${a}² + ${b}² = ${a*a} + ${b*b} = ${a*a+b*b}`,
                                [String((a + b) * (a + b))]: `That's (a+b)². We need a² + b² = ${a*a + b*b}`
                            }
                        },
                        {
                            prompt: `Now calculate 2ab = 2 × ${a} × ${b} = ?`,
                            hint: `Multiply 2 × ${a} × ${b}`,
                            answer: String(2*a*b),
                            acceptableAnswers: [String(2*a*b)],
                            commonMistakes: {
                                [String(a*b)]: `Don't forget the 2! 2 × ${a} × ${b} = ${2*a*b}`,
                                [String(2+a+b)]: `You added instead of multiplied! 2 × ${a} × ${b} = ${2*a*b}`
                            }
                        },
                        {
                            prompt: `Finally, c = √c². If c² = ${Math.round(cSquared)}, what is c (round to 1 decimal)?`,
                            hint: `Take the square root of ${Math.round(cSquared)}`,
                            answer: String(c),
                            acceptableAnswers: [String(c), String(Math.round(c))],
                            commonMistakes: {
                                [String(Math.round(cSquared))]: `That's c². Take the SQUARE ROOT to get c ≈ ${c}`,
                                [String(Math.round(cSquared / 2))]: `Don't divide by 2! Take √${Math.round(cSquared)} ≈ ${c}`
                            }
                        }
                    ]
                },
                practice: { problem: `Which situation requires Law of Cosines instead of Law of Sines?`, answer: "SAS - two sides and included angle",
                    options: ["SAS - two sides and included angle", "AAS - two angles and a side", "ASA - two angles and included side", "AAA - three angles"],
                    mistakeAnalysis: {
                        "AAS - two angles and a side": "AAS gives angle-side pairs, so use Law of SINES for this",
                        "ASA - two angles and included side": "ASA involves angle pairs, so Law of SINES works here",
                        "AAA - three angles": "AAA doesn't uniquely determine a triangle (infinite similar triangles possible)"
                    }}
            };
        },
        "Coordinate Geometry": () => {
            const x1 = rand(1, 5), y1 = rand(1, 5);
            const x2 = rand(6, 10), y2 = rand(6, 10);
            const dist = Math.round(Math.sqrt((x2-x1)**2 + (y2-y1)**2) * 100) / 100;
            const midX = (x1 + x2) / 2, midY = (y1 + y2) / 2;
            return {
                goalProblem: `Find the distance between points A(1, 2) and B(4, 6)`,
                teachingSteps: [
                    {
                        title: "What is Coordinate Geometry?",
                        explanation: "<strong>Coordinate geometry</strong> combines algebra and geometry by placing shapes on a coordinate plane.<br><br>We use coordinates (x, y) to precisely locate points and calculate geometric properties!",
                        visual: "Algebra + Geometry = Coordinate Geometry"
                    },
                    {
                        title: "The Distance Formula",
                        explanation: "To find the distance between two points (x₁, y₁) and (x₂, y₂):<br><br><strong>d = √[(x₂-x₁)² + (y₂-y₁)²]</strong><br><br>This is the Pythagorean theorem in disguise!",
                        visual: "d = √[(x₂-x₁)² + (y₂-y₁)²]"
                    },
                    {
                        title: "The Midpoint Formula",
                        explanation: "To find the point exactly halfway between (x₁, y₁) and (x₂, y₂):<br><br><strong>Midpoint = ((x₁+x₂)/2, (y₁+y₂)/2)</strong><br><br>Just average the x's and average the y's!",
                        visual: "Midpoint = ((x₁+x₂)/2, (y₁+y₂)/2)"
                    },
                    {
                        title: "The Slope Formula",
                        explanation: "Slope measures <em>steepness</em> - how much y changes per unit of x:<br><br><strong>m = (y₂-y₁)/(x₂-x₁) = rise/run</strong><br><br>Positive slope: goes up ↗ | Negative slope: goes down ↘",
                        visual: "m = (y₂-y₁)/(x₂-x₁) = rise/run"
                    },
                    {
                        title: "Step 1: Identify the Coordinates",
                        explanation: "Point A: (1, 2) → x₁ = 1, y₁ = 2<br>Point B: (4, 6) → x₂ = 4, y₂ = 6",
                        visual: "A(1, 2) and B(4, 6)"
                    },
                    {
                        title: "Step 2: Apply the Distance Formula",
                        explanation: "d = √[(x₂-x₁)² + (y₂-y₁)²]<br>d = √[(4-1)² + (6-2)²]<br>d = √[3² + 4²]<br>d = √[9 + 16]<br>d = √25<br>d = <strong>5</strong>",
                        visual: "d = √[9 + 16] = √25 = 5"
                    }
                ],
                finalAnswer: "5",
                answerExplanation: "Using the distance formula: d = √[(4-1)² + (6-2)²] = √[9+16] = √25 = 5",
                example: { problem: `Distance from A(1,2) to B(4,6)`, steps: [
                    { text: "Write the distance formula", math: "d = √[(x₂-x₁)² + (y₂-y₁)²]" },
                    { text: "Substitute", math: "d = √[(4-1)² + (6-2)²]" },
                    { text: "Calculate differences", math: "d = √[3² + 4²] = √[9 + 16]" },
                    { text: "Final answer", math: "<strong>d = √25 = 5</strong>" }
                ]},
                keyPoints: [
                    "Distance formula: d = √[(x₂-x₁)² + (y₂-y₁)²]",
                    "Midpoint: average the x's and y's",
                    "Slope: m = rise/run = (y₂-y₁)/(x₂-x₁)"
                ],
                mistakes: [
                    { wrong: "Subtracting in wrong order for distance", why: "Order doesn't matter for distance since we SQUARE the differences" },
                    { wrong: "Forgetting to square the differences", why: "The formula requires (x₂-x₁)² not just (x₂-x₁)" }
                ],
                guided: {
                    problem: `Find the distance between P(${x1}, ${y1}) and Q(${x2}, ${y2}). Round to 2 decimal places.`,
                    steps: [
                        { label: "x₂ - x₁", value: `${x2} - ${x1} = ${x2 - x1}` },
                        { label: "y₂ - y₁", value: `${y2} - ${y1} = ${y2 - y1}` },
                        { label: "Distance", value: "?" }
                    ],
                    answer: String(dist),
                    answerLabel: "Distance ≈",
                    interactiveSteps: [
                        {
                            prompt: `Calculate x₂ - x₁ = ${x2} - ${x1} = ?`,
                            hint: `Subtract: ${x2} minus ${x1}`,
                            answer: String(x2 - x1),
                            acceptableAnswers: [String(x2 - x1)],
                            commonMistakes: {
                                [String(x2 + x1)]: `You added! Subtract: ${x2} - ${x1} = ${x2 - x1}`,
                                [String(x1 - x2)]: `That's ${x1} - ${x2}. Either order works (we'll square it anyway).`
                            }
                        },
                        {
                            prompt: `Calculate y₂ - y₁ = ${y2} - ${y1} = ?`,
                            hint: `Subtract: ${y2} minus ${y1}`,
                            answer: String(y2 - y1),
                            acceptableAnswers: [String(y2 - y1)],
                            commonMistakes: {
                                [String(y2 + y1)]: `You added! Subtract: ${y2} - ${y1} = ${y2 - y1}`
                            }
                        },
                        {
                            prompt: `Now use d = √[(${x2-x1})² + (${y2-y1})²]. Calculate the distance (round to 2 decimals).`,
                            hint: `Square each difference, add them, then take the square root`,
                            answer: String(dist),
                            acceptableAnswers: [String(dist), String(Math.round(dist * 10) / 10), String(Math.round(dist))],
                            commonMistakes: {
                                [String((x2-x1)**2 + (y2-y1)**2)]: `That's the sum of squares (${(x2-x1)**2 + (y2-y1)**2}). Don't forget to take the SQUARE ROOT!`
                            }
                        }
                    ]
                },
                practice: { problem: `What is the midpoint of (0, 0) and (6, 8)?`, answer: "(3, 4)",
                    options: ["(3, 4)", "(6, 8)", "(14, 0)", "(2, 4)"],
                    mistakeAnalysis: {
                        "(6, 8)": "That's one of the endpoints! Midpoint = ((0+6)/2, (0+8)/2) = (3, 4)",
                        "(14, 0)": "You might have added wrong. Midpoint averages: (6/2, 8/2) = (3, 4)",
                        "(2, 4)": "Check your division. (0+6)/2 = 3, not 2. Midpoint = (3, 4)"
                    }}
            };
        }
    },
    7: {
        Quadratics: () => {
            const a = 1, b = rand(-8, 8), c = rand(-10, 10);
            return {
                goalProblem: `Solve: x² + 5x + 6 = 0`,
                teachingSteps: [
                    {
                        title: "What is a Quadratic Equation?",
                        explanation: "A <strong>quadratic equation</strong> has the form:<br><br><strong>ax² + bx + c = 0</strong><br><br>The highest power of x is 2 (that's what makes it quadratic!).",
                        visual: "ax² + bx + c = 0 (x² is the key!)"
                    },
                    {
                        title: "Ways to Solve Quadratics",
                        explanation: "Three main methods:<br><br>1. <strong>Factoring</strong> - Break into (x + p)(x + q) = 0<br>2. <strong>Quadratic Formula</strong> - x = (-b ± √(b²-4ac)) / 2a<br>3. <strong>Completing the Square</strong><br><br>We'll use factoring (the easiest when it works!).",
                        visual: "Factoring → Formula → Completing the Square"
                    },
                    {
                        title: "The Factoring Strategy",
                        explanation: "For x² + bx + c = 0, find two numbers that:<br><br>• <strong>MULTIPLY</strong> to give c (the constant)<br>• <strong>ADD</strong> to give b (the x coefficient)<br><br>Then write: (x + first#)(x + second#) = 0",
                        visual: "Find p and q where: p × q = c AND p + q = b"
                    },
                    {
                        title: "Step 1: Identify b and c",
                        explanation: "In <strong>x² + 5x + 6 = 0</strong>:<br><br>• b = <strong>5</strong> (coefficient of x)<br>• c = <strong>6</strong> (constant term)<br><br>We need numbers that multiply to 6 and add to 5.",
                        visual: "b = 5, c = 6 → Find: ___ × ___ = 6 and ___ + ___ = 5"
                    },
                    {
                        title: "Step 2: Find the Two Numbers",
                        explanation: "What multiplies to 6 AND adds to 5?<br><br>Try: 1 × 6 = 6, but 1 + 6 = 7 ✗<br>Try: <strong>2 × 3 = 6</strong>, and <strong>2 + 3 = 5</strong> ✓<br><br>Our numbers are <strong>2 and 3</strong>!",
                        visual: "2 × 3 = 6 ✓ | 2 + 3 = 5 ✓ → Numbers: 2 and 3"
                    },
                    {
                        title: "Step 3: Write in Factored Form",
                        explanation: "Using 2 and 3:<br><br>x² + 5x + 6 = <strong>(x + 2)(x + 3) = 0</strong>",
                        visual: "(x + 2)(x + 3) = 0"
                    },
                    {
                        title: "Step 4: Zero Product Property",
                        explanation: "If two things multiply to zero, one of them MUST be zero!<br><br>(x + 2)(x + 3) = 0 means:<br>• x + 2 = 0 → <strong>x = -2</strong><br>• x + 3 = 0 → <strong>x = -3</strong>",
                        visual: "x + 2 = 0 → x = -2 | x + 3 = 0 → x = -3"
                    }
                ],
                finalAnswer: "x = -2 or x = -3",
                answerExplanation: "We factored to (x + 2)(x + 3) = 0, then set each factor equal to zero: x = -2 and x = -3.",
                example: { problem: `Solve: x² + 5x + 6 = 0 by factoring`, steps: [
                    { text: "Find numbers that multiply to 6 and add to 5", math: "2 × 3 = 6, 2 + 3 = 5 ✓" },
                    { text: "Factor", math: "(x + 2)(x + 3) = 0" },
                    { text: "Set each factor to zero", math: "x + 2 = 0 or x + 3 = 0" },
                    { text: "Solve each", math: "<strong>x = -2 or x = -3</strong>" }
                ]},
                keyPoints: [
                    "Set each factor equal to zero (Zero Product Property)",
                    "Quadratics can have 0, 1, or 2 real solutions",
                    "The quadratic formula always works (when factoring is hard)"
                ],
                mistakes: [
                    { wrong: "Forgetting the ± in the quadratic formula", why: "There are TWO solutions: one with + and one with −" },
                    { wrong: "(x + 2)(x + 3) = 0 → x = 2, x = 3", why: "Wrong signs! x + 2 = 0 means x = -2, not x = 2" }
                ],
                guided: {
                    problem: `Solve: x² + 5x + 6 = 0`,
                    steps: [
                        { label: "Factor: need numbers that multiply to 6, add to 5", value: "2 and 3" },
                        { label: "Factored form", value: "(x + 2)(x + 3) = 0" },
                        { label: "Solutions", value: "?" }
                    ],
                    answer: "x = -2, x = -3",
                    answerLabel: "x = ?",
                    interactiveSteps: [
                        {
                            prompt: "We need two numbers that MULTIPLY to 6 and ADD to 5. What are they?",
                            hint: "Think of factor pairs of 6: (1,6), (2,3)... which pair adds to 5?",
                            answer: "2 and 3",
                            acceptableAnswers: ["2 and 3", "2, 3", "2 3", "3 and 2", "3, 2"],
                            commonMistakes: {
                                "1 and 6": "1 × 6 = 6 ✓ but 1 + 6 = 7 ✗. We need 2 and 3 (2 + 3 = 5)",
                                "2 and 5": "2 + 5 = 7, not 5. The numbers are 2 and 3",
                                "1 and 5": "1 × 5 = 5, not 6. We need numbers that MULTIPLY to 6 and ADD to 5"
                            }
                        },
                        {
                            prompt: "Now write it in factored form: (x + ?)(x + ?) = 0",
                            hint: "Use the numbers 2 and 3 in the factors",
                            answer: "(x + 2)(x + 3)",
                            acceptableAnswers: ["(x + 2)(x + 3)", "(x+2)(x+3)", "(x + 3)(x + 2)", "(x+3)(x+2)"],
                            commonMistakes: {
                                "(x - 2)(x - 3)": "Since we're adding positive numbers, use + not -: (x + 2)(x + 3)",
                                "(x + 5)(x + 6)": "5 and 6 are from the equation, but we need to use the factor pair: (x + 2)(x + 3)"
                            }
                        },
                        {
                            prompt: "If x + 2 = 0, what is x?",
                            hint: "Subtract 2 from both sides",
                            answer: "-2",
                            acceptableAnswers: ["-2", "x = -2", "x=-2"],
                            commonMistakes: {
                                "2": "If x + 2 = 0, then x = 0 - 2 = -2 (subtract, don't keep positive)",
                                "-3": "That's the other solution. From x + 2 = 0, we get x = -2"
                            }
                        },
                        {
                            prompt: "If x + 3 = 0, what is x?",
                            hint: "Subtract 3 from both sides",
                            answer: "-3",
                            acceptableAnswers: ["-3", "x = -3", "x=-3"],
                            commonMistakes: {
                                "3": "If x + 3 = 0, then x = 0 - 3 = -3 (subtract, don't keep positive)",
                                "-2": "That's the other solution. From x + 3 = 0, we get x = -3"
                            }
                        }
                    ]
                },
                practice: { problem: `What are the solutions to (x - 4)(x + 1) = 0?`, answer: "x = 4, x = -1",
                    options: ["x = 4, x = -1", "x = -4, x = 1", "x = 4, x = 1", "x = -4, x = -1"],
                    mistakeAnalysis: {
                        "x = -4, x = 1": "Signs are flipped. x - 4 = 0 → x = 4; x + 1 = 0 → x = -1",
                        "x = 4, x = 1": "x + 1 = 0 means x = -1, not x = 1",
                        "x = -4, x = -1": "x - 4 = 0 means x = 4, not x = -4"
                    }}
            };
        },
        "Completing the Square": () => {
            const h = rand(2, 5);
            const k = rand(1, 8);
            const b = 2 * h;
            const c = h * h + k;
            return {
                goalProblem: `Rewrite x² + 6x + 5 in vertex form by completing the square`,
                teachingSteps: [
                    {
                        title: "What is Completing the Square?",
                        explanation: "<strong>Completing the square</strong> is a technique to rewrite a quadratic expression in <strong>vertex form</strong>:<br><br>x² + bx + c → <strong>(x + h)² + k</strong><br><br>This form tells us the vertex is at (-h, k)!",
                        visual: "Standard: x² + bx + c → Vertex: (x + h)² + k"
                    },
                    {
                        title: "Why is it Called 'Completing the Square'?",
                        explanation: "We're making a <strong>perfect square trinomial</strong>!<br><br>A perfect square like (x + 3)² expands to x² + 6x + 9.<br><br>We manipulate our expression to create this pattern.",
                        visual: "(x + 3)² = x² + 6x + 9 ← Perfect square!"
                    },
                    {
                        title: "The Key Formula",
                        explanation: "To complete the square for <strong>x² + bx</strong>:<br><br>1. Take <strong>half of b</strong>: b/2<br>2. <strong>Square it</strong>: (b/2)²<br>3. Add and subtract this value<br><br>This creates (x + b/2)²",
                        visual: "x² + bx + (b/2)² = (x + b/2)²"
                    },
                    {
                        title: "Step 1: Identify b",
                        explanation: "In <strong>x² + 6x + 5</strong>:<br><br>The coefficient of x is <strong>b = 6</strong>",
                        visual: "x² + 6x + 5 → b = 6"
                    },
                    {
                        title: "Step 2: Calculate (b/2)²",
                        explanation: "Half of 6 is <strong>3</strong><br><br>Square it: 3² = <strong>9</strong><br><br>This is the magic number we need!",
                        visual: "b/2 = 6/2 = 3 → 3² = 9"
                    },
                    {
                        title: "Step 3: Add and Subtract 9",
                        explanation: "x² + 6x + 5<br><br>= x² + 6x <strong>+ 9 - 9</strong> + 5<br><br>We added 9 and subtracted 9 (net zero change!)",
                        visual: "x² + 6x + 9 - 9 + 5"
                    },
                    {
                        title: "Step 4: Group the Perfect Square",
                        explanation: "The first three terms form a perfect square:<br><br>(x² + 6x + 9) - 9 + 5<br><br>= <strong>(x + 3)²</strong> - 9 + 5<br><br>= <strong>(x + 3)² - 4</strong>",
                        visual: "(x + 3)² - 4"
                    },
                    {
                        title: "The Answer in Vertex Form",
                        explanation: "<strong>x² + 6x + 5 = (x + 3)² - 4</strong><br><br>Vertex form: (x - h)² + k → vertex at (h, k)<br>Our form: (x - (-3))² + (-4) → vertex at <strong>(-3, -4)</strong>",
                        visual: "Vertex form: (x + 3)² - 4 | Vertex: (-3, -4)"
                    }
                ],
                finalAnswer: "(x + 3)² - 4",
                answerExplanation: "We took half of 6 (which is 3), squared it (9), added and subtracted 9, then grouped to get (x + 3)² - 4.",
                example: { problem: `Rewrite x² + 6x + 5 in vertex form`, steps: [
                    { text: "Find half of b", math: "b = 6, so b/2 = 3" },
                    { text: "Square it", math: "3² = 9" },
                    { text: "Add and subtract 9", math: "x² + 6x + 9 - 9 + 5" },
                    { text: "Group the perfect square", math: "(x + 3)² - 9 + 5" },
                    { text: "Simplify", math: "<strong>(x + 3)² - 4</strong>" }
                ]},
                keyPoints: [
                    "Take half of b and square it: (b/2)²",
                    "Add and subtract this value to keep the expression equal",
                    "Vertex form (x - h)² + k has vertex at (h, k)"
                ],
                mistakes: [
                    { wrong: "Forgetting to subtract the value you added", why: "If you add 9, you must subtract 9 to keep the equation balanced!" },
                    { wrong: "Using b instead of b/2", why: "You must take HALF of b first, then square it. For b = 6: (6/2)² = 9, not 6² = 36" },
                    { wrong: "Getting the vertex signs wrong", why: "(x + 3)² means h = -3. The vertex is at (-3, k), not (3, k)" }
                ],
                guided: {
                    problem: `Rewrite x² + ${b}x + ${c} in vertex form`,
                    steps: [
                        { label: "Half of " + b, value: String(h) },
                        { label: "Square it", value: String(h * h) },
                        { label: "Vertex form", value: "?" }
                    ],
                    answer: `(x + ${h})² + ${k}`,
                    answerLabel: "Vertex form:",
                    interactiveSteps: [
                        {
                            prompt: `In x² + ${b}x + ${c}, what is b (the coefficient of x)?`,
                            hint: "Look at the number in front of x",
                            answer: String(b),
                            acceptableAnswers: [String(b)],
                            commonMistakes: {
                                [String(c)]: `${c} is the constant term (c). The coefficient of x is ${b}.`,
                                "1": "That's the coefficient of x². The coefficient of x is " + b
                            }
                        },
                        {
                            prompt: `What is half of ${b}?`,
                            hint: `${b} ÷ 2 = ?`,
                            answer: String(h),
                            acceptableAnswers: [String(h)],
                            commonMistakes: {
                                [String(b)]: `We need HALF of ${b}. ${b} ÷ 2 = ${h}`,
                                [String(b * b)]: `That's ${b} squared. We need half of ${b}, which is ${h}`
                            }
                        },
                        {
                            prompt: `Now square ${h}. What is ${h}²?`,
                            hint: `${h} × ${h} = ?`,
                            answer: String(h * h),
                            acceptableAnswers: [String(h * h)],
                            commonMistakes: {
                                [String(h * 2)]: `That's ${h} × 2. We need ${h}² = ${h} × ${h} = ${h * h}`,
                                [String(h)]: `You need to square ${h}. ${h}² = ${h * h}`
                            }
                        },
                        {
                            prompt: `x² + ${b}x + ${h * h} = (x + ?)²`,
                            hint: "This perfect square trinomial equals (x + b/2)²",
                            answer: String(h),
                            acceptableAnswers: [String(h), `(x + ${h})`, `(x+${h})`],
                            commonMistakes: {
                                [String(b)]: `Use half of b, not b itself. (x + ${h})²`,
                                [String(h * h)]: `${h * h} is (b/2)². The answer is (x + ${h})²`
                            }
                        },
                        {
                            prompt: `We added ${h * h} to make the perfect square, but the original constant was ${c}. What is ${c} - ${h * h}?`,
                            hint: "This becomes the k value in vertex form",
                            answer: String(k),
                            acceptableAnswers: [String(k)],
                            commonMistakes: {
                                [String(c + h * h)]: `Subtract, not add! ${c} - ${h * h} = ${k}`,
                                [String(c)]: `You need to subtract what we added: ${c} - ${h * h} = ${k}`
                            }
                        },
                        {
                            prompt: `So the vertex form is (x + ${h})² + ?`,
                            hint: "We calculated k = " + k,
                            answer: `(x + ${h})² + ${k}`,
                            acceptableAnswers: [`(x + ${h})² + ${k}`, `(x+${h})² + ${k}`, `(x+${h})²+${k}`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `What is the vertex of y = (x - 2)² + 5?`, answer: "(2, 5)",
                    options: ["(2, 5)", "(-2, 5)", "(2, -5)", "(-2, -5)"],
                    mistakeAnalysis: {
                        "(-2, 5)": "Watch the signs! (x - 2)² means h = 2 (positive), so vertex is (2, 5)",
                        "(2, -5)": "k = 5 (positive). The vertex is (2, 5)",
                        "(-2, -5)": "Both signs are wrong. (x - h)² + k has vertex (h, k). Here h = 2, k = 5"
                    }}
            };
        },
        Logarithms: () => {
            const base = pick([2, 10]);
            const exp = rand(2, 4);
            const result = Math.pow(base, exp);
            return {
                goalProblem: `Find log₂(32)`,
                teachingSteps: [
                    {
                        title: "What is a Logarithm?",
                        explanation: "A <strong>logarithm</strong> answers the question:<br><br><em>\"What EXPONENT do I need?\"</em><br><br>log₂(8) asks: \"2 to WHAT POWER gives me 8?\"",
                        visual: "log = \"What exponent?\""
                    },
                    {
                        title: "The Definition",
                        explanation: "<strong>log_b(x) = y</strong> means <strong>b^y = x</strong><br><br>In words: \"log base b of x equals y\"<br><br>The LOG and EXPONENT forms say the same thing!",
                        visual: "log_b(x) = y ↔ b^y = x"
                    },
                    {
                        title: "Example to Build Intuition",
                        explanation: "log₂(8) = ?<br><br>Ask: 2 to what power equals 8?<br>2¹ = 2<br>2² = 4<br>2³ = <strong>8</strong> ✓<br><br>So log₂(8) = <strong>3</strong>",
                        visual: "2³ = 8, so log₂(8) = 3"
                    },
                    {
                        title: "Step 1: Understand What We're Finding",
                        explanation: "log₂(32) asks: \"<strong>2 to what power equals 32?</strong>\"<br><br>We're looking for the exponent.",
                        visual: "2^? = 32"
                    },
                    {
                        title: "Step 2: List Powers of 2",
                        explanation: "Let's calculate powers of 2 until we reach 32:<br><br>2¹ = 2<br>2² = 4<br>2³ = 8<br>2⁴ = 16<br>2⁵ = <strong>32</strong> ✓",
                        visual: "2¹=2, 2²=4, 2³=8, 2⁴=16, 2⁵=32"
                    },
                    {
                        title: "Step 3: Write the Answer",
                        explanation: "Since 2⁵ = 32, we know:<br><br><strong>log₂(32) = 5</strong><br><br>The exponent we needed was 5!",
                        visual: "2⁵ = 32 → log₂(32) = 5"
                    }
                ],
                finalAnswer: "5",
                answerExplanation: "We asked \"2 to what power equals 32?\" and found that 2⁵ = 32, so the answer is 5.",
                example: { problem: `Find log₂(32)`, steps: [
                    { text: "Ask: 2 to what power equals 32?", math: "2^? = 32" },
                    { text: "Calculate powers of 2", math: "2¹=2, 2²=4, 2³=8, 2⁴=16, 2⁵=32" },
                    { text: "2⁵ = 32", math: "<strong>log₂(32) = 5</strong>" }
                ]},
                keyPoints: [
                    "log_b(x) asks: 'b to what power equals x?'",
                    "log_b(b) = 1 always (b¹ = b)",
                    "log_b(1) = 0 always (b⁰ = 1)"
                ],
                mistakes: [
                    { wrong: "Thinking log₂(8) = 8 ÷ 2 = 4", why: "Logs aren't division! Ask: 2 to what power = 8? Answer: 3" },
                    { wrong: "Confusing the base and the result", why: "In log₂(8) = 3, the base is 2, the input is 8, the answer is 3" }
                ],
                guided: {
                    problem: `Find log_${base}(${result})`,
                    steps: [
                        { label: `Ask: ${base} to what power = ${result}?`, value: `${base}^? = ${result}` },
                        { label: `${base}^${exp} = ${result}`, value: `So the answer is ${exp}` }
                    ],
                    answer: String(exp),
                    answerLabel: `log_${base}(${result}) = ?`,
                    interactiveSteps: [
                        {
                            prompt: `log_${base}(${result}) asks: "${base} to WHAT POWER equals ${result}?" What are we looking for?`,
                            hint: "A logarithm finds the missing exponent",
                            answer: "exponent",
                            acceptableAnswers: ["exponent", "the exponent", "power", "the power"],
                            commonMistakes: {
                                "base": "The base is ${base}. We're looking for the EXPONENT (power).",
                                [String(result)]: `${result} is the result. We need to find what POWER gives us ${result}.`,
                                [String(base)]: `${base} is the base. We need the EXPONENT.`
                            }
                        },
                        {
                            prompt: `What is ${base}¹?`,
                            hint: "Any number to the power of 1 equals itself",
                            answer: String(base),
                            acceptableAnswers: [String(base)],
                            commonMistakes: {
                                "1": `${base}¹ = ${base}, not 1. Any number to the power of 1 equals itself.`,
                                "0": `${base}⁰ = 1 (zero power). ${base}¹ = ${base}.`
                            }
                        },
                        {
                            prompt: `What is ${base}²?`,
                            hint: `Multiply ${base} × ${base}`,
                            answer: String(base * base),
                            acceptableAnswers: [String(base * base)],
                            commonMistakes: {
                                [String(base * 2)]: `That's ${base} × 2. We need ${base}² = ${base} × ${base} = ${base * base}`,
                                [String(base + 2)]: `That's ${base} + 2. We need ${base}² = ${base} × ${base} = ${base * base}`
                            }
                        },
                        {
                            prompt: `So ${base}^${exp} = ${result}. What is log_${base}(${result})?`,
                            hint: `We found that ${base} to the power of __ equals ${result}`,
                            answer: String(exp),
                            acceptableAnswers: [String(exp)],
                            commonMistakes: {
                                [String(result)]: `${result} is what we get when we raise ${base} to a power. The answer is the EXPONENT: ${exp}`,
                                [String(base)]: `${base} is the base. The answer is the exponent: ${exp}`,
                                [String(result / base)]: `That's division. Logs find exponents: ${base}^${exp} = ${result}, so log_${base}(${result}) = ${exp}`
                            }
                        }
                    ]
                },
                practice: { problem: `What is log₁₀(1000)?`, answer: "3",
                    options: ["2", "3", "100", "1000"],
                    mistakeAnalysis: {
                        "2": "10² = 100, not 1000. Try 10³ = 1000, so log₁₀(1000) = 3",
                        "100": "Logs give the exponent, not a division result. 10³ = 1000, so answer is 3",
                        "1000": "That's the input, not the answer. Ask: 10 to what power = 1000?"
                    }}
            };
        },
        Polynomials: () => ({
            goalProblem: `Multiply: (x + 3)(x² - 2x + 1)`,
            teachingSteps: [
                {
                    title: "What is a Polynomial?",
                    explanation: "A <strong>polynomial</strong> is an expression with variables raised to whole-number powers (0, 1, 2, 3...).<br><br>Examples: 3x², x³ + 2x - 5, 7",
                    visual: "Polynomial = terms with whole-number exponents"
                },
                {
                    title: "Polynomial Vocabulary",
                    explanation: "• <strong>Term:</strong> A piece like 3x² or -5<br>• <strong>Degree:</strong> Highest exponent (degree of 5x³ + 2x is 3)<br>• <strong>Leading coefficient:</strong> Number in front of highest term<br>• <strong>Standard form:</strong> Terms ordered from highest to lowest degree",
                    visual: "5x³ + 2x - 1 → degree 3, leading coeff = 5"
                },
                {
                    title: "Multiplying Polynomials: The Distributive Method",
                    explanation: "To multiply polynomials, <strong>distribute</strong> each term in the first polynomial to <strong>every</strong> term in the second.<br><br>Every term times every term!",
                    visual: "(a + b)(c + d + e) = a(c+d+e) + b(c+d+e)"
                },
                {
                    title: "Step 1: Distribute the First Term (x)",
                    explanation: "Multiply <strong>x</strong> by each term in (x² - 2x + 1):<br><br>x × x² = x³<br>x × (-2x) = -2x²<br>x × 1 = x<br><br>Result: <strong>x³ - 2x² + x</strong>",
                    visual: "x(x² - 2x + 1) = x³ - 2x² + x"
                },
                {
                    title: "Step 2: Distribute the Second Term (3)",
                    explanation: "Multiply <strong>3</strong> by each term in (x² - 2x + 1):<br><br>3 × x² = 3x²<br>3 × (-2x) = -6x<br>3 × 1 = 3<br><br>Result: <strong>3x² - 6x + 3</strong>",
                    visual: "3(x² - 2x + 1) = 3x² - 6x + 3"
                },
                {
                    title: "Step 3: Combine Like Terms",
                    explanation: "Add our results together:<br>x³ - 2x² + x + 3x² - 6x + 3<br><br>Combine like terms:<br>x³ + (-2x² + 3x²) + (x - 6x) + 3<br>= <strong>x³ + x² - 5x + 3</strong>",
                    visual: "-2x² + 3x² = x² | x - 6x = -5x"
                }
            ],
            finalAnswer: "x³ + x² - 5x + 3",
            answerExplanation: "We distributed each term and combined like terms: x³ + x² - 5x + 3.",
            example: { problem: `Multiply: (x + 3)(x² - 2x + 1)`, steps: [
                { text: "Distribute x", math: "x(x² - 2x + 1) = x³ - 2x² + x" },
                { text: "Distribute 3", math: "3(x² - 2x + 1) = 3x² - 6x + 3" },
                { text: "Combine like terms", math: "x³ - 2x² + 3x² + x - 6x + 3" },
                { text: "Simplify", math: "<strong>x³ + x² - 5x + 3</strong>" }
            ]},
            keyPoints: [
                "Degree of polynomial = highest exponent",
                "When adding/subtracting, only combine LIKE terms",
                "When multiplying, distribute each term"
            ],
            mistakes: [
                { wrong: "Adding exponents when adding terms: x² + x² = x⁴", why: "x² + x² = 2x². Only add COEFFICIENTS, not exponents." },
                { wrong: "Forgetting to distribute to all terms", why: "Every term in the first polynomial must multiply every term in the second." }
            ],
            guided: {
                problem: `Add: (3x² + 2x - 5) + (x² - 4x + 3)`,
                steps: [
                    { label: "Combine x² terms", value: "3x² + x² = 4x²" },
                    { label: "Combine x terms", value: "2x + (-4x) = -2x" },
                    { label: "Combine constants", value: "-5 + 3 = -2" },
                    { label: "Final answer", value: "?" }
                ],
                answer: "4x² - 2x - 2",
                answerLabel: "Sum:",
                interactiveSteps: [
                    {
                        prompt: "When adding polynomials, we combine 'like terms'. What makes terms 'like'?",
                        hint: "They have the same variable raised to the same...",
                        answer: "same variable and exponent",
                        acceptableAnswers: ["same variable and exponent", "same exponent", "same power", "same variable and power"],
                        commonMistakes: {
                            "same coefficient": "Coefficients can be different. Like terms have the same VARIABLE and EXPONENT.",
                            "same sign": "Signs don't matter. Like terms = same variable and exponent (e.g., 3x² and -5x²)"
                        }
                    },
                    {
                        prompt: "Combine the x² terms: 3x² + x² = ?",
                        hint: "3x² + 1x² = (3+1)x²",
                        answer: "4x²",
                        acceptableAnswers: ["4x²", "4x^2"],
                        commonMistakes: {
                            "3x⁴": "Don't add exponents! 3x² + x² = (3+1)x² = 4x²",
                            "4x⁴": "Add coefficients, not exponents: 3 + 1 = 4, so 4x²",
                            "3x²": "Don't forget the x² from the second polynomial! 3 + 1 = 4"
                        }
                    },
                    {
                        prompt: "Combine the x terms: 2x + (-4x) = ?",
                        hint: "2 + (-4) = 2 - 4 = ?",
                        answer: "-2x",
                        acceptableAnswers: ["-2x", "-2 x"],
                        commonMistakes: {
                            "6x": "2 + (-4) = -2, not 6. When adding a negative, you subtract!",
                            "-6x": "2 + (-4) = 2 - 4 = -2, so the answer is -2x",
                            "2x": "Don't forget the -4x! 2 + (-4) = -2x"
                        }
                    },
                    {
                        prompt: "Combine the constants: -5 + 3 = ?",
                        hint: "Start at -5 and add 3 (move right on number line)",
                        answer: "-2",
                        acceptableAnswers: ["-2"],
                        commonMistakes: {
                            "-8": "That's -5 + (-3). We have -5 + 3 = -2",
                            "8": "-5 + 3 = -2, not +8",
                            "2": "Watch the sign! -5 + 3 = -2 (negative)"
                        }
                    }
                ]
            },
            practice: { problem: `What is the degree of 5x³ - 2x² + 7x - 1?`, answer: "3",
                options: ["1", "2", "3", "5"],
                mistakeAnalysis: {
                    "1": "The degree is the HIGHEST power, not the lowest. Highest here is x³, so degree = 3",
                    "2": "x² is not the highest power. Look for x³.",
                    "5": "That's the coefficient of x³. The DEGREE is the exponent: 3"
                }}
        }),
        Probability: () => {
            const favorable = rand(2, 5);
            const total = rand(favorable + 2, 12);
            return {
                goalProblem: `A bag has 3 red and 5 blue marbles. What is P(red)?`,
                teachingSteps: [
                    {
                        title: "What is Probability?",
                        explanation: "<strong>Probability</strong> measures how <strong>likely</strong> something is to happen.<br><br>It answers: \"What are the chances?\"",
                        visual: "Probability = How likely is this event?"
                    },
                    {
                        title: "The Probability Scale",
                        explanation: "Probability is always between <strong>0 and 1</strong>:<br><br>• <strong>0</strong> = Impossible (will never happen)<br>• <strong>0.5</strong> = Equally likely (50/50)<br>• <strong>1</strong> = Certain (will definitely happen)<br><br>You can also use percentages: 0% to 100%",
                        visual: "0 (impossible) ←——————→ 1 (certain)"
                    },
                    {
                        title: "The Basic Probability Formula",
                        explanation: "The probability formula is:<br><br><strong>P(event) = Favorable outcomes / Total outcomes</strong><br><br>Favorable = outcomes you WANT<br>Total = ALL possible outcomes",
                        visual: "P = Favorable / Total"
                    },
                    {
                        title: "Step 1: Count Favorable Outcomes",
                        explanation: "We want to pick a <strong>red</strong> marble.<br><br>How many red marbles are there? <strong>3</strong><br><br>Favorable outcomes = 3",
                        visual: "Favorable (red marbles) = 3"
                    },
                    {
                        title: "Step 2: Count Total Outcomes",
                        explanation: "How many marbles are there in total?<br><br>Red + Blue = 3 + 5 = <strong>8</strong> marbles<br><br>Total outcomes = 8",
                        visual: "Total = 3 + 5 = 8 marbles"
                    },
                    {
                        title: "Step 3: Apply the Formula",
                        explanation: "P(red) = Favorable / Total<br><br>P(red) = 3/8<br><br>As a decimal: 3 ÷ 8 = <strong>0.375</strong><br>As a percent: <strong>37.5%</strong>",
                        visual: "P(red) = 3/8 = 0.375 = 37.5%"
                    }
                ],
                finalAnswer: "3/8 or 0.375 or 37.5%",
                answerExplanation: "3 favorable outcomes (red) divided by 8 total outcomes gives us 3/8 = 0.375 = 37.5%.",
                example: { problem: `A bag has 3 red and 5 blue marbles. What is P(red)?`, steps: [
                    { text: "Count favorable outcomes", math: "Red marbles = 3" },
                    { text: "Count total outcomes", math: "Total = 3 + 5 = 8" },
                    { text: "Apply formula", math: "P(red) = 3/8" },
                    { text: "As decimal or percent", math: "<strong>P(red) = 0.375 = 37.5%</strong>" }
                ]},
                keyPoints: [
                    "P(event) = favorable / total",
                    "All probabilities are between 0 and 1 (or 0% and 100%)",
                    "P(not A) = 1 - P(A)"
                ],
                mistakes: [
                    { wrong: "P > 1 or P < 0", why: "Probability is ALWAYS between 0 and 1 (inclusive)." },
                    { wrong: "Using wrong total: P(red) = 3/5", why: "Denominator is ALL outcomes (red + blue = 8), not just one color." }
                ],
                guided: {
                    problem: `A bag has ${favorable} green and ${total - favorable} yellow marbles. What is P(green)?`,
                    steps: [
                        { label: "Favorable outcomes (green)", value: `${favorable}` },
                        { label: "Total outcomes", value: `${favorable} + ${total - favorable} = ${total}` },
                        { label: "P(green) = favorable/total", value: "?" }
                    ],
                    answer: `${favorable}/${total}`,
                    answerLabel: "P(green) = ?",
                    interactiveSteps: [
                        {
                            prompt: "What is the basic probability formula?",
                            hint: "P(event) = something / something else",
                            answer: "favorable/total",
                            acceptableAnswers: ["favorable/total", "favorable / total", "favorable outcomes / total outcomes", "wanted/total"],
                            commonMistakes: {
                                "total/favorable": "It's the other way around! Favorable goes on TOP: favorable / total",
                                "favorable - total": "Probability is a RATIO (division), not subtraction",
                                "favorable + total": "Probability is a RATIO (division), not addition"
                            }
                        },
                        {
                            prompt: `How many favorable outcomes (green marbles) are there?`,
                            hint: "Look at the number of green marbles",
                            answer: String(favorable),
                            acceptableAnswers: [String(favorable)],
                            commonMistakes: {
                                [String(total - favorable)]: `That's the yellow marbles. Green marbles = ${favorable}`,
                                [String(total)]: `That's the total. Favorable (green) = ${favorable}`
                            }
                        },
                        {
                            prompt: `How many TOTAL marbles are in the bag?`,
                            hint: `Add green + yellow: ${favorable} + ${total - favorable} = ?`,
                            answer: String(total),
                            acceptableAnswers: [String(total)],
                            commonMistakes: {
                                [String(favorable)]: `That's just the green. Total = green + yellow = ${favorable} + ${total - favorable} = ${total}`,
                                [String(total - favorable)]: `That's just the yellow. Add both: ${favorable} + ${total - favorable} = ${total}`
                            }
                        },
                        {
                            prompt: `Now calculate P(green) = favorable/total = ?`,
                            hint: `${favorable} / ${total} as a fraction`,
                            answer: `${favorable}/${total}`,
                            acceptableAnswers: [`${favorable}/${total}`, `${favorable} / ${total}`],
                            commonMistakes: {
                                [`${total}/${favorable}`]: "Numerator should be favorable, not total. P(green) = favorable/total",
                                [`${total - favorable}/${total}`]: `That's P(yellow)! For green: ${favorable}/${total}`
                            }
                        }
                    ]
                },
                practice: { problem: `You flip a fair coin. What is P(heads)?`, answer: "1/2 or 0.5",
                    options: ["1/2 or 0.5", "1/4", "1", "2"],
                    mistakeAnalysis: {
                        "1/4": "A coin has 2 outcomes (heads, tails), not 4. P(heads) = 1/2",
                        "1": "P = 1 means certain. Heads isn't guaranteed; it's 1 of 2 outcomes.",
                        "2": "Probability is a fraction ≤ 1. P(heads) = 1 favorable / 2 total = 1/2"
                    }}
            };
        },
        Sequences: () => {
            const a1 = rand(2, 8);
            const d = rand(2, 5);
            const n = rand(5, 8);
            const an = a1 + (n - 1) * d;
            return {
                goalProblem: `Find the 10th term of the arithmetic sequence: 3, 7, 11, 15, ...`,
                teachingSteps: [
                    {
                        title: "What is a Sequence?",
                        explanation: "A <strong>sequence</strong> is an ordered list of numbers following a pattern.<br><br>Examples:<br>• 2, 4, 6, 8, ... (add 2 each time)<br>• 3, 9, 27, 81, ... (multiply by 3 each time)",
                        visual: "Sequence = Ordered list with a pattern"
                    },
                    {
                        title: "Arithmetic vs. Geometric Sequences",
                        explanation: "<strong>Arithmetic:</strong> Add/subtract the same number (common difference d)<br><br><strong>Geometric:</strong> Multiply/divide by the same number (common ratio r)<br><br>3, 7, 11, 15 is arithmetic (d = 4)",
                        visual: "Arithmetic: +d each time | Geometric: ×r each time"
                    },
                    {
                        title: "The Arithmetic Sequence Formula",
                        explanation: "For an <strong>arithmetic sequence</strong>:<br><br><strong>aₙ = a₁ + (n - 1)d</strong><br><br>Where:<br>• aₙ = the nth term<br>• a₁ = first term<br>• n = term number<br>• d = common difference",
                        visual: "aₙ = a₁ + (n - 1)d"
                    },
                    {
                        title: "Step 1: Find the Common Difference",
                        explanation: "Look at the sequence: 3, 7, 11, 15, ...<br><br>7 - 3 = <strong>4</strong><br>11 - 7 = <strong>4</strong><br>15 - 11 = <strong>4</strong><br><br>The common difference d = <strong>4</strong>",
                        visual: "d = 7-3 = 11-7 = 15-11 = 4"
                    },
                    {
                        title: "Step 2: Identify the Values",
                        explanation: "We have:<br>• a₁ = <strong>3</strong> (first term)<br>• d = <strong>4</strong> (common difference)<br>• n = <strong>10</strong> (we want the 10th term)",
                        visual: "a₁ = 3, d = 4, n = 10"
                    },
                    {
                        title: "Step 3: Apply the Formula",
                        explanation: "aₙ = a₁ + (n - 1)d<br><br>a₁₀ = 3 + (10 - 1)(4)<br>a₁₀ = 3 + (9)(4)<br>a₁₀ = 3 + 36<br>a₁₀ = <strong>39</strong>",
                        visual: "a₁₀ = 3 + 9(4) = 3 + 36 = 39"
                    }
                ],
                finalAnswer: "39",
                answerExplanation: "Using aₙ = a₁ + (n-1)d with a₁=3, d=4, n=10: a₁₀ = 3 + 9(4) = 39",
                example: { problem: `Find the 10th term: 3, 7, 11, 15, ...`, steps: [
                    { text: "Find common difference", math: "d = 7 - 3 = 4" },
                    { text: "Identify values", math: "a₁ = 3, d = 4, n = 10" },
                    { text: "Apply formula", math: "a₁₀ = 3 + (10-1)(4)" },
                    { text: "Calculate", math: "<strong>a₁₀ = 3 + 36 = 39</strong>" }
                ]},
                keyPoints: [
                    "Arithmetic: aₙ = a₁ + (n-1)d",
                    "Geometric: aₙ = a₁ × r^(n-1)",
                    "Always find the pattern first (d or r)"
                ],
                mistakes: [
                    { wrong: "Using n instead of (n-1)", why: "The formula uses (n-1) because we add d starting from the 2nd term" },
                    { wrong: "Confusing arithmetic and geometric", why: "Check: are we adding (arithmetic) or multiplying (geometric)?" }
                ],
                guided: {
                    problem: `Find the ${n}th term of: ${a1}, ${a1+d}, ${a1+2*d}, ${a1+3*d}, ...`,
                    steps: [
                        { label: "First term a₁", value: String(a1) },
                        { label: "Common difference d", value: String(d) },
                        { label: `${n}th term`, value: "?" }
                    ],
                    answer: String(an),
                    answerLabel: `a${n} =`,
                    interactiveSteps: [
                        {
                            prompt: `What is the common difference? (${a1+d} - ${a1} = ?)`,
                            hint: "Subtract consecutive terms",
                            answer: String(d),
                            acceptableAnswers: [String(d)],
                            commonMistakes: {
                                [String(a1)]: `That's the first term. Common difference = ${a1+d} - ${a1} = ${d}`,
                                [String(a1+d)]: `That's the second term. d = ${a1+d} - ${a1} = ${d}`
                            }
                        },
                        {
                            prompt: `For the ${n}th term, what is (n - 1)?`,
                            hint: `n = ${n}, so n - 1 = ?`,
                            answer: String(n - 1),
                            acceptableAnswers: [String(n - 1)],
                            commonMistakes: {
                                [String(n)]: `Don't forget to subtract 1! ${n} - 1 = ${n - 1}`,
                                [String(n + 1)]: `That's n + 1. We need n - 1 = ${n} - 1 = ${n - 1}`
                            }
                        },
                        {
                            prompt: `Calculate: a${n} = ${a1} + ${n-1} × ${d} = ?`,
                            hint: `First multiply: ${n-1} × ${d} = ${(n-1)*d}, then add ${a1}`,
                            answer: String(an),
                            acceptableAnswers: [String(an)],
                            commonMistakes: {
                                [String(a1 + n * d)]: `You used n instead of (n-1). The answer is ${a1} + ${n-1}×${d} = ${an}`,
                                [String((n-1) * d)]: `Don't forget to add a₁! ${a1} + ${(n-1)*d} = ${an}`
                            }
                        }
                    ]
                },
                practice: { problem: `What is the 5th term of: 2, 6, 18, 54, ...?`, answer: "162",
                    options: ["162", "58", "108", "486"],
                    mistakeAnalysis: {
                        "58": "This is geometric (×3), not arithmetic (+d). The 5th term = 54 × 3 = 162",
                        "108": "You might have multiplied 54 by 2. The ratio is 3, so 54 × 3 = 162",
                        "486": "That's the 6th term (162 × 3). The 5th term is 162"
                    }}
            };
        },
        "Conic Sections": () => {
            const h = rand(-4, 4), k = rand(-4, 4);
            const r = rand(2, 6);
            return {
                goalProblem: `Write the equation of a circle with center (2, -3) and radius 5`,
                teachingSteps: [
                    {
                        title: "What are Conic Sections?",
                        explanation: "<strong>Conic sections</strong> are shapes formed by slicing a cone:<br><br>• <strong>Circle:</strong> Slice parallel to the base<br>• <strong>Ellipse:</strong> Slice at an angle<br>• <strong>Parabola:</strong> Slice parallel to the side<br>• <strong>Hyperbola:</strong> Slice through both halves",
                        visual: "Cone slices → Circle, Ellipse, Parabola, Hyperbola"
                    },
                    {
                        title: "The Circle Equation",
                        explanation: "The standard form of a <strong>circle</strong> is:<br><br><strong>(x - h)² + (y - k)² = r²</strong><br><br>Where:<br>• (h, k) = center<br>• r = radius",
                        visual: "(x - h)² + (y - k)² = r²"
                    },
                    {
                        title: "Other Conic Equations",
                        explanation: "<strong>Ellipse:</strong> (x-h)²/a² + (y-k)²/b² = 1<br><br><strong>Parabola:</strong> y = a(x-h)² + k (vertical)<br>or x = a(y-k)² + h (horizontal)<br><br><strong>Hyperbola:</strong> (x-h)²/a² - (y-k)²/b² = 1",
                        visual: "Each conic has its own standard form"
                    },
                    {
                        title: "Step 1: Identify the Center",
                        explanation: "The center is given as <strong>(2, -3)</strong><br><br>So h = 2 and k = -3",
                        visual: "Center (h, k) = (2, -3)"
                    },
                    {
                        title: "Step 2: Identify the Radius",
                        explanation: "The radius is <strong>5</strong><br><br>We'll need r² = 5² = <strong>25</strong>",
                        visual: "r = 5 → r² = 25"
                    },
                    {
                        title: "Step 3: Write the Equation",
                        explanation: "(x - h)² + (y - k)² = r²<br><br>(x - 2)² + (y - (-3))² = 25<br><br><strong>(x - 2)² + (y + 3)² = 25</strong><br><br>Note: y - (-3) becomes y + 3",
                        visual: "(x - 2)² + (y + 3)² = 25"
                    }
                ],
                finalAnswer: "(x - 2)² + (y + 3)² = 25",
                answerExplanation: "Plugging h=2, k=-3, r=5 into the circle equation: (x-2)² + (y+3)² = 25",
                example: { problem: `Circle with center (2, -3), radius 5`, steps: [
                    { text: "Identify h and k", math: "h = 2, k = -3" },
                    { text: "Calculate r²", math: "r² = 5² = 25" },
                    { text: "Substitute into formula", math: "(x - 2)² + (y - (-3))² = 25" },
                    { text: "Simplify", math: "<strong>(x - 2)² + (y + 3)² = 25</strong>" }
                ]},
                keyPoints: [
                    "Circle: (x-h)² + (y-k)² = r²",
                    "The equation uses r², not r",
                    "Watch signs: (y - (-3)) = (y + 3)"
                ],
                mistakes: [
                    { wrong: "Using r instead of r²", why: "The formula uses r SQUARED. If r = 5, use 25 in the equation." },
                    { wrong: "Wrong signs for center", why: "(x - h) means if h is positive, you see a minus. (y - (-3)) = (y + 3)" }
                ],
                guided: {
                    problem: `Write the equation of a circle with center (${h}, ${k}) and radius ${r}`,
                    steps: [
                        { label: "h =", value: String(h) },
                        { label: "k =", value: String(k) },
                        { label: "r² =", value: String(r * r) }
                    ],
                    answer: `(x - ${h})² + (y - ${k})² = ${r*r}`,
                    answerLabel: "Equation:",
                    interactiveSteps: [
                        {
                            prompt: `The center is (${h}, ${k}). What is h?`,
                            hint: "h is the x-coordinate of the center",
                            answer: String(h),
                            acceptableAnswers: [String(h)],
                            commonMistakes: {
                                [String(k)]: `That's k (y-coordinate). h is the x-coordinate: ${h}`,
                                [String(r)]: `That's the radius. h is the x-coordinate of center: ${h}`
                            }
                        },
                        {
                            prompt: `What is r²? (The radius is ${r})`,
                            hint: `Square the radius: ${r} × ${r}`,
                            answer: String(r * r),
                            acceptableAnswers: [String(r * r)],
                            commonMistakes: {
                                [String(r)]: `That's r. The formula uses r² = ${r}² = ${r*r}`,
                                [String(r * 2)]: `That's r × 2. We need r² = ${r} × ${r} = ${r*r}`
                            }
                        },
                        {
                            prompt: `The equation is (x - h)² + (y - k)² = r². What goes in place of h?`,
                            hint: `h = ${h}, so (x - ?) becomes (x - ${h})`,
                            answer: String(h),
                            acceptableAnswers: [String(h), `(x - ${h})`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `What is the center of (x + 4)² + (y - 1)² = 9?`, answer: "(-4, 1)",
                    options: ["(-4, 1)", "(4, -1)", "(4, 1)", "(-4, -1)"],
                    mistakeAnalysis: {
                        "(4, -1)": "(x + 4) means h = -4, and (y - 1) means k = 1. Center: (-4, 1)",
                        "(4, 1)": "(x + 4) = (x - (-4)), so h = -4. Center: (-4, 1)",
                        "(-4, -1)": "(y - 1) means k = +1, not -1. Center: (-4, 1)"
                    }}
            };
        },
        "Rational Functions": () => {
            const a = rand(2, 5);
            return {
                goalProblem: `Find the vertical asymptote of f(x) = 1/(x - 3)`,
                teachingSteps: [
                    {
                        title: "What is a Rational Function?",
                        explanation: "A <strong>rational function</strong> is a ratio of two polynomials:<br><br><strong>f(x) = P(x) / Q(x)</strong><br><br>Example: f(x) = (x + 1)/(x - 2)",
                        visual: "Rational = Polynomial / Polynomial"
                    },
                    {
                        title: "Domain Restrictions",
                        explanation: "Since we can't divide by zero, rational functions are <strong>undefined</strong> where the denominator equals zero.<br><br>These restrictions affect the domain!",
                        visual: "If Q(x) = 0, the function is undefined"
                    },
                    {
                        title: "Vertical Asymptotes",
                        explanation: "A <strong>vertical asymptote</strong> occurs where the denominator = 0 (and numerator ≠ 0).<br><br>The graph approaches but never touches/crosses a vertical asymptote.",
                        visual: "Denominator = 0 → Vertical Asymptote"
                    },
                    {
                        title: "Horizontal Asymptotes",
                        explanation: "A <strong>horizontal asymptote</strong> shows the function's behavior as x → ±∞:<br><br>• If degree(top) < degree(bottom): y = 0<br>• If degrees equal: y = leading coefficients ratio<br>• If degree(top) > degree(bottom): no horizontal asymptote",
                        visual: "Horizontal asymptote = end behavior"
                    },
                    {
                        title: "Step 1: Find Where Denominator = 0",
                        explanation: "For f(x) = 1/(x - 3):<br><br>Set denominator = 0:<br>x - 3 = 0<br>x = <strong>3</strong>",
                        visual: "x - 3 = 0 → x = 3"
                    },
                    {
                        title: "Step 2: Verify It's an Asymptote",
                        explanation: "At x = 3:<br>• Denominator = 0 ✓<br>• Numerator = 1 ≠ 0 ✓<br><br>Since the numerator isn't also 0, we have a vertical asymptote at <strong>x = 3</strong>",
                        visual: "Vertical asymptote: x = 3"
                    }
                ],
                finalAnswer: "x = 3",
                answerExplanation: "Set the denominator equal to zero: x - 3 = 0 → x = 3. The vertical asymptote is x = 3.",
                example: { problem: `Find vertical asymptote of f(x) = 1/(x - 3)`, steps: [
                    { text: "Set denominator = 0", math: "x - 3 = 0" },
                    { text: "Solve for x", math: "x = 3" },
                    { text: "Check numerator ≠ 0 at x = 3", math: "Numerator = 1 ≠ 0 ✓" },
                    { text: "Vertical asymptote", math: "<strong>x = 3</strong>" }
                ]},
                keyPoints: [
                    "Vertical asymptote: where denominator = 0 (and numerator ≠ 0)",
                    "The function is undefined at vertical asymptotes",
                    "Compare degrees for horizontal asymptotes"
                ],
                mistakes: [
                    { wrong: "Setting numerator = 0 for vertical asymptote", why: "Vertical asymptotes come from DENOMINATOR = 0, not numerator." },
                    { wrong: "Including holes as asymptotes", why: "If both num and denom = 0 at same point, it's a HOLE, not an asymptote." }
                ],
                guided: {
                    problem: `Find the vertical asymptote of f(x) = ${a}/(x + 2)`,
                    steps: [
                        { label: "Set denominator = 0", value: "x + 2 = 0" },
                        { label: "Solve for x", value: "?" }
                    ],
                    answer: "x = -2",
                    answerLabel: "Vertical asymptote:",
                    interactiveSteps: [
                        {
                            prompt: "To find vertical asymptotes, what do we set equal to zero?",
                            hint: "It's the bottom part of the fraction...",
                            answer: "denominator",
                            acceptableAnswers: ["denominator", "the denominator", "bottom", "x + 2"],
                            commonMistakes: {
                                "numerator": "Numerator = 0 gives x-intercepts. For vertical asymptotes, set DENOMINATOR = 0",
                                [String(a)]: `${a} is the numerator. Set the DENOMINATOR (x + 2) = 0`
                            }
                        },
                        {
                            prompt: "Solve: x + 2 = 0. What is x?",
                            hint: "Subtract 2 from both sides",
                            answer: "-2",
                            acceptableAnswers: ["-2", "x = -2", "x=-2"],
                            commonMistakes: {
                                "2": "If x + 2 = 0, then x = -2 (subtract 2, don't keep it positive)",
                                "-4": "x + 2 = 0 means x = 0 - 2 = -2"
                            }
                        },
                        {
                            prompt: "So the vertical asymptote is at x = ?",
                            hint: "We found x = -2",
                            answer: "-2",
                            acceptableAnswers: ["-2", "x = -2", "x=-2"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `What is the horizontal asymptote of f(x) = 2/(x + 1)?`, answer: "y = 0",
                    options: ["y = 0", "y = 2", "x = -1", "No horizontal asymptote"],
                    mistakeAnalysis: {
                        "y = 2": "2 is the numerator. Since degree(top) < degree(bottom), y = 0",
                        "x = -1": "That's the VERTICAL asymptote. The HORIZONTAL asymptote is y = 0",
                        "No horizontal asymptote": "Since degree(numerator) < degree(denominator), there IS one: y = 0"
                    }}
            };
        },
        "Piecewise Functions": () => {
            const a = rand(2, 5);
            const b = rand(1, 4);
            return {
                goalProblem: `Evaluate f(5) if f(x) = { x² if x < 3; 2x + 1 if x ≥ 3 }`,
                teachingSteps: [
                    {
                        title: "What is a Piecewise Function?",
                        explanation: "A <strong>piecewise function</strong> uses different formulas for different parts of its domain.<br><br>It's like different rules for different situations!",
                        visual: "Piecewise = Different rules for different x-values"
                    },
                    {
                        title: "Reading Piecewise Notation",
                        explanation: "f(x) = { x² if x < 3; 2x + 1 if x ≥ 3 }<br><br>This means:<br>• Use x² when x is less than 3<br>• Use 2x + 1 when x is 3 or greater",
                        visual: "Check the condition first, then use that formula"
                    },
                    {
                        title: "Evaluating Piecewise Functions",
                        explanation: "To evaluate f(a):<br><br>1. <strong>First:</strong> Check which condition 'a' satisfies<br>2. <strong>Then:</strong> Use the corresponding formula<br>3. <strong>Finally:</strong> Substitute and calculate",
                        visual: "Step 1: Which piece? → Step 2: Use that formula"
                    },
                    {
                        title: "Step 1: Check Which Condition",
                        explanation: "We need f(5). Is 5 < 3 or ≥ 3?<br><br>5 ≥ 3 ✓<br><br>So we use the formula: <strong>2x + 1</strong>",
                        visual: "5 ≥ 3 → Use 2x + 1"
                    },
                    {
                        title: "Step 2: Substitute and Calculate",
                        explanation: "Using f(x) = 2x + 1 with x = 5:<br><br>f(5) = 2(5) + 1<br>f(5) = 10 + 1<br>f(5) = <strong>11</strong>",
                        visual: "f(5) = 2(5) + 1 = 11"
                    }
                ],
                finalAnswer: "11",
                answerExplanation: "Since 5 ≥ 3, we use the second piece (2x + 1). f(5) = 2(5) + 1 = 11.",
                example: { problem: `Evaluate f(5) for f(x) = { x² if x < 3; 2x + 1 if x ≥ 3 }`, steps: [
                    { text: "Check condition", math: "5 ≥ 3, so use 2x + 1" },
                    { text: "Substitute x = 5", math: "f(5) = 2(5) + 1" },
                    { text: "Calculate", math: "<strong>f(5) = 11</strong>" }
                ]},
                keyPoints: [
                    "Always check which condition the input satisfies first",
                    "Each piece has its own domain restriction",
                    "At boundary points, check which inequality includes it (< vs ≤)"
                ],
                mistakes: [
                    { wrong: "Using the wrong piece", why: "Check the condition! 5 ≥ 3, so use 2x + 1, not x²" },
                    { wrong: "Evaluating all pieces", why: "Only ONE piece applies for any given x-value. Find which one!" }
                ],
                guided: {
                    problem: `Evaluate f(${a}) if f(x) = { ${b}x if x ≤ 4; x + 10 if x > 4 }`,
                    steps: [
                        { label: `Is ${a} ≤ 4 or > 4?`, value: a <= 4 ? `${a} ≤ 4` : `${a} > 4` },
                        { label: "Use formula", value: a <= 4 ? `${b}x` : "x + 10" },
                        { label: "f(" + a + ") =", value: "?" }
                    ],
                    answer: String(a <= 4 ? b * a : a + 10),
                    answerLabel: `f(${a}) =`,
                    interactiveSteps: [
                        {
                            prompt: `First, check: is ${a} ≤ 4 or is ${a} > 4?`,
                            hint: `Compare ${a} to 4`,
                            answer: a <= 4 ? `${a} ≤ 4` : `${a} > 4`,
                            acceptableAnswers: a <= 4 ? [`${a} ≤ 4`, `${a} <= 4`, "≤ 4", "<= 4", "less than or equal to 4"] : [`${a} > 4`, "greater than 4", "> 4"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Based on that, which formula do we use?`,
                            hint: a <= 4 ? `Since ${a} ≤ 4, use the first formula` : `Since ${a} > 4, use the second formula`,
                            answer: a <= 4 ? `${b}x` : "x + 10",
                            acceptableAnswers: a <= 4 ? [`${b}x`, `${b}*x`] : ["x + 10", "x+10"],
                            commonMistakes: {}
                        },
                        {
                            prompt: a <= 4 ? `Calculate: ${b} × ${a} = ?` : `Calculate: ${a} + 10 = ?`,
                            hint: a <= 4 ? `Multiply ${b} times ${a}` : `Add ${a} + 10`,
                            answer: String(a <= 4 ? b * a : a + 10),
                            acceptableAnswers: [String(a <= 4 ? b * a : a + 10)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `For f(x) = { x² if x < 0; x if x ≥ 0 }, what is f(-3)?`, answer: "9",
                    options: ["-3", "9", "-9", "3"],
                    mistakeAnalysis: {
                        "-3": "Use the correct piece! -3 < 0, so use x². f(-3) = (-3)² = 9",
                        "-9": "(-3)² = 9 (positive), not -9. Squaring a negative gives positive.",
                        "3": "f(-3) = (-3)² = 9, not 3. Remember to square!"
                    }}
            };
        },
        Asymptotes: () => {
            const a = rand(2, 4);
            const b = rand(1, 5);
            return {
                goalProblem: `Find all asymptotes of f(x) = (2x + 1)/(x - 4)`,
                teachingSteps: [
                    {
                        title: "What are Asymptotes?",
                        explanation: "<strong>Asymptotes</strong> are lines that a graph approaches but never actually reaches.<br><br>They show the function's behavior at extremes or restrictions.",
                        visual: "Asymptote = Line the graph gets infinitely close to"
                    },
                    {
                        title: "Types of Asymptotes",
                        explanation: "Three types:<br><br>• <strong>Vertical:</strong> x = a (graph goes up/down infinitely)<br>• <strong>Horizontal:</strong> y = b (graph levels off as x → ±∞)<br>• <strong>Oblique/Slant:</strong> y = mx + b (when degree top > degree bottom by 1)",
                        visual: "Vertical: x = ? | Horizontal: y = ? | Oblique: y = mx + b"
                    },
                    {
                        title: "Finding Vertical Asymptotes",
                        explanation: "Set the <strong>denominator = 0</strong><br><br>For (2x + 1)/(x - 4):<br>x - 4 = 0<br>x = 4<br><br>Vertical asymptote: <strong>x = 4</strong>",
                        visual: "x - 4 = 0 → x = 4"
                    },
                    {
                        title: "Finding Horizontal Asymptotes",
                        explanation: "Compare degrees of numerator and denominator:<br><br>• deg(top) < deg(bottom): y = 0<br>• deg(top) = deg(bottom): y = (leading coeff top)/(leading coeff bottom)<br>• deg(top) > deg(bottom): no horizontal asymptote",
                        visual: "Compare degrees to find horizontal asymptote"
                    },
                    {
                        title: "Step 1: Find Vertical Asymptote",
                        explanation: "Denominator = 0:<br>x - 4 = 0<br>x = 4<br><br>Vertical asymptote: <strong>x = 4</strong>",
                        visual: "VA: x = 4"
                    },
                    {
                        title: "Step 2: Find Horizontal Asymptote",
                        explanation: "Numerator: 2x + 1 (degree 1, leading coeff = 2)<br>Denominator: x - 4 (degree 1, leading coeff = 1)<br><br>Degrees are equal, so:<br>y = 2/1 = <strong>2</strong><br><br>Horizontal asymptote: <strong>y = 2</strong>",
                        visual: "HA: y = 2/1 = 2"
                    }
                ],
                finalAnswer: "Vertical: x = 4, Horizontal: y = 2",
                answerExplanation: "VA: set denominator = 0 → x = 4. HA: equal degrees so y = 2/1 = 2.",
                example: { problem: `Find all asymptotes of (2x + 1)/(x - 4)`, steps: [
                    { text: "Find VA: set denom = 0", math: "x - 4 = 0 → x = 4" },
                    { text: "Check degrees", math: "Both degree 1" },
                    { text: "HA: leading coefficients", math: "y = 2/1 = 2" },
                    { text: "Asymptotes", math: "<strong>VA: x = 4, HA: y = 2</strong>" }
                ]},
                keyPoints: [
                    "VA: denominator = 0",
                    "HA: compare degrees and leading coefficients",
                    "Oblique asymptote when deg(top) = deg(bottom) + 1"
                ],
                mistakes: [
                    { wrong: "Setting numerator = 0 for VA", why: "Vertical asymptotes come from DENOMINATOR = 0" },
                    { wrong: "Forgetting to compare degrees for HA", why: "The degrees determine if/what the horizontal asymptote is" }
                ],
                guided: {
                    problem: `Find all asymptotes of f(x) = (${a}x)/(x + ${b})`,
                    steps: [
                        { label: "Set denominator = 0", value: `x + ${b} = 0 → x = -${b}` },
                        { label: "Compare degrees", value: "Both degree 1" },
                        { label: "Leading coefficients", value: `${a}/1 = ${a}` }
                    ],
                    answer: `VA: x = -${b}, HA: y = ${a}`,
                    answerLabel: "Asymptotes:",
                    interactiveSteps: [
                        {
                            prompt: `Set denominator = 0: x + ${b} = 0. Solve for x.`,
                            hint: `Subtract ${b} from both sides`,
                            answer: String(-b),
                            acceptableAnswers: [String(-b), `x = ${-b}`, `x=${-b}`],
                            commonMistakes: {
                                [String(b)]: `x + ${b} = 0 means x = -${b} (negative)`,
                                "0": `Don't forget to solve! x + ${b} = 0 → x = -${b}`
                            }
                        },
                        {
                            prompt: "What is the degree of the numerator?",
                            hint: `The numerator is ${a}x. What power is x raised to?`,
                            answer: "1",
                            acceptableAnswers: ["1", "degree 1", "first"],
                            commonMistakes: {
                                [String(a)]: `${a} is the coefficient. The degree (power of x) is 1`,
                                "0": `x = x¹, so the degree is 1`
                            }
                        },
                        {
                            prompt: `Since both have degree 1, HA = (leading coeff top)/(leading coeff bottom) = ${a}/1 = ?`,
                            hint: `${a} divided by 1`,
                            answer: String(a),
                            acceptableAnswers: [String(a), `y = ${a}`, `y=${a}`],
                            commonMistakes: {
                                "1": `The numerator's leading coefficient is ${a}, not 1. y = ${a}/1 = ${a}`,
                                [String(a + 1)]: `Don't add! Divide: ${a}/1 = ${a}`
                            }
                        }
                    ]
                },
                practice: { problem: `What is the horizontal asymptote of f(x) = 5/(x² + 1)?`, answer: "y = 0",
                    options: ["y = 0", "y = 5", "y = 1", "No horizontal asymptote"],
                    mistakeAnalysis: {
                        "y = 5": "5 is the numerator. Since deg(top) < deg(bottom), HA is y = 0",
                        "y = 1": "That's the coefficient of x². Since deg(0) < deg(2), HA is y = 0",
                        "No horizontal asymptote": "deg(numerator) < deg(denominator), so HA IS y = 0"
                    }}
            };
        },
        Permutations: () => {
            const n = rand(5, 8);
            const r = rand(2, 4);
            const perm = (() => {
                let result = 1;
                for (let i = n; i > n - r; i--) result *= i;
                return result;
            })();
            return {
                goalProblem: `How many ways can 3 people be selected from 7 for 1st, 2nd, and 3rd place?`,
                teachingSteps: [
                    {
                        title: "Permutations vs. Combinations",
                        explanation: "Both count ways to select items, but:<br><br><strong>Permutations:</strong> Order MATTERS (1st, 2nd, 3rd are different)<br><strong>Combinations:</strong> Order doesn't matter (just selecting a group)",
                        visual: "Permutations: ORDER matters | Combinations: order doesn't matter"
                    },
                    {
                        title: "The Permutation Formula",
                        explanation: "The number of permutations of n items taken r at a time:<br><br><strong>P(n,r) = n!/(n-r)!</strong><br><br>Or: P(n,r) = n × (n-1) × (n-2) × ... (r factors)",
                        visual: "P(n,r) = n!/(n-r)!"
                    },
                    {
                        title: "Factorial Reminder",
                        explanation: "<strong>n!</strong> (n factorial) = n × (n-1) × (n-2) × ... × 2 × 1<br><br>Examples:<br>5! = 5 × 4 × 3 × 2 × 1 = 120<br>4! = 4 × 3 × 2 × 1 = 24<br>0! = 1 (by definition)",
                        visual: "n! = n × (n-1) × ... × 1"
                    },
                    {
                        title: "Step 1: Identify n and r",
                        explanation: "We're selecting from <strong>7 people</strong> (n = 7)<br><br>We're filling <strong>3 positions</strong> (r = 3: 1st, 2nd, 3rd)<br><br>Order matters because positions are different!",
                        visual: "n = 7, r = 3"
                    },
                    {
                        title: "Step 2: Apply the Formula",
                        explanation: "P(7,3) = 7!/(7-3)! = 7!/4!<br><br>= (7 × 6 × 5 × 4!)/(4!)<br>= 7 × 6 × 5<br>= <strong>210</strong>",
                        visual: "P(7,3) = 7 × 6 × 5 = 210"
                    },
                    {
                        title: "The Quick Method",
                        explanation: "For P(n,r), just multiply n down for r numbers:<br><br>P(7,3) = 7 × 6 × 5 = <strong>210</strong><br><br>(Start at 7, multiply 3 consecutive decreasing numbers)",
                        visual: "P(7,3) = 7 × 6 × 5 (3 numbers starting from 7)"
                    }
                ],
                finalAnswer: "210",
                answerExplanation: "P(7,3) = 7 × 6 × 5 = 210 ways. Order matters for 1st, 2nd, 3rd place.",
                example: { problem: `P(7,3) - select 3 from 7 for 1st, 2nd, 3rd`, steps: [
                    { text: "Identify n and r", math: "n = 7, r = 3" },
                    { text: "Order matters → Permutation", math: "P(7,3)" },
                    { text: "Calculate", math: "7 × 6 × 5 = 210" },
                    { text: "Answer", math: "<strong>210 ways</strong>" }
                ]},
                keyPoints: [
                    "Permutation = order matters",
                    "P(n,r) = n!/(n-r)! = n × (n-1) × ... (r factors)",
                    "Think: 'How many choices for each position?'"
                ],
                mistakes: [
                    { wrong: "Using combination when order matters", why: "If positions are different (1st, 2nd, 3rd), use PERMUTATION" },
                    { wrong: "Using n^r instead of P(n,r)", why: "n^r is for choosing WITH replacement. P(n,r) is WITHOUT replacement." }
                ],
                guided: {
                    problem: `How many ways can ${r} books be arranged from a shelf of ${n} books?`,
                    steps: [
                        { label: "n (total items)", value: String(n) },
                        { label: "r (positions to fill)", value: String(r) },
                        { label: `P(${n},${r})`, value: "?" }
                    ],
                    answer: String(perm),
                    answerLabel: "Number of arrangements:",
                    interactiveSteps: [
                        {
                            prompt: "Does order matter when ARRANGING books?",
                            hint: "Think: does the order/position of books matter?",
                            answer: "yes",
                            acceptableAnswers: ["yes", "Yes", "YES", "y"],
                            commonMistakes: {
                                "no": "Arranging implies order! Book A first vs Book B first are different arrangements."
                            }
                        },
                        {
                            prompt: `How many choices for the first position?`,
                            hint: `We have ${n} books to choose from`,
                            answer: String(n),
                            acceptableAnswers: [String(n)],
                            commonMistakes: {
                                [String(r)]: `We have ${n} books total to choose from for the first spot`,
                                "1": `We can put any of the ${n} books first, so ${n} choices`
                            }
                        },
                        {
                            prompt: `After choosing the first book, how many choices for the second position?`,
                            hint: "One book is already used...",
                            answer: String(n - 1),
                            acceptableAnswers: [String(n - 1)],
                            commonMistakes: {
                                [String(n)]: `One book is used, so only ${n - 1} remain for the second position`,
                                [String(r - 1)]: `We subtract from n (total books), not r. ${n} - 1 = ${n - 1}`
                            }
                        },
                        {
                            prompt: `Calculate P(${n},${r}) = ${n} × ${n-1}${r > 2 ? ` × ${n-2}` : ''}${r > 3 ? ` × ${n-3}` : ''} = ?`,
                            hint: "Multiply these numbers together",
                            answer: String(perm),
                            acceptableAnswers: [String(perm)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `How many 3-digit numbers can be formed from 1,2,3,4,5 (no repetition)?`, answer: "60",
                    options: ["60", "125", "15", "10"],
                    mistakeAnalysis: {
                        "125": "That's 5³ (with repetition). Without repetition: P(5,3) = 5×4×3 = 60",
                        "15": "That's C(5,3) - combinations. Order matters for numbers: P(5,3) = 60",
                        "10": "Check your multiplication: 5 × 4 × 3 = 60"
                    }}
            };
        },
        Combinations: () => {
            const n = rand(6, 10);
            const r = rand(2, 4);
            const comb = (() => {
                let num = 1, den = 1;
                for (let i = 0; i < r; i++) {
                    num *= (n - i);
                    den *= (i + 1);
                }
                return num / den;
            })();
            return {
                goalProblem: `How many ways can a committee of 3 be chosen from 8 people?`,
                teachingSteps: [
                    {
                        title: "Combinations: Order Doesn't Matter",
                        explanation: "Use <strong>combinations</strong> when you're just selecting a group, and the order of selection doesn't matter.<br><br>Choosing {A, B, C} is the same as {C, A, B}.",
                        visual: "Combination = just selecting, order doesn't matter"
                    },
                    {
                        title: "The Combination Formula",
                        explanation: "The number of combinations of n items taken r at a time:<br><br><strong>C(n,r) = n!/[r!(n-r)!]</strong><br><br>Also written as ⁿCᵣ or (n choose r)",
                        visual: "C(n,r) = n!/[r!(n-r)!]"
                    },
                    {
                        title: "Permutation vs Combination",
                        explanation: "C(n,r) = P(n,r)/r!<br><br>We divide by r! because order doesn't matter - we're removing the duplicate arrangements.<br><br>Example: ABC, ACB, BAC, BCA, CAB, CBA are all the same combination.",
                        visual: "C(n,r) = P(n,r)/r! (remove duplicate orderings)"
                    },
                    {
                        title: "Step 1: Verify Order Doesn't Matter",
                        explanation: "A 'committee' is just a group - the order of selection doesn't matter.<br><br>Committee {Alice, Bob, Carol} = {Carol, Alice, Bob}<br><br>Use COMBINATION!",
                        visual: "Committee = group → Combination"
                    },
                    {
                        title: "Step 2: Identify n and r",
                        explanation: "n = <strong>8</strong> (total people)<br>r = <strong>3</strong> (committee size)<br><br>We need C(8,3)",
                        visual: "n = 8, r = 3 → C(8,3)"
                    },
                    {
                        title: "Step 3: Calculate",
                        explanation: "C(8,3) = 8!/(3! × 5!)<br><br>= (8 × 7 × 6)/(3 × 2 × 1)<br>= 336/6<br>= <strong>56</strong>",
                        visual: "C(8,3) = (8×7×6)/(3×2×1) = 56"
                    }
                ],
                finalAnswer: "56",
                answerExplanation: "C(8,3) = 8!/(3!×5!) = (8×7×6)/(3×2×1) = 56 ways to form the committee.",
                example: { problem: `C(8,3) - choose committee of 3 from 8 people`, steps: [
                    { text: "Order doesn't matter → Combination", math: "C(8,3)" },
                    { text: "Apply formula", math: "(8 × 7 × 6)/(3 × 2 × 1)" },
                    { text: "Calculate", math: "336/6 = 56" },
                    { text: "Answer", math: "<strong>56 ways</strong>" }
                ]},
                keyPoints: [
                    "Combination = order doesn't matter",
                    "C(n,r) = n!/[r!(n-r)!]",
                    "Use for: teams, committees, groups, hands of cards"
                ],
                mistakes: [
                    { wrong: "Using permutation when order doesn't matter", why: "For selecting a GROUP (no positions), use combination" },
                    { wrong: "Forgetting to divide by r!", why: "The r! accounts for the duplicate orderings we must remove" }
                ],
                guided: {
                    problem: `How many ways can ${r} students be chosen from ${n} for a study group?`,
                    steps: [
                        { label: "Does order matter?", value: "No - it's just a group" },
                        { label: `C(${n},${r}) = ${n}!/[${r}!(${n-r})!]`, value: "?" }
                    ],
                    answer: String(comb),
                    answerLabel: "Number of groups:",
                    interactiveSteps: [
                        {
                            prompt: "For a 'study group', does the order of selection matter?",
                            hint: "Is there a 1st member, 2nd member, etc.? Or just 'in the group'?",
                            answer: "no",
                            acceptableAnswers: ["no", "No", "NO", "n"],
                            commonMistakes: {
                                "yes": "A study group is just a group - no positions or order. Use COMBINATION!"
                            }
                        },
                        {
                            prompt: `Calculate the numerator: ${n} × ${n-1}${r > 2 ? ` × ${n-2}` : ''}${r > 3 ? ` × ${n-3}` : ''} = ?`,
                            hint: "Multiply the top numbers",
                            answer: String((() => { let p = 1; for(let i = 0; i < r; i++) p *= (n-i); return p; })()),
                            acceptableAnswers: [String((() => { let p = 1; for(let i = 0; i < r; i++) p *= (n-i); return p; })())],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate the denominator: ${r}! = ${Array.from({length: r}, (_, i) => r-i).join(' × ')} = ?`,
                            hint: `${r}! = ${r} × ${r-1}${r > 2 ? ` × ${r-2}` : ''}${r > 3 ? ` × ${r-3}` : ''} × ... × 1`,
                            answer: String((() => { let f = 1; for(let i = 1; i <= r; i++) f *= i; return f; })()),
                            acceptableAnswers: [String((() => { let f = 1; for(let i = 1; i <= r; i++) f *= i; return f; })())],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now divide: C(${n},${r}) = ?`,
                            hint: "Divide the numerator by the denominator",
                            answer: String(comb),
                            acceptableAnswers: [String(comb)],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `How many 5-card hands can be dealt from a 52-card deck?`, answer: "2,598,960",
                    options: ["2,598,960", "311,875,200", "52", "5"],
                    mistakeAnalysis: {
                        "311,875,200": "That's P(52,5) - permutation. Order doesn't matter in a hand: C(52,5)",
                        "52": "That's just the number of cards. C(52,5) = 52!/(5!×47!) = 2,598,960",
                        "5": "That's r (cards chosen). The answer is C(52,5) = 2,598,960"
                    }}
            };
        },
        "Expected Value": () => {
            const p1 = rand(1, 4) / 10;
            const p2 = 1 - p1;
            const v1 = rand(10, 30);
            const v2 = rand(-10, 0);
            const ev = Math.round((p1 * v1 + p2 * v2) * 100) / 100;
            return {
                goalProblem: `A game: Win $10 with probability 0.4, lose $5 with probability 0.6. Find expected value.`,
                teachingSteps: [
                    {
                        title: "What is Expected Value?",
                        explanation: "<strong>Expected value</strong> is the average outcome you'd expect over many trials.<br><br>It's the 'long-run average' - what happens if you played this game thousands of times.",
                        visual: "Expected Value = Long-run average outcome"
                    },
                    {
                        title: "The Expected Value Formula",
                        explanation: "<strong>E(X) = Σ(value × probability)</strong><br><br>Multiply each outcome by its probability, then add them all up!<br><br>E(X) = v₁p₁ + v₂p₂ + v₃p₃ + ...",
                        visual: "E(X) = Σ(value × probability)"
                    },
                    {
                        title: "Interpreting Expected Value",
                        explanation: "• E(X) > 0: Favorable (you expect to gain on average)<br>• E(X) < 0: Unfavorable (you expect to lose on average)<br>• E(X) = 0: Fair game",
                        visual: "E > 0: favorable | E < 0: unfavorable | E = 0: fair"
                    },
                    {
                        title: "Step 1: List All Outcomes",
                        explanation: "Outcome 1: Win $10 with P = 0.4<br>Outcome 2: Lose $5 with P = 0.6<br><br>(Note: Losing $5 means value = -$5)",
                        visual: "Win +$10 (P=0.4) | Lose -$5 (P=0.6)"
                    },
                    {
                        title: "Step 2: Multiply Each Value by Its Probability",
                        explanation: "E(X) = (value₁ × prob₁) + (value₂ × prob₂)<br><br>E(X) = ($10 × 0.4) + (-$5 × 0.6)<br>E(X) = $4 + (-$3)<br>E(X) = <strong>$1</strong>",
                        visual: "E(X) = 10(0.4) + (-5)(0.6) = 4 - 3 = $1"
                    },
                    {
                        title: "Interpretation",
                        explanation: "Expected value = <strong>$1</strong><br><br>This means on average, you'd win $1 per game over the long run.<br><br>This is a <strong>favorable</strong> game (E > 0)!",
                        visual: "E = $1 > 0 → Favorable game!"
                    }
                ],
                finalAnswer: "$1",
                answerExplanation: "E(X) = 10(0.4) + (-5)(0.6) = 4 - 3 = $1. On average, you win $1 per game.",
                example: { problem: `Win $10 (P=0.4), lose $5 (P=0.6). Find E(X).`, steps: [
                    { text: "List outcomes and probabilities", math: "+$10 (0.4), -$5 (0.6)" },
                    { text: "Apply formula", math: "E = 10(0.4) + (-5)(0.6)" },
                    { text: "Calculate each term", math: "E = 4 + (-3)" },
                    { text: "Sum", math: "<strong>E = $1</strong>" }
                ]},
                keyPoints: [
                    "E(X) = Σ(value × probability)",
                    "Losses are negative values",
                    "E > 0 means favorable, E < 0 means unfavorable"
                ],
                mistakes: [
                    { wrong: "Forgetting negative signs for losses", why: "A loss of $5 means value = -$5 in the formula" },
                    { wrong: "Adding probabilities instead of multiplying", why: "Multiply each VALUE by its probability, then ADD those products" }
                ],
                guided: {
                    problem: `Win $${v1} with probability ${p1}, lose $${-v2} with probability ${p2}. Find E(X).`,
                    steps: [
                        { label: `Value 1 × Prob 1`, value: `$${v1} × ${p1} = $${v1 * p1}` },
                        { label: `Value 2 × Prob 2`, value: `$${v2} × ${p2} = $${v2 * p2}` },
                        { label: "E(X)", value: "?" }
                    ],
                    answer: `$${ev}`,
                    answerLabel: "E(X) =",
                    interactiveSteps: [
                        {
                            prompt: `Calculate: $${v1} × ${p1} = ?`,
                            hint: `Multiply ${v1} by ${p1}`,
                            answer: String(v1 * p1),
                            acceptableAnswers: [String(v1 * p1), `$${v1 * p1}`, String(Math.round(v1 * p1 * 100) / 100)],
                            commonMistakes: {
                                [String(v1 + p1)]: `Multiply, don't add! ${v1} × ${p1} = ${v1 * p1}`,
                                [String(v1 / p1)]: `Multiply, don't divide! ${v1} × ${p1} = ${v1 * p1}`
                            }
                        },
                        {
                            prompt: `A loss of $${-v2} has what value in the formula?`,
                            hint: "Losses are negative...",
                            answer: String(v2),
                            acceptableAnswers: [String(v2), `$${v2}`],
                            commonMistakes: {
                                [String(-v2)]: `Losses are NEGATIVE! Losing $${-v2} means value = ${v2}`,
                                "0": `A loss of $${-v2} is still a value: ${v2} (negative)`
                            }
                        },
                        {
                            prompt: `Calculate: ${v2} × ${p2} = ?`,
                            hint: `Multiply ${v2} by ${p2}`,
                            answer: String(Math.round(v2 * p2 * 100) / 100),
                            acceptableAnswers: [String(Math.round(v2 * p2 * 100) / 100), String(v2 * p2)],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Now add the two products: ${v1 * p1} + ${Math.round(v2 * p2 * 100) / 100} = ?`,
                            hint: "Add the two values (one may be negative)",
                            answer: String(ev),
                            acceptableAnswers: [String(ev), `$${ev}`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `If E(X) = -$2, this game is:`, answer: "Unfavorable (you expect to lose)",
                    options: ["Unfavorable (you expect to lose)", "Favorable (you expect to win)", "Fair (even odds)", "Impossible to determine"],
                    mistakeAnalysis: {
                        "Favorable (you expect to win)": "Negative expected value means you LOSE on average. E < 0 is unfavorable.",
                        "Fair (even odds)": "Fair would be E = 0. E = -$2 means unfavorable.",
                        "Impossible to determine": "E < 0 tells us it's unfavorable - you'll lose $2 on average per game."
                    }}
            };
        }
    },
    8: {
        "Trig Functions": () => ({
            goalProblem: `Find sin(180°) and cos(180°)`,
            teachingSteps: [
                {
                    title: "Trig Functions Beyond Triangles",
                    explanation: "In Pre-Calc, we extend trig functions beyond right triangles using the <strong>Unit Circle</strong>.<br><br>This lets us find sin/cos for ANY angle (even negative or greater than 90°)!",
                    visual: "Unit Circle → Trig for ALL angles"
                },
                {
                    title: "The Unit Circle",
                    explanation: "The <strong>Unit Circle</strong> is:<br><br>• A circle with <strong>radius = 1</strong><br>• Centered at the <strong>origin (0,0)</strong><br>• Angles measured from the positive x-axis<br>• Going counter-clockwise = positive angles",
                    visual: "Radius = 1, centered at (0,0)"
                },
                {
                    title: "The Key Insight: Coordinates = sin and cos",
                    explanation: "For any point on the unit circle at angle θ:<br><br>• <strong>x-coordinate = cos(θ)</strong><br>• <strong>y-coordinate = sin(θ)</strong><br><br>The point is (cos θ, sin θ)!",
                    visual: "Point = (cos θ, sin θ) → cos = x, sin = y"
                },
                {
                    title: "Key Angles to Memorize",
                    explanation: "• 0°: (1, 0) → cos=1, sin=0<br>• 90°: (0, 1) → cos=0, sin=1<br>• 180°: (-1, 0) → cos=-1, sin=0<br>• 270°: (0, -1) → cos=0, sin=-1<br>• 360°: (1, 0) → same as 0°",
                    visual: "0°→(1,0) | 90°→(0,1) | 180°→(-1,0) | 270°→(0,-1)"
                },
                {
                    title: "Step 1: Locate 180° on the Unit Circle",
                    explanation: "180° is halfway around the circle.<br><br>Starting from the positive x-axis and going counter-clockwise 180°, we land on the <strong>negative x-axis</strong>.",
                    visual: "180° = negative x-axis"
                },
                {
                    title: "Step 2: Find the Point",
                    explanation: "At 180°, the point on the unit circle is:<br><br><strong>(-1, 0)</strong><br><br>(one unit left of center, no units up/down)",
                    visual: "Point at 180° = (-1, 0)"
                },
                {
                    title: "Step 3: Read sin and cos",
                    explanation: "Point = (cos θ, sin θ) = (-1, 0)<br><br>• <strong>cos(180°) = -1</strong> (x-coordinate)<br>• <strong>sin(180°) = 0</strong> (y-coordinate)",
                    visual: "cos(180°) = -1, sin(180°) = 0"
                }
            ],
            finalAnswer: "sin(180°) = 0, cos(180°) = -1",
            answerExplanation: "At 180° on the unit circle, the point is (-1, 0), so cos = -1 (x-coord) and sin = 0 (y-coord).",
            example: { problem: `Find sin(180°) and cos(180°)`, steps: [
                { text: "Locate 180° on the unit circle", math: "180° is on the negative x-axis" },
                { text: "The point is (-1, 0)", math: "(cos 180°, sin 180°) = (-1, 0)" },
                { text: "Read off the values", math: "<strong>sin(180°) = 0, cos(180°) = -1</strong>" }
            ]},
            keyPoints: [
                "sin = y-coordinate, cos = x-coordinate on unit circle",
                "sin and cos repeat every 360° (they're periodic)",
                "tan θ = sin θ / cos θ"
            ],
            mistakes: [
                { wrong: "Confusing sin and cos coordinates", why: "cos = x (horizontal), sin = y (vertical). Think: cos sounds like 'cross' (horizontal)" },
                { wrong: "Forgetting signs in different quadrants", why: "In quadrant II: sin positive, cos negative. Use 'All Students Take Calculus'" }
            ],
            guided: { problem: `What is cos(0°)?`, steps: [
                { label: "0° is on the positive x-axis", value: "Point: (1, 0)" },
                { label: "cos = x-coordinate", value: "?" }
            ], answer: "1", answerLabel: "cos(0°) = ?",
                interactiveSteps: [
                    {
                        prompt: "Where is 0° located on the unit circle?",
                        hint: "0° is the starting point, pointing right...",
                        answer: "positive x-axis",
                        acceptableAnswers: ["positive x-axis", "right", "x-axis", "(1, 0)", "1, 0"],
                        commonMistakes: {
                            "y-axis": "0° is on the positive x-axis (pointing right). 90° is on the y-axis.",
                            "origin": "The origin is the center. 0° is at point (1, 0) on the circle."
                        }
                    },
                    {
                        prompt: "At 0° on the unit circle, what is the coordinate point (x, y)?",
                        hint: "On the positive x-axis, on a circle with radius 1...",
                        answer: "(1, 0)",
                        acceptableAnswers: ["(1, 0)", "1, 0", "(1,0)"],
                        commonMistakes: {
                            "(0, 1)": "That's 90°. At 0°, we're on the positive x-axis: (1, 0)",
                            "(0, 0)": "That's the center. The point on the circle at 0° is (1, 0)."
                        }
                    },
                    {
                        prompt: "Cosine equals which coordinate: x or y?",
                        hint: "cos = horizontal, sin = vertical...",
                        answer: "x",
                        acceptableAnswers: ["x", "x-coordinate", "x coordinate"],
                        commonMistakes: {
                            "y": "y is for sine. Cosine = x-coordinate (horizontal)."
                        }
                    },
                    {
                        prompt: "At (1, 0), the x-coordinate is 1. So cos(0°) = ?",
                        hint: "Read the x-coordinate...",
                        answer: "1",
                        acceptableAnswers: ["1"],
                        commonMistakes: {
                            "0": "0 is the y-coordinate (which is sin). cos(0°) = x-coordinate = 1"
                        }
                    }
                ]
            },
            practice: { problem: `What is sin(90°)?`, answer: "1",
                options: ["0", "1", "-1", "√2/2"],
                mistakeAnalysis: {
                    "0": "sin(90°) = 1. You might be thinking of cos(90°) = 0",
                    "-1": "sin(90°) = 1, not -1. sin is negative at 270°.",
                    "√2/2": "That's sin(45°). At 90°, sin = 1."
                }}
        }),
        "Radian Measure": () => {
            const degrees = pick([30, 45, 60, 90, 120, 180]);
            const radians = degrees === 30 ? "π/6" : degrees === 45 ? "π/4" : degrees === 60 ? "π/3" : degrees === 90 ? "π/2" : degrees === 120 ? "2π/3" : "π";
            return {
                goalProblem: `Convert 180° to radians`,
                teachingSteps: [
                    {
                        title: "Why Use Radians?",
                        explanation: "Radians are another way to measure angles, and they're actually more natural in advanced math!<br><br>Many formulas in calculus only work when using radians, not degrees.",
                        visual: "Radians = the 'natural' angle measure for math"
                    },
                    {
                        title: "What is a Radian?",
                        explanation: "A <strong>radian</strong> is defined by the arc length on a unit circle.<br><br>1 radian = the angle where the arc length equals the radius.<br><br>Since the circumference = 2πr, a full circle = <strong>2π radians</strong>.",
                        visual: "Full circle = 360° = 2π radians"
                    },
                    {
                        title: "The Key Conversion",
                        explanation: "The magic relationship:<br><br><strong>180° = π radians</strong><br><br>This gives us our conversion factors:<br>• To convert deg → rad: multiply by <strong>π/180</strong><br>• To convert rad → deg: multiply by <strong>180/π</strong>",
                        visual: "180° = π rad → deg × (π/180) = rad"
                    },
                    {
                        title: "Common Angle Conversions",
                        explanation: "• 30° = π/6<br>• 45° = π/4<br>• 60° = π/3<br>• 90° = π/2<br>• 180° = π<br>• 270° = 3π/2<br>• 360° = 2π",
                        visual: "30°=π/6 | 45°=π/4 | 60°=π/3 | 90°=π/2 | 180°=π"
                    },
                    {
                        title: "Step 1: Use the Conversion Formula",
                        explanation: "To convert degrees to radians:<br><br><strong>radians = degrees × (π/180)</strong>",
                        visual: "radians = degrees × (π/180)"
                    },
                    {
                        title: "Step 2: Plug in 180°",
                        explanation: "radians = 180° × (π/180)<br><br>= 180π/180<br><br>= <strong>π</strong>",
                        visual: "180 × (π/180) = π"
                    }
                ],
                finalAnswer: "π radians",
                answerExplanation: "Using the formula: 180° × (π/180) = π radians. This is the key fact: 180° = π radians.",
                example: { problem: `Convert 180° to radians`, steps: [
                    { text: "Apply formula", math: "radians = degrees × (π/180)" },
                    { text: "Substitute", math: "= 180 × (π/180)" },
                    { text: "Simplify", math: "<strong>= π radians</strong>" }
                ]},
                keyPoints: [
                    "180° = π radians (memorize this!)",
                    "Degrees to radians: multiply by π/180",
                    "Radians to degrees: multiply by 180/π"
                ],
                mistakes: [
                    { wrong: "Multiplying by 180/π when going to radians", why: "That's backwards! Degrees → radians uses π/180." },
                    { wrong: "Forgetting π in the answer", why: "Radian answers typically include π (e.g., π/2, not 1.57)" }
                ],
                guided: { problem: `Convert ${degrees}° to radians`, steps: [
                    { label: "Formula", value: "degrees × (π/180)" },
                    { label: `${degrees} × (π/180)`, value: "?" }
                ], answer: radians, answerLabel: `${degrees}° in radians:`,
                    interactiveSteps: [
                        {
                            prompt: "To convert degrees to radians, we multiply by what?",
                            hint: "π over some number...",
                            answer: "π/180",
                            acceptableAnswers: ["π/180", "pi/180", "π / 180"],
                            commonMistakes: {
                                "180/π": "That's for radians to degrees. Degrees to radians uses π/180.",
                                "180": "Don't forget π! Multiply by π/180."
                            }
                        },
                        {
                            prompt: `Set up: ${degrees} × (π/180). What is ${degrees}/180 simplified?`,
                            hint: `Simplify the fraction ${degrees}/180`,
                            answer: degrees === 30 ? "1/6" : degrees === 45 ? "1/4" : degrees === 60 ? "1/3" : degrees === 90 ? "1/2" : degrees === 120 ? "2/3" : "1",
                            acceptableAnswers: degrees === 180 ? ["1", "180/180"] : [degrees === 30 ? "1/6" : degrees === 45 ? "1/4" : degrees === 60 ? "1/3" : degrees === 90 ? "1/2" : "2/3"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `So ${degrees}° = ? radians`,
                            hint: `${degrees}/180 × π = ${radians}`,
                            answer: radians,
                            acceptableAnswers: [radians, radians + " radians", radians + " rad"],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Convert π/2 radians to degrees`, answer: "90°",
                    options: ["45°", "90°", "180°", "360°"],
                    mistakeAnalysis: {
                        "45°": "π/4 = 45°. π/2 = 90°",
                        "180°": "π = 180°. π/2 = half of that = 90°",
                        "360°": "2π = 360°. π/2 = 90°"
                    }}
            };
        },
        "Inverse Trig": () => ({
            goalProblem: `Find arcsin(1/2) in degrees`,
            teachingSteps: [
                {
                    title: "What are Inverse Trig Functions?",
                    explanation: "<strong>Inverse trig functions</strong> do the opposite of regular trig:<br><br>• sin gives you a ratio from an angle<br>• <strong>arcsin (sin⁻¹)</strong> gives you an angle from a ratio<br><br>They answer: \"What angle has this trig ratio?\"",
                    visual: "sin(angle) → ratio | arcsin(ratio) → angle"
                },
                {
                    title: "The Three Main Inverse Trig Functions",
                    explanation: "• <strong>arcsin</strong> (or sin⁻¹): inverse of sine<br>• <strong>arccos</strong> (or cos⁻¹): inverse of cosine<br>• <strong>arctan</strong> (or tan⁻¹): inverse of tangent<br><br>Note: sin⁻¹ does NOT mean 1/sin!",
                    visual: "arcsin = sin⁻¹ | arccos = cos⁻¹ | arctan = tan⁻¹"
                },
                {
                    title: "Domain and Range Restrictions",
                    explanation: "Since trig functions repeat, we restrict inverse trig to give ONE answer:<br><br>• arcsin: returns angles in [-90°, 90°]<br>• arccos: returns angles in [0°, 180°]<br>• arctan: returns angles in (-90°, 90°)",
                    visual: "arcsin → [-90°, 90°] | arccos → [0°, 180°]"
                },
                {
                    title: "Step 1: Understand the Question",
                    explanation: "arcsin(1/2) asks: \"What angle θ has sin(θ) = 1/2?\"<br><br>We need to find an angle whose sine equals 0.5.",
                    visual: "Find θ where sin(θ) = 1/2"
                },
                {
                    title: "Step 2: Think About the Unit Circle",
                    explanation: "At what angle is the y-coordinate (sine) equal to 1/2?<br><br>This happens at <strong>30°</strong> (in the first quadrant).<br><br>sin(30°) = 1/2 ✓",
                    visual: "sin(30°) = 1/2 → arcsin(1/2) = 30°"
                },
                {
                    title: "Step 3: Check the Range",
                    explanation: "arcsin returns angles in [-90°, 90°].<br><br>30° is in this range ✓<br><br>So <strong>arcsin(1/2) = 30°</strong>",
                    visual: "30° is in [-90°, 90°] ✓"
                }
            ],
            finalAnswer: "30°",
            answerExplanation: "arcsin(1/2) asks what angle has sine = 1/2. Since sin(30°) = 1/2, the answer is 30°.",
            example: { problem: `Find arcsin(1/2)`, steps: [
                { text: "arcsin asks: what angle has this sine?", math: "sin(?) = 1/2" },
                { text: "Recall special angles", math: "sin(30°) = 1/2" },
                { text: "Check it's in range [-90°, 90°]", math: "30° ✓" },
                { text: "Answer", math: "<strong>arcsin(1/2) = 30°</strong>" }
            ]},
            keyPoints: [
                "Inverse trig finds the ANGLE from a ratio",
                "sin⁻¹ ≠ 1/sin (it's inverse function, not reciprocal)",
                "Each inverse has a restricted range to give unique answers"
            ],
            mistakes: [
                { wrong: "Thinking sin⁻¹(x) = 1/sin(x)", why: "sin⁻¹ is INVERSE sine (arcsin), not reciprocal. 1/sin = csc." },
                { wrong: "Giving an angle outside the range", why: "arcsin only returns [-90°, 90°]. Use the principal value." }
            ],
            guided: { problem: `Find arccos(0)`, steps: [
                { label: "Find angle where cos(θ) = 0", value: "?" },
                { label: "arccos range is [0°, 180°]", value: "Which angle works?" }
            ], answer: "90°", answerLabel: "arccos(0) =",
                interactiveSteps: [
                    {
                        prompt: "arccos(0) asks: what angle has cosine equal to 0? Where on the unit circle is x-coordinate = 0?",
                        hint: "The x-coordinate is 0 on the y-axis...",
                        answer: "y-axis",
                        acceptableAnswers: ["y-axis", "90°", "90 degrees", "the y-axis"],
                        commonMistakes: {
                            "x-axis": "On the x-axis, cos = ±1. cos = 0 on the y-axis (at 90° and 270°)."
                        }
                    },
                    {
                        prompt: "cos(90°) = 0 and cos(270°) = 0. But arccos must be in [0°, 180°]. Which angle works?",
                        hint: "270° is outside [0°, 180°]...",
                        answer: "90°",
                        acceptableAnswers: ["90°", "90", "90 degrees"],
                        commonMistakes: {
                            "270°": "270° is outside the arccos range [0°, 180°]. Use 90°."
                        }
                    }
                ]
            },
            practice: { problem: `What is arctan(1)?`, answer: "45°",
                options: ["30°", "45°", "60°", "90°"],
                mistakeAnalysis: {
                    "30°": "tan(30°) = 1/√3 ≈ 0.577. tan(45°) = 1.",
                    "60°": "tan(60°) = √3 ≈ 1.73. tan(45°) = 1.",
                    "90°": "tan(90°) is undefined. arctan(1) = 45°."
                }}
        }),
        Vectors: () => {
            const ax = rand(2, 5), ay = rand(2, 5);
            const bx = rand(1, 4), by = rand(1, 4);
            return {
                goalProblem: `Add vectors: a = (3, 4) and b = (2, 1)`,
                teachingSteps: [
                    {
                        title: "What is a Vector?",
                        explanation: "A <strong>vector</strong> has both <strong>magnitude</strong> (size) and <strong>direction</strong>.<br><br>Unlike regular numbers (scalars), vectors tell you \"how much\" AND \"which way.\"<br><br>Notation: <strong>a = (x, y)</strong> or <strong>⟨x, y⟩</strong>",
                        visual: "Vector = magnitude + direction"
                    },
                    {
                        title: "Representing Vectors",
                        explanation: "A 2D vector <strong>(x, y)</strong> represents:<br>• x units in the horizontal direction<br>• y units in the vertical direction<br><br>Think of it as an arrow from origin to point (x, y).",
                        visual: "(3, 4) = right 3, up 4"
                    },
                    {
                        title: "Vector Magnitude",
                        explanation: "The <strong>magnitude</strong> (length) of vector (x, y) is:<br><br><strong>|v| = √(x² + y²)</strong><br><br>This is the Pythagorean theorem!",
                        visual: "|(3,4)| = √(9+16) = √25 = 5"
                    },
                    {
                        title: "Adding Vectors",
                        explanation: "To add vectors, add their corresponding components:<br><br><strong>(a₁, a₂) + (b₁, b₂) = (a₁+b₁, a₂+b₂)</strong><br><br>Graphically, this is the \"tip-to-tail\" method.",
                        visual: "(a₁, a₂) + (b₁, b₂) = (a₁+b₁, a₂+b₂)"
                    },
                    {
                        title: "Step 1: Identify Components",
                        explanation: "Vector a = (3, 4): x-component = 3, y-component = 4<br>Vector b = (2, 1): x-component = 2, y-component = 1",
                        visual: "a = (3, 4), b = (2, 1)"
                    },
                    {
                        title: "Step 2: Add Components",
                        explanation: "Add x-components: 3 + 2 = <strong>5</strong><br>Add y-components: 4 + 1 = <strong>5</strong><br><br>Result: <strong>(5, 5)</strong>",
                        visual: "(3+2, 4+1) = (5, 5)"
                    }
                ],
                finalAnswer: "(5, 5)",
                answerExplanation: "Adding component-wise: (3+2, 4+1) = (5, 5).",
                example: { problem: `Add vectors (3, 4) + (2, 1)`, steps: [
                    { text: "Add x-components", math: "3 + 2 = 5" },
                    { text: "Add y-components", math: "4 + 1 = 5" },
                    { text: "Result", math: "<strong>(5, 5)</strong>" }
                ]},
                keyPoints: [
                    "Add vectors by adding corresponding components",
                    "Magnitude |v| = √(x² + y²)",
                    "Scalar multiplication: k(x,y) = (kx, ky)"
                ],
                mistakes: [
                    { wrong: "Adding all components together: (3,4)+(2,1) = 10", why: "Add x's separately from y's: (3+2, 4+1) = (5, 5)" },
                    { wrong: "Forgetting vectors have direction", why: "Vectors aren't just numbers - keep track of each component." }
                ],
                guided: { problem: `Add vectors: a = (${ax}, ${ay}) and b = (${bx}, ${by})`, steps: [
                    { label: "Add x-components", value: `${ax} + ${bx} = ${ax + bx}` },
                    { label: "Add y-components", value: `${ay} + ${by} = ${ay + by}` },
                    { label: "Result", value: "?" }
                ], answer: `(${ax + bx}, ${ay + by})`, answerLabel: "a + b =",
                    interactiveSteps: [
                        {
                            prompt: `Add the x-components: ${ax} + ${bx} = ?`,
                            hint: `Add the first numbers from each vector`,
                            answer: String(ax + bx),
                            acceptableAnswers: [String(ax + bx)],
                            commonMistakes: {
                                [String(ax * bx)]: `Add, don't multiply! ${ax} + ${bx} = ${ax + bx}`
                            }
                        },
                        {
                            prompt: `Add the y-components: ${ay} + ${by} = ?`,
                            hint: `Add the second numbers from each vector`,
                            answer: String(ay + by),
                            acceptableAnswers: [String(ay + by)],
                            commonMistakes: {
                                [String(ay * by)]: `Add, don't multiply! ${ay} + ${by} = ${ay + by}`
                            }
                        },
                        {
                            prompt: `Write the result as a vector (x, y):`,
                            hint: `Combine your answers: (${ax + bx}, ${ay + by})`,
                            answer: `(${ax + bx}, ${ay + by})`,
                            acceptableAnswers: [`(${ax + bx}, ${ay + by})`, `(${ax+bx},${ay+by})`, `${ax + bx}, ${ay + by}`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `What is the magnitude of vector (3, 4)?`, answer: "5",
                    options: ["5", "7", "12", "25"],
                    mistakeAnalysis: {
                        "7": "That's 3 + 4. Magnitude = √(3² + 4²) = √25 = 5",
                        "12": "You might have done 3 × 4. Magnitude = √(9 + 16) = 5",
                        "25": "That's 3² + 4². Don't forget the square root! √25 = 5"
                    }}
            };
        },
        "Advanced Functions": () => ({
            goalProblem: `Find the inverse of f(x) = 2x + 3`,
            teachingSteps: [
                {
                    title: "What is an Inverse Function?",
                    explanation: "An <strong>inverse function</strong> \"undoes\" what the original function does.<br><br>If f(a) = b, then f⁻¹(b) = a.<br><br>It's like playing a video in reverse!",
                    visual: "f(x) does something → f⁻¹(x) undoes it"
                },
                {
                    title: "The Key Property",
                    explanation: "For a function and its inverse:<br><br><strong>f(f⁻¹(x)) = x</strong> and <strong>f⁻¹(f(x)) = x</strong><br><br>They cancel each other out!",
                    visual: "f and f⁻¹ cancel: f(f⁻¹(x)) = x"
                },
                {
                    title: "How to Find an Inverse",
                    explanation: "1. Replace f(x) with y<br>2. <strong>Swap x and y</strong><br>3. Solve for y<br>4. Replace y with f⁻¹(x)",
                    visual: "Steps: y = f(x) → swap x,y → solve for y"
                },
                {
                    title: "Step 1: Write with y",
                    explanation: "f(x) = 2x + 3<br><br>Replace f(x) with y:<br><strong>y = 2x + 3</strong>",
                    visual: "y = 2x + 3"
                },
                {
                    title: "Step 2: Swap x and y",
                    explanation: "Switch x and y positions:<br><br><strong>x = 2y + 3</strong>",
                    visual: "x = 2y + 3"
                },
                {
                    title: "Step 3: Solve for y",
                    explanation: "x = 2y + 3<br>x - 3 = 2y<br>y = (x - 3)/2<br><br><strong>f⁻¹(x) = (x - 3)/2</strong>",
                    visual: "f⁻¹(x) = (x - 3)/2"
                },
                {
                    title: "Verify: Check Your Answer",
                    explanation: "Let's verify: f(f⁻¹(x)) should equal x.<br><br>f(f⁻¹(x)) = f((x-3)/2)<br>= 2 × (x-3)/2 + 3<br>= (x-3) + 3<br>= x ✓",
                    visual: "f(f⁻¹(x)) = x ✓"
                }
            ],
            finalAnswer: "f⁻¹(x) = (x - 3)/2",
            answerExplanation: "Swap x and y, then solve: x = 2y + 3 → y = (x-3)/2.",
            example: { problem: `Find the inverse of f(x) = 2x + 3`, steps: [
                { text: "Write as y = 2x + 3", math: "y = 2x + 3" },
                { text: "Swap x and y", math: "x = 2y + 3" },
                { text: "Solve for y", math: "y = (x - 3)/2" },
                { text: "Write inverse", math: "<strong>f⁻¹(x) = (x - 3)/2</strong>" }
            ]},
            keyPoints: [
                "Inverse undoes the original function",
                "Find inverse: swap x and y, then solve for y",
                "Verify: f(f⁻¹(x)) = x"
            ],
            mistakes: [
                { wrong: "Just flipping the fraction: inverse of 2x = x/2", why: "You must swap x and y first, then solve algebraically." },
                { wrong: "Forgetting to swap x and y", why: "This is the key step! Swap first, then solve for y." }
            ],
            guided: { problem: `Find the inverse of f(x) = 3x - 6`, steps: [
                { label: "Write y = 3x - 6", value: "y = 3x - 6" },
                { label: "Swap x and y", value: "x = 3y - 6" },
                { label: "Solve for y", value: "?" }
            ], answer: "f⁻¹(x) = (x + 6)/3", answerLabel: "f⁻¹(x) =",
                interactiveSteps: [
                    {
                        prompt: "After swapping x and y in y = 3x - 6, what do we get?",
                        hint: "Just exchange the letters...",
                        answer: "x = 3y - 6",
                        acceptableAnswers: ["x = 3y - 6", "x=3y-6"],
                        commonMistakes: {
                            "y = 3x - 6": "That's the original! After swapping: x = 3y - 6"
                        }
                    },
                    {
                        prompt: "From x = 3y - 6, add 6 to both sides. What do you get?",
                        hint: "x + 6 = 3y - 6 + 6",
                        answer: "x + 6 = 3y",
                        acceptableAnswers: ["x + 6 = 3y", "x+6=3y", "x + 6 = 3y"],
                        commonMistakes: {
                            "x - 6 = 3y": "Add 6 (to undo -6). x + 6 = 3y"
                        }
                    },
                    {
                        prompt: "Now divide both sides by 3 to solve for y:",
                        hint: "(x + 6)/3 = y",
                        answer: "y = (x + 6)/3",
                        acceptableAnswers: ["y = (x + 6)/3", "y=(x+6)/3", "(x + 6)/3", "(x+6)/3"],
                        commonMistakes: {
                            "y = x/3 + 6": "Divide the ENTIRE left side by 3: (x + 6)/3"
                        }
                    }
                ]
            },
            practice: { problem: `If f(2) = 7, what is f⁻¹(7)?`, answer: "2",
                options: ["2", "7", "1/7", "14"],
                mistakeAnalysis: {
                    "7": "f⁻¹ UNDOES f. Since f(2) = 7, then f⁻¹(7) = 2.",
                    "1/7": "Inverse function ≠ reciprocal. f(2) = 7 means f⁻¹(7) = 2.",
                    "14": "The inverse undoes the original. f(2) = 7 → f⁻¹(7) = 2."
                }}
        }),
        "Parametric Equations": () => {
            const t = rand(1, 3);
            return {
                goalProblem: `For x = 2t and y = t², find the point when t = 3`,
                teachingSteps: [
                    {
                        title: "What are Parametric Equations?",
                        explanation: "<strong>Parametric equations</strong> express x and y separately in terms of a third variable (usually <strong>t</strong>).<br><br>Instead of y = f(x), we have:<br>• x = f(t)<br>• y = g(t)",
                        visual: "x = f(t), y = g(t) → both depend on t"
                    },
                    {
                        title: "Why Use Parametric Equations?",
                        explanation: "Parametric equations let us:<br><br>• Describe motion over time (t = time)<br>• Graph curves that aren't functions (like circles)<br>• Control direction and speed along a path",
                        visual: "Great for motion, circles, and complex curves"
                    },
                    {
                        title: "Finding Points",
                        explanation: "To find a point on a parametric curve:<br><br>1. Choose a value for t<br>2. Plug t into the x equation<br>3. Plug t into the y equation<br>4. The point is (x, y)",
                        visual: "Pick t → Calculate x → Calculate y → Point (x, y)"
                    },
                    {
                        title: "Step 1: Identify the Equations",
                        explanation: "We have:<br>• x = 2t<br>• y = t²<br><br>And we want the point when t = 3.",
                        visual: "x = 2t, y = t², find point at t = 3"
                    },
                    {
                        title: "Step 2: Calculate x",
                        explanation: "x = 2t<br>x = 2(3)<br>x = <strong>6</strong>",
                        visual: "x = 2(3) = 6"
                    },
                    {
                        title: "Step 3: Calculate y",
                        explanation: "y = t²<br>y = 3²<br>y = <strong>9</strong>",
                        visual: "y = 3² = 9"
                    },
                    {
                        title: "Step 4: Write the Point",
                        explanation: "The point is <strong>(6, 9)</strong>",
                        visual: "Point: (6, 9)"
                    }
                ],
                finalAnswer: "(6, 9)",
                answerExplanation: "At t = 3: x = 2(3) = 6 and y = 3² = 9, so the point is (6, 9).",
                example: { problem: `Find point when t = 3 for x = 2t, y = t²`, steps: [
                    { text: "Calculate x", math: "x = 2(3) = 6" },
                    { text: "Calculate y", math: "y = 3² = 9" },
                    { text: "Write point", math: "<strong>(6, 9)</strong>" }
                ]},
                keyPoints: [
                    "Plug t into both equations separately",
                    "x and y each depend on the parameter t",
                    "You can eliminate t to get a Cartesian equation"
                ],
                mistakes: [
                    { wrong: "Using t as the y-coordinate", why: "Calculate y from the y equation. t is a parameter, not a coordinate." },
                    { wrong: "Plugging t into only one equation", why: "You need BOTH x and y values to get a point." }
                ],
                guided: { problem: `For x = t + 1 and y = 2t, find the point when t = ${t}`, steps: [
                    { label: "x = t + 1 with t = " + t, value: `x = ${t} + 1 = ${t + 1}` },
                    { label: "y = 2t with t = " + t, value: `y = 2(${t}) = ${2 * t}` },
                    { label: "Point", value: "?" }
                ], answer: `(${t + 1}, ${2 * t})`, answerLabel: "Point:",
                    interactiveSteps: [
                        {
                            prompt: `Calculate x when t = ${t}: x = t + 1 = ?`,
                            hint: `${t} + 1 = ?`,
                            answer: String(t + 1),
                            acceptableAnswers: [String(t + 1)],
                            commonMistakes: {
                                [String(t)]: `Don't forget to add 1! ${t} + 1 = ${t + 1}`
                            }
                        },
                        {
                            prompt: `Calculate y when t = ${t}: y = 2t = ?`,
                            hint: `2 × ${t} = ?`,
                            answer: String(2 * t),
                            acceptableAnswers: [String(2 * t)],
                            commonMistakes: {
                                [String(t + 2)]: `Multiply! 2 × ${t} = ${2 * t}`
                            }
                        },
                        {
                            prompt: `Write the point (x, y):`,
                            hint: `x = ${t + 1}, y = ${2 * t}`,
                            answer: `(${t + 1}, ${2 * t})`,
                            acceptableAnswers: [`(${t + 1}, ${2 * t})`, `(${t+1},${2*t})`],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `A circle has parametric form x = cos(t), y = sin(t). What curve is traced?`, answer: "Unit circle",
                    options: ["Unit circle", "Parabola", "Line", "Ellipse"],
                    mistakeAnalysis: {
                        "Parabola": "x = cos(t), y = sin(t) traces a circle. x² + y² = cos²t + sin²t = 1.",
                        "Line": "This traces a circle. cos and sin oscillate, creating a curved path.",
                        "Ellipse": "Since both use the same parameter without scaling, it's a circle (equal radii)."
                    }}
            };
        },
        "Polar Coordinates": () => {
            const r = rand(2, 5);
            const theta = pick([0, 30, 45, 60, 90]);
            const x = theta === 0 ? r : theta === 90 ? 0 : Math.round(r * Math.cos(theta * Math.PI / 180) * 100) / 100;
            const y = theta === 0 ? 0 : theta === 90 ? r : Math.round(r * Math.sin(theta * Math.PI / 180) * 100) / 100;
            return {
                goalProblem: `Convert polar coordinates (4, 60°) to Cartesian coordinates`,
                teachingSteps: [
                    {
                        title: "What are Polar Coordinates?",
                        explanation: "Instead of (x, y), <strong>polar coordinates</strong> use (r, θ):<br><br>• <strong>r</strong> = distance from origin<br>• <strong>θ</strong> = angle from positive x-axis<br><br>It's like giving directions: \"go r units at angle θ\"",
                        visual: "(r, θ) → distance r at angle θ"
                    },
                    {
                        title: "Cartesian vs. Polar",
                        explanation: "<strong>Cartesian:</strong> (x, y) - how far right and up<br><br><strong>Polar:</strong> (r, θ) - how far and which direction<br><br>Same point, different descriptions!",
                        visual: "Cartesian: (x, y) | Polar: (r, θ)"
                    },
                    {
                        title: "Conversion Formulas",
                        explanation: "<strong>Polar to Cartesian:</strong><br>• x = r cos(θ)<br>• y = r sin(θ)<br><br><strong>Cartesian to Polar:</strong><br>• r = √(x² + y²)<br>• θ = arctan(y/x)",
                        visual: "x = r cos θ, y = r sin θ | r = √(x²+y²)"
                    },
                    {
                        title: "Step 1: Identify r and θ",
                        explanation: "We have polar coordinates (4, 60°):<br><br>• r = 4<br>• θ = 60°",
                        visual: "r = 4, θ = 60°"
                    },
                    {
                        title: "Step 2: Calculate x",
                        explanation: "x = r cos(θ)<br>x = 4 cos(60°)<br>x = 4 × (1/2)<br>x = <strong>2</strong>",
                        visual: "x = 4 × cos(60°) = 4 × 0.5 = 2"
                    },
                    {
                        title: "Step 3: Calculate y",
                        explanation: "y = r sin(θ)<br>y = 4 sin(60°)<br>y = 4 × (√3/2)<br>y = <strong>2√3</strong> ≈ 3.46",
                        visual: "y = 4 × sin(60°) = 4 × (√3/2) = 2√3"
                    },
                    {
                        title: "Final Answer",
                        explanation: "The Cartesian coordinates are:<br><br><strong>(2, 2√3)</strong> or approximately (2, 3.46)",
                        visual: "(4, 60°) → (2, 2√3)"
                    }
                ],
                finalAnswer: "(2, 2√3) ≈ (2, 3.46)",
                answerExplanation: "Using x = r cos θ = 4(1/2) = 2 and y = r sin θ = 4(√3/2) = 2√3.",
                example: { problem: `Convert (4, 60°) to Cartesian`, steps: [
                    { text: "x = r cos θ", math: "x = 4 cos(60°) = 4(1/2) = 2" },
                    { text: "y = r sin θ", math: "y = 4 sin(60°) = 4(√3/2) = 2√3" },
                    { text: "Cartesian point", math: "<strong>(2, 2√3)</strong>" }
                ]},
                keyPoints: [
                    "Polar to Cartesian: x = r cos θ, y = r sin θ",
                    "Cartesian to Polar: r = √(x² + y²), θ = arctan(y/x)",
                    "r is always the distance from origin"
                ],
                mistakes: [
                    { wrong: "Mixing up sin and cos", why: "x uses cos (horizontal), y uses sin (vertical)" },
                    { wrong: "Using degrees in calculator set to radians", why: "Make sure calculator mode matches your angle measure!" }
                ],
                guided: { problem: `Convert polar (${r}, ${theta}°) to Cartesian`, steps: [
                    { label: "x = r cos θ", value: `${r} × cos(${theta}°) = ?` },
                    { label: "y = r sin θ", value: `${r} × sin(${theta}°) = ?` }
                ], answer: `(${x}, ${y})`, answerLabel: "Cartesian:",
                    interactiveSteps: [
                        {
                            prompt: `What is cos(${theta}°)?`,
                            hint: theta === 0 ? "cos(0°) = 1" : theta === 90 ? "cos(90°) = 0" : theta === 60 ? "cos(60°) = 1/2" : theta === 30 ? "cos(30°) = √3/2" : "cos(45°) = √2/2",
                            answer: theta === 0 ? "1" : theta === 90 ? "0" : theta === 60 ? "0.5" : theta === 30 ? "0.866" : "0.707",
                            acceptableAnswers: theta === 0 ? ["1"] : theta === 90 ? ["0"] : theta === 60 ? ["0.5", "1/2", "0.50"] : theta === 30 ? ["√3/2", "0.866", "0.87"] : ["√2/2", "0.707", "0.71"],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate x = ${r} × cos(${theta}°) = ?`,
                            hint: `Multiply ${r} by your cos value`,
                            answer: String(x),
                            acceptableAnswers: [String(x), String(Math.round(x))],
                            commonMistakes: {}
                        },
                        {
                            prompt: `Calculate y = ${r} × sin(${theta}°) = ?`,
                            hint: theta === 0 ? "sin(0°) = 0" : theta === 90 ? "sin(90°) = 1" : theta === 60 ? "sin(60°) = √3/2 ≈ 0.866" : theta === 30 ? "sin(30°) = 0.5" : "sin(45°) = √2/2",
                            answer: String(y),
                            acceptableAnswers: [String(y), String(Math.round(y))],
                            commonMistakes: {}
                        }
                    ]
                },
                practice: { problem: `Convert Cartesian (3, 4) to polar. What is r?`, answer: "5",
                    options: ["5", "7", "12", "1"],
                    mistakeAnalysis: {
                        "7": "r = √(x² + y²) = √(9 + 16) = √25 = 5, not 3 + 4",
                        "12": "r = √(9 + 16) = √25 = 5, not 3 × 4",
                        "1": "r = √(3² + 4²) = √25 = 5"
                    }}
            };
        },
        "Normal Distribution": () => {
            const mean = rand(60, 80);
            const sd = rand(5, 10);
            return {
                goalProblem: `A test has mean 70 and standard deviation 10. What percentage of scores fall within one standard deviation of the mean?`,
                teachingSteps: [
                    {
                        title: "What is the Normal Distribution?",
                        explanation: "The <strong>normal distribution</strong> (bell curve) is the most important distribution in statistics.<br><br>Many natural phenomena follow this pattern: heights, test scores, measurement errors, etc.",
                        visual: "Normal = Bell-shaped, symmetric curve"
                    },
                    {
                        title: "Key Properties",
                        explanation: "• <strong>Symmetric</strong> around the mean<br>• <strong>Mean = Median = Mode</strong> (all at center)<br>• Most data is near the middle, less at extremes<br>• Total area under curve = 1 (100%)",
                        visual: "Symmetric, centered at mean"
                    },
                    {
                        title: "The 68-95-99.7 Rule (Empirical Rule)",
                        explanation: "For normal distributions:<br><br>• <strong>68%</strong> of data falls within 1 SD of mean<br>• <strong>95%</strong> of data falls within 2 SD of mean<br>• <strong>99.7%</strong> of data falls within 3 SD of mean",
                        visual: "68% (1 SD) | 95% (2 SD) | 99.7% (3 SD)"
                    },
                    {
                        title: "Understanding Standard Deviation",
                        explanation: "<strong>Standard deviation (σ)</strong> measures how spread out the data is.<br><br>• Small SD = data tightly clustered around mean<br>• Large SD = data spread out widely",
                        visual: "SD = measure of spread"
                    },
                    {
                        title: "Step 1: Identify the Question",
                        explanation: "We want the percentage within <strong>one standard deviation</strong> of the mean.<br><br>This means between (mean - SD) and (mean + SD).",
                        visual: "Within 1 SD → 70 - 10 to 70 + 10 → 60 to 80"
                    },
                    {
                        title: "Step 2: Apply the Empirical Rule",
                        explanation: "By the 68-95-99.7 rule:<br><br>Within 1 standard deviation = <strong>68%</strong><br><br>So 68% of scores fall between 60 and 80.",
                        visual: "Within 1 SD = 68%"
                    }
                ],
                finalAnswer: "68%",
                answerExplanation: "By the empirical (68-95-99.7) rule, 68% of data falls within one standard deviation of the mean.",
                example: { problem: `Percentage within 1 SD of mean`, steps: [
                    { text: "Recall the empirical rule", math: "68-95-99.7" },
                    { text: "Within 1 SD", math: "68%" },
                    { text: "Answer", math: "<strong>68%</strong>" }
                ]},
                keyPoints: [
                    "68% within 1 SD, 95% within 2 SD, 99.7% within 3 SD",
                    "Normal curves are symmetric around the mean",
                    "Z-score: z = (x - mean)/SD"
                ],
                mistakes: [
                    { wrong: "Confusing SD percentages: 95% for 1 SD", why: "1 SD = 68%, 2 SD = 95%, 3 SD = 99.7%. Memorize 68-95-99.7!" },
                    { wrong: "Thinking SD is a percentage", why: "SD is a measure of spread (same units as data). The percentages come from the empirical rule." }
                ],
                guided: { problem: `Test scores: mean = ${mean}, SD = ${sd}. What range contains 95% of scores?`, steps: [
                    { label: "95% is within how many SDs?", value: "2 SD" },
                    { label: "Lower bound: mean - 2×SD", value: `${mean} - 2(${sd}) = ${mean - 2*sd}` },
                    { label: "Upper bound: mean + 2×SD", value: `${mean} + 2(${sd}) = ${mean + 2*sd}` }
                ], answer: `${mean - 2*sd} to ${mean + 2*sd}`, answerLabel: "95% range:",
                    interactiveSteps: [
                        {
                            prompt: "According to the empirical rule, 95% of data is within how many standard deviations of the mean?",
                            hint: "68-95-99.7 rule...",
                            answer: "2",
                            acceptableAnswers: ["2", "2 SD", "2 standard deviations", "two"],
                            commonMistakes: {
                                "1": "1 SD captures 68%. 95% needs 2 SD.",
                                "3": "3 SD captures 99.7%. 95% needs 2 SD."
                            }
                        },
                        {
                            prompt: `Calculate the lower bound: ${mean} - 2(${sd}) = ?`,
                            hint: `${mean} - ${2 * sd} = ?`,
                            answer: String(mean - 2 * sd),
                            acceptableAnswers: [String(mean - 2 * sd)],
                            commonMistakes: {
                                [String(mean - sd)]: `That's only 1 SD below. We need 2 SD: ${mean} - ${2*sd} = ${mean - 2*sd}`
                            }
                        },
                        {
                            prompt: `Calculate the upper bound: ${mean} + 2(${sd}) = ?`,
                            hint: `${mean} + ${2 * sd} = ?`,
                            answer: String(mean + 2 * sd),
                            acceptableAnswers: [String(mean + 2 * sd)],
                            commonMistakes: {
                                [String(mean + sd)]: `That's only 1 SD above. We need 2 SD: ${mean} + ${2*sd} = ${mean + 2*sd}`
                            }
                        }
                    ]
                },
                practice: { problem: `What percentage of data is MORE than 2 SD from the mean?`, answer: "5%",
                    options: ["5%", "32%", "95%", "2.5%"],
                    mistakeAnalysis: {
                        "32%": "32% is OUTSIDE 1 SD. Outside 2 SD is 100% - 95% = 5%",
                        "95%": "95% is WITHIN 2 SD. OUTSIDE 2 SD is 100% - 95% = 5%",
                        "2.5%": "2.5% is on one tail only. Total outside 2 SD (both tails) = 5%"
                    }}
            };
        },
        Limits: () => ({
            goalProblem: `Find: lim (x→2) (x² - 4)/(x - 2)`,
            teachingSteps: [
                {
                    title: "What is a Limit?",
                    explanation: "A <strong>limit</strong> describes what value a function <strong>approaches</strong> as x gets closer and closer to some number.<br><br>It's like asking: \"What happens as we get REALLY close to x = 2?\"",
                    visual: "Limit = What value does f(x) approach?"
                },
                {
                    title: "Limit Notation",
                    explanation: "We write: <strong>lim (x→a) f(x) = L</strong><br><br>This means: \"As x approaches a, f(x) approaches L\"<br><br>The arrow → means \"approaches\"",
                    visual: "lim (x→a) f(x) = L → \"f(x) approaches L as x approaches a\""
                },
                {
                    title: "Method 1: Direct Substitution",
                    explanation: "The simplest approach: just <strong>plug in the value</strong>!<br><br>If you get a normal number, that's the limit!<br><br>If you get 0/0 or ∞/∞, more work is needed.",
                    visual: "Try plugging in → If normal answer, done!"
                },
                {
                    title: "Step 1: Try Direct Substitution",
                    explanation: "Let's plug in x = 2:<br><br>(2² - 4)/(2 - 2) = (4 - 4)/(0) = <strong>0/0</strong><br><br>Uh oh! 0/0 is called \"indeterminate\" - we need a different approach.",
                    visual: "(4-4)/(2-2) = 0/0 → Indeterminate!"
                },
                {
                    title: "What is 0/0?",
                    explanation: "<strong>0/0 is NOT zero or undefined!</strong><br><br>It's \"indeterminate\" - it means the limit might still exist, but we need to simplify first.<br><br>Common fix: <strong>Factor and cancel!</strong>",
                    visual: "0/0 = Indeterminate → Try factoring"
                },
                {
                    title: "Step 2: Factor the Numerator",
                    explanation: "x² - 4 is a \"difference of squares\":<br><br>x² - 4 = (x + 2)(x - 2)<br><br>So our fraction becomes: <strong>(x+2)(x-2)/(x-2)</strong>",
                    visual: "x² - 4 = (x+2)(x-2)"
                },
                {
                    title: "Step 3: Cancel Common Factors",
                    explanation: "(x+2)(x-2)/(x-2) = <strong>x + 2</strong><br><br>The (x-2) terms cancel!<br><br>Now we have a simpler function: f(x) = x + 2",
                    visual: "(x+2)(x-2)/(x-2) = x + 2"
                },
                {
                    title: "Step 4: Substitute Again",
                    explanation: "Now we can plug in x = 2:<br><br>lim (x→2) (x + 2) = 2 + 2 = <strong>4</strong><br><br>The limit is 4!",
                    visual: "x + 2 → 2 + 2 = 4"
                }
            ],
            finalAnswer: "4",
            answerExplanation: "After factoring x² - 4 = (x+2)(x-2) and canceling, we got x + 2. Substituting x = 2 gives us 4.",
            example: { problem: `Find: lim (x→2) (x² - 4)/(x - 2)`, steps: [
                { text: "Try direct substitution", math: "(2² - 4)/(2 - 2) = 0/0 ← indeterminate!" },
                { text: "Factor the numerator", math: "(x² - 4) = (x+2)(x-2)" },
                { text: "Cancel common factors", math: "(x+2)(x-2)/(x-2) = x + 2" },
                { text: "Now substitute", math: "lim = 2 + 2 = <strong>4</strong>" }
            ]},
            keyPoints: [
                "If direct substitution works, use it!",
                "0/0 is indeterminate - try factoring or L'Hôpital's rule",
                "A limit may exist even if f(a) is undefined"
            ],
            mistakes: [
                { wrong: "Thinking 0/0 = 0 or undefined", why: "0/0 is INDETERMINATE - more work needed!" },
                { wrong: "Forgetting to check both sides", why: "For the limit to exist, left and right limits must be equal." }
            ],
            guided: { problem: `Find: lim (x→3) (x + 5)`, steps: [
                { label: "Try substitution", value: "3 + 5 = ?" },
                { label: "Since it works, the limit is", value: "?" }
            ], answer: "8", answerLabel: "Limit = ?",
                interactiveSteps: [
                    {
                        prompt: "In lim (x→3) (x + 5), what is x approaching?",
                        hint: "Look at the x→? notation...",
                        answer: "3",
                        acceptableAnswers: ["3", "x → 3"],
                        commonMistakes: {
                            "5": "5 is part of the function. x is approaching 3.",
                            "8": "8 is the answer. x is approaching 3."
                        }
                    },
                    {
                        prompt: "What is the simplest method to try first for finding a limit?",
                        hint: "Just plug in the value...",
                        answer: "direct substitution",
                        acceptableAnswers: ["direct substitution", "substitution", "plug in", "substitute"],
                        commonMistakes: {
                            "factoring": "Try direct substitution first. Only factor if you get 0/0."
                        }
                    },
                    {
                        prompt: "Substitute x = 3 into (x + 5). What is 3 + 5?",
                        hint: "3 plus 5...",
                        answer: "8",
                        acceptableAnswers: ["8"],
                        commonMistakes: {
                            "35": "Add, don't concatenate! 3 + 5 = 8"
                        }
                    },
                    {
                        prompt: "Did we get a normal number (not 0/0 or ∞)? So the limit equals?",
                        hint: "Since substitution worked, that's our answer...",
                        answer: "8",
                        acceptableAnswers: ["8", "the limit is 8"],
                        commonMistakes: {}
                    }
                ]
            },
            practice: { problem: `lim (x→4) 2x = ?`, answer: "8",
                options: ["4", "8", "∞", "0"],
                mistakeAnalysis: {
                    "4": "Substitute x = 4 into 2x: 2(4) = 8",
                    "∞": "This function doesn't go to infinity at x = 4. Just substitute: 2(4) = 8",
                    "0": "2(4) = 8, not 0. Simple substitution works here."
                }}
        }),
        "Complex Numbers": () => {
            const a = rand(2, 5), b = rand(2, 5);
            return {
                goalProblem: `Simplify: (3 + 2i) + (1 + 4i)`,
                teachingSteps: [
                    {
                        title: "What is an Imaginary Number?",
                        explanation: "You learned that √(-1) doesn't exist... but mathematicians invented <strong>i</strong> to be the answer!<br><br><strong>i = √(-1)</strong><br><br>This means <strong>i² = -1</strong> (the most important fact!).",
                        visual: "i = √(-1), so i² = -1"
                    },
                    {
                        title: "What is a Complex Number?",
                        explanation: "A <strong>complex number</strong> has the form:<br><br><strong>a + bi</strong><br><br>• <strong>a</strong> = the \"real part\"<br>• <strong>b</strong> = the \"imaginary part\"<br><br>Example: 3 + 2i has real part 3, imaginary part 2",
                        visual: "a + bi → a = real, b = imaginary"
                    },
                    {
                        title: "Powers of i",
                        explanation: "The powers of i follow a pattern:<br><br>• i¹ = i<br>• i² = <strong>-1</strong><br>• i³ = i² × i = -1 × i = <strong>-i</strong><br>• i⁴ = i² × i² = -1 × -1 = <strong>1</strong><br>• i⁵ = i (pattern repeats!)",
                        visual: "i → -1 → -i → 1 → (repeats)"
                    },
                    {
                        title: "Adding Complex Numbers",
                        explanation: "To add complex numbers:<br><br>• Add the <strong>real parts</strong> together<br>• Add the <strong>imaginary parts</strong> together<br><br>Think of i like a variable - combine like terms!",
                        visual: "(a+bi) + (c+di) = (a+c) + (b+d)i"
                    },
                    {
                        title: "Step 1: Identify Real and Imaginary Parts",
                        explanation: "(3 + 2i) + (1 + 4i)<br><br>First number: real = <strong>3</strong>, imaginary = <strong>2</strong><br>Second number: real = <strong>1</strong>, imaginary = <strong>4</strong>",
                        visual: "3 + 2i: real=3, imag=2 | 1 + 4i: real=1, imag=4"
                    },
                    {
                        title: "Step 2: Add Real Parts",
                        explanation: "Real parts: 3 + 1 = <strong>4</strong>",
                        visual: "3 + 1 = 4"
                    },
                    {
                        title: "Step 3: Add Imaginary Parts",
                        explanation: "Imaginary parts: 2i + 4i = <strong>6i</strong>",
                        visual: "2i + 4i = 6i"
                    },
                    {
                        title: "Step 4: Combine",
                        explanation: "Put them together: <strong>4 + 6i</strong>",
                        visual: "4 + 6i (done!)"
                    }
                ],
                finalAnswer: "4 + 6i",
                answerExplanation: "We added real parts (3+1=4) and imaginary parts (2i+4i=6i) separately to get 4 + 6i.",
                example: { problem: `Simplify: (3 + 2i) + (1 + 4i)`, steps: [
                    { text: "Add real parts", math: "3 + 1 = 4" },
                    { text: "Add imaginary parts", math: "2i + 4i = 6i" },
                    { text: "Combine", math: "<strong>4 + 6i</strong>" }
                ]},
                keyPoints: [
                    "Add/subtract: combine real with real, imaginary with imaginary",
                    "Multiply using FOIL, then use i² = -1",
                    "The conjugate of a + bi is a - bi"
                ],
                mistakes: [
                    { wrong: "Forgetting i² = -1 when multiplying", why: "When you get i², replace it with -1" },
                    { wrong: "Adding real and imaginary: 3 + 2i = 5i", why: "3 and 2i are different types. Keep them separate: 3 + 2i" }
                ],
                guided: { problem: `Simplify: (${a} + ${b}i) - (1 + 2i)`, steps: [
                    { label: "Subtract real parts", value: `${a} - 1 = ${a - 1}` },
                    { label: "Subtract imaginary parts", value: `${b}i - 2i = ${b - 2}i` },
                    { label: "Result", value: "?" }
                ], answer: `${a - 1} + ${b - 2}i`, answerLabel: "Simplified:",
                    interactiveSteps: [
                        {
                            prompt: `In (${a} + ${b}i) - (1 + 2i), what is the real part of the first number?`,
                            hint: "The real part is the number without i...",
                            answer: String(a),
                            acceptableAnswers: [String(a)],
                            commonMistakes: {
                                [String(b)]: `${b} is the imaginary part (coefficient of i). The real part is ${a}.`
                            }
                        },
                        {
                            prompt: `Subtract the real parts: ${a} - 1 = ?`,
                            hint: `${a} minus 1...`,
                            answer: String(a - 1),
                            acceptableAnswers: [String(a - 1)],
                            commonMistakes: {
                                [String(a + 1)]: `Subtract, not add! ${a} - 1 = ${a - 1}`
                            }
                        },
                        {
                            prompt: `Now subtract the imaginary parts: ${b}i - 2i = ?`,
                            hint: "Subtract the coefficients of i...",
                            answer: `${b - 2}i`,
                            acceptableAnswers: [`${b - 2}i`, String(b - 2) + "i"],
                            commonMistakes: {
                                [String(b - 2)]: `Don't forget the i! ${b}i - 2i = ${b - 2}i`,
                                [`${b + 2}i`]: `Subtract! ${b} - 2 = ${b - 2}, so it's ${b - 2}i`
                            }
                        },
                        {
                            prompt: `Combine the results. The simplified form is:`,
                            hint: `Real part: ${a - 1}, Imaginary part: ${b - 2}i`,
                            answer: `${a - 1} + ${b - 2}i`,
                            acceptableAnswers: [`${a - 1} + ${b - 2}i`, `${a-1}+${b-2}i`, `${a - 1} + ${b-2}i`],
                            commonMistakes: {
                                [String(a - 1 + b - 2)]: "Don't combine real and imaginary parts! Keep them separate: ${a - 1} + ${b - 2}i"
                            }
                        }
                    ]
                },
                practice: { problem: `What is i²?`, answer: "-1",
                    options: ["-1", "1", "i", "-i"],
                    mistakeAnalysis: {
                        "1": "i² = -1, not 1. i⁴ = 1.",
                        "i": "i² = -1. We're squaring i, which gives -1 by definition.",
                        "-i": "i² = -1, not -i. i³ = -i."
                    }}
            };
        }
    },
    9: {
        Derivatives: () => ({
            goalProblem: `Find the derivative of f(x) = 3x²`,
            teachingSteps: [
                {
                    title: "What is a Derivative?",
                    explanation: "A <strong>derivative</strong> measures the <strong>instantaneous rate of change</strong> of a function.<br><br>Think of it as: \"How fast is y changing at this exact moment?\"<br><br>In real life: velocity is the derivative of position!",
                    visual: "Derivative = Rate of change = Slope at a point"
                },
                {
                    title: "Derivative Notation",
                    explanation: "There are several ways to write derivatives:<br><br>• <strong>f'(x)</strong> - \"f prime of x\"<br>• <strong>dy/dx</strong> - \"dy over dx\"<br>• <strong>d/dx[f(x)]</strong> - \"derivative with respect to x\"<br><br>They all mean the same thing!",
                    visual: "f'(x) = dy/dx = d/dx[f(x)]"
                },
                {
                    title: "The Power Rule",
                    explanation: "The most important derivative rule:<br><br><strong>d/dx[xⁿ] = n · xⁿ⁻¹</strong><br><br>Steps:<br>1. Bring down the exponent as a coefficient<br>2. Subtract 1 from the exponent",
                    visual: "Power Rule: d/dx[xⁿ] = n·xⁿ⁻¹"
                },
                {
                    title: "Common Derivatives to Know",
                    explanation: "• d/dx[c] = <strong>0</strong> (constants become 0)<br>• d/dx[x] = <strong>1</strong><br>• d/dx[x²] = <strong>2x</strong><br>• d/dx[x³] = <strong>3x²</strong>",
                    visual: "Constant → 0 | x → 1 | x² → 2x | x³ → 3x²"
                },
                {
                    title: "Coefficients Multiply Through",
                    explanation: "If there's a coefficient in front, it stays:<br><br><strong>d/dx[c · f(x)] = c · f'(x)</strong><br><br>The constant just \"goes along for the ride.\"",
                    visual: "d/dx[3x²] = 3 · d/dx[x²] = 3 · (2x)"
                },
                {
                    title: "Step 1: Apply Power Rule to x²",
                    explanation: "For x², using power rule:<br><br>• Bring down exponent 2 as coefficient<br>• Reduce exponent: 2 - 1 = 1<br><br>d/dx[x²] = 2 · x¹ = <strong>2x</strong>",
                    visual: "d/dx[x²] = 2·x¹ = 2x"
                },
                {
                    title: "Step 2: Include the Coefficient 3",
                    explanation: "We had <strong>3</strong>x², so multiply by 3:<br><br>d/dx[3x²] = 3 · 2x = <strong>6x</strong>",
                    visual: "3 · 2x = 6x"
                }
            ],
            finalAnswer: "f'(x) = 6x",
            answerExplanation: "Using the power rule on x² gives 2x, then multiplying by the coefficient 3 gives us 6x.",
            example: { problem: `Find the derivative of f(x) = 3x²`, steps: [
                { text: "Apply the power rule", math: "d/dx[xⁿ] = n·xⁿ⁻¹" },
                { text: "Bring down the exponent, reduce power by 1", math: "d/dx[x²] = 2x¹ = 2x" },
                { text: "Don't forget the coefficient", math: "d/dx[3x²] = 3 · 2x = <strong>6x</strong>" }
            ]},
            keyPoints: [
                "Power rule: bring down the power, subtract 1 from the exponent",
                "Derivative of a constant is 0",
                "Constants multiply through: d/dx[cf(x)] = c · f'(x)"
            ],
            mistakes: [
                { wrong: "d/dx[x²] = x (forgetting to bring down the power)", why: "You must multiply by the old exponent: 2·x¹ = 2x" },
                { wrong: "d/dx[5] = 5 (derivative of a constant)", why: "The derivative of any constant is 0!" }
            ],
            guided: {
                problem: `Find the derivative of f(x) = 4x³`,
                steps: [
                    { label: "Apply power rule to x³", value: "3x²" },
                    { label: "Multiply by coefficient 4", value: "?" }
                ],
                answer: "12x²",
                answerLabel: "f'(x) = ?",
                interactiveSteps: [
                    {
                        prompt: "What is the Power Rule formula?",
                        hint: "d/dx[xⁿ] = ...",
                        answer: "n·xⁿ⁻¹",
                        acceptableAnswers: ["n·xⁿ⁻¹", "nxⁿ⁻¹", "n*x^(n-1)", "n times x to the n-1"],
                        commonMistakes: {
                            "xⁿ⁻¹": "You forgot to bring down the exponent as a coefficient! It's n·xⁿ⁻¹",
                            "n·xⁿ": "Close! But you need to SUBTRACT 1 from the exponent: n·xⁿ⁻¹",
                            "xⁿ⁺¹/(n+1)": "That's the integral rule! Derivative uses n·xⁿ⁻¹"
                        }
                    },
                    {
                        prompt: "Apply power rule to x³: bring down the 3 and reduce the power. What do you get?",
                        hint: "3 × x^(3-1) = ?",
                        answer: "3x²",
                        acceptableAnswers: ["3x²", "3x^2", "3 x²"],
                        commonMistakes: {
                            "x²": "Don't forget to bring down the exponent! 3·x² = 3x²",
                            "3x³": "You need to REDUCE the exponent by 1: x³⁻¹ = x²",
                            "x³": "Apply the power rule: bring down 3, reduce power: 3x²"
                        }
                    },
                    {
                        prompt: "Now multiply by the coefficient 4: 4 × 3x² = ?",
                        hint: "Multiply the coefficients: 4 × 3 = ?",
                        answer: "12x²",
                        acceptableAnswers: ["12x²", "12x^2"],
                        commonMistakes: {
                            "7x²": "You added 4 + 3 instead of multiplying. 4 × 3 = 12, so 12x²",
                            "3x²": "Don't forget to multiply by the original coefficient 4! 4 × 3x² = 12x²",
                            "4x²": "You dropped the 3. Multiply: 4 × 3 = 12, so answer is 12x²"
                        }
                    }
                ]
            },
            practice: { problem: `What is d/dx[x⁵]?`, answer: "5x⁴",
                options: ["x⁴", "5x⁴", "5x⁵", "x⁵"],
                mistakeAnalysis: {
                    "x⁴": "Don't forget to multiply by the exponent! 5·x⁴",
                    "5x⁵": "You need to REDUCE the exponent by 1: 5x⁴",
                    "x⁵": "Apply the power rule: bring down 5, reduce power to 4"
                }}
        }),
        Integrals: () => ({
            goalProblem: `Find ∫x² dx`,
            teachingSteps: [
                {
                    title: "What is an Integral?",
                    explanation: "An <strong>integral</strong> (or antiderivative) is the <strong>reverse of a derivative</strong>.<br><br>If the derivative answers \"what's the slope?\", the integral answers \"what function has this slope?\"",
                    visual: "Integral = Reverse of derivative = Antiderivative"
                },
                {
                    title: "Integral Notation",
                    explanation: "We write integrals as: <strong>∫ f(x) dx</strong><br><br>• <strong>∫</strong> - the integral symbol (stretched S for \"sum\")<br>• <strong>f(x)</strong> - the function we're integrating<br>• <strong>dx</strong> - tells us the variable",
                    visual: "∫ f(x) dx"
                },
                {
                    title: "The Power Rule for Integration",
                    explanation: "The reverse of the derivative power rule:<br><br><strong>∫xⁿ dx = xⁿ⁺¹/(n+1) + C</strong><br><br>Steps:<br>1. Add 1 to the exponent<br>2. Divide by the new exponent<br>3. Add +C",
                    visual: "∫xⁿ dx = xⁿ⁺¹/(n+1) + C"
                },
                {
                    title: "What is +C?",
                    explanation: "The <strong>+C</strong> is the \"constant of integration\".<br><br>Why? Because the derivative of ANY constant is 0!<br><br>So x² + 5 and x² + 100 both have derivative 2x. The +C accounts for this.",
                    visual: "d/dx[x² + 5] = 2x | d/dx[x² + 100] = 2x → +C"
                },
                {
                    title: "Step 1: Add 1 to the Exponent",
                    explanation: "We're integrating x².<br><br>Current exponent: 2<br>New exponent: 2 + 1 = <strong>3</strong>",
                    visual: "2 + 1 = 3"
                },
                {
                    title: "Step 2: Divide by the New Exponent",
                    explanation: "Take x to the new power, divided by that power:<br><br><strong>x³/3</strong>",
                    visual: "x³ / 3"
                },
                {
                    title: "Step 3: Add +C",
                    explanation: "Don't forget the constant of integration!<br><br>Final answer: <strong>x³/3 + C</strong>",
                    visual: "x³/3 + C"
                }
            ],
            finalAnswer: "x³/3 + C",
            answerExplanation: "We added 1 to the exponent (2→3), divided by 3, and added +C for the constant of integration.",
            example: { problem: `Find ∫x² dx`, steps: [
                { text: "Add 1 to the exponent", math: "2 + 1 = 3" },
                { text: "Divide by new exponent", math: "x³/3" },
                { text: "Add constant of integration", math: "<strong>x³/3 + C</strong>" }
            ]},
            keyPoints: [
                "Integration is the reverse of differentiation",
                "Add 1 to exponent, divide by new exponent",
                "Always include +C for indefinite integrals"
            ],
            mistakes: [
                { wrong: "Forgetting +C", why: "Indefinite integrals always have +C because the derivative of any constant is 0" },
                { wrong: "Using the wrong formula: subtracting from exponent", why: "That's derivatives! For integrals, ADD to exponent." }
            ],
            guided: {
                problem: `Find ∫x³ dx`,
                steps: [
                    { label: "Add 1 to exponent: 3 + 1", value: "4" },
                    { label: "Divide by new exponent", value: "x⁴/4" },
                    { label: "Add constant", value: "?" }
                ],
                answer: "x⁴/4 + C",
                answerLabel: "∫x³ dx = ?",
                interactiveSteps: [
                    {
                        prompt: "For integrals, what do we do to the exponent first?",
                        hint: "It's the opposite of derivatives...",
                        answer: "add 1",
                        acceptableAnswers: ["add 1", "add one", "+1", "increase by 1"],
                        commonMistakes: {
                            "subtract 1": "That's for derivatives! Integrals ADD 1 to the exponent.",
                            "multiply": "No, we ADD 1 to the exponent (opposite of derivatives)",
                            "divide": "We divide AFTER increasing the exponent. First step is add 1."
                        }
                    },
                    {
                        prompt: "Add 1 to the exponent: 3 + 1 = ?",
                        hint: "Simple addition: 3 + 1",
                        answer: "4",
                        acceptableAnswers: ["4"],
                        commonMistakes: {
                            "2": "You subtracted! For integrals, ADD: 3 + 1 = 4",
                            "3": "You need to add 1: 3 + 1 = 4"
                        }
                    },
                    {
                        prompt: "Now divide by the new exponent: x⁴/? What goes in the denominator?",
                        hint: "We divide by the NEW exponent (the one we just calculated)",
                        answer: "4",
                        acceptableAnswers: ["4"],
                        commonMistakes: {
                            "3": "Use the NEW exponent (4), not the old one (3)",
                            "5": "The new exponent is 4 (we added 1 to 3), so divide by 4"
                        }
                    },
                    {
                        prompt: "What must we always add at the end of an indefinite integral?",
                        hint: "It accounts for any constant that disappears during differentiation...",
                        answer: "+ C",
                        acceptableAnswers: ["+ C", "+C", "C", "plus C", "constant", "+c", "+ c"],
                        commonMistakes: {
                            "0": "We add +C, not 0. This is the constant of integration.",
                            "nothing": "Don't forget +C! It represents any constant."
                        }
                    }
                ]
            },
            practice: { problem: `What is ∫2x dx?`, answer: "x² + C",
                options: ["x² + C", "2x² + C", "x + C", "2 + C"],
                mistakeAnalysis: {
                    "2x² + C": "You forgot to divide by the new exponent! 2 · (x²/2) = x²",
                    "x + C": "You took the derivative instead of integral. ∫2x dx = x² + C",
                    "2 + C": "That would be the integral of 0. ∫2x dx means antiderivative of 2x."
                }}
        }),
        Applications: () => ({
            goalProblem: `Find the critical points of f(x) = x² - 4x + 3`,
            teachingSteps: [
                {
                    title: "Why Are Derivatives Useful?",
                    explanation: "Derivatives help us find:<br><br>• <strong>Maximum and minimum values</strong> of functions<br>• <strong>Where things are increasing or decreasing</strong><br>• <strong>Velocity and acceleration</strong> from position",
                    visual: "Derivatives → Find max/min, motion, rates"
                },
                {
                    title: "What Are Critical Points?",
                    explanation: "<strong>Critical points</strong> are where a function might have a max or min.<br><br>They occur where:<br>• <strong>f'(x) = 0</strong> (slope is flat)<br>• <strong>f'(x) is undefined</strong>",
                    visual: "Critical points: where f'(x) = 0 or undefined"
                },
                {
                    title: "Finding Max/Min: The Process",
                    explanation: "Steps to find max/min:<br><br>1. Find the derivative f'(x)<br>2. Set f'(x) = 0 and solve<br>3. Use second derivative test to classify",
                    visual: "f'(x) → set = 0 → solve → test"
                },
                {
                    title: "The Second Derivative Test",
                    explanation: "To determine if a critical point is a max or min:<br><br>• <strong>f''(x) > 0</strong> → Minimum (concave UP, like a cup)<br>• <strong>f''(x) < 0</strong> → Maximum (concave DOWN, like a frown)",
                    visual: "f'' > 0: minimum ∪ | f'' < 0: maximum ∩"
                },
                {
                    title: "Step 1: Find the Derivative",
                    explanation: "For f(x) = x² - 4x + 3:<br><br>f'(x) = 2x - 4<br><br>(Using power rule: derivative of x² is 2x, derivative of -4x is -4, derivative of 3 is 0)",
                    visual: "f'(x) = 2x - 4"
                },
                {
                    title: "Step 2: Set the Derivative Equal to 0",
                    explanation: "To find critical points, solve f'(x) = 0:<br><br>2x - 4 = 0",
                    visual: "2x - 4 = 0"
                },
                {
                    title: "Step 3: Solve for x",
                    explanation: "2x - 4 = 0<br>2x = 4<br>x = <strong>2</strong><br><br>The critical point is at x = 2!",
                    visual: "2x = 4 → x = 2"
                },
                {
                    title: "Bonus: Is It a Max or Min?",
                    explanation: "f''(x) = 2 (derivative of 2x - 4)<br><br>Since f''(2) = 2 > 0, this is a <strong>minimum</strong>!<br><br>The point (2, f(2)) = (2, -1) is a minimum.",
                    visual: "f''(2) = 2 > 0 → Minimum at x = 2"
                }
            ],
            finalAnswer: "x = 2",
            answerExplanation: "We found f'(x) = 2x - 4, set it to 0, and solved to get x = 2. This is a minimum since f''(x) > 0.",
            example: { problem: `Find the critical points of f(x) = x² - 4x + 3`, steps: [
                { text: "Find the derivative", math: "f'(x) = 2x - 4" },
                { text: "Set derivative equal to 0", math: "2x - 4 = 0" },
                { text: "Solve for x", math: "x = 2" },
                { text: "This is a critical point at x = 2", math: "" }
            ]},
            keyPoints: [
                "Critical points occur where f'(x) = 0 or undefined",
                "Second derivative test: f''(x) > 0 is min, f''(x) < 0 is max",
                "Velocity = dx/dt, Acceleration = dv/dt"
            ],
            mistakes: [
                { wrong: "Forgetting to set the derivative to 0", why: "Max/min occur at critical points where f'(x) = 0" },
                { wrong: "Confusing max and min in second derivative test", why: "Positive second derivative = concave up = minimum" }
            ],
            guided: { problem: `If position s(t) = t³, what is velocity v(t)?`, steps: [
                { label: "Velocity is derivative of position", value: "v(t) = s'(t)" },
                { label: "Apply power rule to t³", value: "?" }
            ], answer: "3t²", answerLabel: "v(t) = ?",
                interactiveSteps: [
                    {
                        prompt: "Velocity is the _______ of position.",
                        hint: "Velocity measures how position changes over time...",
                        answer: "derivative",
                        acceptableAnswers: ["derivative", "rate of change", "slope"],
                        commonMistakes: {
                            "integral": "Integral goes the opposite direction! Velocity = derivative of position.",
                            "position": "Velocity is the DERIVATIVE of position."
                        }
                    },
                    {
                        prompt: "So we need to find s'(t) where s(t) = t³. What rule do we use?",
                        hint: "For xⁿ, we bring down the exponent...",
                        answer: "power rule",
                        acceptableAnswers: ["power rule", "the power rule"],
                        commonMistakes: {
                            "chain rule": "No composition here. Just use power rule: bring down the exponent.",
                            "product rule": "There's only one term. Use power rule: d/dx[xⁿ] = nxⁿ⁻¹"
                        }
                    },
                    {
                        prompt: "Using the power rule on t³: bring down the exponent. What is the coefficient?",
                        hint: "The exponent is 3, bring it in front...",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        commonMistakes: {
                            "2": "Bring down the original exponent (3), not one less."
                        }
                    },
                    {
                        prompt: "Now reduce the exponent by 1: t³ becomes t^?",
                        hint: "3 - 1 = ?",
                        answer: "2",
                        acceptableAnswers: ["2", "t²"],
                        commonMistakes: {
                            "3": "Reduce by 1: 3 - 1 = 2"
                        }
                    },
                    {
                        prompt: "So v(t) = s'(t) = ?",
                        hint: "Coefficient is 3, power is 2...",
                        answer: "3t²",
                        acceptableAnswers: ["3t²", "3t^2", "3t2"],
                        commonMistakes: {
                            "t³": "That's the original. The derivative is 3t².",
                            "3t³": "Remember to reduce the exponent by 1. It's 3t², not 3t³."
                        }
                    }
                ]
            },
            practice: { problem: `Where does f(x) = x² have a minimum?`, answer: "x = 0",
                options: ["x = 0", "x = 1", "x = -1", "No minimum"],
                mistakeAnalysis: {
                    "x = 1": "Find f'(x) = 2x. Set 2x = 0, so x = 0",
                    "x = -1": "f'(x) = 2x = 0 when x = 0, not -1",
                    "No minimum": "The parabola x² opens upward, so it has a minimum at x = 0"
                }}
        }),
        "Chain Rule": () => {
            const outer = pick(["x²", "x³", "√x"]);
            const inner = pick(["2x + 1", "3x - 2", "x² + 1"]);
            const outerDeriv = outer === "x²" ? "2u" : outer === "x³" ? "3u²" : "1/(2√u)";
            const innerDeriv = inner === "2x + 1" ? "2" : inner === "3x - 2" ? "3" : "2x";
            return {
                goalProblem: `Find d/dx of (${inner})² using the chain rule.`,
                teachingSteps: [
                    {
                        title: "What is the Chain Rule?",
                        explanation: "The <strong>chain rule</strong> lets us differentiate <strong>composite functions</strong> - functions inside other functions.<br><br>If y = f(g(x)), then <strong>dy/dx = f'(g(x)) · g'(x)</strong>",
                        visual: "d/dx[f(g(x))] = f'(g(x)) · g'(x)"
                    },
                    {
                        title: "Think: Outside-Inside",
                        explanation: "Identify two parts:<br><br>• <strong>OUTER function</strong>: What's being done last? (squaring)<br>• <strong>INNER function</strong>: What's inside? (${inner})<br><br>Derivative of outer × Derivative of inner!",
                        visual: "(${inner})² → Outer: u², Inner: ${inner}"
                    },
                    {
                        title: "Step 1: Differentiate the Outer",
                        explanation: "Treat the inner function as a single variable 'u'.<br><br>If outer = u², then <strong>d/du(u²) = 2u</strong><br><br>But we keep the inner function in place: <strong>2(${inner})</strong>",
                        visual: "d/du(u²) = 2u → 2(${inner})"
                    },
                    {
                        title: "Step 2: Differentiate the Inner",
                        explanation: "Now find the derivative of the inner function:<br><br>d/dx(${inner}) = <strong>${innerDeriv}</strong>",
                        visual: "d/dx(${inner}) = ${innerDeriv}"
                    },
                    {
                        title: "Step 3: Multiply Together",
                        explanation: `Chain Rule says multiply:<br><br>2(${inner}) × ${innerDeriv}<br><br>= <strong>${innerDeriv === '2' ? '4' : innerDeriv === '3' ? '6' : '4x'}(${inner})</strong>`,
                        visual: `Answer: ${innerDeriv === '2' ? '4' : innerDeriv === '3' ? '6' : '4x'}(${inner})`
                    }
                ],
                finalAnswer: `${innerDeriv === '2' ? '4' : innerDeriv === '3' ? '6' : '4x'}(${inner})`,
                answerExplanation: `Using chain rule: derivative of outer (2u) times derivative of inner (${innerDeriv}) gives ${innerDeriv === '2' ? '4' : innerDeriv === '3' ? '6' : '4x'}(${inner}).`,
                example: { problem: `Find d/dx of (3x + 1)³`, steps: [
                    { text: "Identify: outer = u³, inner = 3x + 1", math: "f(u) = u³, g(x) = 3x + 1" },
                    { text: "Derivative of outer", math: "f'(u) = 3u² → 3(3x + 1)²" },
                    { text: "Derivative of inner", math: "g'(x) = 3" },
                    { text: "Multiply", math: "<strong>3(3x + 1)² · 3 = 9(3x + 1)²</strong>" }
                ]},
                keyPoints: [
                    "Chain Rule: d/dx[f(g(x))] = f'(g(x)) · g'(x)",
                    "Think 'outside-inside': differentiate outer, keep inner, multiply by inner's derivative",
                    "Common pattern: d/dx[uⁿ] = n·uⁿ⁻¹ · u'"
                ],
                mistakes: [
                    { wrong: "Forgetting to multiply by inner derivative", why: "The chain rule REQUIRES multiplying by the derivative of the inner function." },
                    { wrong: "Differentiating inner first", why: "Order matters: outer derivative first (keeping inner), then multiply by inner derivative." }
                ],
                guided: (() => {
                    return {
                        problem: `Find d/dx of √(x² + 9)`,
                        steps: [
                            { label: "Rewrite √ as power", value: "(x² + 9)^(1/2)" },
                            { label: "Outer function", value: "u^(1/2)" },
                            { label: "Inner function", value: "x² + 9" }
                        ],
                        answer: "x/√(x² + 9)",
                        answerLabel: "Final derivative:",
                        interactiveSteps: [
                            {
                                prompt: "What is the outer function if we let u = x² + 9?",
                                hint: "The square root is being applied to the whole thing...",
                                answer: "√u",
                                acceptableAnswers: ["√u", "u^(1/2)", "u^0.5", "sqrt(u)"],
                                commonMistakes: {
                                    "x²": "x² + 9 is the inner function. The outer is the square root."
                                }
                            },
                            {
                                prompt: "What is d/du of √u = u^(1/2)?",
                                hint: "Use power rule: d/du(u^n) = n·u^(n-1)",
                                answer: "1/(2√u)",
                                acceptableAnswers: ["1/(2√u)", "(1/2)u^(-1/2)", "1/2 u^-1/2", "0.5u^-0.5"],
                                commonMistakes: {
                                    "2√u": "That's for u². For √u, the exponent is 1/2, so it's (1/2)u^(-1/2) = 1/(2√u)"
                                }
                            },
                            {
                                prompt: "What is d/dx of the inner function (x² + 9)?",
                                hint: "Differentiate term by term...",
                                answer: "2x",
                                acceptableAnswers: ["2x"],
                                commonMistakes: {
                                    "x²": "You need to differentiate, not copy. d/dx(x²) = 2x"
                                }
                            },
                            {
                                prompt: "Now multiply: [1/(2√(x²+9))] × 2x = ?",
                                hint: "The 2's cancel...",
                                answer: "x/√(x² + 9)",
                                acceptableAnswers: ["x/√(x² + 9)", "x/√(x²+9)", "x/(x²+9)^(1/2)", "x/sqrt(x²+9)"],
                                commonMistakes: {
                                    "2x/(2√(x²+9))": "Simplify! The 2's cancel to give x/√(x²+9)"
                                }
                            }
                        ]
                    };
                })(),
                practice: { problem: `Find d/dx of (5x - 3)⁴`, answer: "20(5x - 3)³",
                    options: shuffle(["20(5x - 3)³", "4(5x - 3)³", "5(5x - 3)⁴", "4·5x³"]),
                    mistakeAnalysis: {
                        "4(5x - 3)³": "You forgot to multiply by the derivative of the inner function (5). Chain rule gives 4(5x-3)³ × 5 = 20(5x-3)³",
                        "5(5x - 3)⁴": "The outer derivative brings down the exponent and reduces it: 4(5x-3)³, then multiply by inner derivative (5)",
                        "4·5x³": "Don't separate the terms. Keep (5x-3) together as the inner function."
                    }}
            };
        },
        "Product Rule": () => {
            const f = pick(["x²", "x³", "2x"]);
            const g = pick(["sin(x)", "cos(x)", "eˣ"]);
            const fPrime = f === "x²" ? "2x" : f === "x³" ? "3x²" : "2";
            const gPrime = g === "sin(x)" ? "cos(x)" : g === "cos(x)" ? "-sin(x)" : "eˣ";
            return {
                goalProblem: `Find d/dx of x² · eˣ using the product rule.`,
                teachingSteps: [
                    {
                        title: "What is the Product Rule?",
                        explanation: "When differentiating a <strong>product of two functions</strong>, we use:<br><br><strong>(f · g)' = f' · g + f · g'</strong><br><br>\"First times derivative of second, plus second times derivative of first\"",
                        visual: "d/dx[f·g] = f'g + fg'"
                    },
                    {
                        title: "Remember the Pattern",
                        explanation: "Think of it as: <strong>\"derivative of first × second + first × derivative of second\"</strong><br><br>Or simply: <strong>f'g + fg'</strong>",
                        visual: "f'g + fg'"
                    },
                    {
                        title: "Identify Our Functions",
                        explanation: "For x² · eˣ:<br><br>• <strong>f = x²</strong> → f' = 2x<br>• <strong>g = eˣ</strong> → g' = eˣ",
                        visual: "f = x², g = eˣ"
                    },
                    {
                        title: "Apply Product Rule",
                        explanation: "f'g + fg' =<br><br><strong>2x · eˣ</strong> + <strong>x² · eˣ</strong>",
                        visual: "= 2x·eˣ + x²·eˣ"
                    },
                    {
                        title: "Factor (Optional)",
                        explanation: "We can factor out eˣ:<br><br>eˣ(2x + x²) = <strong>eˣ(x² + 2x)</strong><br><br>Or factor further: <strong>xeˣ(x + 2)</strong>",
                        visual: "= eˣ(x² + 2x) = xeˣ(x + 2)"
                    }
                ],
                finalAnswer: "2xeˣ + x²eˣ",
                answerExplanation: "Using product rule: (2x)(eˣ) + (x²)(eˣ) = 2xeˣ + x²eˣ, which factors to eˣ(x² + 2x).",
                example: { problem: `Find d/dx of x · sin(x)`, steps: [
                    { text: "f = x, g = sin(x)", math: "f' = 1, g' = cos(x)" },
                    { text: "Apply product rule", math: "f'g + fg'" },
                    { text: "Substitute", math: "1·sin(x) + x·cos(x)" },
                    { text: "Simplify", math: "<strong>sin(x) + x·cos(x)</strong>" }
                ]},
                keyPoints: [
                    "Product Rule: (fg)' = f'g + fg'",
                    "Don't confuse with chain rule - product rule is for multiplication, chain rule is for composition",
                    "d/dx(eˣ) = eˣ (special derivative!)"
                ],
                mistakes: [
                    { wrong: "Just multiplying the derivatives: f'·g'", why: "Product rule is f'g + fg', NOT f'·g'. You need both terms!" },
                    { wrong: "Forgetting one of the two terms", why: "There are always TWO terms in the product rule. Check that you have f'g AND fg'." }
                ],
                guided: (() => {
                    return {
                        problem: `Find d/dx of x³ · cos(x)`,
                        steps: [
                            { label: "f = x³", value: "f' = 3x²" },
                            { label: "g = cos(x)", value: "g' = -sin(x)" }
                        ],
                        answer: "3x²cos(x) - x³sin(x)",
                        answerLabel: "Product rule gives:",
                        interactiveSteps: [
                            {
                                prompt: "In the product x³ · cos(x), what is f (the first function)?",
                                hint: "It's the function on the left of the multiplication...",
                                answer: "x³",
                                acceptableAnswers: ["x³", "x^3", "x3"],
                                commonMistakes: {
                                    "cos(x)": "cos(x) is g (the second function). f is x³."
                                }
                            },
                            {
                                prompt: "What is f' (derivative of x³)?",
                                hint: "Use power rule: bring down exponent, reduce by 1",
                                answer: "3x²",
                                acceptableAnswers: ["3x²", "3x^2", "3x2"],
                                commonMistakes: {
                                    "x²": "Don't forget to bring down the 3: d/dx(x³) = 3x²"
                                }
                            },
                            {
                                prompt: "What is g' (derivative of cos(x))?",
                                hint: "This is a standard trig derivative...",
                                answer: "-sin(x)",
                                acceptableAnswers: ["-sin(x)", "-sinx", "-sin x"],
                                commonMistakes: {
                                    "sin(x)": "The derivative of cos(x) is NEGATIVE sin(x)"
                                }
                            },
                            {
                                prompt: "Now apply f'g + fg': 3x²·cos(x) + x³·(-sin(x)) = ?",
                                hint: "Simplify the second term...",
                                answer: "3x²cos(x) - x³sin(x)",
                                acceptableAnswers: ["3x²cos(x) - x³sin(x)", "3x^2cos(x) - x^3sin(x)", "3x²cosx - x³sinx"],
                                commonMistakes: {
                                    "3x²cos(x) + x³sin(x)": "Watch the sign! x³·(-sin(x)) = -x³sin(x), so it's minus."
                                }
                            }
                        ]
                    };
                })(),
                practice: { problem: `Find d/dx of (2x)(ln x)`, answer: "2ln(x) + 2",
                    options: shuffle(["2ln(x) + 2", "2/x", "2ln(x)", "2x/x"]),
                    mistakeAnalysis: {
                        "2/x": "That's only the derivative of 2ln(x). You need product rule: f'g + fg' = 2·ln(x) + 2x·(1/x)",
                        "2ln(x)": "You forgot the second term fg'. Product rule gives 2ln(x) + 2x·(1/x) = 2ln(x) + 2",
                        "2x/x": "This isn't the product rule. f'g + fg' = 2·ln(x) + 2x·(1/x) = 2ln(x) + 2"
                    }}
            };
        },
        "Integration Techniques": () => {
            const a = rand(2, 5);
            const n = rand(2, 4);
            return {
                goalProblem: `Find ∫${a}x^${n} dx`,
                teachingSteps: [
                    {
                        title: "What is Integration?",
                        explanation: "Integration is the <strong>reverse of differentiation</strong>.<br><br>If the derivative of F(x) is f(x), then <strong>∫f(x)dx = F(x) + C</strong><br><br>We're finding the \"anti-derivative\"!",
                        visual: "Integration ↔ Anti-derivative"
                    },
                    {
                        title: "The Power Rule for Integration",
                        explanation: "For any xⁿ (where n ≠ -1):<br><br><strong>∫xⁿ dx = xⁿ⁺¹/(n+1) + C</strong><br><br>\"Add 1 to exponent, divide by new exponent\"",
                        visual: "∫xⁿ dx = xⁿ⁺¹/(n+1) + C"
                    },
                    {
                        title: "Constants Factor Out",
                        explanation: "Constants can be \"pulled out\" of the integral:<br><br><strong>∫${a}x^${n} dx = ${a}∫x^${n} dx</strong><br><br>This makes integration easier!",
                        visual: "∫cf(x)dx = c∫f(x)dx"
                    },
                    {
                        title: "Apply Power Rule",
                        explanation: "∫x^${n} dx = x^${n+1}/${n+1}<br><br>So:<br>${a}∫x^${n} dx = ${a} · x^${n+1}/${n+1}<br><br>= <strong>${a}x^${n+1}/${n+1} + C</strong>",
                        visual: "${a} · x^${n+1}/${n+1} + C"
                    },
                    {
                        title: "Don't Forget +C!",
                        explanation: "The <strong>constant of integration</strong> (+C) is essential!<br><br>Why? Because d/dx(x²) = d/dx(x² + 5) = 2x.<br><br>Many functions have the same derivative, so we add +C to capture all of them.",
                        visual: "Always include + C"
                    }
                ],
                finalAnswer: `${a}x^${n+1}/${n+1} + C`,
                answerExplanation: `Factor out ${a}, apply power rule (add 1 to exponent, divide by new exponent), and don't forget +C!`,
                example: { problem: `Find ∫6x² dx`, steps: [
                    { text: "Factor out constant", math: "6∫x² dx" },
                    { text: "Apply power rule", math: "6 · x³/3" },
                    { text: "Simplify", math: "<strong>2x³ + C</strong>" }
                ]},
                keyPoints: [
                    "Power rule: ∫xⁿdx = xⁿ⁺¹/(n+1) + C (n ≠ -1)",
                    "∫eˣdx = eˣ + C",
                    "∫1/x dx = ln|x| + C",
                    "Always add +C for indefinite integrals!"
                ],
                mistakes: [
                    { wrong: "Forgetting +C", why: "Indefinite integrals always need +C because many functions share the same derivative." },
                    { wrong: "Using derivative rule instead", why: "Integration is the REVERSE. For derivatives, multiply and subtract 1. For integrals, add 1 and divide." }
                ],
                guided: (() => {
                    const coef = rand(3, 6);
                    const power = rand(3, 5);
                    return {
                        problem: `Find ∫${coef}x^${power} dx`,
                        steps: [
                            { label: "Factor out constant", value: `${coef}∫x^${power} dx` },
                            { label: "New exponent", value: `${power} + 1 = ${power + 1}` }
                        ],
                        answer: `${coef}x^${power+1}/${power+1} + C`,
                        answerLabel: "Final answer:",
                        interactiveSteps: [
                            {
                                prompt: `When integrating x^${power}, what is the new exponent?`,
                                hint: "Add 1 to the current exponent...",
                                answer: String(power + 1),
                                acceptableAnswers: [String(power + 1)],
                                commonMistakes: {
                                    [String(power - 1)]: "That's for derivatives. For integration, ADD 1 to the exponent.",
                                    [String(power)]: "The exponent changes! Add 1 for integration."
                                }
                            },
                            {
                                prompt: `∫x^${power} dx = x^${power+1}/? (what do we divide by?)`,
                                hint: "Divide by the new exponent...",
                                answer: String(power + 1),
                                acceptableAnswers: [String(power + 1)],
                                commonMistakes: {
                                    [String(power)]: "Divide by the NEW exponent (${power + 1}), not the old one."
                                }
                            },
                            {
                                prompt: `So ∫${coef}x^${power} dx = ${coef}x^${power+1}/${power+1} + ?`,
                                hint: "Don't forget the constant of integration!",
                                answer: "C",
                                acceptableAnswers: ["C", "+C", "c", "+c"],
                                commonMistakes: {
                                    "0": "Indefinite integrals need +C (constant of integration)"
                                }
                            }
                        ]
                    };
                })(),
                practice: { problem: `Find ∫4x³ dx`, answer: "x⁴ + C",
                    options: shuffle(["x⁴ + C", "12x² + C", "4x⁴ + C", "x⁴/4 + C"]),
                    mistakeAnalysis: {
                        "12x² + C": "That's the derivative! For integration, add 1 to exponent and divide: 4x⁴/4 = x⁴",
                        "4x⁴ + C": "You forgot to divide by the new exponent. 4·x⁴/4 = x⁴",
                        "x⁴/4 + C": "You divided twice! 4x³ → 4x⁴/4 = x⁴, not x⁴/4"
                    }}
            };
        },
        "Differential Equations": () => {
            const k = rand(2, 5);
            return {
                goalProblem: `Solve: dy/dx = ${k}x with y(0) = 3`,
                teachingSteps: [
                    {
                        title: "What is a Differential Equation?",
                        explanation: "A <strong>differential equation</strong> is an equation involving <strong>derivatives</strong>.<br><br>dy/dx = ${k}x tells us the rate of change of y depends on x.<br><br>We want to find the function y(x)!",
                        visual: "dy/dx = rate of change of y with respect to x"
                    },
                    {
                        title: "Strategy: Integrate Both Sides",
                        explanation: "If dy/dx = f(x), then:<br><br><strong>y = ∫f(x) dx</strong><br><br>Integration \"undoes\" the derivative!",
                        visual: "dy/dx = ${k}x → y = ∫${k}x dx"
                    },
                    {
                        title: "Step 1: Integrate",
                        explanation: "y = ∫${k}x dx<br><br>Using power rule: ∫${k}x dx = ${k}x²/2 + C<br><br>= <strong>${k/2}x² + C</strong> (if ${k} is even) or <strong>${k}x²/2 + C</strong>",
                        visual: "y = ${k}x²/2 + C"
                    },
                    {
                        title: "Step 2: Use Initial Condition",
                        explanation: "We're told y(0) = 3 (when x=0, y=3).<br><br>Substitute: 3 = ${k}(0)²/2 + C<br>3 = 0 + C<br><strong>C = 3</strong>",
                        visual: "y(0) = 3 → C = 3"
                    },
                    {
                        title: "Final Solution",
                        explanation: "Substituting C = 3 back:<br><br><strong>y = ${k}x²/2 + 3</strong>",
                        visual: "y = ${k}x²/2 + 3"
                    }
                ],
                finalAnswer: `y = ${k}x²/2 + 3`,
                answerExplanation: `Integrate dy/dx = ${k}x to get y = ${k}x²/2 + C, then use y(0) = 3 to find C = 3.`,
                example: { problem: `Solve: dy/dx = 2x, y(0) = 5`, steps: [
                    { text: "Integrate both sides", math: "y = ∫2x dx = x² + C" },
                    { text: "Apply initial condition y(0) = 5", math: "5 = 0² + C → C = 5" },
                    { text: "Final solution", math: "<strong>y = x² + 5</strong>" }
                ]},
                keyPoints: [
                    "Differential equation: equation with derivatives",
                    "Solve by integrating both sides",
                    "Initial conditions (like y(0) = 3) help find the constant C",
                    "The solution is a function, not just a number!"
                ],
                mistakes: [
                    { wrong: "Forgetting the constant C", why: "Without +C, you only get ONE solution. The initial condition pins down the specific C." },
                    { wrong: "Not using the initial condition", why: "The initial condition y(0) = 3 is essential to find the specific value of C." }
                ],
                guided: (() => {
                    const coef = rand(2, 4);
                    const initVal = rand(1, 5);
                    return {
                        problem: `Solve: dy/dx = ${coef}, y(0) = ${initVal}`,
                        steps: [
                            { label: "This is a constant rate of change", value: "y changes by ${coef} for every 1 unit of x" },
                            { label: "Integrate", value: `y = ∫${coef} dx = ${coef}x + C` }
                        ],
                        answer: `y = ${coef}x + ${initVal}`,
                        answerLabel: "Solution:",
                        interactiveSteps: [
                            {
                                prompt: `What is ∫${coef} dx?`,
                                hint: "The integral of a constant k is kx + C",
                                answer: `${coef}x + C`,
                                acceptableAnswers: [`${coef}x + C`, `${coef}x+C`, `${coef}x + c`],
                                commonMistakes: {
                                    [`${coef}`]: "Don't forget to integrate! ∫${coef}dx = ${coef}x + C"
                                }
                            },
                            {
                                prompt: `If y = ${coef}x + C and y(0) = ${initVal}, what is C?`,
                                hint: "Substitute x = 0: ${initVal} = ${coef}(0) + C",
                                answer: String(initVal),
                                acceptableAnswers: [String(initVal)],
                                commonMistakes: {
                                    "0": "When x = 0: ${initVal} = 0 + C, so C = ${initVal}"
                                }
                            },
                            {
                                prompt: `So the final solution y = ?`,
                                hint: "Substitute your value of C back into y = ${coef}x + C",
                                answer: `${coef}x + ${initVal}`,
                                acceptableAnswers: [`${coef}x + ${initVal}`, `y = ${coef}x + ${initVal}`],
                                commonMistakes: {
                                    [`${coef}x`]: "Don't forget +C! The solution is y = ${coef}x + ${initVal}"
                                }
                            }
                        ]
                    };
                })(),
                practice: { problem: `Solve: dy/dx = 6x, y(0) = 2`, answer: "y = 3x² + 2",
                    options: shuffle(["y = 3x² + 2", "y = 6x² + 2", "y = 3x²", "y = 6x + 2"]),
                    mistakeAnalysis: {
                        "y = 6x² + 2": "Remember to divide by the new exponent: 6x²/2 = 3x²",
                        "y = 3x²": "You found the integral but forgot to use y(0) = 2 to find C = 2",
                        "y = 6x + 2": "You need to integrate! ∫6x dx = 6x²/2 = 3x², not 6x"
                    }}
            };
        },
        "Limits": () => {
            const a = rand(1, 4);
            const b = rand(1, 3);
            return {
                goalProblem: `Find lim(x→${a}) (x² - ${a*a})/(x - ${a})`,
                teachingSteps: [
                    {
                        title: "What is a Limit?",
                        explanation: "A <strong>limit</strong> describes what value a function <strong>approaches</strong> as x gets closer to some number.<br><br>lim(x→${a}) f(x) means: \"What does f(x) approach as x gets closer and closer to ${a}?\"",
                        visual: "lim(x→a) f(x) = L means f(x) → L as x → a"
                    },
                    {
                        title: "First Try: Direct Substitution",
                        explanation: "Try plugging in x = ${a}:<br><br>(${a}² - ${a*a})/(${a} - ${a}) = (${a*a} - ${a*a})/(0) = <strong>0/0</strong><br><br>This is an <strong>indeterminate form</strong>! We need another approach.",
                        visual: "0/0 = indeterminate (need more work)"
                    },
                    {
                        title: "Factor and Simplify",
                        explanation: "Notice x² - ${a*a} is a <strong>difference of squares</strong>:<br><br>x² - ${a*a} = (x - ${a})(x + ${a})<br><br>So our expression becomes:<br>(x - ${a})(x + ${a})/(x - ${a})",
                        visual: "x² - ${a}² = (x - ${a})(x + ${a})"
                    },
                    {
                        title: "Cancel Common Factors",
                        explanation: "The (x - ${a}) terms cancel!<br><br>(x - ${a})(x + ${a})/(x - ${a}) = <strong>x + ${a}</strong><br><br>This is valid because we're looking at x <em>approaching</em> ${a}, not x = ${a}.",
                        visual: "After canceling: x + ${a}"
                    },
                    {
                        title: "Now Substitute",
                        explanation: "lim(x→${a}) (x + ${a}) = ${a} + ${a} = <strong>${a + a}</strong>",
                        visual: "lim(x→${a}) (x + ${a}) = ${a*2}"
                    }
                ],
                finalAnswer: String(a * 2),
                answerExplanation: `Factor x² - ${a*a} = (x-${a})(x+${a}), cancel with denominator, then substitute x = ${a} into x + ${a} to get ${a*2}.`,
                example: { problem: `Find lim(x→3) (x² - 9)/(x - 3)`, steps: [
                    { text: "Direct substitution gives 0/0", math: "(9-9)/(3-3) = 0/0" },
                    { text: "Factor numerator", math: "x² - 9 = (x-3)(x+3)" },
                    { text: "Cancel (x-3)", math: "(x-3)(x+3)/(x-3) = x+3" },
                    { text: "Substitute", math: "<strong>lim = 3 + 3 = 6</strong>" }
                ]},
                keyPoints: [
                    "0/0 is indeterminate - need to simplify first",
                    "Factor, cancel, then substitute",
                    "Limits describe approaching behavior, not the actual value at the point",
                    "L'Hôpital's Rule: If 0/0, can take derivative of top and bottom"
                ],
                mistakes: [
                    { wrong: "Saying the limit doesn't exist because of 0/0", why: "0/0 means you need to do more work! Factor and simplify first." },
                    { wrong: "Canceling before factoring", why: "You must factor the expression before you can cancel common terms." }
                ],
                guided: (() => {
                    const c = rand(2, 5);
                    return {
                        problem: `Find lim(x→${c}) (x² - ${c*c})/(x - ${c})`,
                        steps: [
                            { label: "Factor numerator", value: `x² - ${c*c} = (x - ${c})(x + ${c})` },
                            { label: "Cancel", value: `(x - ${c})(x + ${c})/(x - ${c}) = x + ${c}` }
                        ],
                        answer: String(c * 2),
                        answerLabel: "The limit equals:",
                        interactiveSteps: [
                            {
                                prompt: `What do you get if you plug x = ${c} directly into the expression?`,
                                hint: "Calculate (${c}² - ${c*c})/(${c} - ${c})...",
                                answer: "0/0",
                                acceptableAnswers: ["0/0", "indeterminate", "undefined"],
                                commonMistakes: {
                                    "0": "The denominator is also 0! You get 0/0, which is indeterminate.",
                                    [String(c*2)]: "Direct substitution gives 0/0. We need to factor first."
                                }
                            },
                            {
                                prompt: `Factor x² - ${c*c} using difference of squares: x² - a² = (x-a)(x+a)`,
                                hint: "a² = ${c*c}, so a = ${c}...",
                                answer: `(x - ${c})(x + ${c})`,
                                acceptableAnswers: [`(x - ${c})(x + ${c})`, `(x-${c})(x+${c})`, `(x+${c})(x-${c})`],
                                commonMistakes: {
                                    [`(x - ${c})²`]: "That's (x-${c})(x-${c}). Difference of squares gives (x-${c})(x+${c})"
                                }
                            },
                            {
                                prompt: "After canceling (x - ${c}), what expression remains?",
                                hint: "The (x - ${c}) in numerator and denominator cancel...",
                                answer: `x + ${c}`,
                                acceptableAnswers: [`x + ${c}`, `x+${c}`, `${c} + x`],
                                commonMistakes: {
                                    [`x - ${c}`]: "You canceled the wrong factor! (x+${c}) remains."
                                }
                            },
                            {
                                prompt: `Now find lim(x→${c}) (x + ${c}) = ?`,
                                hint: "Now you can substitute x = ${c}...",
                                answer: String(c * 2),
                                acceptableAnswers: [String(c * 2)],
                                commonMistakes: {
                                    [String(c)]: "Add ${c} + ${c} = ${c*2}, not just ${c}"
                                }
                            }
                        ]
                    };
                })(),
                practice: { problem: `Find lim(x→2) (x² - 4)/(x - 2)`, answer: "4",
                    options: shuffle(["4", "0", "2", "undefined"]),
                    mistakeAnalysis: {
                        "0": "0/0 is indeterminate, not 0. Factor: (x-2)(x+2)/(x-2) = x+2, then plug in x=2 to get 4",
                        "2": "After factoring and canceling, you get x+2. When x=2: 2+2=4",
                        "undefined": "The limit exists! Factor (x²-4)=(x-2)(x+2), cancel, then substitute to get 4"
                    }}
            };
        }
    },
    10: {
        Matrices: () => ({
            goalProblem: `Add: [1 2] + [5 6]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[3 4] &nbsp;&nbsp; [7 8]`,
            teachingSteps: [
                {
                    title: "What is a Matrix?",
                    explanation: "A <strong>matrix</strong> is a rectangular grid of numbers arranged in <strong>rows</strong> (horizontal) and <strong>columns</strong> (vertical).<br><br>Think of it like a spreadsheet or table of numbers!",
                    visual: "Matrix = Grid of numbers in rows and columns"
                },
                {
                    title: "Matrix Dimensions",
                    explanation: "We describe matrix size as <strong>m × n</strong>:<br><br>• <strong>m</strong> = number of rows<br>• <strong>n</strong> = number of columns<br><br>A 2×3 matrix has 2 rows and 3 columns.",
                    visual: "m × n = rows × columns"
                },
                {
                    title: "Matrix Addition",
                    explanation: "To add matrices:<br><br>• They <strong>MUST be the same size</strong><br>• Add <strong>corresponding elements</strong> (same position)<br><br>Just add each cell to the cell in the same position!",
                    visual: "[a b] + [e f] = [a+e  b+f]"
                },
                {
                    title: "Our Problem",
                    explanation: "We're adding two 2×2 matrices:<br><br>[1 2] + [5 6]<br>[3 4] &nbsp;&nbsp; [7 8]<br><br>Both are 2×2, so we can add them!",
                    visual: "Both 2×2 → Addition is possible"
                },
                {
                    title: "Step 1: Add First Row Elements",
                    explanation: "Top-left: 1 + 5 = <strong>6</strong><br>Top-right: 2 + 6 = <strong>8</strong><br><br>First row of result: [6  8]",
                    visual: "Row 1: [1+5, 2+6] = [6, 8]"
                },
                {
                    title: "Step 2: Add Second Row Elements",
                    explanation: "Bottom-left: 3 + 7 = <strong>10</strong><br>Bottom-right: 4 + 8 = <strong>12</strong><br><br>Second row of result: [10  12]",
                    visual: "Row 2: [3+7, 4+8] = [10, 12]"
                },
                {
                    title: "Final Result",
                    explanation: "Putting it together:<br><br>[6 &nbsp;&nbsp;8]<br>[10 12]",
                    visual: "Result: [6 8; 10 12]"
                }
            ],
            finalAnswer: "[6 8; 10 12]",
            answerExplanation: "We added corresponding elements: top row (1+5, 2+6) = (6, 8), bottom row (3+7, 4+8) = (10, 12).",
            example: { problem: `Add: [1 2] + [5 6]\n      [3 4]   [7 8]`, steps: [
                { text: "Add corresponding elements", math: "[1+5  2+6] = [6  8]" },
                { text: "Continue for second row", math: "[3+7  4+8] = [10 12]" },
                { text: "Result", math: "<strong>[6 8; 10 12]</strong>" }
            ]},
            keyPoints: [
                "Matrix addition requires SAME dimensions",
                "For multiplication AB: columns of A must equal rows of B",
                "Matrix multiplication is NOT commutative: AB ≠ BA"
            ],
            mistakes: [
                { wrong: "Adding matrices of different sizes", why: "Matrices must be the same size to add them." },
                { wrong: "Thinking AB = BA", why: "Matrix multiplication is NOT commutative. Order matters!" }
            ],
            guided: { problem: `Multiply: 3 × [2 4]\n            [1 5]`, steps: [
                { label: "Multiply each element by 3", value: "[3·2  3·4] = [6 12]" },
                { label: "Second row", value: "[3·1  3·5] = ?" }
            ], answer: "[3 15]", answerLabel: "Second row:",
                interactiveSteps: [
                    {
                        prompt: "When multiplying a matrix by a scalar (single number), what do we do to each element?",
                        hint: "Scalar multiplication distributes to every element...",
                        answer: "multiply each element by the scalar",
                        acceptableAnswers: ["multiply each element by the scalar", "multiply each element", "multiply each by 3", "multiply all by 3"],
                        commonMistakes: {
                            "add 3": "Scalar MULTIPLICATION means multiply each element by the scalar."
                        }
                    },
                    {
                        prompt: "First row: 3 × 2 = ?",
                        hint: "3 times 2...",
                        answer: "6",
                        acceptableAnswers: ["6"],
                        commonMistakes: {
                            "5": "Add? No, multiply! 3 × 2 = 6"
                        }
                    },
                    {
                        prompt: "First row: 3 × 4 = ?",
                        hint: "3 times 4...",
                        answer: "12",
                        acceptableAnswers: ["12"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "Second row: 3 × 1 = ?",
                        hint: "3 times 1...",
                        answer: "3",
                        acceptableAnswers: ["3"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "Second row: 3 × 5 = ?",
                        hint: "3 times 5...",
                        answer: "15",
                        acceptableAnswers: ["15"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "So the second row of the result is [? ?]",
                        hint: "We got 3 × 1 = 3 and 3 × 5 = 15...",
                        answer: "[3 15]",
                        acceptableAnswers: ["[3 15]", "[3, 15]", "3 15", "3, 15"],
                        commonMistakes: {
                            "[6 12]": "That's the first row! Second row is [3 15]"
                        }
                    }
                ]
            },
            practice: { problem: `What are the dimensions of a matrix with 3 rows and 2 columns?`, answer: "3 × 2",
                options: ["3 × 2", "2 × 3", "6", "5"],
                mistakeAnalysis: {
                    "2 × 3": "Rows come FIRST: 3 rows × 2 columns = 3 × 2",
                    "6": "That's the total number of elements. Dimensions are written as rows × columns.",
                    "5": "That's 3 + 2. Dimensions are 3 × 2 (rows × columns)."
                }}
        }),
        Series: () => ({
            goalProblem: `Find the sum: 1 + 2 + 3 + ... + 100`,
            teachingSteps: [
                {
                    title: "What is a Series?",
                    explanation: "A <strong>series</strong> is the <strong>sum</strong> of the terms in a sequence.<br><br>Sequence: 1, 2, 3, 4, 5<br>Series: 1 + 2 + 3 + 4 + 5 = 15",
                    visual: "Series = Sum of a sequence"
                },
                {
                    title: "Two Types of Series",
                    explanation: "<strong>Arithmetic Series:</strong> constant DIFFERENCE between terms<br>Example: 2, 5, 8, 11 (adding 3 each time)<br><br><strong>Geometric Series:</strong> constant RATIO between terms<br>Example: 2, 6, 18, 54 (multiplying by 3 each time)",
                    visual: "Arithmetic: +d each time | Geometric: ×r each time"
                },
                {
                    title: "Arithmetic Series Formula",
                    explanation: "For an arithmetic series:<br><br><strong>Sum = (n/2) × (first + last)</strong><br><br>Where n = number of terms<br><br>This formula is super fast for long series!",
                    visual: "Sum = (n/2)(first + last)"
                },
                {
                    title: "Our Problem: 1 + 2 + 3 + ... + 100",
                    explanation: "This is arithmetic (adding 1 each time).<br><br>• First term: <strong>1</strong><br>• Last term: <strong>100</strong><br>• Number of terms (n): <strong>100</strong>",
                    visual: "First = 1, Last = 100, n = 100"
                },
                {
                    title: "Step 1: Set Up the Formula",
                    explanation: "Sum = (n/2) × (first + last)<br><br>Sum = (100/2) × (1 + 100)",
                    visual: "Sum = (100/2) × (1 + 100)"
                },
                {
                    title: "Step 2: Simplify",
                    explanation: "Sum = 50 × 101<br><br>(100 ÷ 2 = 50, and 1 + 100 = 101)",
                    visual: "50 × 101"
                },
                {
                    title: "Step 3: Calculate",
                    explanation: "50 × 101 = <strong>5050</strong><br><br>So the sum of all numbers from 1 to 100 is 5050!<br><br>(This is called a \"triangular number\")",
                    visual: "50 × 101 = 5050"
                }
            ],
            finalAnswer: "5050",
            answerExplanation: "Using the formula (n/2)(first + last) = (100/2)(1 + 100) = 50 × 101 = 5050.",
            example: { problem: `Find the sum: 1 + 2 + 3 + ... + 100`, steps: [
                { text: "This is an arithmetic series", math: "First = 1, Last = 100, n = 100 terms" },
                { text: "Use the formula", math: "Sum = n/2 × (first + last)" },
                { text: "Calculate", math: "Sum = 100/2 × (1 + 100) = 50 × 101" },
                { text: "Result", math: "<strong>5050</strong>" }
            ]},
            keyPoints: [
                "Arithmetic: constant difference between terms",
                "Geometric: constant RATIO between terms",
                "Infinite geometric series converge only if |r| < 1"
            ],
            mistakes: [
                { wrong: "Using geometric formula for arithmetic series", why: "Check the pattern: +d (arithmetic) or ×r (geometric)?" },
                { wrong: "Forgetting that infinite series need |r| < 1", why: "If |r| ≥ 1, the series diverges (sum is infinite)." }
            ],
            guided: { problem: `Sum the arithmetic series: 2 + 4 + 6 + 8 + 10`, steps: [
                { label: "Number of terms", value: "5" },
                { label: "First = 2, Last = 10", value: "Sum = 5/2 × (2 + 10)" },
                { label: "Calculate", value: "?" }
            ], answer: "30", answerLabel: "Sum = ?",
                interactiveSteps: [
                    {
                        prompt: "What type of series is 2 + 4 + 6 + 8 + 10? (constant difference or constant ratio)",
                        hint: "Each term is +2 from the previous...",
                        answer: "arithmetic",
                        acceptableAnswers: ["arithmetic", "constant difference", "arithmetic series"],
                        commonMistakes: {
                            "geometric": "Geometric has constant ratio. This has constant difference (+2), so it's arithmetic."
                        }
                    },
                    {
                        prompt: "How many terms are in this series?",
                        hint: "Count them: 2, 4, 6, 8, 10...",
                        answer: "5",
                        acceptableAnswers: ["5", "five"],
                        commonMistakes: {
                            "10": "10 is the last term, not the count. There are 5 terms."
                        }
                    },
                    {
                        prompt: "What is the first term?",
                        hint: "The series starts with...",
                        answer: "2",
                        acceptableAnswers: ["2"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "What is the last term?",
                        hint: "The series ends with...",
                        answer: "10",
                        acceptableAnswers: ["10"],
                        commonMistakes: {}
                    },
                    {
                        prompt: "The arithmetic series formula is Sum = (n/2) × (first + last). Calculate: (5/2) × (2 + 10) = ?",
                        hint: "5/2 = 2.5, and 2 + 10 = 12. What is 2.5 × 12?",
                        answer: "30",
                        acceptableAnswers: ["30"],
                        commonMistakes: {
                            "12": "12 is first + last. You still need to multiply by n/2 = 2.5. 2.5 × 12 = 30",
                            "60": "You used n instead of n/2. Sum = (5/2) × 12 = 2.5 × 12 = 30"
                        }
                    }
                ]
            },
            practice: { problem: `For the geometric series 1 + 1/2 + 1/4 + 1/8 + ..., what does the infinite sum approach?`, answer: "2",
                options: ["1", "2", "∞", "1.5"],
                mistakeAnalysis: {
                    "1": "Sum = a₁/(1-r) = 1/(1-0.5) = 1/0.5 = 2",
                    "∞": "Since |r| = 0.5 < 1, this series CONVERGES to 2",
                    "1.5": "Sum = 1/(1-0.5) = 1/0.5 = 2"
                }}
        }),
        "Partial Derivatives": () => {
            const a = rand(2, 5);
            const b = rand(2, 4);
            return {
                goalProblem: `Find ∂/∂x of f(x,y) = ${a}x²y + ${b}xy²`,
                teachingSteps: [
                    {
                        title: "What are Partial Derivatives?",
                        explanation: "When a function has <strong>multiple variables</strong> (like x AND y), we can differentiate with respect to <strong>one variable at a time</strong>.<br><br>∂/∂x means: differentiate with respect to x, <strong>treating y as a constant</strong>.",
                        visual: "∂/∂x: treat y as constant, differentiate normally for x"
                    },
                    {
                        title: "The ∂ Symbol",
                        explanation: "We use <strong>∂</strong> (\"partial\") instead of d to show it's a <strong>partial derivative</strong>.<br><br>∂f/∂x = \"the partial derivative of f with respect to x\"<br>∂f/∂y = \"the partial derivative of f with respect to y\"",
                        visual: "∂ = partial derivative symbol"
                    },
                    {
                        title: "Our Function",
                        explanation: "f(x,y) = ${a}x²y + ${b}xy²<br><br>We need ∂/∂x, so we treat <strong>y as a constant</strong>.",
                        visual: "f(x,y) = ${a}x²y + ${b}xy² — find ∂f/∂x"
                    },
                    {
                        title: "Step 1: First Term",
                        explanation: "${a}x²y — treating y as constant:<br><br>∂/∂x(${a}x²y) = ${a}y · ∂/∂x(x²) = ${a}y · 2x = <strong>${a*2}xy</strong>",
                        visual: "∂/∂x(${a}x²y) = ${a*2}xy"
                    },
                    {
                        title: "Step 2: Second Term",
                        explanation: "${b}xy² — treating y² as constant:<br><br>∂/∂x(${b}xy²) = ${b}y² · ∂/∂x(x) = ${b}y² · 1 = <strong>${b}y²</strong>",
                        visual: "∂/∂x(${b}xy²) = ${b}y²"
                    },
                    {
                        title: "Final Answer",
                        explanation: "Combining both terms:<br><br>∂f/∂x = <strong>${a*2}xy + ${b}y²</strong>",
                        visual: "∂f/∂x = ${a*2}xy + ${b}y²"
                    }
                ],
                finalAnswer: `${a*2}xy + ${b}y²`,
                answerExplanation: `Treating y as constant: ∂/∂x(${a}x²y) = ${a*2}xy (power rule on x²), and ∂/∂x(${b}xy²) = ${b}y² (y² is constant, x becomes 1).`,
                example: { problem: `Find ∂/∂y of f(x,y) = 3x²y + 2xy²`, steps: [
                    { text: "Treat x as constant", math: "∂/∂y(3x²y) = 3x² · 1 = 3x²" },
                    { text: "Second term", math: "∂/∂y(2xy²) = 2x · 2y = 4xy" },
                    { text: "Combine", math: "<strong>∂f/∂y = 3x² + 4xy</strong>" }
                ]},
                keyPoints: [
                    "∂/∂x: treat all other variables as constants",
                    "∂/∂y: treat x as constant, differentiate normally for y",
                    "Use regular differentiation rules (power rule, etc.)"
                ],
                mistakes: [
                    { wrong: "Differentiating both variables at once", why: "For ∂/∂x, ONLY x changes. Treat y as if it were a number like 5." },
                    { wrong: "Forgetting constants from other variables", why: "When y is constant in ${a}x²y, keep the y! Result is ${a*2}xy, not ${a*2}x." }
                ],
                guided: (() => {
                    const c1 = rand(2, 4);
                    const c2 = rand(2, 3);
                    return {
                        problem: `Find ∂/∂y of f(x,y) = ${c1}x²y + ${c2}xy³`,
                        steps: [
                            { label: "Treat x as constant", value: "x is just a number" },
                            { label: "First term", value: `∂/∂y(${c1}x²y) = ${c1}x²` }
                        ],
                        answer: `${c1}x² + ${c2*3}xy²`,
                        answerLabel: "∂f/∂y =",
                        interactiveSteps: [
                            {
                                prompt: `When finding ∂/∂y, what do we treat as a constant?`,
                                hint: "We're differentiating with respect to y...",
                                answer: "x",
                                acceptableAnswers: ["x", "x values", "the x variable"],
                                commonMistakes: {
                                    "y": "No! We're differentiating WITH RESPECT TO y. We treat x as constant."
                                }
                            },
                            {
                                prompt: `Find ∂/∂y of ${c1}x²y (x² is constant)`,
                                hint: "∂/∂y of (constant × y) = constant × 1 = constant",
                                answer: `${c1}x²`,
                                acceptableAnswers: [`${c1}x²`, `${c1}x^2`],
                                commonMistakes: {
                                    [`${c1*2}xy`]: "That's ∂/∂x! For ∂/∂y, x² is constant, so ∂/∂y(${c1}x²y) = ${c1}x²"
                                }
                            },
                            {
                                prompt: `Find ∂/∂y of ${c2}xy³ (x is constant)`,
                                hint: "Use power rule on y³: bring down 3, reduce exponent by 1",
                                answer: `${c2*3}xy²`,
                                acceptableAnswers: [`${c2*3}xy²`, `${c2*3}xy^2`],
                                commonMistakes: {
                                    [`${c2}y³`]: "Don't forget the coefficient! ${c2}x · 3y² = ${c2*3}xy²"
                                }
                            },
                            {
                                prompt: `Combine: ∂f/∂y = ${c1}x² + ?`,
                                hint: "Add the second partial derivative...",
                                answer: `${c2*3}xy²`,
                                acceptableAnswers: [`${c2*3}xy²`, `${c2*3}xy^2`],
                                commonMistakes: {}
                            }
                        ]
                    };
                })(),
                practice: { problem: `Find ∂/∂x of f(x,y) = 5xy + 3x²`, answer: "5y + 6x",
                    options: shuffle(["5y + 6x", "5x + 6x", "5 + 6x", "5xy + 6x"]),
                    mistakeAnalysis: {
                        "5x + 6x": "For ∂/∂x(5xy), y is constant, so it's 5y, not 5x",
                        "5 + 6x": "Keep the y! ∂/∂x(5xy) = 5y (y is treated as constant)",
                        "5xy + 6x": "You need to differentiate! ∂/∂x(5xy) = 5y, ∂/∂x(3x²) = 6x"
                    }}
            };
        },
        "Discrete Math": () => {
            const n = rand(5, 8);
            const r = rand(2, 3);
            const factorial = (num) => num <= 1 ? 1 : num * factorial(num - 1);
            const C = factorial(n) / (factorial(r) * factorial(n - r));
            return {
                goalProblem: `How many ways can you choose ${r} items from ${n} items? (Order doesn't matter)`,
                teachingSteps: [
                    {
                        title: "What is Discrete Math?",
                        explanation: "<strong>Discrete math</strong> deals with countable, distinct objects.<br><br>Key topics: counting, combinations, permutations, logic, graph theory, sets.",
                        visual: "Discrete = separate, countable things"
                    },
                    {
                        title: "Combinations vs Permutations",
                        explanation: "<strong>Permutation:</strong> Order MATTERS (arrangements)<br>\"How many ways to arrange ABC?\" → 6 ways<br><br><strong>Combination:</strong> Order DOESN'T matter (selections)<br>\"How many ways to choose 2 from ABC?\" → 3 ways (AB, AC, BC)",
                        visual: "Permutation = Order matters | Combination = Order doesn't matter"
                    },
                    {
                        title: "The Combination Formula",
                        explanation: "C(n,r) = <strong>n! / (r! × (n-r)!)</strong><br><br>Where:<br>• n = total items<br>• r = items to choose<br>• n! = n factorial = n × (n-1) × ... × 1",
                        visual: "C(n,r) = n! / (r!(n-r)!)"
                    },
                    {
                        title: "Our Problem",
                        explanation: "Choose ${r} from ${n} items (order doesn't matter).<br><br>n = ${n}, r = ${r}<br><br>C(${n},${r}) = ${n}! / (${r}! × ${n-r}!)",
                        visual: "C(${n},${r}) = ${n}! / (${r}! × ${n-r}!)"
                    },
                    {
                        title: "Calculate Factorials",
                        explanation: "${n}! = ${factorial(n)}<br>${r}! = ${factorial(r)}<br>${n-r}! = ${factorial(n-r)}<br><br>C(${n},${r}) = ${factorial(n)} / (${factorial(r)} × ${factorial(n-r)})",
                        visual: "${factorial(n)} / (${factorial(r)} × ${factorial(n-r)})"
                    },
                    {
                        title: "Final Calculation",
                        explanation: "C(${n},${r}) = ${factorial(n)} / ${factorial(r) * factorial(n-r)} = <strong>${C}</strong><br><br>There are ${C} ways to choose ${r} items from ${n}.",
                        visual: "C(${n},${r}) = ${C}"
                    }
                ],
                finalAnswer: String(C),
                answerExplanation: `Using the combination formula: C(${n},${r}) = ${n}!/(${r}!×${n-r}!) = ${factorial(n)}/(${factorial(r)}×${factorial(n-r)}) = ${C}`,
                example: { problem: `How many ways to choose 2 from 5 items?`, steps: [
                    { text: "Use combination (order doesn't matter)", math: "C(5,2) = 5! / (2! × 3!)" },
                    { text: "Calculate", math: "120 / (2 × 6) = 120/12" },
                    { text: "Result", math: "<strong>10 ways</strong>" }
                ]},
                keyPoints: [
                    "Combination: order doesn't matter → C(n,r) = n!/(r!(n-r)!)",
                    "Permutation: order matters → P(n,r) = n!/(n-r)!",
                    "n! = n × (n-1) × (n-2) × ... × 1"
                ],
                mistakes: [
                    { wrong: "Using permutation when order doesn't matter", why: "If order doesn't matter, use COMBINATION (divide by r! to remove duplicate arrangements)." },
                    { wrong: "Forgetting to divide by (n-r)!", why: "The formula needs BOTH r! and (n-r)! in the denominator." }
                ],
                guided: (() => {
                    const items = rand(4, 6);
                    const choose = 2;
                    const result = factorial(items) / (factorial(choose) * factorial(items - choose));
                    return {
                        problem: `How many ways to choose ${choose} pizza toppings from ${items} options?`,
                        steps: [
                            { label: "This is a combination (order doesn't matter)", value: `C(${items},${choose})` },
                            { label: "Formula", value: `${items}! / (${choose}! × ${items-choose}!)` }
                        ],
                        answer: String(result),
                        answerLabel: "Number of ways:",
                        interactiveSteps: [
                            {
                                prompt: "Does the order of pizza toppings matter? (yes/no)",
                                hint: "Is pepperoni-and-mushroom different from mushroom-and-pepperoni?",
                                answer: "no",
                                acceptableAnswers: ["no", "n", "nope", "doesn't matter"],
                                commonMistakes: {
                                    "yes": "Order doesn't matter for toppings! Pepperoni+Mushroom = Mushroom+Pepperoni"
                                }
                            },
                            {
                                prompt: "Since order doesn't matter, do we use permutation or combination?",
                                hint: "Permutation = order matters, Combination = order doesn't matter",
                                answer: "combination",
                                acceptableAnswers: ["combination", "combinations", "C"],
                                commonMistakes: {
                                    "permutation": "Permutation is when order MATTERS. Since topping order doesn't matter, use combination."
                                }
                            },
                            {
                                prompt: `What is ${items}! (${items} factorial)?`,
                                hint: `${items}! = ${items} × ${items-1} × ${items-2} × ...`,
                                answer: String(factorial(items)),
                                acceptableAnswers: [String(factorial(items))],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Calculate C(${items},${choose}) = ${factorial(items)} / (${factorial(choose)} × ${factorial(items-choose)}) = ?`,
                                hint: `${factorial(choose)} × ${factorial(items-choose)} = ${factorial(choose) * factorial(items-choose)}. Then divide...`,
                                answer: String(result),
                                acceptableAnswers: [String(result)],
                                commonMistakes: {}
                            }
                        ]
                    };
                })(),
                practice: { problem: `What is 5! (5 factorial)?`, answer: "120",
                    options: shuffle(["120", "25", "15", "5"]),
                    mistakeAnalysis: {
                        "25": "That's 5². Factorial means 5! = 5×4×3×2×1 = 120",
                        "15": "That's 5+4+3+2+1. Factorial MULTIPLIES: 5! = 5×4×3×2×1 = 120",
                        "5": "Factorial means multiply all integers down to 1: 5! = 5×4×3×2×1 = 120"
                    }}
            };
        },
        "Multivariable Calculus": () => {
            const a = rand(2, 4);
            const b = rand(2, 3);
            return {
                goalProblem: `Find the gradient ∇f of f(x,y) = ${a}x² + ${b}y²`,
                teachingSteps: [
                    {
                        title: "What is Multivariable Calculus?",
                        explanation: "Multivariable calculus extends calculus to functions of <strong>multiple variables</strong>.<br><br>Instead of f(x), we work with f(x,y), f(x,y,z), etc.",
                        visual: "f(x) → f(x,y) → f(x,y,z)"
                    },
                    {
                        title: "What is the Gradient?",
                        explanation: "The <strong>gradient</strong> (∇f or \"del f\") is a vector of all partial derivatives:<br><br>∇f = ⟨∂f/∂x, ∂f/∂y⟩<br><br>It points in the direction of <strong>steepest increase</strong>!",
                        visual: "∇f = ⟨∂f/∂x, ∂f/∂y⟩"
                    },
                    {
                        title: "Our Function",
                        explanation: "f(x,y) = ${a}x² + ${b}y²<br><br>We need both partial derivatives to form the gradient.",
                        visual: "f(x,y) = ${a}x² + ${b}y²"
                    },
                    {
                        title: "Step 1: Find ∂f/∂x",
                        explanation: "Differentiate with respect to x (treat y as constant):<br><br>∂f/∂x = ∂/∂x(${a}x²) + ∂/∂x(${b}y²)<br>= ${a*2}x + 0 = <strong>${a*2}x</strong>",
                        visual: "∂f/∂x = ${a*2}x"
                    },
                    {
                        title: "Step 2: Find ∂f/∂y",
                        explanation: "Differentiate with respect to y (treat x as constant):<br><br>∂f/∂y = ∂/∂y(${a}x²) + ∂/∂y(${b}y²)<br>= 0 + ${b*2}y = <strong>${b*2}y</strong>",
                        visual: "∂f/∂y = ${b*2}y"
                    },
                    {
                        title: "Form the Gradient",
                        explanation: "∇f = ⟨∂f/∂x, ∂f/∂y⟩ = <strong>⟨${a*2}x, ${b*2}y⟩</strong><br><br>This vector tells us the direction and rate of steepest increase at any point (x,y).",
                        visual: "∇f = ⟨${a*2}x, ${b*2}y⟩"
                    }
                ],
                finalAnswer: `⟨${a*2}x, ${b*2}y⟩`,
                answerExplanation: `The gradient is the vector of partial derivatives: ∂f/∂x = ${a*2}x and ∂f/∂y = ${b*2}y, so ∇f = ⟨${a*2}x, ${b*2}y⟩.`,
                example: { problem: `Find ∇f for f(x,y) = x² + 4xy`, steps: [
                    { text: "Find ∂f/∂x", math: "∂f/∂x = 2x + 4y" },
                    { text: "Find ∂f/∂y", math: "∂f/∂y = 0 + 4x = 4x" },
                    { text: "Form gradient", math: "<strong>∇f = ⟨2x + 4y, 4x⟩</strong>" }
                ]},
                keyPoints: [
                    "Gradient ∇f = ⟨∂f/∂x, ∂f/∂y⟩ (vector of partial derivatives)",
                    "Gradient points toward steepest increase",
                    "Magnitude |∇f| gives rate of steepest increase"
                ],
                mistakes: [
                    { wrong: "Writing gradient as a single value", why: "The gradient is a VECTOR, not a scalar. It has multiple components." },
                    { wrong: "Mixing up partial derivatives", why: "∂f/∂x only differentiates x terms. ∂f/∂y only differentiates y terms." }
                ],
                guided: (() => {
                    const c1 = rand(1, 3);
                    const c2 = rand(2, 4);
                    return {
                        problem: `Find the gradient of f(x,y) = ${c1}x³ + ${c2}y²`,
                        steps: [
                            { label: "Find ∂f/∂x", value: `${c1*3}x²` },
                            { label: "Find ∂f/∂y", value: `${c2*2}y` }
                        ],
                        answer: `⟨${c1*3}x², ${c2*2}y⟩`,
                        answerLabel: "∇f =",
                        interactiveSteps: [
                            {
                                prompt: `Find ∂/∂x of ${c1}x³ (treating y as constant)`,
                                hint: "Power rule: d/dx(x³) = 3x²",
                                answer: `${c1*3}x²`,
                                acceptableAnswers: [`${c1*3}x²`, `${c1*3}x^2`],
                                commonMistakes: {
                                    [`${c1}x³`]: "You need to differentiate! Use power rule: ${c1}·3x² = ${c1*3}x²"
                                }
                            },
                            {
                                prompt: `Find ∂/∂x of ${c2}y² (treating y as constant)`,
                                hint: "If y is constant, what's the derivative of a constant?",
                                answer: "0",
                                acceptableAnswers: ["0", "zero"],
                                commonMistakes: {
                                    [`${c2*2}y`]: "That's ∂/∂y! For ∂/∂x, y² is constant, so derivative is 0."
                                }
                            },
                            {
                                prompt: `Find ∂/∂y of ${c2}y² (treating x as constant)`,
                                hint: "Power rule on y²...",
                                answer: `${c2*2}y`,
                                acceptableAnswers: [`${c2*2}y`],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Now form the gradient vector: ∇f = ⟨∂f/∂x, ∂f/∂y⟩ = ?`,
                                hint: "Put ∂f/∂x first, then ∂f/∂y...",
                                answer: `⟨${c1*3}x², ${c2*2}y⟩`,
                                acceptableAnswers: [`⟨${c1*3}x², ${c2*2}y⟩`, `<${c1*3}x², ${c2*2}y>`, `(${c1*3}x², ${c2*2}y)`],
                                commonMistakes: {}
                            }
                        ]
                    };
                })(),
                practice: { problem: `What does the gradient vector point toward?`, answer: "Steepest increase",
                    options: shuffle(["Steepest increase", "Steepest decrease", "Perpendicular to surface", "Origin"]),
                    mistakeAnalysis: {
                        "Steepest decrease": "That's -∇f (negative gradient). The gradient itself points toward steepest INCREASE.",
                        "Perpendicular to surface": "That's the normal vector. Gradient points toward steepest increase in function value.",
                        "Origin": "Gradient direction depends on the function and location, not always toward origin."
                    }}
            };
        },
        "Linear Algebra": () => {
            const a = rand(1, 3);
            const b = rand(1, 3);
            const c = rand(1, 3);
            const d = rand(1, 3);
            const det = a * d - b * c;
            return {
                goalProblem: `Find the determinant of the matrix [${a} ${b}; ${c} ${d}]`,
                teachingSteps: [
                    {
                        title: "What is Linear Algebra?",
                        explanation: "<strong>Linear algebra</strong> studies vectors, matrices, and linear transformations.<br><br>It's essential for computer graphics, machine learning, physics, and engineering!",
                        visual: "Linear Algebra = Vectors + Matrices + Transformations"
                    },
                    {
                        title: "What is a Determinant?",
                        explanation: "The <strong>determinant</strong> is a special number calculated from a square matrix.<br><br>It tells us:<br>• If matrix is invertible (det ≠ 0)<br>• Scale factor of the transformation<br>• Area/volume change",
                        visual: "det(A) = scalar value from square matrix"
                    },
                    {
                        title: "2×2 Determinant Formula",
                        explanation: "For a 2×2 matrix [a b; c d]:<br><br><strong>det = ad - bc</strong><br><br>\"Main diagonal minus other diagonal\"",
                        visual: "[a b]  →  det = ad - bc<br>[c d]"
                    },
                    {
                        title: "Our Matrix",
                        explanation: "Our matrix is:<br>[${a} ${b}]<br>[${c} ${d}]<br><br>a=${a}, b=${b}, c=${c}, d=${d}",
                        visual: "[${a} ${b}]<br>[${c} ${d}]"
                    },
                    {
                        title: "Apply the Formula",
                        explanation: "det = ad - bc<br><br>= (${a})(${d}) - (${b})(${c})<br>= ${a*d} - ${b*c}<br>= <strong>${det}</strong>",
                        visual: "det = ${a}×${d} - ${b}×${c} = ${det}"
                    },
                    {
                        title: "What This Means",
                        explanation: `${det === 0 ? 'det = 0 means this matrix is NOT invertible (singular matrix).' : 'det = ' + det + ' ≠ 0 means this matrix IS invertible.'}<br><br>${det < 0 ? 'Negative determinant means the transformation flips orientation.' : 'Positive determinant preserves orientation.'}`,
                        visual: `det = ${det} → ${det === 0 ? 'Not invertible' : 'Invertible'}`
                    }
                ],
                finalAnswer: String(det),
                answerExplanation: `Using det = ad - bc: (${a})(${d}) - (${b})(${c}) = ${a*d} - ${b*c} = ${det}`,
                example: { problem: `Find det of [3 1; 2 4]`, steps: [
                    { text: "Identify: a=3, b=1, c=2, d=4", math: "det = ad - bc" },
                    { text: "Calculate", math: "det = (3)(4) - (1)(2)" },
                    { text: "Result", math: "<strong>det = 12 - 2 = 10</strong>" }
                ]},
                keyPoints: [
                    "2×2 determinant: det = ad - bc",
                    "det ≠ 0 means matrix is invertible",
                    "det = 0 means matrix is singular (not invertible)"
                ],
                mistakes: [
                    { wrong: "Using ad + bc instead of ad - bc", why: "It's SUBTRACTION: main diagonal minus other diagonal." },
                    { wrong: "Mixing up which diagonal is which", why: "Main diagonal: top-left to bottom-right (ad). Other: top-right to bottom-left (bc)." }
                ],
                guided: (() => {
                    const m = [[rand(1, 4), rand(1, 3)], [rand(1, 3), rand(1, 4)]];
                    const result = m[0][0] * m[1][1] - m[0][1] * m[1][0];
                    return {
                        problem: `Find the determinant of [${m[0][0]} ${m[0][1]}; ${m[1][0]} ${m[1][1]}]`,
                        steps: [
                            { label: "Matrix", value: `[${m[0][0]} ${m[0][1]}; ${m[1][0]} ${m[1][1]}]` },
                            { label: "Formula", value: "det = ad - bc" }
                        ],
                        answer: String(result),
                        answerLabel: "Determinant =",
                        interactiveSteps: [
                            {
                                prompt: `In [${m[0][0]} ${m[0][1]}; ${m[1][0]} ${m[1][1]}], what is 'a' (top-left)?`,
                                hint: "First row, first column...",
                                answer: String(m[0][0]),
                                acceptableAnswers: [String(m[0][0])],
                                commonMistakes: {}
                            },
                            {
                                prompt: "What is 'd' (bottom-right)?",
                                hint: "Second row, second column...",
                                answer: String(m[1][1]),
                                acceptableAnswers: [String(m[1][1])],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Calculate ad: ${m[0][0]} × ${m[1][1]} = ?`,
                                hint: "Main diagonal product...",
                                answer: String(m[0][0] * m[1][1]),
                                acceptableAnswers: [String(m[0][0] * m[1][1])],
                                commonMistakes: {}
                            },
                            {
                                prompt: `Calculate bc: ${m[0][1]} × ${m[1][0]} = ?`,
                                hint: "Other diagonal product...",
                                answer: String(m[0][1] * m[1][0]),
                                acceptableAnswers: [String(m[0][1] * m[1][0])],
                                commonMistakes: {}
                            },
                            {
                                prompt: `det = ad - bc = ${m[0][0] * m[1][1]} - ${m[0][1] * m[1][0]} = ?`,
                                hint: "Subtract...",
                                answer: String(result),
                                acceptableAnswers: [String(result)],
                                commonMistakes: {
                                    [String(m[0][0] * m[1][1] + m[0][1] * m[1][0])]: "It's SUBTRACTION (ad - bc), not addition!"
                                }
                            }
                        ]
                    };
                })(),
                practice: { problem: `If det(A) = 0, what can you say about matrix A?`, answer: "A is not invertible",
                    options: shuffle(["A is not invertible", "A is the identity matrix", "A has all zeros", "A is symmetric"]),
                    mistakeAnalysis: {
                        "A is the identity matrix": "Identity matrix has det = 1, not 0. det = 0 means not invertible.",
                        "A has all zeros": "Zero matrix does have det = 0, but so do many non-zero matrices.",
                        "A is symmetric": "Symmetry is unrelated to determinant. det = 0 means not invertible."
                    }}
            };
        }
    }
};

// Generate lesson for any tier/skill (falls back to basic template)
function generateLesson(tier, skill) {
    if (lessons[tier] && lessons[tier][skill]) {
        return lessons[tier][skill]();
    }
    // No generic fallback - all lessons must be explicitly defined with proper steps
    console.warn(`Lesson not found: Tier ${tier}, Skill: ${skill}`);
    return null;
}

// ========================================
// GENERATE QUESTION
// ========================================
function generateQuestion(tier, domain = null) {
    const tierGens = generators[tier];
    if (!tierGens) return null;

    const allDomains = Object.keys(tierGens);
    let selectedDomain;

    if (domain && tierGens[domain]) {
        // Specific domain requested
        selectedDomain = domain;
    } else if (state.mode === 'placement') {
        // In placement mode, prioritize untested domains for comprehensive coverage
        if (!state.testedDomains[tier]) {
            state.testedDomains[tier] = new Set();
        }

        // Find domains not yet tested in this tier
        const untestedDomains = allDomains.filter(d => !state.testedDomains[tier].has(d));

        if (untestedDomains.length > 0) {
            // Pick from untested domains first
            selectedDomain = pick(untestedDomains);
        } else {
            // All domains tested, reset and pick any (allows retesting for accuracy)
            state.testedDomains[tier].clear();
            selectedDomain = pick(allDomains);
        }

        // Mark this domain as tested
        state.testedDomains[tier].add(selectedDomain);
    } else {
        // Testing center or learning - random selection
        selectedDomain = pick(allDomains);
    }

    const generator = tierGens[selectedDomain];
    
    const q = generator();
    q.tier = tier;
    q.domain = selectedDomain;
    q.type = q.type || "procedural";
    q.timeExpected = tier <= 2 ? 15 : tier <= 4 ? 20 : tier <= 6 ? 25 : tier <= 8 ? 30 : 35;
    
    // Generate options if not provided
    if (!q.options) {
        if (typeof q.answer === "number") {
            const distractors = generateDistractors(q.answer);
            q.options = shuffle([q.answer, ...distractors]);
            q.answerIndex = q.options.indexOf(q.answer);
        } else {
            q.options = [q.answer, ...generateDistractors(0, 3).map(d => `${d}`)];
            q.answerIndex = 0;
            q.options = shuffle(q.options);
            q.answerIndex = q.options.indexOf(q.answer);
        }
    } else {
        q.answerIndex = q.options.findIndex(o => o == q.answer || o === q.answer);
        if (q.answerIndex === -1) q.answerIndex = 0;
    }
    
    return q;
}

// ========================================
// STATE & UI MANAGEMENT
// ========================================
let state = { mode: null, currentTier: 5, selectedTiers: [], history: [], tierScores: {}, domainScores: {}, gapLog: [], currentQuestion: null, selectedAnswer: null, startTime: null, timerInterval: null, elapsedTime: 0, consecutiveCorrect: 0, consecutiveWrong: 0, currentStreak: 0, probeMode: false,
    // Learning Center state
    learningTier: 1, learningSkill: null, learningPhase: 'learn', currentLesson: null, guidedStep: 0, practiceAttempts: 0, practiceCorrect: 0,
    // Domain coverage tracking for placement test
    testedDomains: {},  // { tier: Set of tested domains }
    // Sparring Arena state
    arenaSelectionMode: 'tier',  // 'tier' or 'skill'
    selectedSkills: [],  // Array of { tier, skill } objects
    practiceMode: 'endless',  // 'endless', 'timed', 'countdown'
    timeLimit: 60,  // seconds for timed mode
    questionGoal: 10,  // questions for countdown mode
    arenaStartTime: null,  // session start time
    arenaTimeRemaining: 0,  // for timed mode countdown
    // Visual interaction state
    visualAnswer: null,  // Current visual answer value
    visualType: null,    // Type of visual (numberline, shape, etc.)
    visualInteractive: false  // Whether visual accepts input
};

function initTierGrid() {
    const grid = document.getElementById('tier-selection-grid');
    grid.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const div = document.createElement('div');
        div.className = 'tier-option';
        div.setAttribute('data-tier', t);
        div.onclick = () => toggleTier(t);
        div.innerHTML = `<div class="tier-checkbox"></div><div><div class="tier-name">Tier ${t}: ${TIERS[t].name}</div><div class="tier-grades">Grades ${TIERS[t].grades}</div></div>`;
        grid.appendChild(div);
    }
}
initTierGrid();

// ==================== SPARRING ARENA SETUP ====================

function initArenaSkillGrid() {
    const grid = document.getElementById('arena-skill-grid');
    const filter = document.getElementById('skill-tier-filter');
    if (!grid || !filter) return;

    // Populate tier filter dropdown
    filter.innerHTML = '<option value="all">All Tiers</option>';
    for (let t = 1; t <= 10; t++) {
        filter.innerHTML += `<option value="${t}">Tier ${t}: ${TIERS[t].name}</option>`;
    }

    renderArenaSkills('all');
}

function renderArenaSkills(tierFilter) {
    const grid = document.getElementById('arena-skill-grid');
    if (!grid) return;
    grid.innerHTML = '';

    for (let t = 1; t <= 10; t++) {
        if (tierFilter !== 'all' && t !== parseInt(tierFilter)) continue;

        const tierGens = generators[t];
        if (!tierGens) continue;

        const skills = Object.keys(tierGens);
        skills.forEach(skill => {
            const div = document.createElement('div');
            const skillState = getSkillState(skill);
            const isUnlocked = isSkillUnlocked(skill);
            const mastery = getSkillMastery(skill);

            div.className = 'skill-option';
            div.setAttribute('data-tier', t);
            div.setAttribute('data-skill', skill);

            // Add state-based styling
            if (!isUnlocked) {
                div.classList.add('locked');
            } else if (skillState === 'mastered') {
                div.classList.add('mastered');
            } else if (skillState === 'needs_review') {
                div.classList.add('needs-review');
            }

            // Check if already selected
            if (state.selectedSkills.some(s => s.tier === t && s.skill === skill)) {
                div.classList.add('selected');
            }

            // Build content
            let content = `<div style="color:var(--slate-200)">${skill}</div>`;
            content += `<div class="skill-tier">Tier ${t}</div>`;

            // Show mastery bar for unlocked skills
            if (isUnlocked && mastery > 0) {
                content += `<div class="skill-mastery-bar" style="margin-top:0.5rem"><div class="skill-mastery-fill" style="width:${mastery}%"></div></div>`;
            }

            // Show lock icon for locked skills
            if (!isUnlocked) {
                content += `<div style="font-size:0.8rem;color:var(--slate-500);margin-top:0.25rem">🔒 Locked</div>`;
            }

            // State badges
            if (skillState === 'mastered') {
                content += `<div style="font-size:0.7rem;color:var(--amber-400);margin-top:0.25rem">✓ Mastered</div>`;
            } else if (skillState === 'needs_review') {
                content += `<div style="font-size:0.7rem;color:var(--rose-400);margin-top:0.25rem">⟳ Review</div>`;
            }

            div.innerHTML = content;

            // Only allow selection if unlocked
            if (isUnlocked) {
                div.onclick = () => toggleSkillSelection(t, skill);
            } else {
                div.onclick = () => showLockedSkillInfo(skill);
            }

            grid.appendChild(div);
        });
    }
}

function filterSkillsByTier() {
    const filter = document.getElementById('skill-tier-filter');
    renderArenaSkills(filter.value);
}

function setSelectionMode(mode) {
    state.arenaSelectionMode = mode;

    document.getElementById('select-by-tier-btn').classList.toggle('active', mode === 'tier');
    document.getElementById('select-by-skill-btn').classList.toggle('active', mode === 'skill');
    document.getElementById('select-needs-practice-btn').classList.toggle('active', mode === 'needs-practice');

    document.getElementById('tier-selection-panel').style.display = mode === 'tier' ? 'block' : 'none';
    document.getElementById('skill-selection-panel').style.display = mode === 'skill' ? 'block' : 'none';
    document.getElementById('needs-practice-panel').style.display = mode === 'needs-practice' ? 'block' : 'none';

    if (mode === 'skill') {
        initArenaSkillGrid();
    } else if (mode === 'needs-practice') {
        loadNeedsPracticeSkills();
    }

    updateArenaStartButton();
}

// ========================================
// NEEDS PRACTICE MODE
// ========================================

// Get skills that need practice from the skill tree
function getNeedsPracticeSkills() {
    const needsPractice = [];

    // Go through all skills in the tree data
    for (const [skillName, data] of Object.entries(skillTreeData.skills)) {
        if (!data) continue;

        const state = data.state;
        const mastery = data.mastery_score || 0;
        const lastPracticed = data.last_practiced;
        const decayRate = data.decay_rate || 14;

        // Calculate days since practice
        let daysSince = Infinity;
        if (lastPracticed) {
            daysSince = Math.floor((Date.now() - new Date(lastPracticed).getTime()) / (1000 * 60 * 60 * 24));
        }

        // Calculate priority (higher = more urgent)
        let priority = 0;
        let reason = '';

        // Needs review (decayed)
        if (state === 'needs_review') {
            priority = 100;
            reason = 'Needs review';
        }
        // Mastered but decaying
        else if ((state === 'mastered' || state === 'activated') && daysSince > decayRate) {
            priority = 80 + Math.min(daysSince - decayRate, 20);
            reason = `${daysSince} days since practice`;
        }
        // In progress (started but not mastered)
        else if (state === 'in_progress') {
            priority = 60 + (100 - mastery) / 2;
            reason = `In progress (${mastery}%)`;
        }
        // Activated but low mastery
        else if (state === 'activated' && mastery < 85) {
            priority = 40 + (85 - mastery);
            reason = `Building mastery (${mastery}%)`;
        }
        // Available but never practiced
        else if (state === 'available' && !lastPracticed) {
            priority = 30;
            reason = 'Ready to learn';
        }
        // Stale (7-14 days since practice)
        else if ((state === 'mastered' || state === 'activated') && daysSince > 7) {
            priority = 20 + daysSince;
            reason = `Getting stale (${daysSince} days)`;
        }

        if (priority > 0) {
            // Find the Dojo domain name for this skill
            const dojoInfo = findDojoSkillInfo(skillName);
            if (dojoInfo) {
                needsPractice.push({
                    skill: skillName,
                    domain: dojoInfo.domain,
                    tier: dojoInfo.tier,
                    priority,
                    reason,
                    mastery,
                    state,
                    daysSince
                });
            }
        }
    }

    // Sort by priority (highest first)
    needsPractice.sort((a, b) => b.priority - a.priority);

    return needsPractice;
}

// Find the Dojo tier and domain for a tree skill name
function findDojoSkillInfo(treeSkillName) {
    for (let tier = 1; tier <= 10; tier++) {
        const tierGens = generators[tier];
        if (!tierGens) continue;

        for (const domain of Object.keys(tierGens)) {
            const mappedName = getTreeSkillName(domain);
            if (mappedName === treeSkillName || domain === treeSkillName) {
                return { tier, domain };
            }
        }
    }
    return null;
}

// Load and render needs practice skills
function loadNeedsPracticeSkills() {
    const skills = getNeedsPracticeSkills();
    const grid = document.getElementById('needs-practice-grid');
    const summary = document.getElementById('needs-practice-summary');
    const noSkills = document.getElementById('no-needs-practice');

    if (skills.length === 0) {
        grid.style.display = 'none';
        summary.style.display = 'none';
        noSkills.style.display = 'block';
        state.selectedSkills = [];
        updateArenaStartButton();
        return;
    }

    grid.style.display = 'grid';
    summary.style.display = 'block';
    noSkills.style.display = 'none';

    // Show summary
    const urgent = skills.filter(s => s.priority >= 80).length;
    const moderate = skills.filter(s => s.priority >= 40 && s.priority < 80).length;
    const light = skills.filter(s => s.priority < 40).length;

    summary.innerHTML = `
        <div style="display:flex;gap:1.5rem;flex-wrap:wrap;">
            ${urgent > 0 ? `<div style="color:var(--rose-400);"><strong>${urgent}</strong> urgent</div>` : ''}
            ${moderate > 0 ? `<div style="color:var(--amber-400);"><strong>${moderate}</strong> moderate</div>` : ''}
            ${light > 0 ? `<div style="color:var(--cyan-400);"><strong>${light}</strong> light</div>` : ''}
            <div style="color:var(--slate-400);margin-left:auto;">${skills.length} skills total</div>
        </div>
    `;

    // Render skills (top 20 for performance)
    grid.innerHTML = '';
    const displaySkills = skills.slice(0, 20);

    displaySkills.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'skill-option needs-practice-skill selected';
        div.setAttribute('data-tier', s.tier);
        div.setAttribute('data-skill', s.domain);
        div.style.position = 'relative';

        // Priority color
        let priorityColor = 'var(--cyan-500)';
        let priorityLabel = 'Low';
        if (s.priority >= 80) {
            priorityColor = 'var(--rose-500)';
            priorityLabel = 'Urgent';
        } else if (s.priority >= 40) {
            priorityColor = 'var(--amber-500)';
            priorityLabel = 'Med';
        }

        div.innerHTML = `
            <div class="priority-badge" style="background:${priorityColor}">${priorityLabel}</div>
            <div style="color:var(--slate-200);font-weight:500;">${s.domain}</div>
            <div class="skill-tier">Tier ${s.tier}</div>
            <div style="font-size:0.75rem;color:var(--slate-500);margin-top:0.25rem;">${s.reason}</div>
        `;

        div.onclick = () => toggleNeedsPracticeSkill(s.tier, s.domain, div);
        grid.appendChild(div);
    });

    // Auto-select all needs practice skills
    state.selectedSkills = displaySkills.map(s => ({ tier: s.tier, skill: s.domain }));
    updateArenaStartButton();
}

// Toggle selection for needs practice skill
function toggleNeedsPracticeSkill(tier, skill, element) {
    const idx = state.selectedSkills.findIndex(s => s.tier === tier && s.skill === skill);

    if (idx > -1) {
        state.selectedSkills.splice(idx, 1);
        element.classList.remove('selected');
    } else {
        state.selectedSkills.push({ tier, skill });
        element.classList.add('selected');
    }

    updateArenaStartButton();
}

function toggleSkillSelection(tier, skill) {
    // Check if skill is unlocked
    if (!isSkillUnlocked(skill)) {
        showLockedSkillInfo(skill);
        return;
    }

    const idx = state.selectedSkills.findIndex(s => s.tier === tier && s.skill === skill);
    const el = document.querySelector(`.skill-option[data-tier="${tier}"][data-skill="${skill}"]`);

    if (idx > -1) {
        state.selectedSkills.splice(idx, 1);
        if (el) el.classList.remove('selected');
    } else {
        state.selectedSkills.push({ tier, skill });
        if (el) el.classList.add('selected');
    }

    updateArenaStartButton();
}

function selectAllSkills() {
    state.selectedSkills = [];
    const filter = document.getElementById('skill-tier-filter').value;

    for (let t = 1; t <= 10; t++) {
        if (filter !== 'all' && t !== parseInt(filter)) continue;
        const tierGens = generators[t];
        if (!tierGens) continue;
        Object.keys(tierGens).forEach(skill => {
            // Only add unlocked skills
            if (isSkillUnlocked(skill)) {
                state.selectedSkills.push({ tier: t, skill });
            }
        });
    }

    // Update visual selection (only for unlocked skills)
    document.querySelectorAll('.skill-option').forEach(el => {
        if (!el.classList.contains('locked')) {
            el.classList.add('selected');
        }
    });
    updateArenaStartButton();
}

function clearSkillSelection() {
    state.selectedSkills = [];
    document.querySelectorAll('.skill-option').forEach(el => el.classList.remove('selected'));
    updateArenaStartButton();
}

function setPracticeMode(mode) {
    state.practiceMode = mode;

    document.querySelectorAll('.mode-option').forEach(el => {
        el.classList.toggle('selected', el.getAttribute('data-practice-mode') === mode);
    });

    document.getElementById('timed-options').style.display = mode === 'timed' ? 'block' : 'none';
    document.getElementById('countdown-options').style.display = mode === 'countdown' ? 'block' : 'none';
}

function setTimeLimit(seconds) {
    state.timeLimit = seconds;
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.getAttribute('data-time')) === seconds);
    });
    // Clear custom input if a preset was selected
    const customInput = document.getElementById('custom-time-input');
    if (customInput) customInput.value = '';
}

function setCustomTimeLimit() {
    const input = document.getElementById('custom-time-input');
    const minutes = parseInt(input.value);
    if (minutes && minutes >= 1 && minutes <= 60) {
        state.timeLimit = minutes * 60;
        // Deselect all preset buttons
        document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
    }
}

function setQuestionCount(count) {
    state.questionGoal = count;
    document.querySelectorAll('.count-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.getAttribute('data-count')) === count);
    });
    // Clear custom input if a preset was selected
    const customInput = document.getElementById('custom-count-input');
    if (customInput) customInput.value = '';
}

function setCustomQuestionCount() {
    const input = document.getElementById('custom-count-input');
    const count = parseInt(input.value);
    if (count && count >= 1 && count <= 500) {
        state.questionGoal = count;
        // Deselect all preset buttons
        document.querySelectorAll('.count-btn').forEach(btn => btn.classList.remove('selected'));
    }
}

function updateArenaStartButton() {
    let hasSelection = false;
    if (state.arenaSelectionMode === 'tier') {
        hasSelection = state.selectedTiers.length > 0;
    } else if (state.arenaSelectionMode === 'skill' || state.arenaSelectionMode === 'needs-practice') {
        hasSelection = state.selectedSkills.length > 0;
    }
    document.getElementById('start-testing-btn').disabled = !hasSelection;
}

function selectMode(mode) {
    state.mode = mode;
    document.getElementById('mode-screen').classList.remove('active');
    if (mode === 'placement') {
        document.getElementById('placement-setup-screen').classList.add('active');
    } else if (mode === 'testing') {
        document.getElementById('testing-setup-screen').classList.add('active');
    } else if (mode === 'learning') {
        initLearningSetup();
        document.getElementById('learning-setup-screen').classList.add('active');
    }
}

function goToModeSelect() {
    resetState();
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('mode-screen').classList.add('active');
}

function resetState() {
    state = { mode: null, currentTier: 5, selectedTiers: [], history: [], tierScores: {}, domainScores: {}, gapLog: [], currentQuestion: null, selectedAnswer: null, startTime: null, timerInterval: null, elapsedTime: 0, consecutiveCorrect: 0, consecutiveWrong: 0, currentStreak: 0, probeMode: false,
        learningTier: 1, learningSkill: null, learningPhase: 'learn', currentLesson: null, guidedStep: 0, practiceAttempts: 0, practiceCorrect: 0,
        testedDomains: {},
        arenaSelectionMode: 'tier', selectedSkills: [], practiceMode: 'endless', timeLimit: 60, questionGoal: 10, arenaStartTime: null, arenaTimeRemaining: 0
    };
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.tier-option').forEach(o => o.classList.remove('selected'));
    document.querySelectorAll('.skill-option').forEach(o => o.classList.remove('selected'));
    document.getElementById('start-placement-btn').disabled = true;
    document.getElementById('start-testing-btn').disabled = true;

    // Reset arena selection mode buttons and panels
    document.getElementById('select-by-tier-btn')?.classList.add('active');
    document.getElementById('select-by-skill-btn')?.classList.remove('active');
    document.getElementById('select-needs-practice-btn')?.classList.remove('active');
    document.getElementById('tier-selection-panel').style.display = 'block';
    document.getElementById('skill-selection-panel').style.display = 'none';
    document.getElementById('needs-practice-panel').style.display = 'none';
}

function selectLevel(el, tier) {
    document.querySelectorAll('.level-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    state.currentTier = tier;
    document.getElementById('start-placement-btn').disabled = false;
}

function toggleTier(tier) {
    const opt = document.querySelector(`.tier-option[data-tier="${tier}"]`);
    const idx = state.selectedTiers.indexOf(tier);
    if (idx > -1) { state.selectedTiers.splice(idx, 1); opt.classList.remove('selected'); }
    else { state.selectedTiers.push(tier); opt.classList.add('selected'); }
    updateArenaStartButton();
}

function selectAllTiers() { for (let t = 1; t <= 10; t++) if (!state.selectedTiers.includes(t)) toggleTier(t); }
function clearTierSelection() { [...state.selectedTiers].forEach(t => toggleTier(t)); }
function selectTierRange(a, b) { clearTierSelection(); for (let t = a; t <= b; t++) toggleTier(t); }

function initScores() { 
    for (let i = 1; i <= 10; i++) {
        state.tierScores[i] = { correct: 0, total: 0, times: [] };
        state.domainScores[i] = {};
    }
}

function startPlacementTest() {
    initScores();
    startSessionTracking('placement');
    setupTestUI(false);
    document.getElementById('placement-setup-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');
    loadQuestion();
}

function startTestingCenter() {
    initScores();
    startSessionTracking('testing');

    // Set current tier based on selection mode
    if (state.arenaSelectionMode === 'tier') {
        state.currentTier = Math.min(...state.selectedTiers);
    } else {
        // For skill mode, set current tier from first selected skill
        state.currentTier = state.selectedSkills.length > 0 ? state.selectedSkills[0].tier : 1;
    }

    // Initialize arena timer
    state.arenaStartTime = Date.now();
    state.arenaTimeRemaining = state.timeLimit;

    setupTestUI(true);
    document.getElementById('testing-setup-screen').classList.remove('active');
    document.getElementById('test-screen').classList.add('active');

    // Start arena timer if in timed mode
    if (state.practiceMode === 'timed') {
        startArenaTimer();
    }

    loadQuestion();
}

let arenaTimerInterval = null;

function startArenaTimer() {
    if (arenaTimerInterval) clearInterval(arenaTimerInterval);

    arenaTimerInterval = setInterval(() => {
        const elapsed = (Date.now() - state.arenaStartTime) / 1000;
        state.arenaTimeRemaining = Math.max(0, state.timeLimit - elapsed);

        // Update display
        updateArenaTimerDisplay();

        // Check if time is up
        if (state.arenaTimeRemaining <= 0) {
            clearInterval(arenaTimerInterval);
            arenaTimerInterval = null;
            endArenaSession('time');
        }
    }, 100);
}

function updateArenaTimerDisplay() {
    const display = document.getElementById('arena-timer-display');
    if (!display) return;

    if (state.practiceMode === 'timed') {
        const mins = Math.floor(state.arenaTimeRemaining / 60);
        const secs = Math.floor(state.arenaTimeRemaining % 60);
        display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        display.style.color = state.arenaTimeRemaining < 10 ? 'var(--red-400)' : 'var(--cyan-400)';
    } else if (state.practiceMode === 'countdown') {
        const remaining = state.questionGoal - state.history.length;
        display.textContent = `${remaining} left`;
    } else {
        const elapsed = Math.floor((Date.now() - state.arenaStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        display.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

function endArenaSession(reason = 'manual') {
    if (arenaTimerInterval) {
        clearInterval(arenaTimerInterval);
        arenaTimerInterval = null;
    }
    endTest();
}

function setupTestUI(isTC) {
    const header = document.getElementById('test-header');
    header.classList.toggle('testing-center-header', isTC);
    document.getElementById('tc-stats-bar').style.display = isTC ? 'flex' : 'none';
    document.getElementById('end-session-btn').style.display = isTC ? 'inline-flex' : 'none';
    document.getElementById('idk-btn').style.display = isTC ? 'none' : 'inline-flex';
    document.getElementById('test-screen').classList.toggle('testing-center-mode', isTC);
    const btnClass = isTC ? 'btn btn-cyan' : 'btn btn-primary';
    document.getElementById('submit-btn').className = btnClass;
    document.getElementById('next-btn').className = btnClass;
}

// Helper function to get tier accuracy
function getTierAccuracy(tier) {
    const ts = state.tierScores[tier];
    if (!ts || ts.total === 0) return null;
    return (ts.correct / ts.total) * 100;
}

// Helper function to determine adaptive tier based on recent performance
function getAdaptiveTier() {
    // Find the current working tier (where we have good but not perfect accuracy)
    // Move up if doing well (>80%), move down if struggling (<50%)

    let workingTier = state.currentTier;

    // Check recent history (last 5 questions at current working tier)
    const recentAtTier = state.history.filter(h => h.tier === workingTier).slice(-5);
    if (recentAtTier.length >= 3) {
        const recentCorrect = recentAtTier.filter(h => h.correct).length;
        const recentAcc = (recentCorrect / recentAtTier.length) * 100;

        if (recentAcc >= 80 && workingTier < 10) {
            // Doing great, try harder tier
            workingTier = Math.min(10, workingTier + 1);
        } else if (recentAcc < 50 && workingTier > 1) {
            // Struggling, try easier tier
            workingTier = Math.max(1, workingTier - 1);
        }
    }

    return workingTier;
}

function loadQuestion() {
    // Placement test: dynamic length based on convergence (min 20, max 40)
    const minQuestions = 20;
    const maxQuestions = 40;

    if (state.mode === 'placement') {
        // Check if we've converged on a stable tier
        if (state.history.length >= minQuestions) {
            const hasConverged = checkPlacementConvergence();
            if (hasConverged || state.history.length >= maxQuestions) {
                endTest();
                return;
            }
        }
    }

    let targetTier = state.currentTier;
    state.probeMode = false;

    if (state.mode === 'placement') {
        // Fully adaptive placement test algorithm:
        // 1. Start at selected tier, test 3 questions
        // 2. If >66% correct, move up a tier; if <33% correct, move down
        // 3. Continue until we find the "edge" tier (50-80% accuracy)
        // 4. Once edge is found, test domains within that tier and adjacent tiers
        // 5. Periodically probe 2-3 tiers above/below to ensure we haven't missed anything

        const qNum = state.history.length;

        // Phase 1 (Q0-2): Initial calibration at starting tier
        if (qNum < 3) {
            targetTier = state.currentTier;
        }
        // Phase 2 (Q3+): Adaptive tier selection
        else {
            // Get current tier's accuracy
            const currentAcc = getTierAccuracy(state.currentTier);

            // Every 5 questions, do a probe of a distant tier
            if (qNum % 5 === 0 && qNum > 0) {
                state.probeMode = true;
                // Probe higher if doing well, lower if struggling
                if (currentAcc !== null && currentAcc >= 60) {
                    // Probe 2-3 tiers above current
                    const probeUp = Math.min(10, state.currentTier + rand(2, 3));
                    targetTier = probeUp;
                } else {
                    // Probe 2-3 tiers below current
                    const probeDown = Math.max(1, state.currentTier - rand(2, 3));
                    targetTier = probeDown;
                }
            }
            // Regular adaptive selection
            else {
                targetTier = getAdaptiveTier();

                // Update working tier if we've moved
                if (targetTier !== state.currentTier) {
                    const tierAcc = getTierAccuracy(targetTier);
                    // Only commit to new tier if we have evidence it's appropriate
                    if (tierAcc === null || (tierAcc >= 30 && tierAcc <= 90)) {
                        state.currentTier = targetTier;
                    }
                }
            }
        }

        // Ensure we're testing within bounds
        targetTier = Math.max(1, Math.min(10, targetTier));
    }

    // Testing center / Sparring Arena logic
    let selectedDomain = null;

    if (state.mode === 'testing') {
        // Check if countdown mode goal reached
        if (state.practiceMode === 'countdown' && state.history.length >= state.questionGoal) {
            endArenaSession('goal');
            return;
        }

        // Skill-based selection (includes 'skill' and 'needs-practice' modes)
        if ((state.arenaSelectionMode === 'skill' || state.arenaSelectionMode === 'needs-practice') && state.selectedSkills.length > 0) {
            // For needs-practice mode, prioritize higher priority skills by shuffling with weight
            if (state.arenaSelectionMode === 'needs-practice') {
                // Random selection weighted toward earlier skills (higher priority)
                const weightedIdx = Math.floor(Math.pow(Math.random(), 1.5) * state.selectedSkills.length);
                const selected = state.selectedSkills[weightedIdx];
                targetTier = selected.tier;
                selectedDomain = selected.skill;
            } else {
                // Regular skill mode - cycle through selected skills
                const skillIdx = state.history.length % state.selectedSkills.length;
                const selected = state.selectedSkills[skillIdx];
                targetTier = selected.tier;
                selectedDomain = selected.skill;
            }
        }
        // Tier-based selection
        else if (state.selectedTiers.length > 0) {
            const sorted = [...state.selectedTiers].sort((a, b) => a - b);
            targetTier = sorted[state.history.length % sorted.length];
        }

        // Update arena timer display
        updateArenaTimerDisplay();
    }

    const q = generateQuestion(targetTier, selectedDomain);
    if (!q) { endTest(); return; }

    state.currentQuestion = q;
    state.selectedAnswer = null;
    renderQuestion();
    startTimer();
    updateProgress();
}

// Check if placement test has converged to a stable tier
function checkPlacementConvergence() {
    // Need at least 5 questions at the current tier
    const atCurrentTier = state.history.filter(h => h.tier === state.currentTier);
    if (atCurrentTier.length < 5) return false;

    // Check if accuracy is stable (between 40-80% suggests correct placement)
    const acc = getTierAccuracy(state.currentTier);
    if (acc === null) return false;

    // Also need to have tested adjacent tiers
    const tierAbove = state.currentTier < 10 ? getTierAccuracy(state.currentTier + 1) : 100;
    const tierBelow = state.currentTier > 1 ? getTierAccuracy(state.currentTier - 1) : 0;

    // Converged if: current tier is challenging but doable (40-80%)
    // AND tier above is harder (<60%) or we're at top
    // AND tier below is easier (>60%) or we're at bottom
    const currentInRange = acc >= 40 && acc <= 80;
    const aboveIsHarder = tierAbove === null || tierAbove < 60 || state.currentTier === 10;
    const belowIsEasier = tierBelow === null || tierBelow > 60 || state.currentTier === 1;

    return currentInRange && aboveIsHarder && belowIsEasier;
}

// ========================================
// VISUAL RENDERING SYSTEM
// ========================================

function setVisualAnswer(value) {
    state.visualAnswer = value;
    if (state.visualInteractive) {
        document.getElementById('submit-btn').disabled = false;
    }
}

function compareVisualAnswer(userAnswer, expectedAnswer, type) {
    if (type === 'numberline' || type === 'clock') {
        return Math.abs(userAnswer - expectedAnswer) < 0.01;
    }
    if (type === 'coordinate') {
        if (typeof expectedAnswer === 'string') {
            return userAnswer === expectedAnswer;
        }
        return userAnswer.x === expectedAnswer.x && userAnswer.y === expectedAnswer.y;
    }
    return userAnswer === expectedAnswer;
}

function renderVisual(visual) {
    const container = document.getElementById('visual-container');
    container.innerHTML = '';
    state.visualAnswer = null;
    state.visualType = null;
    state.visualInteractive = false;

    if (!visual) return;

    state.visualType = visual.type;
    state.visualInteractive = visual.mode === 'interactive';

    switch (visual.type) {
        case 'numberline':
            renderNumberLine(container, visual.data, visual.mode);
            break;
        case 'shape':
            renderShape(container, visual.data);
            break;
        case 'coordinate':
            renderCoordinatePlane(container, visual.data, visual.mode);
            break;
        case 'fraction':
            renderFractionVisual(container, visual.data);
            break;
        case 'clock':
            renderClockFace(container, visual.data, visual.mode);
            break;
        case 'chart':
            renderChart(container, visual.data);
            break;
    }
}

function renderNumberLine(container, data, mode) {
    const { min = 0, max = 20, step = 1, markers = [], target = null, initialValue = null } = data;
    const range = max - min;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-number-line';

    const track = document.createElement('div');
    track.className = 'dojo-number-line-track';

    // Create ticks and labels
    for (let v = min; v <= max; v += step) {
        const pct = ((v - min) / range) * 100;
        const tick = document.createElement('div');
        tick.className = 'dojo-number-line-tick' + (v % (step * 5) === 0 || v === min || v === max ? ' major' : '');
        tick.style.left = pct + '%';
        track.appendChild(tick);

        // Labels for major ticks
        if (v % (step * 5) === 0 || v === min || v === max || range <= 10) {
            const label = document.createElement('div');
            label.className = 'dojo-number-line-label';
            label.style.left = pct + '%';
            label.textContent = v;
            track.appendChild(label);
        }
    }

    // Fixed markers (display mode)
    markers.forEach(m => {
        const pct = ((m - min) / range) * 100;
        const marker = document.createElement('div');
        marker.className = 'dojo-number-line-fixed-marker';
        marker.style.left = pct + '%';
        track.appendChild(marker);
    });

    // Interactive marker
    if (mode === 'interactive') {
        const startVal = initialValue !== null ? initialValue : (min + max) / 2;
        let currentValue = startVal;

        const marker = document.createElement('div');
        marker.className = 'dojo-number-line-marker';
        marker.style.left = ((startVal - min) / range) * 100 + '%';

        const valueDisplay = document.createElement('div');
        valueDisplay.className = 'dojo-number-line-value';
        valueDisplay.textContent = startVal;
        marker.appendChild(valueDisplay);

        const updateMarker = (clientX) => {
            const rect = track.getBoundingClientRect();
            let pct = (clientX - rect.left) / rect.width;
            pct = Math.max(0, Math.min(1, pct));
            let val = min + pct * range;
            val = Math.round(val / step) * step;
            val = Math.max(min, Math.min(max, val));

            currentValue = val;
            marker.style.left = ((val - min) / range) * 100 + '%';
            valueDisplay.textContent = val;
            setVisualAnswer(val);
        };

        // Mouse events
        marker.addEventListener('mousedown', (e) => {
            e.preventDefault();
            marker.classList.add('dragging');
            const onMove = (e) => updateMarker(e.clientX);
            const onUp = () => {
                marker.classList.remove('dragging');
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            };
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });

        // Touch events
        marker.addEventListener('touchstart', (e) => {
            e.preventDefault();
            marker.classList.add('dragging');
        });
        wrapper.addEventListener('touchmove', (e) => {
            if (marker.classList.contains('dragging')) {
                updateMarker(e.touches[0].clientX);
            }
        });
        wrapper.addEventListener('touchend', () => {
            marker.classList.remove('dragging');
        });

        // Click on track
        track.addEventListener('click', (e) => {
            if (e.target === marker) return;
            updateMarker(e.clientX);
        });

        track.appendChild(marker);
        setVisualAnswer(startVal);
    }

    wrapper.appendChild(track);
    container.appendChild(wrapper);
}

function renderShape(container, data) {
    const { shape, dimensions = {}, showMeasurements = true, showAngles = false, highlightSides = [], shaded = 0 } = data;

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'dojo-shape-svg');
    svg.setAttribute('viewBox', '0 0 200 160');

    let path = '';
    let dimLines = [];
    let angleArcs = [];

    switch (shape) {
        case 'triangle': {
            const base = dimensions.base || 80;
            const height = dimensions.height || 70;
            const x1 = 100 - base/2, y1 = 130;
            const x2 = 100 + base/2, y2 = 130;
            const x3 = dimensions.isRight ? x1 : 100, y3 = 130 - height;
            path = `M${x1},${y1} L${x2},${y2} L${x3},${y3} Z`;
            if (showMeasurements) {
                dimLines.push({ x1, y1: y1+15, x2, y2: y2+15, label: dimensions.base || 'base', labelY: y1+28 });
                if (dimensions.height) {
                    dimLines.push({ x1: x3+10, y1: y3, x2: x3+10, y2: y1, label: height, labelX: x3+22, vertical: true });
                }
            }
            if (showAngles && dimensions.isRight) {
                angleArcs.push({ cx: x1, cy: y1, label: '90°' });
            }
            break;
        }
        case 'square': {
            const side = dimensions.side || 80;
            const x = 100 - side/2, y = 80 - side/2;
            path = `M${x},${y} L${x+side},${y} L${x+side},${y+side} L${x},${y+side} Z`;
            if (showMeasurements) {
                dimLines.push({ x1: x, y1: y+side+15, x2: x+side, y2: y+side+15, label: side, labelY: y+side+28 });
            }
            break;
        }
        case 'rectangle': {
            const width = dimensions.width || 100;
            const height = dimensions.height || 60;
            const x = 100 - width/2, y = 80 - height/2;
            path = `M${x},${y} L${x+width},${y} L${x+width},${y+height} L${x},${y+height} Z`;
            if (showMeasurements) {
                dimLines.push({ x1: x, y1: y+height+15, x2: x+width, y2: y+height+15, label: width, labelY: y+height+28 });
                dimLines.push({ x1: x-15, y1: y, x2: x-15, y2: y+height, label: height, labelX: x-28, vertical: true });
            }
            break;
        }
        case 'circle': {
            const r = dimensions.radius || 50;
            path = `M${100-r},80 A${r},${r} 0 1,1 ${100+r},80 A${r},${r} 0 1,1 ${100-r},80`;
            if (showMeasurements && dimensions.radius) {
                dimLines.push({ x1: 100, y1: 80, x2: 100+r, y2: 80, label: `r=${r}`, labelY: 72 });
            }
            break;
        }
        case 'pentagon': {
            const r = 50;
            const pts = [];
            for (let i = 0; i < 5; i++) {
                const angle = -Math.PI/2 + (2*Math.PI*i/5);
                pts.push([100 + r*Math.cos(angle), 80 + r*Math.sin(angle)]);
            }
            path = 'M' + pts.map(p => p.join(',')).join(' L') + ' Z';
            break;
        }
        case 'hexagon': {
            const r = 50;
            const pts = [];
            for (let i = 0; i < 6; i++) {
                const angle = (2*Math.PI*i/6);
                pts.push([100 + r*Math.cos(angle), 80 + r*Math.sin(angle)]);
            }
            path = 'M' + pts.map(p => p.join(',')).join(' L') + ' Z';
            break;
        }
        case 'cube': {
            // 3D cube representation
            const s = 50;
            const off = 20;
            path = `M60,100 L${60+s},100 L${60+s},${100-s} L60,${100-s} Z
                    M60,${100-s} L${60+off},${100-s-off} L${60+s+off},${100-s-off} L${60+s},${100-s}
                    M${60+s},100 L${60+s+off},${100-off} L${60+s+off},${100-s-off}`;
            break;
        }
        case 'cylinder': {
            const r = 35, h = 70;
            path = `M${100-r},50 A${r},12 0 1,1 ${100+r},50 A${r},12 0 1,1 ${100-r},50
                    M${100-r},50 L${100-r},${50+h} A${r},12 0 0,0 ${100+r},${50+h} L${100+r},50`;
            break;
        }
        case 'cone': {
            const r = 40, h = 80;
            path = `M100,40 L${100-r},${40+h} A${r},12 0 0,0 ${100+r},${40+h} Z`;
            break;
        }
        case 'sphere': {
            const r = 50;
            path = `M${100-r},80 A${r},${r} 0 1,1 ${100+r},80 A${r},${r} 0 1,1 ${100-r},80
                    M${100-r},80 Q100,${80+r*0.3} ${100+r},80`;
            break;
        }
    }

    const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    pathEl.setAttribute('d', path);
    pathEl.setAttribute('class', 'shape-fill' + (shaded ? ' shaded' : ''));
    svg.appendChild(pathEl);

    // Dimension lines
    dimLines.forEach(d => {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', d.x1);
        line.setAttribute('y1', d.y1);
        line.setAttribute('x2', d.x2);
        line.setAttribute('y2', d.y2);
        line.setAttribute('class', 'dimension-line');
        svg.appendChild(line);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', d.labelX || (d.x1 + d.x2) / 2);
        text.setAttribute('y', d.labelY || (d.y1 + d.y2) / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('class', 'dimension-text');
        text.textContent = d.label;
        svg.appendChild(text);
    });

    // Angle arcs
    angleArcs.forEach(a => {
        const arc = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        arc.setAttribute('d', `M${a.cx+15},${a.cy} A15,15 0 0,0 ${a.cx},${a.cy-15}`);
        arc.setAttribute('class', 'angle-arc');
        svg.appendChild(arc);

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', a.cx + 20);
        text.setAttribute('y', a.cy - 8);
        text.setAttribute('class', 'angle-text');
        text.textContent = a.label;
        svg.appendChild(text);
    });

    container.appendChild(svg);
}

function renderCoordinatePlane(container, data, mode) {
    const { xRange = [-5, 5], yRange = [-5, 5], gridStep = 1, points = [], lines = [], curves = [] } = data;

    const width = 300, height = 300;
    const padding = 30;
    const plotWidth = width - 2*padding;
    const plotHeight = height - 2*padding;

    const xMin = xRange[0], xMax = xRange[1];
    const yMin = yRange[0], yMax = yRange[1];

    const toX = (x) => padding + ((x - xMin) / (xMax - xMin)) * plotWidth;
    const toY = (y) => padding + ((yMax - y) / (yMax - yMin)) * plotHeight;

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'dojo-coordinate-svg');
    svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

    // Grid lines
    for (let x = xMin; x <= xMax; x += gridStep) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', toX(x));
        line.setAttribute('y1', padding);
        line.setAttribute('x2', toX(x));
        line.setAttribute('y2', height - padding);
        line.setAttribute('class', 'grid-line');
        svg.appendChild(line);
    }
    for (let y = yMin; y <= yMax; y += gridStep) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', padding);
        line.setAttribute('y1', toY(y));
        line.setAttribute('x2', width - padding);
        line.setAttribute('y2', toY(y));
        line.setAttribute('class', 'grid-line');
        svg.appendChild(line);
    }

    // Axes
    const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxis.setAttribute('x1', padding);
    xAxis.setAttribute('y1', toY(0));
    xAxis.setAttribute('x2', width - padding);
    xAxis.setAttribute('y2', toY(0));
    xAxis.setAttribute('class', 'axis-line');
    svg.appendChild(xAxis);

    const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxis.setAttribute('x1', toX(0));
    yAxis.setAttribute('y1', padding);
    yAxis.setAttribute('x2', toX(0));
    yAxis.setAttribute('y2', height - padding);
    yAxis.setAttribute('class', 'axis-line');
    svg.appendChild(yAxis);

    // Axis labels
    for (let x = xMin; x <= xMax; x += gridStep) {
        if (x === 0) continue;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', toX(x));
        text.setAttribute('y', toY(0) + 15);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('class', 'axis-label');
        text.textContent = x;
        svg.appendChild(text);
    }
    for (let y = yMin; y <= yMax; y += gridStep) {
        if (y === 0) continue;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', toX(0) - 8);
        text.setAttribute('y', toY(y) + 4);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('class', 'axis-label');
        text.textContent = y;
        svg.appendChild(text);
    }

    // Draw lines/curves
    lines.forEach((lineData, idx) => {
        if (lineData.equation) {
            // y = mx + b format
            const { m, b } = lineData.equation;
            const pathPoints = [];
            for (let x = xMin; x <= xMax; x += 0.1) {
                const y = m * x + b;
                if (y >= yMin && y <= yMax) {
                    pathPoints.push([toX(x), toY(y)]);
                }
            }
            if (pathPoints.length > 1) {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M' + pathPoints.map(p => p.join(',')).join(' L'));
                path.setAttribute('class', 'graph-line' + (idx > 0 ? ' secondary' : ''));
                svg.appendChild(path);
            }
        } else if (lineData.points) {
            // Line through specific points
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = lineData.points.map((p, i) => (i === 0 ? 'M' : 'L') + toX(p.x) + ',' + toY(p.y)).join(' ');
            path.setAttribute('d', d);
            path.setAttribute('class', 'graph-line' + (idx > 0 ? ' secondary' : ''));
            svg.appendChild(path);
        }
    });

    // Draw curves (quadratic, etc.)
    curves.forEach((curveData, idx) => {
        const pathPoints = [];
        if (curveData.type === 'quadratic') {
            const { a, b, c } = curveData;
            for (let x = xMin; x <= xMax; x += 0.1) {
                const y = a*x*x + b*x + c;
                if (y >= yMin && y <= yMax) {
                    pathPoints.push([toX(x), toY(y)]);
                }
            }
        } else if (curveData.type === 'trig') {
            const { func, amplitude = 1, period = 2*Math.PI, phase = 0 } = curveData;
            for (let x = xMin; x <= xMax; x += 0.05) {
                let y;
                const angle = (2*Math.PI/period) * x + phase;
                if (func === 'sin') y = amplitude * Math.sin(angle);
                else if (func === 'cos') y = amplitude * Math.cos(angle);
                else if (func === 'tan') y = amplitude * Math.tan(angle);
                if (y >= yMin && y <= yMax && Math.abs(y) < 100) {
                    pathPoints.push([toX(x), toY(y)]);
                }
            }
        }
        if (pathPoints.length > 1) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M' + pathPoints.map(p => p.join(',')).join(' L'));
            path.setAttribute('class', 'graph-line');
            svg.appendChild(path);
        }
    });

    // Plot points
    points.forEach(p => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', toX(p.x));
        circle.setAttribute('cy', toY(p.y));
        circle.setAttribute('r', 5);
        circle.setAttribute('class', 'plot-point' + (p.interactive ? ' interactive' : ''));
        svg.appendChild(circle);

        if (p.label) {
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', toX(p.x) + 8);
            text.setAttribute('y', toY(p.y) - 8);
            text.setAttribute('class', 'point-label');
            text.textContent = p.label;
            svg.appendChild(text);
        }
    });

    // Interactive point placement
    if (mode === 'interactive' && data.targetPoint) {
        let placedPoint = null;

        svg.style.cursor = 'crosshair';
        svg.addEventListener('click', (e) => {
            const rect = svg.getBoundingClientRect();
            const scale = width / rect.width;
            const px = (e.clientX - rect.left) * scale;
            const py = (e.clientY - rect.top) * scale;

            const x = Math.round(xMin + ((px - padding) / plotWidth) * (xMax - xMin));
            const y = Math.round(yMax - ((py - padding) / plotHeight) * (yMax - yMin));

            if (x >= xMin && x <= xMax && y >= yMin && y <= yMax) {
                if (placedPoint) svg.removeChild(placedPoint);

                placedPoint = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                placedPoint.setAttribute('cx', toX(x));
                placedPoint.setAttribute('cy', toY(y));
                placedPoint.setAttribute('r', 6);
                placedPoint.setAttribute('class', 'plot-point interactive');
                svg.appendChild(placedPoint);

                setVisualAnswer({ x, y });
            }
        });
    }

    container.appendChild(svg);
}

function renderFractionVisual(container, data) {
    const { style = 'bar', numerator, denominator, compare = null } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-fraction-container';

    const createBar = (num, denom, label) => {
        const row = document.createElement('div');
        row.className = 'dojo-fraction-row';

        const bar = document.createElement('div');
        bar.className = 'dojo-fraction-bar';

        for (let i = 0; i < denom; i++) {
            const segment = document.createElement('div');
            segment.className = 'dojo-fraction-bar-segment' + (i < num ? ' filled' : '');
            bar.appendChild(segment);
        }

        row.appendChild(bar);

        if (label) {
            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-fraction-label';
            labelEl.textContent = label;
            row.appendChild(labelEl);
        }

        return row;
    };

    const createCircle = (num, denom, label) => {
        const row = document.createElement('div');
        row.className = 'dojo-fraction-row';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', 'dojo-fraction-circle');
        svg.setAttribute('viewBox', '0 0 100 100');

        for (let i = 0; i < denom; i++) {
            const startAngle = (i / denom) * 2 * Math.PI - Math.PI/2;
            const endAngle = ((i + 1) / denom) * 2 * Math.PI - Math.PI/2;
            const x1 = 50 + 40 * Math.cos(startAngle);
            const y1 = 50 + 40 * Math.sin(startAngle);
            const x2 = 50 + 40 * Math.cos(endAngle);
            const y2 = 50 + 40 * Math.sin(endAngle);
            const largeArc = (endAngle - startAngle > Math.PI) ? 1 : 0;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', `M50,50 L${x1},${y1} A40,40 0 ${largeArc},1 ${x2},${y2} Z`);
            path.setAttribute('class', 'slice' + (i < num ? ' filled' : ''));
            svg.appendChild(path);
        }

        row.appendChild(svg);

        if (label) {
            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-fraction-label';
            labelEl.textContent = label;
            row.appendChild(labelEl);
        }

        return row;
    };

    if (style === 'bar') {
        wrapper.appendChild(createBar(numerator, denominator, `${numerator}/${denominator}`));
        if (compare) {
            wrapper.appendChild(createBar(compare.numerator, compare.denominator, `${compare.numerator}/${compare.denominator}`));
        }
    } else {
        wrapper.appendChild(createCircle(numerator, denominator, `${numerator}/${denominator}`));
        if (compare) {
            wrapper.appendChild(createCircle(compare.numerator, compare.denominator, `${compare.numerator}/${compare.denominator}`));
        }
    }

    container.appendChild(wrapper);
}

function renderClockFace(container, data, mode) {
    const { hour = 12, minute = 0, interactive = false } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-clock-container';

    const canvas = document.createElement('canvas');
    canvas.className = 'dojo-clock-canvas';
    canvas.width = 160;
    canvas.height = 160;
    const ctx = canvas.getContext('2d');

    let currentHour = hour;
    let currentMinute = minute;
    let draggingHand = null;

    const drawClock = () => {
        const cx = 80, cy = 80, r = 70;

        ctx.clearRect(0, 0, 160, 160);

        // Clock face
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, 2 * Math.PI);
        ctx.fillStyle = '#334155';
        ctx.fill();
        ctx.strokeStyle = '#64748b';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Hour markers
        for (let i = 1; i <= 12; i++) {
            const angle = (i / 12) * 2 * Math.PI - Math.PI/2;
            const x = cx + (r - 15) * Math.cos(angle);
            const y = cy + (r - 15) * Math.sin(angle);
            ctx.fillStyle = '#e2e8f0';
            ctx.font = '12px Source Sans 3';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(i.toString(), x, y);
        }

        // Tick marks
        for (let i = 0; i < 60; i++) {
            const angle = (i / 60) * 2 * Math.PI - Math.PI/2;
            const inner = i % 5 === 0 ? r - 8 : r - 5;
            const outer = r - 2;
            ctx.beginPath();
            ctx.moveTo(cx + inner * Math.cos(angle), cy + inner * Math.sin(angle));
            ctx.lineTo(cx + outer * Math.cos(angle), cy + outer * Math.sin(angle));
            ctx.strokeStyle = i % 5 === 0 ? '#94a3b8' : '#64748b';
            ctx.lineWidth = i % 5 === 0 ? 2 : 1;
            ctx.stroke();
        }

        // Hour hand
        const hourAngle = ((currentHour % 12) / 12 + currentMinute / 720) * 2 * Math.PI - Math.PI/2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + 35 * Math.cos(hourAngle), cy + 35 * Math.sin(hourAngle));
        ctx.strokeStyle = '#f59e0b';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        ctx.stroke();

        // Minute hand
        const minuteAngle = (currentMinute / 60) * 2 * Math.PI - Math.PI/2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.lineTo(cx + 50 * Math.cos(minuteAngle), cy + 50 * Math.sin(minuteAngle));
        ctx.strokeStyle = '#22d3ee';
        ctx.lineWidth = 3;
        ctx.stroke();

        // Center dot
        ctx.beginPath();
        ctx.arc(cx, cy, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#f1f5f9';
        ctx.fill();
    };

    drawClock();
    wrapper.appendChild(canvas);

    // Time display
    const display = document.createElement('div');
    display.className = 'dojo-clock-display';
    display.textContent = `${currentHour}:${currentMinute.toString().padStart(2, '0')}`;
    wrapper.appendChild(display);

    // Interactive mode
    if (mode === 'interactive') {
        const updateTime = (clientX, clientY) => {
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left - 80;
            const y = clientY - rect.top - 80;
            let angle = Math.atan2(y, x) + Math.PI/2;
            if (angle < 0) angle += 2 * Math.PI;

            if (draggingHand === 'minute') {
                currentMinute = Math.round((angle / (2 * Math.PI)) * 60) % 60;
            } else if (draggingHand === 'hour') {
                currentHour = Math.round((angle / (2 * Math.PI)) * 12) || 12;
            }

            drawClock();
            display.textContent = `${currentHour}:${currentMinute.toString().padStart(2, '0')}`;
            setVisualAnswer({ hour: currentHour, minute: currentMinute });
        };

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left - 80;
            const y = e.clientY - rect.top - 80;
            const dist = Math.sqrt(x*x + y*y);

            if (dist < 45) draggingHand = 'hour';
            else draggingHand = 'minute';

            updateTime(e.clientX, e.clientY);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (draggingHand) updateTime(e.clientX, e.clientY);
        });

        canvas.addEventListener('mouseup', () => { draggingHand = null; });
        canvas.addEventListener('mouseleave', () => { draggingHand = null; });

        // Touch events
        canvas.addEventListener('touchstart', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.touches[0].clientX - rect.left - 80;
            const y = e.touches[0].clientY - rect.top - 80;
            const dist = Math.sqrt(x*x + y*y);
            draggingHand = dist < 45 ? 'hour' : 'minute';
            updateTime(e.touches[0].clientX, e.touches[0].clientY);
        });

        canvas.addEventListener('touchmove', (e) => {
            if (draggingHand) {
                e.preventDefault();
                updateTime(e.touches[0].clientX, e.touches[0].clientY);
            }
        });

        canvas.addEventListener('touchend', () => { draggingHand = null; });

        setVisualAnswer({ hour: currentHour, minute: currentMinute });
    }

    container.appendChild(wrapper);
}

function renderChart(container, data) {
    const { type = 'bar', labels = [], values = [], icon = null } = data;

    const wrapper = document.createElement('div');
    wrapper.className = 'dojo-chart-container';

    if (type === 'bar') {
        const chart = document.createElement('div');
        chart.className = 'dojo-bar-chart';

        const maxVal = Math.max(...values, 1);

        labels.forEach((label, i) => {
            const bar = document.createElement('div');
            bar.className = 'dojo-bar';

            const value = document.createElement('div');
            value.className = 'dojo-bar-value';
            value.textContent = values[i];
            bar.appendChild(value);

            const fill = document.createElement('div');
            fill.className = 'dojo-bar-fill';
            fill.style.height = (values[i] / maxVal * 100) + 'px';
            bar.appendChild(fill);

            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-bar-label';
            labelEl.textContent = label;
            bar.appendChild(labelEl);

            chart.appendChild(bar);
        });

        wrapper.appendChild(chart);
    } else if (type === 'line') {
        const chart = document.createElement('div');
        chart.className = 'dojo-line-chart';

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', '0 0 300 120');

        const maxVal = Math.max(...values, 1);
        const points = values.map((v, i) => {
            const x = 20 + (i / (values.length - 1 || 1)) * 260;
            const y = 100 - (v / maxVal) * 80;
            return [x, y];
        });

        // Line
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M' + points.map(p => p.join(',')).join(' L'));
        path.setAttribute('class', 'chart-line');
        svg.appendChild(path);

        // Points
        points.forEach(([x, y], i) => {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 4);
            circle.setAttribute('class', 'chart-point');
            svg.appendChild(circle);
        });

        chart.appendChild(svg);
        wrapper.appendChild(chart);
    } else if (type === 'picture') {
        const chart = document.createElement('div');
        chart.className = 'dojo-picture-chart';

        labels.forEach((label, i) => {
            const row = document.createElement('div');
            row.className = 'dojo-picture-row';

            const labelEl = document.createElement('div');
            labelEl.className = 'dojo-picture-row-label';
            labelEl.textContent = label;
            row.appendChild(labelEl);

            const icons = document.createElement('div');
            icons.className = 'dojo-picture-icons';
            icons.textContent = (icon || '★').repeat(values[i]);
            row.appendChild(icons);

            chart.appendChild(row);
        });

        wrapper.appendChild(chart);
    }

    container.appendChild(wrapper);
}

function renderQuestion() {
    const q = state.currentQuestion;
    document.getElementById('tag-tier').textContent = `Tier ${q.tier}`;
    document.getElementById('tag-domain').textContent = q.domain;
    document.getElementById('tag-type').textContent = q.type;

    const meta = document.getElementById('question-meta');
    meta.querySelectorAll('.tag-probe, .tag-practice').forEach(e => e.remove());
    if (state.probeMode) { const t = document.createElement('span'); t.className = 'question-tag tag-probe'; t.textContent = 'GAP PROBE'; meta.appendChild(t); }
    if (state.mode === 'testing') { const t = document.createElement('span'); t.className = 'question-tag tag-practice'; t.textContent = 'PRACTICE'; meta.appendChild(t); }

    document.getElementById('question-text').textContent = q.question;

    // Render visual if present
    renderVisual(q.visual || null);

    // Reset visual state
    state.selectedAnswer = null;

    const opts = document.getElementById('answer-options');
    opts.innerHTML = '';

    // For interactive visuals, hide multiple choice options
    if (q.visual && q.visual.mode === 'interactive') {
        // Don't show multiple choice options for interactive visuals
    } else {
        ['A','B','C','D'].forEach((l, i) => {
            if (i < q.options.length) {
                const div = document.createElement('div');
                div.className = 'answer-option';
                div.onclick = () => selectAnswer(i);
                div.innerHTML = `<span class="option-letter">${l}</span><span>${q.options[i]}</span>`;
                opts.appendChild(div);
            }
        });
    }

    document.getElementById('explanation-box').classList.remove('show');
    document.getElementById('submit-btn').style.display = 'inline-flex';
    document.getElementById('submit-btn').disabled = !state.visualInteractive;
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('feedback').classList.remove('show', 'correct', 'incorrect');

    // Show IDK button only in placement mode
    if (state.mode === 'placement') {
        document.getElementById('idk-btn').style.display = 'inline-flex';
    }
}

function selectAnswer(i) {
    if (document.getElementById('next-btn').style.display !== 'none') return;
    state.selectedAnswer = i;
    document.querySelectorAll('.answer-option').forEach((o, idx) => o.classList.toggle('selected', idx === i));
    document.getElementById('submit-btn').disabled = false;
}

function startTimer() {
    state.startTime = Date.now();
    state.elapsedTime = 0;
    const fill = document.getElementById('timer-fill');
    fill.style.width = '0%';
    fill.classList.remove('slow');
    if (state.timerInterval) clearInterval(state.timerInterval);
    state.timerInterval = setInterval(() => {
        state.elapsedTime = (Date.now() - state.startTime) / 1000;
        document.getElementById('timer-display').textContent = state.elapsedTime.toFixed(1) + 's';
        const pct = Math.min((state.elapsedTime / (state.currentQuestion.timeExpected * 2)) * 100, 100);
        fill.style.width = pct + '%';
        if (state.elapsedTime > state.currentQuestion.timeExpected) fill.classList.add('slow');
    }, 100);
}

function stopTimer() { if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; } return state.elapsedTime; }

function updateProgress() {
    document.getElementById('question-number').textContent = state.history.length + 1;
    document.getElementById('correct-count').textContent = state.history.filter(h => h.correct).length;
    document.getElementById('current-tier-display').textContent = `Tier ${state.currentQuestion.tier} — ${TIERS[state.currentQuestion.tier].name}`;
    
    if (state.mode === 'testing' && state.history.length > 0) {
        const c = state.history.filter(h => h.correct).length;
        const acc = Math.round((c / state.history.length) * 100);
        const avg = (state.history.reduce((s, h) => s + h.time, 0) / state.history.length).toFixed(1);
        document.getElementById('tc-accuracy').textContent = acc + '%';
        document.getElementById('tc-accuracy').className = `stat-value ${acc >= 70 ? 'good' : acc >= 50 ? 'medium' : 'poor'}`;
        document.getElementById('tc-avg-time').textContent = avg + 's';
        document.getElementById('tc-streak').textContent = state.currentStreak;
    }
}

function submitAnswer() {
    const time = stopTimer();
    const q = state.currentQuestion;

    // Determine correctness based on visual or multiple choice
    let correct;
    let correctAnswerDisplay;

    if (q.visual && q.visual.mode === 'interactive') {
        // Visual interactive answer
        const visualTarget = q.visual.data.target;
        correct = compareVisualAnswer(state.visualAnswer, visualTarget, state.visualType);
        correctAnswerDisplay = formatVisualAnswer(visualTarget, state.visualType);
    } else {
        // Standard multiple choice
        correct = state.selectedAnswer === q.answerIndex;
        correctAnswerDisplay = q.options[q.answerIndex];
    }

    const fast = time <= q.timeExpected * 0.7;
    const slow = time > q.timeExpected * 1.5;

    state.history.push({ tier: q.tier, domain: q.domain, type: q.type, question: q.question, correct, time, fast, slow });

    // Record for batched session tracking
    recordQuestionResult(q.domain, q.tier, correct, time);

    const ts = state.tierScores[q.tier];
    ts.total++;
    if (correct) ts.correct++;
    ts.times.push(time);

    // Track domain scores
    if (!state.domainScores[q.tier][q.domain]) {
        state.domainScores[q.tier][q.domain] = { correct: 0, total: 0 };
    }
    state.domainScores[q.tier][q.domain].total++;
    if (correct) state.domainScores[q.tier][q.domain].correct++;

    // Send progress update to Skill Tree
    const ds = state.domainScores[q.tier][q.domain];
    sendSkillProgress(q.domain, q.tier, ds.correct, ds.total, time);

    state.currentStreak = correct ? state.currentStreak + 1 : 0;

    const fb = document.getElementById('feedback');
    fb.classList.add('show');
    if (correct) {
        fb.className = 'feedback show correct';
        fb.textContent = fast ? '✓ Correct! (Fast)' : slow ? '✓ Correct (Slow)' : '✓ Correct!';
    } else {
        fb.className = 'feedback show incorrect';
        fb.textContent = `✗ Incorrect. Answer: ${correctAnswerDisplay}`;
        if (!state.gapLog.find(g => g.tier === q.tier && g.domain === q.domain))
            state.gapLog.push({ tier: q.tier, domain: q.domain, type: q.type });
    }

    // Highlight correct/incorrect for multiple choice
    if (!(q.visual && q.visual.mode === 'interactive')) {
        document.querySelectorAll('.answer-option').forEach((o, i) => {
            if (i === q.answerIndex) o.classList.add('correct');
            else if (i === state.selectedAnswer && !correct) o.classList.add('incorrect');
        });
    }

    if (state.mode === 'testing' && q.explanation) {
        document.getElementById('explanation-text').textContent = q.explanation;
        document.getElementById('explanation-box').classList.add('show');
    }

    if (state.mode === 'placement') adaptTier(correct, fast, slow);

    document.getElementById('idk-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-flex';
    updateProgress();
}

function formatVisualAnswer(value, type) {
    if (type === 'clock') {
        return `${value.hour}:${value.minute.toString().padStart(2, '0')}`;
    }
    if (type === 'coordinate') {
        return `(${value.x}, ${value.y})`;
    }
    return value;
}

function adaptTier(correct, fast, slow) {
    if (correct) {
        state.consecutiveCorrect++;
        state.consecutiveWrong = 0;
        if (fast && state.consecutiveCorrect >= 2) { state.currentTier = Math.min(state.currentTier + 1, 10); state.consecutiveCorrect = 0; }
        else if (!slow && state.consecutiveCorrect >= 3) { state.currentTier = Math.min(state.currentTier + 1, 10); state.consecutiveCorrect = 0; }
    } else {
        state.consecutiveWrong++;
        state.consecutiveCorrect = 0;
        if (state.consecutiveWrong >= 2) { state.currentTier = Math.max(state.currentTier - 1, 1); state.consecutiveWrong = 0; }
    }
}

function submitIDK() {
    const time = stopTimer();
    const q = state.currentQuestion;
    
    // Record as unknown (counts as incorrect for placement purposes)
    state.history.push({ 
        tier: q.tier, 
        domain: q.domain, 
        type: q.type, 
        question: q.question, 
        correct: false, 
        time: time, 
        fast: false, 
        slow: false,
        idk: true  // Mark as IDK
    });
    
    const ts = state.tierScores[q.tier];
    ts.total++; 
    // Don't increment correct - it's unknown
    ts.times.push(time);
    
    // Track domain scores
    if (!state.domainScores[q.tier][q.domain]) {
        state.domainScores[q.tier][q.domain] = { correct: 0, total: 0, idk: 0 };
    }
    state.domainScores[q.tier][q.domain].total++;
    state.domainScores[q.tier][q.domain].idk = (state.domainScores[q.tier][q.domain].idk || 0) + 1;

    // Send progress update to Skill Tree (IDK counts as incorrect)
    const ds = state.domainScores[q.tier][q.domain];
    sendSkillProgress(q.domain, q.tier, ds.correct, ds.total, time);

    // Log as gap immediately
    if (!state.gapLog.find(g => g.tier === q.tier && g.domain === q.domain))
        state.gapLog.push({ tier: q.tier, domain: q.domain, type: q.type, idk: true });
    
    // Show brief feedback
    const fb = document.getElementById('feedback');
    fb.className = 'feedback show incorrect';
    fb.textContent = `Skipped — Answer was: ${q.options[q.answerIndex]}`;
    fb.classList.add('show');
    
    // Show correct answer
    document.querySelectorAll('.answer-option').forEach((o, i) => {
        if (i === q.answerIndex) o.classList.add('correct');
    });
    
    // IDK counts as wrong for tier adaptation (more aggressive drop)
    state.consecutiveWrong++;
    state.consecutiveCorrect = 0;
    state.currentStreak = 0;
    
    // Drop tier immediately on IDK (they clearly don't know this level)
    if (state.consecutiveWrong >= 1) { 
        state.currentTier = Math.max(state.currentTier - 1, 1); 
        state.consecutiveWrong = 0; 
    }
    
    // Hide IDK and submit, show next
    document.getElementById('idk-btn').style.display = 'none';
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-flex';
    
    updateProgress();
}

function nextQuestion() { loadQuestion(); }

function endTest() {
    stopTimer();

    // End session tracking and send batched update
    endSessionTracking();

    const placement = calculatePlacement();
    document.getElementById('test-screen').classList.remove('active');
    document.getElementById('results-screen').classList.add('active');
    document.getElementById('results-screen').classList.toggle('testing-center-results', state.mode === 'testing');
    document.getElementById('results-title').textContent = state.mode === 'placement' ? 'Belt Test Results' : 'Practice Results';
    renderResults(placement);

    // Apply belt test results to skill tree (for placement mode)
    if (state.mode === 'placement') {
        const treeResults = applyBeltTestToTree();

        // Show tree sync results
        const treeSyncCard = document.getElementById('tree-sync-card');
        const treeSyncContainer = document.getElementById('tree-sync-results');

        if (treeResults.totalSkillsUpdated > 0) {
            treeSyncCard.style.display = 'block';
            treeSyncContainer.innerHTML = renderBeltTestTreeResults(treeResults);

            // Show notification
            const masteredCount = treeResults.mastered.length + treeResults.inferred.filter(s => s.newState === 'mastered').length;
            if (masteredCount > 0) {
                showNotification(`🎉 ${masteredCount} skills mastered!`);
            }
        } else {
            treeSyncCard.style.display = 'none';
        }
    } else {
        // Hide tree sync card for non-placement modes
        document.getElementById('tree-sync-card').style.display = 'none';
    }

    // Send full session results to Skill Tree
    sendSessionResults();
}

function calculatePlacement() {
    let best = 1;
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total >= 2 && s.correct / s.total >= 0.6) best = t;
    }
    const relevant = state.history.filter(h => h.tier <= best + 1);
    const fastCorrect = relevant.filter(h => h.fast && h.correct).length;
    let fluency = 'Normal';
    if (relevant.length > 0) {
        const ratio = fastCorrect / relevant.length;
        if (ratio >= 0.6) fluency = 'Automatic';
        else if (ratio <= 0.2) fluency = 'Slow';
    }
    const tc = state.history.filter(h => h.correct).length;
    const avg = state.history.length > 0 ? state.history.reduce((s, h) => s + h.time, 0) / state.history.length : 0;
    return { tier: best, fluency, total: state.history.length, correct: tc, accuracy: state.history.length > 0 ? Math.round(tc / state.history.length * 100) : 0, avgTime: avg.toFixed(1) };
}

function renderResults(p) {
    document.getElementById('result-tier-number').textContent = p.tier;
    document.getElementById('result-tier-title').textContent = TIERS[p.tier].name;
    document.getElementById('result-tier-grades').textContent = `Grades ${TIERS[p.tier].grades}`;
    const fb = document.getElementById('fluency-badge');
    fb.textContent = p.fluency + ' Fluency';
    fb.className = `fluency-badge fluency-${p.fluency.toLowerCase()}`;
    document.getElementById('stat-total').textContent = p.total;
    document.getElementById('stat-correct').textContent = p.correct;
    document.getElementById('stat-idk').textContent = state.history.filter(h => h.idk).length;
    document.getElementById('stat-accuracy').textContent = p.accuracy + '%';
    
    const bd = document.getElementById('tier-breakdown');
    bd.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const s = state.tierScores[t];
        if (s.total === 0) continue;
        const acc = Math.round(s.correct / s.total * 100);
        const cls = acc >= 70 ? 'good' : acc >= 50 ? 'medium' : 'poor';
        bd.innerHTML += `<div class="tier-row"><span class="tier-label">T${t}: ${TIERS[t].name}</span><div class="tier-bar"><div class="tier-fill ${cls}" style="width:${acc}%"></div></div><span class="tier-score">${s.correct}/${s.total}</span></div>`;
    }
    
    const gl = document.getElementById('gap-log');
    if (state.gapLog.length === 0) gl.innerHTML = '<div class="no-gaps">✓ No gaps identified</div>';
    else gl.innerHTML = state.gapLog.map(g => `<div class="gap-item${g.idk ? ' idk' : ''}"><span class="gap-tier">T${g.tier}</span><span class="gap-skill">${g.domain} (${g.type})${g.idk ? ' — Unknown' : ''}</span></div>`).join('');
    
    const recs = document.getElementById('recommendations');
    recs.innerHTML = `<div class="rec-item"><div class="rec-icon">📍</div><div class="rec-content"><h4>Placement: Tier ${p.tier} — ${TIERS[p.tier].name}</h4><p>Ready for Grades ${TIERS[p.tier].grades} content. Domains: ${TIERS[p.tier].domains.slice(0,3).join(', ')}</p></div></div>`;
    if (p.fluency === 'Slow') recs.innerHTML += `<div class="rec-item"><div class="rec-icon">⏱️</div><div class="rec-content"><h4>Focus on Fluency</h4><p>Practice timed drills to build automaticity.</p></div></div>`;
    else if (p.fluency === 'Automatic') recs.innerHTML += `<div class="rec-item"><div class="rec-icon">⚡</div><div class="rec-content"><h4>Strong Fluency</h4><p>Quick responses indicate solid automaticity. Consider advancing.</p></div></div>`;
    if (state.gapLog.length > 0) {
        const idkGaps = state.gapLog.filter(g => g.idk);
        const wrongGaps = state.gapLog.filter(g => !g.idk);
        if (idkGaps.length > 0) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">❓</div><div class="rec-content"><h4>Topics to Learn</h4><p>New material needed: ${idkGaps.slice(0,3).map(g => `${g.domain} (Tier ${g.tier})`).join(', ')}</p></div></div>`;
        if (wrongGaps.length > 0) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">🔧</div><div class="rec-content"><h4>Topics to Review</h4><p>Review: ${wrongGaps.slice(0,3).map(g => `${g.domain} (Tier ${g.tier})`).join(', ')}</p></div></div>`;
    }
    if (p.tier < 10) recs.innerHTML += `<div class="rec-item"><div class="rec-icon">📈</div><div class="rec-content"><h4>Next Level</h4><p>To advance to Tier ${p.tier + 1} (${TIERS[p.tier + 1].name}), master: ${TIERS[p.tier + 1].domains.slice(0,3).join(', ')}</p></div></div>`;
    
    const hist = document.getElementById('question-history');
    hist.innerHTML = state.history.map((h, i) => `<div class="history-item ${h.correct ? 'correct' : h.idk ? 'idk' : 'incorrect'}"><span class="q-number">${i+1}</span><span class="q-text">${h.idk ? '❓ ' : ''}${h.question}</span><span class="q-time">${h.time.toFixed(1)}s</span><span class="q-tier">T${h.tier}${h.idk ? ' IDK' : ''}</span></div>`).join('');
}

// ========================================
// LEARNING CENTER FUNCTIONS
// ========================================

function initLearningSetup() {
    // Create tier selection buttons
    const tierSelect = document.getElementById('learning-tier-select');
    tierSelect.innerHTML = '';
    for (let t = 1; t <= 10; t++) {
        const btn = document.createElement('button');
        btn.className = 'tier-select-btn' + (t === 1 ? ' selected' : '');
        btn.textContent = `T${t}`;
        btn.title = `Tier ${t}: ${TIERS[t].name}`;
        btn.onclick = () => selectLearningTier(t);
        tierSelect.appendChild(btn);
    }
    state.learningTier = 1;
    updateSkillGrid();
}

function selectLearningTier(tier) {
    state.learningTier = tier;
    state.learningSkill = null;
    document.querySelectorAll('.tier-select-btn').forEach((btn, i) => {
        btn.classList.toggle('selected', i + 1 === tier);
    });
    updateSkillGrid();
    document.getElementById('start-learning-btn').disabled = true;
}

function updateSkillGrid() {
    const grid = document.getElementById('skill-grid');
    const domains = TIERS[state.learningTier].domains;
    grid.innerHTML = '';
    domains.forEach(skill => {
        const card = document.createElement('div');
        const skillState = getSkillState(skill);
        const isUnlocked = isSkillUnlocked(skill);
        const mastery = getSkillMastery(skill);

        card.className = 'skill-card';

        // Add state-based styling
        if (!isUnlocked) {
            card.classList.add('locked');
        } else if (skillState === 'mastered') {
            card.classList.add('mastered');
        } else if (skillState === 'activated' || skillState === 'in_progress') {
            card.classList.add('in-progress');
        } else if (skillState === 'needs_review') {
            card.classList.add('needs-review');
        }

        // Build card content
        let cardContent = `<div class="skill-name">${skill}</div>`;

        // Show mastery indicator for unlocked skills
        if (isUnlocked && mastery > 0) {
            cardContent += `<div class="skill-mastery-bar"><div class="skill-mastery-fill" style="width: ${mastery}%"></div></div>`;
        }

        // Show lock icon and prerequisites for locked skills
        if (!isUnlocked) {
            const prereqs = getSkillPrerequisites(skill);
            cardContent += `<div class="skill-lock-icon">🔒</div>`;
            if (prereqs.length > 0) {
                const prereqList = prereqs.slice(0, 2).join(', ') + (prereqs.length > 2 ? '...' : '');
                cardContent += `<div class="skill-prereq-hint">Master: ${prereqList}</div>`;
            }
        }

        // Show state badges
        if (skillState === 'mastered') {
            cardContent += `<div class="skill-badge mastered">✓ Mastered</div>`;
        } else if (skillState === 'needs_review') {
            cardContent += `<div class="skill-badge needs-review">⟳ Review</div>`;
        }

        card.innerHTML = cardContent;

        // Only make clickable if unlocked
        if (isUnlocked) {
            card.onclick = () => selectSkill(skill);
        } else {
            card.onclick = () => showLockedSkillInfo(skill);
        }

        grid.appendChild(card);
    });
}

// Show info modal for locked skills
function showLockedSkillInfo(skill) {
    const prereqs = getSkillPrerequisites(skill);
    const prereqStatuses = prereqs.map(p => {
        const state = getSkillState(p);
        const mastery = getSkillMastery(p);
        const isMastered = ['mastered', 'activated', 'needs_review'].includes(state);
        return { name: p, mastered: isMastered, mastery, state };
    });

    let message = `To unlock "${skill}", you need to master:\n\n`;
    prereqStatuses.forEach(p => {
        const status = p.mastered ? '✓' : '○';
        const masteryText = p.mastery > 0 ? ` (${p.mastery}%)` : '';
        message += `${status} ${p.name}${masteryText}\n`;
    });

    alert(message);
}

function selectSkill(skill) {
    // Verify skill is unlocked
    if (!isSkillUnlocked(skill)) {
        showLockedSkillInfo(skill);
        return;
    }

    state.learningSkill = skill;
    document.querySelectorAll('.skill-card').forEach(card => {
        const cardSkill = card.querySelector('.skill-name').textContent;
        card.classList.toggle('selected', cardSkill === skill);
    });
    document.getElementById('start-learning-btn').disabled = false;

    // Notify tree to highlight this skill
    requestTreeHighlight(skill);
}

function startLearning() {
    state.learningPhase = 'learn';
    state.currentLesson = generateLesson(state.learningTier, state.learningSkill);
    state.guidedStep = 0;
    state.practiceAttempts = 0;
    state.practiceCorrect = 0;

    if (!state.currentLesson) {
        // Lesson not available - just return silently (button should be disabled)
        return;
    }

    // Start session tracking for batched updates
    startSessionTracking('learning');

    document.getElementById('learning-setup-screen').classList.remove('active');
    document.getElementById('learning-screen').classList.add('active');

    // Update header
    document.getElementById('learning-tier-badge').textContent = `Tier ${state.learningTier}`;
    document.getElementById('learning-skill-name').textContent = state.learningSkill;

    renderLearningPhase();
}

function renderLearningPhase() {
    const lesson = state.currentLesson;
    
    // Update phase indicators
    document.querySelectorAll('.phase-dot').forEach(dot => {
        const phase = dot.dataset.phase;
        dot.classList.remove('active', 'completed');
        if (phase === state.learningPhase) dot.classList.add('active');
        else if ((phase === 'learn' && state.learningPhase !== 'learn') || 
                 (phase === 'guided' && state.learningPhase === 'practice')) {
            dot.classList.add('completed');
        }
    });
    document.querySelectorAll('.phase-label').forEach(label => {
        label.classList.toggle('active', label.dataset.phase === state.learningPhase);
    });
    document.querySelectorAll('.phase-line').forEach((line, i) => {
        line.classList.toggle('completed', 
            (i === 0 && state.learningPhase !== 'learn') ||
            (i === 1 && state.learningPhase === 'practice'));
    });
    
    // Hide all phases
    document.querySelectorAll('.phase-content').forEach(p => p.classList.remove('active'));
    
    if (state.learningPhase === 'learn') {
        renderLearnPhase(lesson);
        document.getElementById('phase-learn').classList.add('active');
        document.getElementById('learning-continue-btn').textContent = 'Continue to Guided Practice →';
        document.getElementById('learning-continue-btn').style.display = 'inline-flex';
    } else if (state.learningPhase === 'guided') {
        renderGuidedPhase(lesson);
        document.getElementById('phase-guided').classList.add('active');
        document.getElementById('learning-continue-btn').style.display = 'none';
    } else if (state.learningPhase === 'practice') {
        renderPracticePhase(lesson);
        document.getElementById('phase-practice').classList.add('active');
        document.getElementById('learning-continue-btn').style.display = 'none';
    }
}

function renderLearnPhase(lesson) {
    // Reset step reveal state
    state.currentConceptStep = 0;
    state.totalConceptSteps = lesson.teachingSteps ? lesson.teachingSteps.length : 0;

    // Check if lesson has new step-by-step format
    if (lesson.teachingSteps && lesson.teachingSteps.length > 0) {
        // New step-by-step format
        document.getElementById('goal-problem-text').innerHTML = lesson.goalProblem || lesson.example.problem;

        // Build concept steps HTML (all hidden initially)
        document.getElementById('concept-steps').innerHTML = lesson.teachingSteps.map((step, i) =>
            `<div class="concept-step" id="concept-step-${i}">
                <div class="step-header">
                    <span class="step-number">${i + 1}</span>
                    <span class="step-title">${step.title}</span>
                    <button class="read-aloud-btn step-read-btn" onclick="readConceptStep(${i}, this)" title="Read aloud">
                        <span class="speaker-icon">🔊</span> Read
                    </button>
                </div>
                <div class="step-explanation">${step.explanation}</div>
                ${step.visual ? `<div class="step-visual">${step.visual}</div>` : ''}
            </div>`
        ).join('');

        // Set up final answer
        document.getElementById('answer-text').innerHTML = lesson.finalAnswer || lesson.example.steps[lesson.example.steps.length - 1]?.math || '';
        document.getElementById('answer-explanation').innerHTML = lesson.answerExplanation || '';

        // Reset visibility
        document.getElementById('final-answer').classList.remove('visible');

        // Get or recreate button container if needed
        let btnContainer = document.getElementById('reveal-btn-container');
        let btn = document.getElementById('reveal-next-btn');

        // If button doesn't exist (was removed), recreate it
        if (!btn || !btnContainer) {
            btnContainer = document.createElement('div');
            btnContainer.id = 'reveal-btn-container';
            btnContainer.innerHTML = `<button class="concept-reveal-btn" id="reveal-next-btn" onclick="revealNextConceptStep()">
                <span class="btn-icon">👉</span>
                <span>Show Next Step</span>
            </button>`;
            btn = btnContainer.querySelector('#reveal-next-btn');
        }

        btn.style.display = 'flex';
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">👉</span><span>Show Next Step</span>';
        btn.onclick = revealNextConceptStep;

        // Move button container back to after concept-steps
        document.getElementById('concept-steps').insertAdjacentElement('afterend', btnContainer);

        document.getElementById('key-points-section').style.display = 'none';
        document.getElementById('mistakes-section').style.display = 'none';

        // Reveal first step automatically
        setTimeout(() => revealNextConceptStep(), 300);
    } else {
        // Fallback to old format - show everything at once
        document.getElementById('goal-problem-text').innerHTML = lesson.example.problem;

        // Convert old format to steps
        const steps = lesson.example.steps.map((step, i) => ({
            title: step.text,
            explanation: '',
            visual: step.math
        }));

        document.getElementById('concept-steps').innerHTML = steps.map((step, i) =>
            `<div class="concept-step visible" id="concept-step-${i}">
                <div class="step-header">
                    <span class="step-number">${i + 1}</span>
                    <span class="step-title">${step.title}</span>
                    <button class="read-aloud-btn step-read-btn" onclick="readConceptStepOld(${i}, this)" title="Read aloud">
                        <span class="speaker-icon">🔊</span> Read
                    </button>
                </div>
                ${step.visual ? `<div class="step-visual">${step.visual}</div>` : ''}
            </div>`
        ).join('');

        // Show answer immediately
        document.getElementById('answer-text').innerHTML = lesson.example.steps[lesson.example.steps.length - 1]?.math || '';
        document.getElementById('answer-explanation').innerHTML = '';
        document.getElementById('final-answer').classList.add('visible');
        document.getElementById('reveal-next-btn').style.display = 'none';

        // Show key points and mistakes
        document.getElementById('key-points-section').style.display = 'block';
        document.getElementById('mistakes-section').style.display = 'block';
    }

    // Key points
    document.getElementById('key-points-list').innerHTML = lesson.keyPoints.map(p => `<li>${p}</li>`).join('');

    // Common mistakes
    document.getElementById('common-mistakes-list').innerHTML = lesson.mistakes.map(m =>
        `<div class="mistake-item"><div class="mistake-wrong">✗ ${m.wrong}</div><div class="mistake-why">→ ${m.why}</div></div>`
    ).join('');
}

function revealNextConceptStep() {
    const lesson = state.currentLesson;
    const currentStep = state.currentConceptStep;
    const totalSteps = state.totalConceptSteps;
    const btnContainer = document.getElementById('reveal-btn-container');
    const btn = document.getElementById('reveal-next-btn');

    if (currentStep < totalSteps) {
        // Reveal the next step
        const stepEl = document.getElementById(`concept-step-${currentStep}`);
        if (stepEl) {
            stepEl.classList.add('visible');

            // Move button container right after this step
            stepEl.insertAdjacentElement('afterend', btnContainer);

            // Scroll the button into view smoothly
            setTimeout(() => {
                btnContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }
        state.currentConceptStep++;

        // Update button text
        if (state.currentConceptStep >= totalSteps) {
            btn.innerHTML = '<span class="btn-icon">🎯</span><span>Show the Answer!</span>';
        } else {
            btn.innerHTML = `<span class="btn-icon">👉</span><span>Next Step (${state.currentConceptStep + 1}/${totalSteps})</span>`;
        }
    } else {
        // All steps revealed, show the answer
        const finalAnswer = document.getElementById('final-answer');
        finalAnswer.classList.add('visible');

        // Move button after final answer and update it
        finalAnswer.insertAdjacentElement('afterend', btnContainer);
        btn.innerHTML = '<span class="btn-icon">✅</span><span>Continue to Guided Practice →</span>';
        btn.onclick = nextLearningPhase;

        // Scroll to final answer
        setTimeout(() => {
            finalAnswer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);

        // Show key points and mistakes after a short delay
        setTimeout(() => {
            document.getElementById('key-points-section').style.display = 'block';
            document.getElementById('mistakes-section').style.display = 'block';
        }, 500);
    }
}

function renderGuidedPhase(lesson) {
    const guided = lesson.guided;

    // Initialize guided state
    state.guidedCurrentStep = 0;
    state.guidedSteps = guided.interactiveSteps || generateInteractiveSteps(guided, lesson);
    state.guidedAttempts = 0;

    // Set problem text
    document.getElementById('guided-problem').innerHTML = guided.problem;

    // Set total steps
    const totalSteps = state.guidedSteps.length;
    document.getElementById('guided-total-steps').textContent = totalSteps;
    document.getElementById('guided-current-step').textContent = '1';

    // Create progress dots
    document.getElementById('guided-progress-dots').innerHTML = state.guidedSteps.map((_, i) =>
        `<div class="dot ${i === 0 ? 'current' : ''}"></div>`
    ).join('');

    // Clear completed steps
    document.getElementById('guided-completed-steps').innerHTML = '';

    // Show completion area as hidden
    document.getElementById('guided-completion').style.display = 'none';
    document.getElementById('guided-current-step-area').style.display = 'block';

    // Render first step
    renderGuidedStep();
}

// Generate interactive steps from the old format
function generateInteractiveSteps(guided, lesson) {
    const steps = [];
    const mistakes = lesson.mistakes || [];

    // Convert old guided.steps to interactive format
    guided.steps.forEach((step, i) => {
        const isLast = i === guided.steps.length - 1;
        if (isLast) {
            // Last step is always user input for final answer
            steps.push({
                prompt: guided.answerLabel || step.label,
                hint: `Look at the previous steps to find the answer`,
                answer: guided.answer,
                acceptableAnswers: [guided.answer],
                commonMistakes: buildMistakeMap(guided.answer, mistakes, lesson)
            });
        } else if (step.value && step.value !== '?') {
            // Create fill-in step for intermediate values
            const answerValue = extractAnswer(step.value);
            if (answerValue && i > 0) { // Skip first step (usually just setup)
                steps.push({
                    prompt: step.label,
                    hint: `Calculate: ${guided.steps[i-1]?.value || 'using what you know'}`,
                    answer: answerValue,
                    acceptableAnswers: [answerValue],
                    showWork: guided.steps.slice(0, i).map(s => `${s.label}: ${s.value}`),
                    commonMistakes: {}
                });
            }
        }
    });

    // If no steps were generated, create at least the final answer step
    if (steps.length === 0) {
        steps.push({
            prompt: guided.answerLabel || 'Final Answer',
            hint: 'Use the information given to solve the problem',
            answer: guided.answer,
            acceptableAnswers: [guided.answer],
            commonMistakes: buildMistakeMap(guided.answer, mistakes, lesson)
        });
    }

    return steps;
}

// Extract a numeric or simple answer from a step value
function extractAnswer(value) {
    if (!value || value === '?') return null;
    // Try to extract the last number or simple expression
    const match = value.match(/=\s*([^=]+)$/) || value.match(/(\d+(?:\.\d+)?(?:\/\d+)?)/);
    return match ? match[1].trim() : value.trim();
}

// Build mistake map from lesson mistakes
function buildMistakeMap(correctAnswer, mistakes, lesson) {
    const mistakeMap = {};

    // Add common arithmetic mistakes
    const numAnswer = parseFloat(correctAnswer);
    if (!isNaN(numAnswer)) {
        // Common off-by-one or arithmetic errors
        mistakeMap[String(numAnswer + 1)] = "Almost! Double-check your arithmetic.";
        mistakeMap[String(numAnswer - 1)] = "Almost! Double-check your arithmetic.";
        mistakeMap[String(numAnswer * 2)] = "You might have doubled when you shouldn't have.";
        mistakeMap[String(numAnswer / 2)] = "You might have halved when you shouldn't have.";
        mistakeMap[String(-numAnswer)] = "Check if the sign (positive/negative) is correct.";
    }

    // Add lesson-specific mistakes
    mistakes.forEach(m => {
        if (m.wrong && m.why) {
            // Extract any numbers from the wrong answer description
            const wrongNums = m.wrong.match(/\d+(?:\.\d+)?/g);
            if (wrongNums) {
                wrongNums.forEach(num => {
                    mistakeMap[num] = m.why;
                });
            }
        }
    });

    return mistakeMap;
}

function renderGuidedStep() {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const stepNum = state.guidedCurrentStep + 1;

    // Update step counter
    document.getElementById('guided-current-step').textContent = stepNum;

    // Update progress dots
    document.querySelectorAll('.guided-progress .dot').forEach((dot, i) => {
        dot.classList.remove('current', 'completed');
        if (i < state.guidedCurrentStep) dot.classList.add('completed');
        else if (i === state.guidedCurrentStep) dot.classList.add('current');
    });

    // Show previous work if available
    if (step.showWork && step.showWork.length > 0) {
        document.getElementById('guided-step-hint').innerHTML = `<strong>So far:</strong> ${step.showWork.join(' → ')}`;
    } else {
        document.getElementById('guided-step-hint').textContent = step.hint || '';
    }

    // Set prompt with read aloud button
    document.getElementById('guided-step-prompt').innerHTML = `
        <div class="step-header-row">
            <div class="step-prompt-text"><strong>Step ${stepNum}:</strong> ${step.prompt}</div>
            <button class="read-aloud-btn" onclick="readAloud(this)" title="Read aloud">
                <span class="speaker-icon">🔊</span> Read
            </button>
        </div>
    `;

    // Check if this step uses selection options (clickable choices) instead of text input
    if (step.selectOptions && step.selectOptions.length > 0) {
        // Render clickable option buttons
        document.getElementById('guided-input-area').innerHTML = `
            <div class="guided-select-options">
                ${step.selectOptions.map((opt, i) => `
                    <button class="guided-select-option" onclick="selectGuidedOption('${opt.value}', ${i})">${opt.label}</button>
                `).join('')}
            </div>
        `;
    } else {
        // Reset input - use formatHint for placeholder, or derive a smart default from the expected answer
        const placeholderText = step.formatHint || getSmartPlaceholder(step);
        document.getElementById('guided-input-area').innerHTML = `
            <input type="text" class="guided-input" id="guided-answer-input" placeholder="${placeholderText}" onkeypress="if(event.key==='Enter')checkGuidedStepAnswer()">
            <button class="btn btn-emerald guided-submit" onclick="checkGuidedStepAnswer()">Check</button>
        `;
    }

    // Clear feedback
    document.getElementById('guided-feedback').classList.remove('show', 'correct', 'incorrect', 'hint');

    // Focus input (only if it's a text input step)
    if (!step.selectOptions) {
        setTimeout(() => document.getElementById('guided-answer-input')?.focus(), 100);
    }
}

function selectGuidedOption(value, index) {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const fb = document.getElementById('guided-feedback');

    state.guidedAttempts++;

    // Normalize for comparison
    const normalizeAnswer = (ans) => String(ans).toLowerCase().replace(/\s+/g, '').replace(/,/g, '');
    const userAnswer = normalizeAnswer(value);

    // Check if correct
    const acceptableAnswers = step.acceptableAnswers || [step.answer];
    const isCorrect = acceptableAnswers.some(ans => normalizeAnswer(ans) === userAnswer);

    // Highlight selected option
    document.querySelectorAll('.guided-select-option').forEach((opt, i) => {
        opt.classList.remove('selected', 'correct', 'incorrect');
        if (i === index) {
            opt.classList.add('selected');
            opt.classList.add(isCorrect ? 'correct' : 'incorrect');
        }
    });

    if (isCorrect) {
        fb.className = 'guided-feedback show correct';
        fb.innerHTML = `✓ Correct! ${getEncouragement()}`;

        addCompletedStep(step, value);

        setTimeout(() => {
            state.guidedCurrentStep++;
            state.guidedAttempts = 0;

            if (state.guidedCurrentStep >= state.guidedSteps.length) {
                showGuidedCompletion();
            } else {
                renderGuidedStep();
            }
        }, 1000);
    } else {
        // Check for specific mistake feedback
        const mistakeFeedback = step.commonMistakes?.[value] || step.commonMistakes?.[userAnswer];

        if (mistakeFeedback) {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite.<div class="mistake-tip">💡 ${mistakeFeedback}</div>`;
        } else {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite. Try again!`;
        }

        // After 3 attempts, show the answer
        if (state.guidedAttempts >= 3) {
            fb.innerHTML += `<br><br>The correct answer is: <strong>${step.answer}</strong>`;

            setTimeout(() => {
                addCompletedStep(step, step.answer);
                state.guidedCurrentStep++;
                state.guidedAttempts = 0;

                if (state.guidedCurrentStep >= state.guidedSteps.length) {
                    showGuidedCompletion();
                } else {
                    renderGuidedStep();
                }
            }, 2000);
        }
    }
}

function checkGuidedStepAnswer() {
    const step = state.guidedSteps[state.guidedCurrentStep];
    const input = document.getElementById('guided-answer-input').value.trim();
    const fb = document.getElementById('guided-feedback');

    state.guidedAttempts++;

    // Normalize answers for comparison
    const normalizeAnswer = (ans) => String(ans).toLowerCase().replace(/\s+/g, '').replace(/,/g, '');
    const userAnswer = normalizeAnswer(input);

    // Check if correct (allow multiple acceptable answers)
    const acceptableAnswers = step.acceptableAnswers || [step.answer];
    const isCorrect = acceptableAnswers.some(ans => normalizeAnswer(ans) === userAnswer);

    if (isCorrect) {
        fb.className = 'guided-feedback show correct';
        fb.innerHTML = `✓ Correct! ${getEncouragement()}`;

        // Add to completed steps
        addCompletedStep(step, input);

        // Move to next step or complete
        setTimeout(() => {
            state.guidedCurrentStep++;
            state.guidedAttempts = 0;

            if (state.guidedCurrentStep >= state.guidedSteps.length) {
                // All steps complete
                showGuidedCompletion();
            } else {
                renderGuidedStep();
            }
        }, 1000);
    } else {
        // Check for common mistakes
        const mistakeFeedback = step.commonMistakes?.[input] || step.commonMistakes?.[userAnswer];

        if (mistakeFeedback) {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite.<div class="mistake-tip">💡 ${mistakeFeedback}</div>`;
        } else if (state.guidedAttempts >= 2) {
            // After 2 attempts, give a stronger hint
            fb.className = 'guided-feedback show hint';
            fb.innerHTML = `💡 Hint: The answer involves "${step.answer.toString().charAt(0)}..." - try again!`;
        } else {
            fb.className = 'guided-feedback show incorrect';
            fb.innerHTML = `✗ Not quite. Check your work and try again.`;
        }

        // After 3 attempts, show the answer
        if (state.guidedAttempts >= 3) {
            fb.innerHTML += `<br><br>The correct answer is: <strong>${step.answer}</strong>`;

            setTimeout(() => {
                addCompletedStep(step, step.answer);
                state.guidedCurrentStep++;
                state.guidedAttempts = 0;

                if (state.guidedCurrentStep >= state.guidedSteps.length) {
                    showGuidedCompletion();
                } else {
                    renderGuidedStep();
                }
            }, 2000);
        }

        // Select input for easy retry
        document.getElementById('guided-answer-input')?.select();
    }
}

function addCompletedStep(step, answer) {
    const stepNum = state.guidedCurrentStep + 1;
    const completedHTML = `
        <div class="guided-completed-step">
            <div class="step-num">✓</div>
            <div class="step-content">
                <div class="step-question">${step.prompt}</div>
                <div class="step-answer">${answer}</div>
            </div>
        </div>
    `;
    document.getElementById('guided-completed-steps').innerHTML += completedHTML;
}

function showGuidedCompletion() {
    const lesson = state.currentLesson;

    document.getElementById('guided-current-step-area').style.display = 'none';
    document.getElementById('guided-completion').style.display = 'block';
    document.getElementById('guided-final-answer').innerHTML = `Final Answer: <strong>${lesson.guided.answer}</strong>`;

    // Update progress dots
    document.querySelectorAll('.guided-progress .dot').forEach(dot => {
        dot.classList.remove('current');
        dot.classList.add('completed');
    });
}

// Derive a smart placeholder based on the expected answer type
function getSmartPlaceholder(step) {
    const answer = String(step.answer || '').toLowerCase().trim();
    const acceptableAnswers = step.acceptableAnswers || [];

    // Check if answer is a fraction (contains /)
    if (answer.includes('/') && !answer.includes(':')) {
        return 'e.g., 3/4';
    }

    // Check if answer is a time (contains :)
    if (answer.includes(':')) {
        return 'e.g., 3:30';
    }

    // Check if answer is yes/no type
    if (['yes', 'no', 'yeah', 'yep', 'nope'].includes(answer)) {
        return 'yes or no';
    }

    // Check if answer is a direction
    if (['left', 'right', 'up', 'down'].includes(answer)) {
        return 'left or right';
    }

    // Check if answer is round up/down
    if (answer.includes('round')) {
        return 'round up or round down';
    }

    // Check if answer is even/odd
    if (['even', 'odd'].includes(answer)) {
        return 'even or odd';
    }

    // Check if answer is an operation
    if (['add', 'subtract', 'multiply', 'divide', 'addition', 'subtraction', 'multiplication', 'division'].includes(answer)) {
        return 'e.g., multiply';
    }

    // Check if any acceptable answer has units (like "26 units")
    const hasUnits = acceptableAnswers.some(a => /\d+\s*(units?|cm|m|ft|in|inches|feet|cents?|¢|\$)/.test(a));
    if (hasUnits) {
        return 'Enter a number (with or without units)';
    }

    // Check if it's a pure number
    if (/^-?\d+(\.\d+)?$/.test(answer)) {
        return 'Enter a number';
    }

    // Check if it's asking for a digit
    if (/^[0-9]$/.test(answer)) {
        return 'Enter a digit (0-9)';
    }

    // Default
    return 'Your answer';
}

function getEncouragement() {
    const phrases = ['Great job!', 'Excellent!', 'Perfect!', 'Well done!', 'Awesome!', 'Nice work!'];
    return phrases[Math.floor(Math.random() * phrases.length)];
}

// Legacy function kept for compatibility
function checkGuidedAnswer() {
    checkGuidedStepAnswer();
}

function renderPracticePhase(lesson) {
    // Reset practice state on first render
    if (state.practiceCorrect === 0) {
        state.practiceAttempts = 0;
    }

    // Generate a fresh question from the generators (not the static lesson practice)
    const question = generateQuestion(state.learningTier, state.learningSkill);

    // Store current practice question in state
    state.currentPracticeQuestion = question;

    document.getElementById('practice-problem').innerHTML = question.question;
    document.getElementById('practice-options').innerHTML = question.options.map((opt, i) =>
        `<div class="practice-option" onclick="selectPracticeOption(${i})">${opt}</div>`
    ).join('');

    // Update progress display
    document.getElementById('practice-correct-count').textContent = state.practiceCorrect;
    for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot-${i}`);
        dot.classList.toggle('completed', i <= state.practiceCorrect);
    }

    document.getElementById('practice-feedback').classList.remove('show', 'correct', 'incorrect');
    document.getElementById('mistake-analysis').classList.remove('show');
}

function selectPracticeOption(index) {
    const question = state.currentPracticeQuestion;
    const selectedAnswer = question.options[index];
    const correct = String(selectedAnswer) === String(question.answer);

    state.practiceAttempts++;

    // Record for batched session tracking
    recordQuestionResult(state.learningSkill, state.learningTier, correct, 0);

    // Show selection
    document.querySelectorAll('.practice-option').forEach((opt, i) => {
        opt.classList.remove('selected');
        if (i === index) opt.classList.add('selected');
    });

    const fb = document.getElementById('practice-feedback');
    fb.classList.add('show');

    if (correct) {
        state.practiceCorrect++;

        // Update progress display
        document.getElementById('practice-correct-count').textContent = state.practiceCorrect;
        document.getElementById(`dot-${state.practiceCorrect}`).classList.add('completed');

        document.querySelectorAll('.practice-option').forEach((opt, i) => {
            if (String(question.options[i]) === String(question.answer)) {
                opt.classList.add('correct');
            }
        });

        if (state.practiceCorrect >= 3) {
            // Completed 3 in a row!
            fb.className = 'practice-feedback show correct';
            fb.innerHTML = `✓ Excellent! 3 in a row - you've mastered this concept!`;
            setTimeout(() => {
                document.getElementById('learning-continue-btn').textContent = 'Complete Lesson ✓';
                document.getElementById('learning-continue-btn').style.display = 'inline-flex';
                document.getElementById('learning-continue-btn').onclick = completeLearning;
            }, 500);
        } else {
            // More to go
            fb.className = 'practice-feedback show correct';
            fb.innerHTML = `✓ Correct! ${3 - state.practiceCorrect} more in a row to go.`;
            setTimeout(() => {
                renderPracticePhase(state.currentLesson);
            }, 1200);
        }
    } else {
        // Reset streak on incorrect answer
        const hadProgress = state.practiceCorrect > 0;
        state.practiceCorrect = 0;

        // Reset progress display
        document.getElementById('practice-correct-count').textContent = '0';
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`dot-${i}`).classList.remove('completed');
        }

        fb.className = 'practice-feedback show incorrect';
        fb.innerHTML = hadProgress ? `Not quite. Streak reset - let's try again!` : `Not quite. Try again!`;

        document.querySelectorAll('.practice-option')[index].classList.add('incorrect');

        // Show explanation if available
        const mistakeDiv = document.getElementById('mistake-analysis');
        if (question.explanation) {
            mistakeDiv.innerHTML = `<h4>💡 Explanation</h4><p>${question.explanation}</p><button class="btn btn-emerald practice-ok-btn" onclick="dismissPracticeFeedback()">OK - Next Problem</button>`;
            mistakeDiv.classList.add('show');
        } else {
            mistakeDiv.innerHTML = `<h4>💡 Tip</h4><p>Review the worked example and try again.</p><button class="btn btn-emerald practice-ok-btn" onclick="dismissPracticeFeedback()">OK - Next Problem</button>`;
            mistakeDiv.classList.add('show');
        }

        // Disable option clicking while feedback is shown
        document.querySelectorAll('.practice-option').forEach(opt => opt.style.pointerEvents = 'none');
    }
}

function dismissPracticeFeedback() {
    // Re-enable option clicking and load next problem
    document.querySelectorAll('.practice-option').forEach(opt => opt.style.pointerEvents = 'auto');
    renderPracticePhase(state.currentLesson);
}

function nextLearningPhase() {
    if (state.learningPhase === 'learn') {
        state.learningPhase = 'guided';
    } else if (state.learningPhase === 'guided') {
        state.learningPhase = 'practice';
    }
    renderLearningPhase();
}

function previousLearningPhase() {
    if (state.learningPhase === 'guided') {
        state.learningPhase = 'learn';
        renderLearningPhase();
    } else if (state.learningPhase === 'practice') {
        state.learningPhase = 'guided';
        renderLearningPhase();
    }
}

function goBackToLearn() {
    // Go directly back to the Learn phase from any phase
    state.learningPhase = 'learn';
    state.practiceCorrect = 0; // Reset practice progress
    renderLearningPhase();
}

function completeLearning() {
    // End session tracking and send batched update to tree
    endSessionTracking();

    // Send skill mastery to Skill Tree (completed lesson = high mastery)
    sendSkillProgress(state.learningSkill, state.learningTier, 3, 3, 0);

    // Also send a lesson complete message
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({
            type: 'DOGO_LESSON_COMPLETE',
            skill: getSkillTreeName(state.learningSkill),
            domain: state.learningSkill,
            tier: state.learningTier,
            timestamp: Date.now()
        }, '*');
    }

    // Write lesson completion to localStorage for tree cross-tab sync
    localStorage.setItem('dojo_lesson_complete', JSON.stringify({
        skill: getTreeSkillName(state.learningSkill),
        domain: state.learningSkill,
        tier: state.learningTier,
        userId: getUserId(),
        timestamp: Date.now()
    }));

    endLearning();

    // Show mastery notification
    showNotification(`Skill Mastered: ${state.learningSkill}!`);
}

function endLearning() {
    // End session tracking if not already ended
    endSessionTracking();

    document.getElementById('learning-screen').classList.remove('active');
    document.getElementById('learning-setup-screen').classList.add('active');

    // Stop any ongoing speech
    stopSpeaking();

    // Reset button
    document.getElementById('learning-continue-btn').onclick = nextLearningPhase;
    document.getElementById('learning-continue-btn').textContent = 'Continue →';

    // Refresh skill grid to show updated states
    updateSkillGrid();
}

// ========================================
// TEXT-TO-SPEECH (READ ALOUD) FUNCTIONS
// ========================================

// Track current speech state
let currentUtterance = null;
let currentSpeakingBtn = null;

// Clean text for speech (remove HTML, special chars, etc.)
function cleanTextForSpeech(text) {
    // Remove HTML tags
    let cleaned = text.replace(/<[^>]*>/g, ' ');
    // Replace common math symbols with spoken equivalents
    cleaned = cleaned
        .replace(/×/g, ' times ')
        .replace(/÷/g, ' divided by ')
        .replace(/\+/g, ' plus ')
        .replace(/−|–|-/g, ' minus ')
        .replace(/=/g, ' equals ')
        .replace(/≥/g, ' is greater than or equal to ')
        .replace(/≤/g, ' is less than or equal to ')
        .replace(/>/g, ' is greater than ')
        .replace(/</g, ' is less than ')
        .replace(/≠/g, ' is not equal to ')
        .replace(/²/g, ' squared ')
        .replace(/³/g, ' cubed ')
        .replace(/√/g, ' square root of ')
        .replace(/π/g, ' pi ')
        .replace(/°/g, ' degrees ')
        .replace(/\$/g, ' dollars ')
        .replace(/%/g, ' percent ')
        .replace(/\^/g, ' to the power of ')
        .replace(/\*/g, ' times ')
        .replace(/\//g, ' divided by ')
        .replace(/\(x\)/g, ' of x ')
        .replace(/x²/g, ' x squared ')
        .replace(/x³/g, ' x cubed ')
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, ' and ')
        .replace(/\s+/g, ' ')
        .trim();
    return cleaned;
}

// Read guided step aloud (Guided Practice phase)
function readAloud(buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the current step's text to read
    const step = state.guidedSteps[state.guidedCurrentStep];
    const stepNum = state.guidedCurrentStep + 1;

    // Build the text to read
    let textToRead = `Step ${stepNum}. ${step.prompt}`;

    // Also add the hint if available
    if (step.hint) {
        textToRead += `. Hint: ${step.hint}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Stop speaking
function stopSpeaking() {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    resetSpeakingButton();
}

// Reset button state
function resetSpeakingButton() {
    if (currentSpeakingBtn) {
        currentSpeakingBtn.classList.remove('speaking');
        currentSpeakingBtn.innerHTML = '<span class="speaker-icon">🔊</span> Read';
        currentSpeakingBtn = null;
    }
    currentUtterance = null;
}

// Stop speaking when moving to next step
const originalRenderGuidedStep = renderGuidedStep;
renderGuidedStep = function() {
    stopSpeaking();
    originalRenderGuidedStep();
};

// Read a concept step aloud (Learn phase - new format with teachingSteps)
function readConceptStep(stepIndex, buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the step from the lesson
    const lesson = state.currentLesson;
    if (!lesson || !lesson.teachingSteps || !lesson.teachingSteps[stepIndex]) return;

    const step = lesson.teachingSteps[stepIndex];

    // Build the text to read
    let textToRead = `Step ${stepIndex + 1}. ${step.title}. ${step.explanation}`;

    // Add visual if present
    if (step.visual) {
        textToRead += `. ${step.visual}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Read a concept step aloud (Learn phase - old format)
function readConceptStepOld(stepIndex, buttonElement) {
    // Check if speech synthesis is supported
    if (!('speechSynthesis' in window)) {
        return;
    }

    // If already speaking, stop
    if (speechSynthesis.speaking) {
        stopSpeaking();
        return;
    }

    // Get the step from the lesson
    const lesson = state.currentLesson;
    if (!lesson || !lesson.example || !lesson.example.steps || !lesson.example.steps[stepIndex]) return;

    const step = lesson.example.steps[stepIndex];

    // Build the text to read
    let textToRead = `Step ${stepIndex + 1}. ${step.text}`;

    // Add math if present
    if (step.math) {
        textToRead += `. ${step.math}`;
    }

    // Clean and speak
    speakText(textToRead, buttonElement);
}

// Common function to handle speech
function speakText(text, buttonElement) {
    // Clean the text
    const textToRead = cleanTextForSpeech(text);

    // Create utterance
    currentUtterance = new SpeechSynthesisUtterance(textToRead);
    currentUtterance.rate = 0.9; // Slightly slower for clarity
    currentUtterance.pitch = 1;
    currentUtterance.volume = 1;

    // Try to use a good voice (prefer US English)
    const voices = speechSynthesis.getVoices();
    const preferredVoice = voices.find(v =>
        v.lang.startsWith('en') && (v.name.includes('Google') || v.name.includes('Microsoft') || v.name.includes('Samantha'))
    ) || voices.find(v => v.lang.startsWith('en-US')) || voices.find(v => v.lang.startsWith('en'));

    if (preferredVoice) {
        currentUtterance.voice = preferredVoice;
    }

    // Update button state
    currentSpeakingBtn = buttonElement;
    buttonElement.classList.add('speaking');
    buttonElement.innerHTML = '<span class="speaker-icon">🔊</span> Stop';

    // Handle speech end
    currentUtterance.onend = () => {
        resetSpeakingButton();
    };

    currentUtterance.onerror = () => {
        resetSpeakingButton();
    };

    // Start speaking
    speechSynthesis.speak(currentUtterance);
}

// Ensure voices are loaded (some browsers load them asynchronously)
if ('speechSynthesis' in window) {
    speechSynthesis.getVoices();
    speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}
    </script>
</body>
</html>
