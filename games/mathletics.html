<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mathletics - Math Mastery System</title>
    
    <!-- Load shared configuration if available -->
    <script>
        // Check if we're embedded in the portal
        if (window.parent !== window && window.parent.portalAuth) {
            window.portalAuth = window.parent.portalAuth;
            window.PortalUI = window.parent.PortalUI;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg: #0f1216;
            --card: #151a21;
            --text: #e6edf3;
            --muted: #97a2b0;
            --accent: #6aa9ff;
            --accent-2: #8bffb0;
            --danger: #ff6a6a;
            --warning: #ffd36a;
            --success: #39ff88;
            --border: #2a3140;
            --primary: var(--accent);
            --secondary: var(--accent-2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .mathletics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .header p {
            color: var(--muted);
            font-size: 1.1rem;
        }
        
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .btn {
            appearance: none;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #0b0f14;
            border: none;
        }
        
        .btn-success {
            background: var(--success);
            color: #0b0f14;
            border: none;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #0e1319;
            color: var(--text);
            border: 1px solid var(--border);
            font-size: 16px;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .stats {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            flex: 1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--muted);
        }
        
        .progress-bar {
            background: #0e1319;
            border: 1px solid var(--border);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }
        
        .progress-bar.small {
            height: 12px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .game-area {
            text-align: center;
            padding: 40px 20px;
        }
        
        .problem {
            font-size: 3rem;
            font-weight: 700;
            margin: 30px 0;
            color: var(--accent);
        }
        
        .answer-input {
            font-size: 2rem;
            padding: 15px;
            text-align: center;
            background: var(--card);
            border: 2px solid var(--accent);
            border-radius: 10px;
            color: var(--text);
            width: 200px;
            margin: 0 auto;
        }
        
        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .timer.warning {
            border-color: var(--warning);
            color: var(--warning);
        }
        
        .timer.danger {
            border-color: var(--danger);
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .results-table th {
            background: rgba(0,0,0,0.2);
            color: var(--accent);
            font-weight: 600;
        }
        
        .correct { color: var(--success); }
        .incorrect { color: var(--danger); }
        .slow { color: var(--warning); }
        .fast { color: var(--accent-2); }
        
        .mastery-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mastery-bronze {
            background: #cd7f32;
            color: white;
        }
        
        .mastery-silver {
            background: #c0c0c0;
            color: #333;
        }
        
        .mastery-gold {
            background: #ffd700;
            color: #333;
        }
        
        .mastery-none {
            background: #555;
            color: white;
        }
        
        .heatmap {
            display: grid;
            grid-template-columns: repeat(13, 1fr); /* Will be updated dynamically */
            gap: 2px;
            margin: 20px 0;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 4px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .heatmap-header {
            background: var(--accent);
            color: #0b0f14;
        }
        
        .heatmap-fast {
            background: var(--success);
            color: #0b0f14;
        }
        
        .heatmap-medium {
            background: var(--warning);
            color: #0b0f14;
        }
        
        .heatmap-slow {
            background: var(--danger);
            color: white;
        }
        
        .heatmap-unknown {
            background: var(--muted);
            color: var(--bg);
        }
        
        .hidden { display: none !important; }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border: 1px solid var(--border);
        }
        
        .alert-success {
            background: rgba(57, 255, 136, 0.1);
            color: var(--success);
            border-color: var(--success);
        }
        
        .alert-error {
            background: rgba(255, 106, 106, 0.1);
            color: var(--danger);
            border-color: var(--danger);
        }
        
        .alert-info {
            background: rgba(106, 169, 255, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }
        
        .back-btn {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="mathletics-container">
        <!-- Header -->
        <div class="header">
            <h1>🎯 Mathletics</h1>
            <p>Master your multiplication facts through adaptive practice</p>
        </div>
        
        <!-- Placement Test Screen -->
        <div id="placement-screen" class="hidden">
            <div class="card">
                <h2>📊 Find Your Starting Level</h2>
                <p>Let's determine the best multiplication range for you to start practicing.</p>
                
                <div class="grid grid-2" style="margin-top: 20px;">
                    <div class="card">
                        <h3>🎯 Quick Placement</h3>
                        <p>Take a short test to find your optimal starting range</p>
                        <button class="btn btn-primary" onclick="startPlacementTest()" style="width: 100%; margin-top: 15px;">
                            Start Placement Test
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3>⚡ Choose Your Level</h3>
                        <p>Skip the test and choose your starting range</p>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="placement-range">Starting Range:</label>
                            <select id="placement-range" style="margin-bottom: 15px;">
                                <option value="0-8">0-8 (Beginner)</option>
                                <option value="0-10">0-10 (Elementary)</option>
                                <option value="0-12">0-12 (Intermediate)</option>
                                <option value="0-15">0-15 (Advanced)</option>
                                <option value="0-17">0-17 (Expert)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="setStartingRange()" style="width: 100%;">
                            Start Here
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Menu -->
        <div id="main-menu" class="card hidden">
            
            <div class="grid grid-2" style="margin-top: 20px;">
                <div class="card">
                    <h3>🚀 Quick Start</h3>
                    <p>Jump into practice with your current level</p>
                    <button class="btn btn-primary" onclick="quickStart()" style="width: 100%; margin-top: 15px;">
                        Start Practice Session
                    </button>
                </div>
                
                <div class="card">
                    <h3>⚙️ Custom Session</h3>
                    <p>Customize your practice settings</p>
                    <button class="btn btn-primary" onclick="showSettings()" style="width: 100%; margin-top: 15px;">
                        Custom Settings
                    </button>
                </div>
            </div>
            
            <!-- Current Progress -->
            <div class="card" style="margin-top: 20px;">
                <h3>📊 Your Progress</h3>
                <div id="progress-overview">
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="current-range">0-8</div>
                            <div class="stat-label">Current Range</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="mastery-level">Bronze</div>
                            <div class="stat-label">Mastery Level</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="facts-mastered">0</div>
                            <div class="stat-label">Facts Mastered</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="avg-speed">--</div>
                            <div class="stat-label">Avg Speed (sec)</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="showDetailedProgress()" style="margin-top: 15px;">
                    View Detailed Progress
                </button>
                
                <button class="btn btn-secondary" onclick="showPlacementScreen()" style="margin-top: 10px;">
                    Change Starting Level
                </button>
            </div>
        </div>
        
        <!-- Settings Screen -->
        <div id="settings-screen" class="hidden">
            <div class="card">
                <h2>⚙️ Session Settings</h2>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label for="min-range">Minimum Number:</label>
                        <select id="min-range">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="max-range">Maximum Number:</label>
                        <select id="max-range">
                            <option value="8">8</option>
                            <option value="10">10</option>
                            <option value="12">12</option>
                            <option value="15">15</option>
                            <option value="17">17</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="time-limit">Time Limit (seconds):</label>
                        <select id="time-limit">
                            <option value="120">2 minutes</option>
                            <option value="180">3 minutes</option>
                            <option value="240" selected>4 minutes</option>
                            <option value="300">5 minutes</option>
                            <option value="360">6 minutes</option>
                            <option value="420">7 minutes</option>
                            <option value="480">8 minutes</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="target-problems">Target Problems:</label>
                        <select id="target-problems">
                            <option value="25">25 problems</option>
                            <option value="40">40 problems</option>
                            <option value="60">60 problems</option>
                            <option value="80" selected>80 problems</option>
                            <option value="100">100 problems</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="spaced-repetition" checked>
                        Include previous difficult facts (Spaced Repetition)
                    </label>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="startCustomSession()">
                        Start Session
                    </button>
                    <button class="btn btn-secondary" onclick="showMainMenu()">
                        Back to Menu
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="hidden">
            <div class="timer" id="timer">5:00</div>
            
            <div class="card">
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="problems-completed">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="problems-remaining">80</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="current-accuracy">100%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="current-speed">--</div>
                        <div class="stat-label">Avg Speed</div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="game-area">
                <div class="problem" id="current-problem">3 × 4 = ?</div>
                <input type="number" class="answer-input" id="answer-input" placeholder="?" autocomplete="off">
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitAnswer()">Submit</button>
                    <button class="btn btn-danger" onclick="pauseGame()">Pause</button>
                </div>
                <div id="feedback" style="margin-top: 15px; font-size: 1.2rem;"></div>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div id="results-screen" class="hidden">
            <div class="card">
                <h2>🎯 Session Results</h2>
                
                <div id="session-summary" class="stats">
                    <!-- Populated by JavaScript -->
                </div>
                
                <div id="mastery-progress" style="margin: 20px 0;">
                    <!-- Mastery progress info -->
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="showMainMenu()">
                        Back to Menu
                    </button>
                    <button class="btn btn-secondary" onclick="startAgain()">
                        Practice Again
                    </button>
                    <button class="btn" onclick="showDetailedResults()">
                        View Details
                    </button>
                </div>
            </div>
            
            <div id="detailed-results" class="card hidden">
                <h3>📋 Detailed Results</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Problem</th>
                            <th>Your Answer</th>
                            <th>Correct</th>
                            <th>Time</th>
                            <th>Speed Rating</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Progress Screen -->
        <div id="progress-screen" class="hidden">
            <div class="card">
                <h2>📊 Detailed Progress</h2>
                
                <div class="grid grid-3">
                    <div class="card">
                        <h3>🏆 Mastery Levels</h3>
                        <div id="mastery-breakdown">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>📈 Performance Trends</h3>
                        <div id="performance-trends">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>🎯 Goals</h3>
                        <div id="student-goals">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>🔥 Facts Heatmap</h3>
                    <p style="margin-bottom: 15px;">Speed performance for each multiplication fact</p>
                    <div id="facts-heatmap" class="heatmap">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.9rem;">
                        <span><span class="mastery-indicator mastery-none">Unknown</span> Not practiced</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--danger); border-radius: 2px; margin-right: 5px;"></span>Slow (>4s)</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--warning); border-radius: 2px; margin-right: 5px;"></span>Medium (2-4s)</span>
                        <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--success); border-radius: 2px; margin-right: 5px;"></span>Fast (<2s)</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMainMenu()">
                        Back to Menu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class Mathletics {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.studentData = {
                    current_range: { min: 0, max: 8 },
                    mastery_level: 'Bronze',
                    time_limit: 300,
                    facts_mastered: 0,
                    avg_speed: null,
                    problem_history: {},
                    session_count: 0,
                    total_problems: 0,
                    total_correct: 0,
                    mastery_progress: {},
                    difficult_facts: [],
                    needs_placement: true,
                    recent_sessions: [], // Track last 5 sessions for multi-session mastery
                    mastery_confidence: {
                        bronze: 0,
                        silver: 0,  
                        gold: 0
                    }
                };
                this.currentSession = {
                    problems: [],
                    responses: [],
                    startTime: null,
                    timeLimit: 300,
                    targetProblems: 80,
                    currentProblemIndex: 0,
                    currentProblemStartTime: null,
                    isActive: false,
                    correctStreak: 0
                };
                this.timer = null;
                
                this.init();
            }
            
            async init() {
                console.log('🎯 Initializing Mathletics...');
                
                // Initialize Supabase - check if we have access to portal auth
                if (window.portalAuth && window.portalAuth.supabase) {
                    this.supabase = window.portalAuth.supabase;
                    this.currentUser = window.portalAuth.getUserInfo();
                    console.log('Using portal authentication');
                } else {
                    // Fallback to standalone Supabase (you'll need to configure this)
                    console.log('Using standalone mode');
                    this.currentUser = { 
                        profile: { 
                            first_name: 'Student',
                            id: 'demo-student'
                        }
                    };
                }
                
                // Load student data
                await this.loadStudentData();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Initialize UI
                if (this.studentData.needs_placement && this.studentData.session_count === 0) {
                    this.showPlacementScreen();
                } else {
                    this.updateProgressOverview();
                    this.showMainMenu();
                }
                
                console.log('✅ Mathletics initialized');
            }
            
            setupEventListeners() {
                // Answer input handling
                const answerInput = document.getElementById('answer-input');
                if (answerInput) {
                    answerInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && this.currentSession.isActive) {
                            this.submitAnswer();
                        }
                    });
                    
                    answerInput.addEventListener('input', () => {
                        // Auto-submit if answer looks complete (optional)
                        const answer = parseInt(answerInput.value);
                        if (answer >= 0 && answerInput.value.length >= 1) {
                            // Could add auto-submit logic here
                        }
                    });
                }
                
                // Set default values for settings
                document.getElementById('min-range').value = this.studentData.current_range.min;
                document.getElementById('max-range').value = this.studentData.current_range.max;
                document.getElementById('time-limit').value = this.studentData.time_limit || 240;
            }
            
            async loadStudentData() {
                if (!this.supabase || !this.currentUser?.profile?.id) {
                    console.log('Loading demo student data');
                    return;
                }
                
                try {
                    const { data, error } = await this.supabase
                        .from('mathletics_progress')
                        .select('*')
                        .eq('user_id', this.currentUser.profile.id)
                        .single();
                    
                    if (data && !error) {
                        this.studentData = { ...this.studentData, ...data };
                        console.log('Loaded student data:', this.studentData);
                    } else if (error && error.code !== 'PGRST116') {
                        console.error('Error loading student data:', error);
                    }
                } catch (err) {
                    console.error('Database error:', err);
                }
            }
            
            async saveStudentData() {
                if (!this.supabase || !this.currentUser?.profile?.id) {
                    console.log('Saving to local storage (demo mode)');
                    return;
                }
                
                try {
                    const dataToSave = {
                        user_id: this.currentUser.profile.id,
                        ...this.studentData,
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await this.supabase
                        .from('mathletics_progress')
                        .upsert(dataToSave);
                    
                    if (error) throw error;
                    console.log('Student data saved successfully');
                } catch (err) {
                    console.error('Error saving student data:', err);
                }
            }
            
            updateProgressOverview() {
                document.getElementById('current-range').textContent = 
                    `${this.studentData.current_range.min}-${this.studentData.current_range.max}`;
                document.getElementById('mastery-level').textContent = this.studentData.mastery_level;
                document.getElementById('facts-mastered').textContent = this.studentData.facts_mastered;
                document.getElementById('avg-speed').textContent = 
                    this.studentData.avg_speed ? `${this.studentData.avg_speed.toFixed(1)}s` : '--';
            }
            
            showPlacementScreen() {
                this.hideAllScreens();
                document.getElementById('placement-screen').classList.remove('hidden');
            }
            
            setStartingRange() {
                const rangeValue = document.getElementById('placement-range').value;
                const [min, max] = rangeValue.split('-').map(Number);
                
                this.studentData.current_range = { min, max };
                this.studentData.needs_placement = false;
                this.saveStudentData();
                
                this.updateProgressOverview();
                this.showMainMenu();
                
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = `Starting range set to ${min}-${max}. Good luck with your practice!`;
                document.querySelector('#main-menu').prepend(alert);
                setTimeout(() => alert.remove(), 3000);
            }
            
            async startPlacementTest() {
                // Quick placement test with a few problems from different ranges
                const testProblems = [
                    { a: 2, b: 3, answer: 6, range: '0-5' },
                    { a: 4, b: 7, answer: 28, range: '0-8' },
                    { a: 6, b: 9, answer: 54, range: '0-10' },
                    { a: 8, b: 12, answer: 96, range: '0-12' },
                    { a: 13, b: 9, answer: 117, range: '0-15' },
                    { a: 16, b: 14, answer: 224, range: '0-17' }
                ];
                
                let correct = 0;
                let totalTime = 0;
                
                for (let i = 0; i < testProblems.length; i++) {
                    const problem = testProblems[i];
                    const startTime = Date.now();
                    
                    const userAnswer = prompt(`Placement Test Question ${i + 1}/6\n\n${problem.a} × ${problem.b} = ?`);
                    
                    if (userAnswer === null) {
                        // User cancelled, set default range
                        this.studentData.current_range = { min: 0, max: 8 };
                        this.studentData.needs_placement = false;
                        this.saveStudentData();
                        this.updateProgressOverview();
                        this.showMainMenu();
                        return;
                    }
                    
                    const timeSpent = (Date.now() - startTime) / 1000;
                    totalTime += timeSpent;
                    
                    if (parseInt(userAnswer) === problem.answer && timeSpent < 10) {
                        correct++;
                    } else {
                        // Stop at first wrong answer or slow response
                        break;
                    }
                }
                
                // Determine starting range based on performance
                let recommendedRange;
                if (correct >= 5) {
                    recommendedRange = { min: 0, max: 17 };
                } else if (correct >= 4) {
                    recommendedRange = { min: 0, max: 15 };
                } else if (correct >= 3) {
                    recommendedRange = { min: 0, max: 12 };
                } else if (correct >= 2) {
                    recommendedRange = { min: 0, max: 10 };
                } else {
                    recommendedRange = { min: 0, max: 8 };
                }
                
                this.studentData.current_range = recommendedRange;
                this.studentData.needs_placement = false;
                this.saveStudentData();
                
                this.updateProgressOverview();
                this.showMainMenu();
                
                // Show results
                const alert = document.createElement('div');
                alert.className = 'alert alert-success';
                alert.innerHTML = `Placement test complete! You got ${correct} correct.<br>Starting range set to ${recommendedRange.min}-${recommendedRange.max}.`;
                document.querySelector('#main-menu').prepend(alert);
                setTimeout(() => alert.remove(), 5000);
            }
            
            quickStart() {
                // Use current student settings for quick start
                this.startSession(
                    this.studentData.current_range.min,
                    this.studentData.current_range.max,
                    this.studentData.time_limit || 240,
                    80,
                    true
                );
            }
            
            showSettings() {
                this.hideAllScreens();
                document.getElementById('settings-screen').classList.remove('hidden');
            }
            
            startCustomSession() {
                const minRange = parseInt(document.getElementById('min-range').value);
                const maxRange = parseInt(document.getElementById('max-range').value);
                const timeLimit = parseInt(document.getElementById('time-limit').value);
                const targetProblems = parseInt(document.getElementById('target-problems').value);
                const spacedRepetition = document.getElementById('spaced-repetition').checked;
                
                this.startSession(minRange, maxRange, timeLimit, targetProblems, spacedRepetition);
            }
            
            startSession(minRange, maxRange, timeLimit, targetProblems, spacedRepetition) {
                // Initialize session
                this.currentSession = {
                    problems: [],
                    responses: [],
                    startTime: Date.now(),
                    timeLimit: timeLimit,
                    targetProblems: targetProblems,
                    currentProblemIndex: 0,
                    currentProblemStartTime: null,
                    isActive: true,
                    correctStreak: 0,
                    minRange: minRange,
                    maxRange: maxRange
                };
                
                // Generate problems
                this.generateProblems(minRange, maxRange, targetProblems, spacedRepetition);
                
                // Show game screen
                this.hideAllScreens();
                document.getElementById('game-screen').classList.remove('hidden');
                
                // Start timer
                this.startTimer();
                
                // Show first problem
                this.showNextProblem();
                
                // Focus on input
                document.getElementById('answer-input').focus();
            }
            
            generateProblems(minRange, maxRange, targetProblems, spacedRepetition) {
                const problems = [];
                
                // Generate base problems from current range
                const baseProblems = [];
                for (let i = minRange; i <= maxRange; i++) {
                    for (let j = minRange; j <= maxRange; j++) {
                        baseProblems.push({ a: i, b: j, answer: i * j });
                    }
                }
                
                // Add spaced repetition problems (difficult facts from previous sessions)
                let spacedProblems = [];
                if (spacedRepetition && this.studentData.difficult_facts.length > 0) {
                    spacedProblems = this.studentData.difficult_facts
                        .slice(0, Math.min(10, Math.floor(targetProblems * 0.3)))
                        .map(fact => ({
                            a: fact.a,
                            b: fact.b,
                            answer: fact.answer,
                            isSpacedRepetition: true
                        }));
                }
                
                // Combine and shuffle problems
                const allProblems = [...baseProblems, ...spacedProblems];
                
                // Randomly select target number of problems
                for (let i = 0; i < targetProblems && i < allProblems.length * 3; i++) {
                    const randomProblem = allProblems[Math.floor(Math.random() * allProblems.length)];
                    problems.push({ ...randomProblem });
                }
                
                this.currentSession.problems = problems;
            }
            
            startTimer() {
                this.updateTimerDisplay();
                this.timer = setInterval(() => {
                    this.updateTimerDisplay();
                    
                    if (this.getRemainingTime() <= 0) {
                        this.endSession('time_up');
                    }
                }, 1000);
            }
            
            updateTimerDisplay() {
                const remaining = this.getRemainingTime();
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = display;
                    
                    // Add warning classes
                    timerElement.classList.remove('warning', 'danger');
                    if (remaining <= 30) {
                        timerElement.classList.add('danger');
                    } else if (remaining <= 60) {
                        timerElement.classList.add('warning');
                    }
                }
            }
            
            getRemainingTime() {
                const elapsed = (Date.now() - this.currentSession.startTime) / 1000;
                return Math.max(0, Math.floor(this.currentSession.timeLimit - elapsed));
            }
            
            showNextProblem() {
                if (this.currentSession.currentProblemIndex >= this.currentSession.problems.length ||
                    this.currentSession.currentProblemIndex >= this.currentSession.targetProblems) {
                    this.endSession('completed');
                    return;
                }
                
                const problem = this.currentSession.problems[this.currentSession.currentProblemIndex];
                document.getElementById('current-problem').textContent = `${problem.a} × ${problem.b} = ?`;
                document.getElementById('answer-input').value = '';
                document.getElementById('answer-input').focus();
                document.getElementById('feedback').textContent = '';
                
                this.currentSession.currentProblemStartTime = Date.now();
                
                this.updateSessionStats();
            }
            
            submitAnswer() {
                if (!this.currentSession.isActive) return;
                
                const answerInput = document.getElementById('answer-input');
                const userAnswer = parseInt(answerInput.value);
                const currentProblem = this.currentSession.problems[this.currentSession.currentProblemIndex];
                const timeSpent = (Date.now() - this.currentSession.currentProblemStartTime) / 1000;
                
                if (isNaN(userAnswer)) {
                    document.getElementById('feedback').innerHTML = 
                        '<span style="color: var(--warning)">Please enter a number</span>';
                    return;
                }
                
                const isCorrect = userAnswer === currentProblem.answer;
                
                // Record response
                this.currentSession.responses.push({
                    problem: currentProblem,
                    userAnswer: userAnswer,
                    correct: isCorrect,
                    timeSpent: timeSpent,
                    timestamp: Date.now()
                });
                
                if (isCorrect) {
                    this.currentSession.correctStreak++;
                    document.getElementById('feedback').innerHTML = 
                        '<span class="correct">✓ Correct!</span>';
                    
                    // Move to next problem after short delay
                    setTimeout(() => {
                        this.currentSession.currentProblemIndex++;
                        this.showNextProblem();
                    }, 800);
                } else {
                    this.currentSession.correctStreak = 0;
                    document.getElementById('feedback').innerHTML = 
                        `<span class="incorrect">✗ Try again! ${currentProblem.a} × ${currentProblem.b} = ${currentProblem.answer}</span>`;
                    
                    // Stay on same problem - student must get it right
                    answerInput.value = '';
                    answerInput.focus();
                }
            }
            
            updateSessionStats() {
                const completed = this.currentSession.responses.filter(r => r.correct).length;
                const remaining = this.currentSession.targetProblems - completed;
                const correctResponses = this.currentSession.responses.filter(r => r.correct);
                const accuracy = this.currentSession.responses.length > 0 ? 
                    (correctResponses.length / this.currentSession.responses.length * 100).toFixed(0) : 100;
                const avgSpeed = correctResponses.length > 0 ?
                    (correctResponses.reduce((sum, r) => sum + r.timeSpent, 0) / correctResponses.length).toFixed(1) : '--';
                
                document.getElementById('problems-completed').textContent = completed;
                document.getElementById('problems-remaining').textContent = Math.max(0, remaining);
                document.getElementById('current-accuracy').textContent = accuracy + '%';
                document.getElementById('current-speed').textContent = avgSpeed === '--' ? '--' : avgSpeed + 's';
                
                // Update progress bar
                const progressPercent = (completed / this.currentSession.targetProblems) * 100;
                document.getElementById('progress-fill').style.width = progressPercent + '%';
            }
            
            pauseGame() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                this.currentSession.isActive = false;
                
                // Show pause dialog (simplified)
                if (confirm('Game paused. Continue playing?')) {
                    this.resumeGame();
                } else {
                    this.showMainMenu();
                }
            }
            
            resumeGame() {
                this.currentSession.isActive = true;
                this.startTimer();
                document.getElementById('answer-input').focus();
            }
            
            async endSession(reason) {
                this.currentSession.isActive = false;
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                // Process session results
                await this.processSessionResults();
                
                // Show results
                this.showResults(reason);
            }
            
            async processSessionResults() {
                const correctResponses = this.currentSession.responses.filter(r => r.correct);
                const totalTime = (Date.now() - this.currentSession.startTime) / 1000;
                
                // Update student stats
                this.studentData.session_count++;
                this.studentData.total_problems += correctResponses.length;
                this.studentData.total_correct += correctResponses.length;
                
                // Calculate new average speed
                const sessionAvgSpeed = correctResponses.length > 0 ?
                    correctResponses.reduce((sum, r) => sum + r.timeSpent, 0) / correctResponses.length : 0;
                
                if (this.studentData.avg_speed) {
                    this.studentData.avg_speed = (this.studentData.avg_speed + sessionAvgSpeed) / 2;
                } else {
                    this.studentData.avg_speed = sessionAvgSpeed;
                }
                
                // Track difficult facts (response time > 4 seconds)
                const slowFacts = correctResponses.filter(r => r.timeSpent > 4);
                slowFacts.forEach(fact => {
                    const factKey = `${fact.problem.a}x${fact.problem.b}`;
                    const existingIndex = this.studentData.difficult_facts.findIndex(f => 
                        f.a === fact.problem.a && f.b === fact.problem.b);
                    
                    if (existingIndex >= 0) {
                        // Update existing difficult fact
                        this.studentData.difficult_facts[existingIndex].count++;
                        this.studentData.difficult_facts[existingIndex].lastSeen = Date.now();
                    } else {
                        // Add new difficult fact
                        this.studentData.difficult_facts.push({
                            a: fact.problem.a,
                            b: fact.problem.b,
                            answer: fact.problem.answer,
                            count: 1,
                            lastSeen: Date.now()
                        });
                    }
                });
                
                // Update problem history for heatmap
                correctResponses.forEach(response => {
                    const key = `${response.problem.a}x${response.problem.b}`;
                    if (!this.studentData.problem_history[key]) {
                        this.studentData.problem_history[key] = {
                            times: [],
                            correct: 0,
                            total: 0
                        };
                    }
                    this.studentData.problem_history[key].times.push(response.timeSpent);
                    this.studentData.problem_history[key].correct++;
                    this.studentData.problem_history[key].total++;
                });
                
                // Check for mastery progression
                this.checkMasteryProgression(correctResponses, totalTime);
                
                // Save data
                await this.saveStudentData();
            }
            
            checkMasteryProgression(correctResponses, totalTime) {
                const targetProblems = this.currentSession.targetProblems;
                const completedProblems = correctResponses.length;
                const avgSpeed = correctResponses.length > 0 ?
                    correctResponses.reduce((sum, r) => sum + r.timeSpent, 0) / correctResponses.length : 999;
                const accuracy = completedProblems / Math.max(1, this.currentSession.responses.length);
                const completionRate = completedProblems / targetProblems;
                
                // Record this session's performance
                const sessionPerformance = {
                    date: new Date().toISOString(),
                    completionRate: completionRate,
                    avgSpeed: avgSpeed,
                    accuracy: accuracy,
                    problems: completedProblems,
                    range: `${this.studentData.current_range.min}-${this.studentData.current_range.max}`
                };
                
                // Keep only last 5 sessions for this range
                if (!this.studentData.recent_sessions) {
                    this.studentData.recent_sessions = [];
                }
                
                this.studentData.recent_sessions.push(sessionPerformance);
                this.studentData.recent_sessions = this.studentData.recent_sessions
                    .filter(s => s.range === sessionPerformance.range)
                    .slice(-5);
                
                // Evaluate multi-session mastery
                this.evaluateMultiSessionMastery();
            }
            
            evaluateMultiSessionMastery() {
                const sessions = this.studentData.recent_sessions;
                if (sessions.length < 2) {
                    // Need at least 2 sessions to evaluate consistency
                    return;
                }
                
                // Define mastery criteria (more reasonable than before)
                const masteryLevels = {
                    bronze: {
                        completionRate: 0.75,  // 75% completion
                        avgSpeed: 6.0,         // 6 seconds average
                        accuracy: 0.92,        // 92% accuracy
                        sessionsRequired: 2    // Must meet in 2/last 3 sessions
                    },
                    silver: {
                        completionRate: 0.80,  // 80% completion  
                        avgSpeed: 4.0,         // 4 seconds average
                        accuracy: 0.95,        // 95% accuracy
                        sessionsRequired: 2    // Must meet in 2/last 3 sessions
                    },
                    gold: {
                        completionRate: 0.85,  // 85% completion
                        avgSpeed: 3.0,         // 3 seconds average
                        accuracy: 0.97,        // 97% accuracy
                        sessionsRequired: 3    // Must meet in 3/last 4 sessions (more consistency)
                    }
                };
                
                // Evaluate each mastery level
                Object.keys(masteryLevels).forEach(level => {
                    const criteria = masteryLevels[level];
                    const recentSessions = sessions.slice(-Math.max(criteria.sessionsRequired + 1, 4));
                    
                    const qualifyingSessions = recentSessions.filter(session =>
                        session.completionRate >= criteria.completionRate &&
                        session.avgSpeed <= criteria.avgSpeed &&
                        session.accuracy >= criteria.accuracy
                    );
                    
                    const meetsRequirement = qualifyingSessions.length >= criteria.sessionsRequired;
                    
                    // Update confidence score
                    if (meetsRequirement) {
                        this.studentData.mastery_confidence[level] = Math.min(100, 
                            this.studentData.mastery_confidence[level] + 20);
                    } else {
                        this.studentData.mastery_confidence[level] = Math.max(0,
                            this.studentData.mastery_confidence[level] - 5);
                    }
                });
                
                // Determine current mastery level based on confidence
                let newMasteryLevel = this.studentData.mastery_level;
                let shouldAdvanceRange = false;
                
                if (this.studentData.mastery_confidence.gold >= 80 && this.studentData.mastery_level !== 'Gold') {
                    newMasteryLevel = 'Gold';
                    this.studentData.mastery_level = 'Gold';
                    shouldAdvanceRange = true;
                } else if (this.studentData.mastery_confidence.silver >= 60 && 
                          ['Bronze', 'None'].includes(this.studentData.mastery_level)) {
                    newMasteryLevel = 'Silver';
                    this.studentData.mastery_level = 'Silver';
                } else if (this.studentData.mastery_confidence.bronze >= 40 && 
                          this.studentData.mastery_level === 'None') {
                    newMasteryLevel = 'Bronze';
                    this.studentData.mastery_level = 'Bronze';
                }
                
                // Advance range if achieved gold mastery with high confidence
                if (shouldAdvanceRange && this.studentData.mastery_confidence.gold >= 80) {
                    const currentMax = this.studentData.current_range.max;
                    if (currentMax < 20) {
                        this.studentData.current_range = {
                            min: this.studentData.current_range.min,
                            max: currentMax + 1
                        };
                        this.studentData.mastery_level = 'Bronze';
                        this.studentData.time_limit = Math.min(360, this.studentData.time_limit + 30);
                        
                        // Reset confidence and sessions for new range
                        this.studentData.mastery_confidence = { bronze: 0, silver: 0, gold: 0 };
                        this.studentData.recent_sessions = [];
                    }
                }
                
                // Update facts mastered count
                const rangeSize = (this.studentData.current_range.max - this.studentData.current_range.min + 1);
                this.studentData.facts_mastered = rangeSize * rangeSize;
            }
            
            showResults(reason) {
                this.hideAllScreens();
                document.getElementById('results-screen').classList.remove('hidden');
                
                const correctResponses = this.currentSession.responses.filter(r => r.correct);
                const totalResponses = this.currentSession.responses.length;
                const accuracy = totalResponses > 0 ? (correctResponses.length / totalResponses * 100).toFixed(0) : 0;
                const avgSpeed = correctResponses.length > 0 ?
                    (correctResponses.reduce((sum, r) => sum + r.timeSpent, 0) / correctResponses.length).toFixed(1) : 0;
                
                // Session summary
                const summaryHTML = `
                    <div class="stat">
                        <div class="stat-value">${correctResponses.length}</div>
                        <div class="stat-label">Problems Completed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${accuracy}%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${avgSpeed}s</div>
                        <div class="stat-label">Average Speed</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value mastery-${this.studentData.mastery_level.toLowerCase()}">${this.studentData.mastery_level}</div>
                        <div class="stat-label">Current Mastery</div>
                    </div>
                `;
                
                document.getElementById('session-summary').innerHTML = summaryHTML;
                
                // Mastery progress info
                const masteryHTML = this.generateMasteryProgressHTML();
                document.getElementById('mastery-progress').innerHTML = masteryHTML;
                
                // Populate detailed results table
                this.populateDetailedResults();
            }
            
            generateMasteryProgressHTML() {
                const confidence = this.studentData.mastery_confidence || { bronze: 0, silver: 0, gold: 0 };
                const sessions = this.studentData.recent_sessions || [];
                
                let progressHTML = `
                    <div class="alert alert-info">
                        <strong>Current Range:</strong> ${this.studentData.current_range.min}-${this.studentData.current_range.max}<br>
                        <strong>Mastery Level:</strong> <span class="mastery-indicator mastery-${this.studentData.mastery_level.toLowerCase()}">${this.studentData.mastery_level}</span><br>
                `;
                
                // Show progress towards next level
                const currentLevel = this.studentData.mastery_level.toLowerCase();
                const nextLevel = currentLevel === 'bronze' ? 'silver' : 
                                currentLevel === 'silver' ? 'gold' : null;
                
                if (nextLevel) {
                    const nextConfidence = confidence[nextLevel];
                    const requirement = nextLevel === 'silver' ? 60 : 80;
                    
                    progressHTML += `
                        <strong>Progress to ${nextLevel.charAt(0).toUpperCase() + nextLevel.slice(1)}:</strong> 
                        <div class="progress-bar" style="margin: 5px 0;">
                            <div class="progress-fill" style="width: ${nextConfidence}%"></div>
                        </div>
                        ${nextConfidence}% / ${requirement}% confidence
                    `;
                }
                
                if (sessions.length >= 2) {
                    const recent = sessions.slice(-3);
                    const trend = this.calculatePerformanceTrend(recent);
                    
                    progressHTML += `<br><strong>Recent Performance:</strong> ${trend}`;
                }
                
                progressHTML += `</div>`;
                
                return progressHTML;
            }
            
            calculatePerformanceTrend(sessions) {
                if (sessions.length < 2) return 'Not enough data';
                
                const first = sessions[0];
                const last = sessions[sessions.length - 1];
                
                const speedImprovement = ((first.avgSpeed - last.avgSpeed) / first.avgSpeed * 100);
                const accuracyImprovement = ((last.accuracy - first.accuracy) * 100);
                
                if (speedImprovement > 5 && accuracyImprovement > 2) {
                    return '📈 Improving';
                } else if (speedImprovement < -5 || accuracyImprovement < -2) {
                    return '📉 Needs focus';
                } else {
                    return '➡️ Consistent';
                }
            }
            
            populateDetailedResults() {
                const tbody = document.getElementById('results-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                this.currentSession.responses.forEach((response, index) => {
                    const row = document.createElement('tr');
                    const speedClass = response.timeSpent < 2 ? 'fast' : 
                                     response.timeSpent < 4 ? '' : 'slow';
                    
                    row.innerHTML = `
                        <td>${response.problem.a} × ${response.problem.b}</td>
                        <td class="${response.correct ? 'correct' : 'incorrect'}">${response.userAnswer}</td>
                        <td>${response.problem.answer}</td>
                        <td class="${speedClass}">${response.timeSpent.toFixed(1)}s</td>
                        <td>
                            ${response.timeSpent < 2 ? 
                                '<span class="mastery-indicator" style="background: var(--success); color: #0b0f14;">Fast</span>' :
                              response.timeSpent < 4 ? 
                                '<span class="mastery-indicator" style="background: var(--warning); color: #0b0f14;">Good</span>' :
                                '<span class="mastery-indicator" style="background: var(--danger); color: white;">Slow</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            showDetailedResults() {
                const detailedDiv = document.getElementById('detailed-results');
                detailedDiv.classList.toggle('hidden');
            }
            
            showDetailedProgress() {
                this.hideAllScreens();
                document.getElementById('progress-screen').classList.remove('hidden');
                
                this.generateHeatmap();
                this.updateProgressScreen();
            }
            
            generateHeatmap() {
                const heatmapDiv = document.getElementById('facts-heatmap');
                if (!heatmapDiv) return;
                
                heatmapDiv.innerHTML = '';
                
                // Determine max range for heatmap based on student's current level
                const maxRange = Math.min(20, Math.max(12, this.studentData.current_range.max + 3));
                
                // Update grid template
                heatmapDiv.style.gridTemplateColumns = `repeat(${maxRange + 2}, 1fr)`;
                
                // Create header row
                const headerRow = document.createElement('div');
                headerRow.className = 'heatmap-cell heatmap-header';
                headerRow.textContent = '×';
                heatmapDiv.appendChild(headerRow);
                
                for (let i = 0; i <= maxRange; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell heatmap-header';
                    cell.textContent = i;
                    heatmapDiv.appendChild(cell);
                }
                
                // Create data rows
                for (let a = 0; a <= maxRange; a++) {
                    // Row header
                    const rowHeader = document.createElement('div');
                    rowHeader.className = 'heatmap-cell heatmap-header';
                    rowHeader.textContent = a;
                    heatmapDiv.appendChild(rowHeader);
                    
                    // Data cells
                    for (let b = 0; b <= maxRange; b++) {
                        const cell = document.createElement('div');
                        cell.className = 'heatmap-cell';
                        
                        const key = `${a}x${b}`;
                        const history = this.studentData.problem_history[key];
                        
                        if (history && history.times.length > 0) {
                            const avgTime = history.times.reduce((sum, t) => sum + t, 0) / history.times.length;
                            
                            if (avgTime < 2) {
                                cell.classList.add('heatmap-fast');
                            } else if (avgTime < 4) {
                                cell.classList.add('heatmap-medium');
                            } else {
                                cell.classList.add('heatmap-slow');
                            }
                            
                            cell.title = `${a} × ${b}: ${avgTime.toFixed(1)}s avg (${history.times.length} attempts)`;
                        } else {
                            cell.classList.add('heatmap-unknown');
                            cell.title = `${a} × ${b}: Not practiced`;
                        }
                        
                        heatmapDiv.appendChild(cell);
                    }
                }
            }
            
            updateProgressScreen() {
                // Update mastery breakdown with confidence levels
                const masteryDiv = document.getElementById('mastery-breakdown');
                if (masteryDiv) {
                    const confidence = this.studentData.mastery_confidence || { bronze: 0, silver: 0, gold: 0 };
                    const totalFacts = Object.keys(this.studentData.problem_history).length;
                    const fastFacts = Object.values(this.studentData.problem_history)
                        .filter(h => {
                            if (h.times.length === 0) return false;
                            const avg = h.times.reduce((sum, t) => sum + t, 0) / h.times.length;
                            return avg < 2;
                        }).length;
                    const mediumFacts = Object.values(this.studentData.problem_history)
                        .filter(h => {
                            if (h.times.length === 0) return false;
                            const avg = h.times.reduce((sum, t) => sum + t, 0) / h.times.length;
                            return avg >= 2 && avg < 4;
                        }).length;
                    
                    masteryDiv.innerHTML = `
                        <div style="margin: 15px 0;">
                            <h4>Mastery Confidence</h4>
                            <div style="margin: 10px 0;">
                                <span class="mastery-indicator mastery-gold">Gold</span>
                                <div class="progress-bar" style="margin: 5px 0; height: 12px;">
                                    <div class="progress-fill" style="width: ${confidence.gold}%"></div>
                                </div>
                                ${confidence.gold}% (need 80% to advance)
                            </div>
                            <div style="margin: 10px 0;">
                                <span class="mastery-indicator mastery-silver">Silver</span>
                                <div class="progress-bar" style="margin: 5px 0; height: 12px;">
                                    <div class="progress-fill" style="width: ${confidence.silver}%"></div>
                                </div>
                                ${confidence.silver}% (need 60% to advance)
                            </div>
                            <div style="margin: 10px 0;">
                                <span class="mastery-indicator mastery-bronze">Bronze</span>
                                <div class="progress-bar" style="margin: 5px 0; height: 12px;">
                                    <div class="progress-fill" style="width: ${confidence.bronze}%"></div>
                                </div>
                                ${confidence.bronze}% (need 40% to advance)
                            </div>
                        </div>
                        <div style="margin: 15px 0;">
                            <h4>Fact Mastery</h4>
                            <div style="margin: 10px 0;">
                                <span style="color: var(--success)">Fast (&lt;2s):</span> ${fastFacts} facts
                            </div>
                            <div style="margin: 10px 0;">
                                <span style="color: var(--warning)">Medium (2-4s):</span> ${mediumFacts} facts
                            </div>
                            <div style="margin: 10px 0;">
                                <span style="color: var(--danger)">Slow (&gt;4s):</span> ${totalFacts - fastFacts - mediumFacts} facts
                            </div>
                        </div>
                    `;
                }
                
                // Update performance trends with session history
                const trendsDiv = document.getElementById('performance-trends');
                if (trendsDiv) {
                    const sessions = this.studentData.recent_sessions || [];
                    const sessionHistory = sessions.length >= 2 ? 
                        this.generateSessionHistoryHTML(sessions) :
                        '<p><em>Complete 2+ sessions to see trends</em></p>';
                    
                    trendsDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <p><strong>Sessions Completed:</strong> ${this.studentData.session_count}</p>
                            <p><strong>Total Problems:</strong> ${this.studentData.total_problems}</p>
                            <p><strong>Current Average:</strong> ${this.studentData.avg_speed ? this.studentData.avg_speed.toFixed(1) + 's' : '--'}</p>
                            <p><strong>Recent Sessions:</strong> ${sessions.length}/5</p>
                        </div>
                        ${sessionHistory}
                    `;
                }
                
                // Update goals with specific next steps
                const goalsDiv = document.getElementById('student-goals');
                if (goalsDiv) {
                    const nextGoal = this.getNextGoalDescription();
                    const nextRange = this.studentData.current_range.max + 1;
                    
                    goalsDiv.innerHTML = `
                        <div style="margin: 10px 0;">
                            <strong>Current Goal:</strong><br>
                            ${nextGoal}
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Next Milestone:</strong><br>
                            ${nextRange <= 20 ? `Advance to 0-${nextRange} range` : 'All ranges mastered!'}
                        </div>
                        <div style="margin: 10px 0; font-size: 0.9em; color: var(--muted);">
                            <strong>Tip:</strong> Consistent practice across multiple sessions builds lasting mastery!
                        </div>
                    `;
                }
            }
            
            generateSessionHistoryHTML(sessions) {
                if (sessions.length === 0) return '<p>No recent sessions</p>';
                
                let html = '<div style="font-size: 0.9em;">';
                html += '<strong>Recent Sessions:</strong><br>';
                
                sessions.slice(-3).reverse().forEach((session, index) => {
                    const date = new Date(session.date).toLocaleDateString();
                    const completion = (session.completionRate * 100).toFixed(0);
                    const speed = session.avgSpeed.toFixed(1);
                    const accuracy = (session.accuracy * 100).toFixed(0);
                    
                    html += `
                        <div style="margin: 5px 0; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 4px;">
                            ${date}: ${completion}% complete, ${speed}s avg, ${accuracy}% accurate
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }
            
            getNextGoalDescription() {
                const currentLevel = this.studentData.mastery_level.toLowerCase();
                const confidence = this.studentData.mastery_confidence || { bronze: 0, silver: 0, gold: 0 };
                const sessions = this.studentData.recent_sessions || [];
                
                if (currentLevel === 'bronze') {
                    const silverProgress = confidence.silver;
                    const needed = Math.max(0, 60 - silverProgress);
                    return `Reach Silver level (${silverProgress}% confidence, need ${needed}% more)`;
                } else if (currentLevel === 'silver') {
                    const goldProgress = confidence.gold;
                    const needed = Math.max(0, 80 - goldProgress);
                    return `Reach Gold level (${goldProgress}% confidence, need ${needed}% more)`;
                } else if (currentLevel === 'gold') {
                    return 'Maintain Gold mastery to advance to next range';
                } else {
                    const bronzeProgress = confidence.bronze;
                    const needed = Math.max(0, 40 - bronzeProgress);
                    return `Reach Bronze level (${bronzeProgress}% confidence, need ${needed}% more)`;
                }
            }
            
            startAgain() {
                this.quickStart();
            }
            
            showMainMenu() {
                this.hideAllScreens();
                document.getElementById('main-menu').classList.remove('hidden');
                this.updateProgressOverview();
            }
            
            hideAllScreens() {
                document.querySelectorAll('.mathletics-container > div:not(.back-btn):not(.header)').forEach(el => {
                    el.classList.add('hidden');
                });
            }
        }
        
        // Global functions for button clicks
        function quickStart() {
            window.mathletics.quickStart();
        }
        
        function showSettings() {
            window.mathletics.showSettings();
        }
        
        function startCustomSession() {
            window.mathletics.startCustomSession();
        }
        
        function showMainMenu() {
            window.mathletics.showMainMenu();
        }
        
        function showPlacementScreen() {
            window.mathletics.showPlacementScreen();
        }
        
        function setStartingRange() {
            window.mathletics.setStartingRange();
        }
        
        function startPlacementTest() {
            window.mathletics.startPlacementTest();
        }
        
        function submitAnswer() {
            window.mathletics.submitAnswer();
        }
        
        function pauseGame() {
            window.mathletics.pauseGame();
        }
        
        function startAgain() {
            window.mathletics.startAgain();
        }
        
        function showDetailedResults() {
            window.mathletics.showDetailedResults();
        }
        
        function showDetailedProgress() {
            window.mathletics.showDetailedProgress();
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.mathletics = new Mathletics();
        });
        
        // Handle messages from parent window (when embedded)
        window.addEventListener('message', function(event) {
            if (event.data.action === 'init' && event.data.authData) {
                // Initialize with auth data from parent
                console.log('Received auth data from parent');
            }
        });
    </script>
</body>
</html>
