<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>RIUTIZ - Card Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --orange: #f97316; --orange-bg: #431407;
      --green: #22c55e; --green-bg: #052e16;
      --purple: #a855f7; --purple-bg: #3b0764;
      --blue: #3b82f6; --blue-bg: #172554;
      --black: #a1a1aa; --black-bg: #18181b;
      --colorless: #d4d4d8; --colorless-bg: #27272a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #18181b, #09090b);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    /* Menu Screen */
    .menu-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .menu-title {
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--orange) 0%, var(--purple) 50%, var(--blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 60px rgba(168, 85, 247, 0.5);
      margin-bottom: 0.5rem;
    }

    .menu-subtitle { color: #71717a; margin-bottom: 2rem; }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn:active { transform: scale(0.95); }

    .btn-primary {
      background: linear-gradient(to right, var(--orange), var(--purple));
      color: white;
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.3);
    }

    .btn-secondary { background: #3f3f46; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-success { background: #16a34a; color: white; }
    .btn-warning { background: #d97706; color: white; }
    .btn-purple { background: #9333ea; color: white; }

    .menu-buttons { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 300px; }
    .menu-buttons .btn { width: 100%; }

    .menu-hints { color: #71717a; font-size: 0.875rem; max-width: 300px; text-align: center; margin-top: 1.5rem; }
    .menu-hints p { margin-bottom: 0.5rem; }

    .color-preview { display: flex; gap: 0.5rem; margin-top: 2rem; }
    .color-dot {
      width: 2.5rem; height: 2.5rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: bold; color: #000;
    }

    .online-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    .online-status.online { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .online-status.offline { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* Game Screen */
    .game-screen { display: flex; flex-direction: column; min-height: 100vh; }
    .hidden { display: none !important; }

    /* Top Bar */
    .top-bar {
      background: rgba(24, 24, 27, 0.9);
      border-bottom: 1px solid #27272a;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .player-badge {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .player-avatar {
      width: 2rem; height: 2rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold;
    }
    .player-avatar.opponent { background: rgba(239, 68, 68, 0.2); border: 2px solid #ef4444; }
    .player-avatar.you { background: rgba(59, 130, 246, 0.2); border: 2px solid #3b82f6; }

    .points { font-size: 1.5rem; font-weight: 900; }
    .points.opponent { color: #ef4444; }
    .points.you { color: #3b82f6; }

    .deck-info { font-size: 0.75rem; color: #71717a; }

    /* Battlefield */
    .battlefield { flex: 1; padding: 0.5rem; overflow-y: auto; }

    .field-zone {
      min-height: 6rem;
      background: rgba(24, 24, 27, 0.5);
      border-radius: 0.75rem;
      border: 1px solid #27272a;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .field-label { font-size: 0.7rem; color: #71717a; margin-bottom: 0.25rem; }
    .field-label .hint { color: #fbbf24; }

    .cards-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
      min-height: 5rem;
      align-items: center;
    }
    .cards-row.empty { color: #52525b; font-size: 0.875rem; }

    /* Resources */
    .resources-row {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 0.5rem;
      min-height: 2.5rem;
      align-items: center;
    }

    .resource-token {
      width: 2.5rem; height: 2.5rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: bold; color: #000;
      cursor: pointer;
      transition: all 0.2s;
    }
    .resource-token:not(.spent):hover { transform: scale(1.1); }
    .resource-token.spent { opacity: 0.4; transform: rotate(90deg); }

    /* Phase Indicator */
    .phase-divider {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
    }
    .phase-line { flex: 1; height: 1px; background: linear-gradient(to right, transparent, #3f3f46, transparent); }

    .phases { display: flex; gap: 0.25rem; align-items: center; }
    .phase {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.7rem;
      font-weight: bold;
      background: #27272a;
      color: #71717a;
      transition: all 0.2s;
    }
    .phase.active { background: #f59e0b; color: #000; transform: scale(1.1); }

    .turn-indicator { margin-left: 0.5rem; font-size: 0.75rem; }
    .turn-indicator.your-turn { color: #22c55e; }
    .turn-indicator.opp-turn { color: #ef4444; }

    /* Message Bar */
    .message-bar {
      background: rgba(39, 39, 42, 0.8);
      padding: 0.5rem 1rem;
      text-align: center;
      font-size: 0.875rem;
    }

    /* Hand */
    .hand-area {
      background: rgba(24, 24, 27, 0.9);
      border-top: 1px solid #27272a;
      padding: 0.5rem;
    }
    .hand-scroll {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.5rem;
      scroll-snap-type: x mandatory;
    }
    .hand-scroll > div { scroll-snap-align: center; flex-shrink: 0; }

    /* Action Bar */
    .action-bar {
      background: #09090b;
      border-top: 1px solid #27272a;
      padding: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
    }

    .player-info { display: flex; align-items: center; gap: 0.5rem; }
    .action-buttons { display: flex; gap: 0.5rem; }
    .action-buttons .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }

    /* Cards */
    .card {
      position: relative;
      border-radius: 0.5rem;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .card.small { width: 4rem; height: 6rem; font-size: 6px; }
    .card.in-hand { width: 6rem; height: 9rem; font-size: 10px; }
    .card.large { width: 7rem; height: 10rem; font-size: 12px; }

    .card:active { transform: scale(0.95); }
    .card.selected { box-shadow: 0 0 0 3px #facc15; transform: scale(1.05); z-index: 20; }
    .card.attacker { box-shadow: 0 0 0 3px #ef4444; transform: translateY(-1rem) scale(1.1); z-index: 10; }
    .card.blocker { box-shadow: 0 0 0 3px #3b82f6; }
    .card.targetable { box-shadow: 0 0 0 2px #fbbf24, 0 0 15px rgba(251, 191, 36, 0.5); }
    .card.spent { transform: rotate(90deg); opacity: 0.6; }
    .card.attacker.spent { transform: rotate(90deg) translateX(-1rem) scale(1.1); }

    .card-inner { height: 100%; padding: 0.25rem; display: flex; flex-direction: column; }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .card-cost { display: flex; gap: 2px; flex-shrink: 0; }
    .mana-pip {
      width: 1em; height: 1em;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8em; font-weight: bold; color: #000;
    }
    .mana-pip.generic { background: #52525b; color: white; border: 1px solid #71717a; }

    .card-type { color: #a1a1aa; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .card-art {
      flex: 1;
      margin: 0.25rem 0;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      opacity: 0.6;
    }

    .card-stats { display: flex; justify-content: space-between; font-size: 0.9em; }
    .stat-dice { color: #fbbf24; }
    .stat-hp { color: #ef4444; }

    .card-ability {
      font-size: 0.85em;
      color: #d4d4d8;
      line-height: 1.2;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .card-rarity {
      position: absolute;
      bottom: 0.25rem;
      right: 0.25rem;
      width: 0.5rem; height: 0.5rem;
      border-radius: 50%;
    }
    .card-rarity.R { background: #f59e0b; }
    .card-rarity.U { background: #6366f1; }
    .card-rarity.C { background: #71717a; }

    .card-indicator {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      width: 1rem; height: 1rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.6rem;
    }
    .indicator-bearings { background: rgba(234, 179, 8, 0.8); }
    .indicator-activate { background: rgba(147, 51, 234, 0.8); }

    /* Card Preview Overlay */
    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
    }

    .preview-card {
      width: 18rem;
      border-radius: 1rem;
      overflow: hidden;
      animation: zoomIn 0.15s ease-out;
    }
    @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .preview-header { padding: 1rem 1rem 0.5rem; }
    .preview-name-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem; }
    .preview-name { font-size: 1.25rem; font-weight: bold; }
    .preview-cost { display: flex; gap: 0.25rem; }
    .preview-cost .mana-pip { width: 1.75rem; height: 1.75rem; font-size: 0.875rem; }
    .preview-type { color: #a1a1aa; font-size: 0.875rem; }

    .preview-art {
      height: 8rem;
      margin: 0 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      opacity: 0.6;
    }

    .preview-stats { display: flex; justify-content: space-between; padding: 0.5rem 1rem; font-size: 1rem; }
    .preview-stats span { font-weight: bold; }

    .preview-ability { padding: 0.75rem 1rem; min-height: 5rem; }
    .preview-ability p { font-size: 0.875rem; line-height: 1.5; color: #e4e4e7; }
    .preview-ability .no-ability { color: #71717a; font-style: italic; }

    .preview-resource { padding: 0 1rem 0.75rem; border-top: 1px solid #3f3f46; margin-top: 0.5rem; padding-top: 0.5rem; }
    .preview-resource p { font-size: 0.75rem; color: #a1a1aa; }
    .preview-resource span { color: #71717a; }

    .preview-footer { padding: 0 1rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    .preview-rarity { font-size: 0.75rem; color: #71717a; }
    .preview-hint { text-align: center; color: #71717a; font-size: 0.75rem; padding-bottom: 0.75rem; }

    /* Victory Screen */
    .victory-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1rem;
    }
    .victory-title { font-size: 3rem; color: #fbbf24; margin-bottom: 1rem; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .victory-text { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .victory-score { color: #71717a; margin-bottom: 2rem; }

    /* Turn Counter */
    .turn-counter {
      position: fixed;
      top: 3.5rem;
      left: 0.5rem;
      background: rgba(24, 24, 27, 0.8);
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      z-index: 10;
    }

    /* Lobby Screen */
    .lobby-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    .lobby-title { font-size: 2rem; font-weight: bold; margin-bottom: 1rem; }
    .lobby-code { font-size: 3rem; font-weight: 900; color: var(--orange); letter-spacing: 0.5rem; margin-bottom: 2rem; }

    .lobby-players {
      width: 100%;
      max-width: 400px;
      margin-bottom: 2rem;
    }

    .lobby-player {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #27272a;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .lobby-player.ready { border-left: 4px solid var(--green); }
    .lobby-player .ready-badge { color: var(--green); font-size: 0.875rem; }

    .lobby-waiting { color: #71717a; font-style: italic; padding: 1rem; text-align: center; }

    /* Deck Builder */
    .deck-builder-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0.5rem;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
    }

    .deck-builder-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: rgba(24, 24, 27, 0.9);
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .deck-builder-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--orange);
    }

    .deck-builder-actions { display: flex; gap: 0.5rem; }
    .deck-builder-actions .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }

    .deck-mode-toggle {
      display: flex;
      gap: 0.25rem;
      background: #1a1a1e;
      padding: 0.25rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .deck-mode-btn {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 0.375rem;
      background: transparent;
      color: #71717a;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .deck-mode-btn.active {
      background: var(--orange);
      color: #000;
    }

    .deck-stats {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #27272a;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .deck-stat {
      text-align: center;
      flex: 1;
      min-width: 60px;
    }
    .deck-stat-value { font-size: 1.25rem; font-weight: bold; }
    .deck-stat-label { font-size: 0.65rem; color: #71717a; }
    .deck-stat-value.valid { color: var(--green); }
    .deck-stat-value.invalid { color: #ef4444; }

    .deck-builder-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 0.5rem;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .deck-builder-content {
        flex-direction: row;
      }
      .card-browser { flex: 2; }
      .deck-panel { flex: 1; max-width: 350px; }
    }

    .card-browser {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #1a1a1e;
      border-radius: 0.5rem;
    }

    .card-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      padding: 0.5rem;
      border-bottom: 1px solid #27272a;
    }

    .filter-btn {
      padding: 0.25rem 0.5rem;
      border: 1px solid #3f3f46;
      border-radius: 0.25rem;
      background: transparent;
      color: #a1a1aa;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover { background: #27272a; }
    .filter-btn.active { background: var(--orange); color: #000; border-color: var(--orange); }

    .filter-search {
      flex: 1;
      min-width: 100px;
      padding: 0.25rem 0.5rem;
      border: 1px solid #3f3f46;
      border-radius: 0.25rem;
      background: #27272a;
      color: white;
      font-size: 0.75rem;
    }

    .card-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(4.5rem, 1fr));
      gap: 0.5rem;
    }

    .card-grid-item {
      position: relative;
      cursor: pointer;
    }

    .card-grid-item .card-count {
      position: absolute;
      top: -0.25rem;
      right: -0.25rem;
      background: var(--orange);
      color: #000;
      font-size: 0.7rem;
      font-weight: bold;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .card-grid-item .owned-count {
      position: absolute;
      bottom: 0.25rem;
      left: 0.25rem;
      background: rgba(0,0,0,0.8);
      color: #71717a;
      font-size: 0.6rem;
      padding: 0.1rem 0.25rem;
      border-radius: 0.25rem;
    }

    .deck-panel {
      display: flex;
      flex-direction: column;
      background: #1a1a1e;
      border-radius: 0.5rem;
      overflow: hidden;
      max-height: 40vh;
    }

    @media (min-width: 768px) {
      .deck-panel { max-height: none; }
    }

    .deck-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #27272a;
    }

    .deck-name-input {
      flex: 1;
      padding: 0.25rem 0.5rem;
      border: 1px solid #3f3f46;
      border-radius: 0.25rem;
      background: #27272a;
      color: white;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }

    .deck-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .deck-card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.375rem 0.5rem;
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .deck-card-row:hover { background: #27272a; }

    .deck-card-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      overflow: hidden;
    }

    .deck-card-cost {
      display: flex;
      gap: 2px;
    }

    .deck-card-cost .mana-pip {
      width: 1rem;
      height: 1rem;
      font-size: 0.6rem;
    }

    .deck-card-name {
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .deck-card-count {
      font-size: 0.8rem;
      color: #71717a;
      margin-left: 0.5rem;
    }

    .deck-card-remove {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1rem;
      opacity: 0.6;
    }

    .deck-card-remove:hover { opacity: 1; }

    .mana-curve {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 50px;
      padding: 0.5rem;
      border-top: 1px solid #27272a;
    }

    .curve-bar {
      flex: 1;
      background: var(--orange);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      position: relative;
    }

    .curve-bar-label {
      position: absolute;
      bottom: -1rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: #71717a;
    }

    .deck-actions {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      border-top: 1px solid #27272a;
    }

    .deck-actions .btn { flex: 1; padding: 0.5rem; font-size: 0.8rem; }

    .saved-decks-panel {
      background: #1a1a1e;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
      max-height: 150px;
      overflow-y: auto;
    }

    .saved-deck-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #27272a;
      cursor: pointer;
    }

    .saved-deck-row:hover { background: #27272a; }
    .saved-deck-row:last-child { border-bottom: none; }

    .saved-deck-info { flex: 1; }
    .saved-deck-name { font-size: 0.875rem; font-weight: bold; }
    .saved-deck-count { font-size: 0.75rem; color: #71717a; }

    .empty-deck-message {
      text-align: center;
      padding: 2rem 1rem;
      color: #71717a;
      font-size: 0.875rem;
    }

    /* Loading */
    .loading { text-align: center; padding: 2rem; color: #71717a; }
  </style>
</head>
<body>
  <!-- Menu Screen -->
  <div id="menu-screen" class="menu-screen">
    <div id="online-status" class="online-status offline">Offline Mode</div>
    <h1 class="menu-title">RIUTIZ</h1>
    <p class="menu-subtitle">The Competitive Card Game</p>
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="startQuickGame()">Play vs AI</button>
      <button class="btn btn-secondary" onclick="showDeckBuilder()">Deck Builder</button>
      <button class="btn btn-purple" onclick="showMultiplayerMenu()" id="multiplayer-btn">Multiplayer</button>
    </div>
    <div class="menu-hints">
      <p>First to 25 points wins!</p>
      <p>Roll dice to attack</p>
      <p>Tap to select - Hold to preview</p>
    </div>
    <div class="color-preview">
      <div class="color-dot" style="background: var(--orange)">O</div>
      <div class="color-dot" style="background: var(--green)">G</div>
      <div class="color-dot" style="background: var(--purple)">P</div>
      <div class="color-dot" style="background: var(--blue)">B</div>
      <div class="color-dot" style="background: var(--black)">Bk</div>
    </div>
    <div id="loading-status" class="loading"></div>
  </div>

  <!-- Multiplayer Menu -->
  <div id="multiplayer-menu" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2.5rem;">Multiplayer</h2>
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="findMatch('casual')">Quick Match (Casual)</button>
      <button class="btn btn-warning" onclick="findMatch('ranked')">Ranked Match</button>
      <button class="btn btn-secondary" onclick="createLobby()">Create Lobby</button>
      <button class="btn btn-secondary" onclick="showJoinLobby()">Join Lobby</button>
      <button class="btn btn-danger" onclick="showMenu()">Back</button>
    </div>
    <div id="queue-status" class="loading hidden"></div>
  </div>

  <!-- Join Lobby -->
  <div id="join-lobby-screen" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2rem;">Join Lobby</h2>
    <input type="text" id="lobby-code-input" placeholder="Enter Code" maxlength="6"
           style="font-size: 2rem; text-align: center; padding: 1rem; background: #27272a; border: 2px solid #3f3f46; border-radius: 0.5rem; color: white; text-transform: uppercase; width: 200px; margin-bottom: 1rem;">
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="joinLobbyByCode()">Join</button>
      <button class="btn btn-secondary" onclick="showMultiplayerMenu()">Back</button>
    </div>
  </div>

  <!-- Lobby Screen -->
  <div id="lobby-screen" class="lobby-screen hidden">
    <h2 class="lobby-title">Lobby</h2>
    <div class="lobby-code" id="lobby-code-display">------</div>
    <div class="lobby-players" id="lobby-players">
      <div class="lobby-waiting">Waiting for players...</div>
    </div>
    <div class="menu-buttons">
      <button class="btn btn-success hidden" id="start-match-btn" onclick="startLobbyMatch()">Start Match</button>
      <button class="btn btn-primary" id="ready-btn" onclick="toggleReady()">Ready Up</button>
      <button class="btn btn-danger" onclick="leaveLobbyScreen()">Leave</button>
    </div>
  </div>

  <!-- Deck Builder Screen -->
  <div id="deck-builder-screen" class="deck-builder-screen hidden">
    <div class="deck-builder-header">
      <span class="deck-builder-title">Deck Builder</span>
      <div class="deck-builder-actions">
        <button class="btn btn-secondary" onclick="closeDeckBuilder()">Back</button>
      </div>
    </div>

    <!-- Mode Toggle -->
    <div class="deck-mode-toggle">
      <button class="deck-mode-btn active" data-mode="casual" onclick="setDeckMode('casual')">Casual (All Cards)</button>
      <button class="deck-mode-btn" data-mode="ranked" onclick="setDeckMode('ranked')">Ranked (Owned)</button>
    </div>

    <!-- Deck Stats -->
    <div class="deck-stats">
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-size-stat">0</div>
        <div class="deck-stat-label">Cards</div>
      </div>
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-unique-stat">0</div>
        <div class="deck-stat-label">Unique</div>
      </div>
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-pupils-stat">0</div>
        <div class="deck-stat-label">Pupils</div>
      </div>
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-spells-stat">0</div>
        <div class="deck-stat-label">Spells</div>
      </div>
    </div>

    <div class="deck-builder-content">
      <!-- Card Browser -->
      <div class="card-browser">
        <div class="card-filters">
          <button class="filter-btn" data-filter="color" data-value="" onclick="setCardFilter('color', null)">All</button>
          <button class="filter-btn" data-filter="color" data-value="O" onclick="setCardFilter('color', 'O')" style="background: var(--orange-bg); border-color: var(--orange);">O</button>
          <button class="filter-btn" data-filter="color" data-value="G" onclick="setCardFilter('color', 'G')" style="background: var(--green-bg); border-color: var(--green);">G</button>
          <button class="filter-btn" data-filter="color" data-value="P" onclick="setCardFilter('color', 'P')" style="background: var(--purple-bg); border-color: var(--purple);">P</button>
          <button class="filter-btn" data-filter="color" data-value="B" onclick="setCardFilter('color', 'B')" style="background: var(--blue-bg); border-color: var(--blue);">B</button>
          <button class="filter-btn" data-filter="color" data-value="Bk" onclick="setCardFilter('color', 'Bk')" style="background: var(--black-bg); border-color: var(--black);">Bk</button>
          <input type="text" class="filter-search" id="card-search" placeholder="Search cards..." oninput="setCardFilter('search', this.value)">
        </div>
        <div class="card-grid-container">
          <div class="card-grid" id="card-grid"></div>
        </div>
      </div>

      <!-- Deck Panel -->
      <div class="deck-panel">
        <div class="deck-panel-header">
          <input type="text" class="deck-name-input" id="deck-name-input" value="New Deck" placeholder="Deck Name">
          <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="clearCurrentDeck()">Clear</button>
        </div>
        <div class="deck-list" id="deck-list">
          <div class="empty-deck-message">Click cards to add them to your deck</div>
        </div>
        <div class="mana-curve" id="mana-curve">
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">0</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">1</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">2</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">3</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">4</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">5</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">6+</span></div>
        </div>
        <div class="deck-actions">
          <button class="btn btn-success" onclick="saveDeck()">Save Deck</button>
          <button class="btn btn-secondary" onclick="showSavedDecks()">Load</button>
        </div>
      </div>
    </div>

    <!-- Saved Decks Panel (hidden by default) -->
    <div class="saved-decks-panel hidden" id="saved-decks-panel">
      <div class="deck-panel-header" style="padding: 0.5rem;">
        <span style="font-weight: bold;">Saved Decks</span>
        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="hideSavedDecks()">Close</button>
      </div>
      <div id="saved-decks-list"></div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="game-screen hidden">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="player-badge">
        <div class="player-avatar opponent">2</div>
        <span id="opponent-name" style="font-size: 0.875rem;">Opponent</span>
      </div>
      <div class="points opponent" id="opp-points">0 pts</div>
      <div class="deck-info">
        <span id="opp-hand-count">7</span>
        <span id="opp-deck-count">33</span>
      </div>
    </div>

    <!-- Battlefield -->
    <div class="battlefield">
      <!-- Opponent Resources -->
      <div class="resources-row" id="opp-resources"></div>

      <!-- Opponent Field -->
      <div class="field-zone">
        <div class="field-label">Opponent's Field</div>
        <div class="cards-row" id="opp-field"></div>
      </div>

      <!-- Phase Divider -->
      <div class="phase-divider">
        <div class="phase-line"></div>
        <div class="phases">
          <div class="phase" data-phase="draw">Draw</div>
          <div class="phase" data-phase="ready">Ready</div>
          <div class="phase" data-phase="main">Main</div>
          <div class="phase" data-phase="combat">Combat</div>
          <div class="phase" data-phase="end">End</div>
        </div>
        <span class="turn-indicator" id="turn-indicator">Your Turn</span>
        <div class="phase-line"></div>
      </div>

      <!-- Your Field -->
      <div class="field-zone">
        <div class="field-label">Your Field <span class="hint" id="field-hint"></span></div>
        <div class="cards-row" id="your-field"></div>
      </div>

      <!-- Your Resources -->
      <div class="resources-row" id="your-resources"></div>
    </div>

    <!-- Message Bar -->
    <div class="message-bar" id="message">Tap a card to select - Hold to preview</div>

    <!-- Your Hand -->
    <div class="hand-area">
      <div class="hand-scroll" id="your-hand"></div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="player-info">
        <div class="player-avatar you">1</div>
        <div>
          <div class="points you" id="your-points">0 pts</div>
          <div class="deck-info">
            <span id="your-hand-count">7</span>
            <span id="your-deck-count">33</span>
          </div>
        </div>
      </div>
      <div class="action-buttons" id="action-buttons"></div>
    </div>

    <!-- Turn Counter -->
    <div class="turn-counter">Turn <span id="turn-number">1</span></div>
  </div>

  <!-- Victory Screen -->
  <div id="victory-screen" class="victory-screen hidden">
    <h1 class="victory-title">VICTORY!</h1>
    <p class="victory-text" id="winner-text">Player 1 Wins!</p>
    <p class="victory-score" id="final-score">Final Score: 0 - 0</p>
    <button class="btn btn-warning" onclick="showMenu()">Play Again</button>
  </div>

  <!-- Card Preview Overlay -->
  <div id="preview-overlay" class="preview-overlay hidden"></div>

<!-- Load Scripts -->
<script src="Data/Riutiz/cards.json" type="application/json" id="card-data-json"></script>

<!-- Arcade System -->
<script src="../firebase/firebase-config.js"></script>
<script src="../shared/arcade/FirebaseManager.js"></script>
<script src="../shared/arcade/ArcadeManager.js"></script>
<script src="../shared/arcade/MatchmakingManager.js"></script>
<script src="../shared/arcade/MultiplayerSync.js"></script>
<script src="../shared/arcade/LeaderboardManager.js"></script>

<!-- Game Modules -->
<script src="riutiz/RiutizGame.js"></script>
<script src="riutiz/RiutizAI.js"></script>
<script src="riutiz/RiutizUI.js"></script>
<script src="riutiz/RiutizCollection.js"></script>
<script src="riutiz/RiutizDeckBuilder.js"></script>
<script src="riutiz/RiutizMultiplayer.js"></script>
<script src="riutiz/RiutizArt.js"></script>

<script>
// ============================================
// GAME INITIALIZATION
// ============================================
let CARD_DATA = [];
let game = null;
let ui = null;
let ai = null;
let collection = null;
let deckBuilder = null;
let multiplayer = null;
let isReady = false;

// ============================================
// INITIALIZATION
// ============================================
async function init() {
  const status = document.getElementById('loading-status');
  status.textContent = 'Loading cards...';

  try {
    // Load card data
    const response = await fetch('Data/Riutiz/cards.json');
    if (response.ok) {
      CARD_DATA = await response.json();
      status.textContent = `Loaded ${CARD_DATA.length} cards`;
    } else {
      throw new Error('Failed to load cards');
    }

    // Try to initialize arcade (may fail if Firebase not configured)
    try {
      await initializeArcade({ firebaseConfig: window.FIREBASE_CONFIG });

      if (window.arcade && window.arcade.isOnline) {
        document.getElementById('online-status').textContent = 'Online';
        document.getElementById('online-status').className = 'online-status online';

        // Initialize collection
        collection = new RiutizCollection(window.arcade, CARD_DATA);
        await collection.load();
      }
    } catch (e) {
      console.log('Running in offline mode:', e.message);
    }

    // Initialize deck builder
    deckBuilder = new RiutizDeckBuilder(collection, CARD_DATA, { arcade: window.arcade });
    await deckBuilder.loadDecks();

    setTimeout(() => status.textContent = '', 2000);

  } catch (err) {
    status.textContent = 'Error loading. Refresh to retry.';
    console.error(err);
  }
}

// ============================================
// GAME FUNCTIONS
// ============================================
function startQuickGame() {
  // Create game instance
  game = new RiutizGame({
    mode: 'vs-ai',
    cardData: CARD_DATA
  });

  // Create UI
  ui = new RiutizUI(game, {
    localPlayer: 1,
    onCardClick: (card, location) => console.log('Card clicked:', card.name, location)
  });
  ui.init();

  // Create AI
  ai = new RiutizAI(game, 2);

  // Set up game event listeners
  game.addEventListener('turnEnded', (e) => {
    if (e.detail.nextPlayer === 2) {
      setTimeout(() => ai.takeTurn(), 500);
    }
    ui.render();
  });

  game.addEventListener('combatStarted', () => ui.render());
  game.addEventListener('attackersDeclared', () => {
    ui.render();
    // AI declares blockers after player confirms attackers
    if (game.state.currentPlayer === 1) {
      setTimeout(() => ai.declareBlockers(), 1000);
    }
  });

  game.addEventListener('combatResolved', (e) => {
    ui.setMessage(e.detail.pointsScored > 0 ?
      `Dealt ${e.detail.pointsScored} points!` :
      'Combat resolved!');
    ui.render();
  });

  game.addEventListener('gameOver', (e) => {
    ui.showVictoryScreen(
      e.detail.winner,
      game.state.players[1].points,
      game.state.players[2].points
    );
  });

  // Start game
  game.startGame();

  // Show game screen
  ui.showGameScreen();
  ui.setMessage('Game started! Your turn.');
  ui.render();
}

function showMenu() {
  document.querySelectorAll('.menu-screen, .game-screen, .victory-screen, .lobby-screen').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById('menu-screen').classList.remove('hidden');
}

// ============================================
// MULTIPLAYER FUNCTIONS
// ============================================
function showMultiplayerMenu() {
  document.getElementById('menu-screen').classList.add('hidden');
  document.getElementById('multiplayer-menu').classList.remove('hidden');
}

async function findMatch(mode) {
  if (!window.arcade || !window.arcade.isOnline) {
    alert('Multiplayer requires online connection');
    return;
  }

  const status = document.getElementById('queue-status');
  status.classList.remove('hidden');
  status.textContent = 'Finding match...';

  try {
    // Initialize multiplayer if needed
    if (!multiplayer) {
      game = new RiutizGame({ mode: 'online-pvp', cardData: CARD_DATA });
      multiplayer = new RiutizMultiplayer(game, window.arcade);
      await multiplayer.initialize();

      multiplayer.onMatchStartCallback((match) => {
        startMultiplayerGame(match);
      });
    }

    await multiplayer.joinQueue({ mode, deckId: null });

  } catch (error) {
    status.textContent = 'Error: ' + error.message;
    console.error(error);
  }
}

async function createLobby() {
  if (!window.arcade || !window.arcade.isOnline) {
    alert('Multiplayer requires online connection');
    return;
  }

  try {
    if (!multiplayer) {
      game = new RiutizGame({ mode: 'online-pvp', cardData: CARD_DATA });
      multiplayer = new RiutizMultiplayer(game, window.arcade);
      await multiplayer.initialize();
    }

    const result = await multiplayer.createLobby({ mode: 'casual' });

    document.getElementById('multiplayer-menu').classList.add('hidden');
    document.getElementById('lobby-screen').classList.remove('hidden');
    document.getElementById('lobby-code-display').textContent = result.joinCode;
    document.getElementById('start-match-btn').classList.remove('hidden');

    updateLobbyUI();

    multiplayer.matchmaking.onLobbyChange((data) => {
      if (data.event === 'match_started') {
        startMultiplayerGame(data);
      } else {
        updateLobbyUI();
      }
    });

  } catch (error) {
    alert('Error creating lobby: ' + error.message);
  }
}

function showJoinLobby() {
  document.getElementById('multiplayer-menu').classList.add('hidden');
  document.getElementById('join-lobby-screen').classList.remove('hidden');
}

async function joinLobbyByCode() {
  const code = document.getElementById('lobby-code-input').value.toUpperCase();
  if (code.length < 4) {
    alert('Please enter a valid code');
    return;
  }

  try {
    if (!multiplayer) {
      game = new RiutizGame({ mode: 'online-pvp', cardData: CARD_DATA });
      multiplayer = new RiutizMultiplayer(game, window.arcade);
      await multiplayer.initialize();
    }

    await multiplayer.joinLobby(code);

    document.getElementById('join-lobby-screen').classList.add('hidden');
    document.getElementById('lobby-screen').classList.remove('hidden');
    document.getElementById('lobby-code-display').textContent = code;
    document.getElementById('start-match-btn').classList.add('hidden');

    updateLobbyUI();

    multiplayer.matchmaking.onLobbyChange((data) => {
      if (data.event === 'match_started') {
        startMultiplayerGame(data);
      } else {
        updateLobbyUI();
      }
    });

  } catch (error) {
    alert('Error joining lobby: ' + error.message);
  }
}

function updateLobbyUI() {
  const lobby = multiplayer?.currentLobby;
  if (!lobby) return;

  const container = document.getElementById('lobby-players');
  container.innerHTML = '';

  for (const [id, player] of Object.entries(lobby.players || {})) {
    const div = document.createElement('div');
    div.className = 'lobby-player' + (player.ready ? ' ready' : '');
    div.innerHTML = `
      <span>${player.display_name}${player.is_host ? ' (Host)' : ''}</span>
      <span class="ready-badge">${player.ready ? 'Ready' : 'Not Ready'}</span>
    `;
    container.appendChild(div);
  }
}

async function toggleReady() {
  isReady = !isReady;
  await multiplayer.setReady(isReady, null);
  document.getElementById('ready-btn').textContent = isReady ? 'Unready' : 'Ready Up';
  document.getElementById('ready-btn').className = 'btn ' + (isReady ? 'btn-danger' : 'btn-primary');
}

async function startLobbyMatch() {
  try {
    await multiplayer.startMatchFromLobby();
  } catch (error) {
    alert('Error starting match: ' + error.message);
  }
}

async function leaveLobbyScreen() {
  if (multiplayer) {
    await multiplayer.leaveLobby();
  }
  showMultiplayerMenu();
}

function startMultiplayerGame(match) {
  // Hide lobby/menu
  document.querySelectorAll('.menu-screen, .lobby-screen').forEach(el => {
    el.classList.add('hidden');
  });

  // Set up UI
  ui = new RiutizUI(game, {
    localPlayer: multiplayer.localPlayerNumber
  });
  ui.init();

  // Set opponent name
  const opponent = multiplayer.sync.getOpponent();
  document.getElementById('opponent-name').textContent = opponent?.display_name || 'Opponent';

  // Show game
  ui.showGameScreen();
  ui.setMessage('Match started!');
  ui.render();
}

// ============================================
// DECK BUILDER
// ============================================
function showDeckBuilder() {
  document.querySelectorAll('.menu-screen, .game-screen, .victory-screen, .lobby-screen').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById('deck-builder-screen').classList.remove('hidden');

  // Initialize deck builder if needed
  if (!deckBuilder) {
    deckBuilder = new RiutizDeckBuilder(collection, CARD_DATA, { arcade: window.arcade });
  }

  // Render the deck builder
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function closeDeckBuilder() {
  document.getElementById('deck-builder-screen').classList.add('hidden');
  document.getElementById('menu-screen').classList.remove('hidden');
}

function setDeckMode(mode) {
  deckBuilder.setMode(mode);

  // Update UI
  document.querySelectorAll('.deck-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function setCardFilter(filterType, value) {
  deckBuilder.setFilter(filterType, value);

  // Update active state for color filters
  if (filterType === 'color') {
    document.querySelectorAll('.filter-btn[data-filter="color"]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.value === (value || ''));
    });
  }

  renderCardGrid();
}

function renderCardGrid() {
  const grid = document.getElementById('card-grid');
  const cards = deckBuilder.getFilteredCards();

  grid.innerHTML = cards.map(card => {
    const inDeck = deckBuilder.getCardCount(card.id);
    const owned = collection ? collection.getQuantity(card.id) : 99;
    const color = getCardColor(card.cost);
    const bgColor = getCardBgColor(color);

    return `
      <div class="card-grid-item" onclick="addCardToDeck(${card.id})" oncontextmenu="showCardPreview(${card.id}); return false;">
        ${inDeck > 0 ? `<div class="card-count">${inDeck}</div>` : ''}
        ${deckBuilder.mode === 'ranked' ? `<div class="owned-count">x${owned}</div>` : ''}
        <div class="card small" style="background: ${bgColor};">
          <div class="card-inner">
            <div class="card-header">
              <span class="card-name">${card.name}</span>
            </div>
            <div class="card-cost">${renderManaCost(card.cost)}</div>
            <div class="card-art" style="background: ${bgColor};">${getCardEmoji(card.type)}</div>
            <div class="card-stats">
              ${card.dice ? `<span class="stat-dice">${card.dice}d</span>` : ''}
              ${card.hp ? `<span class="stat-hp">${card.hp}hp</span>` : ''}
            </div>
            <div class="card-rarity ${card.rarity || 'C'}"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderDeckList() {
  const list = document.getElementById('deck-list');
  const deckCards = deckBuilder.getDeckCards();

  if (deckCards.length === 0) {
    list.innerHTML = '<div class="empty-deck-message">Click cards to add them to your deck</div>';
    return;
  }

  list.innerHTML = deckCards.map(card => {
    const color = getCardColor(card.cost);
    return `
      <div class="deck-card-row" onclick="showCardPreview(${card.id})">
        <div class="deck-card-info">
          <div class="deck-card-cost">${renderManaCost(card.cost)}</div>
          <span class="deck-card-name">${card.name}</span>
        </div>
        <span class="deck-card-count">x${card.count}</span>
        <button class="deck-card-remove" onclick="event.stopPropagation(); removeCardFromDeck(${card.id})">-</button>
      </div>
    `;
  }).join('');

  // Update deck name input
  document.getElementById('deck-name-input').value = deckBuilder.deckName;
}

function updateDeckStats() {
  const stats = deckBuilder.getDeckStats();
  const isValid = stats.size >= deckBuilder.minDeckSize;

  document.getElementById('deck-size-stat').textContent = stats.size;
  document.getElementById('deck-size-stat').className = 'deck-stat-value ' + (isValid ? 'valid' : 'invalid');
  document.getElementById('deck-unique-stat').textContent = stats.uniqueCards;
  document.getElementById('deck-pupils-stat').textContent = stats.types.Pupil;
  document.getElementById('deck-spells-stat').textContent = stats.types.Interruption + stats.types.Tool + stats.types.Location;

  // Update mana curve
  renderManaCurve(stats.curve);
}

function renderManaCurve(curve) {
  const container = document.getElementById('mana-curve');
  const maxVal = Math.max(...Object.values(curve), 1);
  const labels = ['0', '1', '2', '3', '4', '5', '6+'];

  container.innerHTML = labels.map((label, i) => {
    const key = i >= 6 ? '6+' : i;
    const count = curve[key] || 0;
    const height = Math.round((count / maxVal) * 100);
    return `
      <div class="curve-bar" style="height: ${height}%;" title="${count} cards at cost ${label}">
        <span class="curve-bar-label">${label}</span>
      </div>
    `;
  }).join('');
}

function addCardToDeck(cardId) {
  const result = deckBuilder.addCard(cardId);
  if (!result.success) {
    showToast(result.error);
    return;
  }

  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function removeCardFromDeck(cardId) {
  deckBuilder.removeCard(cardId);
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function clearCurrentDeck() {
  if (deckBuilder.currentDeck.length > 0 && !confirm('Clear all cards from deck?')) {
    return;
  }
  deckBuilder.clearDeck();
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

async function saveDeck() {
  const name = document.getElementById('deck-name-input').value.trim();
  if (!name) {
    showToast('Please enter a deck name');
    return;
  }

  const result = await deckBuilder.saveDeck(name);
  if (!result.success) {
    showToast('Deck invalid: ' + result.errors[0]);
    return;
  }

  showToast('Deck saved!');
}

function showSavedDecks() {
  const panel = document.getElementById('saved-decks-panel');
  const list = document.getElementById('saved-decks-list');

  const decks = Object.values(deckBuilder.savedDecks);
  const starters = deckBuilder.starterDecks || [];

  let html = '';

  // Starter decks
  if (starters.length > 0) {
    html += '<div style="padding: 0.5rem; color: #71717a; font-size: 0.75rem;">Starter Decks</div>';
    starters.forEach(deck => {
      html += `
        <div class="saved-deck-row" onclick="loadStarterDeck('${deck.id}')">
          <div class="saved-deck-info">
            <div class="saved-deck-name">${deck.name}</div>
            <div class="saved-deck-count">${deck.card_count} cards</div>
          </div>
        </div>
      `;
    });
  }

  // Saved decks
  if (decks.length > 0) {
    html += '<div style="padding: 0.5rem; color: #71717a; font-size: 0.75rem; border-top: 1px solid #27272a;">Your Decks</div>';
    decks.forEach(deck => {
      html += `
        <div class="saved-deck-row" onclick="loadSavedDeck('${deck.id}')">
          <div class="saved-deck-info">
            <div class="saved-deck-name">${deck.name}</div>
            <div class="saved-deck-count">${deck.card_count} cards</div>
          </div>
          <button class="deck-card-remove" onclick="event.stopPropagation(); deleteSavedDeck('${deck.id}')">Ã—</button>
        </div>
      `;
    });
  }

  if (!html) {
    html = '<div class="empty-deck-message">No saved decks yet</div>';
  }

  list.innerHTML = html;
  panel.classList.remove('hidden');
}

function hideSavedDecks() {
  document.getElementById('saved-decks-panel').classList.add('hidden');
}

function loadSavedDeck(deckId) {
  deckBuilder.loadDeck(deckId);
  hideSavedDecks();
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function loadStarterDeck(deckId) {
  deckBuilder.loadStarterDeck(deckId);
  hideSavedDecks();
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

async function deleteSavedDeck(deckId) {
  if (!confirm('Delete this deck?')) return;
  await deckBuilder.deleteDeck(deckId);
  showSavedDecks();
}

function showCardPreview(cardId) {
  const card = CARD_DATA.find(c => c.id === cardId);
  if (!card) return;

  const overlay = document.getElementById('preview-overlay');
  const color = getCardColor(card.cost);
  const bgColor = getCardBgColor(color);

  overlay.innerHTML = `
    <div class="preview-card" style="background: ${bgColor};">
      <div class="preview-header">
        <div class="preview-name-row">
          <span class="preview-name">${card.name}</span>
          <div class="preview-cost">${renderManaCost(card.cost)}</div>
        </div>
        <div class="preview-type">${card.type || 'Unknown'}</div>
      </div>
      <div class="preview-art" style="background: ${bgColor};">${getCardEmoji(card.type)}</div>
      <div class="preview-stats">
        ${card.dice ? `<span><span class="stat-dice">Dice:</span> ${card.dice}</span>` : ''}
        ${card.hp ? `<span><span class="stat-hp">HP:</span> ${card.hp}</span>` : ''}
      </div>
      <div class="preview-ability">
        ${card.ability ? `<p>${card.ability}</p>` : '<p class="no-ability">No special ability</p>'}
      </div>
      <div class="preview-resource">
        <p>Resource: Produces <span style="color: ${getColorHex(color)};">(${color})</span></p>
      </div>
      <div class="preview-footer">
        <span class="preview-rarity">${getRarityName(card.rarity)}</span>
      </div>
      <div class="preview-hint">Tap anywhere to close</div>
    </div>
  `;

  overlay.classList.remove('hidden');
  overlay.onclick = () => overlay.classList.add('hidden');
}

// Utility functions for card rendering
function getCardColor(cost) {
  if (!cost) return 'C';
  const matches = cost.match(/\(([^)]+)\)/g) || [];
  for (const m of matches) {
    const val = m.replace(/[()]/g, '');
    if (!/^\d+$/.test(val)) return val;
  }
  return 'C';
}

function getCardBgColor(color) {
  const colors = {
    'O': 'linear-gradient(135deg, #431407, #7c2d12)',
    'G': 'linear-gradient(135deg, #052e16, #14532d)',
    'P': 'linear-gradient(135deg, #3b0764, #581c87)',
    'B': 'linear-gradient(135deg, #172554, #1e3a8a)',
    'Bk': 'linear-gradient(135deg, #18181b, #27272a)',
    'C': 'linear-gradient(135deg, #27272a, #3f3f46)'
  };
  return colors[color] || colors['C'];
}

function getColorHex(color) {
  const colors = { 'O': '#f97316', 'G': '#22c55e', 'P': '#a855f7', 'B': '#3b82f6', 'Bk': '#a1a1aa', 'C': '#d4d4d8' };
  return colors[color] || colors['C'];
}

function getCardEmoji(type) {
  if (!type) return '?';
  if (type.includes('Pupil')) return 'ðŸ‘¤';
  if (type === 'Interruption') return 'âš¡';
  if (type === 'Tool') return 'ðŸ”§';
  if (type === 'Location') return 'ðŸ›ï¸';
  return '?';
}

function getRarityName(rarity) {
  const names = { 'C': 'Common', 'U': 'Uncommon', 'R': 'Rare' };
  return names[rarity] || 'Common';
}

function renderManaCost(cost) {
  if (!cost) return '';
  const matches = cost.match(/\(([^)]+)\)/g) || [];
  return matches.map(m => {
    const val = m.replace(/[()]/g, '');
    if (/^\d+$/.test(val)) {
      return `<span class="mana-pip generic">${val}</span>`;
    }
    const color = getColorHex(val);
    return `<span class="mana-pip" style="background: ${color};">${val}</span>`;
  }).join('');
}

function showToast(message) {
  // Simple toast notification
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.style.cssText = `
    position: fixed;
    bottom: 5rem;
    left: 50%;
    transform: translateX(-50%);
    background: #27272a;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    z-index: 200;
    animation: fadeIn 0.2s;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => toast.remove(), 2500);
}

// ============================================
// INITIALIZE ON LOAD
// ============================================
init();
</script>
</body>
</html>
