<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>RIUTIZ - Card Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --orange: #f97316; --orange-bg: #431407;
      --green: #22c55e; --green-bg: #052e16;
      --purple: #a855f7; --purple-bg: #3b0764;
      --blue: #3b82f6; --blue-bg: #172554;
      --black: #a1a1aa; --black-bg: #18181b;
      --colorless: #d4d4d8; --colorless-bg: #27272a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(to bottom, #18181b, #09090b);
      color: white;
      min-height: 100vh;
      overflow-x: hidden;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    /* Menu Screen */
    .menu-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .menu-title {
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--orange) 0%, var(--purple) 50%, var(--blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 60px rgba(168, 85, 247, 0.5);
      margin-bottom: 0.5rem;
    }

    .menu-subtitle { color: #71717a; margin-bottom: 2rem; }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .btn:active { transform: scale(0.95); }

    .btn-primary {
      background: linear-gradient(to right, var(--orange), var(--purple));
      color: white;
      box-shadow: 0 0 30px rgba(168, 85, 247, 0.3);
    }

    .btn-secondary { background: #3f3f46; color: white; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-success { background: #16a34a; color: white; }
    .btn-warning { background: #d97706; color: white; }
    .btn-purple { background: #9333ea; color: white; }

    .menu-buttons { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 300px; }
    .menu-buttons .btn { width: 100%; }

    .menu-hints { color: #71717a; font-size: 0.875rem; max-width: 300px; text-align: center; margin-top: 1.5rem; }
    .menu-hints p { margin-bottom: 0.5rem; }

    .color-preview { display: flex; gap: 0.5rem; margin-top: 2rem; }
    .color-dot {
      width: 2.5rem; height: 2.5rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.7rem; font-weight: bold; color: #000;
    }

    .online-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    .online-status.online { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .online-status.offline { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

    /* Starter Deck Selection */
    .starter-deck-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      max-width: 800px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .starter-deck-card {
      background: linear-gradient(135deg, var(--deck-bg) 0%, #0a0a0a 100%);
      border: 3px solid var(--deck-color);
      border-radius: 1rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .starter-deck-card:hover {
      transform: translateY(-0.5rem) scale(1.02);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px var(--deck-color);
    }
    .starter-deck-card:active {
      transform: scale(0.98);
    }
    .starter-deck-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }
    .starter-deck-name {
      font-size: 1rem;
      font-weight: bold;
      color: var(--deck-color);
      margin-bottom: 0.25rem;
    }
    .starter-deck-desc {
      font-size: 0.7rem;
      color: #a1a1aa;
      line-height: 1.3;
    }
    .starter-deck-card[data-color="O"] { --deck-color: var(--orange); --deck-bg: var(--orange-bg); }
    .starter-deck-card[data-color="G"] { --deck-color: var(--green); --deck-bg: var(--green-bg); }
    .starter-deck-card[data-color="P"] { --deck-color: var(--purple); --deck-bg: var(--purple-bg); }
    .starter-deck-card[data-color="B"] { --deck-color: var(--blue); --deck-bg: var(--blue-bg); }
    .starter-deck-card[data-color="K"] { --deck-color: var(--black); --deck-bg: var(--black-bg); }

    /* Game Screen - MTG Arena Style */
    .game-screen {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 50%, #1a1a2e 100%);
      position: relative;
    }
    .hidden { display: none !important; }

    /* Top Bar - Opponent Info */
    .top-bar {
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 10;
    }

    .player-badge {
      display: flex; align-items: center; gap: 0.5rem;
    }
    .player-avatar {
      width: 2.5rem; height: 2.5rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold;
      font-size: 1rem;
    }
    .player-avatar.opponent { background: rgba(239, 68, 68, 0.3); border: 2px solid #ef4444; }
    .player-avatar.you { background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; }

    .points { font-size: 1.75rem; font-weight: 900; }
    .points.opponent { color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
    .points.you { color: #3b82f6; text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }

    .deck-info { font-size: 0.7rem; color: #71717a; }

    /* Battlefield - Arena Style */
    .battlefield {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* Battlefield Background Layer */
    .battlefield::before {
      content: '';
      position: absolute;
      inset: 0;
      z-index: 0;
      background-size: cover;
      background-position: center;
      opacity: 0.4;
      transition: background-image 0.8s ease-in-out, opacity 0.3s;
      pointer-events: none;
    }

    /* Default: Classroom */
    .battlefield::before {
      background:
        linear-gradient(180deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%),
        repeating-linear-gradient(0deg, transparent, transparent 2rem, rgba(255,255,255,0.03) 2rem, rgba(255,255,255,0.03) 2.1rem),
        repeating-linear-gradient(90deg, transparent, transparent 3rem, rgba(255,255,255,0.02) 3rem, rgba(255,255,255,0.02) 3.1rem);
      background-color: #1e293b;
    }

    /* Location-specific backgrounds */
    .battlefield.loc-parking-lot::before {
      background: linear-gradient(180deg, rgba(55, 65, 81, 0.7) 0%, rgba(31, 41, 55, 0.9) 100%);
      background-color: #374151;
    }
    .battlefield.loc-workshop::before {
      background: linear-gradient(180deg, rgba(120, 53, 15, 0.6) 0%, rgba(67, 20, 7, 0.9) 100%);
      background-color: #78350f;
    }
    .battlefield.loc-field::before {
      background: linear-gradient(180deg, rgba(34, 197, 94, 0.3) 0%, rgba(5, 46, 22, 0.8) 100%);
      background-color: #166534;
    }
    .battlefield.loc-gym::before {
      background: linear-gradient(180deg, rgba(234, 88, 12, 0.4) 0%, rgba(124, 45, 18, 0.9) 100%);
      background-color: #c2410c;
    }
    .battlefield.loc-cafeteria::before {
      background: linear-gradient(180deg, rgba(251, 191, 36, 0.3) 0%, rgba(120, 53, 15, 0.9) 100%);
      background-color: #b45309;
    }
    .battlefield.loc-lab::before {
      background: linear-gradient(180deg, rgba(34, 211, 238, 0.3) 0%, rgba(8, 51, 68, 0.9) 100%);
      background-color: #0e7490;
    }
    .battlefield.loc-music-room::before {
      background: linear-gradient(180deg, rgba(168, 85, 247, 0.4) 0%, rgba(59, 7, 100, 0.9) 100%);
      background-color: #7c3aed;
    }
    .battlefield.loc-amphitheater::before {
      background: linear-gradient(180deg, rgba(239, 68, 68, 0.3) 0%, rgba(127, 29, 29, 0.9) 100%);
      background-color: #b91c1c;
    }
    .battlefield.loc-counselor::before {
      background: linear-gradient(180deg, rgba(34, 197, 94, 0.25) 0%, rgba(20, 83, 45, 0.9) 100%);
      background-color: #15803d;
    }
    .battlefield.loc-auditorium::before {
      background: linear-gradient(180deg, rgba(220, 38, 38, 0.4) 0%, rgba(69, 10, 10, 0.95) 100%);
      background-color: #991b1b;
    }
    .battlefield.loc-office::before {
      background: linear-gradient(180deg, rgba(100, 116, 139, 0.5) 0%, rgba(30, 41, 59, 0.9) 100%);
      background-color: #475569;
    }
    .battlefield.loc-computer-lab::before {
      background: linear-gradient(180deg, rgba(59, 130, 246, 0.4) 0%, rgba(23, 37, 84, 0.9) 100%);
      background-color: #1d4ed8;
    }
    .battlefield.loc-server-room::before {
      background: linear-gradient(180deg, rgba(20, 184, 166, 0.3) 0%, rgba(17, 94, 89, 0.9) 100%);
      background-color: #0f766e;
    }
    .battlefield.loc-library::before {
      background: linear-gradient(180deg, rgba(180, 83, 9, 0.4) 0%, rgba(69, 26, 3, 0.9) 100%);
      background-color: #92400e;
    }
    .battlefield.loc-playground::before {
      background: linear-gradient(180deg, rgba(250, 204, 21, 0.3) 0%, rgba(113, 63, 18, 0.9) 100%);
      background-color: #a16207;
    }
    .battlefield.loc-university::before {
      background: linear-gradient(180deg, rgba(99, 102, 241, 0.4) 0%, rgba(49, 46, 129, 0.9) 100%);
      background-color: #4338ca;
    }

    /* Location change animation */
    .battlefield.location-changing::before {
      opacity: 0;
    }

    /* Opponent's side */
    .opponent-side {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 0.5rem;
      min-height: 0;
      position: relative;
      z-index: 1;
    }

    /* Center divider with phase indicator */
    .battle-divider {
      height: auto;
      min-height: 3rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
      padding: 0.25rem 0;
    }
    .battle-divider::before {
      content: '';
      position: absolute;
      left: 10%;
      right: 10%;
      top: 50%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #f59e0b, transparent);
      opacity: 0.5;
      z-index: 0;
    }

    /* Center Location Card */
    .center-location {
      position: relative;
      z-index: 3;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 2rem;
    }
    .center-location:empty {
      display: none;
    }
    .center-location .location-card {
      background: linear-gradient(135deg, #1e1e2e 0%, #0a0a0f 100%);
      border: 2px solid #f59e0b;
      border-radius: 0.5rem;
      padding: 0.4rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.3), 0 4px 15px rgba(0,0,0,0.5);
      cursor: pointer;
      transition: all 0.2s;
    }
    .center-location .location-card:hover {
      transform: scale(1.05);
      box-shadow: 0 0 30px rgba(245, 158, 11, 0.5), 0 6px 20px rgba(0,0,0,0.6);
    }
    .center-location .location-icon {
      font-size: 1.5rem;
    }
    .center-location .location-info {
      display: flex;
      flex-direction: column;
    }
    .center-location .location-name {
      font-weight: bold;
      font-size: 0.85rem;
      color: #f59e0b;
    }
    .center-location .location-ability {
      font-size: 0.65rem;
      color: #a1a1aa;
      max-width: 12rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Your side */
    .your-side {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding: 0.5rem;
      min-height: 0;
      position: relative;
      z-index: 1;
    }

    /* Field zones - no boxes, just card areas */
    .field-zone {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      min-height: 5.5rem;
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .field-zone:empty::after {
      content: 'Drop cards here';
      color: #3f3f46;
      font-size: 0.75rem;
      font-style: italic;
    }

    .cards-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    .cards-row.empty {
      color: #3f3f46;
      font-size: 0.75rem;
      font-style: italic;
    }

    /* Resources - Compact side display */
    /* Resources - Bottom left stacked */
    .resources-container {
      position: absolute;
      bottom: 14rem;
      left: 0.5rem;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .resources-area {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .resources-area .resources-label {
      font-size: 0.6rem;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .resources-area.opponent .resources-label { color: #ef4444; }
    .resources-area.yours .resources-label { color: #3b82f6; }

    .resources-row {
      display: flex;
      gap: 0.2rem;
      flex-wrap: wrap;
      justify-content: flex-start;
      max-width: 10rem;
      min-height: 2rem;
      min-width: 3rem;
      padding: 0.25rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .resources-row:empty::after {
      content: 'üíé';
      opacity: 0.2;
      font-size: 1.25rem;
    }

    /* Artifacts - Bottom right */
    .artifacts-container {
      position: absolute;
      bottom: 14rem;
      right: 0.5rem;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .artifacts-area {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      align-items: flex-end;
    }
    .artifacts-area .artifacts-label {
      font-size: 0.6rem;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .artifacts-area.opponent .artifacts-label { color: #ef4444; }
    .artifacts-area.yours .artifacts-label { color: #3b82f6; }

    .artifacts-row {
      display: flex;
      gap: 0.3rem;
      flex-wrap: wrap;
      justify-content: flex-end;
      max-width: 10rem;
      min-height: 1.5rem;
    }
    .artifacts-row:empty::after {
      content: 'üîß';
      opacity: 0.15;
      font-size: 1rem;
    }
    .artifacts-row .card.small {
      width: 3.5rem;
      height: 5rem;
      font-size: 5px;
    }

    .resource-token {
      width: 1.75rem; height: 1.75rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.6rem; font-weight: bold; color: #000;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .resource-token:not(.spent):hover { transform: scale(1.2); z-index: 10; }
    .resource-token.spent { opacity: 0.35; filter: grayscale(0.5); }

    /* Phase Indicator - Centered in divider */
    .phases {
      display: flex;
      gap: 0.25rem;
      align-items: center;
      background: rgba(0,0,0,0.6);
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
    }
    .phase {
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 0.6rem;
      font-weight: bold;
      background: transparent;
      color: #52525b;
      transition: all 0.2s;
    }
    .phase.active {
      background: #f59e0b;
      color: #000;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
    }

    .turn-indicator {
      position: absolute;
      right: 1rem;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
    }
    .turn-indicator.your-turn { color: #22c55e; background: rgba(34, 197, 94, 0.2); }
    .turn-indicator.opp-turn { color: #ef4444; background: rgba(239, 68, 68, 0.2); }

    /* Message Bar - Floating */
    .message-bar {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      padding: 0.5rem 1.5rem;
      border-radius: 2rem;
      font-size: 0.8rem;
      z-index: 20;
      pointer-events: none;
      border: 1px solid #3f3f46;
      white-space: nowrap;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Hand Area - Fanned Arc */
    .hand-area {
      position: relative;
      height: 11rem;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      padding-bottom: 3.5rem; /* Space for action bar */
      background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
      overflow: visible;
    }

    .hand-fan {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      position: relative;
      height: 100%;
      perspective: 1000px;
    }

    .hand-card-wrapper {
      position: absolute;
      bottom: 3.5rem; /* Above action bar */
      transition: all 0.2s ease-out;
      transform-origin: bottom center;
    }

    .hand-card-wrapper:hover {
      z-index: 100 !important;
      transform: translateY(-2rem) scale(1.15) !important;
    }

    .hand-card-wrapper .card {
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    /* Action Bar - Bottom overlay */
    .action-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%);
      padding: 0.5rem 1rem;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 30;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    .action-buttons .btn {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
    }

    /* Combat animations */
    .card.attacking {
      animation: attackPulse 0.5s ease-in-out infinite alternate;
    }
    @keyframes attackPulse {
      from { box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
      to { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8); }
    }

    .card.attacker {
      transform: translateY(-1.5rem) !important;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 10px 30px rgba(0,0,0,0.5) !important;
      z-index: 15;
    }
    .card.attacker.spent {
      transform: rotate(90deg) translateX(-1.5rem) !important;
    }

    .card.blocker {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.6) !important;
    }
    .card.blocker.spent {
      transform: rotate(90deg) !important;
    }

    .card.blocking-line::after {
      content: '';
      position: absolute;
      top: -2rem;
      left: 50%;
      width: 2px;
      height: 2rem;
      background: linear-gradient(to top, #3b82f6, transparent);
    }

    /* Cards */
    .card {
      position: relative;
      border-radius: 0.5rem;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }
    .card.small { width: 4rem; height: 6rem; font-size: 6px; }
    .card.in-hand { width: 6rem; height: 9rem; font-size: 10px; }
    .card.large { width: 7rem; height: 10rem; font-size: 12px; }

    .card:active { transform: scale(0.95); }
    .card.selected { box-shadow: 0 0 0 3px #facc15; transform: scale(1.05); z-index: 20; }
    .card.targetable { box-shadow: 0 0 0 2px #fbbf24, 0 0 15px rgba(251, 191, 36, 0.5); }
    .card.spent { transform: rotate(90deg); opacity: 0.6; }

    .card-inner { height: 100%; padding: 0.25rem; display: flex; flex-direction: column; }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
    .card-cost { display: flex; gap: 2px; flex-shrink: 0; }
    .mana-pip {
      width: 1em; height: 1em;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8em; font-weight: bold; color: #000;
    }
    .mana-pip.generic { background: #52525b; color: white; border: 1px solid #71717a; }

    .card-type { color: #a1a1aa; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .card-art {
      flex: 1;
      margin: 0.25rem 0;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2em;
      opacity: 0.6;
    }

    .card-stats { display: flex; justify-content: space-between; font-size: 0.9em; }
    .stat-dice { color: #fbbf24; }
    .stat-hp { color: #ef4444; }

    .card-ability {
      font-size: 0.85em;
      color: #d4d4d8;
      line-height: 1.2;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .card-rarity {
      position: absolute;
      bottom: 0.25rem;
      right: 0.25rem;
      width: 0.5rem; height: 0.5rem;
      border-radius: 50%;
    }
    .card-rarity.R { background: #f59e0b; }
    .card-rarity.U { background: #6366f1; }
    .card-rarity.C { background: #71717a; }

    .card-indicator {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      width: 1rem; height: 1rem;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.6rem;
    }
    .indicator-bearings { background: rgba(234, 179, 8, 0.8); }
    .indicator-activate { background: rgba(147, 51, 234, 0.8); }

    /* Card Preview Overlay */
    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
    }

    .preview-card {
      width: 18rem;
      border-radius: 1rem;
      overflow: hidden;
      animation: zoomIn 0.15s ease-out;
    }
    @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .preview-header { padding: 1rem 1rem 0.5rem; }
    .preview-name-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem; }
    .preview-name { font-size: 1.25rem; font-weight: bold; }
    .preview-cost { display: flex; gap: 0.25rem; }
    .preview-cost .mana-pip { width: 1.75rem; height: 1.75rem; font-size: 0.875rem; }
    .preview-type { color: #a1a1aa; font-size: 0.875rem; }

    .preview-art {
      height: 8rem;
      margin: 0 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      opacity: 0.6;
    }

    .preview-stats { display: flex; justify-content: space-between; padding: 0.5rem 1rem; font-size: 1rem; }
    .preview-stats span { font-weight: bold; }

    .preview-ability { padding: 0.75rem 1rem; min-height: 5rem; }
    .preview-ability p { font-size: 0.875rem; line-height: 1.5; color: #e4e4e7; }
    .preview-ability .no-ability { color: #71717a; font-style: italic; }

    .preview-resource { padding: 0 1rem 0.75rem; border-top: 1px solid #3f3f46; margin-top: 0.5rem; padding-top: 0.5rem; }
    .preview-resource p { font-size: 0.75rem; color: #a1a1aa; }
    .preview-resource span { color: #71717a; }

    .preview-footer { padding: 0 1rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    .preview-rarity { font-size: 0.75rem; color: #71717a; }
    .preview-hint { text-align: center; color: #71717a; font-size: 0.75rem; padding-bottom: 0.75rem; }

    /* Victory Screen */
    .victory-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 1rem;
    }
    .victory-title { font-size: 3rem; color: #fbbf24; margin-bottom: 1rem; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .victory-text { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .victory-score { color: #71717a; margin-bottom: 2rem; }

    /* Turn Counter */
    .turn-counter {
      position: fixed;
      top: 3.5rem;
      left: 0.5rem;
      background: rgba(24, 24, 27, 0.8);
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      z-index: 10;
    }

    /* Lobby Screen */
    .lobby-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    .lobby-title { font-size: 2rem; font-weight: bold; margin-bottom: 1rem; }
    .lobby-code { font-size: 3rem; font-weight: 900; color: var(--orange); letter-spacing: 0.5rem; margin-bottom: 2rem; }

    .lobby-players {
      width: 100%;
      max-width: 400px;
      margin-bottom: 2rem;
    }

    .lobby-player {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #27272a;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .lobby-player.ready { border-left: 4px solid var(--green); }
    .lobby-player .ready-badge { color: var(--green); font-size: 0.875rem; }

    .lobby-waiting { color: #71717a; font-style: italic; padding: 1rem; text-align: center; }

    /* Game Mode Selection */
    .mode-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      max-width: 700px;
      width: 100%;
      padding: 1rem;
    }

    .mode-card {
      background: linear-gradient(135deg, #27272a 0%, #18181b 100%);
      border: 2px solid #3f3f46;
      border-radius: 1rem;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .mode-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }

    .mode-card.casual:hover { border-color: var(--green); box-shadow: 0 10px 30px rgba(34, 197, 94, 0.2); }
    .mode-card.ranked:hover { border-color: var(--orange); box-shadow: 0 10px 30px rgba(249, 115, 22, 0.2); }

    .mode-card-icon { font-size: 3rem; margin-bottom: 0.75rem; }
    .mode-card-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; }
    .mode-card.casual .mode-card-title { color: var(--green); }
    .mode-card.ranked .mode-card-title { color: var(--orange); }
    .mode-card-desc { font-size: 0.875rem; color: #a1a1aa; line-height: 1.4; }

    /* Deck Selection */
    .deck-select-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      max-width: 800px;
      width: 100%;
      padding: 1rem;
      max-height: 50vh;
      overflow-y: auto;
    }

    .deck-select-card {
      background: #27272a;
      border: 2px solid #3f3f46;
      border-radius: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .deck-select-card:hover {
      border-color: var(--purple);
      transform: scale(1.02);
    }

    .deck-select-card.selected {
      border-color: var(--green);
      background: rgba(34, 197, 94, 0.1);
    }

    .deck-select-card.invalid {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .deck-select-name {
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .deck-select-info {
      font-size: 0.75rem;
      color: #71717a;
      display: flex;
      justify-content: space-between;
    }

    .deck-select-color {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    .deck-select-color.O { background: var(--orange); }
    .deck-select-color.G { background: var(--green); }
    .deck-select-color.P { background: var(--purple); }
    .deck-select-color.B { background: var(--blue); }
    .deck-select-color.K { background: var(--black); }
    .deck-select-color.C { background: var(--colorless); }

    .deck-select-warning {
      font-size: 0.7rem;
      color: #ef4444;
      margin-top: 0.5rem;
    }

    .no-decks-message {
      text-align: center;
      padding: 2rem;
      color: #71717a;
    }

    .no-decks-message p { margin-bottom: 1rem; }

    /* Deck Builder */
    .deck-builder-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0.5rem;
      padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
    }

    .deck-builder-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: rgba(24, 24, 27, 0.9);
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .deck-builder-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--orange);
    }

    .deck-builder-actions { display: flex; gap: 0.5rem; }
    .deck-builder-actions .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }

    .deck-mode-toggle {
      display: flex;
      gap: 0.25rem;
      background: #1a1a1e;
      padding: 0.25rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .deck-mode-btn {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 0.375rem;
      background: transparent;
      color: #71717a;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .deck-mode-btn.active {
      background: var(--orange);
      color: #000;
    }

    .deck-stats {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #27272a;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .deck-stat {
      text-align: center;
      flex: 1;
      min-width: 60px;
    }
    .deck-stat-value { font-size: 1.25rem; font-weight: bold; }
    .deck-stat-label { font-size: 0.65rem; color: #71717a; }
    .deck-stat-value.valid { color: var(--green); }
    .deck-stat-value.invalid { color: #ef4444; }

    .deck-builder-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 0.5rem;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .deck-builder-content {
        flex-direction: row;
      }
      .card-browser { flex: 2; }
      .deck-panel { flex: 1; max-width: 350px; }
    }

    .card-browser {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #1a1a1e;
      border-radius: 0.5rem;
    }

    .card-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      padding: 0.5rem;
      border-bottom: 1px solid #27272a;
    }

    .filter-btn {
      padding: 0.25rem 0.5rem;
      border: 1px solid #3f3f46;
      border-radius: 0.25rem;
      background: transparent;
      color: #a1a1aa;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover { background: #27272a; }
    .filter-btn.active { background: var(--orange); color: #000; border-color: var(--orange); }

    .filter-search {
      flex: 1;
      min-width: 100px;
      padding: 0.25rem 0.5rem;
      border: 1px solid #3f3f46;
      border-radius: 0.25rem;
      background: #27272a;
      color: white;
      font-size: 0.75rem;
    }

    .card-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(4.5rem, 1fr));
      gap: 0.5rem;
    }

    .card-grid-item {
      position: relative;
      cursor: pointer;
    }

    .card-grid-item .card-count {
      position: absolute;
      top: -0.25rem;
      right: -0.25rem;
      background: var(--orange);
      color: #000;
      font-size: 0.7rem;
      font-weight: bold;
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }

    .card-grid-item .owned-count {
      position: absolute;
      bottom: 0.25rem;
      left: 0.25rem;
      background: rgba(0,0,0,0.8);
      color: #71717a;
      font-size: 0.6rem;
      padding: 0.1rem 0.25rem;
      border-radius: 0.25rem;
    }

    .deck-panel {
      display: flex;
      flex-direction: column;
      background: #1a1a1e;
      border-radius: 0.5rem;
      overflow: hidden;
      max-height: 40vh;
    }

    @media (min-width: 768px) {
      .deck-panel { max-height: none; }
    }

    .deck-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #27272a;
    }

    .deck-name-input {
      flex: 1;
      padding: 0.25rem 0.5rem;
      border: 1px solid #3f3f46;
      border-radius: 0.25rem;
      background: #27272a;
      color: white;
      font-size: 0.875rem;
      margin-right: 0.5rem;
    }

    .deck-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .deck-card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.375rem 0.5rem;
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .deck-card-row:hover { background: #27272a; }

    .deck-card-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      overflow: hidden;
    }

    .deck-card-cost {
      display: flex;
      gap: 2px;
    }

    .deck-card-cost .mana-pip {
      width: 1rem;
      height: 1rem;
      font-size: 0.6rem;
    }

    .deck-card-name {
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .deck-card-count {
      font-size: 0.8rem;
      color: #71717a;
      margin-left: 0.5rem;
    }

    .deck-card-remove {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      padding: 0.25rem;
      font-size: 1rem;
      opacity: 0.6;
    }

    .deck-card-remove:hover { opacity: 1; }

    .mana-curve {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 50px;
      padding: 0.5rem;
      border-top: 1px solid #27272a;
    }

    .curve-bar {
      flex: 1;
      background: var(--orange);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      position: relative;
    }

    .curve-bar-label {
      position: absolute;
      bottom: -1rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: #71717a;
    }

    .deck-actions {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      border-top: 1px solid #27272a;
    }

    .deck-actions .btn { flex: 1; padding: 0.5rem; font-size: 0.8rem; }

    .saved-decks-panel {
      background: #1a1a1e;
      border-radius: 0.5rem;
      margin-top: 0.5rem;
      max-height: 150px;
      overflow-y: auto;
    }

    .saved-deck-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #27272a;
      cursor: pointer;
    }

    .saved-deck-row:hover { background: #27272a; }
    .saved-deck-row:last-child { border-bottom: none; }

    .saved-deck-info { flex: 1; }
    .saved-deck-name { font-size: 0.875rem; font-weight: bold; }
    .saved-deck-count { font-size: 0.75rem; color: #71717a; }

    .empty-deck-message {
      text-align: center;
      padding: 2rem 1rem;
      color: #71717a;
      font-size: 0.875rem;
    }

    /* Loading */
    .loading { text-align: center; padding: 2rem; color: #71717a; }

    /* Drag and Drop */
    .card[draggable="true"] {
      cursor: grab;
    }
    .card[draggable="true"]:active {
      cursor: grabbing;
    }
    .field-zone.drop-hover {
      background: rgba(34, 197, 94, 0.15) !important;
      border-color: #22c55e !important;
    }
    .resources-row.drop-hover {
      background: rgba(59, 130, 246, 0.15) !important;
      outline: 2px dashed #3b82f6;
    }
    .drop-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.75rem;
      color: #22c55e;
      font-weight: bold;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .field-zone:has(.drop-hover) .drop-hint { opacity: 1; }

    /* Deck Management Screen */
    .deck-management-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }

    .deck-management-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: rgba(24, 24, 27, 0.9);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }

    .deck-management-title {
      font-size: 1.5rem;
      font-weight: bold;
      background: linear-gradient(to right, var(--orange), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .deck-list-container {
      flex: 1;
      overflow-y: auto;
    }

    .deck-section {
      margin-bottom: 1.5rem;
    }

    .deck-section-title {
      font-size: 0.875rem;
      color: #71717a;
      text-transform: uppercase;
      padding: 0.5rem 0;
      border-bottom: 1px solid #27272a;
      margin-bottom: 0.5rem;
    }

    .deck-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: #1a1a1e;
      border: 1px solid #27272a;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s;
    }

    .deck-card:hover {
      border-color: #3f3f46;
      background: #27272a;
    }

    .deck-card-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .deck-card-icon.starter { background: linear-gradient(135deg, var(--orange-bg), var(--purple-bg)); }
    .deck-card-icon.casual { background: var(--green-bg); border: 1px solid var(--green); }
    .deck-card-icon.ranked { background: var(--orange-bg); border: 1px solid var(--orange); }

    .deck-card-info {
      flex: 1;
    }

    .deck-card-name {
      font-weight: bold;
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .deck-card-meta {
      font-size: 0.75rem;
      color: #71717a;
      display: flex;
      gap: 0.75rem;
    }

    .deck-card-type {
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.65rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .deck-card-type.starter { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
    .deck-card-type.casual { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .deck-card-type.ranked { background: rgba(249, 115, 22, 0.2); color: #f97316; }

    .deck-card-actions {
      display: flex;
      gap: 0.5rem;
    }

    .deck-action-btn {
      padding: 0.5rem 0.75rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .deck-action-btn.edit { background: var(--blue); color: white; }
    .deck-action-btn.duplicate { background: #6b7280; color: white; }
    .deck-action-btn.delete { background: #dc2626; color: white; }
    .deck-action-btn:hover { opacity: 0.9; transform: scale(1.02); }

    .new-deck-btn {
      width: 100%;
      padding: 1rem;
      border: 2px dashed #3f3f46;
      border-radius: 0.75rem;
      background: transparent;
      color: #71717a;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 0.5rem;
    }

    .new-deck-btn:hover {
      border-color: var(--orange);
      color: var(--orange);
      background: rgba(249, 115, 22, 0.1);
    }

    /* Deck Type Selection Modal */
    .deck-type-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
    }

    .deck-type-modal-content {
      background: #18181b;
      border: 1px solid #27272a;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
    }

    .deck-type-modal-title {
      font-size: 1.25rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 1rem;
    }

    .deck-type-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .deck-type-option {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 2px solid #3f3f46;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .deck-type-option:hover {
      border-color: #52525b;
      background: rgba(255, 255, 255, 0.02);
    }

    .deck-type-option.selected {
      border-color: var(--orange);
      background: rgba(249, 115, 22, 0.1);
    }

    .deck-type-option-icon {
      width: 3rem;
      height: 3rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .deck-type-option-icon.casual { background: var(--green-bg); }
    .deck-type-option-icon.ranked { background: var(--orange-bg); }

    .deck-type-option-info h4 {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    .deck-type-option-info p {
      font-size: 0.75rem;
      color: #71717a;
    }

    .deck-type-modal-actions {
      display: flex;
      gap: 0.5rem;
    }

    .deck-type-modal-actions .btn {
      flex: 1;
    }
  </style>
</head>
<body>
  <!-- Menu Screen -->
  <div id="menu-screen" class="menu-screen">
    <div id="online-status" class="online-status offline">Offline Mode</div>
    <h1 class="menu-title">RIUTIZ</h1>
    <p class="menu-subtitle">The Competitive Card Game</p>
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="startQuickGame()">Play vs AI</button>
      <button class="btn btn-secondary" onclick="showDeckManagement()">Deck Builder</button>
      <button class="btn btn-purple" onclick="showMultiplayerMenu()" id="multiplayer-btn">Multiplayer</button>
    </div>
    <div class="menu-hints">
      <p>First to 25 points wins!</p>
      <p>Roll dice to attack</p>
      <p>Tap to select - Hold to preview</p>
    </div>
    <div class="color-preview">
      <div class="color-dot" style="background: var(--orange)">O</div>
      <div class="color-dot" style="background: var(--green)">G</div>
      <div class="color-dot" style="background: var(--purple)">P</div>
      <div class="color-dot" style="background: var(--blue)">B</div>
      <div class="color-dot" style="background: var(--black)">Bk</div>
    </div>
    <div id="loading-status" class="loading"></div>
  </div>

  <!-- Deck Management Screen -->
  <div id="deck-management-screen" class="deck-management-screen hidden">
    <div class="deck-management-header">
      <span class="deck-management-title">My Decks</span>
      <button class="btn btn-secondary" onclick="closeDeckManagement()">Back</button>
    </div>

    <div class="deck-list-container" id="deck-list-container">
      <!-- Populated by JavaScript -->
    </div>

    <button class="new-deck-btn" onclick="showNewDeckTypeModal()">
      + Create New Deck
    </button>
  </div>

  <!-- Deck Type Selection Modal -->
  <div id="deck-type-modal" class="deck-type-modal hidden">
    <div class="deck-type-modal-content">
      <div class="deck-type-modal-title" id="deck-type-modal-title">Select Deck Type</div>
      <div class="deck-type-options">
        <div class="deck-type-option" data-type="casual" onclick="selectDeckType('casual')">
          <div class="deck-type-option-icon casual">üéÆ</div>
          <div class="deck-type-option-info">
            <h4>Casual</h4>
            <p>Use any card in the game. Perfect for experimenting!</p>
          </div>
        </div>
        <div class="deck-type-option" data-type="ranked" onclick="selectDeckType('ranked')">
          <div class="deck-type-option-icon ranked">üèÜ</div>
          <div class="deck-type-option-info">
            <h4>Ranked</h4>
            <p>Only cards you own. Use in ranked matches!</p>
          </div>
        </div>
      </div>
      <div class="deck-type-modal-actions">
        <button class="btn btn-secondary" onclick="closeDeckTypeModal()">Cancel</button>
        <button class="btn btn-primary" id="confirm-deck-type-btn" onclick="confirmDeckType()">Continue</button>
      </div>
    </div>
  </div>

  <!-- Starter Deck Selection -->
  <div id="starter-deck-screen" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2rem;">Choose Your Starter Deck</h2>
    <p class="menu-subtitle">Pick a color to begin your journey!</p>
    <div class="starter-deck-grid" id="starter-deck-grid">
      <!-- Populated by JavaScript -->
    </div>
  </div>

  <!-- Multiplayer Menu -->
  <div id="multiplayer-menu" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2.5rem;">Multiplayer</h2>
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="showGameModeSelect('quickmatch')">Quick Match</button>
      <button class="btn btn-secondary" onclick="showGameModeSelect('lobby')">Create Lobby</button>
      <button class="btn btn-secondary" onclick="showJoinLobby()">Join Lobby</button>
      <button class="btn btn-danger" onclick="showMenu()">Back</button>
    </div>
    <div id="queue-status" class="loading hidden" style="margin-top: 1rem;"></div>
  </div>

  <!-- Game Mode Selection -->
  <div id="mode-select-screen" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2rem;">Select Game Mode</h2>
    <p class="menu-subtitle">Choose how you want to play</p>
    <div class="mode-cards">
      <div class="mode-card casual" onclick="selectGameMode('casual')">
        <div class="mode-card-icon">üéÆ</div>
        <div class="mode-card-title">Casual</div>
        <div class="mode-card-desc">Play with any deck - use all cards in the game, even ones you don't own yet!</div>
      </div>
      <div class="mode-card ranked" onclick="selectGameMode('ranked')">
        <div class="mode-card-icon">üèÜ</div>
        <div class="mode-card-title">Ranked</div>
        <div class="mode-card-desc">Competitive play - decks are limited to cards you've earned. Climb the leaderboards!</div>
      </div>
    </div>
    <div class="menu-buttons" style="margin-top: 1rem;">
      <button class="btn btn-secondary" onclick="showMultiplayerMenu()">Back</button>
    </div>
  </div>

  <!-- Deck Selection -->
  <div id="deck-select-screen" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2rem;">Select Your Deck</h2>
    <p class="menu-subtitle" id="deck-select-mode-label">Casual Mode</p>
    <div class="deck-select-grid" id="deck-select-grid">
      <!-- Populated dynamically -->
    </div>
    <div class="menu-buttons" style="margin-top: 1rem;">
      <button class="btn btn-primary hidden" id="confirm-deck-btn" onclick="confirmDeckSelection()">Confirm Deck</button>
      <button class="btn btn-warning" onclick="openDeckBuilder()">Build New Deck</button>
      <button class="btn btn-secondary" onclick="showGameModeSelect()">Back</button>
    </div>
  </div>

  <!-- Join Lobby -->
  <div id="join-lobby-screen" class="menu-screen hidden">
    <h2 class="menu-title" style="font-size: 2rem;">Join Lobby</h2>
    <input type="text" id="lobby-code-input" placeholder="Enter Code" maxlength="6"
           style="font-size: 2rem; text-align: center; padding: 1rem; background: #27272a; border: 2px solid #3f3f46; border-radius: 0.5rem; color: white; text-transform: uppercase; width: 200px; margin-bottom: 1rem;">
    <div class="menu-buttons">
      <button class="btn btn-primary" onclick="joinLobbyByCode()">Join</button>
      <button class="btn btn-secondary" onclick="showMultiplayerMenu()">Back</button>
    </div>
  </div>

  <!-- Lobby Screen -->
  <div id="lobby-screen" class="lobby-screen hidden">
    <h2 class="lobby-title">Lobby</h2>
    <div class="lobby-code" id="lobby-code-display">------</div>
    <div class="lobby-mode" id="lobby-mode-display" style="font-size: 0.875rem; color: #71717a; margin-bottom: 1rem;">Casual Mode</div>
    <div class="lobby-players" id="lobby-players">
      <div class="lobby-waiting">Waiting for players...</div>
    </div>
    <div class="menu-buttons">
      <button class="btn btn-success hidden" id="start-match-btn" onclick="startLobbyMatch()">Start Match</button>
      <button class="btn btn-primary" id="ready-btn" onclick="toggleReady()">Ready Up</button>
      <button class="btn btn-danger" onclick="leaveLobbyScreen()">Leave</button>
    </div>
  </div>

  <!-- Deck Builder Screen -->
  <div id="deck-builder-screen" class="deck-builder-screen hidden">
    <div class="deck-builder-header">
      <span class="deck-builder-title">Deck Builder</span>
      <div class="deck-builder-actions">
        <button class="btn btn-secondary" onclick="closeDeckBuilder()">Back</button>
      </div>
    </div>

    <!-- Deck Type Indicator (read-only) -->
    <div class="deck-mode-toggle">
      <div class="deck-mode-btn" data-mode="casual" id="deck-type-casual-indicator" style="cursor: default;">üéÆ Casual (All Cards)</div>
      <div class="deck-mode-btn" data-mode="ranked" id="deck-type-ranked-indicator" style="cursor: default;">üèÜ Ranked (Owned)</div>
    </div>

    <!-- Deck Stats -->
    <div class="deck-stats">
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-size-stat">0</div>
        <div class="deck-stat-label">Cards</div>
      </div>
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-unique-stat">0</div>
        <div class="deck-stat-label">Unique</div>
      </div>
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-pupils-stat">0</div>
        <div class="deck-stat-label">Pupils</div>
      </div>
      <div class="deck-stat">
        <div class="deck-stat-value" id="deck-spells-stat">0</div>
        <div class="deck-stat-label">Spells</div>
      </div>
    </div>

    <div class="deck-builder-content">
      <!-- Card Browser -->
      <div class="card-browser">
        <div class="card-filters">
          <button class="filter-btn" data-filter="color" data-value="" onclick="setCardFilter('color', null)">All</button>
          <button class="filter-btn" data-filter="color" data-value="O" onclick="setCardFilter('color', 'O')" style="background: var(--orange-bg); border-color: var(--orange);">O</button>
          <button class="filter-btn" data-filter="color" data-value="G" onclick="setCardFilter('color', 'G')" style="background: var(--green-bg); border-color: var(--green);">G</button>
          <button class="filter-btn" data-filter="color" data-value="P" onclick="setCardFilter('color', 'P')" style="background: var(--purple-bg); border-color: var(--purple);">P</button>
          <button class="filter-btn" data-filter="color" data-value="B" onclick="setCardFilter('color', 'B')" style="background: var(--blue-bg); border-color: var(--blue);">B</button>
          <button class="filter-btn" data-filter="color" data-value="Bk" onclick="setCardFilter('color', 'Bk')" style="background: var(--black-bg); border-color: var(--black);">Bk</button>
          <button class="filter-btn" data-filter="color" data-value="C" onclick="setCardFilter('color', 'C')" style="background: #27272a; border-color: #d4d4d8;">C</button>
          <input type="text" class="filter-search" id="card-search" placeholder="Search cards..." oninput="setCardFilter('search', this.value)">
        </div>
        <div class="card-grid-container">
          <div class="card-grid" id="card-grid"></div>
        </div>
      </div>

      <!-- Deck Panel -->
      <div class="deck-panel">
        <div class="deck-panel-header">
          <input type="text" class="deck-name-input" id="deck-name-input" value="New Deck" placeholder="Deck Name">
          <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="clearCurrentDeck()">Clear</button>
        </div>
        <div class="deck-list" id="deck-list">
          <div class="empty-deck-message">Click cards to add them to your deck</div>
        </div>
        <div class="mana-curve" id="mana-curve">
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">0</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">1</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">2</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">3</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">4</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">5</span></div>
          <div class="curve-bar" style="height: 0%;"><span class="curve-bar-label">6+</span></div>
        </div>
        <div class="deck-actions">
          <button class="btn btn-success" onclick="saveDeck()">Save Deck</button>
          <button class="btn btn-secondary" onclick="showSavedDecks()">Load</button>
        </div>
      </div>
    </div>

    <!-- Saved Decks Panel (hidden by default) -->
    <div class="saved-decks-panel hidden" id="saved-decks-panel">
      <div class="deck-panel-header" style="padding: 0.5rem;">
        <span style="font-weight: bold;">Saved Decks</span>
        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="hideSavedDecks()">Close</button>
      </div>
      <div id="saved-decks-list"></div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="game-screen hidden">
    <!-- Top Bar - Opponent Info -->
    <div class="top-bar">
      <div class="player-badge">
        <div class="player-avatar opponent">2</div>
        <div>
          <span id="opponent-name" style="font-size: 0.9rem; font-weight: bold;">Opponent</span>
          <div class="deck-info">üÉè <span id="opp-hand-count">7</span> | üìö <span id="opp-deck-count">33</span></div>
        </div>
      </div>
      <div class="points opponent" id="opp-points">0</div>
    </div>

    <!-- Battlefield -->
    <div class="battlefield">
      <!-- Resources Container - Bottom Left -->
      <div class="resources-container">
        <div class="resources-area opponent">
          <span class="resources-label">Opp Resources</span>
          <div class="resources-row" id="opp-resources"></div>
        </div>
        <div class="resources-area yours">
          <span class="resources-label">Your Resources</span>
          <div class="resources-row" id="your-resources"></div>
        </div>
      </div>

      <!-- Artifacts Container - Bottom Right -->
      <div class="artifacts-container">
        <div class="artifacts-area opponent">
          <span class="artifacts-label">Opp Artifacts</span>
          <div class="artifacts-row" id="opp-artifacts"></div>
        </div>
        <div class="artifacts-area yours">
          <span class="artifacts-label">Your Artifacts</span>
          <div class="artifacts-row" id="your-artifacts"></div>
        </div>
      </div>

      <!-- Opponent's Side -->
      <div class="opponent-side">
        <div class="field-zone" id="opp-field"></div>
      </div>

      <!-- Center Divider with Location and Phases -->
      <div class="battle-divider">
        <div class="center-location" id="center-location"></div>
        <div class="phases">
          <div class="phase" data-phase="draw">D</div>
          <div class="phase" data-phase="ready">R</div>
          <div class="phase" data-phase="main">M</div>
          <div class="phase" data-phase="combat">C</div>
          <div class="phase" data-phase="end">E</div>
        </div>
        <span class="turn-indicator" id="turn-indicator">Your Turn</span>
      </div>

      <!-- Your Side -->
      <div class="your-side">
        <div class="field-zone" id="your-field"></div>
      </div>

      <!-- Floating Message -->
      <div class="message-bar" id="message">Drag cards to play</div>
    </div>

    <!-- Hand Area - Fanned -->
    <div class="hand-area">
      <div class="hand-fan" id="your-hand"></div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div class="player-info">
        <div class="player-avatar you">1</div>
        <div>
          <div class="points you" id="your-points">0</div>
          <div class="deck-info">üÉè <span id="your-hand-count">7</span> | üìö <span id="your-deck-count">33</span></div>
        </div>
      </div>
      <div style="font-size: 0.75rem; color: #71717a;">Turn <span id="turn-number">1</span></div>
      <div class="action-buttons" id="action-buttons"></div>
    </div>
  </div>

  <!-- Victory Screen -->
  <div id="victory-screen" class="victory-screen hidden">
    <h1 class="victory-title">VICTORY!</h1>
    <p class="victory-text" id="winner-text">Player 1 Wins!</p>
    <p class="victory-score" id="final-score">Final Score: 0 - 0</p>
    <button class="btn btn-warning" onclick="showMenu()">Play Again</button>
  </div>

  <!-- Card Preview Overlay -->
  <div id="preview-overlay" class="preview-overlay hidden"></div>

<!-- Load Scripts -->
<script src="Data/Riutiz/cards.json" type="application/json" id="card-data-json"></script>

<!-- Arcade System -->
<script src="../firebase/firebase-config.js"></script>
<script src="../shared/arcade/FirebaseManager.js"></script>
<script src="../shared/arcade/ArcadeManager.js"></script>
<script src="../shared/arcade/MatchmakingManager.js"></script>
<script src="../shared/arcade/MultiplayerSync.js"></script>
<script src="../shared/arcade/LeaderboardManager.js"></script>
<script src="../shared/arcade/RatingManager.js"></script>
<script src="../shared/arcade/FriendsManager.js"></script>
<script src="../shared/arcade/ProfileCustomization.js"></script>

<!-- Game Modules -->
<script src="riutiz/RiutizGame.js"></script>
<script src="riutiz/RiutizAI.js"></script>
<script src="riutiz/RiutizUI.js"></script>
<script src="riutiz/RiutizCollection.js"></script>
<script src="riutiz/RiutizDeckBuilder.js"></script>
<script src="riutiz/RiutizMultiplayer.js"></script>
<script src="riutiz/RiutizArt.js"></script>

<script>
// ============================================
// GAME INITIALIZATION
// ============================================
let CARD_DATA = [];
let game = null;
let ui = null;
let ai = null;
let collection = null;
let deckBuilder = null;
let multiplayer = null;
let isReady = false;

// ============================================
// INITIALIZATION
// ============================================
async function init() {
  const status = document.getElementById('loading-status');
  status.textContent = 'Loading cards...';

  try {
    // Load card data
    const response = await fetch('Data/Riutiz/cards.json');
    if (response.ok) {
      CARD_DATA = await response.json();
      status.textContent = `Loaded ${CARD_DATA.length} cards`;
    } else {
      throw new Error('Failed to load cards');
    }

    // Try to initialize arcade (may fail if Firebase not configured)
    try {
      await initializeArcade({ firebaseConfig: window.FIREBASE_CONFIG });

      if (window.arcade && window.arcade.isOnline) {
        document.getElementById('online-status').textContent = 'Online';
        document.getElementById('online-status').className = 'online-status online';

        // Initialize collection
        collection = new RiutizCollection(window.arcade, CARD_DATA);
        await collection.load();
      }
    } catch (e) {
      console.log('Running in offline mode:', e.message);
    }

    // Initialize collection for offline mode if not already done
    if (!collection) {
      collection = new RiutizCollection(null, CARD_DATA);
      await collection.load();
    }

    // Check if player needs to choose a starter deck
    if (collection.needsStarterDeck()) {
      showStarterDeckSelection();
    }

    // Initialize deck builder
    deckBuilder = new RiutizDeckBuilder(collection, CARD_DATA, { arcade: window.arcade });
    await deckBuilder.loadDecks();

    // Check for URL parameters (battle invites, spectating, lobbies)
    handleUrlParameters();

    setTimeout(() => status.textContent = '', 2000);

  } catch (err) {
    status.textContent = 'Error loading. Refresh to retry.';
    console.error(err);
  }
}

// Handle URL parameters for invites, spectating, and lobbies
function handleUrlParameters() {
  const params = new URLSearchParams(window.location.search);

  // Handle spectate mode
  const spectateId = params.get('spectate');
  if (spectateId) {
    startSpectating(spectateId);
    return;
  }

  // Handle lobby join
  const lobbyId = params.get('lobby');
  if (lobbyId) {
    joinLobbyById(lobbyId);
    return;
  }

  // Handle battle invite from friend
  const inviteFrom = params.get('invite_from');
  if (inviteFrom) {
    handleBattleInvite(inviteFrom);
    return;
  }
}

async function startSpectating(matchId) {
  if (!window.arcade?.firebase) {
    alert('Cannot spectate: Not connected online');
    return;
  }

  // Initialize friends manager for spectator tracking
  if (window.arcade) {
    const friendsManager = new FriendsManager(window.arcade);
    await friendsManager.initialize();
    await friendsManager.joinAsSpectator('riutiz', matchId);
  }

  // TODO: Load match state and show in spectator mode
  console.log('Spectating match:', matchId);
  alert('Spectator mode coming soon! Match ID: ' + matchId);
}

async function joinLobbyById(lobbyId) {
  if (!window.arcade?.firebase) {
    alert('Cannot join lobby: Not connected online');
    return;
  }

  try {
    // Initialize multiplayer
    multiplayer = new RiutizMultiplayer(window.arcade, CARD_DATA);
    await multiplayer.initialize();

    // Join the lobby (works with both ID and code)
    await multiplayer.joinLobby(lobbyId);

    // Show lobby screen
    document.querySelectorAll('.menu-screen, .game-screen, .victory-screen').forEach(el => {
      el.classList.add('hidden');
    });
    document.getElementById('lobby-screen').classList.remove('hidden');

  } catch (error) {
    console.error('Failed to join lobby:', error);
    alert('Failed to join lobby: ' + error.message);
  }
}

async function handleBattleInvite(fromUserId) {
  if (!window.arcade?.firebase) {
    alert('Cannot join game: Not connected online');
    return;
  }

  try {
    // Initialize multiplayer
    multiplayer = new RiutizMultiplayer(window.arcade, CARD_DATA);
    await multiplayer.initialize();

    // Create a lobby and send the invite response
    const result = await multiplayer.createLobby({ mode: 'casual', invitedPlayer: fromUserId });

    if (result.success) {
      // Show lobby screen
      document.querySelectorAll('.menu-screen, .game-screen, .victory-screen').forEach(el => {
        el.classList.add('hidden');
      });
      document.getElementById('lobby-screen').classList.remove('hidden');

      // The invited player should be notified and can join this lobby
      console.log('Created lobby for battle invite, code:', result.code);
    }
  } catch (error) {
    console.error('Failed to handle battle invite:', error);
    alert('Failed to set up game: ' + error.message);
  }

  // Clear the URL parameter
  window.history.replaceState({}, '', window.location.pathname);
}

// ============================================
// STARTER DECK SELECTION
// ============================================

function showStarterDeckSelection() {
  // Hide all screens
  document.querySelectorAll('.menu-screen, .game-screen, .victory-screen, .lobby-screen').forEach(el => {
    el.classList.add('hidden');
  });

  // Show starter deck screen
  document.getElementById('starter-deck-screen').classList.remove('hidden');

  // Populate grid
  const grid = document.getElementById('starter-deck-grid');
  grid.innerHTML = '';

  const decks = collection.getStarterDecks();
  decks.forEach(deck => {
    const card = document.createElement('div');
    card.className = 'starter-deck-card';
    card.dataset.color = deck.color;
    card.innerHTML = `
      <div class="starter-deck-icon">${deck.icon}</div>
      <div class="starter-deck-name">${deck.name}</div>
      <div class="starter-deck-desc">${deck.description}</div>
    `;
    card.onclick = () => selectStarterDeck(deck.id);
    grid.appendChild(card);
  });
}

async function selectStarterDeck(deckId) {
  const status = document.getElementById('loading-status');
  status.textContent = 'Setting up your collection...';

  // Grant the starter deck
  await collection.grantStarterDeck(deckId);

  // Create a default deck with the starter cards
  const deckList = collection.getStarterDeckList(deckId);
  const deck = collection.getStarterDecks().find(d => d.id === deckId);

  if (deckBuilder && deck) {
    // Save the starter deck as their first deck
    await deckBuilder.saveDeck({
      name: deck.name,
      cards: deckList,
      primary_color: deck.color
    });
  }

  status.textContent = 'Ready to play!';
  setTimeout(() => {
    status.textContent = '';
    showMenu();
  }, 1000);
}

// ============================================
// GAME FUNCTIONS
// ============================================
// AI Opponent Names
const AI_NAMES = [
  'Professor Bot',
  'Dean Algorithm',
  'Dr. Neural',
  'Coach Circuit',
  'Ms. Binary',
  'Principal Pixel',
  'Mr. Syntax',
  'Lady Logic',
  'Captain Code',
  'Sensei Silicon',
  'Baron Byte',
  'Duchess Data',
  'Sir Stacktrace',
  'Madame Matrix',
  'Chancellor Chip'
];

function getRandomAIName() {
  return AI_NAMES[Math.floor(Math.random() * AI_NAMES.length)];
}

function getRandomAIDeck() {
  // Get starter decks from deck builder or collection
  const starterDecks = deckBuilder?.starterDecks || collection?.starterDecks || [];
  if (starterDecks.length === 0) {
    console.warn('No starter decks available, AI will use random deck');
    return null;
  }

  // Pick a random starter deck
  const randomStarter = starterDecks[Math.floor(Math.random() * starterDecks.length)];
  console.log('AI selected deck:', randomStarter.name);

  // Return the deck_list array
  return randomStarter.deck_list || null;
}

function startQuickGame() {
  // Get random AI deck
  const aiDeck = getRandomAIDeck();

  // Create game instance with AI deck
  game = new RiutizGame({
    mode: 'vs-ai',
    cardData: CARD_DATA,
    player2Deck: aiDeck
  });

  // Create UI
  ui = new RiutizUI(game, {
    localPlayer: 1,
    onCardClick: (card, location) => console.log('Card clicked:', card.name, location)
  });
  ui.init();

  // Create AI with random name
  ai = new RiutizAI(game, 2);
  const aiName = getRandomAIName();
  document.getElementById('opponent-name').textContent = aiName;

  // Set up game event listeners
  game.addEventListener('turnEnded', (e) => {
    if (e.detail.nextPlayer === 2) {
      setTimeout(() => ai.takeTurn(), 500);
    }
    ui.render();
  });

  game.addEventListener('combatStarted', () => ui.render());
  game.addEventListener('attackersDeclared', () => {
    ui.render();
    // AI declares blockers after player confirms attackers
    if (game.state.currentPlayer === 1) {
      setTimeout(() => ai.declareBlockers(), 1000);
    }
  });

  game.addEventListener('combatResolved', (e) => {
    ui.setMessage(e.detail.pointsScored > 0 ?
      `Dealt ${e.detail.pointsScored} points!` :
      'Combat resolved!');
    ui.render();
  });

  game.addEventListener('gameOver', (e) => {
    ui.showVictoryScreen(
      e.detail.winner,
      game.state.players[1].points,
      game.state.players[2].points
    );
  });

  // Start game
  game.startGame();

  // Show game screen
  ui.showGameScreen();
  ui.setMessage('Game started! Your turn.');
  ui.render();
}

function showMenu() {
  document.querySelectorAll('.menu-screen, .game-screen, .victory-screen, .lobby-screen').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById('menu-screen').classList.remove('hidden');
}

// ============================================
// MULTIPLAYER FUNCTIONS
// ============================================
let selectedGameMode = 'casual';
let selectedDeckId = null;
let multiplayerAction = 'quickmatch'; // 'quickmatch' or 'lobby'

function showMultiplayerMenu() {
  document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
  document.getElementById('multiplayer-menu').classList.remove('hidden');
}

function showGameModeSelect(action = null) {
  if (action) multiplayerAction = action;
  document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
  document.getElementById('mode-select-screen').classList.remove('hidden');
}

function selectGameMode(mode) {
  selectedGameMode = mode;
  showDeckSelect();
}

function showDeckSelect() {
  document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
  document.getElementById('deck-select-screen').classList.remove('hidden');

  // Update label
  const label = document.getElementById('deck-select-mode-label');
  label.textContent = selectedGameMode === 'casual' ? 'Casual Mode - Any Deck' : 'Ranked Mode - Owned Cards Only';
  label.style.color = selectedGameMode === 'casual' ? 'var(--green)' : 'var(--orange)';

  // Populate deck grid
  populateDeckSelectGrid();
}

function populateDeckSelectGrid() {
  const grid = document.getElementById('deck-select-grid');
  const decks = deckBuilder.getDecksForMode(selectedGameMode);

  if (decks.length === 0) {
    grid.innerHTML = `
      <div class="no-decks-message" style="grid-column: 1 / -1;">
        <p>No valid decks for ${selectedGameMode} mode!</p>
        <p style="font-size: 0.875rem;">You need a deck with at least 40 cards${selectedGameMode === 'ranked' ? ' using only cards you own' : ''}.</p>
      </div>
    `;
    document.getElementById('confirm-deck-btn').classList.add('hidden');
    return;
  }

  grid.innerHTML = decks.map(deck => {
    const isValidForRanked = selectedGameMode === 'ranked' ? deckBuilder.isDeckValidForRanked(deck) : true;
    const errors = selectedGameMode === 'ranked' && !isValidForRanked ? deckBuilder.getRankedValidationErrors(deck) : [];

    return `
      <div class="deck-select-card ${!isValidForRanked ? 'invalid' : ''}"
           data-deck-id="${deck.id}"
           onclick="${isValidForRanked ? `selectDeck('${deck.id}')` : ''}">
        <div class="deck-select-name">
          <span class="deck-select-color ${deck.primary_color || 'C'}"></span>
          ${deck.name}
        </div>
        <div class="deck-select-info">
          <span>${deck.card_count} cards</span>
          <span>${deck.deck_type === 'ranked' ? 'üèÜ' : 'üéÆ'}</span>
        </div>
        ${errors.length > 0 ? `<div class="deck-select-warning">${errors[0]}</div>` : ''}
      </div>
    `;
  }).join('');

  // Clear selection
  selectedDeckId = null;
  document.getElementById('confirm-deck-btn').classList.add('hidden');
}

function selectDeck(deckId) {
  selectedDeckId = deckId;

  // Update UI
  document.querySelectorAll('.deck-select-card').forEach(card => {
    card.classList.toggle('selected', card.dataset.deckId === deckId);
  });

  document.getElementById('confirm-deck-btn').classList.remove('hidden');
}

async function confirmDeckSelection() {
  if (!selectedDeckId) {
    alert('Please select a deck first!');
    return;
  }

  if (multiplayerAction === 'quickmatch') {
    await startQuickMatch();
  } else if (multiplayerAction === 'lobby') {
    await createLobbyWithDeck();
  } else if (multiplayerAction === 'join-lobby') {
    await joinLobbyWithDeck();
  }
}

async function joinLobbyWithDeck() {
  if (!pendingLobbyCode) {
    showJoinLobby();
    return;
  }

  try {
    await multiplayer.joinLobby(pendingLobbyCode, { deckId: selectedDeckId });

    document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
    document.getElementById('lobby-screen').classList.remove('hidden');

    updateLobbyUI();

    multiplayer.matchmaking.onLobbyChange((data) => {
      if (data.event === 'match_started') {
        startMultiplayerGame(data);
      } else {
        updateLobbyUI();
      }
    });

    pendingLobbyCode = null;

  } catch (error) {
    alert('Error joining lobby: ' + error.message);
    pendingLobbyCode = null;
  }
}

async function startQuickMatch() {
  if (!window.arcade || !window.arcade.isOnline) {
    alert('Multiplayer requires online connection');
    return;
  }

  document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
  document.getElementById('multiplayer-menu').classList.remove('hidden');

  const queueStatus = document.getElementById('queue-status');
  queueStatus.classList.remove('hidden');
  queueStatus.textContent = `Finding ${selectedGameMode} match...`;

  try {
    // Initialize multiplayer if needed
    if (!multiplayer) {
      game = new RiutizGame({ mode: 'online-pvp', cardData: CARD_DATA });
      multiplayer = new RiutizMultiplayer(game, window.arcade);
      await multiplayer.initialize();

      multiplayer.onMatchStartCallback((match) => {
        startMultiplayerGame(match);
      });
    }

    await multiplayer.joinQueue({ mode: selectedGameMode, deckId: selectedDeckId });

  } catch (error) {
    queueStatus.textContent = 'Error: ' + error.message;
    console.error(error);
  }
}

async function createLobbyWithDeck() {
  if (!window.arcade || !window.arcade.isOnline) {
    alert('Multiplayer requires online connection');
    return;
  }

  try {
    // Initialize multiplayer if needed
    if (!multiplayer) {
      game = new RiutizGame({ mode: 'online-pvp', cardData: CARD_DATA });
      multiplayer = new RiutizMultiplayer(game, window.arcade);
      await multiplayer.initialize();

      multiplayer.onMatchStartCallback((match) => {
        startMultiplayerGame(match);
      });
    }

    const result = await multiplayer.createLobby({
      mode: selectedGameMode,
      deckId: selectedDeckId
    });

    document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
    document.getElementById('lobby-screen').classList.remove('hidden');
    document.getElementById('lobby-code-display').textContent = result.joinCode;
    document.getElementById('start-match-btn').classList.remove('hidden');

    // Update lobby mode display
    updateLobbyUI();

    multiplayer.matchmaking.onLobbyChange((data) => {
      if (data.event === 'match_started') {
        startMultiplayerGame(data);
      } else {
        updateLobbyUI();
      }
    });

  } catch (error) {
    alert('Error creating lobby: ' + error.message);
  }
}

function showJoinLobby() {
  document.querySelectorAll('.menu-screen').forEach(el => el.classList.add('hidden'));
  document.getElementById('join-lobby-screen').classList.remove('hidden');
}

let pendingLobbyCode = null;

async function joinLobbyByCode() {
  const code = document.getElementById('lobby-code-input').value.toUpperCase();
  if (code.length < 4) {
    alert('Please enter a valid code');
    return;
  }

  try {
    if (!multiplayer) {
      game = new RiutizGame({ mode: 'online-pvp', cardData: CARD_DATA });
      multiplayer = new RiutizMultiplayer(game, window.arcade);
      await multiplayer.initialize();
    }

    // First, peek at the lobby to get its mode
    const lobbyInfo = await multiplayer.matchmaking.getLobbyInfo(code);
    if (lobbyInfo) {
      // Store code and show deck selection for the lobby's mode
      pendingLobbyCode = code;
      selectedGameMode = lobbyInfo.mode || 'casual';
      multiplayerAction = 'join-lobby';
      showDeckSelect();
      return;
    }

    // If we can't get lobby info, just join directly
    await multiplayer.joinLobby(code);

    document.getElementById('join-lobby-screen').classList.add('hidden');
    document.getElementById('lobby-screen').classList.remove('hidden');
    document.getElementById('lobby-code-display').textContent = code;
    document.getElementById('start-match-btn').classList.add('hidden');

    updateLobbyUI();

    multiplayer.matchmaking.onLobbyChange((data) => {
      if (data.event === 'match_started') {
        startMultiplayerGame(data);
      } else {
        updateLobbyUI();
      }
    });

  } catch (error) {
    alert('Error joining lobby: ' + error.message);
  }
}

function updateLobbyUI() {
  const lobby = multiplayer?.currentLobby;
  if (!lobby) return;

  // Update mode display
  const modeDisplay = document.getElementById('lobby-mode-display');
  if (modeDisplay) {
    const isRanked = lobby.mode === 'ranked';
    modeDisplay.textContent = isRanked ? 'üèÜ Ranked Mode' : 'üéÆ Casual Mode';
    modeDisplay.style.color = isRanked ? 'var(--orange)' : 'var(--green)';
  }

  const container = document.getElementById('lobby-players');
  container.innerHTML = '';

  for (const [id, player] of Object.entries(lobby.players || {})) {
    const deckName = player.deck_id ? getDeckName(player.deck_id) : 'No deck';
    const div = document.createElement('div');
    div.className = 'lobby-player' + (player.ready ? ' ready' : '');
    div.innerHTML = `
      <div>
        <div>${player.display_name}${player.is_host ? ' (Host)' : ''}</div>
        <div style="font-size: 0.75rem; color: #71717a;">${deckName}</div>
      </div>
      <span class="ready-badge">${player.ready ? 'Ready' : 'Not Ready'}</span>
    `;
    container.appendChild(div);
  }
}

function getDeckName(deckId) {
  if (!deckBuilder) return 'Deck';
  const deck = deckBuilder.savedDecks[deckId];
  return deck?.name || 'Deck';
}

async function toggleReady() {
  isReady = !isReady;
  await multiplayer.setReady(isReady, selectedDeckId);
  document.getElementById('ready-btn').textContent = isReady ? 'Unready' : 'Ready Up';
  document.getElementById('ready-btn').className = 'btn ' + (isReady ? 'btn-danger' : 'btn-primary');
}

async function startLobbyMatch() {
  try {
    await multiplayer.startMatchFromLobby();
  } catch (error) {
    alert('Error starting match: ' + error.message);
  }
}

async function leaveLobbyScreen() {
  if (multiplayer) {
    await multiplayer.leaveLobby();
  }
  showMultiplayerMenu();
}

function startMultiplayerGame(match) {
  // Hide lobby/menu
  document.querySelectorAll('.menu-screen, .lobby-screen').forEach(el => {
    el.classList.add('hidden');
  });

  // Set up UI
  ui = new RiutizUI(game, {
    localPlayer: multiplayer.localPlayerNumber
  });
  ui.init();

  // Set opponent name
  const opponent = multiplayer.sync.getOpponent();
  document.getElementById('opponent-name').textContent = opponent?.display_name || 'Opponent';

  // Show game
  ui.showGameScreen();
  ui.setMessage('Match started!');
  ui.render();
}

// ============================================
// DECK MANAGEMENT
// ============================================
let editingDeckId = null;
let editingDeckType = 'casual';
let pendingDeckAction = null; // 'new', 'edit', 'duplicate'

function showDeckManagement() {
  document.querySelectorAll('.menu-screen, .game-screen, .victory-screen, .lobby-screen, .deck-builder-screen').forEach(el => {
    el.classList.add('hidden');
  });
  document.getElementById('deck-management-screen').classList.remove('hidden');

  // Initialize deck builder if needed
  if (!deckBuilder) {
    deckBuilder = new RiutizDeckBuilder(collection, CARD_DATA, { arcade: window.arcade });
  }

  renderDeckManagement();
}

function closeDeckManagement() {
  document.getElementById('deck-management-screen').classList.add('hidden');
  document.getElementById('menu-screen').classList.remove('hidden');
}

function renderDeckManagement() {
  const container = document.getElementById('deck-list-container');
  const starters = deckBuilder.starterDecks || [];
  const userDecks = Object.values(deckBuilder.savedDecks || {});
  const chosenStarterId = collection?.collection?.chosen_starter;

  let html = '';

  // Starter deck section (only show chosen starter)
  const chosenStarter = chosenStarterId ? starters.find(d => d.id === chosenStarterId) : null;
  if (chosenStarter) {
    html += `<div class="deck-section">
      <div class="deck-section-title">Starter Deck</div>
      <div class="deck-card">
        <div class="deck-card-icon starter">${chosenStarter.icon || 'üé¥'}</div>
        <div class="deck-card-info">
          <div class="deck-card-name">${chosenStarter.name}</div>
          <div class="deck-card-meta">
            <span>${chosenStarter.deck_list?.length || 40} cards</span>
            <span class="deck-card-type starter">Starter</span>
            <span class="deck-card-type ranked">Ranked</span>
          </div>
        </div>
        <div class="deck-card-actions">
          <button class="deck-action-btn duplicate" onclick="duplicateDeck('starter', '${chosenStarter.id}')">Duplicate</button>
        </div>
      </div>
    </div>`;
  }

  // User decks section
  if (userDecks.length > 0) {
    html += `<div class="deck-section">
      <div class="deck-section-title">My Decks (${userDecks.length})</div>`;

    userDecks.forEach(deck => {
      const deckType = deck.deck_type || 'casual';
      const typeIcon = deckType === 'ranked' ? 'üèÜ' : 'üéÆ';
      const iconClass = deckType === 'ranked' ? 'ranked' : 'casual';

      html += `
        <div class="deck-card">
          <div class="deck-card-icon ${iconClass}">${typeIcon}</div>
          <div class="deck-card-info">
            <div class="deck-card-name">${deck.name}</div>
            <div class="deck-card-meta">
              <span>${deck.card_count || deck.cards?.length || 0} cards</span>
              <span class="deck-card-type ${deckType}">${deckType}</span>
            </div>
          </div>
          <div class="deck-card-actions">
            <button class="deck-action-btn edit" onclick="editDeck('${deck.id}')">Edit</button>
            <button class="deck-action-btn duplicate" onclick="duplicateDeck('user', '${deck.id}')">Copy</button>
            <button class="deck-action-btn delete" onclick="deleteDeckConfirm('${deck.id}')">Delete</button>
          </div>
        </div>
      `;
    });

    html += `</div>`;
  }

  if (!chosenStarter && userDecks.length === 0) {
    html = `<div class="empty-deck-message">
      <p>No decks yet!</p>
      <p>Create a new deck to get started.</p>
    </div>`;
  }

  container.innerHTML = html;
}

function showNewDeckTypeModal() {
  pendingDeckAction = 'new';
  editingDeckId = null;
  document.getElementById('deck-type-modal-title').textContent = 'Select Deck Type';
  document.getElementById('deck-type-modal').classList.remove('hidden');

  // Reset selection
  document.querySelectorAll('.deck-type-option').forEach(opt => opt.classList.remove('selected'));
}

function closeDeckTypeModal() {
  document.getElementById('deck-type-modal').classList.add('hidden');
  pendingDeckAction = null;
}

function selectDeckType(type) {
  editingDeckType = type;
  document.querySelectorAll('.deck-type-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.type === type);
  });
}

function confirmDeckType() {
  if (!editingDeckType) {
    alert('Please select a deck type');
    return;
  }

  closeDeckTypeModal();

  if (pendingDeckAction === 'new') {
    // Create new deck
    deckBuilder.clear();
    deckBuilder.deckName = 'New Deck';
    deckBuilder.deckId = null;
    deckBuilder.setMode(editingDeckType);
    deckBuilder.deckType = editingDeckType;
    openDeckEditor();
  } else if (pendingDeckAction === 'edit') {
    // Edit existing deck
    deckBuilder.loadDeck(editingDeckId);
    deckBuilder.setMode(editingDeckType);
    openDeckEditor();
  } else if (pendingDeckAction === 'duplicate') {
    // Duplicate deck (already loaded)
    deckBuilder.setMode(editingDeckType);
    deckBuilder.deckType = editingDeckType;
    openDeckEditor();
  }
}

function editDeck(deckId) {
  const deck = deckBuilder.savedDecks[deckId];
  if (!deck) return;

  // For existing decks, use their type directly and go to editor
  editingDeckId = deckId;
  editingDeckType = deck.deck_type || 'casual';
  deckBuilder.loadDeck(deckId);
  deckBuilder.setMode(editingDeckType);
  openDeckEditor();
}

function duplicateDeck(source, deckId) {
  if (source === 'starter') {
    // Load starter deck
    deckBuilder.loadStarterDeck(deckId);
    deckBuilder.deckName = deckBuilder.deckName.replace(' (Copy)', '') + ' (Copy)';
  } else {
    // Load user deck
    deckBuilder.loadDeck(deckId);
    deckBuilder.deckName = deckBuilder.deckName.replace(' (Copy)', '') + ' (Copy)';
    deckBuilder.deckId = null; // Clear ID so it creates a new deck
  }

  // Show type selection for the duplicate
  pendingDeckAction = 'duplicate';
  editingDeckId = null;
  document.getElementById('deck-type-modal-title').textContent = 'Select Type for Copy';
  document.getElementById('deck-type-modal').classList.remove('hidden');

  // Pre-select ranked for starter duplicates
  if (source === 'starter') {
    selectDeckType('ranked');
  } else {
    document.querySelectorAll('.deck-type-option').forEach(opt => opt.classList.remove('selected'));
  }
}

function deleteDeckConfirm(deckId) {
  const deck = deckBuilder.savedDecks[deckId];
  if (!deck) return;

  if (confirm(`Delete "${deck.name}"? This cannot be undone.`)) {
    deckBuilder.deleteDeck(deckId);
    renderDeckManagement();
  }
}

function openDeckEditor() {
  document.getElementById('deck-management-screen').classList.add('hidden');
  document.getElementById('deck-builder-screen').classList.remove('hidden');

  // Update type indicator to reflect current type
  document.getElementById('deck-type-casual-indicator').classList.toggle('active', editingDeckType === 'casual');
  document.getElementById('deck-type-ranked-indicator').classList.toggle('active', editingDeckType === 'ranked');

  // Update deck name input
  document.getElementById('deck-name-input').value = deckBuilder.deckName || 'New Deck';

  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

// ============================================
// DECK BUILDER (EDITOR)
// ============================================
function showDeckBuilder() {
  // Redirect to deck management for new flow
  showDeckManagement();
}

function openDeckBuilder() {
  // Alias for backward compatibility
  showDeckManagement();
}

function closeDeckBuilder() {
  document.getElementById('deck-builder-screen').classList.add('hidden');
  showDeckManagement();
}

function setDeckMode(mode) {
  deckBuilder.setMode(mode);

  // Update UI
  document.querySelectorAll('.deck-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });

  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function setCardFilter(filterType, value) {
  deckBuilder.setFilter(filterType, value);

  // Update active state for color filters
  if (filterType === 'color') {
    document.querySelectorAll('.filter-btn[data-filter="color"]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.value === (value || ''));
    });
  }

  renderCardGrid();
}

function renderCardGrid() {
  const grid = document.getElementById('card-grid');
  const cards = deckBuilder.getFilteredCards();

  grid.innerHTML = cards.map(card => {
    const inDeck = deckBuilder.getCardCount(card.id);
    const owned = collection ? collection.getQuantity(card.id) : 99;
    const color = getCardColor(card.cost);
    const bgColor = getCardBgColor(color);

    return `
      <div class="card-grid-item"
           onclick="addCardToDeck(${card.id})"
           onmouseenter="showHoverPreview(${card.id}, event)"
           onmouseleave="hideHoverPreview()"
           ontouchstart="handleTouchStart(${card.id}, event)"
           ontouchmove="handleTouchMove()"
           ontouchend="handleTouchEnd(${card.id}, event)">
        ${inDeck > 0 ? `<div class="card-count">${inDeck}</div>` : ''}
        ${deckBuilder.mode === 'ranked' ? `<div class="owned-count">x${owned}</div>` : ''}
        <div class="card small" style="background: ${bgColor};">
          <div class="card-inner">
            <div class="card-header">
              <span class="card-name">${card.name}</span>
            </div>
            <div class="card-cost">${renderManaCost(card.cost)}</div>
            <div class="card-art" style="background: ${bgColor};">${getCardEmoji(card.type)}</div>
            <div class="card-stats">
              ${card.dice ? `<span class="stat-dice">${card.dice}d</span>` : ''}
              ${card.hp ? `<span class="stat-hp">${card.hp}hp</span>` : ''}
            </div>
            <div class="card-rarity ${card.rarity || 'C'}"></div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderDeckList() {
  const list = document.getElementById('deck-list');
  const deckCards = deckBuilder.getDeckCards();

  if (deckCards.length === 0) {
    list.innerHTML = '<div class="empty-deck-message">Click cards to add them to your deck</div>';
    return;
  }

  list.innerHTML = deckCards.map(card => {
    const color = getCardColor(card.cost);
    return `
      <div class="deck-card-row"
           onmouseenter="showHoverPreview(${card.id}, event)"
           onmouseleave="hideHoverPreview()"
           ontouchstart="handleTouchStart(${card.id}, event)"
           ontouchmove="handleTouchMove()"
           ontouchend="handleTouchEnd(${card.id}, event)">
        <div class="deck-card-info">
          <div class="deck-card-cost">${renderManaCost(card.cost)}</div>
          <span class="deck-card-name">${card.name}</span>
        </div>
        <span class="deck-card-count">x${card.count}</span>
        <button class="deck-card-remove" onclick="event.stopPropagation(); removeCardFromDeck(${card.id})">-</button>
      </div>
    `;
  }).join('');

  // Update deck name input
  document.getElementById('deck-name-input').value = deckBuilder.deckName;
}

function updateDeckStats() {
  const stats = deckBuilder.getDeckStats();
  const isValid = stats.size >= deckBuilder.minDeckSize;

  document.getElementById('deck-size-stat').textContent = stats.size;
  document.getElementById('deck-size-stat').className = 'deck-stat-value ' + (isValid ? 'valid' : 'invalid');
  document.getElementById('deck-unique-stat').textContent = stats.uniqueCards;
  document.getElementById('deck-pupils-stat').textContent = stats.types.Pupil;
  document.getElementById('deck-spells-stat').textContent = stats.types.Interruption + stats.types.Tool + stats.types.Location;

  // Update mana curve
  renderManaCurve(stats.curve);
}

function renderManaCurve(curve) {
  const container = document.getElementById('mana-curve');
  const maxVal = Math.max(...Object.values(curve), 1);
  const labels = ['0', '1', '2', '3', '4', '5', '6+'];

  container.innerHTML = labels.map((label, i) => {
    const key = i >= 6 ? '6+' : i;
    const count = curve[key] || 0;
    const height = Math.round((count / maxVal) * 100);
    return `
      <div class="curve-bar" style="height: ${height}%;" title="${count} cards at cost ${label}">
        <span class="curve-bar-label">${label}</span>
      </div>
    `;
  }).join('');
}

function addCardToDeck(cardId) {
  const result = deckBuilder.addCard(cardId);
  if (!result.success) {
    showToast(result.error);
    return;
  }

  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function removeCardFromDeck(cardId) {
  deckBuilder.removeCard(cardId);
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function clearCurrentDeck() {
  if (deckBuilder.currentDeck.length > 0 && !confirm('Clear all cards from deck?')) {
    return;
  }
  deckBuilder.clearDeck();
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

async function saveDeck() {
  const name = document.getElementById('deck-name-input').value.trim();
  if (!name) {
    showToast('Please enter a deck name');
    return;
  }

  // Save with deck type
  deckBuilder.deckType = editingDeckType;
  const result = await deckBuilder.saveDeck(name);
  if (!result.success) {
    showToast('Deck invalid: ' + result.errors[0]);
    return;
  }

  showToast('Deck saved!');

  // Go back to deck management
  closeDeckBuilder();
}

function showSavedDecks() {
  const panel = document.getElementById('saved-decks-panel');
  const list = document.getElementById('saved-decks-list');

  const decks = Object.values(deckBuilder.savedDecks);
  const starters = deckBuilder.starterDecks || [];

  // Only show the starter deck the player chose
  const chosenStarterId = collection?.collection?.chosen_starter;
  const chosenStarter = chosenStarterId ? starters.find(d => d.id === chosenStarterId) : null;

  let html = '';

  // Show only the chosen starter deck
  if (chosenStarter) {
    html += '<div style="padding: 0.5rem; color: #71717a; font-size: 0.75rem;">Starter Deck</div>';
    html += `
      <div class="saved-deck-row" onclick="loadStarterDeck('${chosenStarter.id}')">
        <div class="saved-deck-info">
          <div class="saved-deck-name">${chosenStarter.icon || ''} ${chosenStarter.name}</div>
          <div class="saved-deck-count">${chosenStarter.deck_list?.length || 40} cards</div>
        </div>
      </div>
    `;
  }

  // Saved decks
  if (decks.length > 0) {
    html += '<div style="padding: 0.5rem; color: #71717a; font-size: 0.75rem; border-top: 1px solid #27272a;">Your Decks</div>';
    decks.forEach(deck => {
      html += `
        <div class="saved-deck-row" onclick="loadSavedDeck('${deck.id}')">
          <div class="saved-deck-info">
            <div class="saved-deck-name">${deck.name}</div>
            <div class="saved-deck-count">${deck.card_count} cards</div>
          </div>
          <button class="deck-card-remove" onclick="event.stopPropagation(); deleteSavedDeck('${deck.id}')">√ó</button>
        </div>
      `;
    });
  }

  if (!html) {
    html = '<div class="empty-deck-message">No saved decks yet</div>';
  }

  list.innerHTML = html;
  panel.classList.remove('hidden');
}

function hideSavedDecks() {
  document.getElementById('saved-decks-panel').classList.add('hidden');
}

function loadSavedDeck(deckId) {
  deckBuilder.loadDeck(deckId);
  hideSavedDecks();
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

function loadStarterDeck(deckId) {
  deckBuilder.loadStarterDeck(deckId);
  hideSavedDecks();
  renderCardGrid();
  renderDeckList();
  updateDeckStats();
}

async function deleteSavedDeck(deckId) {
  if (!confirm('Delete this deck?')) return;
  await deckBuilder.deleteDeck(deckId);
  showSavedDecks();
}

let hoverPreviewTimeout = null;
let longPressTimer = null;
let longPressCardId = null;
let touchMoved = false;

function handleTouchStart(cardId, event) {
  touchMoved = false;
  longPressCardId = cardId;
  longPressTimer = setTimeout(() => {
    if (!touchMoved) {
      showMobilePreview(cardId);
    }
  }, 500); // 500ms long press
}

function handleTouchMove() {
  touchMoved = true;
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
}

function handleTouchEnd(cardId, event) {
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }

  // If it was a long press (preview is showing), prevent the click
  const preview = document.getElementById('preview-overlay');
  if (preview && !preview.classList.contains('hidden')) {
    event.preventDefault();
    return false;
  }
}

function showMobilePreview(cardId) {
  // Use the full-screen preview for mobile
  showCardPreview(cardId);
}

function showHoverPreview(cardId, event) {
  // Clear any pending hide
  if (hoverPreviewTimeout) {
    clearTimeout(hoverPreviewTimeout);
    hoverPreviewTimeout = null;
  }

  const card = CARD_DATA.find(c => c.id === cardId);
  if (!card) return;

  let preview = document.getElementById('hover-preview');
  if (!preview) {
    preview = document.createElement('div');
    preview.id = 'hover-preview';
    preview.style.cssText = `
      position: fixed;
      z-index: 1000;
      pointer-events: none;
      transition: opacity 0.15s;
    `;
    document.body.appendChild(preview);
  }

  const color = getCardColor(card.cost);
  const bgColor = getCardBgColor(color);

  preview.innerHTML = `
    <div class="preview-card" style="background: ${bgColor}; width: 16rem; border-radius: 0.75rem; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
      <div class="preview-header" style="padding: 0.75rem 0.75rem 0.5rem;">
        <div class="preview-name-row" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.25rem;">
          <span class="preview-name" style="font-size: 1rem; font-weight: bold;">${card.name}</span>
          <div class="preview-cost" style="display: flex; gap: 0.2rem;">${renderManaCost(card.cost)}</div>
        </div>
        <div class="preview-type" style="color: #a1a1aa; font-size: 0.75rem;">${card.type || 'Unknown'}</div>
      </div>
      <div class="preview-art" style="height: 5rem; margin: 0 0.75rem; border-radius: 0.25rem; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; opacity: 0.6; background: ${bgColor};">${getCardEmoji(card.type)}</div>
      <div class="preview-stats" style="display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; font-size: 0.875rem;">
        ${card.dice ? `<span><span style="color: #fbbf24;">Dice:</span> ${card.dice}</span>` : '<span></span>'}
        ${card.hp ? `<span><span style="color: #ef4444;">HP:</span> ${card.hp}</span>` : '<span></span>'}
      </div>
      <div class="preview-ability" style="padding: 0.5rem 0.75rem; min-height: 3rem;">
        ${card.ability ? `<p style="font-size: 0.75rem; line-height: 1.4; color: #e4e4e7;">${card.ability}</p>` : '<p style="color: #71717a; font-style: italic; font-size: 0.75rem;">No special ability</p>'}
      </div>
      <div style="padding: 0.25rem 0.75rem 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 0.25rem;">
        <p style="font-size: 0.65rem; color: #71717a;">Resource: Produces <span style="color: ${getColorHex(color)};">(${color})</span></p>
      </div>
    </div>
  `;

  // Position the preview
  const rect = event.target.closest('.card-grid-item').getBoundingClientRect();
  const previewWidth = 256;
  const previewHeight = 320;

  let left = rect.right + 10;
  let top = rect.top;

  // If preview would go off right edge, show on left
  if (left + previewWidth > window.innerWidth - 20) {
    left = rect.left - previewWidth - 10;
  }

  // If preview would go off bottom, adjust up
  if (top + previewHeight > window.innerHeight - 20) {
    top = window.innerHeight - previewHeight - 20;
  }

  // If preview would go off top, adjust down
  if (top < 20) {
    top = 20;
  }

  preview.style.left = left + 'px';
  preview.style.top = top + 'px';
  preview.style.opacity = '1';
  preview.style.display = 'block';
}

function hideHoverPreview() {
  hoverPreviewTimeout = setTimeout(() => {
    const preview = document.getElementById('hover-preview');
    if (preview) {
      preview.style.opacity = '0';
      setTimeout(() => {
        if (preview.style.opacity === '0') {
          preview.style.display = 'none';
        }
      }, 150);
    }
  }, 100);
}

function showCardPreview(cardId) {
  const card = CARD_DATA.find(c => c.id === cardId);
  if (!card) return;

  const overlay = document.getElementById('preview-overlay');
  const color = getCardColor(card.cost);
  const bgColor = getCardBgColor(color);

  overlay.innerHTML = `
    <div class="preview-card" style="background: ${bgColor};">
      <div class="preview-header">
        <div class="preview-name-row">
          <span class="preview-name">${card.name}</span>
          <div class="preview-cost">${renderManaCost(card.cost)}</div>
        </div>
        <div class="preview-type">${card.type || 'Unknown'}</div>
      </div>
      <div class="preview-art" style="background: ${bgColor};">${getCardEmoji(card.type)}</div>
      <div class="preview-stats">
        ${card.dice ? `<span><span class="stat-dice">Dice:</span> ${card.dice}</span>` : ''}
        ${card.hp ? `<span><span class="stat-hp">HP:</span> ${card.hp}</span>` : ''}
      </div>
      <div class="preview-ability">
        ${card.ability ? `<p>${card.ability}</p>` : '<p class="no-ability">No special ability</p>'}
      </div>
      <div class="preview-resource">
        <p>Resource: Produces <span style="color: ${getColorHex(color)};">(${color})</span></p>
      </div>
      <div class="preview-footer">
        <span class="preview-rarity">${getRarityName(card.rarity)}</span>
      </div>
      <div class="preview-hint">Tap anywhere to close</div>
    </div>
  `;

  overlay.classList.remove('hidden');
  overlay.onclick = () => overlay.classList.add('hidden');
}

// Utility functions for card rendering
function getCardColor(cost) {
  if (!cost) return 'C';
  const matches = cost.match(/\(([^)]+)\)/g) || [];
  for (const m of matches) {
    const val = m.replace(/[()]/g, '');
    if (!/^\d+$/.test(val)) return val;
  }
  return 'C';
}

function getCardBgColor(color) {
  const colors = {
    'O': 'linear-gradient(135deg, #431407, #7c2d12)',
    'G': 'linear-gradient(135deg, #052e16, #14532d)',
    'P': 'linear-gradient(135deg, #3b0764, #581c87)',
    'B': 'linear-gradient(135deg, #172554, #1e3a8a)',
    'Bk': 'linear-gradient(135deg, #18181b, #27272a)',
    'C': 'linear-gradient(135deg, #27272a, #3f3f46)'
  };
  return colors[color] || colors['C'];
}

function getColorHex(color) {
  const colors = { 'O': '#f97316', 'G': '#22c55e', 'P': '#a855f7', 'B': '#3b82f6', 'Bk': '#a1a1aa', 'C': '#d4d4d8' };
  return colors[color] || colors['C'];
}

function getCardEmoji(type) {
  if (!type) return '?';
  if (type.includes('Pupil')) return 'üë§';
  if (type === 'Interruption') return '‚ö°';
  if (type === 'Tool') return 'üîß';
  if (type === 'Location') return 'üèõÔ∏è';
  return '?';
}

function getRarityName(rarity) {
  const names = { 'C': 'Common', 'U': 'Uncommon', 'R': 'Rare' };
  return names[rarity] || 'Common';
}

function renderManaCost(cost) {
  if (!cost) return '';
  const matches = cost.match(/\(([^)]+)\)/g) || [];
  return matches.map(m => {
    const val = m.replace(/[()]/g, '');
    if (/^\d+$/.test(val)) {
      return `<span class="mana-pip generic">${val}</span>`;
    }
    const color = getColorHex(val);
    return `<span class="mana-pip" style="background: ${color};">${val}</span>`;
  }).join('');
}

function showToast(message) {
  // Simple toast notification
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.style.cssText = `
    position: fixed;
    bottom: 5rem;
    left: 50%;
    transform: translateX(-50%);
    background: #27272a;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    z-index: 200;
    animation: fadeIn 0.2s;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => toast.remove(), 2500);
}

// ============================================
// INITIALIZE ON LOAD
// ============================================
init();
</script>
</body>
</html>
