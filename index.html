<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Learning Portal</title>
    
    <!-- Load shared styles -->
    <link rel="stylesheet" href="shared/styles.css">

    <!-- Load shared configuration first -->
    <script src="shared/config.js"></script>
    <script src="shared/supabase.min.js"></script>

    <style>
       :root{
          --bg:#0f1216;
          --card:#151a21;
          --text:#e6edf3;
          --muted:#97a2b0;
          --accent:#6aa9ff;
          --accent-2:#8bffb0;
          --danger:#ff6a6a;
          --warning:#ffd36a;
          --link:#a0c2ff;
          --border:#2a3140;
          
          /* Unified theme variables */
          --primary: var(--accent);
          --secondary: var(--accent-2);
          --background: var(--bg);
          --card-bg: var(--card);
          --text-color: var(--text);
          --muted-color: var(--muted);
          --border-color: var(--border);

          /* Button color scheme (overridden by JS) */
          --btn-bg: linear-gradient(135deg, #6aa9ff, #8bffb0);
          --btn-text: #0b0f14;
          --btn-shadow: rgba(106, 169, 255, 0.3);
        }
        
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%}
        body{
          font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell;
          background:var(--bg);
          color:var(--text);
          -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
        }
        
        /* Shell */
        .container{
          background:var(--card);
          border:1px solid var(--border);
          border-radius:16px;
          width:100%; max-width:1200px; min-height:600px; overflow:hidden;
          box-shadow:0 10px 30px rgba(0,0,0,.35);
          margin: 20px auto;
        }
        
        /* Header */
        .header{
          background:rgba(0,0,0,.25);
          border-bottom:1px solid var(--border);
          color:var(--text);
          padding:16px 20px;
          text-align:center;
          position:relative;
        }
        .header h1{font-size:20px;letter-spacing:.3px}
        #welcome-message{opacity:.85}
        .logout-btn{
          position:absolute; right:20px; top:50%; transform:translateY(-50%);
          background:#0c1118; border:1px solid #223041; color:#e5e7eb;
          padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer;
        }
        .logout-btn:hover{border-color:var(--accent-2); box-shadow:0 0 0 2px rgba(139,255,176,.08)}
        
        /* Top nav tabs */
        .nav-tabs{
          display:flex; gap:0; background:#0c1118; border-bottom:1px solid var(--border);
        }
        .nav-tab{
          flex:1; padding:12px 14px; text-align:center; cursor:pointer; border:0;
          background:transparent; color:#c7d2fe;
          transition:color .15s ease, background-color .15s ease, border-color .15s ease;
          display: inline-block;
          text-decoration: none;
          font-family: inherit;
          font-size: inherit;
        }
        .nav-tab:hover{background:rgba(255,255,255,.02); color:#a5b4fc}
        .nav-tab.active{
          color:var(--accent); font-weight:700; border-bottom:3px solid var(--accent); background:#0b0f14;
        }
        
        /* Content area */
        .content{padding:20px; min-height:400px}
        
        /* Cards & layout */
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-top:16px}
        .card{
          background:#0c1118;
          border:1px solid #223041;
          border-radius:12px; padding:16px;
          box-shadow:0 6px 16px rgba(0,0,0,.25);
        }
        .card h3{margin-bottom:8px}
        
        /* Forms */
        .form-group{margin-bottom:16px; text-align:left}
        .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--text);font-size:14px}
        .form-group input,.form-group select, .form-group textarea{
          width:100%; padding:8px 12px; border-radius:8px;
          background:#0e1319; color:var(--text); border:1px solid var(--border); font-size:14px;
          transition:border-color .15s ease, box-shadow .15s ease;
        }
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{
          outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(106,169,255,.2);
        }
        .auth-form{max-width:400px;margin:0 auto;text-align:center}
        
        /* Buttons */
        .btn{
          appearance:none; border:1px solid #223041; background:#0c1118; color:#e5e7eb;
          padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer;
          transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease, transform .02s ease;
        }
        .btn:hover{border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.1), inset 0 0 0 1px rgba(57,255,136,.15); background:#0b0f14}
        .btn:active{transform:translateY(0)}
        .btn.small{padding:4px 8px; font-size:11px; letter-spacing:.09em}
        
        .btn-primary,.btn-secondary{
          background:var(--btn-bg);
          color:var(--btn-text); border-color:transparent; font-weight:600;
        }
        .btn-primary:hover,.btn-secondary:hover{background:var(--btn-bg); filter:brightness(1.05); box-shadow:0 4px 12px var(--btn-shadow)}
        
        .btn-danger{background:#dc3545;color:#fff;border:1px solid #dc3545}
        .btn-danger:hover{background:#c82333;border-color:#bd2130; box-shadow:0 0 0 2px rgba(220,53,69,.25)}
        
        .hidden{display:none}
        
        /* Alerts */
        .alert{padding:12px;border-radius:8px;margin:12px 0;border:1px solid var(--border)}
        .alert-success{background:rgba(139,255,176,.1); color:#b5ffd0; border-color:rgba(139,255,176,.3)}
        .alert-error{background:rgba(255,106,106,.1); color:#ffb3b3; border-color:rgba(255,106,106,.3)}
        
        /* Stats */
        .stats{display:flex;justify-content:space-between;gap:12px;margin:10px 0}
        .stat{text-align:center}
        .stat-value{font-size:22px;font-weight:700;color:var(--accent)}
        .stat-label{font-size:12px;color:var(--muted)}
        
        /* Progress */
        .progress-bar{background:#0e1319;border:1px solid var(--border);border-radius:10px;height:16px;overflow:hidden;margin:10px 0}
        .progress-fill{background:linear-gradient(90deg,var(--accent),var(--accent-2));height:100%;border-radius:10px;transition:width .3s ease}
        
        /* Game grid/cards */
        .game-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:16px}
        .game-card{
          background:#0b1017; border:1px solid #1a2330; color:#e5e7eb;
          border-radius:12px; padding:16px; text-align:center; cursor:pointer; transition:transform .2s ease, border-color .15s ease, box-shadow .15s ease;
        }
        .game-card:hover{transform:translateY(-4px); border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.08)}
        
        /* Tables */
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
        
        /* Links */
        a{color:var(--link)}
        a:hover{color:var(--accent)}
        
        /* Unified Navigation Integration */
        .main-wrapper {
          display: flex;
          flex-direction: column;
          min-height: 100vh;
        }
        
        .portal-content {
          flex: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }
        
        /* When authenticated, adjust layout */
        .authenticated .portal-content {
          align-items: flex-start;
          padding-top: 0;
        }
        
        /* Hide old navigation when unified nav is present */
        .authenticated .header {
          display: none;
        }
        
        .authenticated .nav-tabs {
          display: none;
        }
        
        .authenticated .container {
          margin: 0;
          border-radius: 0;
          border: none;
          box-shadow: none;
          background: transparent;
          max-width: none;
          width: 100%;
        }

        /* Iframe containers - prevent collapse */
        #skill-tree-container {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
       /* In your portal's main CSS file */
        #games-iframe,
        iframe[src*="mathspire"] {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            height: calc(var(--vh, 1vh) * 100) !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            z-index: 1000;
        }
        
        /* Hide other portal UI when game is active */
        .game-active #portal-header,
        .game-active #portal-nav,
        .game-active #portal-sidebar {
            display: none !important;
        }
        
        /* Ensure game container fills screen */
        .game-container,
        #game-frame-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            overflow: hidden !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Fullscreen mode styles */
        .game-fullscreen #game-iframe-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            height: calc(var(--vh, 1vh) * 100) !important;
            z-index: 9999 !important;
            background: #000 !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .game-fullscreen #game-iframe-container > div:first-child {
            display: none !important;
        }

        .game-fullscreen #game-iframe-container > div:last-child {
            width: 100% !important;
            height: 100% !important;
            min-height: 100% !important;
            border: none !important;
            border-radius: 0 !important;
        }

        .game-fullscreen .portal-content,
        .game-fullscreen #unified-nav-container,
        .game-fullscreen .nav-tabs {
            display: none !important;
        }

        /* Floating exit fullscreen button */
        #exit-fullscreen-btn {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10001;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        #exit-fullscreen-btn:hover,
        #exit-fullscreen-btn:active {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .game-fullscreen #exit-fullscreen-btn {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Mobile: make exit button larger and more tappable */
        @media (max-width: 768px) {
            #exit-fullscreen-btn {
                padding: 14px 20px;
                font-size: 16px;
                top: 15px;
                right: 15px;
            }

            /* iOS safe area support */
            .game-fullscreen #exit-fullscreen-btn {
                top: max(15px, env(safe-area-inset-top, 15px));
                right: max(15px, env(safe-area-inset-right, 15px));
            }

            .game-fullscreen #game-iframe-container {
                padding-top: env(safe-area-inset-top, 0);
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }

        /* Ensure iframe fills container in fullscreen */
        .game-fullscreen #game-iframe {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        @media (max-width: 768px) {
            #game-iframe-container > div:last-child {
                height: calc(100vh - 120px) !important;
                min-height: 100% !important;
            }
        }
        
        #skill-tree-container iframe,
        #game-iframe {
            flex: 1;
            min-height: 0; /* Allows flex item to shrink below content size */
        }
        
        /* Animations */
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Unified navigation will be inserted here when authenticated -->
        <div id="unified-nav-container"></div>
        
        <div class="portal-content">
            <div class="container">
                <div class="header">
                    <h1>üéì Student Learning Portal</h1>
                    <p id="welcome-message">Welcome to your learning dashboard</p>
                    <button class="logout-btn hidden" id="logout-btn">Logout</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab" id="dashboard-tab" style="display:none;">Dashboard</button>
                    <button class="nav-tab" id="games-tab" style="display:none;">Games</button>
                    <button class="nav-tab" id="skills-tab" style="display:none;">Skills</button>
                    <button class="nav-tab" id="grades-tab" style="display:none;">Grades</button>
                    <a class="nav-tab" id="portal-tab" href="portal/" style="display:none;">üìö Classes & Messaging</a>
                </div>

                <div class="content">
                    <!-- Login Section -->
                    <div id="login-section" class="hidden">
                        <div class="auth-form">
                            <h2>Student Portal Login</h2>
                            <div id="auth-alerts"></div>
                           <form id="login-form">
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="password">Password</label>
                                    <input type="password" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                                <button type="button" class="btn btn-secondary" id="register-btn">Register New Account</button>
                                <p style="margin-top: 15px; text-align: center;">
                                    <a href="#" id="forgot-password-link" style="color: var(--link);">Forgot Password?</a>
                                    <span style="margin: 0 10px; color: var(--muted);">|</span>
                                    <a href="#" id="activate-account-link" style="color: var(--link);">Activate Account</a>
                                </p>
                            </form>

                            <form id="register-form" class="hidden">
                                <h3>Create New Account</h3>
                                <div class="form-group">
                                    <label for="reg-email">Email Address</label>
                                    <input type="email" id="reg-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-password">Password</label>
                                    <input type="password" id="reg-password" required minlength="8">
                                    <small style="color: var(--muted); font-size: 11px;">Must be at least 8 characters</small>
                                </div>
                                <div class="form-group">
                                    <label for="reg-password-confirm">Confirm Password</label>
                                    <input type="password" id="reg-password-confirm" required minlength="8">
                                    <small id="password-match-status" style="font-size: 11px;"></small>
                                </div>
                                <div class="form-group">
                                    <label for="reg-username">Username</label>
                                    <input type="text" id="reg-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-firstname">First Name</label>
                                    <input type="text" id="reg-firstname" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-lastname">Last Name</label>
                                    <input type="text" id="reg-lastname" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-usertype">Account Type</label>
                                    <select id="reg-usertype" required>
                                        <option value="student">Student</option>
                                        <option value="parent">Parent</option>
                                    </select>
                                </div>
                                <div class="form-group" id="grade-group">
                                    <label for="reg-grade">Grade Level (for students)</label>
                                    <select id="reg-grade">
                                        <option value="">Select Grade</option>
                                        <option value="K">Kindergarten</option>
                                        <option value="1">1st Grade</option>
                                        <option value="2">2nd Grade</option>
                                        <option value="3">3rd Grade</option>
                                        <option value="4">4th Grade</option>
                                        <option value="5">5th Grade</option>
                                        <option value="6">6th Grade</option>
                                        <option value="7">7th Grade</option>
                                        <option value="8">8th Grade</option>
                                        <option value="9">9th Grade</option>
                                        <option value="10">10th Grade</option>
                                        <option value="11">11th Grade</option>
                                        <option value="12">12th Grade</option>
                                    </select>
                                </div>
                                <div class="form-group" id="enrollment-type-group">
                                    <label for="reg-enrollment-type">Enrollment Type</label>
                                    <select id="reg-enrollment-type">
                                        <option value="full-time">Full-Time Student</option>
                                        <option value="homeschool">Homeschool Student</option>
                                    </select>
                                </div>
                                <div class="form-group" id="child-email-group" style="display:none;">
                                    <label for="child-emails">Children's Email Addresses</label>
                                    <textarea id="child-emails" rows="4" placeholder="Enter each child's email address on a separate line:&#10;child1@yourschool.edu&#10;child2@yourschool.edu&#10;child3@yourschool.edu" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 16px; font-family: inherit; resize: vertical; background: #0e1319; color: var(--text);"></textarea>
                                    <small style="color: var(--muted); font-size: 12px;">Enter one email address per line for each child's student account</small>
                                </div>
                                <button type="submit" class="btn btn-primary" id="register-submit-btn">Register</button>
                                <button type="button" class="btn btn-secondary" id="back-to-login-btn">Back to Login</button>
                            </form>
                        </div>
                    </div>

                    <form id="activate-form" class="hidden">
                        <h3>üîì Activate Your Account</h3>
                        <p style="color: var(--muted-color); margin-bottom: 15px;">
                            Enter your information to activate your student account
                        </p>
                        
                        <div class="form-group">
                            <label for="activate-username">Username</label>
                            <input type="text" id="activate-username" required>
                            <small style="color: var(--muted-color);">The username given to you by your teacher</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="activate-email">Email Address</label>
                            <input type="email" id="activate-email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="activate-password">Create Password</label>
                            <input type="password" id="activate-password" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label for="activate-password-confirm">Confirm Password</label>
                            <input type="password" id="activate-password-confirm" required minlength="6">
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="activate-submit-btn">Activate Account</button>
                        <button type="button" class="btn btn-secondary" id="back-to-login-from-activate-btn">Back to Login</button>
                    </form>

                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="hidden">
                        <!-- Content will be populated by JavaScript -->
                    </div>

                    <!-- Games Section -->
                    <div id="games-section" class="hidden">
                        <div id="game-selection">
                            <h2>üéÆ Educational Games</h2>
                            <div class="game-list">
                                <div class="game-card" data-game="math-dojo" style="border: 2px solid #dc2626;">
                                    <div class="game-icon">ü•ã</div>
                                    <h3>Math Dojo</h3>
                                    <p>Train your math skills through placement tests, skill-building lessons, and testing challenges</p>
                                    <div class="game-tags">
                                        <span class="tag">Training Center</span>
                                        <span class="tag">All Levels</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="mathletics">
                                    <h3>üéØ Mathletics</h3>
                                    <p>Master multiplication facts through adaptive practice</p>
                                    <div class="stats">
                                        <div class="stat">
                                            <div class="stat-value" id="mathletics-range">0-2</div>
                                            <div class="stat-label">Current Range</div>
                                        </div>
                                        <div class="stat">
                                            <div class="stat-value" id="mathletics-mastery">Bronze</div>
                                            <div class="stat-label">Mastery Level</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="game-card" data-game="practice-pilot">
                                    <h3>üéØ Practice Pilot </h3>
                                    <p>Destroy enemies while practicing math.</p>
                                    <div class="game-tags">
                                        <span class="tag">Strategy</span>
                                        <span class="tag">Math Practice</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="mathspire">
                                    <div class="game-icon">üè∞</div>
                                    <h3>Mathspire</h3>
                                    <p>Deck-building roguelike adventure through the Tower of Mathematical Mastery</p>
                                    <div class="game-tags">
                                        <span class="tag">Strategy</span>
                                        <span class="tag">Math Practice</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="wasteland-adventure">
                                    <div class="game-icon">üèúÔ∏è</div>
                                    <h3>Wasteland Adventure</h3>
                                    <p>Survive the post-apocalyptic wasteland in this text-based RPG adventure</p>
                                    <div class="game-tags">
                                        <span class="tag">RPG</span>
                                        <span class="tag">Story</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="clockwork-defense">
                                    <div class="game-icon">‚è∞</div>
                                    <h3>Clockwork Defense</h3>
                                    <p>Defend your tower using time-telling skills in this steampunk tower defense</p>
                                    <div class="game-tags">
                                        <span class="tag">Tower Defense</span>
                                        <span class="tag">Time Skills</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="dimension-shift">
                                    <div class="game-icon">üåÄ</div>
                                    <h3>Dimension Shift</h3>
                                    <p>Navigate through a 3D perspective-shifting maze using spatial reasoning</p>
                                    <div class="game-tags">
                                        <span class="tag">Puzzle</span>
                                        <span class="tag">3D Maze</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="teacher-challenge">
                                    <div class="game-icon">üçé</div>
                                    <h3>Teacher Challenge</h3>
                                    <p>A fun arcade-style game for teachers and students alike</p>
                                    <div class="game-tags">
                                        <span class="tag">Arcade</span>
                                        <span class="tag">Fun</span>
                                    </div>
                                </div>
                                <div class="game-card" data-game="riutiz">
                                    <div class="game-icon">üÉè</div>
                                    <h3>RIUTIZ</h3>
                                    <p>Competitive card game with deck building and multiplayer battles</p>
                                    <div class="game-tags">
                                        <span class="tag">Card Game</span>
                                        <span class="tag">Multiplayer</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="game-iframe-container" class="hidden">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                <h3 id="current-game-title"></h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" id="fullscreen-game-btn" title="Enter Fullscreen">‚õ∂ Fullscreen</button>
                                    <button class="btn btn-secondary" id="close-game-btn">‚Üê Back to Games</button>
                                </div>
                            </div>
                            <div style="width: 100%; height: calc(100vh - 200px); min-height: 600px; border: 2px solid var(--border); border-radius: 10px; overflow: hidden; background: #000; position: relative;">
                                <iframe
                                    id="game-iframe"
                                    style="width: 100%; height: 100%; border: none; display: block;"
                                    frameborder="0"
                                    scrolling="auto"
                                    allow="autoplay; fullscreen; accelerometer; gyroscope"
                                    sandbox="allow-same-origin allow-scripts allow-forms allow-pointer-lock allow-modals"
                                    loading="lazy"
                                ></iframe>
                                <!-- Floating exit fullscreen button (visible only in fullscreen mode) -->
                                <button id="exit-fullscreen-btn" aria-label="Exit Fullscreen">‚úï Exit</button>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Section -->
                    <div id="skills-section" class="hidden">
                        <h2>üåü Skill Trees</h2>
                        <div class="subject-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button class="btn btn-primary skill-tree-btn" data-subject="Art" style="margin-bottom: 10px;">
                                üé® Art
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Math" style="margin-bottom: 10px;">
                                üìê Math
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Science" style="margin-bottom: 10px;">
                                üî¨ Science
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Reading" style="margin-bottom: 10px;">
                                üìö Reading
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Programming" style="margin-bottom: 10px;">
                                üíª Programming
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Robotics" style="margin-bottom: 10px;">
                                ü§ñ Robotics
                            </button>
                        </div>
                        <div id="skill-tree-container" style="width: 100%; min-height: 70vh; height: calc(100vh - 300px); border: 2px solid var(--border); border-radius: 10px; overflow: hidden; background: radial-gradient(circle, #0a0a2e 0%, #000000 100%);">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted);">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">üåü</div>
                                    <h3>Select a Subject</h3>
                                    <p>Choose a subject above to explore your skill tree</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grades Section -->
                    <div id="grades-section" class="hidden">
                        <h2>üìä Grades & Assignments</h2>
                        <div id="grades-content">
                            <p>No grades available yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // In your portal's JavaScript
        function setMobileViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setMobileViewportHeight();
        window.addEventListener('resize', setMobileViewportHeight);
        window.addEventListener('orientationchange', setMobileViewportHeight);
        
        // When loading the game iframe
        const gameIframe = document.getElementById('games-iframe');
        if (gameIframe) {
            gameIframe.style.width = '100vw';
            gameIframe.style.height = '100vh';
        }
        
        // ==================== BUTTON COLOR SCHEME ====================
        const BUTTON_COLOR_SCHEMES = {
          ocean:  { bg: 'linear-gradient(135deg, #6aa9ff, #8bffb0)', text: '#0b0f14', shadow: 'rgba(106, 169, 255, 0.3)' },
          sunset: { bg: 'linear-gradient(135deg, #f7971e, #f5576c)', text: '#0b0f14', shadow: 'rgba(247, 151, 30, 0.3)' },
          purple: { bg: 'linear-gradient(135deg, #667eea, #f093fb)', text: '#0b0f14', shadow: 'rgba(102, 126, 234, 0.3)' },
          cyber:  { bg: 'linear-gradient(135deg, #4facfe, #00f2fe)', text: '#0b0f14', shadow: 'rgba(79, 172, 254, 0.3)' },
          slate:  { bg: '#2b3442',                                   text: '#e6edf3', shadow: 'rgba(43, 52, 66, 0.3)' }
        };

        function applyButtonColorScheme(scheme) {
          const s = BUTTON_COLOR_SCHEMES[scheme] || BUTTON_COLOR_SCHEMES.ocean;
          document.documentElement.style.setProperty('--btn-bg', s.bg);
          document.documentElement.style.setProperty('--btn-text', s.text);
          document.documentElement.style.setProperty('--btn-shadow', s.shadow);
        }

        // Enhanced StudentPortal class with unified integration
        class StudentPortal {
            constructor() {
                this.initialized = false;
                this.currentSection = 'dashboard';
                this.eventListeners = new Set();
                this.skillTreeIntegration = null;
                
                // Wait for shared auth to be ready
                this.waitForAuth().then(() => {
                    this.init();
                });
            }

            async waitForAuth() {
                // Wait for portalAuth to be initialized
                while (!window.portalAuth || !window.portalAuth.initialized) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                this.auth = window.portalAuth;
            }

            async init() {
                if (this.initialized) return;
                this.initialized = true;

                console.log('üöÄ Initializing StudentPortal with unified auth...');

                // Check for auth tokens in URL hash
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const type = hashParams.get('type');
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');

                if (type === 'recovery' && accessToken) {
                    console.log('üîë Password recovery detected, redirecting to reset page...');
                    window.location.href = 'reset.html' + window.location.hash;
                    return;
                }

                // Check for teacher password setup (from invite link)
                const urlParams = new URLSearchParams(window.location.search);
                const needsPasswordSetup = urlParams.get('setup_password') === 'true';

                if (needsPasswordSetup && accessToken) {
                    console.log('üë©‚Äçüè´ Teacher password setup detected...');
                    await this.handleTeacherPasswordSetup(accessToken, refreshToken);
                    return;
                }

                // Handle signup/email verification tokens (type=signup or type=magiclink)
                if (accessToken && refreshToken && (type === 'signup' || type === 'magiclink' || !type)) {
                    console.log('üìß Email verification tokens detected, setting session...');
                    try {
                        const { data, error } = await this.auth.supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                        if (error) {
                            console.error('Error setting session from URL:', error);
                        } else {
                            console.log('‚úÖ Session set from URL tokens:', data?.user?.email);
                            // Clear the hash to clean up URL
                            history.replaceState(null, '', window.location.pathname + window.location.search);
                        }
                    } catch (err) {
                        console.error('Failed to set session from URL:', err);
                    }
                }

                // Set up skill tree integration
                this.skillTreeIntegration = new SkillTreeIntegration(this);
                await this.skillTreeIntegration.initialize();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Listen for auth state changes
                window.addEventListener('portalAuthChange', (e) => {
                    this.handleAuthStateChange(e.detail);
                });
                
                // Check initial auth state
                if (this.auth.isAuthenticated()) {
                    this.showAuthenticatedState();
                } else {
                    this.showLoginForm();
                }
                
                // Handle hash navigation
                this.handleHashNavigation();
                window.addEventListener('hashchange', () => this.handleHashNavigation());

                // Handle messages from game iframes
                window.addEventListener('message', (event) => {
                    if (event.data.action === 'closeGame') {
                        this.closeGame();
                    } else if (event.data.action === 'exitFullscreen') {
                        this.exitGameFullscreen();
                    } else if (event.data.action === 'enterFullscreen') {
                        this.enterGameFullscreen();
                    } else if (event.data.action === 'progressUpdated') {
                        // Refresh Mathletics progress display
                        setTimeout(() => this.updateMathleticsProgress(), 1000);
                    }
                });
                
                console.log('‚úÖ StudentPortal initialized');
            }

            handleAuthStateChange(detail) {
                if (detail.event === 'SIGNED_IN') {
                    this.showAuthenticatedState();
                    window.PortalUI.showNotification(`Welcome back, ${detail.profile?.first_name || 'User'}!`, 'success');
                } else if (detail.event === 'SIGNED_OUT') {
                    this.showLoginForm();
                    document.body.classList.remove('authenticated');
                }
            }

            showAuthenticatedState() {
                document.body.classList.add('authenticated');

                const userInfo = this.auth.getUserInfo();

                // Check if user has a profile
                if (!userInfo.hasProfile) {
                    // Show a message that they need to complete registration
                    const container = document.querySelector('.content');
                    if (container) {
                        container.innerHTML = `
                            <div class="card" style="max-width: 500px; margin: 50px auto; text-align: center;">
                                <h2>‚ö†Ô∏è Profile Incomplete</h2>
                                <p>Your account exists but your profile is missing.</p>
                                <p>This can happen if registration wasn't completed properly.</p>
                                <br>
                                <p>Please contact support or try logging out and registering again.</p>
                                <br>
                                <button class="btn btn-primary" onclick="window.portalAuth.logout()">
                                    Logout and Try Again
                                </button>
                            </div>
                        `;
                    }
                    return;
                }

                // Apply button color scheme from profile
                applyButtonColorScheme(userInfo.profile?.button_color_scheme || 'ocean');

                // Check for pending child links
                const pendingLinks = localStorage.getItem('pending_child_links');
                console.log('Pending links found:', pendingLinks);
                console.log('User type:', userInfo.profile?.user_type);

                if (pendingLinks && userInfo.profile?.user_type === 'parent') {
                    const childEmails = JSON.parse(pendingLinks);
                    console.log('Processing child links for:', childEmails);

                    // Add delay to ensure auth is fully ready
                    setTimeout(async () => {
                        try {
                            const results = await this.linkParentToChildren(userInfo.profile.id, childEmails);
                            console.log('Link results:', results);
                            localStorage.removeItem('pending_child_links');

                            // Show detailed results to user
                            const successCount = results.filter(r => r.success).length;
                            const failedEmails = results.filter(r => !r.success).map(r => r.email);
                            const notFoundEmails = childEmails.filter(email =>
                                !results.some(r => r.email === email)
                            );

                            if (successCount > 0) {
                                window.PortalUI?.showNotification(
                                    `Successfully linked ${successCount} child account${successCount > 1 ? 's' : ''}!`,
                                    'success'
                                );
                            }

                            if (notFoundEmails.length > 0 || failedEmails.length > 0) {
                                const allFailed = [...notFoundEmails, ...failedEmails];
                                setTimeout(() => {
                                    this.showChildLinkResultsModal(results, notFoundEmails);
                                }, 1500);
                            }

                            // Reload dashboard to show linked children
                            if (successCount > 0) {
                                await this.loadParentTeacherDashboard();
                            }
                        } catch (error) {
                            console.error('Failed to link children:', error);
                            window.PortalUI?.showNotification('Error linking child accounts. Please try again from the dashboard.', 'error');
                        }
                    }, 1000);
                }
                
                // Show unified navigation
                const navContainer = document.getElementById('unified-nav-container');
                if (navContainer) {
                    navContainer.innerHTML = window.PortalUI.createUnifiedNavigation('main', this.currentSection);
                }
                
                // Hide login elements
                const loginSection = document.getElementById('login-section');
                if (loginSection) loginSection.classList.add('hidden');
                
                // Show appropriate dashboard
                if (userInfo.profile?.user_type === 'parent' || userInfo.profile?.user_type === 'teacher' || userInfo.profile?.user_type === 'admin') {
                    this.loadParentTeacherDashboard();
                } else {
                    this.loadStudentDashboard();
                    setTimeout(() => this.updateMathleticsProgress(), 500);  // Update Mathletics progress
                }
                
                this.showTab('dashboard');
            }

            showLoginForm() {
                document.body.classList.remove('authenticated');
                
                // Hide unified navigation
                const navContainer = document.getElementById('unified-nav-container');
                if (navContainer) navContainer.innerHTML = '';
                
                // Show login
                this.showTab('login');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const activateForm = document.getElementById('activate-form');
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
                if (activateForm) activateForm.classList.add('hidden');
            }

            handleHashNavigation() {
                const hash = window.location.hash.substring(1);
                const validSections = ['dashboard', 'games', 'skills', 'grades'];
                
                if (hash && validSections.includes(hash)) {
                    if (this.auth.isAuthenticated()) {
                        this.showTab(hash);
                    } else {
                        this.showTab('login');
                    }
                } else if (this.auth.isAuthenticated()) {
                    this.showTab('dashboard');
                }
            }

            setupEventListeners() {
                // Auth forms
                this.addSafeEventListener('login-form', 'submit', (e) => this.handleLogin(e));
                this.addSafeEventListener('register-form', 'submit', (e) => this.handleRegister(e));
                
                // Auth navigation
                this.addSafeEventListener('register-btn', 'click', () => this.showRegisterForm());
                this.addSafeEventListener('back-to-login-btn', 'click', () => this.showLoginForm());
                this.addSafeEventListener('forgot-password-link', 'click', (e) => {
                    e.preventDefault();
                    this.showForgotPasswordForm();
                });
                
                // User type handling
                this.addSafeEventListener('reg-usertype', 'change', (e) => this.handleUserTypeChange(e));

                // Password confirmation matching
                this.addSafeEventListener('reg-password', 'input', () => this.checkPasswordMatch());
                this.addSafeEventListener('reg-password-confirm', 'input', () => this.checkPasswordMatch());

                // Legacy tab navigation (for when not authenticated)
                this.addSafeEventListener('login-tab', 'click', () => this.showTab('login'));
                this.addSafeEventListener('dashboard-tab', 'click', () => this.showTab('dashboard'));
                this.addSafeEventListener('games-tab', 'click', () => this.showTab('games'));
                this.addSafeEventListener('skills-tab', 'click', () => this.showTab('skills'));
                this.addSafeEventListener('grades-tab', 'click', () => this.showTab('grades'));
                
                // Game and skill interactions
                this.addGameCardListeners();
                this.addSkillTreeListeners();
                this.addSafeEventListener('close-game-btn', 'click', () => this.closeGame());

                // Fullscreen controls
                this.addSafeEventListener('fullscreen-game-btn', 'click', () => this.toggleGameFullscreen());
                this.addSafeEventListener('exit-fullscreen-btn', 'click', () => this.exitGameFullscreen());

                // Listen for fullscreen change events
                document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());
                document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange());

                // Activate account link
                const activateLink = document.getElementById('activate-account-link');
                if (activateLink) {
                    activateLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showActivateForm();
                    });
                }
                
                // Back to login from activate
                const backToLoginFromActivate = document.getElementById('back-to-login-from-activate-btn');
                if (backToLoginFromActivate) {
                    backToLoginFromActivate.addEventListener('click', () => {
                        this.showLoginForm();
                    });
                }
                
                // Activate form submission
                const activateForm = document.getElementById('activate-form');
                if (activateForm) {
                    activateForm.addEventListener('submit', (e) => {
                        this.handleActivate(e);
                    });
                }

                // Legacy logout
                this.addSafeEventListener('logout-btn', 'click', () => this.auth.logout());
            }

            addSafeEventListener(elementId, event, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    const listenerKey = `${elementId}-${event}`;
                    if (this.eventListeners.has(listenerKey)) {
                        element.removeEventListener(event, handler);
                    }
                    element.addEventListener(event, handler);
                    this.eventListeners.add(listenerKey);
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const email = document.getElementById('email')?.value;
                const password = document.getElementById('password')?.value;
                const loginBtn = document.getElementById('login-btn');

                if (!email || !password) {
                    window.PortalUI.showNotification('Please enter email and password', 'error');
                    return;
                }

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Logging in...';
                }

                try {
                    const { data, error } = await this.auth.supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    // Load the profile to check can_login and account_status
                    await this.auth.loadUserProfile();
                    const userInfo = this.auth.getUserInfo();

                    if (userInfo.profile && !userInfo.profile.can_login) {
                        // Account exists but can't login - sign them out
                        await this.auth.supabase.auth.signOut();
                        throw new Error('This account is not activated yet. Please use the "Activate Account" option.');
                    }

                    if (userInfo.profile && userInfo.profile.account_status === 'inactive') {
                        // Account has been deactivated - sign them out
                        await this.auth.supabase.auth.signOut();
                        throw new Error('This account has been deactivated. Please contact an administrator.');
                    }

                    // Success is handled by auth state change listener
                } catch (error) {
                    console.error('Login error:', error);
                    window.PortalUI.showNotification(error.message, 'error');

                    // Track failed login attempts for security
                    this.trackFailedLogin(email, error.message);
                } finally {
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login';
                    }
                }
            }

            async handleRegister(e) {
                e.preventDefault();

                const email = document.getElementById('reg-email')?.value;
                const password = document.getElementById('reg-password')?.value;
                const passwordConfirm = document.getElementById('reg-password-confirm')?.value;
                const username = document.getElementById('reg-username')?.value;
                const firstName = document.getElementById('reg-firstname')?.value;
                const lastName = document.getElementById('reg-lastname')?.value;
                const grade = document.getElementById('reg-grade')?.value;
                const userType = document.getElementById('reg-usertype')?.value;
                const enrollmentType = document.getElementById('reg-enrollment-type')?.value;
                const childEmailsTextarea = document.getElementById('child-emails');

                const registerBtn = document.getElementById('register-submit-btn');

                if (!email || !password || !passwordConfirm || !username || !firstName || !lastName || !userType) {
                    window.PortalUI.showNotification('Please fill in all required fields', 'error');
                    return;
                }

                if (password !== passwordConfirm) {
                    window.PortalUI.showNotification('Passwords do not match', 'error');
                    return;
                }

                if (password.length < 8) {
                    window.PortalUI.showNotification('Password must be at least 8 characters', 'error');
                    return;
                }
            
                if (registerBtn) {
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'Registering...';
                }
            
                try {
                    // First, try to sign up with Supabase Auth
                    const { data: authData, error: authError } = await this.auth.supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            emailRedirectTo: `${window.location.origin}/student-portal/confirm.html`
                        }
                    });
            
                    // Handle auth errors
                    if (authError) {
                        if (authError.message.includes('already registered')) {
                            throw new Error('This email is already registered. Please login or reset your password.');
                        }
                        throw authError;
                    }
            
                    // Check if signup actually created a new user or returned existing
                    if (!authData.user) {
                        throw new Error('Registration failed. Please try again.');
                    }
            
                    // If user.identities is empty, user already existed
                    if (authData.user.identities && authData.user.identities.length === 0) {
                        throw new Error('An account with this email already exists. Please login instead.');
                    }
            
                    // Create user profile using the secure signup function
                    // This bypasses RLS since auth.uid() is NULL during signup
                    const { data: profileResult, error: profileError } = await this.auth.supabase
                        .rpc('create_signup_profile', {
                            user_id: authData.user.id,
                            user_email: email,
                            user_username: username,
                            user_first_name: firstName,
                            user_last_name: lastName,
                            user_type: userType,
                            user_grade_level: userType === 'student' ? grade : null,
                            user_enrollment_type: userType === 'student' ? enrollmentType : null
                        });

                    if (profileError) {
                        console.error('Profile creation RPC error:', profileError);
                        throw new Error(`Profile creation failed: ${profileError.message}`);
                    }

                    if (profileResult && profileResult.error) {
                        console.error('Profile creation failed:', profileResult.error);
                        throw new Error(profileResult.error);
                    }
            
                    // If parent, handle child relationships
                    // In handleRegister, replace the parent linking section with:
                    if (userType === 'parent' && childEmailsTextarea) {
                        const childEmails = childEmailsTextarea.value
                            .split('\n')
                            .map(email => email.trim())
                            .filter(email => email.length > 0);
                    
                        if (childEmails.length > 0) {
                            console.log('Storing child emails for later:', childEmails);
                            localStorage.setItem('pending_child_links', JSON.stringify(childEmails));
                        }
                    }
            
                    // Notify admins of new registration (don't block)
                    this.notifyAdminsOfNewUser(authData.user.id, firstName, lastName, email, userType).catch(err => {
                        console.error('Failed to notify admins:', err);
                    });

                    window.PortalUI.showNotification('Registration successful! Please check your email to verify your account.', 'success');
                    this.showLoginForm();
            
                } catch (error) {
                    console.error('Registration error:', error);
                    const errorMessage = error.message || 'Registration failed. Please try again.';
                    window.PortalUI.showNotification(errorMessage, 'error');
                } finally {
                    if (registerBtn) {
                        registerBtn.disabled = false;
                        registerBtn.textContent = 'Register';
                    }
                }
            }

            async linkParentToChildren(parentId, childEmails) {
                const results = [];

                for (const childEmail of childEmails) {
                    try {
                        // First find the child's user ID
                        const { data: childProfile, error: childError } = await this.auth.supabase
                            .from('user_profiles')
                            .select('id, first_name, last_name, user_type')
                            .eq('email', childEmail)
                            .single();

                        if (childError || !childProfile) {
                            console.warn(`Child account not found for email: ${childEmail}`);
                            results.push({ email: childEmail, success: false, reason: 'not_found' });
                            continue;
                        }

                        // Verify it's a student account
                        if (childProfile.user_type !== 'student') {
                            console.warn(`Account ${childEmail} is not a student account`);
                            results.push({ email: childEmail, success: false, reason: 'not_student' });
                            continue;
                        }

                        // Use UPSERT with the correct table name
                        const { data, error } = await this.auth.supabase
                            .from('parent_child_links')
                            .upsert({
                                parent_id: parentId,
                                child_id: childProfile.id,
                                created_at: new Date().toISOString()
                            }, {
                                onConflict: 'parent_id,child_id',
                                ignoreDuplicates: false
                            });

                        if (error) {
                            console.error(`Error linking to child ${childEmail}:`, error);
                            results.push({ email: childEmail, success: false, reason: 'link_error', error: error.message });
                        } else {
                            results.push({
                                email: childEmail,
                                success: true,
                                childName: `${childProfile.first_name} ${childProfile.last_name}`
                            });
                        }

                    } catch (error) {
                        console.error(`Failed to link parent to child ${childEmail}:`, error);
                        results.push({ email: childEmail, success: false, reason: 'error', error: error.message });
                    }
                }

                const successCount = results.filter(r => r.success).length;
                if (successCount > 0) {
                    console.log(`Successfully linked to ${successCount} child account(s)`);
                }

                return results;
            }

            async notifyAdminsOfNewUser(userId, firstName, lastName, email, userType) {
                try {
                    // Get all admins with notification preferences
                    const { data: admins } = await this.auth.supabase
                        .from('user_profiles')
                        .select('id, first_name, email, email_notifications')
                        .eq('user_type', 'admin');

                    if (!admins || admins.length === 0) return;

                    const userName = `${firstName} ${lastName}`;
                    const userTypeLabel = userType.charAt(0).toUpperCase() + userType.slice(1);

                    // Notify each admin
                    for (const admin of admins) {
                        const emailPrefs = admin.email_notifications || {};
                        // Default to true if no preference set
                        if (emailPrefs.new_user_registration === false) continue;

                        // Create in-app notification for admin
                        await this.auth.supabase
                            .from('notifications')
                            .insert({
                                user_id: admin.id,
                                type: 'new_user_registration',
                                title: 'New User Registration',
                                message: `${userName} registered as a ${userTypeLabel} (${email})`,
                                metadata: { userId, userName, email, userType }
                            });

                        // Send email to admin
                        if (admin.email) {
                            await this.auth.supabase.functions.invoke('send-notification-email', {
                                body: {
                                    to: admin.email,
                                    type: 'new_user_registration',
                                    data: {
                                        adminName: admin.first_name,
                                        userName: userName,
                                        userEmail: email,
                                        userType: userTypeLabel
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error sending new user registration notification:', error);
                }
            }

            showChildLinkResultsModal(results, notFoundEmails) {
                const successResults = results.filter(r => r.success);
                const failedResults = results.filter(r => !r.success);

                let content = '<div style="padding: 10px;">';

                // Show successful links
                if (successResults.length > 0) {
                    content += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--accent-2); margin-bottom: 10px;">Successfully Linked</h4>
                            ${successResults.map(r => `
                                <div style="padding: 8px; background: rgba(139, 255, 176, 0.1); border-radius: 6px; margin-bottom: 5px;">
                                    ${r.childName || r.email}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Show failed/not found
                if (notFoundEmails.length > 0 || failedResults.length > 0) {
                    content += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--warning); margin-bottom: 10px;">Could Not Link</h4>
                            <p style="color: var(--muted); font-size: 13px; margin-bottom: 10px;">
                                These accounts could not be linked. The child may need to register first.
                            </p>
                            ${notFoundEmails.map(email => `
                                <div style="padding: 8px; background: rgba(255, 211, 106, 0.1); border-radius: 6px; margin-bottom: 5px;">
                                    <strong>${email}</strong>
                                    <span style="color: var(--muted); font-size: 12px;"> - Account not found</span>
                                </div>
                            `).join('')}
                            ${failedResults.map(r => `
                                <div style="padding: 8px; background: rgba(255, 211, 106, 0.1); border-radius: 6px; margin-bottom: 5px;">
                                    <strong>${r.email}</strong>
                                    <span style="color: var(--muted); font-size: 12px;"> - ${
                                        r.reason === 'not_student' ? 'Not a student account' :
                                        r.reason === 'link_error' ? 'Link failed' : 'Error occurred'
                                    }</span>
                                </div>
                            `).join('')}
                            <p style="color: var(--muted); font-size: 12px; margin-top: 10px;">
                                You can link children later from your dashboard using the "Link Another Child" button.
                            </p>
                        </div>
                    `;
                }

                content += `
                    <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                        <button class="btn btn-primary" onclick="portal.closeModal()">Got it</button>
                    </div>
                </div>`;

                this.showModal('child-link-results', 'Child Account Linking Results', content);
            }

            async handlePasswordReset(e) {
                e.preventDefault();
                
                const emailInput = document.getElementById('forgot-email');
                const resetBtn = document.getElementById('send-reset-btn');
                const form = document.getElementById('forgot-password-form');
                const successMessage = document.getElementById('reset-success-message');
                
                if (!emailInput || !resetBtn) return;
                
                const email = emailInput.value.trim();
                
                if (!email) {
                    window.PortalUI?.showNotification('Please enter your email address', 'error') || 
                    alert('Please enter your email address');
                    return;
                }
            
                // Disable button and show loading state
                resetBtn.disabled = true;
                resetBtn.textContent = 'Sending...';
            
                try {
                    // Use Supabase's built-in password reset
                    const { error } = await this.auth.supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: `${window.location.href.split('/').slice(0, -1).join('/')}/reset.html`
                    });
            
                    if (error) {
                        throw error;
                    }
            
                    // Show success message
                    if (form) form.classList.add('hidden');
                    if (successMessage) successMessage.classList.remove('hidden');
            
                    // Also show a notification
                    window.PortalUI?.showNotification('Password reset email sent! Check your inbox.', 'success') ||
                    alert('Password reset email sent! Check your inbox.');
            
                } catch (error) {
                    console.error('Password reset error:', error);
                    
                    let errorMessage = 'Failed to send reset email. ';
                    
                    if (error.message.includes('User not found')) {
                        errorMessage += 'No account found with this email address.';
                    } else if (error.message.includes('Email rate limit')) {
                        errorMessage += 'Too many requests. Please wait before trying again.';
                    } else {
                        errorMessage += error.message;
                    }
            
                    window.PortalUI?.showNotification(errorMessage, 'error') || 
                    alert(errorMessage);
            
                } finally {
                    // Re-enable button
                    if (resetBtn) {
                        resetBtn.disabled = false;
                        resetBtn.textContent = 'Send Reset Link';
                    }
                }
            }
            
            closeForgotPasswordModal() {
                this.closeModal();
            }

            async handleTeacherPasswordSetup(accessToken, refreshToken) {
                // Set up the session with the tokens from the URL
                try {
                    const { data, error } = await this.auth.supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });

                    if (error) {
                        console.error('Session setup error:', error);
                        window.PortalUI?.showNotification('Invalid or expired invitation link. Please contact an administrator.', 'error');
                        this.showLoginForm();
                        return;
                    }

                    const user = data?.user;
                    const firstName = user?.user_metadata?.first_name || 'Teacher';

                    // Show password setup modal
                    this.showTeacherPasswordSetupModal(firstName);

                } catch (err) {
                    console.error('Teacher password setup error:', err);
                    window.PortalUI?.showNotification('Error setting up account. Please try again.', 'error');
                    this.showLoginForm();
                }
            }

            showTeacherPasswordSetupModal(firstName) {
                const modalContent = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="margin-bottom: 10px;">Welcome, ${firstName}!</h3>
                        <p style="margin-bottom: 20px; color: var(--muted);">
                            Your account has been created. Please set a password to complete your registration.
                        </p>

                        <form id="teacher-password-setup-form">
                            <div class="form-group" style="text-align: left; margin-bottom: 15px;">
                                <label for="setup-password">Password</label>
                                <input type="password" id="setup-password" required minlength="6"
                                       placeholder="Enter your password (min 6 characters)"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text);">
                            </div>
                            <div class="form-group" style="text-align: left; margin-bottom: 20px;">
                                <label for="setup-password-confirm">Confirm Password</label>
                                <input type="password" id="setup-password-confirm" required minlength="6"
                                       placeholder="Confirm your password"
                                       style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text);">
                            </div>

                            <button type="submit" class="btn btn-primary" id="setup-password-btn" style="width: 100%;">
                                Set Password & Continue
                            </button>
                        </form>
                    </div>
                `;

                this.showModal('teacher-password-setup', 'Complete Your Registration', modalContent);

                // Add form handler after modal is rendered
                setTimeout(() => {
                    const form = document.getElementById('teacher-password-setup-form');
                    if (form) {
                        form.addEventListener('submit', (e) => this.submitTeacherPassword(e));
                    }
                }, 100);
            }

            async submitTeacherPassword(e) {
                e.preventDefault();

                const password = document.getElementById('setup-password')?.value;
                const confirmPassword = document.getElementById('setup-password-confirm')?.value;
                const submitBtn = document.getElementById('setup-password-btn');

                if (!password || !confirmPassword) return;

                if (password !== confirmPassword) {
                    window.PortalUI?.showNotification('Passwords do not match', 'error');
                    return;
                }

                if (password.length < 6) {
                    window.PortalUI?.showNotification('Password must be at least 6 characters', 'error');
                    return;
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Setting up...';
                }

                try {
                    // Update the user's password
                    const { error } = await this.auth.supabase.auth.updateUser({
                        password: password
                    });

                    if (error) throw error;

                    // Clear the needs_password_setup flag from user metadata
                    await this.auth.supabase.auth.updateUser({
                        data: { needs_password_setup: false }
                    });

                    // Close modal and clean up URL
                    this.closeModal();

                    // Remove setup_password param and hash from URL
                    const url = new URL(window.location);
                    url.searchParams.delete('setup_password');
                    url.hash = '';
                    window.history.replaceState({}, '', url);

                    window.PortalUI?.showNotification('Password set successfully! Welcome to the portal.', 'success');

                    // Redirect to the portal
                    setTimeout(() => {
                        window.location.href = 'portal/index.html';
                    }, 1500);

                } catch (err) {
                    console.error('Password setup error:', err);
                    window.PortalUI?.showNotification('Error setting password: ' + err.message, 'error');

                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Set Password & Continue';
                    }
                }
            }

            showActivateForm() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('activate-form').classList.remove('hidden');
                
                // Clear any alerts
                const alerts = document.getElementById('auth-alerts');
                if (alerts) alerts.innerHTML = '';
            }
            
            async handleActivate(e) {
                e.preventDefault();
                
                const username = document.getElementById('activate-username')?.value;
                const email = document.getElementById('activate-email')?.value;
                const password = document.getElementById('activate-password')?.value;
                const passwordConfirm = document.getElementById('activate-password-confirm')?.value;
                
                const activateBtn = document.getElementById('activate-submit-btn');
                const alerts = document.getElementById('auth-alerts');
                
                // Clear previous alerts
                if (alerts) alerts.innerHTML = '';
                
                // Validate passwords match
                if (password !== passwordConfirm) {
                    if (alerts) {
                        alerts.innerHTML = '<div class="alert alert-error">Passwords do not match</div>';
                    }
                    return;
                }
                
                if (!username || !email || !password) {
                    if (alerts) {
                        alerts.innerHTML = '<div class="alert alert-error">Please fill in all fields</div>';
                    }
                    return;
                }
                
                if (activateBtn) {
                    activateBtn.disabled = true;
                    activateBtn.textContent = 'Activating...';
                }
                
                try {
                    // Step 1: Find the inactive student profile by username
                    const { data: profile, error: findError } = await this.auth.supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('username', username)
                        .eq('account_status', 'inactive')
                        .eq('user_type', 'student')
                        .single();
                    
                    if (findError || !profile) {
                        throw new Error('No inactive account found with that username. Please check with your teacher.');
                    }
                    
                    // Step 2: Check if student is eligible for activation
                    // (You can add grade level checks here if needed)
                    
                    // Step 3: Create auth user
                    const { data: authData, error: authError } = await this.auth.supabase.auth.signUp({
                        email: email,
                        password: password
                    });
                    
                    if (authError) throw authError;
                    
                    if (!authData.user) {
                        throw new Error('Failed to create authentication account');
                    }
                    
                    // Step 4: Update the profile to link to auth user and activate
                    const { error: updateError } = await this.auth.supabase
                        .from('user_profiles')
                        .update({
                            auth_user_id: authData.user.id,
                            email: email,
                            account_status: 'active',
                            can_login: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('username', username)
                        .eq('account_status', 'inactive');
                    
                    if (updateError) {
                        console.error('Profile update error:', updateError);
                        // Try to clean up the auth user
                        try {
                            await this.auth.supabase.auth.admin.deleteUser(authData.user.id);
                        } catch (cleanupError) {
                            console.error('Cleanup error:', cleanupError);
                        }
                        throw new Error('Failed to activate account. Please contact your teacher.');
                    }
                    
                    // Success!
                    if (alerts) {
                        alerts.innerHTML = '<div class="alert alert-success">Account activated! Please check your email to verify, then you can login.</div>';
                    }
                    
                    // Clear form
                    document.getElementById('activate-form').reset();
                    
                    // Show login form after 3 seconds
                    setTimeout(() => {
                        this.showLoginForm();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Activation error:', error);
                    if (alerts) {
                        alerts.innerHTML = `<div class="alert alert-error">${error.message || 'Activation failed. Please try again.'}</div>`;
                    }
                } finally {
                    if (activateBtn) {
                        activateBtn.disabled = false;
                        activateBtn.textContent = 'Activate Account';
                    }
                }
            }
            
            showModal(id, title, content) {
                // Remove existing modal
                const existingModal = document.getElementById('portal-modal');
                if (existingModal) existingModal.remove();
            
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'portal-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
            
                modal.innerHTML = `
                    <div style="
                        background: var(--card);
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        padding: 20px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <h3 style="margin-bottom: 20px; color: var(--text);">${title}</h3>
                        ${content}
                    </div>
                `;
            
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal();
                    }
                });
            
                document.body.appendChild(modal);
            }
            
            closeModal() {
                const modal = document.getElementById('portal-modal');
                if (modal) modal.remove();
            }

            handleUserTypeChange(e) {
                const userType = e.target.value;
                const isStudent = userType === 'student';
                const isParent = userType === 'parent';

                const gradeGroup = document.getElementById('grade-group');
                const enrollmentTypeGroup = document.getElementById('enrollment-type-group');
                const childEmailGroup = document.getElementById('child-email-group');

                if (gradeGroup) gradeGroup.style.display = isStudent ? 'block' : 'none';
                if (enrollmentTypeGroup) enrollmentTypeGroup.style.display = isStudent ? 'block' : 'none';
                if (childEmailGroup) childEmailGroup.style.display = isParent ? 'block' : 'none';
            }

            checkPasswordMatch() {
                const password = document.getElementById('reg-password')?.value || '';
                const confirmPassword = document.getElementById('reg-password-confirm')?.value || '';
                const statusEl = document.getElementById('password-match-status');
                const registerBtn = document.getElementById('register-submit-btn');

                if (!statusEl) return;

                if (!confirmPassword) {
                    statusEl.textContent = '';
                    statusEl.style.color = '';
                    return;
                }

                if (password === confirmPassword) {
                    statusEl.textContent = 'Passwords match';
                    statusEl.style.color = 'var(--accent-2, #8bffb0)';
                } else {
                    statusEl.textContent = 'Passwords do not match';
                    statusEl.style.color = 'var(--danger)';
                }
            }

            showRegisterForm() {
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
            }

            showForgotPasswordForm() {
                const modalContent = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="margin-bottom: 20px;">Reset Password</h3>
                        <p style="margin-bottom: 20px; color: var(--muted);">
                            Enter your email address and we'll send you a link to reset your password.
                        </p>
                        
                        <form id="forgot-password-form">
                            <div class="form-group" style="text-align: left;">
                                <label for="forgot-email">Email Address</label>
                                <input type="email" id="forgot-email" required placeholder="Enter your email address">
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="portal.closeForgotPasswordModal()">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" id="send-reset-btn">
                                    Send Reset Link
                                </button>
                            </div>
                        </form>
                        
                        <div id="reset-success-message" class="hidden" style="margin-top: 20px; padding: 15px; background: rgba(139, 255, 176, 0.1); border: 1px solid rgba(139, 255, 176, 0.25); border-radius: 8px; color: #b5ffd0;">
                            <h4>Reset Link Sent!</h4>
                            <p>Check your email for a password reset link. The link will expire in 1 hour.</p>
                            <button class="btn btn-secondary" onclick="portal.closeForgotPasswordModal()" style="margin-top: 10px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            
                // Create modal (using the existing modal system)
                this.showModal('forgot-password', 'Reset Password', modalContent);
            
                // Add form submission handler
                setTimeout(() => {
                    const form = document.getElementById('forgot-password-form');
                    if (form) {
                        form.addEventListener('submit', (e) => this.handlePasswordReset(e));
                    }
                }, 100);
            }

            showTab(tabName) {
                this.currentSection = tabName;
                
                // Update unified navigation if present
                const navContainer = document.getElementById('unified-nav-container');
                if (navContainer && this.auth.isAuthenticated()) {
                    navContainer.innerHTML = window.PortalUI.createUnifiedNavigation('main', tabName);
                }
                
                // Hide all sections
                document.querySelectorAll('[id$="-section"]').forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                
                // Show requested section
                const section = document.getElementById(tabName + '-section');
                if (section) {
                    section.classList.remove('hidden');
                }
                
                // Update URL hash
                if (tabName !== 'login') {
                    window.location.hash = tabName;
                } else {
                    window.history.replaceState(null, null, window.location.pathname);
                }
                
                // Special handling
                if (tabName === 'skills') {
                    this.showSkillsTab();
                } else if (tabName === 'games') {
                    // Refresh game cards when navigating to games
                    setTimeout(() => this.addGameCardListeners(), 100);
                }
            }

            loadStudentDashboard() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const userInfo = this.auth.getUserInfo();
                const firstName = userInfo.profile?.first_name || 'Student';
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, ${firstName}!</h2>
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>üéØ Quick Access</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; max-width: 600px;">
                                <button class="btn btn-primary" onclick="portal.showTab('games')" style="width: 100%;">
                                    üéÆ Play Games
                                </button>
                                <button class="btn btn-primary" onclick="portal.showTab('skills')" style="width: 100%;">
                                    üåü View Skills
                                </button>
                                <button class="btn btn-secondary" onclick="window.portalAuth.goToClassesPortal()" style="width: 100%;">
                                    üìö Go to Classes
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard">
                            <div class="card">
                                <h3>üìä Progress Overview</h3>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value" id="skills-unlocked">0</div>
                                        <div class="stat-label">Skills Unlocked</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value" id="active-classes-count">...</div>
                                        <div class="stat-label">Active Classes</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <h3>üéØ Recent Activity</h3>
                                <p>No recent activity</p>
                                <button class="btn btn-secondary" onclick="window.portalAuth.goToClassesPortal('messaging')" style="margin-top: 10px;">
                                    üí¨ Check Messages
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                 this.loadStudentStats();
            }

            async loadStudentStats() {
                try {
                    const userId = this.auth.getUserInfo().profile.id;
                    
                    // Get actual class count from database
                    const { data: enrollments, error } = await this.auth.supabase
                        .from('class_enrollments')
                        .select('class_id', { count: 'exact' })
                        .eq('student_id', userId)
                        .eq('status', 'active');
                    
                    const classCount = enrollments?.length || 0;
                    
                    // Update the UI
                    const classCountEl = document.getElementById('active-classes-count');
                    if (classCountEl) {
                        classCountEl.textContent = classCount;
                    }
                    
                } catch (error) {
                    console.error('Error loading student stats:', error);
                    const classCountEl = document.getElementById('active-classes-count');
                    if (classCountEl) {
                        classCountEl.textContent = '0';
                    }
                }
            }

            async loadParentTeacherDashboard() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const userInfo = this.auth.getUserInfo();
                const firstName = userInfo.profile?.first_name || 'User';
                const userType = userInfo.profile?.user_type || 'user';
                
                if (userType === 'parent') {
                    await this.loadParentDashboard(dashboardSection, userInfo, firstName);
                } else if (userType === 'teacher') {
                    await this.loadTeacherDashboard(dashboardSection, userInfo, firstName);
                }
            }
            
            async loadParentDashboard(dashboardSection, userInfo, firstName) {
                try {
                    console.log('Loading parent dashboard for:', userInfo.profile.id);
                    
                    // Step 1: Get child IDs (simple query, no joins)
                    const { data: links, error: linkError } = await this.auth.supabase
                        .from('parent_child_links')
                        .select('child_id')
                        .eq('parent_id', userInfo.profile.id);
                    
                    console.log('Parent links found:', links);
                    
                    if (linkError) {
                        console.error('Error fetching links:', linkError);
                        throw linkError;
                    }
                    
                    if (!links || links.length === 0) {
                        dashboardSection.innerHTML = `
                            <h2>Welcome, ${firstName}</h2>
                            <div class="card" style="max-width: 600px; margin: 50px auto; text-align: center;">
                                <h3>üë∂ No Children Linked</h3>
                                <p>No children are linked to your account yet.</p>
                                <button class="btn btn-primary" onclick="portal.showLinkChildModal()" style="margin-top: 15px;">
                                    ‚ûï Link a Child
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    // Step 2: Get child profiles separately
                    const childIds = links.map(l => l.child_id);
                    console.log('Looking for child profiles with IDs:', childIds);
                    
                    const { data: childProfiles, error: profileError } = await this.auth.supabase
                        .from('user_profiles')
                        .select('id, first_name, last_name, email, grade_level')
                        .in('id', childIds);
                    
                    console.log('Child profiles found:', childProfiles);
                    
                    if (!childProfiles || childProfiles.length === 0) {
                        dashboardSection.innerHTML = `
                            <h2>Welcome, ${firstName}</h2>
                            <div class="card" style="max-width: 600px; margin: 50px auto; text-align: center;">
                                <h3>‚ö†Ô∏è Child Profile Missing</h3>
                                <p>Child account linked but profile not found. The child may need to complete registration.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Store children profiles for later use
                    this.childProfiles = childProfiles;

                    // Get enrollment data for all children (reuse childIds from above)
                    let enrollmentCounts = {};
                    let enrollmentTypes = {};
                    try {
                        const { data: enrollments } = await this.auth.supabase
                            .from('class_enrollments')
                            .select('student_id')
                            .in('student_id', childIds)
                            .eq('status', 'active');

                        childIds.forEach(id => { enrollmentCounts[id] = 0; });
                        (enrollments || []).forEach(e => {
                            enrollmentCounts[e.student_id] = (enrollmentCounts[e.student_id] || 0) + 1;
                        });

                        const { data: profiles } = await this.auth.supabase
                            .from('user_profiles')
                            .select('id, enrollment_type')
                            .in('id', childIds);
                        (profiles || []).forEach(p => {
                            enrollmentTypes[p.id] = p.enrollment_type === 'homeschool' ? 'Homeschool' : 'Full-Time';
                        });
                    } catch (e) {
                        console.warn('Could not load enrollment data:', e);
                    }

                    // Build the dashboard with the children data
                    let childSelectorHTML = '';
                    if (childProfiles.length > 1) {
                        childSelectorHTML = `
                            <div style="margin-bottom: 20px;">
                                <label style="color: var(--muted); font-size: 13px; margin-bottom: 6px; display: block;">Select Child</label>
                                <select id="child-selector" class="form-control" style="max-width: 300px;" onchange="portal.onChildSelectorChange(this.value)">
                                    ${childProfiles.map((child, index) => `
                                        <option value="${child.id}" ${index === 0 ? 'selected' : ''}>
                                            ${child.first_name} ${child.last_name}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        `;
                    }

                    // Show the first child's basic info immediately
                    const firstChild = childProfiles[0];
                    this.selectedChildId = firstChild.id;

                    dashboardSection.innerHTML = `
                        <h2>Parent Dashboard - Welcome, ${firstName}</h2>
                        ${childSelectorHTML}
                        <div class="dashboard">
                            <div class="card">
                                <h3>üë∂ Linked Child${childProfiles.length > 1 ? 'ren' : ''}</h3>
                                ${childProfiles.map(child => {
                                    const classCount = enrollmentCounts[child.id] || 0;
                                    const enrType = enrollmentTypes[child.id] || 'Full-Time';
                                    return `
                                    <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                                        <strong>${child.first_name} ${child.last_name}</strong><br>
                                        <small>Grade ${child.grade_level || 'N/A'} ‚Ä¢ ${enrType} ‚Ä¢ ${classCount} class${classCount !== 1 ? 'es' : ''}</small>
                                    </div>
                                    `;
                                }).join('')}
                                <button class="btn btn-secondary" onclick="portal.showLinkChildModal()" style="width: 100%; margin-top: 10px;">
                                    ‚ûï Link Another Child
                                </button>
                            </div>
                            <div class="card">
                                <h3>üìö Quick Actions</h3>
                                <button class="btn btn-primary" onclick="window.portalAuth.goToClassesPortal()" style="width: 100%; margin-bottom: 10px;">
                                    View Classes & Messages
                                </button>
                                <button class="btn btn-secondary" id="view-child-details-btn" onclick="portal.loadChildDetails(portal.selectedChildId)" style="width: 100%; margin-bottom: 10px;">
                                    View ${firstChild.first_name}'s Details
                                </button>
                            </div>
                        </div>
                        <div id="child-details-container"></div>
                    `;
                    
                } catch (error) {
                    console.error('Error loading parent dashboard:', error);
                    dashboardSection.innerHTML = `
                        <h2>Welcome, ${firstName}</h2>
                        <div class="alert alert-error">Failed to load dashboard: ${error.message}</div>
                    `;
                }
            }
            
            async loadChildInfo(childId) {
                const container = document.getElementById('child-info-container');
                if (!container) return;
            
                try {
                    // Get child's profile
                    const { data: childProfile } = await this.auth.supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', childId)
                        .single();
            
                    // Get child's class enrollments with class details
                    const { data: enrollments } = await this.auth.supabase
                        .from('class_enrollments')
                        .select(`
                            *,
                            classes (
                                id,
                                name,
                                subject,
                                teacher_id,
                                user_profiles!classes_teacher_id_fkey (
                                    first_name,
                                    last_name
                                )
                            )
                        `)
                        .eq('student_id', childId);
            
                    // Get assignments for all enrolled classes
                    let assignmentsHTML = '';
                    if (enrollments && enrollments.length > 0) {
                        const classIds = enrollments.map(e => e.class_id);
                        
                        const { data: assignments } = await this.auth.supabase
                            .from('assignments')
                            .select(`
                                *,
                                submissions!left (
                                    id,
                                    student_id,
                                    grade,
                                    submitted_at,
                                    status
                                )
                            `)
                            .in('class_id', classIds)
                            .order('due_date', { ascending: false });
            
                        // Group assignments by class
                        const assignmentsByClass = {};
                        enrollments.forEach(enrollment => {
                            const classAssignments = assignments?.filter(a => a.class_id === enrollment.class_id) || [];
                            if (classAssignments.length > 0) {
                                assignmentsByClass[enrollment.classes.name] = classAssignments.map(assignment => {
                                    const submission = assignment.submissions?.find(s => s.student_id === childId);
                                    return { ...assignment, submission };
                                });
                            }
                        });
            
                        assignmentsHTML = Object.entries(assignmentsByClass).map(([className, classAssignments]) => `
                            <div class="card" style="margin-top: 20px;">
                                <h4>üìö ${className}</h4>
                                <table style="width: 100%; margin-top: 10px;">
                                    <thead>
                                        <tr>
                                            <th>Assignment</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Grade</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${classAssignments.map(assignment => {
                                            const submission = assignment.submission;
                                            const status = submission?.status || 'Not Started';
                                            const grade = submission?.grade || '-';
                                            const dueDate = new Date(assignment.due_date).toLocaleDateString();
                                            const isPastDue = new Date(assignment.due_date) < new Date() && !submission;
                                            
                                            return `
                                                <tr>
                                                    <td>${assignment.title}</td>
                                                    <td>${dueDate}</td>
                                                    <td>
                                                        <span style="color: ${
                                                            status === 'submitted' ? 'var(--accent-2)' : 
                                                            isPastDue ? 'var(--danger)' : 
                                                            'var(--warning)'
                                                        }">
                                                            ${isPastDue ? 'Past Due' : status}
                                                        </span>
                                                    </td>
                                                    <td>${grade}</td>
                                                    <td>
                                                        <button class="btn btn-secondary small" 
                                                                onclick="portal.viewAssignmentDetails('${assignment.id}')">
                                                            View Details
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('');
                    }
            
                    // Build the child info display
                    container.innerHTML = `
                        <div class="dashboard">
                            <div class="card">
                                <h3>üë¶ ${childProfile.first_name} ${childProfile.last_name}</h3>
                                <p>Grade Level: ${childProfile.grade_level || 'Not set'}</p>
                                <p>Email: ${childProfile.email}</p>
                            </div>
                            
                            <div class="card">
                                <h3>üìä Academic Overview</h3>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value">${enrollments?.length || 0}</div>
                                        <div class="stat-label">Enrolled Classes</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value">-</div>
                                        <div class="stat-label">Overall Grade</div>
                                    </div>
                                </div>
                            </div>
                        </div>
            
                        <div style="margin-top: 20px;">
                            <h3>üìö Enrolled Classes</h3>
                            ${enrollments && enrollments.length > 0 ? `
                                <div class="dashboard">
                                    ${enrollments.map(enrollment => `
                                        <div class="card">
                                            <h4>${enrollment.classes.name}</h4>
                                            <p><strong>Subject:</strong> ${enrollment.classes.subject}</p>
                                            <p><strong>Teacher:</strong> ${enrollment.classes.user_profiles.first_name} ${enrollment.classes.user_profiles.last_name}</p>
                                            <p><strong>Current Grade:</strong> ${enrollment.current_grade || 'N/A'}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>No class enrollments found.</p>'}
                        </div>
            
                        ${assignmentsHTML ? `
                            <div style="margin-top: 20px;">
                                <h3>üìù Assignments</h3>
                                ${assignmentsHTML}
                            </div>
                        ` : ''}
                    `;
                } catch (error) {
                    console.error('Error loading child info:', error);
                    container.innerHTML = '<div class="alert alert-error">Failed to load child information.</div>';
                }
            }
            
            onChildSelectorChange(childId) {
                this.selectedChildId = childId;
                const child = this.childProfiles?.find(c => c.id === childId);
                if (child) {
                    const btn = document.getElementById('view-child-details-btn');
                    if (btn) {
                        btn.textContent = `View ${child.first_name}'s Details`;
                    }
                }
                // Clear previous child details
                const container = document.getElementById('child-details-container');
                if (container) container.innerHTML = '';
            }

            async viewAssignmentDetails(assignmentId) {
                try {
                    const { data: assignment, error } = await this.auth.supabase
                        .from('assignments')
                        .select('*')
                        .eq('id', assignmentId)
                        .single();
            
                    if (error) throw error;
            
                    // Create modal to show assignment details
                    this.showModal('assignment-details', assignment.title, `
                        <div style="padding: 20px;">
                            <p><strong>Description:</strong></p>
                            <p>${assignment.description || 'No description provided'}</p>
                            <br>
                            <p><strong>Due Date:</strong> ${new Date(assignment.due_date).toLocaleDateString()}</p>
                            <p><strong>Points:</strong> ${assignment.max_points || 'Not specified'}</p>
                            <br>
                            <button class="btn btn-secondary" onclick="portal.closeModal()">Close</button>
                        </div>
                    `);
                } catch (error) {
                    console.error('Error viewing assignment:', error);
                    window.PortalUI.showNotification('Failed to load assignment details', 'error');
                }
            }

            // Parent-specific methods
            showLinkChildModal() {
                const modalContent = `
                    <form id="link-child-form" onsubmit="portal.linkChildByEmail(event)">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; color: var(--muted);">Child's Email Address</label>
                            <input type="email" id="child-email-input" class="form-control" placeholder="child@example.com" required>
                            <small style="color: var(--muted);">Enter the email address your child uses to sign in.</small>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="portal.closeModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Link Child</button>
                        </div>
                    </form>
                `;
                this.showModal('link-child', 'Link a Child', modalContent);
            }

            async linkChildByEmail(event) {
                event.preventDefault();

                const emailInput = document.getElementById('child-email-input');
                const childEmail = emailInput?.value?.trim().toLowerCase();

                if (!childEmail) {
                    window.PortalUI?.showNotification('Please enter an email address', 'error');
                    return;
                }

                try {
                    // Find the child's profile by email
                    // Note: This query may be restricted by RLS policies
                    const { data: childProfile, error: findError } = await this.auth.supabase
                        .from('user_profiles')
                        .select('id, first_name, last_name, email, user_type')
                        .eq('email', childEmail)
                        .eq('user_type', 'student')
                        .single();

                    console.log('Link child lookup result:', { childProfile, findError, searchedEmail: childEmail });

                    if (findError) {
                        console.error('Error finding child profile:', findError);
                        // Check if it's an RLS/permission issue vs not found
                        if (findError.code === 'PGRST116') {
                            window.PortalUI?.showNotification('No student found with that email address. Make sure the student has registered first.', 'error');
                        } else {
                            window.PortalUI?.showNotification('Error looking up student: ' + findError.message, 'error');
                        }
                        return;
                    }

                    if (!childProfile) {
                        window.PortalUI?.showNotification('No student found with that email address', 'error');
                        return;
                    }

                    // Check if already linked to another parent
                    const { data: existingLink } = await this.auth.supabase
                        .from('parent_child_links')
                        .select('parent_id')
                        .eq('child_id', childProfile.id)
                        .maybeSingle();

                    if (existingLink && existingLink.parent_id !== this.auth.currentUser.id) {
                        window.PortalUI?.showNotification('This student is already linked to another parent account. Please contact the school administrator if you believe this is an error.', 'warning');
                        this.closeModal();
                        return;
                    }

                    // Create the link
                    const { error: linkError } = await this.auth.supabase
                        .from('parent_child_links')
                        .upsert({
                            parent_id: this.auth.currentUser.id,
                            child_id: childProfile.id
                        }, { onConflict: 'parent_id,child_id' });

                    if (linkError) {
                        console.error('Error linking child:', linkError);
                        window.PortalUI?.showNotification('Failed to link child: ' + linkError.message, 'error');
                        return;
                    }

                    window.PortalUI?.showNotification(`Successfully linked ${childProfile.first_name} to your account!`, 'success');
                    this.closeModal();

                    // Reload the parent dashboard
                    await this.loadParentTeacherDashboard();

                } catch (error) {
                    console.error('Error in linkChildByEmail:', error);
                    window.PortalUI?.showNotification('An error occurred. Please try again.', 'error');
                }
            }

            // Track failed login attempts and alert admins for security
            async trackFailedLogin(email, errorMessage) {
                try {
                    // Store failed attempt count in sessionStorage
                    const key = `failed_login_${email}`;
                    const attempts = parseInt(sessionStorage.getItem(key) || '0') + 1;
                    sessionStorage.setItem(key, attempts.toString());

                    // Only alert admins after 3+ failed attempts (to reduce noise)
                    if (attempts >= 3) {
                        // Get all admins with notification preferences
                        const { data: admins } = await this.auth.supabase
                            .from('user_profiles')
                            .select('id, email_notifications')
                            .eq('user_type', 'admin');

                        if (admins && admins.length > 0) {
                            // Create security alert notification for each admin
                            for (const admin of admins) {
                                const emailPrefs = admin.email_notifications || {};
                                // Default to true if no preference set
                                if (emailPrefs.system_alerts === false) continue;

                                await this.auth.supabase
                                    .from('notifications')
                                    .insert({
                                        user_id: admin.id,
                                        type: 'system_alert',
                                        title: 'Security Alert: Multiple Failed Login Attempts',
                                        message: `${attempts} failed login attempts for email: ${email}. Last error: ${errorMessage}`,
                                        is_read: false,
                                        metadata: {
                                            alertType: 'failed_login',
                                            email: email,
                                            attempts: attempts,
                                            errorMessage: errorMessage,
                                            timestamp: new Date().toISOString()
                                        }
                                    });
                            }
                        }

                        // Reset counter after alerting
                        sessionStorage.removeItem(key);
                    }
                } catch (err) {
                    // Don't let tracking errors break the login flow
                    console.error('Error tracking failed login:', err);
                }
            }

            async loadChildDetails(childId) {
                const container = document.getElementById('child-details-container');
                if (!container) return;

                container.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';

                try {
                    // Get child's profile
                    const { data: childProfile } = await this.auth.supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', childId)
                        .single();

                    if (!childProfile) {
                        container.innerHTML = '<div class="alert alert-error">Child profile not found.</div>';
                        return;
                    }

                    // Get child's class enrollments with class details
                    const { data: enrollments } = await this.auth.supabase
                        .from('class_enrollments')
                        .select('*, classes(id, name, subject)')
                        .eq('student_id', childId)
                        .eq('status', 'active');

                    // Get assignments and grades
                    let gradesHTML = '';
                    if (enrollments && enrollments.length > 0) {
                        const classIds = enrollments.map(e => e.class_id);

                        const { data: assignments } = await this.auth.supabase
                            .from('assignments')
                            .select('id, title, class_id, due_date, points_possible')
                            .in('class_id', classIds)
                            .eq('is_published', true)
                            .order('due_date', { ascending: true });

                        if (assignments && assignments.length > 0) {
                            const assignmentIds = assignments.map(a => a.id);
                            const { data: submissions } = await this.auth.supabase
                                .from('submissions')
                                .select('assignment_id, grade, submitted_at, status')
                                .eq('student_id', childId)
                                .in('assignment_id', assignmentIds);

                            gradesHTML = `
                                <div class="card" style="margin-top: 20px;">
                                    <h4>üìù Recent Assignments</h4>
                                    <table style="width: 100%; margin-top: 10px;">
                                        <thead>
                                            <tr>
                                                <th style="text-align: left;">Assignment</th>
                                                <th style="text-align: left;">Class</th>
                                                <th style="text-align: left;">Status</th>
                                                <th style="text-align: left;">Grade</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${assignments.slice(0, 10).map(a => {
                                                const submission = submissions?.find(s => s.assignment_id === a.id);
                                                const className = enrollments.find(e => e.class_id === a.class_id)?.classes?.name || 'Unknown';
                                                const isPastDue = a.due_date && new Date(a.due_date) < new Date() && !submission;
                                                const statusText = submission ? (submission.status || 'Submitted') : (isPastDue ? 'Missing' : 'Pending');
                                                const statusColor = submission ? 'var(--accent-2)' : (isPastDue ? 'var(--danger)' : 'var(--warning)');

                                                return `
                                                    <tr>
                                                        <td>${a.title}</td>
                                                        <td>${className}</td>
                                                        <td style="color: ${statusColor};">${statusText}</td>
                                                        <td>${submission?.grade ?? '-'}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }
                    }

                    container.innerHTML = `
                        <div class="card" style="margin-top: 20px;">
                            <h3>üìä ${childProfile.first_name}'s Details</h3>
                            <p><strong>Name:</strong> ${childProfile.first_name} ${childProfile.last_name}</p>
                            <p><strong>Email:</strong> ${childProfile.email}</p>
                            <p><strong>Grade Level:</strong> ${childProfile.grade_level || 'Not set'}</p>
                            <p><strong>Enrolled Classes:</strong> ${enrollments?.length || 0}</p>
                        </div>
                        ${gradesHTML}
                    `;
                } catch (error) {
                    console.error('Error loading child details:', error);
                    container.innerHTML = '<div class="alert alert-error">Failed to load child details.</div>';
                }
            }

            async loadTeacherDashboard(dashboardSection, userInfo, firstName) {
                // Keep existing teacher dashboard
                dashboardSection.innerHTML = `
                    <h2>Teacher Dashboard - Welcome, ${firstName}</h2>
                    <div class="dashboard">
                        <div class="card">
                            <h3>üë®‚Äçüè´ Your Classes</h3>
                            <p>Manage your classes, students, and assignments.</p>
                            <button class="btn btn-primary" onclick="window.portalAuth.goToClassesPortal()" style="margin-top: 15px; width: 100%;">
                                üìö Go to Classes & Messaging
                            </button>
                        </div>
                        <div class="card">
                            <h3>üìä Overview</h3>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">New Submissions</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">Pending Grades</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            addGameCardListeners() {
                const gameCards = document.querySelectorAll('.game-card');
                gameCards.forEach(card => {
                    const gameId = card.getAttribute('data-game');
                    if (gameId) {
                        card.addEventListener('click', () => this.openGame(gameId));
                    }
                });
            }

            addSkillTreeListeners() {
                const skillButtons = document.querySelectorAll('.skill-tree-btn');
                skillButtons.forEach(button => {
                    const subject = button.getAttribute('data-subject');
                    if (subject) {
                        button.addEventListener('click', () => this.loadSkillTree(subject));
                    }
                });
            }

            async loadSkillTree(subject) {
                if (this.skillTreeIntegration) {
                    await this.skillTreeIntegration.loadSkillTree(subject);
                }
            }

            showSkillsTab() {
                setTimeout(() => this.addSkillTreeListeners(), 100);
            }

            async updateMathleticsProgress() {
                if (!this.auth.isAuthenticated()) return;
                
                try {
                    const { data, error } = await this.auth.supabase
                        .from('mathletics_progress')
                        .select('current_range, mastery_level')
                        .eq('user_id', this.auth.getUserInfo().profile.id)
                        .single();
                    
                    if (data && !error) {
                        const rangeElement = document.getElementById('mathletics-range');
                        const masteryElement = document.getElementById('mathletics-mastery');
                        
                        if (rangeElement) {
                            rangeElement.textContent = `${data.current_range?.min || 0}-${data.current_range?.max || 2}`;
                        }
                        if (masteryElement) {
                            masteryElement.textContent = data.mastery_level || 'Bronze';
                        }
                    }
                } catch (err) {
                    console.error('Error updating Mathletics progress:', err);
                }
            }
            
            openGame(gameId) {
                const gameConfig = {
                    'math-dojo': {
                        url: 'games/math-dojo.html',
                        title: 'ü•ã Math Dojo'
                    },
                    'mathletics': {
                        url: 'games/mathletics.html',
                        title: 'üéØ Mathletics'
                    },
                    'mathspire': {
                        url: 'games/mathspire.html',
                        title: 'üè∞ Mathspire'
                    },
                    'practice-pilot': {
                        url: 'games/practice-pilot.html',
                        title: 'üöÄ Practice Pilot'
                    },
                    'wasteland-adventure': {
                        url: 'games/wasteland_adventure.html',
                        title: 'üèúÔ∏è Wasteland Adventure'
                    },
                    'clockwork-defense': {
                        url: 'games/clockwork-defense.html',
                        title: '‚è∞ Clockwork Defense'
                    },
                    'dimension-shift': {
                        url: 'games/dimension-shift.html',
                        title: 'üåÄ Dimension Shift'
                    },
                    'teacher-challenge': {
                        url: 'games/teacher-challenge.html',
                        title: 'üçé Teacher Challenge'
                    },
                    'riutiz': {
                        url: 'games/riutiz.html',
                        title: 'üÉè RIUTIZ'
                    }
                };
                
                const game = gameConfig[gameId];
                if (!game) return;
                
                document.getElementById('game-selection').classList.add('hidden');
                document.getElementById('game-iframe-container').classList.remove('hidden');
                
                const iframe = document.getElementById('game-iframe');
                iframe.src = game.url;
                document.getElementById('current-game-title').textContent = game.title;
                
                // Enable touch events in iframe
                iframe.onload = () => {
                    console.log('Game loaded, enabling touch events');
                    iframe.contentWindow.postMessage({ type: 'ENABLE_TOUCH' }, '*');
                };
                
                console.log(`üéÆ Opened game: ${game.title}`);
            }

            closeGame() {
                // Exit fullscreen first if active
                this.exitGameFullscreen();

                // Show game selection, hide iframe
                document.getElementById('game-selection').classList.remove('hidden');
                document.getElementById('game-iframe-container').classList.add('hidden');

                // Clear iframe
                document.getElementById('game-iframe').src = '';

                console.log('üéÆ Closed game');
            }

            toggleGameFullscreen() {
                const container = document.getElementById('game-iframe-container');
                if (!container) return;

                const isFullscreen = document.fullscreenElement ||
                                   document.webkitFullscreenElement ||
                                   document.body.classList.contains('game-fullscreen');

                if (isFullscreen) {
                    this.exitGameFullscreen();
                } else {
                    this.enterGameFullscreen();
                }
            }

            enterGameFullscreen() {
                const container = document.getElementById('game-iframe-container');
                if (!container) return;

                // Try native fullscreen API first
                const requestFullscreen = container.requestFullscreen ||
                                         container.webkitRequestFullscreen ||
                                         container.mozRequestFullScreen ||
                                         container.msRequestFullscreen;

                if (requestFullscreen) {
                    requestFullscreen.call(container).catch(err => {
                        console.log('Native fullscreen failed, using CSS fallback:', err);
                        // CSS fallback for mobile browsers that block fullscreen
                        document.body.classList.add('game-fullscreen');
                    });
                } else {
                    // CSS fallback for browsers without fullscreen API
                    document.body.classList.add('game-fullscreen');
                }

                // Always add CSS class as backup visual indicator
                document.body.classList.add('game-fullscreen');

                // Mobile: scroll to top and prevent body scroll to help hide address bar
                window.scrollTo(0, 0);
                document.body.style.overflow = 'hidden';

                // Update button text
                const fullscreenBtn = document.getElementById('fullscreen-game-btn');
                if (fullscreenBtn) {
                    fullscreenBtn.textContent = '‚õ∂ Exit Fullscreen';
                }

                // Notify iframe it's now fullscreen
                const iframe = document.getElementById('game-iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ type: 'FULLSCREEN_ENTER' }, '*');
                }

                console.log('üéÆ Entered fullscreen mode');
            }

            exitGameFullscreen() {
                // Exit native fullscreen if active
                if (document.fullscreenElement || document.webkitFullscreenElement) {
                    const exitFullscreen = document.exitFullscreen ||
                                          document.webkitExitFullscreen ||
                                          document.mozCancelFullScreen ||
                                          document.msExitFullscreen;
                    if (exitFullscreen) {
                        exitFullscreen.call(document).catch(err => {
                            console.log('Exit fullscreen error:', err);
                        });
                    }
                }

                // Always remove CSS class
                document.body.classList.remove('game-fullscreen');

                // Restore body scroll
                document.body.style.overflow = '';

                // Update button text
                const fullscreenBtn = document.getElementById('fullscreen-game-btn');
                if (fullscreenBtn) {
                    fullscreenBtn.textContent = '‚õ∂ Fullscreen';
                }

                // Notify iframe it exited fullscreen
                const iframe = document.getElementById('game-iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ type: 'FULLSCREEN_EXIT' }, '*');
                }

                console.log('üéÆ Exited fullscreen mode');
            }

            handleFullscreenChange() {
                const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;

                if (!isFullscreen) {
                    // User exited fullscreen via Escape key or browser UI
                    document.body.classList.remove('game-fullscreen');
                    const fullscreenBtn = document.getElementById('fullscreen-game-btn');
                    if (fullscreenBtn) {
                        fullscreenBtn.textContent = '‚õ∂ Fullscreen';
                    }
                }
            }
        }

        // Real SkillTreeIntegration class that integrates with SkillTreeViewer.html
        class SkillTreeIntegration {
            constructor(portal) {
                this.portal = portal;
                this.skillProgress = {};
                this.currentIframe = null;
                this.messageHandlers = new Map();
                
                // Set up message listener for skill tree communication
                window.addEventListener('message', (event) => {
                    this.handleSkillTreeMessage(event);
                });
            }
        
            async initialize() {
                await this.loadUserProgress();
                console.log('üåü SkillTreeIntegration initialized with real skill tree system');
            }
        
            async loadUserProgress() {
                // Load progress from database or localStorage
                if (this.portal.auth.isAuthenticated()) {
                    try {
                        const userId = this.portal.auth.getUserInfo().profile.id;

                        // Try to load from Supabase with all new fields
                        const { data, error } = await this.portal.auth.supabase
                            .from('skill_progress')
                            .select('subject, skill_name, state, mastery_score, last_practiced, practice_count, decay_rate, mastered_at')
                            .eq('user_id', userId);

                        console.log('üìä Loaded skill progress from database:', data?.length || 0, 'records', error ? `Error: ${error.message}` : '');

                        if (data && !error) {
                            // Organize progress by subject with full skill data
                            this.skillProgress = {};
                            data.forEach(record => {
                                if (!this.skillProgress[record.subject]) {
                                    this.skillProgress[record.subject] = {};
                                }
                                // Store full skill data object, not just state
                                this.skillProgress[record.subject][record.skill_name] = {
                                    state: record.state,
                                    mastery_score: record.mastery_score || 0,
                                    last_practiced: record.last_practiced,
                                    practice_count: record.practice_count || 0,
                                    decay_rate: record.decay_rate || 14,
                                    mastered_at: record.mastered_at
                                };
                            });
                            console.log('üìä Skill progress by subject:', Object.keys(this.skillProgress).map(s => `${s}: ${Object.keys(this.skillProgress[s]).length} skills`));
                        } else {
                            // Fallback to localStorage
                            const saved = localStorage.getItem(`skill_progress_${userId}`);
                            this.skillProgress = saved ? JSON.parse(saved) : {};
                            console.log('üìä Loaded from localStorage fallback');
                        }

                        // Update skills counter
                        this.updateSkillsCounter();

                    } catch (error) {
                        console.warn('Could not load skill progress:', error);
                        this.skillProgress = {};
                    }
                }
            }
        
            updateSkillsCounter() {
                // Count total unlocked/mastered skills across all subjects
                let totalUnlocked = 0;
                let totalMastered = 0;
                let needsReview = 0;

                Object.values(this.skillProgress).forEach(subjectProgress => {
                    Object.values(subjectProgress).forEach(skillData => {
                        // Handle both old format (string) and new format (object)
                        const state = typeof skillData === 'string' ? skillData : skillData.state;

                        if (['available', 'activated', 'mastered', 'in_progress', 'needs_review'].includes(state)) {
                            totalUnlocked++;
                        }
                        if (['activated', 'mastered'].includes(state)) {
                            totalMastered++;
                        }

                        // Check for decay on mastered skills
                        if (typeof skillData === 'object' && skillData.last_practiced) {
                            const daysSince = Math.floor((Date.now() - new Date(skillData.last_practiced)) / (1000 * 60 * 60 * 24));
                            const decayRate = skillData.decay_rate || 14;
                            if (daysSince > decayRate && ['activated', 'mastered'].includes(state)) {
                                needsReview++;
                            }
                        }
                    });
                });

                const counter = document.getElementById('skills-unlocked');
                if (counter) {
                    counter.textContent = totalMastered;
                }

                // Update needs review badge if it exists
                const reviewBadge = document.getElementById('skills-needs-review');
                if (reviewBadge) {
                    reviewBadge.textContent = needsReview;
                    reviewBadge.style.display = needsReview > 0 ? 'inline' : 'none';
                }
            }
        
            handleSkillTreeMessage(event) {
                // Handle messages from the skill tree iframe or games
                if (!event.data || !event.data.type) return;

                switch (event.data.type) {
                    case 'REQUEST_SKILL_DATA':
                        this.sendSkillData(event.data.subject, event.source);
                        break;

                    case 'SKILL_UNLOCKED':
                        this.handleSkillUnlocked(event.data);
                        break;

                    case 'SKILL_PRACTICE':
                        // Game reporting skill practice
                        this.handleSkillPractice(event.data);
                        break;

                    case 'GAME_SESSION_COMPLETE':
                        // Game session finished with results
                        this.handleGameSessionComplete(event.data);
                        break;

                    case 'REQUEST_SKILLS_FOR_GAME':
                        // Game requesting available skills to practice
                        this.sendSkillsForGame(event.data, event.source);
                        break;

                    case 'OPEN_GAME':
                        // Skill tree requesting to open a game (e.g., Practice in Dojo)
                        this.handleOpenGameRequest(event.data);
                        break;

                    case 'RESET_SKILL_PROGRESS':
                        // Skill tree requesting to reset all progress for a subject
                        this.handleResetSkillProgress(event.data);
                        break;

                    case 'DOJO_SKILL_DATA_UPDATED':
                        // Dojo has updated skill data - refresh local state
                        this.handleDojoSkillUpdate(event.data);
                        break;

                    case 'SKILL_TREE_STATES_UPDATED':
                        // Skill tree has updated states - forward to Dojo
                        this.forwardSkillStatesToDojo(event.data);
                        break;

                    case 'BACKFILL_SKILLS':
                        // Skill tree requesting bulk backfill of prerequisite skills to Supabase
                        this.handleBackfillSkills(event.data);
                        break;

                    default:
                        console.log('Unknown message from skill tree/game:', event.data.type);
                }
            }

            handleOpenGameRequest(data) {
                const { gameId } = data;
                if (!gameId) return;

                console.log('üéÆ Opening game from skill tree:', gameId);

                // Switch to Games tab and open the game
                this.portal.showTab('games');
                setTimeout(() => {
                    this.portal.openGame(gameId);
                }, 100);
            }

            async handleResetSkillProgress(data) {
                const { subject } = data;
                if (!subject) return;

                console.log('üîÑ Resetting skill progress for:', subject);

                // Clear local progress
                if (this.skillProgress[subject]) {
                    this.skillProgress[subject] = {};
                }

                // Delete from Supabase
                try {
                    if (this.portal.auth.isAuthenticated()) {
                        const userId = this.portal.auth.getUserInfo().profile.id;
                        console.log('Deleting skill progress for user:', userId, 'subject:', subject);
                        const { error } = await this.portal.auth.supabase
                            .from('skill_progress')
                            .delete()
                            .eq('user_id', userId)
                            .eq('subject', subject);

                        if (error) {
                            console.error('Failed to delete skill progress from database:', error);
                        } else {
                            console.log('‚úÖ Skill progress deleted from database');
                        }

                        // Also clear localStorage fallback
                        localStorage.removeItem(`skill_progress_${userId}`);
                        localStorage.removeItem('math_skill_states');
                        console.log('‚úÖ LocalStorage cleared');
                    } else {
                        console.log('No user logged in, skipping database reset');
                    }
                } catch (e) {
                    console.error('Error resetting skill progress:', e);
                }
            }

            async handleBackfillSkills(data) {
                const { subject, skills } = data;
                if (!subject || !skills || skills.length === 0) return;

                console.log(`üîÑ Backfilling ${skills.length} prerequisite skills to Supabase for ${subject}`);

                // Update local progress
                if (!this.skillProgress[subject]) {
                    this.skillProgress[subject] = {};
                }

                const now = new Date().toISOString();
                for (const s of skills) {
                    this.skillProgress[subject][s.skillName] = {
                        state: 'mastered',
                        mastery_score: 100,
                        last_practiced: now,
                        practice_count: 1,
                        decay_rate: 14,
                        mastered_at: now
                    };
                }

                // Bulk upsert to Supabase
                if (this.portal.auth.isAuthenticated()) {
                    try {
                        const userId = this.portal.auth.getUserInfo().profile.id;

                        const rows = skills.map(s => ({
                            user_id: userId,
                            subject: subject,
                            skill_name: s.skillName,
                            state: 'mastered',
                            mastery_score: 100,
                            last_practiced: now,
                            practice_count: 1,
                            mastered_at: now,
                            updated_at: now
                        }));

                        const { error } = await this.portal.auth.supabase
                            .from('skill_progress')
                            .upsert(rows);

                        if (error) {
                            console.error('Failed to backfill skills to database:', error);
                        } else {
                            console.log(`‚úÖ Backfilled ${skills.length} skills to database`);
                        }
                    } catch (e) {
                        console.error('Error backfilling skills:', e);
                    }
                }

                this.updateSkillsCounter();
            }

            handleDojoSkillUpdate(data) {
                console.log('üì• Received skill update from Dojo');

                // Update local skill progress for Math
                if (data.skills) {
                    this.skillProgress['Math'] = data.skills;
                }

                // Update skills counter
                this.updateSkillsCounter();

                // Forward to skill tree iframe if it exists
                const skillTreeIframe = document.getElementById('skill-tree-frame');
                if (skillTreeIframe && skillTreeIframe.contentWindow) {
                    skillTreeIframe.contentWindow.postMessage({
                        type: 'SKILL_DATA_RESPONSE',
                        subject: 'Math',
                        progress: data.skills,
                        skillTreeData: {}
                    }, '*');
                    console.log('üì§ Forwarded skill update to skill tree');
                }
            }

            forwardSkillStatesToDojo(data) {
                console.log('üì§ Forwarding skill states to Dojo');

                // Find the game iframe (Dojo)
                const gameIframe = document.getElementById('game-frame');
                if (gameIframe && gameIframe.contentWindow) {
                    gameIframe.contentWindow.postMessage({
                        type: 'SKILL_STATES_FROM_TREE',
                        subject: data.subject,
                        skills: data.skills
                    }, '*');
                    console.log('üì§ Sent skill states to Dojo iframe');
                }
            }

            sendSkillData(subject, source) {
                // Merge localStorage data with Supabase data to prevent data loss
                let progress = {};
                try {
                    if (subject === 'Math') {
                        const localData = localStorage.getItem('math_skill_states');
                        if (localData) {
                            const parsed = JSON.parse(localData);
                            const localSkills = parsed.skills || parsed;
                            Object.assign(progress, localSkills);
                        }
                    }
                } catch (e) {
                    console.warn('Failed to read localStorage for skill data merge:', e);
                }

                // Supabase data takes priority
                const supabaseProgress = this.skillProgress[subject] || {};
                Object.assign(progress, supabaseProgress);

                console.log('üì§ Sending skill data for', subject, '- skills:', Object.keys(progress).length);

                // Send the data back to the skill tree
                source.postMessage({
                    type: 'SKILL_DATA_RESPONSE',
                    subject: subject,
                    progress: progress,
                    skillTreeData: {
                        // The SkillTreeViewer.html has its own built-in data
                        // We just need to send progress
                    }
                }, '*');
            }
        
            async handleSkillUnlocked(data) {
                const { subject, skillName, state } = data;
                const now = new Date().toISOString();

                // Update local progress with new format
                if (!this.skillProgress[subject]) {
                    this.skillProgress[subject] = {};
                }
                const isMastery = state === 'activated' || state === 'mastered';
                this.skillProgress[subject][skillName] = {
                    state: isMastery ? 'mastered' : state,
                    mastery_score: isMastery ? 100 : 50,
                    last_practiced: now,
                    practice_count: 1,
                    decay_rate: 14,
                    mastered_at: isMastery ? now : null
                };

                // Save to database
                if (this.portal.auth.isAuthenticated()) {
                    try {
                        const userId = this.portal.auth.getUserInfo().profile.id;

                        // Save to Supabase with all new fields
                        const { error } = await this.portal.auth.supabase
                            .from('skill_progress')
                            .upsert({
                                user_id: userId,
                                subject: subject,
                                skill_name: skillName,
                                state: isMastery ? 'mastered' : state,
                                mastery_score: isMastery ? 100 : 50,
                                last_practiced: now,
                                practice_count: 1,
                                mastered_at: isMastery ? now : null,
                                updated_at: now
                            });
                        
                        if (error) {
                            console.warn('Failed to save to database:', error);
                            // Fallback to localStorage
                            localStorage.setItem(`skill_progress_${userId}`, JSON.stringify(this.skillProgress));
                        }
                        
                        // Update counter
                        this.updateSkillsCounter();
                        
                        // Show success notification
                        window.PortalUI.showNotification(
                            `üåü Skill unlocked: ${skillName}!`, 
                            'success', 
                            3000
                        );
                        
                    } catch (error) {
                        console.error('Error saving skill progress:', error);
                        // Still save to localStorage as fallback
                        const userId = this.portal.auth.getUserInfo().profile.id;
                        localStorage.setItem(`skill_progress_${userId}`, JSON.stringify(this.skillProgress));
                    }
                }
            }

            // Handle skill practice from games
            async handleSkillPractice(data) {
                const { subject, skillName, score, gameId } = data;

                if (!this.portal.auth.isAuthenticated()) return;

                try {
                    const userId = this.portal.auth.getUserInfo().profile.id;

                    // Record practice session
                    const { error: sessionError } = await this.portal.auth.supabase
                        .from('skill_practice_sessions')
                        .insert({
                            user_id: userId,
                            subject: subject,
                            skill_name: skillName,
                            source_type: 'game',
                            game_id: gameId,
                            score: score,
                            started_at: new Date().toISOString()
                        });

                    if (sessionError) {
                        console.warn('Failed to record practice session:', sessionError);
                    }

                    // Update local progress cache
                    await this.loadUserProgress();

                    // Show notification
                    if (score >= 80) {
                        window.PortalUI?.showNotification(
                            `Great practice on ${skillName}! Score: ${score}%`,
                            'success',
                            3000
                        );
                    }

                } catch (error) {
                    console.error('Error handling skill practice:', error);
                }
            }

            // Handle complete game session with multiple skill updates
            async handleGameSessionComplete(data) {
                const { gameId, subject, skills, duration, totalScore } = data;

                if (!this.portal.auth.isAuthenticated()) return;

                try {
                    const userId = this.portal.auth.getUserInfo().profile.id;

                    // Record each skill practiced
                    for (const skill of skills) {
                        await this.portal.auth.supabase
                            .from('skill_practice_sessions')
                            .insert({
                                user_id: userId,
                                subject: subject,
                                skill_name: skill.name,
                                source_type: 'game',
                                game_id: gameId,
                                score: skill.score,
                                correct_count: skill.correct,
                                total_count: skill.total,
                                duration_seconds: duration,
                                started_at: new Date().toISOString()
                            });
                    }

                    // Refresh progress
                    await this.loadUserProgress();

                    // Check for mastery achievements
                    const masteredSkills = skills.filter(s => s.score >= 80);
                    if (masteredSkills.length > 0) {
                        window.PortalUI?.showNotification(
                            `Session complete! Mastered ${masteredSkills.length} skill(s)`,
                            'success',
                            4000
                        );
                    }

                } catch (error) {
                    console.error('Error handling game session:', error);
                }
            }

            // Send available skills for games to use
            sendSkillsForGame(data, source) {
                const { subject, includeStates } = data;
                const states = includeStates || ['available', 'in_progress', 'mastered', 'activated', 'needs_review'];

                const subjectProgress = this.skillProgress[subject] || {};
                const availableSkills = [];

                Object.entries(subjectProgress).forEach(([skillName, skillData]) => {
                    const state = typeof skillData === 'string' ? skillData : skillData.state;
                    if (states.includes(state)) {
                        availableSkills.push({
                            name: skillName,
                            state: state,
                            mastery_score: typeof skillData === 'object' ? skillData.mastery_score : 0,
                            last_practiced: typeof skillData === 'object' ? skillData.last_practiced : null,
                            needs_review: state === 'needs_review' ||
                                (typeof skillData === 'object' && skillData.last_practiced &&
                                Math.floor((Date.now() - new Date(skillData.last_practiced)) / (1000 * 60 * 60 * 24)) > (skillData.decay_rate || 14))
                        });
                    }
                });

                // Sort by priority: needs_review first, then by mastery score
                availableSkills.sort((a, b) => {
                    if (a.needs_review && !b.needs_review) return -1;
                    if (!a.needs_review && b.needs_review) return 1;
                    return a.mastery_score - b.mastery_score;
                });

                source.postMessage({
                    type: 'SKILLS_FOR_GAME_RESPONSE',
                    subject: subject,
                    skills: availableSkills
                }, '*');
            }

            async loadSkillTree(subject) {
                const container = document.getElementById('skill-tree-container');
                if (!container) return;
                
                console.log(`üåü Loading skill tree for ${subject}`);
                
                // Remove any existing iframe
                if (this.currentIframe) {
                    this.currentIframe.remove();
                    this.currentIframe = null;
                }
                
                // Create iframe for the skill tree
                const iframe = document.createElement('iframe');
                iframe.id = 'skill-tree-iframe';
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                    border-radius: 10px;
                    background: radial-gradient(circle, #0a0a2e 0%, #000000 100%);
                `;
                
                // Set the iframe source with subject parameter
                iframe.src = `SkillTreeViewer.html?subject=${encodeURIComponent(subject)}&v=${Date.now()}`;
                
                // Clear container and add iframe
                container.innerHTML = '';
                container.appendChild(iframe);
                this.currentIframe = iframe;
                
                // Handle iframe load
                iframe.onload = () => {
                    console.log(`‚úÖ Skill tree loaded for ${subject}`);
                    
                    // Send initial data to the skill tree after a short delay
                    setTimeout(() => {
                        if (iframe.contentWindow) {
                            this.sendSkillData(subject, iframe.contentWindow);
                        }
                    }, 500);
                };
                
                iframe.onerror = () => {
                    console.error(`‚ùå Failed to load skill tree for ${subject}`);
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-color);">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                                <h3>Failed to Load Skill Tree</h3>
                                <p>Could not load the ${subject} skill tree</p>
                                <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 15px;">
                                    üîÑ Retry
                                </button>
                            </div>
                        </div>
                    `;
                };
            }
        
            // Method to get subject progress for other parts of the app
            getSubjectProgress(subject) {
                return this.skillProgress[subject] || {};
            }
        
            // Method to get total progress stats
            getTotalStats() {
                let totalSkills = 0;
                let unlockedSkills = 0;
                let completedSkills = 0;
                
                Object.values(this.skillProgress).forEach(subjectProgress => {
                    Object.values(subjectProgress).forEach(state => {
                        totalSkills++;
                        if (state === 'available' || state === 'activated') {
                            unlockedSkills++;
                        }
                        if (state === 'activated') {
                            completedSkills++;
                        }
                    });
                });
                
                return {
                    total: totalSkills,
                    unlocked: unlockedSkills,
                    completed: completedSkills
                };
            }
        
            // Method to refresh skill tree if needed
            refreshSkillTree(subject) {
                if (this.currentIframe && this.currentIframe.contentWindow) {
                    this.currentIframe.contentWindow.postMessage({
                        type: 'PROGRESS_UPDATED',
                        subject: subject,
                        progress: this.skillProgress[subject] || {}
                    }, '*');
                }
            }
        }

        // Initialize portal when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.portal = new StudentPortal();
        });
    </script>
</body>
</html>
