<!DOCTYPE html> 
 <html lang="en"> 
 <head> 
     <meta charset="UTF-8"> 
     <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
     <title>Student Learning Portal</title> 
      
         <script src="shared/config.js"></script> 
     <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
      
     <style> 
        :root{ 
           --bg:#0f1216; 
           --card:#151a21; 
           --text:#e6edf3; 
           --muted:#97a2b0; 
           --accent:#6aa9ff; 
           --accent-2:#8bffb0; 
           --danger:#ff6a6a; 
           --warning:#ffd36a; 
           --link:#a0c2ff; 
           --border:#2a3140; 
            
           /* Unified theme variables */ 
           --primary: var(--accent); 
           --secondary: var(--accent-2); 
           --background: var(--bg); 
           --card-bg: var(--card); 
           --text-color: var(--text); 
           --muted-color: var(--muted); 
           --border-color: var(--border); 
         } 
          
         *{margin:0;padding:0;box-sizing:border-box} 
         html,body{height:100%} 
         body{ 
           font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell; 
           background:var(--bg); 
           color:var(--text); 
           -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; 
         } 
          
         /* Shell */ 
         .container{ 
           background:var(--card); 
           border:1px solid var(--border); 
           border-radius:16px; 
           width:100%; max-width:1200px; min-height:600px; overflow:hidden; 
           box-shadow:0 10px 30px rgba(0,0,0,.35); 
           margin: 20px auto; 
         } 
          
         /* Header */ 
         .header{ 
           background:rgba(0,0,0,.25); 
           border-bottom:1px solid var(--border); 
           color:var(--text); 
           padding:16px 20px; 
           text-align:center; 
           position:relative; 
         } 
         .header h1{font-size:20px;letter-spacing:.3px} 
         #welcome-message{opacity:.85} 
         .logout-btn{ 
           position:absolute; right:20px; top:50%; transform:translateY(-50%); 
           background:#0c1118; border:1px solid #223041; color:#e5e7eb; 
           padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer; 
         } 
         .logout-btn:hover{border-color:var(--accent-2); box-shadow:0 0 0 2px rgba(139,255,176,.08)} 
          
         /* Top nav tabs */ 
         .nav-tabs{ 
           display:flex; gap:0; background:#0c1118; border-bottom:1px solid var(--border); 
         } 
         .nav-tab{ 
           flex:1; padding:12px 14px; text-align:center; cursor:pointer; border:0; 
           background:transparent; color:#c7d2fe; 
           transition:color .15s ease, background-color .15s ease, border-color .15s ease; 
           display: inline-block; 
           text-decoration: none; 
           font-family: inherit; 
           font-size: inherit; 
         } 
         .nav-tab:hover{background:rgba(255,255,255,.02); color:#a5b4fc} 
         .nav-tab.active{ 
           color:var(--accent); font-weight:700; border-bottom:3px solid var(--accent); background:#0b0f14; 
         } 
          
         /* Content area */ 
         .content{padding:20px; min-height:400px} 
          
         /* Cards & layout */ 
         .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-top:16px} 
         .card{ 
           background:#0c1118; 
           border:1px solid #223041; 
           border-radius:12px; padding:16px; 
           box-shadow:0 6px 16px rgba(0,0,0,.25); 
         } 
         .card h3{margin-bottom:8px} 
          
         /* Forms */ 
         .form-group{margin-bottom:14px; text-align:left} 
         .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--text)} 
         .form-group input,.form-group select, .form-group textarea{ 
           width:100%; padding:10px 12px; border-radius:10px; 
           background:#0e1319; color:var(--text); border:1px solid var(--border); font-size:14px; 
         } 
         .auth-form{max-width:400px;margin:0 auto;text-align:center} 
          
         /* Buttons */ 
         .btn{ 
           appearance:none; border:1px solid #223041; background:#0c1118; color:#e5e7eb; 
           padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer; 
           transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease, transform .02s ease; 
         } 
         .btn:hover{border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.1), inset 0 0 0 1px rgba(57,255,136,.15); background:#0b0f14} 
         .btn:active{transform:translateY(0)} 
         .btn.small{padding:4px 8px; font-size:11px; letter-spacing:.09em} 
          
         .btn-primary{ 
           background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%); 
           color:#0b0f14; border-color:transparent; 
         } 
         .btn-primary:hover{filter:brightness(1.05)} 
         .btn-secondary{background:#2b3442;color:var(--text);border:1px solid var(--border)} 
         .btn-secondary:hover{border-color:var(--accent)} 
          
         .btn-danger{background:#dc3545;color:#fff;border:1px solid #dc3545} 
         .btn-danger:hover{background:#c82333;border-color:#bd2130; box-shadow:0 0 0 2px rgba(220,53,69,.25)} 
          
         .hidden{display:none} 
          
         /* Alerts */ 
         .alert{padding:12px;border-radius:8px;margin:12px 0;border:1px solid var(--border)} 
         .alert-success{background:rgba(139,255,176,.08); color:#b5ffd0; border-color:rgba(139,255,176,.25)} 
         .alert-error{background:rgba(255,107,107,.08); color:#ffb3b3; border-color:rgba(255,107,107,.25)} 
          
         /* Stats */ 
         .stats{display:flex;justify-content:space-between;gap:12px;margin:10px 0} 
         .stat{text-align:center} 
         .stat-value{font-size:22px;font-weight:700;color:var(--accent)} 
         .stat-label{font-size:12px;color:var(--muted)} 
          
         /* Progress */ 
         .progress-bar{background:#0e1319;border:1px solid var(--border);border-radius:10px;height:16px;overflow:hidden;margin:10px 0} 
         .progress-fill{background:linear-gradient(90deg,var(--accent),var(--accent-2));height:100%;border-radius:10px;transition:width .3s ease} 
          
         /* Game grid/cards */ 
         .game-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:16px} 
         .game-card{ 
           background:#0b1017; border:1px solid #1a2330; color:#e5e7eb; 
           border-radius:12px; padding:16px; text-align:center; cursor:pointer; transition:transform .2s ease, border-color .15s ease, box-shadow .15s ease; 
         } 
         .game-card:hover{transform:translateY(-4px); border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.08)} 
          
         /* Tables */ 
         table{width:100%;border-collapse:collapse;margin-top:8px} 
         th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left} 
          
         /* Links */ 
         a{color:var(--link)} 
         a:hover{color:var(--accent)} 
          
         /* Unified Navigation Integration */ 
         .main-wrapper { 
           display: flex; 
           flex-direction: column; 
           min-height: 100vh; 
         } 
          
         .portal-content { 
           flex: 1; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           padding: 20px; 
         } 
          
         /* When authenticated, adjust layout */ 
         .authenticated .portal-content { 
           align-items: flex-start; 
           padding-top: 0; 
         } 
          
         /* Hide old navigation when unified nav is present */ 
         .authenticated .header { 
           display: none; 
         } 
          
         .authenticated .nav-tabs { 
           display: none; 
         } 
          
         .authenticated .container { 
           margin: 0; 
           border-radius: 0; 
           border: none; 
           box-shadow: none; 
           background: transparent; 
           max-width: none; 
           width: 100%; 
         } 
          
         /* Animations */ 
         @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}} 

         /* Math Placement Test Banner */ 
         .placement-banner { 
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
           border: 1px solid rgba(255, 255, 255, 0.1); 
           border-radius: 12px; 
           padding: 20px; 
           margin: 20px 0; 
           text-align: center; 
           color: white; 
           box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); 
         } 
          
         .placement-banner h3 { 
           margin-bottom: 10px; 
           font-size: 1.3rem; 
         } 
          
         .placement-banner p { 
           margin-bottom: 15px; 
           opacity: 0.9; 
         } 
          
         .placement-test-btn { 
           background: rgba(255, 255, 255, 0.2); 
           border: 2px solid rgba(255, 255, 255, 0.3); 
           color: white; 
           padding: 12px 24px; 
           border-radius: 8px; 
           font-size: 14px; 
           font-weight: 600; 
           cursor: pointer; 
           transition: all 0.2s ease; 
           text-decoration: none; 
           display: inline-block; 
         } 
          
         .placement-test-btn:hover { 
           background: rgba(255, 255, 255, 0.3); 
           border-color: rgba(255, 255, 255, 0.5); 
           transform: translateY(-2px); 
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); 
         } 
     </style> 
 </head> 
 <body> 
     <div class="main-wrapper"> 
                 <div id="unified-nav-container"></div> 
          
         <div class="portal-content"> 
             <div class="container"> 
                 <div class="header"> 
                     <h1>🎓 Student Learning Portal</h1> 
                     <p id="welcome-message">Welcome to your learning dashboard</p> 
                     <button class="logout-btn hidden" id="logout-btn">Logout</button> 
                 </div> 

                 <div class="nav-tabs"> 
                     <button class="nav-tab" id="login-tab">Login</button> 
                     <button class="nav-tab" id="dashboard-tab" style="display:none;">Dashboard</button> 
                     <button class="nav-tab" id="games-tab" style="display:none;">Games</button> 
                     <button class="nav-tab" id="skills-tab" style="display:none;">Skills</button> 
                     <button class="nav-tab" id="grades-tab" style="display:none;">Grades</button> 
                     <a class="nav-tab" id="portal-tab" href="portal/" style="display:none;">📚 Classes & Messaging</a> 
                 </div> 

                 <div class="content"> 
                                         <div id="login-section" class="hidden"> 
                         <div class="auth-form"> 
                             <h2>Student Portal Login</h2> 
                             <div id="auth-alerts"></div> 
                                                         <div class="placement-banner"> 
                                 <h3>📐 Math Placement Test</h3> 
                                 <p>Discover your math level and get personalized course recommendations</p> 
                                 <a href="tests/math-placement-test.html" class="placement-test-btn"> 
                                     🚀 Take Placement Test 
                                 </a> 
                             </div> 
                            <form id="login-form"> 
                                 <div class="form-group"> 
                                     <label for="email">Email Address</label> 
                                     <input type="email" id="email" required> 
                                 </div> 
                                 <div class="form-group"> 
                                     <label for="password">Password</label> 
                                     <input type="password" id="password" required> 
                                 </div> 
                                 <button type="submit" class="btn btn-primary" id="login-btn">Login</button> 
                                 <button type="button" class="btn btn-secondary" id="register-btn">Register New Account</button> 
                                 <p style="margin-top: 15px; text-align: center;"> 
                                     <a href="#" id="forgot-password-link" style="color: #4facfe;">Forgot Password?</a> 
                                 </p> 
                             </form> 

                             <form id="register-form" class="hidden"> 
                                 <h3>Create New Account</h3> 
                                 <div class="form-group"> 
                                     <label for="reg-email">Email Address</label> 
                                     <input type="email" id="reg-email" required> 
                                 </div> 
                                 <div class="form-group"> 
                                     <label for="reg-password">Password</label> 
                                     <input type="password" id="reg-password" required minlength="6"> 
                                 </div> 
                                 <div class="form-group"> 
                                     <label for="reg-username">Username</label> 
                                     <input type="text" id="reg-username" required> 
                                 </div> 
                                 <div class="form-group"> 
                                     <label for="reg-firstname">First Name</label> 
                                     <input type="text" id="reg-firstname" required> 
                                 </div> 
                                 <div class="form-group"> 
                                     <label for="reg-lastname">Last Name</label> 
                                     <input type="text" id="reg-lastname" required> 
                                 </div> 
                                 <div class="form-group"> 
                                     <label for="reg-usertype">Account Type</label> 
                                     <select id="reg-usertype" required> 
                                         <option value="student">Student</option> 
                                         <option value="parent">Parent</option> 
                                         <option value="teacher">Teacher</option> 
                                     </select> 
                                 </div> 
                                 <div class="form-group" id="grade-group"> 
                                     <label for="reg-grade">Grade Level (for students)</label> 
                                     <select id="reg-grade"> 
                                         <option value="">Select Grade</option> 
                                         <option value="K">Kindergarten</option> 
                                         <option value="1">1st Grade</option> 
                                         <option value="2">2nd Grade</option> 
                                         <option value="3">3rd Grade</option> 
                                         <option value="4">4th Grade</option> 
                                         <option value="5">5th Grade</option> 
                                         <option value="6">6th Grade</option> 
                                         <option value="7">7th Grade</option> 
                                         <option value="8">8th Grade</option> 
                                         <option value="9">9th Grade</option> 
                                         <option value="10">10th Grade</option> 
                                         <option value="11">11th Grade</option> 
                                         <option value="12">12th Grade</option> 
                                     </select> 
                                 </div> 
                                 <div class="form-group" id="child-email-group" style="display:none;"> 
                                     <label for="child-emails">Children's Email Addresses</label> 
                                     <textarea id="child-emails" rows="4" placeholder="Enter each child's email address on a separate line:&#10;child1@yourschool.edu&#10;child2@yourschool.edu&#10;child3@yourschool.edu" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea> 
                                     <small style="color: #666; font-size: 12px;">Enter one email address per line for each child's student account</small> 
                                 </div> 
                                 <button type="submit" class="btn btn-primary" id="register-submit-btn">Register</button> 
                                 <button type="button" class="btn btn-secondary" id="back-to-login-btn">Back to Login</button> 
                             </form> 
                         </div> 
                     </div> 

                                         <div id="dashboard-section" class="hidden"> 
                                             </div> 

                                         <div id="games-section" class="hidden"> 
                         <h2>🎮 Educational Games</h2> 
                         <div class="game-list"> 
                             <div class="game-card" data-game="mathletics"> 
                                 <h3>🎯 Mathletics</h3> 
                                 <p>Master multiplication facts through adaptive practice</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" id="mathletics-range">0-2</div> 
                                         <div class="stat-label">Current Range</div> 
                                     </div> 
                                     <div class="stat"> 
                                         <div class="stat-value" id="mathletics-mastery">Bronze</div> 
                                         <div class="stat-label">Mastery Level</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="word-wizard"> 
                                 <h3>📚 Word Wizard</h3> 
                                 <p>Spelling and vocabulary</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--warning);">Incomplete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="science-lab"> 
                                 <h3>🧪 Science Lab</h3> 
                                 <p>Fun science experiments</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--warning);">Incomplete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="history-quest"> 
                                 <h3>🏛️ History Quest</h3> 
                                 <p>Explore historical events</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--warning);">Incomplete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="practice-pilot"> 
                                 <h3>🚀 Practice Pilot</h3> 
                                 <p>Control a spaceship while shooting at math problems and Spanish translations!</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--accent-2);">Complete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="teacher-challenge"> 
                                 <h3>👩‍🏫 Teacher Challenge</h3> 
                                 <p>Talk to AI teachers as you complete challenges!</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--accent-2);">Complete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="dimension-shift"> 
                                 <h3>🌀 Dimension Shift</h3> 
                                 <p>Navigate through a maze in a mind-boggling 2.5 dimensional realm!</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--accent-2);">Complete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                             <div class="game-card" data-game="clockwork-defense"> 
                                 <h3>🕰️ Clockwork Defense</h3> 
                                 <p>Defend your clocktower by checking the time!</p> 
                                 <div class="stats"> 
                                     <div class="stat"> 
                                         <div class="stat-value" style="color: var(--accent-2);">Complete</div> 
                                         <div class="stat-label">Status</div> 
                                     </div> 
                                 </div> 
                             </div> 
                         </div> 
                          
                         <div id="game-iframe-container" class="hidden" style="margin-top: 30px;"> 
                             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;"> 
                                 <h3 id="current-game-title"></h3> 
                                 <button class="btn btn-secondary" id="close-game-btn">Close Game</button> 
                             </div> 
                             <iframe id="game-iframe" width="100%" height="500" frameborder="0"></iframe> 
                         </div> 
                     </div> 

                                         <div id="skills-section" class="hidden"> 
                         <h2>🌟 Skill Trees</h2> 
                         <div class="subject-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;"> 
                             <button class="btn btn-primary skill-tree-btn" data-subject="Art" style="margin-bottom: 10px;"> 
                                 🎨 Art 
                             </button> 
                             <button class="btn btn-primary skill-tree-btn" data-subject="Math" style="margin-bottom: 10px;"> 
                                 📐 Math 
                             </button> 
                             <button class="btn btn-primary skill-tree-btn" data-subject="Science" style="margin-bottom: 10px;"> 
                                 🔬 Science 
                             </button> 
                             <button class="btn btn-primary skill-tree-btn" data-subject="Reading" style="margin-bottom: 10px;"> 
                                 📚 Reading 
                             </button> 
                             <button class="btn btn-primary skill-tree-btn" data-subject="Programming" style="margin-bottom: 10px;"> 
                                 💻 Programming 
                             </button> 
                             <button class="btn btn-primary skill-tree-btn" data-subject="Robotics" style="margin-bottom: 10px;"> 
                                 🤖 Robotics 
                             </button> 
                         </div> 
                         <div id="skill-tree-container" style="width: 100%; height: 600px; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden; background: #f8f9fa;"> 
                             <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;"> 
                                 <div style="text-align: center;"> 
                                     <div style="font-size: 48px; margin-bottom: 20px;">🌟</div> 
                                     <h3>Select a Subject</h3> 
                                     <p>Choose a subject above to explore your skill tree</p> 
                                 </div> 
                             </div> 
                         </div> 
                     </div> 

                                         <div id="grades-section" class="hidden"> 
                         <h2>📊 Grades & Assignments</h2> 
                         <div id="grades-content"> 
                             <p>No grades available yet</p> 
                         </div> 
                     </div> 
                 </div> 
             </div> 
         </div> 
     </div> 

     <script> 
         // Enhanced StudentPortal class with unified integration 
         class StudentPortal { 
             constructor() { 
                 this.initialized = false; 
                 this.currentSection = 'dashboard'; 
                 this.eventListeners = new Set(); 
                 this.skillTreeIntegration = null; 
                  
                 // Wait for shared auth to be ready 
                 this.waitForAuth().then(() => { 
                     this.init(); 
                 }); 
             } 

             async waitForAuth() { 
                 // Wait for portalAuth to be initialized 
                 while (!window.portalAuth || !window.portalAuth.initialized) { 
                     await new Promise(resolve => setTimeout(resolve, 100)); 
                 } 
                 this.auth = window.portalAuth; 
             } 

             async init() { 
                 if (this.initialized) return; 
                 this.initialized = true; 
                  
                 console.log('🚀 Initializing StudentPortal with unified auth...'); 
                  
                 // Set up skill tree integration 
                 this.skillTreeIntegration = new SkillTreeIntegration(this); 
                 await this.skillTreeIntegration.initialize(); 
                  
                 // Set up event listeners 
                 this.setupEventListeners(); 
                  
                 // Listen for auth state changes 
                 window.addEventListener('portalAuthChange', (e) => { 
                     this.handleAuthStateChange(e.detail); 
                 }); 
                  
                 // Check initial auth state 
                 if (this.auth.isAuthenticated()) { 
                     this.showAuthenticatedState(); 
                 } else { 
                     this.showLoginForm(); 
                 } 
                  
                 // Handle hash navigation 
                 this.handleHashNavigation(); 
                 window.addEventListener('hashchange', () => this.handleHashNavigation()); 

                 // Handle messages from Mathletics iframe 
                 window.addEventListener('message', (event) => { 
                     if (event.data.action === 'closeGame') { 
                         this.closeGame(); 
                     } else if (event.data.action === 'progressUpdated') { 
                         // Refresh Mathletics progress display 
                         setTimeout(() => this.updateMathleticsProgress(), 1000); 
                     } 
                 }); 
                  
                 console.log('✅ StudentPortal initialized'); 
             } 

             handleAuthStateChange(detail) { 
                 if (detail.event === 'SIGNED_IN') { 
                     this.showAuthenticatedState(); 
                     window.PortalUI.showNotification(`Welcome back, ${detail.profile?.first_name || 'User'}!`, 'success'); 
                 } else if (detail.event === 'SIGNED_OUT') { 
                     this.showLoginForm(); 
                     document.body.classList.remove('authenticated'); 
                 } 
             } 

             showAuthenticatedState() { 
                 document.body.classList.add('authenticated'); 
                  
                 // Show unified navigation 
                 const navContainer = document.getElementById('unified-nav-container'); 
                 if (navContainer) { 
                     navContainer.innerHTML = window.PortalUI.createUnifiedNavigation('main', this.currentSection); 
                 } 
                  
                 // Hide login elements 
                 const loginSection = document.getElementById('login-section'); 
                 if (loginSection) loginSection.classList.add('hidden'); 
                  
                 // Show appropriate dashboard 
                 const userInfo = this.auth.getUserInfo(); 
                 if (userInfo.profile?.user_type === 'parent' || userInfo.profile?.user_type === 'teacher') { 
                     this.loadParentTeacherDashboard(); 
                 } else { 
                     this.loadStudentDashboard(); 
                     setTimeout(() => this.updateMathleticsProgress(), 500);  // Update Mathletics progress 
                 } 
                  
                 this.showTab('dashboard'); 
             } 

             showLoginForm() { 
                 document.body.classList.remove('authenticated'); 
                  
                 // Hide unified navigation 
                 const navContainer = document.getElementById('unified-nav-container'); 
                 if (navContainer) navContainer.innerHTML = ''; 
                  
                 // Show login 
                 this.showTab('login'); 
                 const loginForm = document.getElementById('login-form'); 
                 const registerForm = document.getElementById('register-form'); 
                 if (loginForm) loginForm.classList.remove('hidden'); 
                 if (registerForm) registerForm.classList.add('hidden'); 
             } 

             handleHashNavigation() { 
                 const hash = window.location.hash.substring(1); 
                 if (hash && this.auth.isAuthenticated()) { 
                     this.showTab(hash); 
                 } 
             } 

             setupEventListeners() { 
                 // Auth forms 
                 this.addSafeEventListener('login-form', 'submit', (e) => this.handleLogin(e)); 
                 this.addSafeEventListener('register-form', 'submit', (e) => this.handleRegister(e)); 
                  
                 // Auth navigation 
                 this.addSafeEventListener('register-btn', 'click', () => this.showRegisterForm()); 
                 this.addSafeEventListener('back-to-login-btn', 'click', () => this.showLoginForm()); 
                 this.addSafeEventListener('forgot-password-link', 'click', (e) => { 
                     e.preventDefault(); 
                     this.showForgotPasswordForm(); 
                 }); 
                  
                 // User type handling 
                 this.addSafeEventListener('reg-usertype', 'change', (e) => this.handleUserTypeChange(e)); 
                  
                 // Legacy tab navigation (for when not authenticated) 
                 this.addSafeEventListener('login-tab', 'click', () => this.showTab('login')); 
                 this.addSafeEventListener('dashboard-tab', 'click', () => this.showTab('dashboard')); 
                 this.addSafeEventListener('games-tab', 'click', () => this.showTab('games')); 
                 this.addSafeEventListener('skills-tab', 'click', () => this.showTab('skills')); 
                 this.addSafeEventListener('grades-tab', 'click', () => this.showTab('grades')); 
                  
                 // Game and skill interactions 
                 this.addGameCardListeners(); 
                 this.addSkillTreeListeners(); 
                 this.addSafeEventListener('close-game-btn', 'click', () => this.closeGame()); 
                  
                 // Legacy logout 
                 this.addSafeEventListener('logout-btn', 'click', () => this.auth.logout()); 
             } 

             addSafeEventListener(elementId, event, handler) { 
                 const element = document.getElementById(elementId); 
                 if (element) { 
                     const listenerKey = `${elementId}-${event}`; 
                     if (this.eventListeners.has(listenerKey)) { 
                         element.removeEventListener(event, handler); 
                     } 
                     element.addEventListener(event, handler); 
                     this.eventListeners.add(listenerKey); 
                 } 
             } 

             async handleLogin(e) { 
                 e.preventDefault(); 
                  
                 const email = document.getElementById('email')?.value; 
                 const password = document.getElementById('password')?.value; 
                 const loginBtn = document.getElementById('login-btn'); 

                 if (!email || !password) { 
                     window.PortalUI.showNotification('Please enter email and password', 'error'); 
                     return; 
                 } 

                 if (loginBtn) { 
                     loginBtn.disabled = true; 
                     loginBtn.textContent = 'Logging in...'; 
                 } 

                 try { 
                     const { data, error } = await this.auth.supabase.auth.signInWithPassword({ 
                         email: email, 
                         password: password 
                     }); 

                     if (error) throw error; 
                     // Success is handled by auth state change listener 
                 } catch (error) { 
                     console.error('Login error:', error); 
                     window.PortalUI.showNotification(error.message, 'error'); 
                 } finally { 
                     if (loginBtn) { 
                         loginBtn.disabled = false; 
                         loginBtn.textContent = 'Login'; 
                     } 
                 } 
             } 

             async handleRegister(e) { 
                 e.preventDefault(); 
                  
                 const email = document.getElementById('reg-email')?.value; 
                 const password = document.getElementById('reg-password')?.value; 
                 const username = document.getElementById('reg-username')?.value; 
                 const firstName = document.getElementById('reg-firstname')?.value; 
                 const lastName = document.getElementById('reg-lastname')?.value; 
                 const grade = document.getElementById('reg-grade')?.value; 
                 const userType = document.getElementById('reg-usertype')?.value; 

                 const registerBtn = document.getElementById('register-submit-btn'); 

                 if (!email || !password || !username || !firstName || !lastName || !userType) { 
                     window.PortalUI.showNotification('Please fill in all required fields', 'error'); 
                     return; 
                 } 

                 if (registerBtn) { 
                     registerBtn.disabled = true; 
                     registerBtn.textContent = 'Registering...'; 
                 } 

                 try { 
                     const { data: authData, error: authError } = await this.auth.supabase.auth.signUp({ 
                         email: email, 
                         password: password 
                     }); 

                     if (authError) throw authError; 

                     const { error: profileError } = await this.auth.supabase 
                         .from('user_profiles') 
                         .insert({ 
                             id: authData.user.id, 
                             email: email, 
                             username: username, 
                             first_name: firstName, 
                             last_name: lastName, 
                             user_type: userType, 
                             grade_level: userType === 'student' ? grade : null 
                         }); 

                     if (profileError) throw profileError; 

                     window.PortalUI.showNotification('Registration successful! Please check your email to verify your account.', 'success'); 
                     this.showLoginForm(); 

                 } catch (error) { 
                     console.error('Registration error:', error); 
                     window.PortalUI.showNotification(error.message, 'error'); 
                 } finally { 
                     if (registerBtn) { 
                         registerBtn.disabled = false; 
             _BOS_
