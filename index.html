<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Learning Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
       :root{
          --bg:#0f1216;
          --card:#151a21;
          --text:#e6edf3;
          --muted:#97a2b0;
          --accent:#6aa9ff;
          --accent-2:#8bffb0;
          --danger:#ff6a6a;
          --warning:#ffd36a;
          --link:#a0c2ff;
          --border:#2a3140;
        }
        
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%}
        body{
          font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell;
          background:var(--bg);
          color:var(--text);
          display:flex;align-items:center;justify-content:center;
          -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
        }
        
        /* Shell */
        .container{
          background:var(--card);
          border:1px solid var(--border);
          border-radius:16px;
          width:100%; max-width:1200px; min-height:600px; overflow:hidden;
          box-shadow:0 10px 30px rgba(0,0,0,.35);
        }
        
        /* Header */
        .header{
          background:rgba(0,0,0,.25);
          border-bottom:1px solid var(--border);
          color:var(--text);
          padding:16px 20px;
          text-align:center;
          position:relative;
        }
        .header h1{font-size:20px;letter-spacing:.3px}
        #welcome-message{opacity:.85}
        .logout-btn{
          position:absolute; right:20px; top:50%; transform:translateY(-50%);
          background:#0c1118; border:1px solid #223041; color:#e5e7eb;
          padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer;
        }
        .logout-btn:hover{border-color:var(--accent-2); box-shadow:0 0 0 2px rgba(139,255,176,.08)}
        
        /* Top nav tabs */
        .nav-tabs{
          display:flex; gap:0; background:#0c1118; border-bottom:1px solid var(--border);
        }
        .nav-tab{
          flex:1; padding:12px 14px; text-align:center; cursor:pointer; border:0;
          background:transparent; color:#c7d2fe;
          transition:color .15s ease, background-color .15s ease, border-color .15s ease;
          display: inline-block; /* Ensure both buttons and links display properly */
          text-decoration: none; /* Remove underline from links */
          font-family: inherit;
          font-size: inherit;
        }
        .nav-tab:hover{background:rgba(255,255,255,.02); color:#a5b4fc}
        .nav-tab.active{
          color:var(--accent); font-weight:700; border-bottom:3px solid var(--accent); background:#0b0f14;
        }
        
        /* Content area */
        .content{padding:20px; min-height:400px}
        
        /* Cards & layout */
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-top:16px}
        .card{
          background:#0c1118;
          border:1px solid #223041;
          border-radius:12px; padding:16px;
          box-shadow:0 6px 16px rgba(0,0,0,.25);
        }
        .card h3{margin-bottom:8px}
        
        /* Forms */
        .form-group{margin-bottom:14px; text-align:left}
        .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--text)}
        .form-group input,.form-group select, .form-group textarea{
          width:100%; padding:10px 12px; border-radius:10px;
          background:#0e1319; color:var(--text); border:1px solid var(--border); font-size:14px;
        }
        .auth-form{max-width:400px;margin:0 auto;text-align:center}
        
        /* Buttons ‚Äî cyber dark base, with filled primary */
        .btn{
          appearance:none; border:1px solid #223041; background:#0c1118; color:#e5e7eb;
          padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer;
          transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease, transform .02s ease;
        }
        .btn:hover{border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.1), inset 0 0 0 1px rgba(57,255,136,.15); background:#0b0f14}
        .btn:active{transform:translateY(0)}
        .btn.small{padding:4px 8px; font-size:11px; letter-spacing:.09em}
        
        .btn-primary{
          background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
          color:#0b0f14; border-color:transparent;
        }
        .btn-primary:hover{filter:brightness(1.05)}
        .btn-secondary{background:#2b3442;color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{border-color:var(--accent)}
        
        .btn-danger{background:#dc3545;color:#fff;border:1px solid #dc3545}
        .btn-danger:hover{background:#c82333;border-color:#bd2130; box-shadow:0 0 0 2px rgba(220,53,69,.25)}
        
        .hidden{display:none}
        
        /* Alerts */
        .alert{padding:12px;border-radius:8px;margin:12px 0;border:1px solid var(--border)}
        .alert-success{background:rgba(139,255,176,.08); color:#b5ffd0; border-color:rgba(139,255,176,.25)}
        .alert-error{background:rgba(255,107,107,.08); color:#ffb3b3; border-color:rgba(255,107,107,.25)}
        
        /* Stats */
        .stats{display:flex;justify-content:space-between;gap:12px;margin:10px 0}
        .stat{text-align:center}
        .stat-value{font-size:22px;font-weight:700;color:var(--accent)}
        .stat-label{font-size:12px;color:var(--muted)}
        
        /* Progress */
        .progress-bar{background:#0e1319;border:1px solid var(--border);border-radius:10px;height:16px;overflow:hidden;margin:10px 0}
        .progress-fill{background:linear-gradient(90deg,var(--accent),var(--accent-2));height:100%;border-radius:10px;transition:width .3s ease}
        
        /* Game grid/cards */
        .game-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:16px}
        .game-card{
          background:#0b1017; border:1px solid #1a2330; color:#e5e7eb;
          border-radius:12px; padding:16px; text-align:center; cursor:pointer; transition:transform .2s ease, border-color .15s ease, box-shadow .15s ease;
        }
        .game-card:hover{transform:translateY(-4px); border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.08)}
        
        /* Tables */
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
        
        /* Links */
        a{color:var(--link)}
        a:hover{color:var(--accent)}
        
        /* Animations */
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Student Learning Portal</h1>
            <p id="welcome-message">Welcome to your learning dashboard</p>
            <button class="logout-btn hidden" id="logout-btn">Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab" id="login-tab">Login</button>
            <button class="nav-tab" id="dashboard-tab" style="display:none;">Dashboard</button>
            <button class="nav-tab" id="games-tab" style="display:none;">Games</button>
            <button class="nav-tab" id="skills-tab" style="display:none;">Skills</button>
            <button class="nav-tab" id="grades-tab" style="display:none;">Grades</button>
            <a class="nav-tab" id="portal-tab" href="portal/" style="display:none;">üìö Classes & Messaging</a>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="login-section" class="hidden">
                <div class="auth-form">
                    <h2>Student Portal Login</h2>
                    <div id="auth-alerts"></div>
                    
                   <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                        <button type="button" class="btn btn-secondary" id="register-btn">Register New Account</button>
                        <p style="margin-top: 15px; text-align: center;">
                            <a href="#" id="forgot-password-link" style="color: #4facfe;">Forgot Password?</a>
                        </p>
                    </form>

                    <form id="register-form" class="hidden">
                        <h3>Create New Account</h3>
                        <div class="form-group">
                            <label for="reg-email">Email Address</label>
                            <input type="email" id="reg-email" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-password">Password</label>
                            <input type="password" id="reg-password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="reg-username">Username</label>
                            <input type="text" id="reg-username" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-firstname">First Name</label>
                            <input type="text" id="reg-firstname" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-lastname">Last Name</label>
                            <input type="text" id="reg-lastname" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-usertype">Account Type</label>
                            <select id="reg-usertype" required>
                                <option value="student">Student</option>
                                <option value="parent">Parent</option>
                                <option value="teacher">Teacher</option>
                            </select>
                        </div>
                        <div class="form-group" id="grade-group">
                            <label for="reg-grade">Grade Level (for students)</label>
                            <select id="reg-grade">
                                <option value="">Select Grade</option>
                                <option value="K">Kindergarten</option>
                                <option value="1">1st Grade</option>
                                <option value="2">2nd Grade</option>
                                <option value="3">3rd Grade</option>
                                <option value="4">4th Grade</option>
                                <option value="5">5th Grade</option>
                                <option value="6">6th Grade</option>
                                <option value="7">7th Grade</option>
                                <option value="8">8th Grade</option>
                                <option value="9">9th Grade</option>
                                <option value="10">10th Grade</option>
                                <option value="11">11th Grade</option>
                                <option value="12">12th Grade</option>
                            </select>
                        </div>
                        <div class="form-group" id="child-email-group" style="display:none;">
                            <label for="child-emails">Children's Email Addresses</label>
                            <textarea id="child-emails" rows="4" placeholder="Enter each child's email address on a separate line:&#10;child1@yourschool.edu&#10;child2@yourschool.edu&#10;child3@yourschool.edu" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
                            <small style="color: #666; font-size: 12px;">Enter one email address per line for each child's student account</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="register-submit-btn">Register</button>
                        <button type="button" class="btn btn-secondary" id="back-to-login-btn">Back to Login</button>
                    </form>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="hidden">
                <h2>Welcome back, <span id="student-name">Student</span>!</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>üìä Quick Stats</h3>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value" id="games-played">0</div>
                                <div class="stat-label">Games Played</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="total-score">0</div>
                                <div class="stat-label">High Score</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="achievements">0</div>
                                <div class="stat-label">Skills Unlocked</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üéØ Recent Activity</h3>
                        <div id="recent-activity">
                            <p>No recent activity</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üìà Learning Progress</h3>
                        <div>
                            <p>Math Skills</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                            <p>Reading Comprehension</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üë§ Profile Settings</h3>
                        <p style="margin-bottom: 15px;">Manage your account</p>
                        <button class="btn btn-secondary" id="edit-profile-btn" style="margin-bottom: 10px; width: 100%;">
                            ‚úèÔ∏è Edit Profile
                        </button>
                        <button class="btn btn-secondary" id="change-password-btn" style="margin-bottom: 20px; width: 100%;">
                            üîí Change Password
                        </button>
                        <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
                        <h4 style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è Danger Zone</h4>
                        <button class="btn btn-danger" id="delete-account-btn" style="width: 100%;">
                            üóëÔ∏è Delete My Account
                        </button>
                        <small style="display: block; color: #666; margin-top: 10px;">
                            This action cannot be undone. All your data will be permanently deleted.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Games Section -->
            <div id="games-section" class="hidden">
                <h2>üéÆ Educational Games</h2>
                <div class="game-list">
                    <div class="game-card" data-game="math-adventure">
                        <h3>üî¢ Math Adventure</h3>
                        <p>Practice arithmetic skills</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">Level 1</div>
                                <div class="stat-label">Current Level</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card" data-game="word-wizard">
                        <h3>üìö Word Wizard</h3>
                        <p>Spelling and vocabulary</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">Level 1</div>
                                <div class="stat-label">Current Level</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card" data-game="science-lab">
                        <h3>üß™ Science Lab</h3>
                        <p>Fun science experiments</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">Level 1</div>
                                <div class="stat-label">Current Level</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card" data-game="history-quest">
                        <h3>üèõÔ∏è History Quest</h3>
                        <p>Explore historical events</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">New!</div>
                                <div class="stat-label">Try it out</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="game-iframe-container" class="hidden" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="current-game-title"></h3>
                        <button class="btn btn-secondary" id="close-game-btn">Close Game</button>
                    </div>
                    <iframe id="game-iframe" width="100%" height="500" frameborder="0"></iframe>
                </div>
            </div>

            <!-- Skills Section -->
            <div id="skills-section" class="hidden">
                <h2>üåü Skill Trees</h2>
                <div class="subject-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary skill-tree-btn" data-subject="Art" style="margin-bottom: 10px;">
                        üé® Art
                    </button>
                    <button class="btn btn-primary skill-tree-btn" data-subject="Math" style="margin-bottom: 10px;">
                        üìê Math
                    </button>
                    <button class="btn btn-primary skill-tree-btn" data-subject="Science" style="margin-bottom: 10px;">
                        üî¨ Science
                    </button>
                    <button class="btn btn-primary skill-tree-btn" data-subject="Reading" style="margin-bottom: 10px;">
                        üìö Reading
                    </button>
                    <button class="btn btn-primary skill-tree-btn" data-subject="Programming" style="margin-bottom: 10px;">
                        üíª Programming
                    </button>
                    <button class="btn btn-primary skill-tree-btn" data-subject="Robotics" style="margin-bottom: 10px;">
                        ü§ñ Robotics
                    </button>
                </div>
                <div id="skill-tree-container" style="width: 100%; height: 600px; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden; background: #f8f9fa;">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üåü</div>
                            <h3>Select a Subject</h3>
                            <p>Choose a subject above to explore your skill tree</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="hidden">
                <h2>üìà Learning Progress</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>Subject Progress</h3>
                        <div id="subject-progress">
                            <p>Loading progress data...</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üèÜ Achievements</h3>
                        <div id="achievements-list">
                            <p>No achievements yet. Keep playing!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grades Section -->
            <div id="grades-section" class="hidden">
                <h2>üìä Grades & Assignments</h2>
                <div id="grades-content">
                    <p>No grades available yet</p>
                </div>
            </div>

            <!-- Children Section (Parents/Teachers only) -->
            <div id="children-section" class="hidden">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h2>
                <div class="dashboard" id="children-dashboard">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // SkillTreeIntegration class definition (moved before StudentPortal)
        class SkillTreeIntegration {
            constructor(portal) {
                this.portal = portal;
                this.skillProgress = {};
                this.currentSubject = null;
                this.skillTreeFrame = null;
                
                // Define all available subjects and their metadata
                this.subjects = {
                    'Art': { emoji: 'üé®', totalSkills: 75 },
                    'Math': { emoji: 'üìê', totalSkills: 22 },
                    'Science': { emoji: 'üî¨', totalSkills: 20 },
                    'Reading': { emoji: 'üìö', totalSkills: 19 },
                    'Programming': { emoji: 'üíª', totalSkills: 56 },
                    'Robotics': { emoji: 'ü§ñ', totalSkills: 96 }
                };
            }
        
            async initialize() {
                // Set up message listener first
                this.setupMessageListener();
                
                // Only try to load skill progress if we have an authenticated user
                if (this.portal.currentUser && this.portal.supabase) {
                    await this.loadAllSkillProgress();
                } else {
                    // Initialize empty progress for all subjects
                    console.log('üìä Initializing empty skill progress (no authenticated user yet)');
                    Object.keys(this.subjects).forEach(subject => {
                        this.skillProgress[subject] = {};
                    });
                }
            }

            setupMessageListener() {
                // Remove any existing listener
                if (window.skillTreeMessageHandler) {
                    window.removeEventListener('message', window.skillTreeMessageHandler);
                }
                
                // Create new handler
                window.skillTreeMessageHandler = async (event) => {
                    // Only process messages from our own origin
                    if (event.origin !== window.location.origin) return;
                    
                    console.log('üì® Received message:', event.data?.type);
                    
                    switch (event.data?.type) {
                        case 'SKILL_UNLOCKED':
                            await this.handleSkillUnlock(event.data);
                            break;
                        case 'REQUEST_SKILL_DATA':
                            await this.sendSkillData(event.data.subject);
                            break;
                        case 'SAVE_PROGRESS':
                            await this.saveSkillProgress(event.data.subject, event.data.progress);
                            break;
                    }
                };
                
                window.addEventListener('message', window.skillTreeMessageHandler);
            }
        
            async loadAllSkillProgress() {
                try {
                    // Check if we have an authenticated user
                    if (!this.portal.currentUser || !this.portal.supabase) {
                        console.log('üìä No authenticated user - initializing empty progress');
                        Object.keys(this.subjects).forEach(subject => {
                            this.skillProgress[subject] = {};
                        });
                        return;
                    }
                    
                    const { data, error } = await this.portal.supabase
                        .from('student_skill_progress')
                        .select('subject, skill_states, total_unlocked')
                        .eq('student_id', this.portal.currentUser.id);
                    
                    if (error) {
                        // Don't throw on 401 or other errors, just initialize empty
                        if (error.code === 'PGRST301' || error.status === 401) {
                            console.log('üìä Not authenticated yet - will load progress after login');
                        } else {
                            console.warn('Error loading skill progress:', error.message);
                        }
                        // Initialize empty progress as fallback
                        Object.keys(this.subjects).forEach(subject => {
                            this.skillProgress[subject] = {};
                        });
                        return;
                    }
                    
                    // Initialize all subjects with empty progress
                    Object.keys(this.subjects).forEach(subject => {
                        this.skillProgress[subject] = {};
                    });
                    
                    // Load saved progress
                    if (data && data.length > 0) {
                        data.forEach(record => {
                            if (record.subject && record.skill_states) {
                                this.skillProgress[record.subject] = record.skill_states;
                                console.log(`‚úÖ Loaded ${record.total_unlocked} unlocked skills for ${record.subject}`);
                            }
                        });
                    }
                    
                    console.log('üìä All skill progress loaded:', this.skillProgress);
                } catch (error) {
                    console.error('Error loading skill progress:', error);
                    // Initialize empty progress as fallback
                    Object.keys(this.subjects).forEach(subject => {
                        this.skillProgress[subject] = {};
                    });
                }
            }

            async loadSkillTree(subject) {
                if (!this.subjects[subject]) {
                    console.error('Invalid subject:', subject);
                    return;
                }
                
                this.currentSubject = subject;
                const container = document.getElementById('skill-tree-container');
                if (!container) return;
                
                // Show loading state
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #0a0a2e;">
                        <div style="text-align: center; color: #d4af37;">
                            <div style="font-size: 48px; margin-bottom: 20px;">${this.subjects[subject].emoji}</div>
                            <div style="font-size: 20px;">Loading ${subject} Skill Tree...</div>
                            <div style="margin-top: 10px; font-size: 14px; opacity: 0.7;">Preparing your learning constellation</div>
                        </div>
                    </div>
                `;
                
                // Ensure progress is loaded for this subject
                if (!this.skillProgress[subject]) {
                    await this.loadSubjectProgress(subject);
                }

                // Create iframe with skill tree
                setTimeout(() => {
                    container.innerHTML = `
                        <iframe 
                            id="skill-tree-frame"
                            src="SkillTreeViewer.html?subject=${encodeURIComponent(subject)}"
                            style="width: 100%; height: 100%; border: none;"
                            frameborder="0"
                            allow="fullscreen"
                        ></iframe>
                    `;
                    
                    this.skillTreeFrame = document.getElementById('skill-tree-frame');
                    
                    if (this.skillTreeFrame) {
                        this.skillTreeFrame.onload = () => {
                            // Wait for iframe to fully initialize
                            setTimeout(() => {
                                this.sendSkillData(subject);
                            }, 500);
                        };
                        
                        this.skillTreeFrame.onerror = (error) => {
                            console.error('Error loading skill tree:', error);
                            container.innerHTML = `
                                <div style="text-align: center; padding: 50px; color: #dc3545;">
                                    <h3>Error Loading Skill Tree</h3>
                                    <p>Could not load the skill tree viewer.</p>
                                    <button class="btn btn-primary" onclick="portal.skillTreeIntegration.loadSkillTree('${subject}')">
                                        Try Again
                                    </button>
                                </div>
                            `;
                        };
                    }
                }, 100);
            }

            async loadSubjectProgress(subject) {
                if (!this.portal.currentUser || !this.portal.supabase) {
                    this.skillProgress[subject] = {};
                    return;
                }
                
                try {
                    const { data, error } = await this.portal.supabase
                        .from('student_skill_progress')
                        .select('skill_states, total_unlocked')
                        .eq('student_id', this.portal.currentUser.id)
                        .eq('subject', subject)
                        .maybeSingle();
                    
                    if (error) {
                        // Handle 401 gracefully
                        if (error.code === 'PGRST301' || error.status === 401) {
                            console.log(`üìù Not authenticated - starting with empty progress for ${subject}`);
                        } else {
                            console.warn(`Error loading ${subject} progress:`, error.message);
                        }
                        this.skillProgress[subject] = {};
                        return;
                    }
                    
                    if (data && data.skill_states) {
                        this.skillProgress[subject] = data.skill_states;
                        console.log(`‚úÖ Loaded progress for ${subject}: ${data.total_unlocked} skills unlocked`);
                    } else {
                        this.skillProgress[subject] = {};
                        console.log(`üìù No saved progress for ${subject}, starting fresh`);
                    }
                } catch (error) {
                    console.error(`Error loading ${subject} progress:`, error);
                    this.skillProgress[subject] = {};
                }
            }

            async sendSkillData(subject) {
                if (!this.skillTreeFrame || !this.skillTreeFrame.contentWindow) {
                    console.error('Skill tree frame not ready');
                    return;
                }
                
                const progress = this.skillProgress[subject] || {};
                
                // Ensure we're only sending serializable data
                const message = {
                    type: 'SKILL_DATA_RESPONSE',
                    subject: subject,
                    progress: JSON.parse(JSON.stringify(progress)), // Ensure it's serializable
                    timestamp: Date.now()
                };
                
                console.log(`üì§ Sending skill data for ${subject}:`, message);
                
                try {
                    this.skillTreeFrame.contentWindow.postMessage(message, '*');
                } catch (postError) {
                    console.error('Error posting message to iframe:', postError);
                }
            }

            async handleSkillUnlock(data) {
                try {
                    const { subject, skillName, state } = data;
                    
                    console.log(`üéØ Skill unlock: ${skillName} in ${subject} -> ${state}`);
                    
                    // Update local progress
                    if (!this.skillProgress[subject]) {
                        this.skillProgress[subject] = {};
                    }
                    this.skillProgress[subject][skillName] = state;
                    
                    // Show notification
                    this.showSkillUnlockNotification(skillName, subject);
                    
                    // Save to database
                    await this.saveSkillProgress(subject, this.skillProgress[subject]);
                    
                    // Send updated progress back to iframe
                    if (this.skillTreeFrame && this.skillTreeFrame.contentWindow) {
                        const updateMessage = {
                            type: 'PROGRESS_UPDATED',
                            subject: subject,
                            progress: JSON.parse(JSON.stringify(this.skillProgress[subject])), // Ensure serializable
                            unlockedSkill: skillName,
                            timestamp: Date.now()
                        };
                        
                        try {
                            this.skillTreeFrame.contentWindow.postMessage(updateMessage, '*');
                        } catch (postError) {
                            console.error('Error posting update message to iframe:', postError);
                        }
                    }
                    
                    // Update dashboard stats
                    this.updateDashboardStats();
                    
                } catch (error) {
                    console.error('Error handling skill unlock:', error);
                }
            }

            async saveSkillProgress(subject, skillStates) {
                if (!this.portal.currentUser || !this.portal.supabase) {
                    console.log('Cannot save progress: no authenticated user');
                    return;
                }
                
                try {
                    // Ensure skill states are serializable
                    const cleanSkillStates = JSON.parse(JSON.stringify(skillStates));
                    const totalUnlocked = Object.values(cleanSkillStates).filter(s => s === 'activated').length;
                    
                    const { data, error } = await this.portal.supabase
                        .from('student_skill_progress')
                        .upsert({
                            student_id: this.portal.currentUser.id,
                            subject: subject,
                            skill_states: cleanSkillStates,
                            total_unlocked: totalUnlocked,
                            last_updated: new Date().toISOString()
                        }, {
                            onConflict: 'student_id,subject'
                        });
                    
                    if (error) {
                        // Handle 401 gracefully
                        if (error.code === 'PGRST301' || error.status === 401) {
                            console.warn('Not authenticated - progress saved locally only');
                        } else {
                            console.error('Supabase upsert error:', error.message);
                        }
                        return;
                    }
                    
                    console.log(`üíæ Saved progress: ${totalUnlocked}/${this.subjects[subject]?.totalSkills || '?'} skills in ${subject}`);
                    
                } catch (error) {
                    console.error('Error saving skill progress:', error.message || error);
                    // Could implement retry logic here
                }
            }

            showSkillUnlockNotification(skillName, subject) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 12px;
                    box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
                    z-index: 10000;
                    max-width: 350px;
                    animation: slideIn 0.3s ease-out;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                `;
                
                const emoji = this.subjects[subject]?.emoji || 'üåü';
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 32px;">${emoji}</div>
                        <div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Skill Unlocked!</div>
                            <div style="font-size: 14px; opacity: 0.95;">${skillName}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 2px;">${subject}</div>
                        </div>
                    </div>
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); border-radius: 0 0 12px 12px; overflow: hidden;">
                        <div style="height: 100%; background: white; animation: progress 4s linear;"></div>
                    </div>
                `;
                
                // Add CSS animation if not already present
                if (!document.getElementById('skill-notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'skill-notification-styles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(400px); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes progress {
                            from { width: 100%; }
                            to { width: 0%; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(notification);
                
                // Play a sound if available
                this.playUnlockSound();
                
                // Remove after animation
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 4000);
            }

            playUnlockSound() {
                // Optional: Add a pleasant unlock sound
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    // Silent fail if audio not available
                }
            }

            updateDashboardStats() {
                // Calculate total progress across all subjects
                let totalUnlocked = 0;
                let totalPossible = 0;
                
                Object.entries(this.skillProgress).forEach(([subject, skills]) => {
                    const unlocked = Object.values(skills).filter(s => s === 'activated').length;
                    totalUnlocked += unlocked;
                    totalPossible += this.subjects[subject]?.totalSkills || 0;
                });
                
                // Update dashboard if visible
                const achievementsEl = document.getElementById('achievements');
                if (achievementsEl) {
                    achievementsEl.textContent = totalUnlocked.toString();
                }
                
                // Update progress bars if on dashboard
                if (document.getElementById('dashboard-section') && !document.getElementById('dashboard-section').classList.contains('hidden')) {
                    this.updateProgressBars();
                }
            }

            updateProgressBars() {
                // This would update visual progress bars on the dashboard
                // Implementation depends on your dashboard design
            }
        
            async getProgressSummary() {
                const summary = {};
                
                for (const [subject, skills] of Object.entries(this.skillProgress)) {
                    const total = this.subjects[subject]?.totalSkills || 0;
                    const unlocked = Object.values(skills).filter(s => s === 'activated').length;
                    
                    summary[subject] = {
                        unlocked: unlocked,
                        total: total,
                        percentage: total > 0 ? Math.round((unlocked / total) * 100) : 0
                    };
                }
                
                return summary;
            }
        }

        // StudentPortal class definition
        class StudentPortal {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.userProfile = null;
                this.skillProgress = {};
                this.initialized = false;
                this.eventListeners = new Set();
                this.skillTreeIntegration = new SkillTreeIntegration(this);
                
                // Immediately show login and start initialization
                this.safeShowLoginForm();
                this.init();
            }

            async init() {
                if (this.initialized) return;
                this.initialized = true;
                
                console.log('Initializing StudentPortal...');
                
                // Set up all event listeners first
                this.setupEventListeners();
                
                // Initialize skill tree integration
                await this.skillTreeIntegration.initialize();
                
                // Then handle background tasks with proper delays to prevent race conditions
                setTimeout(() => this.handleAuthCallback(), 100);
                setTimeout(() => this.initializeSupabase(), 300);
                
                console.log('StudentPortal initialized');
            }

            setupEventListeners() {
                try {
                    // Clear existing listeners
                    this.eventListeners.clear();
                    
                    // Main navigation tabs
                    this.addSafeEventListener('dashboard-tab', 'click', () => this.showTab('dashboard'));
                    this.addSafeEventListener('games-tab', 'click', () => this.showTab('games'));
                    this.addSafeEventListener('skills-tab', 'click', () => this.showTab('skills'));
                    this.addSafeEventListener('grades-tab', 'click', () => this.showTab('grades'));
                    this.addSafeEventListener('login-tab', 'click', () => this.showTab('login'));
                    
                    // Note: Portal tab is a link, not a button, so it navigates directly
                    
                    // Auth forms
                    this.addSafeEventListener('login-form', 'submit', (e) => this.handleLogin(e));
                    this.addSafeEventListener('register-form', 'submit', (e) => this.handleRegister(e));
                    
                    // Auth navigation buttons
                    this.addSafeEventListener('register-btn', 'click', () => this.showRegisterForm());
                    this.addSafeEventListener('back-to-login-btn', 'click', () => this.showLoginForm());
                    this.addSafeEventListener('forgot-password-link', 'click', (e) => {
                        e.preventDefault();
                        this.showForgotPasswordForm();
                    });
                    
                    // User type change handler
                    this.addSafeEventListener('reg-usertype', 'change', (e) => this.handleUserTypeChange(e));
                    
                    // Logout button
                    this.addSafeEventListener('logout-btn', 'click', () => this.logout());
                    
                    // Account management
                    this.addSafeEventListener('delete-account-btn', 'click', () => this.deleteAccount());
                    this.addSafeEventListener('edit-profile-btn', 'click', () => this.showEditProfileForm());
                    this.addSafeEventListener('change-password-btn', 'click', () => this.showChangePasswordForm());
                    
                    // Game cards
                    this.addGameCardListeners();
                    
                    // Skill tree buttons
                    this.addSkillTreeListeners();
                    
                    // Close game button
                    this.addSafeEventListener('close-game-btn', 'click', () => this.closeGame());
                    
                    console.log('Event listeners set up successfully');
                } catch (error) {
                    console.error('Event listener setup error:', error);
                }
            }

            addSafeEventListener(elementId, event, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    const listenerKey = `${elementId}-${event}`;
                    
                    // Remove existing listener if it exists
                    if (this.eventListeners.has(listenerKey)) {
                        element.removeEventListener(event, handler);
                    }
                    
                    element.addEventListener(event, handler);
                    this.eventListeners.add(listenerKey);
                }
            }

            addGameCardListeners() {
                const gameCards = document.querySelectorAll('.game-card');
                gameCards.forEach(card => {
                    const gameId = card.getAttribute('data-game');
                    if (gameId) {
                        card.addEventListener('click', () => this.playGame(gameId));
                    }
                });
            }

            addSkillTreeListeners() {
                const skillButtons = document.querySelectorAll('.skill-tree-btn');
                skillButtons.forEach(button => {
                    const subject = button.getAttribute('data-subject');
                    if (subject) {
                        button.addEventListener('click', () => this.loadSkillTree(subject));
                    }
                });
            }

            async loadSkillTree(subject) {
                await this.skillTreeIntegration.loadSkillTree(subject);
            }

            handleUserTypeChange(e) {
                const userType = e.target.value;
                const isStudent = userType === 'student';
                const isParent = userType === 'parent';
                
                const gradeGroup = document.getElementById('grade-group');
                const childEmailGroup = document.getElementById('child-email-group');
                const gradeField = document.getElementById('reg-grade');
                const childEmailsField = document.getElementById('child-emails');
                
                if (gradeGroup) gradeGroup.style.display = isStudent ? 'block' : 'none';
                if (childEmailGroup) childEmailGroup.style.display = isParent ? 'block' : 'none';
                
                if (gradeField) gradeField.required = isStudent;
                if (childEmailsField) childEmailsField.required = isParent;
            }

            safeShowLoginForm() {
                try {
                    // Show login tab
                    const loginTab = document.getElementById('login-tab');
                    if (loginTab) loginTab.style.display = 'inline-block';
                    
                    this.showTab('login');
                } catch (error) {
                    console.error('Error showing login form:', error);
                    // Fallback: just show the login section
                    const loginSection = document.getElementById('login-section');
                    if (loginSection) {
                        loginSection.classList.remove('hidden');
                    }
                    const loginTab = document.getElementById('login-tab');
                    if (loginTab) loginTab.style.display = 'inline-block';
                }
            }

            showLoginForm() {
                // Show login tab
                const loginTab = document.getElementById('login-tab');
                if (loginTab) loginTab.style.display = 'inline-block';
                
                this.showTab('login');
                
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
            }

            showRegisterForm() {
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
            }

            handleAuthCallback() {
                try {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const accessToken = hashParams.get('access_token');
                    const refreshToken = hashParams.get('refresh_token');
                    const type = hashParams.get('type');
                    const error = hashParams.get('error');
                    const errorCode = hashParams.get('error_code');
                    const errorDescription = hashParams.get('error_description');
                    
                    if (error || errorCode) {
                        window.history.replaceState(null, '', window.location.pathname);
                        
                        if (errorCode === 'otp_expired') {
                            this.showAlert('Password reset link has expired. Please request a new one.', 'error');
                            this.showForgotPasswordForm();
                        } else {
                            this.showAlert(errorDescription || 'An error occurred. Please try again.', 'error');
                        }
                        return;
                    }
                    
                    if (type === 'recovery') {
                        window.history.replaceState(null, '', window.location.pathname);
                        sessionStorage.setItem('pending_password_reset', 'true');
                        return;
                    }
                    
                    if (accessToken && refreshToken) {
                        window.history.replaceState(null, '', window.location.pathname);
                        
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success';
                        alertDiv.textContent = 'Email confirmed successfully! Logging you in...';
                        alertDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 15px 30px; border-radius: 8px;';
                        document.body.appendChild(alertDiv);
                        
                        setTimeout(() => {
                            if (alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 5000);
                    }
                } catch (error) {
                    console.error('Auth callback error:', error);
                }
            }

            showForgotPasswordForm() {
                this.showTab('login');
                
                const loginSection = document.getElementById('login-section');
                if (!loginSection) return;
                
                loginSection.innerHTML = `
                    <div class="auth-form">
                        <h2>Forgot Password</h2>
                        <div id="auth-alerts"></div>
                        
                        <form id="forgot-password-form">
                            <div class="form-group">
                                <label for="reset-email">Email Address</label>
                                <input type="email" id="reset-email" required>
                                <small style="color: #666;">We'll send you a password reset link</small>
                            </div>
                            <button type="submit" class="btn btn-primary" id="send-reset-btn">Send Reset Link</button>
                            <button type="button" class="btn btn-secondary" id="back-to-login-from-forgot">Back to Login</button>
                        </form>
                    </div>
                `;
                
                // Add event listeners for the new form
                setTimeout(() => {
                    this.addSafeEventListener('forgot-password-form', 'submit', (e) => this.handleForgotPassword(e));
                    this.addSafeEventListener('back-to-login-from-forgot', 'click', () => this.showLoginForm());
                }, 50);
            }

            showPasswordResetForm() {
                this.showTab('login');
                
                const loginSection = document.getElementById('login-section');
                if (!loginSection) return;
                
                loginSection.innerHTML = `
                    <div class="auth-form">
                        <h2>Reset Your Password</h2>
                        <div id="auth-alerts"></div>
                        
                        <form id="reset-password-form">
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-primary" id="reset-btn">Update Password</button>
                            <button type="button" class="btn btn-secondary" id="cancel-reset-btn">Cancel</button>
                        </form>
                    </div>
                `;
                
                setTimeout(() => {
                    this.addSafeEventListener('reset-password-form', 'submit', (e) => this.handlePasswordReset(e));
                    this.addSafeEventListener('cancel-reset-btn', 'click', () => this.showLoginForm());
                }, 50);
            }
            
           async handleForgotPassword(e) {
                e.preventDefault();
                
                const email = document.getElementById('reset-email')?.value;
                const sendBtn = document.getElementById('send-reset-btn');
                
                if (!email) {
                    this.showAlert('Please enter your email address', 'error');
                    return;
                }
                
                if (sendBtn) {
                    sendBtn.disabled = true;
                    sendBtn.textContent = 'Sending...';
                }
                
                try {
                    const { data, error } = await this.supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: 'https://rivertech-devs.github.io/student-portal/reset.html'
                    });
                    
                    if (error) throw error;
                    
                    this.showAlert('Password reset link sent! Check your email.', 'success');
                    
                    setTimeout(() => {
                        this.showLoginForm();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Password reset request error:', error);
                    this.showAlert(error.message, 'error');
                } finally {
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.textContent = 'Send Reset Link';
                    }
                }
            }

            async handlePasswordReset(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('new-password')?.value;
                const confirmPassword = document.getElementById('confirm-password')?.value;
                
                if (!newPassword || !confirmPassword) {
                    this.showAlert('Please fill in both password fields', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    this.showAlert('Passwords do not match', 'error');
                    return;
                }
                
                const resetBtn = document.getElementById('reset-btn');
                if (resetBtn) {
                    resetBtn.disabled = true;
                    resetBtn.textContent = 'Updating...';
                }
                
                try {
                    const { data, error } = await this.supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    this.showAlert('Password updated successfully! Redirecting...', 'success');
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    this.showAlert(error.message || 'Unable to update password. Please try again.', 'error');
                } finally {
                    if (resetBtn) {
                        resetBtn.disabled = false;
                        resetBtn.textContent = 'Update Password';
                    }
                }
            }

            async initializeSupabase() {
                try {
                    // Check if Supabase is loaded
                    if (typeof supabase === 'undefined') {
                        console.warn('Supabase library not loaded yet. Will retry...');
                        setTimeout(() => this.initializeSupabase(), 1000);
                        return;
                    }
                    
                    // IMPORTANT: Replace these with your actual Supabase project credentials
                    // Get them from: https://app.supabase.com/project/YOUR_PROJECT/settings/api
                    const url = 'https://joxvhzxkrcigknsdrusr.supabase.co';
                    
                    // This should be your "anon public" key from Supabase dashboard
                    // Go to Settings > API > Project API keys > anon public
                    const key = 'sb_publishable_xgvdFBaHCJKl9p-Lu61aZw_3oLkeTtc'; 
                    
                    // Validate the key format
                    if (key === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                        console.error('‚ö†Ô∏è SUPABASE KEY NOT CONFIGURED!');
                        console.log('Please follow these steps:');
                        console.log('1. Go to https://app.supabase.com');
                        console.log('2. Select your project');
                        console.log('3. Go to Settings > API');
                        console.log('4. Copy the "anon public" key');
                        console.log('5. Replace YOUR_SUPABASE_ANON_KEY_HERE with your actual key');
                        
                        // Show error to user
                        this.showAlert('Database not configured. Please contact administrator.', 'error');
                        return;
                    }
            
                    this.supabase = supabase.createClient(url, key, {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true
                        }
                    });
                    
                    // Store reference but don't trigger any postMessage issues
                    if (!window.supabase) {
                        window.supabase = this.supabase;
                    }
                    
                    // Dispatch event without the Supabase object
                    window.dispatchEvent(new CustomEvent('supabase-ready')); 
            
                    // Skip connection test - we'll know it works when user logs in
                    // The user_profiles table has RLS enabled, so it returns 401 when not authenticated
                    console.log('üîå Supabase client initialized');
                    
                    // Optional: Test with a public endpoint instead
                    try {
                        // Just verify the client was created successfully
                        if (this.supabase && this.supabase.auth) {
                            console.log('‚úÖ Supabase client ready');
                        }
                    } catch (testError) {
                        console.warn('Supabase client verification failed');
                    }
                    
                    // Check for existing session (wrap in try-catch to handle any serialization issues)
                    try {
                        const sessionResult = await this.supabase.auth.getSession();
                        
                        if (sessionResult?.data?.session) {
                            const session = sessionResult.data.session;
                            const pendingReset = sessionStorage.getItem('pending_password_reset') === 'true';
                            
                            if (pendingReset) {
                                sessionStorage.removeItem('pending_password_reset');
                                this.currentUser = session.user;
                                this.showPasswordResetForm();
                                return;
                            }

                            this.currentUser = session.user;
                            await this.loadUserProfile();
                            this.showDashboard();
                        } else {
                            console.log('No active session - showing login form');
                        }
                    } catch (sessionError) {
                        console.warn('Session check skipped:', sessionError?.message || 'Session error');
                    }
            
                    // Set up auth state listener (wrap to prevent any serialization issues)
                    try {
                        this.supabase.auth.onAuthStateChange(async (event, session) => {
                            // Only log simple strings, not objects
                            console.log('Auth state changed:', event);
                            
                            if (event === 'SIGNED_IN' && session) {
                                this.currentUser = session.user;
                                await this.loadUserProfile();
                                this.showDashboard();
                            } else if (event === 'SIGNED_OUT') {
                                this.currentUser = null;
                                this.userProfile = null;
                                this.showLoginForm();
                            }
                        });
                    } catch (listenerError) {
                        console.warn('Could not set up auth listener:', listenerError?.message);
                    }
            
                } catch (error) {
                    console.warn('Supabase initialization warning:', error?.message || 'Unknown error');
                    console.log('App will continue in offline mode - some features may be limited');
                    // Don't block UI - just continue without database
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                if (!this.supabase) {
                    this.showAlert('Database connection not available', 'error');
                    return;
                }

                const email = document.getElementById('email')?.value;
                const password = document.getElementById('password')?.value;
                const loginBtn = document.getElementById('login-btn');

                if (!email || !password) {
                    this.showAlert('Please enter email and password', 'error');
                    return;
                }

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Logging in...';
                }

                try {
                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;
                    this.showAlert('Login successful!', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    this.showAlert(error.message, 'error');
                } finally {
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login';
                    }
                }
            }

            async handleRegister(e) {
                e.preventDefault();
                if (!this.supabase) {
                    this.showAlert('Database connection not available', 'error');
                    return;
                }

                const email = document.getElementById('reg-email')?.value;
                const password = document.getElementById('reg-password')?.value;
                const username = document.getElementById('reg-username')?.value;
                const firstName = document.getElementById('reg-firstname')?.value;
                const lastName = document.getElementById('reg-lastname')?.value;
                const grade = document.getElementById('reg-grade')?.value;
                const userType = document.getElementById('reg-usertype')?.value;

                const registerBtn = document.getElementById('register-submit-btn');

                if (!email || !password || !username || !firstName || !lastName || !userType) {
                    this.showAlert('Please fill in all required fields', 'error');
                    return;
                }

                if (registerBtn) {
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'Registering...';
                }

                try {
                    const { data: authData, error: authError } = await this.supabase.auth.signUp({
                        email: email,
                        password: password
                    });

                    if (authError) throw authError;

                    const { error: profileError } = await this.supabase
                        .from('user_profiles')
                        .insert({
                            id: authData.user.id,
                            email: email,
                            username: username,
                            first_name: firstName,
                            last_name: lastName,
                            user_type: userType,
                            grade_level: userType === 'student' ? grade : null
                        });

                    if (profileError) throw profileError;

                    if (userType === 'parent') {
                        const childEmailsText = document.getElementById('child-emails')?.value;
                        if (childEmailsText) {
                            const childEmails = childEmailsText.split('\n')
                                .map(email => email.trim())
                                .filter(email => email.length > 0);
                            
                            const { error: updateError } = await this.supabase
                                .from('user_profiles')
                                .update({ 
                                    parent_email: childEmails.join(', ')
                                })
                                .eq('id', authData.user.id);
                            
                            if (updateError) {
                                console.error('Could not store children emails:', updateError);
                            }
                        }
                    }

                    this.showAlert('Registration successful! Please check your email to verify your account.', 'success');
                    this.showLoginForm();

                } catch (error) {
                    console.error('Registration error:', error);
                    this.showAlert(error.message, 'error');
                } finally {
                    if (registerBtn) {
                        registerBtn.disabled = false;
                        registerBtn.textContent = 'Register';
                    }
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return;
            
                try {
                    const { data, error } = await this.supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', this.currentUser.id)
                        .single();
            
                    if (error) {
                        if (error.code === 'PGRST116') {
                            const { data: newProfile, error: createError } = await this.supabase
                                .from('user_profiles')
                                .insert({
                                    id: this.currentUser.id,
                                    email: this.currentUser.email,
                                    username: this.currentUser.email.split('@')[0],
                                    first_name: 'User',
                                    last_name: 'Name',
                                    user_type: 'student'
                                })
                                .select()
                                .single();
                            
                            if (createError) {
                                console.error('Could not create profile:', createError);
                                await this.logout();
                                return;
                            }
                            
                            this.userProfile = newProfile;
                            alert('Profile was missing. Please update your profile information.');
                            return;
                        }
                        throw error;
                    }
                    this.userProfile = data;
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    await this.logout();
                }
            }

            updatePortalTabVisibility() {
                const portalTab = document.getElementById('portal-tab');
                if (!portalTab) {
                    console.log('‚ö†Ô∏è Portal tab element not found');
                    return;
                }
                
                if (this.userProfile) {
                    const allowedRoles = ['student', 'teacher', 'parent'];
                    if (allowedRoles.includes(this.userProfile.user_type)) {
                        portalTab.style.display = 'inline-block';
                        portalTab.style.visibility = 'visible';
                        portalTab.style.opacity = '1';
                        console.log(`‚úÖ Classes & Messaging tab enabled for ${this.userProfile.user_type}`);
                    } else {
                        portalTab.style.display = 'none';
                        console.log(`‚ùå Classes & Messaging tab disabled - invalid role: ${this.userProfile.user_type}`);
                    }
                } else {
                    portalTab.style.display = 'none';
                    console.log('‚ùå Classes & Messaging tab hidden - no user profile');
                }
            }

            showDashboard() {
                const loginSection = document.getElementById('login-section');
                if (loginSection) loginSection.classList.add('hidden');
            
                const dashboardTab = document.getElementById('dashboard-tab');
                if (dashboardTab) dashboardTab.style.display = 'block';
                
                const isParent = this.userProfile && this.userProfile.user_type === 'parent';
                const isTeacher = this.userProfile && this.userProfile.user_type === 'teacher';
                const isStudent = this.userProfile && this.userProfile.user_type === 'student';
                
                // Show/hide tabs based on user type
                const tabs = ['games-tab', 'skills-tab', 'grades-tab'];
                tabs.forEach(tabId => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        tab.style.display = (isParent || isTeacher) ? 'none' : 'block';
                    }
                });
                
                // Update portal tab visibility
                this.updatePortalTabVisibility();
                
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.classList.remove('hidden');
            
                if (this.userProfile) {
                    const userTypeLabel = this.userProfile.user_type.charAt(0).toUpperCase() + this.userProfile.user_type.slice(1);
                    
                    const welcomeMessage = document.getElementById('welcome-message');
                    if (welcomeMessage) {
                        welcomeMessage.textContent = `Welcome back, ${userTypeLabel}!`;
                    }
                    
                    const studentName = document.getElementById('student-name');
                    if (studentName) {
                        studentName.textContent = this.userProfile.first_name + ' ' + this.userProfile.last_name;
                    }
                }
            
                // Load skill progress now that user is authenticated
                if (this.currentUser && this.skillTreeIntegration) {
                    this.skillTreeIntegration.loadAllSkillProgress().then(() => {
                        console.log('üìä Skill progress loaded after login');
                    }).catch(err => {
                        console.warn('Could not load skill progress:', err.message);
                    });
                }
            
                if (isParent || isTeacher) {
                    this.loadParentDashboard();
                } else {
                    this.loadStudentDashboard();
                }
                
                this.showTab('dashboard');
                
                // Double-check portal tab visibility after everything loads
                setTimeout(() => {
                    this.updatePortalTabVisibility();
                }, 500);
            }

            async loadParentDashboard() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const firstName = this.userProfile?.first_name || 'User';
                const lastName = this.userProfile?.last_name || '';
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, ${firstName} ${lastName}!</h2>
                    <div class="dashboard">
                        <div class="card">
                            <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h3>
                            <p>View your children's progress and communicate with teachers.</p>
                            <button class="btn btn-primary" onclick="document.getElementById('portal-tab').click()" style="margin-top: 15px;">
                                üìö Go to Classes & Messaging
                            </button>
                        </div>
                        <div class="card">
                            <h3>üìä Overview</h3>
                            <p>Quick access to important features:</p>
                            <ul style="list-style: none; padding: 0; margin-top: 10px;">
                                <li style="margin-bottom: 8px;">‚úâÔ∏è Message teachers directly</li>
                                <li style="margin-bottom: 8px;">üìà Track student progress</li>
                                <li style="margin-bottom: 8px;">üìÖ View class schedules</li>
                                <li style="margin-bottom: 8px;">üìù Check assignments</li>
                            </ul>
                        </div>
                        <div class="card">
                            <h3>üîî Notifications</h3>
                            <p>You have no new notifications.</p>
                        </div>
                    </div>
                `;
            }
            
            async loadStudentDashboard() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const firstName = this.userProfile?.first_name || 'Student';
                const lastName = this.userProfile?.last_name || '';
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, <span id="student-name">${firstName} ${lastName}</span>!</h2>
                    <div class="dashboard">
                        <div class="card">
                            <h3>üìä Quick Stats</h3>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">Games Played</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">High Score</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" id="achievements">0</div>
                                    <div class="stat-label">Skills Unlocked</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>üéØ Recent Activity</h3>
                            <div id="recent-activity">
                                <p>No recent activity</p>
                                <p style="margin-top: 10px;">
                                    <a href="#" onclick="document.getElementById('portal-tab').click(); return false;" style="color: var(--accent);">
                                        üìö Check Classes & Messages ‚Üí
                                    </a>
                                </p>
                            </div>
                        </div>
                        <div class="card">
                            <h3>üìà Learning Progress</h3>
                            <div>
                                <p>Math Skills</p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <p>Reading Comprehension</p>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>üë§ Profile Settings</h3>
                            <p style="margin-bottom: 15px;"><strong>Name:</strong> ${firstName} ${lastName}</p>
                            <p style="margin-bottom: 15px;"><strong>Email:</strong> ${this.userProfile?.email || 'Not set'}</p>
                            <p style="margin-bottom: 15px;"><strong>Username:</strong> ${this.userProfile?.username || 'Not set'}</p>
                            <p style="margin-bottom: 15px;"><strong>Grade:</strong> ${this.userProfile?.grade_level || 'Not set'}</p>
                            <button class="btn btn-secondary" id="edit-profile-btn" style="margin-bottom: 10px; width: 100%;">
                                ‚úèÔ∏è Edit Profile
                            </button>
                            <button class="btn btn-secondary" id="change-password-btn" style="margin-bottom: 20px; width: 100%;">
                                üîí Change Password
                            </button>
                            <hr style="border: 0; border-top: 1px solid var(--border); margin: 20px 0;">
                            <h4 style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è Danger Zone</h4>
                            <button class="btn btn-danger" id="delete-account-btn" style="width: 100%;">
                                üóëÔ∏è Delete My Account
                            </button>
                            <small style="display: block; color: #666; margin-top: 10px;">
                                This action cannot be undone. All your data will be permanently deleted.
                            </small>
                        </div>
                    </div>
                `;
                
                // Re-add all account management listeners
                this.addSafeEventListener('delete-account-btn', 'click', () => this.deleteAccount());
                this.addSafeEventListener('edit-profile-btn', 'click', () => this.showEditProfileForm());
                this.addSafeEventListener('change-password-btn', 'click', () => this.showChangePasswordForm());
            }

            async showSkillsTab() {
                const skillsSection = document.getElementById('skills-section');
                if (!skillsSection) return;
                
                // Re-add skill tree listeners when skills section is shown
                setTimeout(() => this.addSkillTreeListeners(), 100);
            }

            playGame(gameId) {
                const gameTitle = {
                    'math-adventure': 'üî¢ Math Adventure',
                    'word-wizard': 'üìö Word Wizard',
                    'science-lab': 'üß™ Science Lab',
                    'history-quest': 'üèõÔ∏è History Quest'
                }[gameId];

                const gameTitleElement = document.getElementById('current-game-title');
                const gameContainer = document.getElementById('game-iframe-container');
                const iframe = document.getElementById('game-iframe');
                
                if (gameTitleElement) gameTitleElement.textContent = gameTitle;
                if (gameContainer) gameContainer.classList.remove('hidden');
                
                if (iframe) {
                    iframe.src = 'data:text/html,<html><body style="font-family: Arial; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><h1>' + gameTitle + '</h1><p>Game would load here!</p><p>This is where your HTML5 educational games would be embedded.</p></body></html>';
                }
            }

            closeGame() {
                const gameContainer = document.getElementById('game-iframe-container');
                const iframe = document.getElementById('game-iframe');
                
                if (gameContainer) gameContainer.classList.add('hidden');
                if (iframe) iframe.src = '';
            }

            showTab(tabName) {
                // Hide all sections
                document.querySelectorAll('[id$="-section"]').forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab) tab.classList.remove('active');
                });
                
                // Show requested section
                const section = document.getElementById(tabName + '-section');
                if (section) {
                    section.classList.remove('hidden');
                }
                
                // Activate tab
                const tab = document.getElementById(tabName + '-tab');
                if (tab) {
                    tab.classList.add('active');
                    // Ensure the tab is visible
                    if (tab.style.display === 'none') {
                        tab.style.display = 'inline-block';
                    }
                }
            
                // Special handling for skills tab
                try {
                    if (tabName === 'skills') {
                        this.showSkillsTab();
                    }
                } catch (error) {
                    console.error(`Error loading ${tabName} tab:`, error);
                }
            }

            showAlert(message, type) {
                // Try to find alert container in current view
                let alertsContainer = document.getElementById('auth-alerts');
                
                // If not in auth section, create a temporary alert at the top of the page
                if (!alertsContainer || alertsContainer.offsetParent === null) {
                    const existingAlert = document.getElementById('temp-alert');
                    if (existingAlert) existingAlert.remove();
                    
                    const alertDiv = document.createElement('div');
                    alertDiv.id = 'temp-alert';
                    alertDiv.className = 'alert alert-' + type;
                    alertDiv.textContent = message;
                    alertDiv.style.cssText = `
                        position: fixed;
                        top: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        z-index: 10000;
                        padding: 15px 30px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        max-width: 500px;
                    `;
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                } else {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-' + type;
                    alertDiv.textContent = message;
                    alertsContainer.innerHTML = '';
                    alertsContainer.appendChild(alertDiv);
                    
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                }
            }

            showEditProfileForm() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                dashboardSection.innerHTML = `
                    <h2>Edit Profile</h2>
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <div id="auth-alerts"></div>
                        <form id="edit-profile-form">
                            <div class="form-group">
                                <label for="edit-firstname">First Name</label>
                                <input type="text" id="edit-firstname" value="${this.userProfile?.first_name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-lastname">Last Name</label>
                                <input type="text" id="edit-lastname" value="${this.userProfile?.last_name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-username">Username</label>
                                <input type="text" id="edit-username" value="${this.userProfile?.username || ''}" required>
                            </div>
                            ${this.userProfile?.user_type === 'student' ? `
                                <div class="form-group">
                                    <label for="edit-grade">Grade Level</label>
                                    <select id="edit-grade">
                                        <option value="">Select Grade</option>
                                        <option value="K" ${this.userProfile?.grade_level === 'K' ? 'selected' : ''}>Kindergarten</option>
                                        <option value="1" ${this.userProfile?.grade_level === '1' ? 'selected' : ''}>1st Grade</option>
                                        <option value="2" ${this.userProfile?.grade_level === '2' ? 'selected' : ''}>2nd Grade</option>
                                        <option value="3" ${this.userProfile?.grade_level === '3' ? 'selected' : ''}>3rd Grade</option>
                                        <option value="4" ${this.userProfile?.grade_level === '4' ? 'selected' : ''}>4th Grade</option>
                                        <option value="5" ${this.userProfile?.grade_level === '5' ? 'selected' : ''}>5th Grade</option>
                                        <option value="6" ${this.userProfile?.grade_level === '6' ? 'selected' : ''}>6th Grade</option>
                                        <option value="7" ${this.userProfile?.grade_level === '7' ? 'selected' : ''}>7th Grade</option>
                                        <option value="8" ${this.userProfile?.grade_level === '8' ? 'selected' : ''}>8th Grade</option>
                                        <option value="9" ${this.userProfile?.grade_level === '9' ? 'selected' : ''}>9th Grade</option>
                                        <option value="10" ${this.userProfile?.grade_level === '10' ? 'selected' : ''}>10th Grade</option>
                                        <option value="11" ${this.userProfile?.grade_level === '11' ? 'selected' : ''}>11th Grade</option>
                                        <option value="12" ${this.userProfile?.grade_level === '12' ? 'selected' : ''}>12th Grade</option>
                                    </select>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    üíæ Save Changes
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancel-edit-btn" style="flex: 1;">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                // Add event listeners
                this.addSafeEventListener('edit-profile-form', 'submit', (e) => this.handleProfileUpdate(e));
                this.addSafeEventListener('cancel-edit-btn', 'click', () => this.showDashboard());
            }

            async handleProfileUpdate(e) {
                e.preventDefault();
                
                const firstName = document.getElementById('edit-firstname')?.value;
                const lastName = document.getElementById('edit-lastname')?.value;
                const username = document.getElementById('edit-username')?.value;
                const grade = document.getElementById('edit-grade')?.value;
                
                try {
                    const updateData = {
                        first_name: firstName,
                        last_name: lastName,
                        username: username
                    };
                    
                    if (this.userProfile?.user_type === 'student' && grade) {
                        updateData.grade_level = grade;
                    }
                    
                    const { data, error } = await this.supabase
                        .from('user_profiles')
                        .update(updateData)
                        .eq('id', this.currentUser.id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    this.userProfile = data;
                    this.showAlert('Profile updated successfully!', 'success');
                    setTimeout(() => this.showDashboard(), 1500);
                    
                } catch (error) {
                    console.error('Profile update error:', error);
                    this.showAlert('Error updating profile: ' + error.message, 'error');
                }
            }

            showChangePasswordForm() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                dashboardSection.innerHTML = `
                    <h2>Change Password</h2>
                    <div class="card" style="max-width: 500px; margin: 0 auto;">
                        <div id="auth-alerts"></div>
                        <form id="change-password-form">
                            <div class="form-group">
                                <label for="current-password">Current Password</label>
                                <input type="password" id="current-password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-new-password">Confirm New Password</label>
                                <input type="password" id="confirm-new-password" required minlength="6">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    üîê Update Password
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancel-password-btn" style="flex: 1;">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                // Add event listeners
                this.addSafeEventListener('change-password-form', 'submit', (e) => this.handlePasswordChange(e));
                this.addSafeEventListener('cancel-password-btn', 'click', () => this.showDashboard());
            }

            async handlePasswordChange(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('new-password')?.value;
                const confirmPassword = document.getElementById('confirm-new-password')?.value;
                
                if (newPassword !== confirmPassword) {
                    this.showAlert('New passwords do not match', 'error');
                    return;
                }
                
                try {
                    const { data, error } = await this.supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    this.showAlert('Password changed successfully!', 'success');
                    setTimeout(() => this.showDashboard(), 1500);
                    
                } catch (error) {
                    console.error('Password change error:', error);
                    this.showAlert('Error changing password: ' + error.message, 'error');
                }
            }

            async deleteAccount() {
                const confirmDelete = confirm(
                    'Are you sure you want to delete your account?\n\n' +
                    'This will permanently remove:\n' +
                    '‚Ä¢ Your profile and progress data\n' +
                    '‚Ä¢ Game saves and achievements\n' +
                    '‚Ä¢ All associated records\n\n' +
                    'This action cannot be undone!'
                );
                
                if (!confirmDelete) return;
                
                const doubleConfirm = prompt(
                    'Type "DELETE" to confirm account deletion:'
                );
                
                if (doubleConfirm !== 'DELETE') {
                    alert('Account deletion cancelled.');
                    return;
                }
                
                try {
                    const deleteBtn = document.getElementById('delete-account-btn');
                    if (deleteBtn) {
                        deleteBtn.disabled = true;
                        deleteBtn.textContent = 'Deleting...';
                    }
                    
                    const { data, error } = await this.supabase.rpc('delete_user_account');
                    
                    if (error) {
                        throw error;
                    }
                    
                    if (data && !data.success) {
                        throw new Error(data.error);
                    }
                    
                    alert('Account deleted successfully! You will be redirected to the login page.');
                    
                    this.currentUser = null;
                    this.userProfile = null;
                    sessionStorage.clear();
                    
                    this.logout();
                    
                } catch (error) {
                    console.error('Account deletion error:', error);
                    alert('Error deleting account: ' + error.message);
                    
                    const deleteBtn = document.getElementById('delete-account-btn');
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'üóëÔ∏è Delete My Account';
                    }
                }
            }

            async logout() {
                try {
                    if (this.supabase) {
                        await this.supabase.auth.signOut();
                    }
                } catch (error) {
                    console.log('Logout error (continuing anyway):', error);
                }
                
                this.currentUser = null;
                this.userProfile = null;
                
                // Hide all sections
                document.querySelectorAll('[id$="-section"]').forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                
                // Hide all tabs except login
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab) {
                        if (tab.id === 'login-tab') {
                            tab.style.display = 'inline-block';
                        } else {
                            tab.style.display = 'none';
                        }
                        tab.classList.remove('active');
                    }
                });
                
                // Hide logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.classList.add('hidden');
                
                // Reset welcome message
                const welcomeMessage = document.getElementById('welcome-message');
                if (welcomeMessage) welcomeMessage.textContent = 'Welcome to your learning dashboard';
                
                // Clear form fields
                const emailField = document.getElementById('email');
                const passwordField = document.getElementById('password');
                if (emailField) emailField.value = '';
                if (passwordField) passwordField.value = '';
                
                this.showLoginForm();
            }
        }

        // Initialize portal when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.portal = new StudentPortal();
        });

    </script>
</body>
</html>
