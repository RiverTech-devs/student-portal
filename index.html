<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Learning Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
            min-height: 600px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .logout-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            transition: all 0.3s ease;
        }
        .nav-tab.active {
            background: white;
            border-bottom: 3px solid #4facfe;
            color: #4facfe;
        }
        .content { padding: 30px; min-height: 400px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-secondary { background: #6c757d; color: white; }
        .hidden { display: none; }
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        .game-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .game-card {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
            color: white;
        }
        .game-card:hover { transform: translateY(-5px); }
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        .stat { text-align: center; }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Student Learning Portal</h1>
            <p id="welcome-message">Welcome to your learning dashboard</p>
            <button class="logout-btn hidden" id="logout-btn" onclick="portal.logout()">Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab" onclick="showTab('login')" id="login-tab" style="display:none;">Login</button>
            <button class="nav-tab" onclick="showTab('dashboard')" id="dashboard-tab" style="display:none;">Dashboard</button>
            <button class="nav-tab" onclick="showTab('games')" id="games-tab" style="display:none;">Games</button>
            <button class="nav-tab" onclick="showTab('skills')" id="skills-tab" style="display:none;">Skills</button>
            <button class="nav-tab" onclick="showTab('grades')" id="grades-tab" style="display:none;">Grades</button>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="login-section" class="hidden">
                <div class="auth-form">
                    <h2>Student Portal Login</h2>
                    <div id="auth-alerts"></div>
                    
                   <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                        <button type="button" class="btn btn-secondary" onclick="showRegisterForm()">Register New Account</button>
                        <p style="margin-top: 15px; text-align: center;">
                            <a href="#" onclick="portal.showForgotPasswordForm(); return false;" style="color: #4facfe;">Forgot Password?</a>
                        </p>
                    </form>

                    <form id="register-form" class="hidden">
                        <h3>Create New Account</h3>
                        <div class="form-group">
                            <label for="reg-email">Email Address</label>
                            <input type="email" id="reg-email" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-password">Password</label>
                            <input type="password" id="reg-password" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="reg-username">Username</label>
                            <input type="text" id="reg-username" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-firstname">First Name</label>
                            <input type="text" id="reg-firstname" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-lastname">Last Name</label>
                            <input type="text" id="reg-lastname" required>
                        </div>
                        <div class="form-group">
                            <label for="reg-usertype">Account Type</label>
                            <select id="reg-usertype" required>
                                <option value="student">Student</option>
                                <option value="parent">Parent</option>
                                <option value="teacher">Teacher</option>
                            </select>
                        </div>
                        <div class="form-group" id="grade-group">
                            <label for="reg-grade">Grade Level (for students)</label>
                            <select id="reg-grade">
                                <option value="">Select Grade</option>
                                <option value="K">Kindergarten</option>
                                <option value="1">1st Grade</option>
                                <option value="2">2nd Grade</option>
                                <option value="3">3rd Grade</option>
                                <option value="4">4th Grade</option>
                                <option value="5">5th Grade</option>
                                <option value="6">6th Grade</option>
                                <option value="7">7th Grade</option>
                                <option value="8">8th Grade</option>
                                <option value="9">9th Grade</option>
                                <option value="10">10th Grade</option>
                                <option value="11">11th Grade</option>
                                <option value="12">12th Grade</option>
                            </select>
                        </div>
                        <div class="form-group" id="child-email-group" style="display:none;">
                            <label for="child-emails">Children's Email Addresses</label>
                            <textarea id="child-emails" rows="4" placeholder="Enter each child's email address on a separate line:&#10;child1@yourschool.edu&#10;child2@yourschool.edu&#10;child3@yourschool.edu" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
                            <small style="color: #666; font-size: 12px;">Enter one email address per line for each child's student account</small>
                        </div>
                        <button type="submit" class="btn btn-primary" id="register-btn">Register</button>
                        <button type="button" class="btn btn-secondary" onclick="showLoginForm()">Back to Login</button>
                    </form>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="hidden">
                <h2>Welcome back, <span id="student-name">Student</span>!</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>üìä Quick Stats</h3>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value" id="games-played">0</div>
                                <div class="stat-label">Games Played</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="total-score">0</div>
                                <div class="stat-label">High Score</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="achievements">0</div>
                                <div class="stat-label">Achievements</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üéØ Recent Activity</h3>
                        <div id="recent-activity">
                            <p>No recent activity</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üìà Learning Progress</h3>
                        <div>
                            <p>Math Skills</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 65%"></div>
                            </div>
                            <p>Reading Comprehension</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 78%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>‚öôÔ∏è Account Settings</h3>
                        <p style="margin-bottom: 15px;">Manage your account</p>
                        <button class="btn" style="background: #dc3545; color: white;" onclick="deleteAccount()" id="delete-account-btn">
                            üóëÔ∏è Delete My Account
                        </button>
                        <small style="display: block; color: #666; margin-top: 10px;">
                            This action cannot be undone
                        </small>
                    </div>
                </div>
            </div>

            <!-- Games Section -->
            <div id="games-section" class="hidden">
                <h2>üéÆ Educational Games</h2>
                <div class="game-list">
                    <div class="game-card" onclick="playGame('math-adventure')">
                        <h3>üî¢ Math Adventure</h3>
                        <p>Practice arithmetic skills</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">Level 1</div>
                                <div class="stat-label">Current Level</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card" onclick="playGame('word-wizard')">
                        <h3>üìö Word Wizard</h3>
                        <p>Spelling and vocabulary</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">Level 1</div>
                                <div class="stat-label">Current Level</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card" onclick="playGame('science-lab')">
                        <h3>üß™ Science Lab</h3>
                        <p>Fun science experiments</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">Level 1</div>
                                <div class="stat-label">Current Level</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-card" onclick="playGame('history-quest')">
                        <h3>üèõÔ∏è History Quest</h3>
                        <p>Explore historical events</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value">New!</div>
                                <div class="stat-label">Try it out</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="game-iframe-container" class="hidden" style="margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="current-game-title"></h3>
                        <button class="btn btn-secondary" onclick="closeGame()">Close Game</button>
                    </div>
                    <iframe id="game-iframe" width="100%" height="500" frameborder="0"></iframe>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="hidden">
                <h2>üìà Learning Progress</h2>
                <div class="dashboard">
                    <div class="card">
                        <h3>Subject Progress</h3>
                        <div id="subject-progress">
                            <p>Loading progress data...</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üèÜ Achievements</h3>
                        <div id="achievements-list">
                            <p>No achievements yet. Keep playing!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grades Section -->
            <div id="grades-section" class="hidden">
                <h2>üìä Grades & Assignments</h2>
                <div id="grades-content">
                    <p>No grades available yet</p>
                </div>
            </div>
            <!-- Skills Section -->
            <div id="skills-section" class="hidden">
                <h2>üåü Skill Trees</h2>
                <div class="subject-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="portal.loadSkillTree('Art')" style="margin-bottom: 10px;">
                        Art
                    </button>
                    <button class="btn btn-primary" onclick="portal.loadSkillTree('Math')" style="margin-bottom: 10px;">
                        Math
                    </button>
                    <button class="btn btn-primary" onclick="portal.loadSkillTree('Science')" style="margin-bottom: 10px;">
                        Science
                    </button>
                    <button class="btn btn-primary" onclick="portal.loadSkillTree('Reading')" style="margin-bottom: 10px;">
                        Reading
                    </button>
                </div>
                <div id="skill-tree-container" style="width: 100%; height: 600px; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden; background: #f8f9fa;">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üåü</div>
                            <h3>Select a Subject</h3>
                            <p>Choose a subject above to explore your skill tree</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Children Section (Parents/Teachers only) -->
            <div id="children-section" class="hidden">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h2>
                <div class="dashboard" id="children-dashboard">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        class StudentPortal {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.userProfile = null;
                this.init();
            }

           init() {
                // Check for auth callback in URL hash
                this.handleAuthCallback();
                
                // Production configuration - automatically connect to Supabase
                this.initializeSupabase();
            
                // Add event listeners only if forms exist
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                }
                
                const registerForm = document.getElementById('register-form');
                if (registerForm) {
                    registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                }
            
                // Handle account type changes for showing/hiding fields
                const userTypeField = document.getElementById('reg-usertype');
                if (userTypeField) {
                    userTypeField.addEventListener('change', (e) => {
                        const userType = e.target.value;
                        const isStudent = userType === 'student';
                        const isParent = userType === 'parent';
                        
                        // Show/hide grade level for students
                        const gradeGroup = document.getElementById('grade-group');
                        if (gradeGroup) gradeGroup.style.display = isStudent ? 'block' : 'none';
                        
                        // Show/hide child emails for parents
                        const childEmailGroup = document.getElementById('child-email-group');
                        if (childEmailGroup) childEmailGroup.style.display = isParent ? 'block' : 'none';
                        
                        // Set required fields
                        const gradeField = document.getElementById('reg-grade');
                        const childEmailsField = document.getElementById('child-emails');
                        
                        if (isStudent) {
                            if (gradeField) gradeField.required = true;
                            if (childEmailsField) childEmailsField.required = false;
                        } else if (isParent) {
                            if (gradeField) gradeField.required = false;
                            if (childEmailsField) childEmailsField.required = true;
                        } else {
                            if (gradeField) gradeField.required = false;
                            if (childEmailsField) childEmailsField.required = false;
                        }
                    });
                }

               // Set up message listener for skill tree communication
                window.addEventListener('message', async (event) => {
                    if (event.data.type === 'SKILL_UNLOCKED') {
                        await this.handleSkillUnlock(event.data);
                    } else if (event.data.type === 'REQUEST_SKILL_DATA') {
                        await this.handleSkillDataRequest(event.data);
                    }
                });

               // Set up message listener for skill tree communication
                window.addEventListener('message', async (event) => {
                    if (event.data.type === 'SKILL_UNLOCKED') {
                        await this.handleSkillUnlock(event.data);
                    } else if (event.data.type === 'REQUEST_SKILL_DATA') {
                        await this.handleSkillDataRequest(event.data);
                    }
                });
                
                console.log('StudentPortal initialized with skill tree communication');
            }

            showLoginForm() {
                const loginSection = document.getElementById('login-section');
                if (!loginSection) return;
                
                loginSection.innerHTML = `
                    <div class="auth-form">
                        <h2>Student Portal Login</h2>
                        <div id="auth-alerts"></div>
                        
                        <form id="login-form">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Password</label>
                                <input type="password" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                            <button type="button" class="btn btn-secondary" onclick="portal.showRegisterForm()">Register New Account</button>
                            <p style="margin-top: 15px; text-align: center;">
                                <a href="#" onclick="portal.showForgotPasswordForm(); return false;" style="color: #4facfe;">Forgot Password?</a>
                            </p>
                            <p style="margin-top: 10px; text-align: center;">
                                <small>Just clicked a password reset link? 
                                    <a href="#" onclick="portal.checkAndShowResetForm(); return false;" style="color: #4facfe;">
                                        Click here to reset password
                                    </a>
                                </small>
                            </p>
                        </form>
                    </div>
                `;
                
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('login-form').classList.remove('hidden');
                
                const registerForm = document.getElementById('register-form');
                if (registerForm) registerForm.classList.add('hidden');
            }

            handleAuthCallback() {
                // Debug logging
                console.log('Full URL hash:', window.location.hash);
                console.log('URL search params:', window.location.search);
                
                // Check if we have auth tokens in the URL hash
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');
                const type = hashParams.get('type');
                const error = hashParams.get('error');
                const errorCode = hashParams.get('error_code');
                const errorDescription = hashParams.get('error_description');
                
                // Handle errors (like expired links)
                if (error || errorCode) {
                    console.log('Auth error detected:', errorCode, errorDescription);
                    
                    // Clear the URL hash
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    if (errorCode === 'otp_expired') {
                        this.showAlert('Password reset link has expired. Please request a new one.', 'error');
                        this.showForgotPasswordForm();
                    } else {
                        this.showAlert(errorDescription || 'An error occurred. Please try again.', 'error');
                    }
                    return;
                }
                
                // CHECK FOR RECOVERY FIRST - before checking for regular tokens
                if (type === 'recovery') {
                    console.log('Password recovery detected!');
                    
                    // Clear the URL hash to clean up the address bar
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    // Store flag to show reset form after session is established
                    sessionStorage.setItem('pending_password_reset', 'true');
                    return;
                }
                
                // Now check for regular auth callback
                if (accessToken && refreshToken) {
                    console.log('Auth callback detected - processing tokens...');
                    
                    // Clear the URL hash to clean up the address bar
                    window.history.replaceState(null, '', window.location.pathname);
                    
                    // Show a success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = 'Email confirmed successfully! Logging you in...';
                    alertDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 15px 30px; border-radius: 8px;';
                    document.body.appendChild(alertDiv);
                    
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                }
            }

            showPasswordResetForm() {
                // Show the login section with password reset form
                this.showTab('login');
                
                const loginSection = document.getElementById('login-section');
                if (!loginSection) return;
                
                loginSection.innerHTML = `
                    <div class="auth-form">
                        <h2>Reset Your Password</h2>
                        <div id="auth-alerts"></div>
                        
                        <form id="reset-password-form">
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-primary" id="reset-btn">Update Password</button>
                            <button type="button" class="btn btn-secondary" onclick="portal.showLoginForm()">Cancel</button>
                        </form>
                    </div>
                `;
                
                document.getElementById('reset-password-form').addEventListener('submit', (e) => this.handlePasswordReset(e));
            }

            async handleSkillUnlock(data) {
                try {
                    console.log('Skill unlocked:', data.skillName, 'in', data.subject);
                    
                    // For now, just show the notification without database calls
                    this.showSkillUnlockNotification(data.skillName, data.subject);
                    
                    // Send simple confirmation back to skill tree
                    const iframe = document.getElementById('skill-tree-frame');
                    if (iframe) {
                        iframe.contentWindow.postMessage({
                            type: 'PROGRESS_UPDATED',
                            progress: {} // Empty for now - will work with hardcoded data
                        }, '*');
                    }
                    
                } catch (error) {
                    console.error('Error handling skill unlock:', error);
                }
            }

            async handleSkillDataRequest(data) {
                try {
                    console.log('Skill data requested for:', data.subject);
                    
                    // For now, just send empty data to trigger hardcoded fallback
                    const iframe = document.getElementById('skill-tree-frame');
                    if (iframe) {
                        iframe.contentWindow.postMessage({
                            type: 'SKILL_DATA_RESPONSE',
                            skillTreeData: null, // This will trigger hardcoded fallback
                            progress: {} // Empty progress - will use defaults
                        }, '*');
                    }
                } catch (error) {
                    console.error('Error handling skill data request:', error);
                }
            }
            
            async checkAndShowResetForm() {
                const { data: { session } } = await this.supabase.auth.getSession();
                if (session) {
                    console.log('Manual reset requested - session found');
                    this.currentUser = session.user;
                    this.showPasswordResetForm();
                } else {
                    this.showAlert('No active session. Please request a new password reset link.', 'error');
                    this.showForgotPasswordForm();
                }
            }
            
            async handlePasswordReset(e) {
                e.preventDefault();
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (newPassword !== confirmPassword) {
                    this.showAlert('Passwords do not match', 'error');
                    return;
                }
                
                const resetBtn = document.getElementById('reset-btn');
                resetBtn.disabled = true;
                resetBtn.textContent = 'Updating...';
                
                try {
                    // Just try to update - Supabase will handle session validation
                    const { data, error } = await this.supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    this.showAlert('Password updated successfully! Redirecting...', 'success');
                    
                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    this.showAlert(error.message || 'Unable to update password. Please try again.', 'error');
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Update Password';
                }
            }

            showSkillUnlockNotification(skillName, subject) {
                // Create a beautiful notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                    color: white;
                    padding: 15px 25px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3);
                    z-index: 10000;
                    max-width: 300px;
                    animation: slideIn 0.3s ease-out;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <span style="font-size: 24px; margin-right: 10px;">üåü</span>
                        <div>
                            <div style="font-weight: bold;">Skill Unlocked!</div>
                            <div style="font-size: 14px; opacity: 0.9;">${skillName}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${subject}</div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 4 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 4000);
            }

            async refreshDashboardStats() {
                // Refresh the dashboard with updated progress
                if (this.userProfile && this.userProfile.user_type === 'student') {
                    await this.loadStudentDashboard();
                }
            }
            
            showForgotPasswordForm() {
                const loginSection = document.getElementById('login-section');
                if (!loginSection) return;
                
                loginSection.innerHTML = `
                    <div class="auth-form">
                        <h2>Forgot Password</h2>
                        <div id="auth-alerts"></div>
                        
                        <form id="forgot-password-form">
                            <div class="form-group">
                                <label for="reset-email">Email Address</label>
                                <input type="email" id="reset-email" required>
                                <small style="color: #666;">We'll send you a password reset link</small>
                            </div>
                            <button type="submit" class="btn btn-primary" id="send-reset-btn">Send Reset Link</button>
                            <button type="button" class="btn btn-secondary" onclick="portal.showLoginForm()">Back to Login</button>
                        </form>
                    </div>
                `;
                
                document.getElementById('forgot-password-form').addEventListener('submit', (e) => this.handleForgotPassword(e));
            }
            
           async handleForgotPassword(e) {
                e.preventDefault();
                
                const email = document.getElementById('reset-email').value;
                const sendBtn = document.getElementById('send-reset-btn');
                
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';
                
                try {
                    const { data, error } = await this.supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: 'https://rivertech-devs.github.io/student-portal/reset.html'  // <-- Use reset.html
                    });
                    
                    if (error) throw error;
                    
                    this.showAlert('Password reset link sent! Check your email.', 'success');
                    
                    // Return to login form after 3 seconds
                    setTimeout(() => {
                        this.showLoginForm();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Password reset request error:', error);
                    this.showAlert(error.message, 'error');
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Reset Link';
                }
            }
            
            showRegisterForm() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }

            async initializeSupabase() {
                // Production credentials - hardcoded for seamless user experience
                const url = 'https://joxvhzxkrcigknsdrusr.supabase.co';
                const key = 'sb_publishable_xgvdFBaHCJKl9p-Lu61aZw_3oLkeTtc';
            
                try {
                    this.supabase = supabase.createClient(url, key, {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true // This will automatically handle the auth callback
                        }
                    });
            
                    const { data, error } = await this.supabase.from('user_profiles').select('count').limit(1);
                    
                    if (error) throw error;
            
                    console.log('Connected to Supabase successfully');
                    
                   // Check for existing session (including from email confirmation)
                    const { data: { session } } = await this.supabase.auth.getSession();
                    if (session) {
                        console.log('Session found:', session.user.email);
                        
                        // Check if this is a recovery session by looking at the user metadata
                        const isRecovery = session.user.recovery_sent_at && 
                            (new Date() - new Date(session.user.last_sign_in_at)) < 60000; // Logged in within last minute
                        
                        const hashHasTokens = window.location.hash.includes('access_token');
                        
                        console.log('Recovery check 1 - isRecovery:', isRecovery, 'hashHasTokens:', hashHasTokens);
                        
                        if (isRecovery || hashHasTokens) {
                            this.currentUser = session.user;
                            this.showPasswordResetForm();
                            
                            // Clear the URL hash after showing form
                            if (hashHasTokens) {
                                window.history.replaceState(null, '', window.location.pathname);
                            }
                            return;
                        }

                        // Check for pending password reset
                        const pendingReset = sessionStorage.getItem('pending_password_reset') === 'true';
                        
                        if (pendingReset) {
                            console.log('Processing pending password reset');
                            sessionStorage.removeItem('pending_password_reset');
                            this.currentUser = session.user;
                            this.showPasswordResetForm();
                            return;
                        }
                        
                        // Check if this is a recovery session
                        // Recovery sessions have specific AMR (Authentication Methods Reference) values
                        const isRecoverySession = session.user.amr?.find(amr => amr.method === 'recovery');
                        const isRecentSession = session.user.last_sign_in_at && 
                            (new Date() - new Date(session.user.last_sign_in_at)) < 60000; // Within last minute
                        
                        if (isRecoverySession || (isRecentSession && session.user.recovery_sent_at)) {
                            console.log('Recovery session detected - showing password reset form');
                            this.currentUser = session.user;
                            this.showPasswordResetForm();
                            return;
                        }

                        // Normal session - not a recovery, just a regular login
                        console.log('Normal session detected - loading dashboard');
                        this.currentUser = session.user;
                        await this.loadUserProfile();
                        this.showDashboard();
                    } else {
                        this.showTab('login');
                    }
            
                    // Listen for auth state changes
                    this.supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('Auth state changed:', event);
                        if (event === 'SIGNED_IN' && session) {
                            this.currentUser = session.user;
                            await this.loadUserProfile();
                            this.showDashboard();
                        } else if (event === 'SIGNED_OUT') {
                            this.currentUser = null;
                            this.userProfile = null;
                            this.showTab('login');
                        }
                    });
            
                } catch (error) {
                    console.error('Supabase connection error:', error);
                    alert('Unable to connect to backend. Please contact support.');
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                if (!this.supabase) {
                    this.showAlert('Please configure Supabase connection first', 'error');
                    return;
                }

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('login-btn');

                loginBtn.disabled = true;
                loginBtn.textContent = 'Logging in...';

                try {
                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;
                    this.showAlert('Login successful!', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    this.showAlert(error.message, 'error');
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                }
            }

            async handleRegister(e) {
                e.preventDefault();
                if (!this.supabase) {
                    this.showAlert('Please configure Supabase connection first', 'error');
                    return;
                }

                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const username = document.getElementById('reg-username').value;
                const firstName = document.getElementById('reg-firstname').value;
                const lastName = document.getElementById('reg-lastname').value;
                const grade = document.getElementById('reg-grade').value;
                const userType = document.getElementById('reg-usertype').value;

                const registerBtn = document.getElementById('register-btn');
                registerBtn.disabled = true;
                registerBtn.textContent = 'Registering...';

                try {
                    const { data: authData, error: authError } = await this.supabase.auth.signUp({
                        email: email,
                        password: password
                    });

                    if (authError) throw authError;

                    // Create user profile
                    const { error: profileError } = await this.supabase
                        .from('user_profiles')
                        .insert({
                            id: authData.user.id,
                            email: email, // Add email to profile
                            username: username,
                            first_name: firstName,
                            last_name: lastName,
                            user_type: userType,
                            grade_level: userType === 'student' ? grade : null
                        });

                    if (profileError) throw profileError;

                    // Store children emails for future linking (if parent account)
                    if (userType === 'parent') {
                        const childEmailsText = document.getElementById('child-emails').value;
                        const childEmails = childEmailsText.split('\n')
                            .map(email => email.trim())
                            .filter(email => email.length > 0);
                        
                        // Store all child emails in the parent profile for future use
                        const { error: updateError } = await this.supabase
                            .from('user_profiles')
                            .update({ 
                                parent_email: childEmails.join(', ') // Store as comma-separated list
                            })
                            .eq('id', authData.user.id);
                        
                        if (updateError) {
                            console.error('Could not store children emails:', updateError);
                        }
                        
                        console.log('Parent account created. Children emails stored:', childEmails);
                    }

                    this.showAlert('Registration successful! Please check your email to verify your account.', 'success');
                    this.showLoginForm();

                } catch (error) {
                    console.error('Registration error:', error);
                    this.showAlert(error.message, 'error');
                } finally {
                    registerBtn.disabled = false;
                    registerBtn.textContent = 'Register';
                }
            }

            async loadUserProfile() {
                if (!this.currentUser) return;
            
                try {
                    const { data, error } = await this.supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', this.currentUser.id)
                        .single();
            
                    if (error) {
                        if (error.code === 'PGRST116') {
                            // Profile doesn't exist - create a basic one
                            console.log('User profile not found - creating basic profile');
                            
                            const { data: newProfile, error: createError } = await this.supabase
                                .from('user_profiles')
                                .insert({
                                    id: this.currentUser.id,
                                    email: this.currentUser.email,
                                    username: this.currentUser.email.split('@')[0],
                                    first_name: 'User',
                                    last_name: 'Name',
                                    user_type: 'student'  // Default type
                                })
                                .select()
                                .single();
                            
                            if (createError) {
                                console.error('Could not create profile:', createError);
                                await this.logout();
                                return;
                            }
                            
                            this.userProfile = newProfile;
                            alert('Profile was missing. Please update your profile information.');
                            return;
                        }
                        throw error;
                    }
                    this.userProfile = data;
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    // If profile loading fails, logout the user
                    await this.logout();
                }
            }

            showDashboard() {
                // Hide login section
                const loginSection = document.getElementById('login-section');
                if (loginSection) loginSection.classList.add('hidden');
            
                // Hide non-existent setup section safely
                const setupSection = document.getElementById('setup-section');
                if (setupSection) setupSection.classList.add('hidden');
            
                // Hide/show tabs based on user type - SAFE ACCESS TO ELEMENTS
                const setupTab = document.getElementById('setup-tab');
                if (setupTab) setupTab.style.display = 'none';
                
                const loginTab = document.getElementById('login-tab');
                if (loginTab) loginTab.style.display = 'none';
                
                // Check if user is a parent or student
                const isParent = this.userProfile && this.userProfile.user_type === 'parent';
                const isTeacher = this.userProfile && this.userProfile.user_type === 'teacher';
                const isStudent = this.userProfile && this.userProfile.user_type === 'student';
                
                // Show appropriate tabs based on user type - SAFE ACCESS
                const dashboardTab = document.getElementById('dashboard-tab');
                if (dashboardTab) dashboardTab.style.display = 'block';
                
                if (isParent || isTeacher) {
                    // Parents and teachers don't need games
                    const gamesTab = document.getElementById('games-tab');
                    const skillsTab = document.getElementById('skills-tab');
                    const gradesTab = document.getElementById('grades-tab');
                    
                    if (gamesTab) gamesTab.style.display = 'none';
                    if (skillsTab) skillsTab.style.display = 'none';
                    if (gradesTab) gradesTab.style.display = 'none';
                    
                    // Show parent/teacher specific tabs
                    let childrenTab = document.getElementById('children-tab');
                    if (!childrenTab) {
                        // Create children tab if it doesn't exist
                        childrenTab = document.createElement('button');
                        childrenTab.id = 'children-tab';
                        childrenTab.className = 'nav-tab';
                        childrenTab.textContent = isParent ? 'My Children' : 'My Students';
                        childrenTab.onclick = () => this.showTab('children');
                        
                        const navTabs = document.querySelector('.nav-tabs');
                        if (navTabs) navTabs.appendChild(childrenTab);
                    }
                    if (childrenTab) childrenTab.style.display = 'block';
                } else {
                    // Students see their own tabs
                    const gamesTab = document.getElementById('games-tab');
                    const skillsTab = document.getElementById('skills-tab');
                    const gradesTab = document.getElementById('grades-tab');
                    
                    if (gamesTab) gamesTab.style.display = 'block';
                    if (skillsTab) skillsTab.style.display = 'block';
                    if (gradesTab) gradesTab.style.display = 'block';
                    
                    // Hide parent/teacher tabs if they exist
                    const childrenTab = document.getElementById('children-tab');
                    if (childrenTab) childrenTab.style.display = 'none';
                }
                
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.classList.remove('hidden');
            
                if (this.userProfile) {
                    const userTypeLabel = this.userProfile.user_type.charAt(0).toUpperCase() + this.userProfile.user_type.slice(1);
                    
                    const welcomeMessage = document.getElementById('welcome-message');
                    if (welcomeMessage) {
                        welcomeMessage.textContent = `Welcome back, ${userTypeLabel}!`;
                    }
                    
                    const studentName = document.getElementById('student-name');
                    if (studentName) {
                        studentName.textContent = this.userProfile.first_name + ' ' + this.userProfile.last_name;
                    }
                }
            
                // Load appropriate dashboard
                if (isParent || isTeacher) {
                    this.loadParentDashboard();
                } else {
                    this.loadStudentDashboard();
                }
                
                this.showTab('dashboard');
            }

            async loadParentDashboard() {
                // Update dashboard for parent view
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, <span id="parent-name">${this.userProfile.first_name} ${this.userProfile.last_name}</span>!</h2>
                    <div class="dashboard">
                        <div class="card">
                            <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h3>
                            <div id="children-list">
                                <p>Loading children...</p>
                            </div>
                            <button class="btn btn-primary" onclick="portal.showAddChildForm()" style="margin-top: 15px;">
                                ‚ûï Link Child Account
                            </button>
                        </div>
                        <div class="card">
                            <h3>üìä Overview</h3>
                            <div id="children-overview">
                                <p>Select a child to view their progress</p>
                            </div>
                        </div>
                        <div class="card">
                            <h3>üìÖ Recent Activity</h3>
                            <div id="recent-activity">
                                <p>No recent activity</p>
                            </div>
                        </div>
                        <div class="card">
                            <h3>‚öôÔ∏è Account Settings</h3>
                            <p style="margin-bottom: 15px;">Manage your account</p>
                            <button class="btn btn-primary" onclick="portal.showPasswordResetForm()" style="margin-bottom: 10px;">
                                üîê Change Password
                            </button>
                            <br>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="deleteAccount()" id="delete-account-btn">
                                üóëÔ∏è Delete My Account
                            </button>
                            <small style="display: block; color: #666; margin-top: 10px;">
                                This action cannot be undone
                            </small>
                        </div>
                    </div>
                `;
                
                // Load linked children
                await this.loadLinkedChildren();
            }
            
            async loadStudentDashboard() {
                // Reset dashboard to student view
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const firstName = this.userProfile?.first_name || 'Student';
                const lastName = this.userProfile?.last_name || '';
                
                // Get real data for this student
                const studentId = this.currentUser.id;
                
                // Get progress data
                const { data: progress } = await this.supabase
                    .from('student_progress')
                    .select('*')
                    .eq('student_id', studentId);
                
                // Get game stats
                const { data: gameStats } = await this.supabase
                    .from('game_scores')
                    .select('*')
                    .eq('student_id', studentId);
                
                const totalGamesPlayed = gameStats?.length || 0;
                const highScore = gameStats?.reduce((max, game) => Math.max(max, game.score), 0) || 0;
                const achievements = Math.floor(totalGamesPlayed / 2); // Simple achievement calculation
                
                // Sort progress by percentage to get top 2
                const sortedProgress = progress ? 
                    [...progress].sort((a, b) => b.progress_percentage - a.progress_percentage) : [];
                const topTwoSubjects = sortedProgress.slice(0, 2);
                
                // Build progress HTML for top 2 subjects
                let progressHtml = '';
                if (topTwoSubjects.length > 0) {
                    progressHtml = '<p style="margin-bottom: 10px;"><strong>Top Subjects:</strong></p>';
                    topTwoSubjects.forEach((subject, index) => {
                        progressHtml += `
                            ${index > 0 ? '<p style="margin-top: 15px;">' : '<p>'}${subject.subject}</p>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${subject.progress_percentage}%"></div>
                            </div>
                            <small style="color: #666;">${subject.progress_percentage}% Complete</small>
                        `;
                    });
                    progressHtml += `
                        <p style="margin-top: 15px; text-align: center;">
                            <a href="#" onclick="portal.showTab('progress'); return false;" style="color: #4facfe; text-decoration: none;">
                                View all subjects ‚Üí
                            </a>
                        </p>
                    `;
                } else {
                    progressHtml = '<p>No progress data yet</p>';
                }
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, <span id="student-name">${firstName} ${lastName}</span>!</h2>
                    <div class="dashboard">
                        <div class="card">
                            <h3>üìä Quick Stats</h3>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-value" id="games-played">${totalGamesPlayed}</div>
                                    <div class="stat-label">Games Played</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" id="total-score">${highScore}</div>
                                    <div class="stat-label">High Score</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" id="achievements">${achievements}</div>
                                    <div class="stat-label">Achievements</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>üéØ Recent Activity</h3>
                            <div id="recent-activity">
                                ${gameStats && gameStats.length > 0 ? 
                                    `<p>Last played: ${gameStats[gameStats.length-1].game_name}</p>
                                     <small style="color: #666;">Score: ${gameStats[gameStats.length-1].score}</small>` : 
                                    '<p>No recent activity</p>'}
                            </div>
                        </div>
                        <div class="card">
                            <h3>üìà Learning Progress</h3>
                            <div>
                                ${progressHtml}
                            </div>
                        </div>
                        <div class="card">
                            <h3>‚öôÔ∏è Account Settings</h3>
                            <p style="margin-bottom: 15px;">Manage your account</p>
                            <button class="btn btn-primary" onclick="portal.showPasswordResetForm()" style="margin-bottom: 10px;">
                                üîê Change Password
                            </button>
                            <br>
                            <button class="btn" style="background: #dc3545; color: white;" onclick="deleteAccount()" id="delete-account-btn">
                                üóëÔ∏è Delete My Account
                            </button>
                            <small style="display: block; color: #666; margin-top: 10px;">
                                This action cannot be undone
                            </small>
                        </div>
                    </div>
                `;
            }
            
            async loadLinkedChildren() {
                try {
                    const childrenListDiv = document.getElementById('children-list');
                    if (!childrenListDiv) return;
                    
                    // First, try to get linked children from parent_child_links table
                    const { data: links, error: linksError } = await this.supabase
                        .from('parent_child_links')
                        .select('child_id')
                        .eq('parent_id', this.currentUser.id);
                    
                    // Also check for pending children emails stored during registration
                    let pendingEmails = [];
                    if (this.userProfile && this.userProfile.parent_email) {
                        // We stored children emails in parent_email field
                        pendingEmails = this.userProfile.parent_email.split(',').map(e => e.trim()).filter(e => e.length > 0);
                        console.log('Pending emails from registration:', pendingEmails);
                    }
                    
                    let htmlContent = '';
                    let linkedChildIds = [];
                    
                    // Show linked children
                    if (links && links.length > 0) {
                        // Get children's profiles
                        linkedChildIds = links.map(link => link.child_id);
                        const { data: children, error: childrenError } = await this.supabase
                            .from('user_profiles')
                            .select('*')
                            .in('id', linkedChildIds);
                        
                        if (children && children.length > 0) {
                            htmlContent += '<h5>Linked Children:</h5>';
                            htmlContent += children.map(child => `
                                <div style="padding: 10px; border: 1px solid #28a745; background: #d4edda; border-radius: 8px; margin-bottom: 10px; cursor: pointer;"
                                     onclick="portal.viewChildDetails('${child.id}')">
                                    <strong>${child.first_name} ${child.last_name}</strong>
                                    <span style="float: right; color: #155724;">Grade ${child.grade_level || 'N/A'}</span>
                                    <br>
                                    <small style="color: #155724;">${child.username} ‚úì Linked</small>
                                </div>
                            `).join('');
                        }
                    }
                    
                    // Show pending children (emails entered but not yet linked)
                    if (pendingEmails.length > 0) {
                        htmlContent += '<h5 style="margin-top: 15px;">Pending Children (from registration):</h5>';
                        
                        // Get ALL student profiles to check against pending emails
                        const { data: allStudents, error: studentsError } = await this.supabase
                            .from('user_profiles')
                            .select('*')
                            .eq('user_type', 'student');
                        
                        console.log('Found students:', allStudents);
                        
                        for (const email of pendingEmails) {
                            // Try to find a matching student profile
                            let matchingStudent = null;
                            
                            if (allStudents) {
                                // First try exact email match
                                matchingStudent = allStudents.find(s => s.email && s.email.toLowerCase() === email.toLowerCase());
                                
                                // If no email match, try to match by username (sometimes email is used as username)
                                if (!matchingStudent) {
                                    const emailUsername = email.split('@')[0];
                                    matchingStudent = allStudents.find(s => 
                                        s.username && s.username.toLowerCase() === emailUsername.toLowerCase()
                                    );
                                }
                            }
                            
                            // Check if already linked
                            const isAlreadyLinked = matchingStudent && linkedChildIds.includes(matchingStudent.id);
                            
                            if (isAlreadyLinked) {
                                // Skip if already linked
                                continue;
                            } else if (matchingStudent) {
                                // Account exists but not linked
                                console.log('Found matching student for', email, matchingStudent);
                                htmlContent += `
                                    <div style="padding: 10px; border: 1px solid #ffc107; background: #fff3cd; border-radius: 8px; margin-bottom: 10px;">
                                        <strong>${matchingStudent.first_name} ${matchingStudent.last_name}</strong>
                                        <br>
                                        <small style="color: #856404;">${email} - Account found!</small>
                                        <button class="btn btn-sm" style="float: right; padding: 4px 8px; font-size: 12px; background: #28a745; color: white;" 
                                                onclick="portal.autoLinkChild('${matchingStudent.id}', '${email}')">
                                            Link Now
                                        </button>
                                    </div>
                                `;
                            } else {
                                // No account yet
                                console.log('No matching student found for', email);
                                htmlContent += `
                                    <div style="padding: 10px; border: 1px solid #6c757d; background: #e9ecef; border-radius: 8px; margin-bottom: 10px;">
                                        <small style="color: #495057;">${email} - Waiting for account creation</small>
                                        <button class="btn btn-sm" style="float: right; padding: 4px 8px; font-size: 12px; background: #6c757d; color: white;" 
                                                onclick="portal.removePendingEmail('${email}')">
                                            Remove
                                        </button>
                                    </div>
                                `;
                            }
                        }
                    }
                    
                    if (!htmlContent) {
                        htmlContent = `
                            <p>No children linked yet.</p>
                            <small>Click "Link Child Account" to connect your children's accounts.</small>
                        `;
                    }
                    
                    childrenListDiv.innerHTML = htmlContent;
                    
                } catch (error) {
                    console.error('Error loading children:', error);
                    childrenListDiv.innerHTML = '<p>Error loading children. Please refresh the page.</p>';
                }
            }

            async autoLinkChild(childId, childEmail) {
                try {
                    // Create the link in parent_child_links table
                    const { data, error } = await this.supabase
                        .from('parent_child_links')
                        .insert({
                            parent_id: this.currentUser.id,
                            child_id: childId
                        });
                    
                    if (error) {
                        if (error.code === '23505') { // Unique violation
                            alert('This child is already linked to your account.');
                        } else {
                            throw error;
                        }
                    } else {
                        alert('Child account linked successfully!');
                        
                        // Remove this email from pending list
                        await this.removePendingEmail(childEmail, false);
                        
                        // Reload the children list
                        await this.loadLinkedChildren();
                    }
                } catch (error) {
                    console.error('Error linking child:', error);
                    alert('Unable to link child account. Please try again.');
                }
            }
            
            async removePendingEmail(email, showConfirm = true) {
                if (showConfirm && !confirm('Remove this email from pending children?')) {
                    return;
                }
                
                try {
                    // Get current pending emails
                    let pendingEmails = [];
                    if (this.userProfile && this.userProfile.parent_email) {
                        pendingEmails = this.userProfile.parent_email.split(',').map(e => e.trim()).filter(e => e.length > 0);
                    }
                    
                    // Remove the specified email
                    pendingEmails = pendingEmails.filter(e => e !== email);
                    
                    // Update the profile
                    const { error } = await this.supabase
                        .from('user_profiles')
                        .update({ 
                            parent_email: pendingEmails.join(', ')
                        })
                        .eq('id', this.currentUser.id);
                    
                    if (!error) {
                        // Update local profile
                        this.userProfile.parent_email = pendingEmails.join(', ');
                        
                        // Reload the children list
                        await this.loadLinkedChildren();
                    }
                } catch (error) {
                    console.error('Error removing pending email:', error);
                }
            }
            
            async viewChildDetails(childId) {
                try {
                    // Fetch child's complete data
                    const { data: child, error } = await this.supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', childId)
                        .single();
                    
                    if (child) {
                        // Get real progress data
                        const { data: progress } = await this.supabase
                            .from('student_progress')
                            .select('*')
                            .eq('student_id', childId);
                        
                        const overviewDiv = document.getElementById('children-overview');
                        if (overviewDiv) {
                            let progressHtml = '';
                            const subjects = ['Math Skills', 'Reading Comprehension', 'Science'];
                            
                            for (const subject of subjects) {
                                const subjectProgress = progress?.find(p => p.subject === subject);
                                const percentage = subjectProgress?.progress_percentage || 0;
                                progressHtml += `
                                    <p>${subject}</p>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                    </div>
                                    <small style="color: #666;">${percentage}% Complete</small>
                                `;
                            }
                            
                            overviewDiv.innerHTML = `
                                <h4>${child.first_name} ${child.last_name}</h4>
                                <p><strong>Grade:</strong> ${child.grade_level || 'Not set'}</p>
                                <p><strong>Username:</strong> ${child.username}</p>
                                <hr style="margin: 15px 0;">
                                <h5>Learning Progress</h5>
                                ${progressHtml}
                            `;
                        }
                    }
                } catch (error) {
                    console.error('Error loading child details:', error);
                }
            }

            async showChildrenTab() {
                console.log('showChildrenTab called');
                const childrenSection = document.getElementById('children-section');
                if (!childrenSection) {
                    console.error('Children section not found');
                    return;
                }
                
                try {
                    // Get linked children
                    const { data: links, error: linksError } = await this.supabase
                        .from('parent_child_links')
                        .select('child_id')
                        .eq('parent_id', this.currentUser.id);
                    
                    if (linksError) throw linksError;
                    
                    if (!links || links.length === 0) {
                        childrenSection.innerHTML = `
                            <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h2>
                            <div class="dashboard">
                                <div class="card">
                                    <p>No children linked yet.</p>
                                    <button class="btn btn-primary" onclick="portal.showTab('dashboard')">Go to Dashboard</button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Get children's profiles
                    const childIds = links.map(link => link.child_id);
                    const { data: children, error: childrenError } = await this.supabase
                        .from('user_profiles')
                        .select('*')
                        .in('id', childIds);
                    
                    if (childrenError) throw childrenError;
                    
                    let htmlContent = '<h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h2><div class="dashboard">';
                    
                    if (children && children.length > 0) {
                        for (const child of children) {
                            // Get progress data for this child
                            const { data: progress } = await this.supabase
                                .from('student_progress')
                                .select('*')
                                .eq('student_id', child.id);
                            
                            // Get recent grades for this child
                            const { data: grades } = await this.supabase
                                .from('student_grades')
                                .select('*')
                                .eq('student_id', child.id)
                                .order('date_received', { ascending: false })
                                .limit(3);
                            
                            // Get game stats
                            const { data: gameStats } = await this.supabase
                                .from('game_scores')
                                .select('*')
                                .eq('student_id', child.id);
                            
                            const totalGamesPlayed = gameStats?.length || 0;
                            const highScore = gameStats?.reduce((max, game) => Math.max(max, game.score), 0) || 0;
                            
                            // Build progress bars from real data
                            let progressHtml = '';
                            const subjects = ['Math Skills', 'Reading Comprehension', 'Science'];
                            
                            for (const subject of subjects) {
                                const subjectProgress = progress?.find(p => p.subject === subject);
                                const percentage = subjectProgress?.progress_percentage || 0;
                                progressHtml += `
                                    <p>${subject}</p>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${percentage}%;"></div>
                                    </div>
                                    <small style="color: #666;">${percentage}% Complete</small>
                                `;
                            }
                            
                            // Build grades from real data
                            let gradesHtml = '';
                            if (grades && grades.length > 0) {
                                gradesHtml = '<div class="stats">';
                                for (const grade of grades) {
                                    gradesHtml += `
                                        <div class="stat">
                                            <div class="stat-value">${grade.grade}</div>
                                            <div class="stat-label">${grade.assignment_name}</div>
                                        </div>
                                    `;
                                }
                                gradesHtml += '</div>';
                            } else {
                                gradesHtml = '<p style="color: #666;">No grades recorded yet</p>';
                            }
                            
                            htmlContent += `
                                <div class="card">
                                    <h3>${child.first_name} ${child.last_name}</h3>
                                    <p><strong>Grade:</strong> ${child.grade_level || 'Not set'}</p>
                                    <p><strong>Username:</strong> ${child.username}</p>
                                    <p><strong>Games Played:</strong> ${totalGamesPlayed} | <strong>High Score:</strong> ${highScore}</p>
                                    <hr style="margin: 15px 0;">
                                    <h4>üìä Progress</h4>
                                    ${progressHtml}
                                    <hr style="margin: 15px 0;">
                                    <h4>üìù Recent Grades</h4>
                                    ${gradesHtml}
                                </div>
                            `;
                        }
                    } else {
                        htmlContent += '<div class="card"><p>No children data available.</p></div>';
                    }
                    
                    htmlContent += '</div>';
                    childrenSection.innerHTML = htmlContent;
                    
                } catch (error) {
                    console.error('Error loading children tab:', error);
                    childrenSection.innerHTML = `
                        <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Your Children</h2>
                        <div class="dashboard">
                            <div class="card">
                                <p>Error loading children data.</p>
                                <p style="color: #dc3545;">${error.message}</p>
                                <button class="btn btn-primary" onclick="portal.showTab('dashboard')">Go to Dashboard</button>
                            </div>
                        </div>
                    `;
                }
            }

            // Enhanced showProgressTab for skill tree integration
            async showProgressTab() {
                const progressSection = document.getElementById('progress-section');
                if (!progressSection) return;
                
                try {
                    const subjects = ['Art', 'Math', 'Science', 'Reading'];
                    let progressHtml = '<h2>üìà Learning Progress</h2><div class="dashboard">';
                    
                    // Get skill tree progress for each subject
                    for (const subject of subjects) {
                        try {
                            const { data: summary } = await this.supabase
                                .rpc('get_child_skill_summary', { 
                                    child_id: this.currentUser.id, 
                                    subject_name: subject 
                                });
                            
                            if (summary && !summary.error) {
                                progressHtml += `
                                    <div class="card">
                                        <h3>${subject} Skills</h3>
                                        <div class="stats">
                                            <div class="stat">
                                                <div class="stat-value">${summary.unlocked_skills}</div>
                                                <div class="stat-label">Unlocked</div>
                                            </div>
                                            <div class="stat">
                                                <div class="stat-value">${summary.total_skills}</div>
                                                <div class="stat-label">Total Skills</div>
                                            </div>
                                            <div class="stat">
                                                <div class="stat-value">${summary.progress_percentage}%</div>
                                                <div class="stat-label">Complete</div>
                                            </div>
                                        </div>
                                        <div class="progress-bar" style="margin: 15px 0;">
                                            <div class="progress-fill" style="width: ${summary.progress_percentage}%;"></div>
                                        </div>
                                        <button class="btn btn-primary" onclick="portal.showTab('skills'); portal.loadSkillTree('${subject}')">
                                            View ${subject} Skill Tree
                                        </button>
                                    </div>
                                `;
                            }
                        } catch (error) {
                            console.error(`Error loading ${subject} progress:`, error);
                        }
                    }
                    
                    progressHtml += '</div>';
                    progressSection.innerHTML = progressHtml;
                    
                } catch (error) {
                    console.error('Error loading progress:', error);
                    progressSection.innerHTML = '<h2>üìà Progress</h2><p>Error loading progress data.</p>';
                }
            }
            
            async showGradesTab() {
                const gradesSection = document.getElementById('grades-section');
                if (!gradesSection) return;
                
                try {
                    const studentId = this.currentUser.id;
                    
                    // Get grades data
                    const { data: grades } = await this.supabase
                        .from('student_grades')
                        .select('*')
                        .eq('student_id', studentId)
                        .order('date_received', { ascending: false });
                    
                    let gradesHtml = '<h2>üìä Grades & Assignments</h2><div id="grades-content">';
                    
                    if (grades && grades.length > 0) {
                        // Group grades by subject
                        const gradesBySubject = {};
                        grades.forEach(grade => {
                            if (!gradesBySubject[grade.subject]) {
                                gradesBySubject[grade.subject] = [];
                            }
                            gradesBySubject[grade.subject].push(grade);
                        });
                        
                        gradesHtml += '<div class="dashboard">';
                        
                        for (const [subject, subjectGrades] of Object.entries(gradesBySubject)) {
                            gradesHtml += `
                                <div class="card">
                                    <h3>${subject}</h3>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid #dee2e6;">
                                                <th style="text-align: left; padding: 8px;">Assignment</th>
                                                <th style="text-align: center; padding: 8px;">Grade</th>
                                                <th style="text-align: right; padding: 8px;">Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            subjectGrades.forEach(grade => {
                                const date = new Date(grade.date_received).toLocaleDateString();
                                gradesHtml += `
                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                        <td style="padding: 8px;">${grade.assignment_name}</td>
                                        <td style="text-align: center; padding: 8px; font-weight: bold; color: #4facfe;">
                                            ${grade.grade}
                                        </td>
                                        <td style="text-align: right; padding: 8px; color: #666;">
                                            ${date}
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            gradesHtml += '</tbody></table></div>';
                        }
                        
                        gradesHtml += '</div>';
                    } else {
                        gradesHtml += '<p>No grades available yet</p>';
                    }
                    
                    gradesHtml += '</div>';
                    gradesSection.innerHTML = gradesHtml;
                    
                } catch (error) {
                    console.error('Error loading grades:', error);
                    gradesSection.innerHTML = '<h2>üìä Grades</h2><p>Error loading grades data.</p>';
                }
            }

            // Add Skills tab handling
            async showSkillsTab() {
                const skillsSection = document.getElementById('skills-section');
                if (!skillsSection) {
                    console.error('Skills section not found');
                    return;
                }
                
                const subjects = ['Art', 'Math', 'Science', 'Reading'];
                
                skillsSection.innerHTML = `
                    <h2>üåü Skill Trees</h2>
                    <div class="subject-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        ${subjects.map(subject => `
                            <button class="btn btn-primary" onclick="portal.loadSkillTree('${subject}')" style="margin-bottom: 10px;">
                                ${subject}
                            </button>
                        `).join('')}
                    </div>
                    <div id="skill-tree-container" style="width: 100%; height: 600px; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden; background: #f8f9fa;">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üåü</div>
                                <h3>Select a Subject</h3>
                                <p>Choose a subject above to explore your skill tree</p>
                            </div>
                        </div>
                    </div>
                `;
            }    
            
            async loadSkillTree(subject) {
                const container = document.getElementById('skill-tree-container');
                if (!container) return;
                
                try {
                    // Show loading state
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #0a0a2e;">
                            <div style="text-align: center; color: #d4af37;">
                                <div style="margin-bottom: 20px;">üåü</div>
                                <div>Loading ${subject} Skill Tree...</div>
                            </div>
                        </div>
                    `;
                    
                    // For now, skip database calls and just load the skill tree directly
                    console.log(`Loading skill tree for: ${subject}`);
                    
                    // Create iframe with CORRECT filename and subject parameter
                    container.innerHTML = `
                        <iframe 
                            id="skill-tree-frame"
                            src="SkillTreeViewer.html?subject=${encodeURIComponent(subject)}"
                            style="width: 100%; height: 100%; border: none;"
                            frameborder="0"
                        ></iframe>
                    `;
                    
                    const iframe = document.getElementById('skill-tree-frame');
                    iframe.onload = () => {
                        // Send initial data to skill tree after short delay
                        setTimeout(() => {
                            iframe.contentWindow.postMessage({
                                type: 'LOAD_SKILL_TREE',
                                subject: subject,
                                skillTreeData: null, // Will use hardcoded fallback for now
                                progress: {} // Start with empty progress for now
                            }, '*');
                        }, 100);
                    };
                    
                } catch (error) {
                    console.error('Error loading skill tree:', error);
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #dc3545;">
                            <h3>Error Loading Skill Tree</h3>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="portal.loadSkillTree('${subject}')">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
            
            // Add message listener in init()
            setupSkillTreeListener() {
                window.addEventListener('message', async (event) => {
                    if (event.data.type === 'SKILL_UNLOCKED') {
                        console.log('Skill unlocked:', event.data.skillName);
                        await this.saveSkillProgress(event.data.subject, event.data.progress);
                    }
                });
            }
            
            async saveSkillProgress(subject, skillStates) {
                try {
                    const totalUnlocked = Object.values(skillStates).filter(s => s === 'activated').length;
                    
                    const { error } = await this.supabase
                        .from('student_skill_progress')
                        .upsert({
                            student_id: this.currentUser.id,
                            subject: subject,
                            skill_states: skillStates,
                            total_unlocked: totalUnlocked,
                            last_updated: new Date()
                        });
                    
                    if (error) throw error;
                    console.log(`Progress saved: ${totalUnlocked} skills unlocked in ${subject}`);
                    
                } catch (error) {
                    console.error('Error saving progress:', error);
                }
            }
            
            showAddChildForm() {
                const childrenListDiv = document.getElementById('children-list');
                if (!childrenListDiv) return;
                
                childrenListDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>Link Child Account</h4>
                        <p style="margin-bottom: 15px;">Enter your child's account email address:</p>
                        <input type="email" id="child-email-link" placeholder="child@example.com" 
                               style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; margin-bottom: 10px;">
                        <button class="btn btn-primary" onclick="portal.linkChildAccount()">Link Account</button>
                        <button class="btn btn-secondary" onclick="portal.loadLinkedChildren()">Cancel</button>
                    </div>
                `;
            }
            
            async linkChildAccount() {
                const email = document.getElementById('child-email-link').value;
                if (!email) {
                    alert('Please enter your child\'s email address');
                    return;
                }
                
                try {
                    // Search for the child's account in user_profiles
                    const { data: profiles, error } = await this.supabase
                        .from('user_profiles')
                        .select('*')
                        .or(`email.eq.${email},username.eq.${email.split('@')[0]}`)
                        .eq('user_type', 'student')
                        .single();
                    
                    if (profiles) {
                        // Found the child's account - create the link
                        await this.autoLinkChild(profiles.id, email);
                    } else {
                        // Try adding to pending list
                        let pendingEmails = [];
                        if (this.userProfile && this.userProfile.parent_email) {
                            pendingEmails = this.userProfile.parent_email.split(',').map(e => e.trim());
                        }
                        
                        if (!pendingEmails.includes(email)) {
                            pendingEmails.push(email);
                            
                            const { error: updateError } = await this.supabase
                                .from('user_profiles')
                                .update({ 
                                    parent_email: pendingEmails.join(', ')
                                })
                                .eq('id', this.currentUser.id);
                            
                            if (!updateError) {
                                this.userProfile.parent_email = pendingEmails.join(', ');
                                alert('Email added to pending list. The child needs to create their account first.');
                            }
                        } else {
                            alert('This email is already in your pending list.');
                        }
                        
                        await this.loadLinkedChildren();
                    }
                } catch (error) {
                    console.error('Error linking child account:', error);
                    alert('Unable to find a student account with that email. Make sure they have registered as a student.');
                }
            }

            showTab(tabName) {
                // Hide all sections safely
                document.querySelectorAll('[id$="-section"]').forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                
                // Remove active class from all tabs safely
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab) tab.classList.remove('active');
                });
                
                // Show the requested section
                const section = document.getElementById(tabName + '-section');
                if (section) {
                    section.classList.remove('hidden');
                }
                
                // Activate the requested tab
                const tab = document.getElementById(tabName + '-tab');
                if (tab) {
                    tab.classList.add('active');
                }
            
                // Special handling for specific tabs
                try {
                    if (tabName === 'children') {
                        this.showChildrenTab();
                    } else if (tabName === 'skills') {
                        this.showSkillsTab();
                    } else if (tabName === 'grades') {
                        this.showGradesTab();
                    }
                } catch (error) {
                    console.error(`Error loading ${tabName} tab:`, error);
                }
            }

            showAlert(message, type) {
                const alertsContainer = document.getElementById('auth-alerts');
                if (!alertsContainer) return;
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-' + type;
                alertDiv.textContent = message;
                alertsContainer.innerHTML = '';
                alertsContainer.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            async logout() {
                try {
                    // Set a timeout for Supabase logout
                    const logoutPromise = this.supabase ? this.supabase.auth.signOut() : Promise.resolve();
                    const timeoutPromise = new Promise((resolve) => setTimeout(resolve, 3000)); // 3 second timeout
                    
                    await Promise.race([logoutPromise, timeoutPromise]);
                } catch (error) {
                    console.log('Logout error (continuing anyway):', error);
                }
                
                // Force logout regardless of Supabase response
                this.currentUser = null;
                this.userProfile = null;
                
                // Hide all sections EXCEPT login
                const setupSection = document.getElementById('setup-section');
                if (setupSection) setupSection.classList.add('hidden');
                
                const loginSection = document.getElementById('login-section');
                if (loginSection) loginSection.classList.remove('hidden');
                
                const dashboardSection = document.getElementById('dashboard-section');
                if (dashboardSection) dashboardSection.classList.add('hidden');
                
                const gamesSection = document.getElementById('games-section');
                if (gamesSection) gamesSection.classList.add('hidden');
                
                const skillsSection = document.getElementById('skills-section');
                if (skillsSection) skillsSection.classList.add('hidden');
                
                const gradesSection = document.getElementById('grades-section');
                if (gradesSection) gradesSection.classList.add('hidden');
                
                const childrenSection = document.getElementById('children-section');
                if (childrenSection) childrenSection.classList.add('hidden');
                
                // Hide ALL tabs for logged out users
                const setupTab = document.getElementById('setup-tab');
                if (setupTab) setupTab.style.display = 'none';
                
                const loginTab = document.getElementById('login-tab');
                if (loginTab) loginTab.style.display = 'none';
                
                const dashboardTab = document.getElementById('dashboard-tab');
                if (dashboardTab) dashboardTab.style.display = 'none';
                
                const gamesTab = document.getElementById('games-tab');
                if (gamesTab) gamesTab.style.display = 'none';
                
                const skillsTab = document.getElementById('skills-tab');
                if (skillsTab) skillsTab.style.display = 'none';
                
                const gradesTab = document.getElementById('grades-tab');
                if (gradesTab) gradesTab.style.display = 'none';
                
                const childrenTab = document.getElementById('children-tab');
                if (childrenTab) childrenTab.style.display = 'none';
                
                // Hide logout button
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) logoutBtn.classList.add('hidden');
                
                // Reset welcome message to generic
                const welcomeMessage = document.getElementById('welcome-message');
                if (welcomeMessage) welcomeMessage.textContent = 'Welcome to your learning dashboard';
                
                // Clear any active tab styling
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    if (tab) tab.classList.remove('active');
                });
                
                // Clear form fields safely
                const emailField = document.getElementById('email');
                const passwordField = document.getElementById('password');
                if (emailField) emailField.value = '';
                if (passwordField) passwordField.value = '';
                
                console.log('Logout completed - all tabs hidden');
            }

        function showLoginForm() {
            portal.showLoginForm();
        }

        function showRegisterForm() {
            portal.showRegisterForm();
        }

        function playGame(gameId) {
            const gameTitle = {
                'math-adventure': 'üî¢ Math Adventure',
                'word-wizard': 'üìö Word Wizard',
                'science-lab': 'üß™ Science Lab',
                'history-quest': 'üèõÔ∏è History Quest'
            }[gameId];

            document.getElementById('current-game-title').textContent = gameTitle;
            document.getElementById('game-iframe-container').classList.remove('hidden');
            
            const iframe = document.getElementById('game-iframe');
            iframe.src = 'data:text/html,<html><body style="font-family: Arial; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><h1>' + gameTitle + '</h1><p>Game would load here!</p><p>This is where your HTML5 educational games would be embedded.</p></body></html>';
        }

        function closeGame() {
            document.getElementById('game-iframe-container').classList.add('hidden');
            document.getElementById('game-iframe').src = '';
        }

        async function deleteAccount() {
            const confirmDelete = confirm(
                'Are you sure you want to delete your account?\n\n' +
                'This will permanently remove:\n' +
                '‚Ä¢ Your profile and progress data\n' +
                '‚Ä¢ Game saves and achievements\n' +
                '‚Ä¢ All associated records\n\n' +
                'This action cannot be undone!'
            );
            
            if (!confirmDelete) return;
            
            const doubleConfirm = prompt(
                'Type "DELETE" to confirm account deletion:'
            );
            
            if (doubleConfirm !== 'DELETE') {
                alert('Account deletion cancelled.');
                return;
            }
            
            try {
                const deleteBtn = document.getElementById('delete-account-btn');
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'Deleting...';
                
                // Call the server-side delete function
                const { data, error } = await portal.supabase.rpc('delete_user_account');
                
                if (error) {
                    throw error;
                }
                
                if (data && !data.success) {
                    throw new Error(data.error);
                }
                
                alert('Account deleted successfully! You will be redirected to the login page.');
                
                // Clear everything and redirect
                portal.currentUser = null;
                portal.userProfile = null;
                sessionStorage.clear();
                
                // Force complete page reload
                portal.logout();
                
            } catch (error) {
                console.error('Account deletion error:', error);
                alert('Error deleting account: ' + error.message);
                
                // Re-enable button
                const deleteBtn = document.getElementById('delete-account-btn');
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'üóëÔ∏è Delete My Account';
                }
            }
        }

        // Initialize the portal
        const portal = new StudentPortal();
    </script>
</body>
</html>
