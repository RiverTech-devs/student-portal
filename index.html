<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Learning Portal</title>
    
    <!-- Load shared configuration first -->
    <script src="shared/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
       :root{
          --bg:#0f1216;
          --card:#151a21;
          --text:#e6edf3;
          --muted:#97a2b0;
          --accent:#6aa9ff;
          --accent-2:#8bffb0;
          --danger:#ff6a6a;
          --warning:#ffd36a;
          --link:#a0c2ff;
          --border:#2a3140;
          
          /* Unified theme variables */
          --primary: var(--accent);
          --secondary: var(--accent-2);
          --background: var(--bg);
          --card-bg: var(--card);
          --text-color: var(--text);
          --muted-color: var(--muted);
          --border-color: var(--border);
        }
        
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{height:100%}
        body{
          font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell;
          background:var(--bg);
          color:var(--text);
          -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
        }
        
        /* Shell */
        .container{
          background:var(--card);
          border:1px solid var(--border);
          border-radius:16px;
          width:100%; max-width:1200px; min-height:600px; overflow:hidden;
          box-shadow:0 10px 30px rgba(0,0,0,.35);
          margin: 20px auto;
        }
        
        /* Header */
        .header{
          background:rgba(0,0,0,.25);
          border-bottom:1px solid var(--border);
          color:var(--text);
          padding:16px 20px;
          text-align:center;
          position:relative;
        }
        .header h1{font-size:20px;letter-spacing:.3px}
        #welcome-message{opacity:.85}
        .logout-btn{
          position:absolute; right:20px; top:50%; transform:translateY(-50%);
          background:#0c1118; border:1px solid #223041; color:#e5e7eb;
          padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer;
        }
        .logout-btn:hover{border-color:var(--accent-2); box-shadow:0 0 0 2px rgba(139,255,176,.08)}
        
        /* Top nav tabs */
        .nav-tabs{
          display:flex; gap:0; background:#0c1118; border-bottom:1px solid var(--border);
        }
        .nav-tab{
          flex:1; padding:12px 14px; text-align:center; cursor:pointer; border:0;
          background:transparent; color:#c7d2fe;
          transition:color .15s ease, background-color .15s ease, border-color .15s ease;
          display: inline-block;
          text-decoration: none;
          font-family: inherit;
          font-size: inherit;
        }
        .nav-tab:hover{background:rgba(255,255,255,.02); color:#a5b4fc}
        .nav-tab.active{
          color:var(--accent); font-weight:700; border-bottom:3px solid var(--accent); background:#0b0f14;
        }
        
        /* Content area */
        .content{padding:20px; min-height:400px}
        
        /* Cards & layout */
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-top:16px}
        .card{
          background:#0c1118;
          border:1px solid #223041;
          border-radius:12px; padding:16px;
          box-shadow:0 6px 16px rgba(0,0,0,.25);
        }
        .card h3{margin-bottom:8px}
        
        /* Forms */
        .form-group{margin-bottom:14px; text-align:left}
        .form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--text)}
        .form-group input,.form-group select, .form-group textarea{
          width:100%; padding:10px 12px; border-radius:10px;
          background:#0e1319; color:var(--text); border:1px solid var(--border); font-size:14px;
        }
        .auth-form{max-width:400px;margin:0 auto;text-align:center}
        
        /* Buttons */
        .btn{
          appearance:none; border:1px solid #223041; background:#0c1118; color:#e5e7eb;
          padding:6px 10px; border-radius:6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; cursor:pointer;
          transition:border-color .15s ease, box-shadow .15s ease, background-color .15s ease, transform .02s ease;
        }
        .btn:hover{border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.1), inset 0 0 0 1px rgba(57,255,136,.15); background:#0b0f14}
        .btn:active{transform:translateY(0)}
        .btn.small{padding:4px 8px; font-size:11px; letter-spacing:.09em}
        
        .btn-primary{
          background:linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
          color:#0b0f14; border-color:transparent;
        }
        .btn-primary:hover{filter:brightness(1.05)}
        .btn-secondary{background:#2b3442;color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{border-color:var(--accent)}
        
        .btn-danger{background:#dc3545;color:#fff;border:1px solid #dc3545}
        .btn-danger:hover{background:#c82333;border-color:#bd2130; box-shadow:0 0 0 2px rgba(220,53,69,.25)}
        
        .hidden{display:none}
        
        /* Alerts */
        .alert{padding:12px;border-radius:8px;margin:12px 0;border:1px solid var(--border)}
        .alert-success{background:rgba(139,255,176,.08); color:#b5ffd0; border-color:rgba(139,255,176,.25)}
        .alert-error{background:rgba(255,107,107,.08); color:#ffb3b3; border-color:rgba(255,107,107,.25)}
        
        /* Stats */
        .stats{display:flex;justify-content:space-between;gap:12px;margin:10px 0}
        .stat{text-align:center}
        .stat-value{font-size:22px;font-weight:700;color:var(--accent)}
        .stat-label{font-size:12px;color:var(--muted)}
        
        /* Progress */
        .progress-bar{background:#0e1319;border:1px solid var(--border);border-radius:10px;height:16px;overflow:hidden;margin:10px 0}
        .progress-fill{background:linear-gradient(90deg,var(--accent),var(--accent-2));height:100%;border-radius:10px;transition:width .3s ease}
        
        /* Game grid/cards */
        .game-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:16px}
        .game-card{
          background:#0b1017; border:1px solid #1a2330; color:#e5e7eb;
          border-radius:12px; padding:16px; text-align:center; cursor:pointer; transition:transform .2s ease, border-color .15s ease, box-shadow .15s ease;
        }
        .game-card:hover{transform:translateY(-4px); border-color:#39ff88; box-shadow:0 0 0 2px rgba(57,255,136,.08)}
        
        /* Tables */
        table{width:100%;border-collapse:collapse;margin-top:8px}
        th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
        
        /* Links */
        a{color:var(--link)}
        a:hover{color:var(--accent)}
        
        /* Unified Navigation Integration */
        .main-wrapper {
          display: flex;
          flex-direction: column;
          min-height: 100vh;
        }
        
        .portal-content {
          flex: 1;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }
        
        /* When authenticated, adjust layout */
        .authenticated .portal-content {
          align-items: flex-start;
          padding-top: 0;
        }
        
        /* Hide old navigation when unified nav is present */
        .authenticated .header {
          display: none;
        }
        
        .authenticated .nav-tabs {
          display: none;
        }
        
        .authenticated .container {
          margin: 0;
          border-radius: 0;
          border: none;
          box-shadow: none;
          background: transparent;
          max-width: none;
          width: 100%;
        }
        
        /* Animations */
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

        /* Math Placement Test Banner */
        .placement-banner {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          padding: 20px;
          margin: 20px 0;
          text-align: center;
          color: white;
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .placement-banner h3 {
          margin-bottom: 10px;
          font-size: 1.3rem;
        }
        
        .placement-banner p {
          margin-bottom: 15px;
          opacity: 0.9;
        }
        
        .placement-test-btn {
          background: rgba(255, 255, 255, 0.2);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          text-decoration: none;
          display: inline-block;
        }
        
        .placement-test-btn:hover {
          background: rgba(255, 255, 255, 0.3);
          border-color: rgba(255, 255, 255, 0.5);
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Unified navigation will be inserted here when authenticated -->
        <div id="unified-nav-container"></div>
        
        <div class="portal-content">
            <div class="container">
                <div class="header">
                    <h1>🎓 Student Learning Portal</h1>
                    <p id="welcome-message">Welcome to your learning dashboard</p>
                    <button class="logout-btn hidden" id="logout-btn">Logout</button>
                </div>

                <div class="nav-tabs">
                    <button class="nav-tab" id="login-tab">Login</button>
                    <button class="nav-tab" id="dashboard-tab" style="display:none;">Dashboard</button>
                    <button class="nav-tab" id="games-tab" style="display:none;">Games</button>
                    <button class="nav-tab" id="skills-tab" style="display:none;">Skills</button>
                    <button class="nav-tab" id="grades-tab" style="display:none;">Grades</button>
                    <a class="nav-tab" id="portal-tab" href="portal/" style="display:none;">📚 Classes & Messaging</a>
                </div>

                <div class="content">
                    <!-- Login Section -->
                    <div id="login-section" class="hidden">
                        <div class="auth-form">
                            <h2>Student Portal Login</h2>
                            <div id="auth-alerts"></div>
                            <!-- Math Placement Test Banner -->
                            <div class="placement-banner">
                                <h3>📐 Math Placement Test</h3>
                                <p>Discover your math level and get personalized course recommendations</p>
                                <a href="tests/math-placement-test.html" class="placement-test-btn">
                                    🚀 Take Placement Test
                                </a>
                            </div>
                           <form id="login-form">
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="password">Password</label>
                                    <input type="password" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
                                <button type="button" class="btn btn-secondary" id="register-btn">Register New Account</button>
                                <p style="margin-top: 15px; text-align: center;">
                                    <a href="#" id="forgot-password-link" style="color: #4facfe;">Forgot Password?</a>
                                </p>
                            </form>

                            <form id="register-form" class="hidden">
                                <h3>Create New Account</h3>
                                <div class="form-group">
                                    <label for="reg-email">Email Address</label>
                                    <input type="email" id="reg-email" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-password">Password</label>
                                    <input type="password" id="reg-password" required minlength="6">
                                </div>
                                <div class="form-group">
                                    <label for="reg-username">Username</label>
                                    <input type="text" id="reg-username" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-firstname">First Name</label>
                                    <input type="text" id="reg-firstname" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-lastname">Last Name</label>
                                    <input type="text" id="reg-lastname" required>
                                </div>
                                <div class="form-group">
                                    <label for="reg-usertype">Account Type</label>
                                    <select id="reg-usertype" required>
                                        <option value="student">Student</option>
                                        <option value="parent">Parent</option>
                                        <option value="teacher">Teacher</option>
                                    </select>
                                </div>
                                <div class="form-group" id="grade-group">
                                    <label for="reg-grade">Grade Level (for students)</label>
                                    <select id="reg-grade">
                                        <option value="">Select Grade</option>
                                        <option value="K">Kindergarten</option>
                                        <option value="1">1st Grade</option>
                                        <option value="2">2nd Grade</option>
                                        <option value="3">3rd Grade</option>
                                        <option value="4">4th Grade</option>
                                        <option value="5">5th Grade</option>
                                        <option value="6">6th Grade</option>
                                        <option value="7">7th Grade</option>
                                        <option value="8">8th Grade</option>
                                        <option value="9">9th Grade</option>
                                        <option value="10">10th Grade</option>
                                        <option value="11">11th Grade</option>
                                        <option value="12">12th Grade</option>
                                    </select>
                                </div>
                                <div class="form-group" id="child-email-group" style="display:none;">
                                    <label for="child-emails">Children's Email Addresses</label>
                                    <textarea id="child-emails" rows="4" placeholder="Enter each child's email address on a separate line:&#10;child1@yourschool.edu&#10;child2@yourschool.edu&#10;child3@yourschool.edu" style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;"></textarea>
                                    <small style="color: #666; font-size: 12px;">Enter one email address per line for each child's student account</small>
                                </div>
                                <button type="submit" class="btn btn-primary" id="register-submit-btn">Register</button>
                                <button type="button" class="btn btn-secondary" id="back-to-login-btn">Back to Login</button>
                            </form>
                        </div>
                    </div>

                    <!-- Dashboard Section -->
                    <div id="dashboard-section" class="hidden">
                        <!-- Content will be populated by JavaScript -->
                    </div>

                    <!-- Games Section -->
                    <div id="games-section" class="hidden">
                        <h2>🎮 Educational Games</h2>
                        <div class="game-list">
                            <div class="game-card" data-game="mathletics">
                                <h3>🎯 Mathletics</h3>
                                <p>Master multiplication facts through adaptive practice</p>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value" id="mathletics-range">0-2</div>
                                        <div class="stat-label">Current Range</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value" id="mathletics-mastery">Bronze</div>
                                        <div class="stat-label">Mastery Level</div>
                                    </div>
                                </div>
                            </div>
                            <div class="game-card" data-game="word-wizard">
                                <h3>📚 Word Wizard</h3>
                                <p>Spelling and vocabulary</p>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value">Level 1</div>
                                        <div class="stat-label">Current Level</div>
                                    </div>
                                </div>
                            </div>
                            <div class="game-card" data-game="science-lab">
                                <h3>🧪 Science Lab</h3>
                                <p>Fun science experiments</p>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value">Level 1</div>
                                        <div class="stat-label">Current Level</div>
                                    </div>
                                </div>
                            </div>
                            <div class="game-card" data-game="history-quest">
                                <h3>🏛️ History Quest</h3>
                                <p>Explore historical events</p>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value">New!</div>
                                        <div class="stat-label">Try it out</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="game-iframe-container" class="hidden" style="margin-top: 30px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 id="current-game-title"></h3>
                                <button class="btn btn-secondary" id="close-game-btn">Close Game</button>
                            </div>
                            <iframe id="game-iframe" width="100%" height="500" frameborder="0"></iframe>
                        </div>
                    </div>

                    <!-- Skills Section -->
                    <div id="skills-section" class="hidden">
                        <h2>🌟 Skill Trees</h2>
                        <div class="subject-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button class="btn btn-primary skill-tree-btn" data-subject="Art" style="margin-bottom: 10px;">
                                🎨 Art
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Math" style="margin-bottom: 10px;">
                                📐 Math
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Science" style="margin-bottom: 10px;">
                                🔬 Science
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Reading" style="margin-bottom: 10px;">
                                📚 Reading
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Programming" style="margin-bottom: 10px;">
                                💻 Programming
                            </button>
                            <button class="btn btn-primary skill-tree-btn" data-subject="Robotics" style="margin-bottom: 10px;">
                                🤖 Robotics
                            </button>
                        </div>
                        <div id="skill-tree-container" style="width: 100%; height: 600px; border: 2px solid #dee2e6; border-radius: 10px; overflow: hidden; background: #f8f9fa;">
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 20px;">🌟</div>
                                    <h3>Select a Subject</h3>
                                    <p>Choose a subject above to explore your skill tree</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grades Section -->
                    <div id="grades-section" class="hidden">
                        <h2>📊 Grades & Assignments</h2>
                        <div id="grades-content">
                            <p>No grades available yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced StudentPortal class with unified integration
        class StudentPortal {
            constructor() {
                this.initialized = false;
                this.currentSection = 'dashboard';
                this.eventListeners = new Set();
                this.skillTreeIntegration = null;
                
                // Wait for shared auth to be ready
                this.waitForAuth().then(() => {
                    this.init();
                });
            }

            async waitForAuth() {
                // Wait for portalAuth to be initialized
                while (!window.portalAuth || !window.portalAuth.initialized) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                this.auth = window.portalAuth;
            }

            async init() {
                if (this.initialized) return;
                this.initialized = true;
                
                console.log('🚀 Initializing StudentPortal with unified auth...');
                
                // Set up skill tree integration
                this.skillTreeIntegration = new SkillTreeIntegration(this);
                await this.skillTreeIntegration.initialize();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Listen for auth state changes
                window.addEventListener('portalAuthChange', (e) => {
                    this.handleAuthStateChange(e.detail);
                });
                
                // Check initial auth state
                if (this.auth.isAuthenticated()) {
                    this.showAuthenticatedState();
                } else {
                    this.showLoginForm();
                }
                
                // Handle hash navigation
                this.handleHashNavigation();
                window.addEventListener('hashchange', () => this.handleHashNavigation());

                // Handle messages from Mathletics iframe
                window.addEventListener('message', (event) => {
                    if (event.data.action === 'closeGame') {
                        this.closeGame();
                    } else if (event.data.action === 'progressUpdated') {
                        // Refresh Mathletics progress display
                        setTimeout(() => this.updateMathleticsProgress(), 1000);
                    }
                });
                
                console.log('✅ StudentPortal initialized');
            }

            handleAuthStateChange(detail) {
                if (detail.event === 'SIGNED_IN') {
                    this.showAuthenticatedState();
                    window.PortalUI.showNotification(`Welcome back, ${detail.profile?.first_name || 'User'}!`, 'success');
                } else if (detail.event === 'SIGNED_OUT') {
                    this.showLoginForm();
                    document.body.classList.remove('authenticated');
                }
            }

            showAuthenticatedState() {
                document.body.classList.add('authenticated');

                const userInfo = this.auth.getUserInfo();

                // Check if user has a profile
                if (!userInfo.hasProfile) {
                    // Show a message that they need to complete registration
                    const container = document.querySelector('.content');
                    if (container) {
                        container.innerHTML = `
                            <div class="card" style="max-width: 500px; margin: 50px auto; text-align: center;">
                                <h2>⚠️ Profile Incomplete</h2>
                                <p>Your account exists but your profile is missing.</p>
                                <p>This can happen if registration wasn't completed properly.</p>
                                <br>
                                <p>Please contact support or try logging out and registering again.</p>
                                <br>
                                <button class="btn btn-primary" onclick="window.portalAuth.logout()">
                                    Logout and Try Again
                                </button>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Show unified navigation
                const navContainer = document.getElementById('unified-nav-container');
                if (navContainer) {
                    navContainer.innerHTML = window.PortalUI.createUnifiedNavigation('main', this.currentSection);
                }
                
                // Hide login elements
                const loginSection = document.getElementById('login-section');
                if (loginSection) loginSection.classList.add('hidden');
                
                // Show appropriate dashboard
                if (userInfo.profile?.user_type === 'parent' || userInfo.profile?.user_type === 'teacher') {
                    this.loadParentTeacherDashboard();
                } else {
                    this.loadStudentDashboard();
                    setTimeout(() => this.updateMathleticsProgress(), 500);  // Update Mathletics progress
                }
                
                this.showTab('dashboard');
            }

            showLoginForm() {
                document.body.classList.remove('authenticated');
                
                // Hide unified navigation
                const navContainer = document.getElementById('unified-nav-container');
                if (navContainer) navContainer.innerHTML = '';
                
                // Show login
                this.showTab('login');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                if (loginForm) loginForm.classList.remove('hidden');
                if (registerForm) registerForm.classList.add('hidden');
            }

            handleHashNavigation() {
                const hash = window.location.hash.substring(1);
                const validSections = ['dashboard', 'games', 'skills', 'grades'];
                
                if (hash && validSections.includes(hash)) {
                    if (this.auth.isAuthenticated()) {
                        this.showTab(hash);
                    } else {
                        this.showTab('login');
                    }
                } else if (this.auth.isAuthenticated()) {
                    this.showTab('dashboard');
                }
            }

            setupEventListeners() {
                // Auth forms
                this.addSafeEventListener('login-form', 'submit', (e) => this.handleLogin(e));
                this.addSafeEventListener('register-form', 'submit', (e) => this.handleRegister(e));
                
                // Auth navigation
                this.addSafeEventListener('register-btn', 'click', () => this.showRegisterForm());
                this.addSafeEventListener('back-to-login-btn', 'click', () => this.showLoginForm());
                this.addSafeEventListener('forgot-password-link', 'click', (e) => {
                    e.preventDefault();
                    this.showForgotPasswordForm();
                });
                
                // User type handling
                this.addSafeEventListener('reg-usertype', 'change', (e) => this.handleUserTypeChange(e));
                
                // Legacy tab navigation (for when not authenticated)
                this.addSafeEventListener('login-tab', 'click', () => this.showTab('login'));
                this.addSafeEventListener('dashboard-tab', 'click', () => this.showTab('dashboard'));
                this.addSafeEventListener('games-tab', 'click', () => this.showTab('games'));
                this.addSafeEventListener('skills-tab', 'click', () => this.showTab('skills'));
                this.addSafeEventListener('grades-tab', 'click', () => this.showTab('grades'));
                
                // Game and skill interactions
                this.addGameCardListeners();
                this.addSkillTreeListeners();
                this.addSafeEventListener('close-game-btn', 'click', () => this.closeGame());
                
                // Legacy logout
                this.addSafeEventListener('logout-btn', 'click', () => this.auth.logout());
            }

            addSafeEventListener(elementId, event, handler) {
                const element = document.getElementById(elementId);
                if (element) {
                    const listenerKey = `${elementId}-${event}`;
                    if (this.eventListeners.has(listenerKey)) {
                        element.removeEventListener(event, handler);
                    }
                    element.addEventListener(event, handler);
                    this.eventListeners.add(listenerKey);
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const email = document.getElementById('email')?.value;
                const password = document.getElementById('password')?.value;
                const loginBtn = document.getElementById('login-btn');

                if (!email || !password) {
                    window.PortalUI.showNotification('Please enter email and password', 'error');
                    return;
                }

                if (loginBtn) {
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Logging in...';
                }

                try {
                    const { data, error } = await this.auth.supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    // Success is handled by auth state change listener
                } catch (error) {
                    console.error('Login error:', error);
                    window.PortalUI.showNotification(error.message, 'error');
                } finally {
                    if (loginBtn) {
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login';
                    }
                }
            }

            async handleRegister(e) {
                e.preventDefault();
                
                const email = document.getElementById('reg-email')?.value;
                const password = document.getElementById('reg-password')?.value;
                const username = document.getElementById('reg-username')?.value;
                const firstName = document.getElementById('reg-firstname')?.value;
                const lastName = document.getElementById('reg-lastname')?.value;
                const grade = document.getElementById('reg-grade')?.value;
                const userType = document.getElementById('reg-usertype')?.value;
                const childEmailsTextarea = document.getElementById('child-emails');
            
                const registerBtn = document.getElementById('register-submit-btn');
            
                if (!email || !password || !username || !firstName || !lastName || !userType) {
                    window.PortalUI.showNotification('Please fill in all required fields', 'error');
                    return;
                }
            
                if (registerBtn) {
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'Registering...';
                }
            
                try {
                    // First, try to sign up with Supabase Auth
                    const { data: authData, error: authError } = await this.auth.supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            emailRedirectTo: `${window.location.origin}/student-portal/confirm.html`
                        }
                    });
            
                    // Handle auth errors
                    if (authError) {
                        if (authError.message.includes('already registered')) {
                            throw new Error('This email is already registered. Please login or reset your password.');
                        }
                        throw authError;
                    }
            
                    // Check if signup actually created a new user or returned existing
                    if (!authData.user) {
                        throw new Error('Registration failed. Please try again.');
                    }
            
                    // If user.identities is empty, user already existed
                    if (authData.user.identities && authData.user.identities.length === 0) {
                        throw new Error('An account with this email already exists. Please login instead.');
                    }
            
                    // Check if profile already exists (in case of partial registration)
                    const { data: existingProfile, error: checkError } = await this.auth.supabase
                        .from('user_profiles')
                        .select('id')
                        .eq('id', authData.user.id);
            
                    if (!checkError && existingProfile && existingProfile.length > 0) {
                        console.log('Profile already exists for this user, skipping profile creation');
                    } else {
                        // Create the user profile
                        const { error: profileError } = await this.auth.supabase
                            .from('user_profiles')
                            .insert({
                                id: authData.user.id,
                                email: email,
                                username: username,
                                first_name: firstName,
                                last_name: lastName,
                                user_type: userType,
                                grade_level: userType === 'student' ? grade : null
                            });
            
                        if (profileError) {
                            // If profile creation fails, we have an auth user with no profile
                            console.error('Profile creation error:', profileError);
                            
                            // Try to clean up the auth user
                            try {
                                await this.auth.supabase.auth.admin.deleteUser(authData.user.id);
                            } catch (deleteError) {
                                console.error('Could not clean up auth user:', deleteError);
                            }
                            
                            if (profileError.message.includes('duplicate key')) {
                                throw new Error('A profile with this email or username already exists.');
                            }
                            throw new Error(`Profile creation failed: ${profileError.message}`);
                        }
                    }
            
                    // If parent, handle child relationships
                    if (userType === 'parent' && childEmailsTextarea) {
                        const childEmails = childEmailsTextarea.value
                            .split('\n')
                            .map(email => email.trim())
                            .filter(email => email.length > 0);
            
                        if (childEmails.length > 0) {
                            // Don't let this fail registration
                            try {
                                await this.linkParentToChildren(authData.user.id, childEmails);
                            } catch (linkError) {
                                console.error('Error linking children:', linkError);
                                // Continue anyway - they can link children later
                            }
                        }
                    }
            
                    window.PortalUI.showNotification('Registration successful! Please check your email to verify your account.', 'success');
                    this.showLoginForm();
            
                } catch (error) {
                    console.error('Registration error:', error);
                    const errorMessage = error.message || 'Registration failed. Please try again.';
                    window.PortalUI.showNotification(errorMessage, 'error');
                } finally {
                    if (registerBtn) {
                        registerBtn.disabled = false;
                        registerBtn.textContent = 'Register';
                    }
                }
            }

            async linkParentToChildren(parentId, childEmails) {
                const results = [];
                
                for (const childEmail of childEmails) {
                    try {
                        // First find the child's user ID
                        const { data: childProfile, error: childError } = await this.auth.supabase
                            .from('user_profiles')
                            .select('id')
                            .eq('email', childEmail)
                            .single();
                        
                        if (childError || !childProfile) {
                            console.warn(`Child account not found for email: ${childEmail}`);
                            continue;
                        }
            
                        // Use UPSERT with the correct table name
                        const { data, error } = await this.auth.supabase
                            .from('parent_child_links')  // Correct table name
                            .upsert({
                                parent_id: parentId,
                                child_id: childProfile.id,
                                created_at: new Date().toISOString()
                            }, {
                                onConflict: 'parent_id,child_id',
                                ignoreDuplicates: false
                            });
            
                        if (error) {
                            console.error(`Error linking to child ${childEmail}:`, error);
                        } else {
                            results.push({ email: childEmail, success: true });
                        }
                        
                    } catch (error) {
                        console.error(`Failed to link parent to child ${childEmail}:`, error);
                    }
                }
                
                const successCount = results.filter(r => r.success).length;
                if (successCount > 0) {
                    console.log(`Successfully linked to ${successCount} child account(s)`);
                }
                
                return results;
            }

            async handlePasswordReset(e) {
                e.preventDefault();
                
                const emailInput = document.getElementById('forgot-email');
                const resetBtn = document.getElementById('send-reset-btn');
                const form = document.getElementById('forgot-password-form');
                const successMessage = document.getElementById('reset-success-message');
                
                if (!emailInput || !resetBtn) return;
                
                const email = emailInput.value.trim();
                
                if (!email) {
                    window.PortalUI?.showNotification('Please enter your email address', 'error') || 
                    alert('Please enter your email address');
                    return;
                }
            
                // Disable button and show loading state
                resetBtn.disabled = true;
                resetBtn.textContent = 'Sending...';
            
                try {
                    // Use Supabase's built-in password reset
                    const { error } = await this.auth.supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: `${window.location.href.split('/').slice(0, -1).join('/')}/reset.html`
                    });
            
                    if (error) {
                        throw error;
                    }
            
                    // Show success message
                    if (form) form.classList.add('hidden');
                    if (successMessage) successMessage.classList.remove('hidden');
            
                    // Also show a notification
                    window.PortalUI?.showNotification('Password reset email sent! Check your inbox.', 'success') ||
                    alert('Password reset email sent! Check your inbox.');
            
                } catch (error) {
                    console.error('Password reset error:', error);
                    
                    let errorMessage = 'Failed to send reset email. ';
                    
                    if (error.message.includes('User not found')) {
                        errorMessage += 'No account found with this email address.';
                    } else if (error.message.includes('Email rate limit')) {
                        errorMessage += 'Too many requests. Please wait before trying again.';
                    } else {
                        errorMessage += error.message;
                    }
            
                    window.PortalUI?.showNotification(errorMessage, 'error') || 
                    alert(errorMessage);
            
                } finally {
                    // Re-enable button
                    if (resetBtn) {
                        resetBtn.disabled = false;
                        resetBtn.textContent = 'Send Reset Link';
                    }
                }
            }
            
            closeForgotPasswordModal() {
                this.closeModal();
            }
            
            // You'll also need to add this method to handle the modal system
            showModal(id, title, content) {
                // Remove existing modal
                const existingModal = document.getElementById('portal-modal');
                if (existingModal) existingModal.remove();
            
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'portal-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
            
                modal.innerHTML = `
                    <div style="
                        background: var(--card);
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        padding: 20px;
                        max-width: 500px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                    ">
                        <h3 style="margin-bottom: 20px; color: var(--text);">${title}</h3>
                        ${content}
                    </div>
                `;
            
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal();
                    }
                });
            
                document.body.appendChild(modal);
            }
            
            closeModal() {
                const modal = document.getElementById('portal-modal');
                if (modal) modal.remove();
            }

            handleUserTypeChange(e) {
                const userType = e.target.value;
                const isStudent = userType === 'student';
                const isParent = userType === 'parent';
                
                const gradeGroup = document.getElementById('grade-group');
                const childEmailGroup = document.getElementById('child-email-group');
                
                if (gradeGroup) gradeGroup.style.display = isStudent ? 'block' : 'none';
                if (childEmailGroup) childEmailGroup.style.display = isParent ? 'block' : 'none';
            }

            showRegisterForm() {
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                
                if (loginForm) loginForm.classList.add('hidden');
                if (registerForm) registerForm.classList.remove('hidden');
            }

            showForgotPasswordForm() {
                const modalContent = `
                    <div style="text-align: center; padding: 20px;">
                        <h3 style="margin-bottom: 20px;">Reset Password</h3>
                        <p style="margin-bottom: 20px; color: var(--muted);">
                            Enter your email address and we'll send you a link to reset your password.
                        </p>
                        
                        <form id="forgot-password-form">
                            <div class="form-group" style="text-align: left;">
                                <label for="forgot-email">Email Address</label>
                                <input type="email" id="forgot-email" required placeholder="Enter your email address">
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                                <button type="button" class="btn btn-secondary" onclick="portal.closeForgotPasswordModal()">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" id="send-reset-btn">
                                    Send Reset Link
                                </button>
                            </div>
                        </form>
                        
                        <div id="reset-success-message" class="hidden" style="margin-top: 20px; padding: 15px; background: rgba(139, 255, 176, 0.1); border: 1px solid rgba(139, 255, 176, 0.25); border-radius: 8px; color: #b5ffd0;">
                            <h4>Reset Link Sent!</h4>
                            <p>Check your email for a password reset link. The link will expire in 1 hour.</p>
                            <button class="btn btn-secondary" onclick="portal.closeForgotPasswordModal()" style="margin-top: 10px;">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            
                // Create modal (using the existing modal system)
                this.showModal('forgot-password', 'Reset Password', modalContent);
            
                // Add form submission handler
                setTimeout(() => {
                    const form = document.getElementById('forgot-password-form');
                    if (form) {
                        form.addEventListener('submit', (e) => this.handlePasswordReset(e));
                    }
                }, 100);
            }

            showTab(tabName) {
                this.currentSection = tabName;
                
                // Update unified navigation if present
                const navContainer = document.getElementById('unified-nav-container');
                if (navContainer && this.auth.isAuthenticated()) {
                    navContainer.innerHTML = window.PortalUI.createUnifiedNavigation('main', tabName);
                }
                
                // Hide all sections
                document.querySelectorAll('[id$="-section"]').forEach(section => {
                    if (section) section.classList.add('hidden');
                });
                
                // Show requested section
                const section = document.getElementById(tabName + '-section');
                if (section) {
                    section.classList.remove('hidden');
                }
                
                // Update URL hash
                if (tabName !== 'login') {
                    window.location.hash = tabName;
                } else {
                    window.history.replaceState(null, null, window.location.pathname);
                }
                
                // Special handling
                if (tabName === 'skills') {
                    this.showSkillsTab();
                } else if (tabName === 'games') {
                    // Refresh game cards when navigating to games
                    setTimeout(() => this.addGameCardListeners(), 100);
                }
            }

            loadStudentDashboard() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const userInfo = this.auth.getUserInfo();
                const firstName = userInfo.profile?.first_name || 'Student';
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, ${firstName}!</h2>
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div class="card" style="margin-bottom: 20px;">
                            <h3>🎯 Quick Access</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; max-width: 600px;">
                                <button class="btn btn-primary" onclick="portal.showTab('games')" style="width: 100%;">
                                    🎮 Play Games
                                </button>
                                <button class="btn btn-primary" onclick="portal.showTab('skills')" style="width: 100%;">
                                    🌟 View Skills
                                </button>
                                <button class="btn btn-secondary" onclick="window.portalAuth.goToClassesPortal()" style="width: 100%;">
                                    📚 Go to Classes
                                </button>
                                <a href="tests/math-placement-test.html" class="btn btn-secondary" style="width: 100%; text-decoration: none;">
                                    📝 Math Placement Test
                                </a>
                            </div>
                        </div>
                        
                        <div class="dashboard">
                            <div class="card">
                                <h3>📊 Progress Overview</h3>
                                <div class="stats">
                                    <div class="stat">
                                        <div class="stat-value" id="skills-unlocked">0</div>
                                        <div class="stat-label">Skills Unlocked</div>
                                    </div>
                                    <div class="stat">
                                        <div class="stat-value">3</div>
                                        <div class="stat-label">Active Classes</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <h3>🎯 Recent Activity</h3>
                                <p>No recent activity</p>
                                <button class="btn btn-secondary" onclick="window.portalAuth.goToClassesPortal('messaging')" style="margin-top: 10px;">
                                    💬 Check Messages
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            loadParentTeacherDashboard() {
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection) return;
                
                const userInfo = this.auth.getUserInfo();
                const firstName = userInfo.profile?.first_name || 'User';
                const userType = userInfo.profile?.user_type || 'user';
                
                dashboardSection.innerHTML = `
                    <h2>Welcome back, ${firstName}!</h2>
                    <div class="dashboard">
                        <div class="card">
                            <h3>👨‍👩‍👧‍👦 ${userType === 'teacher' ? 'Your Classes' : 'Your Children'}</h3>
                            <p>${userType === 'teacher' ? 'Manage your classes and students.' : 'View your children\'s progress and communicate with teachers.'}</p>
                            <button class="btn btn-primary" onclick="window.portalAuth.goToClassesPortal()" style="margin-top: 15px; width: 100%;">
                                📚 Go to Classes & Messaging
                            </button>
                        </div>
                        <div class="card">
                            <h3>📊 Overview</h3>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-value">0</div>
                                    <div class="stat-label">New Messages</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value">3</div>
                                    <div class="stat-label">Active Classes</div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>🔔 Notifications</h3>
                            <p>No new notifications.</p>
                        </div>
                    </div>
                `;
            }

            addGameCardListeners() {
                const gameCards = document.querySelectorAll('.game-card');
                gameCards.forEach(card => {
                    const gameId = card.getAttribute('data-game');
                    if (gameId) {
                        card.addEventListener('click', () => this.playGame(gameId));
                    }
                });
            }

            addSkillTreeListeners() {
                const skillButtons = document.querySelectorAll('.skill-tree-btn');
                skillButtons.forEach(button => {
                    const subject = button.getAttribute('data-subject');
                    if (subject) {
                        button.addEventListener('click', () => this.loadSkillTree(subject));
                    }
                });
            }

            async loadSkillTree(subject) {
                if (this.skillTreeIntegration) {
                    await this.skillTreeIntegration.loadSkillTree(subject);
                }
            }

            showSkillsTab() {
                setTimeout(() => this.addSkillTreeListeners(), 100);
            }

            async updateMathleticsProgress() {
                if (!this.auth.isAuthenticated()) return;
                
                try {
                    const { data, error } = await this.auth.supabase
                        .from('mathletics_progress')
                        .select('current_range, mastery_level')
                        .eq('user_id', this.auth.getUserInfo().profile.id)
                        .single();
                    
                    if (data && !error) {
                        const rangeElement = document.getElementById('mathletics-range');
                        const masteryElement = document.getElementById('mathletics-mastery');
                        
                        if (rangeElement) {
                            rangeElement.textContent = `${data.current_range?.min || 0}-${data.current_range?.max || 2}`;
                        }
                        if (masteryElement) {
                            masteryElement.textContent = data.mastery_level || 'Bronze';
                        }
                    }
                } catch (err) {
                    console.error('Error updating Mathletics progress:', err);
                }
            }
            
            playGame(gameId) {
                const gameTitle = {
                    'mathletics': '🎯 Mathletics',
                    'word-wizard': '📚 Word Wizard',
                    'science-lab': '🧪 Science Lab',
                    'history-quest': '🏛️ History Quest'
                }[gameId];
            
                const gameTitleElement = document.getElementById('current-game-title');
                const gameContainer = document.getElementById('game-iframe-container');
                const iframe = document.getElementById('game-iframe');
                
                if (gameTitleElement) gameTitleElement.textContent = gameTitle;
                if (gameContainer) gameContainer.classList.remove('hidden');
                
                if (iframe) {
                    if (gameId === 'mathletics') {
                        // Load actual Mathletics system
                        iframe.src = 'games/mathletics.html';
                        iframe.style.height = '700px'; // Give more height for Mathletics
                    } else {
                        // Placeholder for other games
                        iframe.src = 'data:text/html,<html><body style="font-family: Arial; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><h1>' + gameTitle + '</h1><p>Game would load here!</p><p>This is where your HTML5 educational games would be embedded.</p></body></html>';
                        iframe.style.height = '500px';
                    }
                }
            }

            closeGame() {
                const gameContainer = document.getElementById('game-iframe-container');
                const iframe = document.getElementById('game-iframe');
                
                if (gameContainer) gameContainer.classList.add('hidden');
                if (iframe) iframe.src = '';
            }
        }

        // Real SkillTreeIntegration class that integrates with SkillTreeViewer.html
        class SkillTreeIntegration {
            constructor(portal) {
                this.portal = portal;
                this.skillProgress = {};
                this.currentIframe = null;
                this.messageHandlers = new Map();
                
                // Set up message listener for skill tree communication
                window.addEventListener('message', (event) => {
                    this.handleSkillTreeMessage(event);
                });
            }
        
            async initialize() {
                await this.loadUserProgress();
                console.log('🌟 SkillTreeIntegration initialized with real skill tree system');
            }
        
            async loadUserProgress() {
                // Load progress from database or localStorage
                if (this.portal.auth.isAuthenticated()) {
                    try {
                        const userId = this.portal.auth.getUserInfo().profile.id;
                        
                        // Try to load from Supabase
                        const { data, error } = await this.portal.auth.supabase
                            .from('skill_progress')
                            .select('subject, skill_name, state')
                            .eq('user_id', userId);
                        
                        if (data && !error) {
                            // Organize progress by subject
                            this.skillProgress = {};
                            data.forEach(record => {
                                if (!this.skillProgress[record.subject]) {
                                    this.skillProgress[record.subject] = {};
                                }
                                this.skillProgress[record.subject][record.skill_name] = record.state;
                            });
                        } else {
                            // Fallback to localStorage
                            const saved = localStorage.getItem(`skill_progress_${userId}`);
                            this.skillProgress = saved ? JSON.parse(saved) : {};
                        }
                        
                        // Update skills counter
                        this.updateSkillsCounter();
                        
                    } catch (error) {
                        console.warn('Could not load skill progress:', error);
                        this.skillProgress = {};
                    }
                }
            }
        
            updateSkillsCounter() {
                // Count total unlocked skills across all subjects
                let totalUnlocked = 0;
                Object.values(this.skillProgress).forEach(subjectProgress => {
                    Object.values(subjectProgress).forEach(state => {
                        if (state === 'available' || state === 'activated') {
                            totalUnlocked++;
                        }
                    });
                });
                
                const counter = document.getElementById('skills-unlocked');
                if (counter) {
                    counter.textContent = totalUnlocked;
                }
            }
        
            handleSkillTreeMessage(event) {
                // Handle messages from the skill tree iframe
                if (!event.data || !event.data.type) return;
                
                switch (event.data.type) {
                    case 'REQUEST_SKILL_DATA':
                        this.sendSkillData(event.data.subject, event.source);
                        break;
                        
                    case 'SKILL_UNLOCKED':
                        this.handleSkillUnlocked(event.data);
                        break;
                        
                    default:
                        console.log('Unknown message from skill tree:', event.data.type);
                }
            }
        
            sendSkillData(subject, source) {
                // Send skill tree data and progress to the iframe
                const progress = this.skillProgress[subject] || {};
                
                // Send the data back to the skill tree
                source.postMessage({
                    type: 'SKILL_DATA_RESPONSE',
                    subject: subject,
                    progress: progress,
                    skillTreeData: {
                        // The SkillTreeViewer.html has its own built-in data
                        // We just need to send progress
                    }
                }, '*');
            }
        
            async handleSkillUnlocked(data) {
                const { subject, skillName, state } = data;
                
                // Update local progress
                if (!this.skillProgress[subject]) {
                    this.skillProgress[subject] = {};
                }
                this.skillProgress[subject][skillName] = state;
                
                // Save to database
                if (this.portal.auth.isAuthenticated()) {
                    try {
                        const userId = this.portal.auth.getUserInfo().profile.id;
                        
                        // Save to Supabase
                        const { error } = await this.portal.auth.supabase
                            .from('skill_progress')
                            .upsert({
                                user_id: userId,
                                subject: subject,
                                skill_name: skillName,
                                state: state,
                                updated_at: new Date().toISOString()
                            });
                        
                        if (error) {
                            console.warn('Failed to save to database:', error);
                            // Fallback to localStorage
                            localStorage.setItem(`skill_progress_${userId}`, JSON.stringify(this.skillProgress));
                        }
                        
                        // Update counter
                        this.updateSkillsCounter();
                        
                        // Show success notification
                        window.PortalUI.showNotification(
                            `🌟 Skill unlocked: ${skillName}!`, 
                            'success', 
                            3000
                        );
                        
                    } catch (error) {
                        console.error('Error saving skill progress:', error);
                        // Still save to localStorage as fallback
                        const userId = this.portal.auth.getUserInfo().profile.id;
                        localStorage.setItem(`skill_progress_${userId}`, JSON.stringify(this.skillProgress));
                    }
                }
            }
        
            async loadSkillTree(subject) {
                const container = document.getElementById('skill-tree-container');
                if (!container) return;
                
                console.log(`🌟 Loading skill tree for ${subject}`);
                
                // Remove any existing iframe
                if (this.currentIframe) {
                    this.currentIframe.remove();
                    this.currentIframe = null;
                }
                
                // Create iframe for the skill tree
                const iframe = document.createElement('iframe');
                iframe.id = 'skill-tree-iframe';
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                    border-radius: 10px;
                    background: radial-gradient(circle, #0a0a2e 0%, #000000 100%);
                `;
                
                // Set the iframe source with subject parameter
                iframe.src = `SkillTreeViewer.html?subject=${encodeURIComponent(subject)}`;
                
                // Clear container and add iframe
                container.innerHTML = '';
                container.appendChild(iframe);
                this.currentIframe = iframe;
                
                // Handle iframe load
                iframe.onload = () => {
                    console.log(`✅ Skill tree loaded for ${subject}`);
                    
                    // Send initial data to the skill tree after a short delay
                    setTimeout(() => {
                        if (iframe.contentWindow) {
                            this.sendSkillData(subject, iframe.contentWindow);
                        }
                    }, 500);
                };
                
                iframe.onerror = () => {
                    console.error(`❌ Failed to load skill tree for ${subject}`);
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-color);">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                                <h3>Failed to Load Skill Tree</h3>
                                <p>Could not load the ${subject} skill tree</p>
                                <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 15px;">
                                    🔄 Retry
                                </button>
                            </div>
                        </div>
                    `;
                };
            }
        
            // Method to get subject progress for other parts of the app
            getSubjectProgress(subject) {
                return this.skillProgress[subject] || {};
            }
        
            // Method to get total progress stats
            getTotalStats() {
                let totalSkills = 0;
                let unlockedSkills = 0;
                let completedSkills = 0;
                
                Object.values(this.skillProgress).forEach(subjectProgress => {
                    Object.values(subjectProgress).forEach(state => {
                        totalSkills++;
                        if (state === 'available' || state === 'activated') {
                            unlockedSkills++;
                        }
                        if (state === 'activated') {
                            completedSkills++;
                        }
                    });
                });
                
                return {
                    total: totalSkills,
                    unlocked: unlockedSkills,
                    completed: completedSkills
                };
            }
        
            // Method to refresh skill tree if needed
            refreshSkillTree(subject) {
                if (this.currentIframe && this.currentIframe.contentWindow) {
                    this.currentIframe.contentWindow.postMessage({
                        type: 'PROGRESS_UPDATED',
                        subject: subject,
                        progress: this.skillProgress[subject] || {}
                    }, '*');
                }
            }
        }

        // Initialize portal when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.portal = new StudentPortal();
        });
    </script>
</body>
</html>
