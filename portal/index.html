// ADD THESE FIXES TO YOUR ClassesPortalApp class

// =============================================================================
// FIX 1: Implement openClass function
// =============================================================================

// Replace the existing openClass method with this:
openClass(classId) {
  const classData = this.classes.find(c => c.id === classId);
  if (!classData) return;

  const isTeacher = this.userInfo.profile.user_type === 'teacher';
  
  const modalContent = `
    <div style="margin-bottom: 20px;">
      <h3 style="color: var(--accent); margin-bottom: 10px;">${classData.name}</h3>
      <p style="color: var(--muted); margin-bottom: 15px;">${classData.description || 'No description available'}</p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
          <strong>Subject:</strong> ${classData.subject}<br>
          <strong>Grade Level:</strong> ${classData.grade_level || 'All Grades'}<br>
          ${isTeacher ? `<strong>Class Code:</strong> <span style="background: var(--accent); color: black; padding: 2px 6px; border-radius: 4px; font-weight: bold;">${classData.class_code}</span>` : ''}
        </div>
        <div>
          <strong>Max Students:</strong> ${classData.max_students || 30}<br>
          <strong>Created:</strong> ${new Date(classData.created_at).toLocaleDateString()}<br>
          ${isTeacher ? `<strong>Current Students:</strong> ${classData.student_count || 0}` : ''}
        </div>
      </div>

      ${isTeacher ? `
        <div style="border-top: 1px solid var(--border); padding-top: 15px;">
          <h4 style="margin-bottom: 10px;">Teacher Actions</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="app.manageStudents('${classId}')">
              üë• Manage Students
            </button>
            <button class="btn btn-secondary" onclick="app.viewAssignments('${classId}')">
              üìù View Assignments
            </button>
            <button class="btn btn-secondary" onclick="app.classAnalytics('${classId}')">
              üìä Class Analytics
            </button>
          </div>
        </div>
      ` : `
        <div style="border-top: 1px solid var(--border); padding-top: 15px;">
          <h4 style="margin-bottom: 10px;">Student Actions</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="app.viewAssignments('${classId}')">
              üìù View Assignments
            </button>
            <button class="btn btn-secondary" onclick="app.viewGrades('${classId}')">
              üìä View Grades
            </button>
          </div>
        </div>
      `}
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
      <button class="btn btn-secondary" onclick="app.closeModal()">Close</button>
      ${isTeacher ? `<button class="btn btn-primary" onclick="app.editClass('${classId}')">‚úèÔ∏è Edit Class</button>` : ''}
    </div>
  `;

  if (window.portalModal) {
    window.portalModal.create('class-details', {
      title: 'üìö Class Details',
      content: modalContent,
      size: 'large'
    });
  } else {
    this.showModal('class-details', 'üìö Class Details', modalContent);
  }
}

// Add these placeholder functions for the class detail actions:
manageStudents(classId) {
  this.showNotification('Student management coming soon!', 'info');
  this.closeModal();
}

viewAssignments(classId) {
  this.showNotification('Assignment management coming soon!', 'info');
  this.closeModal();
}

classAnalytics(classId) {
  this.showNotification('Class analytics coming soon!', 'info');
  this.closeModal();
}

viewGrades(classId) {
  this.showNotification('Grade viewing coming soon!', 'info');
  this.closeModal();
}

// =============================================================================
// FIX 2: Refresh home content after class operations
// =============================================================================

// Update your submitCreateClass method to refresh home content:
async submitCreateClass() {
  const classData = {
    name: document.getElementById('class-name').value,
    subject: document.getElementById('class-subject').value,
    grade_level: document.getElementById('class-grade').value || null,
    description: document.getElementById('class-description').value || null,
    max_students: parseInt(document.getElementById('max-students').value) || 30,
    teacher_id: this.userInfo.user.id
  };

  if (!classData.name || !classData.subject) {
    if (window.PortalUI) {
      window.PortalUI.showNotification('Please fill in required fields', 'error');
    } else {
      this.showNotification('Please fill in required fields', 'error');
    }
    return;
  }

  try {
    if (window.portalLoading) {
      window.portalLoading.show('create-class', 'Creating class...');
    }
    
    const { data, error } = await this.auth.supabase
      .from('classes')
      .insert([classData])
      .select()
      .single();

    if (error) throw error;

    if (window.PortalUI) {
      window.PortalUI.showNotification('Class created successfully!', 'success');
    } else {
      this.showNotification('Class created successfully!', 'success');
    }
    
    if (window.portalModal) {
      window.portalModal.close('create-class');
    } else {
      this.closeModal();
    }
    
    // ‚úÖ FIX: Refresh data and update home content
    await this.loadTeacherData();
    this.setupHomeContent(); // ‚Üê This line refreshes the home stats
    this.renderClasses();

  } catch (error) {
    console.error('Error creating class:', error);
    if (window.PortalUI) {
      window.PortalUI.showNotification('Error creating class: ' + error.message, 'error');
    } else {
      this.showNotification('Error creating class: ' + error.message, 'error');
    }
  } finally {
    if (window.portalLoading) {
      window.portalLoading.hide('create-class');
    }
  }
}

// =============================================================================
// FIX 3: Load message recipients
// =============================================================================

// Add this new method to load potential message recipients:
async loadMessageRecipients() {
  try {
    const userType = this.userInfo.profile.user_type;
    let recipients = [];

    if (userType === 'teacher') {
      // Teachers can message students in their classes and other teachers
      
      // Get students in teacher's classes
      const { data: enrollments } = await this.auth.supabase
        .from('class_enrollments')
        .select(`
          student_id,
          user_profiles!inner(id, first_name, last_name, email, user_type)
        `)
        .in('class_id', this.classes.map(c => c.id))
        .eq('status', 'active');

      if (enrollments) {
        enrollments.forEach(enrollment => {
          const profile = enrollment.user_profiles;
          recipients.push({
            id: profile.id,
            name: `${profile.first_name} ${profile.last_name}`,
            email: profile.email,
            type: 'Student'
          });
        });
      }

      // Get other teachers and staff
      const { data: teachers } = await this.auth.supabase
        .from('user_profiles')
        .select('id, first_name, last_name, email, user_type')
        .in('user_type', ['teacher', 'admin'])
        .neq('id', this.userInfo.user.id);

      if (teachers) {
        teachers.forEach(teacher => {
          recipients.push({
            id: teacher.id,
            name: `${teacher.first_name} ${teacher.last_name}`,
            email: teacher.email,
            type: teacher.user_type === 'admin' ? 'Admin' : 'Teacher'
          });
        });
      }

    } else if (userType === 'student') {
      // Students can message teachers of their classes
      const { data: teachers } = await this.auth.supabase
        .from('classes')
        .select(`
          teacher_id,
          user_profiles!inner(id, first_name, last_name, email, user_type)
        `)
        .in('id', this.classes.map(c => c.id));

      if (teachers) {
        teachers.forEach(classTeacher => {
          const profile = classTeacher.user_profiles;
          recipients.push({
            id: profile.id,
            name: `${profile.first_name} ${profile.last_name}`,
            email: profile.email,
            type: 'Teacher'
          });
        });
      }
    }

    // Remove duplicates
    const uniqueRecipients = recipients.filter((recipient, index, self) =>
      index === self.findIndex(r => r.id === recipient.id)
    );

    this.messageRecipients = uniqueRecipients;
    this.updateMessageRecipientsDropdown();

  } catch (error) {
    console.error('Error loading message recipients:', error);
    this.messageRecipients = [];
  }
}

// Add this method to update the dropdown:
updateMessageRecipientsDropdown() {
  const dropdown = document.getElementById('message-recipient');
  if (!dropdown) return;

  dropdown.innerHTML = '<option value="">Select recipient...</option>';
  
  this.messageRecipients.forEach(recipient => {
    const option = document.createElement('option');
    option.value = recipient.id;
    option.textContent = `${recipient.name} (${recipient.type})`;
    dropdown.appendChild(option);
  });
}

// Update your loadSectionContent method to load recipients when messaging section is shown:
loadSectionContent(sectionName) {
  switch (sectionName) {
    case 'classes':
      this.renderClasses();
      break;
    case 'messaging':
      this.renderMessages();
      this.loadMessageRecipients(); // ‚úÖ FIX: Load recipients when messaging section opens
      break;
    case 'profile':
      this.renderProfile();
      break;
  }
}

// =============================================================================
// ADDITIONAL: Update your class card to make click work properly
// =============================================================================

// Make sure your renderClassCard method has the onclick properly set:
renderClassCard(cls) {
  const userType = this.userInfo.profile.user_type;
  const isTeacher = userType === 'teacher';
  
  return `
    <div class="class-card" onclick="app.openClass('${cls.id}')" style="cursor: pointer;">
      ${isTeacher ? `
        <div class="class-actions">
          <button onclick="event.stopPropagation(); app.editClass('${cls.id}')">‚úèÔ∏è</button>
          <button onclick="event.stopPropagation(); app.deleteClass('${cls.id}')" style="background: rgba(255, 106, 106, 0.3);">üóëÔ∏è</button>
        </div>
      ` : ''}
      <h3>${cls.name}</h3>
      <p>${cls.description || 'No description available'}</p>
      <div class="class-stats">
        <span>üìö ${cls.subject}</span>
        <span>üéì ${cls.grade_level || 'All Grades'}</span>
      </div>
      ${isTeacher ? `
        <div class="class-stats" style="margin-top: 8px;">
          <span>üë• ${cls.student_count || 0}/${cls.max_students || 30}</span>
          <span>üî¢ ${cls.class_code}</span>
        </div>
      ` : ''}
    </div>
  `;
}
