<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>River Tech High School - Report Card</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 11px;
      line-height: 1.4;
      color: #000;
      background: #fff;
    }

    .page {
      width: 8.5in;
      min-height: 11in;
      padding: 0.4in;
      margin: 0 auto;
      background: #fff;
      page-break-after: always;
    }

    .page:last-child {
      page-break-after: auto;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 2px solid #000;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .header-left h1 {
      font-size: 22px;
      font-weight: bold;
      letter-spacing: 1px;
      margin-bottom: 2px;
    }

    .header-left .subtitle {
      font-size: 13px;
      font-weight: normal;
      color: #333;
    }

    .header-right {
      text-align: right;
      font-size: 10px;
      line-height: 1.5;
    }

    .header-right a {
      color: #000;
      text-decoration: none;
    }

    /* Student Info Section */
    .student-section {
      display: flex;
      gap: 30px;
      margin-bottom: 20px;
    }

    .student-info {
      flex: 1;
    }

    .info-row {
      display: flex;
      margin-bottom: 6px;
    }

    .info-label {
      font-weight: bold;
      min-width: 180px;
    }

    .info-value {
      flex: 1;
    }

    .signature-section {
      margin-top: 20px;
      padding-top: 10px;
    }

    .signature-statement {
      font-style: italic;
      margin-bottom: 15px;
      font-size: 10px;
    }

    .signature-line {
      display: flex;
      align-items: flex-end;
      gap: 20px;
    }

    .signature-line span {
      font-weight: bold;
    }

    .signature-underline {
      flex: 1;
      border-bottom: 1px solid #000;
      min-width: 200px;
      height: 20px;
    }

    /* Quote Section */
    .quote-section {
      flex: 1.2;
      background: #f8f8f8;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .quote-text {
      font-size: 10px;
      line-height: 1.5;
      margin-bottom: 8px;
      text-align: justify;
    }

    .quote-attribution {
      font-style: italic;
      font-size: 10px;
      text-align: right;
      margin-bottom: 12px;
    }

    /* Explanation Grid */
    .explanation-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 15px;
      font-size: 9px;
      margin-bottom: 10px;
    }

    .explanation-item {
      display: flex;
      gap: 5px;
    }

    .explanation-item .label {
      font-weight: bold;
      min-width: 45px;
    }

    .explanation-item.orange .label {
      background: #ffcc80;
      padding: 1px 4px;
    }

    .explanation-item.purple .label {
      background: #ce93d8;
      padding: 1px 4px;
    }

    .contact-footer {
      font-size: 9px;
      font-style: italic;
      color: #555;
    }

    /* Grade Scale Table */
    .grade-scale-section {
      margin-top: 15px;
    }

    .grade-scale-section h3 {
      font-size: 12px;
      margin-bottom: 8px;
    }

    .grade-scale-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
    }

    .grade-scale-table th,
    .grade-scale-table td {
      border: 1px solid #999;
      padding: 4px 8px;
      text-align: center;
    }

    .grade-scale-table th {
      background: #e0e0e0;
      font-weight: bold;
    }

    .grade-scale-table tr:nth-child(even) td {
      background: #f5f5f5;
    }

    .grade-scale-table th {
      text-align: left;
      padding-left: 8px;
      min-width: 55px;
    }

    .grade-scale-table td {
      min-width: 45px;
    }

    /* Page 2 - Course Table */
    .page2-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #000;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }

    .page2-header .date {
      font-size: 10px;
    }

    .page2-header .title {
      font-size: 14px;
      font-weight: bold;
    }

    .page2-header .gpa-display {
      font-size: 12px;
      font-weight: bold;
      background: #e3f2fd;
      padding: 5px 12px;
      border-radius: 4px;
      border: 1px solid #90caf9;
    }

    /* Course Table */
    .course-table-wrapper {
      overflow-x: auto;
    }

    .course-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9px;
    }

    .course-table th,
    .course-table td {
      border: 1px solid #999;
      padding: 3px 4px;
      text-align: center;
      vertical-align: middle;
    }

    .course-table th {
      background: #e0e0e0;
      font-weight: bold;
    }

    .course-table .quarter-header {
      background: #bdbdbd;
    }

    .course-table .sub-header {
      font-size: 8px;
      background: #eeeeee;
    }

    .course-table .subject-cell {
      background: #f5f5f5;
      font-weight: bold;
      text-align: left;
      padding-left: 6px;
      vertical-align: top;
    }

    .course-table .units-row {
      font-size: 8px;
      color: #666;
      font-style: italic;
    }

    .course-table .course-name {
      text-align: left;
      padding-left: 6px;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .course-table .credits-cell {
      font-weight: bold;
    }

    /* Quarter highlighting - current quarter */
    .course-table .current-quarter {
      background: #e3f2fd !important;
    }

    .course-table .current-quarter-header {
      background: #90caf9 !important;
    }

    /* Flag colors */
    .course-table .flag-orange {
      background: #ffcc80 !important;
    }

    .course-table .flag-purple {
      background: #ce93d8 !important;
    }

    /* Alternate row shading */
    .course-table .course-row:nth-child(even) td:not(.current-quarter):not(.flag-orange):not(.flag-purple) {
      background: #fafafa;
    }

    /* Finals and GP columns */
    .course-table .finals-cell {
      font-weight: bold;
      background: #fff9c4;
    }

    .course-table .gp-cell {
      font-weight: bold;
      background: #c8e6c9;
    }

    .course-table .hc-cell {
      font-size: 8px;
    }

    /* Weight column */
    .course-table .weight-cell {
      background: #e1bee7;
      font-weight: bold;
    }

    .course-table .weight-header {
      background: #ba68c8 !important;
      color: #fff;
    }

    /* GPA Summary row */
    .course-table .gpa-summary-row td {
      background: #e8f5e9 !important;
      font-weight: bold;
      font-size: 10px;
      border-top: 2px solid #666;
    }

    /* Print Styles */
    @media print {
      body {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .page {
        width: 100%;
        min-height: auto;
        padding: 0.3in;
        margin: 0;
        page-break-after: always;
      }

      .page:last-child {
        page-break-after: auto;
      }

      .no-print {
        display: none !important;
      }

      .course-table-wrapper {
        overflow: visible;
      }
    }

    @page {
      size: letter;
      margin: 0.25in;
    }

    /* Preview controls */
    .preview-controls {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: #333;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      gap: 10px;
    }

    .preview-controls button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
    }

    .preview-controls button:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <div class="preview-controls no-print">
    <button onclick="window.print()">Print / Save PDF</button>
  </div>

  <!-- Page 1: Header + Summary -->
  <div class="page" id="page1">
    <div class="header">
      <div class="header-left">
        <h1 id="school-name">RIVER TECH HIGH SCHOOL</h1>
        <div class="subtitle">HIGH SCHOOL REPORT CARD, <span id="year-label">Y5Q2 2025</span></div>
      </div>
      <div class="header-right">
        <div id="school-website">www.rivertechschool.com</div>
        <div id="school-address">1687 E Horsehaven Ave, Post Falls, ID 83854.</div>
        <div id="school-email">learn@rivertech.me</div>
        <div id="school-phone">425-444-2081</div>
      </div>
    </div>

    <div class="student-section">
      <div class="student-info">
        <div class="info-row">
          <span class="info-label">Student name:</span>
          <span class="info-value" id="student-name"></span>
        </div>
        <div class="info-row">
          <span class="info-label">DOB:</span>
          <span class="info-value" id="student-dob"></span>
        </div>
        <div class="info-row">
          <span class="info-label">Grade Level:</span>
          <span class="info-value" id="student-grade"></span>
        </div>
        <div id="gpa-history-rows">
          <!-- Dynamically populated GPA rows for each year -->
        </div>
        <div class="info-row">
          <span class="info-label">GPA (current quarter):</span>
          <span class="info-value" id="gpa-current">—</span>
        </div>
        <div class="info-row">
          <span class="info-label">Approx. Credits Acquired:</span>
          <span class="info-value" id="approx-credits">—</span>
        </div>

        <div class="signature-section">
          <div class="signature-statement">
            I do hereby affirm that this official academic record is accurate and complete.
          </div>
          <div class="signature-line">
            <span>Administrator's Signature:</span>
            <div class="signature-underline"></div>
            <span>Date:</span>
            <span id="print-date"></span>
          </div>
        </div>
      </div>

      <div class="quote-section">
        <div class="quote-text" id="quote-text">
          Quarterly report cards at River Tech High School are essential tools for monitoring academic progress. They provide a snapshot of student achievement, allowing teachers, parents, and students to identify strengths and areas needing improvement. By reviewing grades regularly, we can collaboratively support each student's educational journey and ensure they stay on track for success.
        </div>
        <div class="quote-attribution">
          —<span id="principal-name">Dan Hegelund</span>, Principal
        </div>

        <div class="explanation-grid" id="explanation-grid">
          <!-- Populated by JS -->
        </div>

        <div class="contact-footer" id="contact-footer">
          For further clarifications email learn@rivertech.me
        </div>
      </div>
    </div>

    <div class="grade-scale-section">
      <h3>Grade Point Scale</h3>
      <table class="grade-scale-table" id="grade-scale-table">
        <tbody id="grade-scale-body">
          <!-- Populated by JS: 3 rows (Letter, Percent, Points) x 12 columns -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Page 2: Course Table -->
  <div class="page" id="page2">
    <div class="page2-header">
      <div class="date" id="report-date"></div>
      <div class="title">Report Card, <span id="report-code">Y5Q2</span> <span id="school-year-range">2024-25</span>, <span id="student-short-name"></span></div>
      <div class="gpa-display">Current GPA: <span id="total-gpa">—</span></div>
    </div>

    <div class="course-table-wrapper">
      <table class="course-table" id="course-table">
        <thead id="course-table-head">
          <!-- Dynamically populated by JS based on active quarters -->
        </thead>
        <tbody id="course-table-body">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Helper functions
    function percentageToGPA(percentage) {
      if (percentage === null || percentage === undefined) return null;
      if (percentage >= 97) return 4.0;
      if (percentage >= 93) return 4.0;
      if (percentage >= 90) return 3.7;
      if (percentage >= 87) return 3.3;
      if (percentage >= 83) return 3.0;
      if (percentage >= 80) return 2.7;
      if (percentage >= 77) return 2.3;
      if (percentage >= 73) return 2.0;
      if (percentage >= 70) return 1.7;
      if (percentage >= 67) return 1.3;
      if (percentage >= 63) return 1.0;
      if (percentage >= 60) return 0.7;
      return 0.0;
    }

    function percentageToLetter(percentage) {
      if (percentage === null || percentage === undefined) return '';
      if (percentage >= 97) return 'A+';
      if (percentage >= 93) return 'A';
      if (percentage >= 90) return 'A-';
      if (percentage >= 87) return 'B+';
      if (percentage >= 83) return 'B';
      if (percentage >= 80) return 'B-';
      if (percentage >= 77) return 'C+';
      if (percentage >= 73) return 'C';
      if (percentage >= 70) return 'C-';
      if (percentage >= 67) return 'D+';
      if (percentage >= 63) return 'D';
      if (percentage >= 60) return 'D-';
      return 'F';
    }

    function getCourseWeightModifier(courseWeight) {
      switch (courseWeight) {
        case 'honors': return 0.5;
        case 'ap': return 1.0;
        case 'dual_credit': return 1.0;
        default: return 0;
      }
    }

    function getHCLabel(courseWeight) {
      switch (courseWeight) {
        case 'honors': return 'H';
        case 'ap': return 'AP';
        case 'dual_credit': return 'C';
        default: return 'N/A';
      }
    }

    function formatDate(date) {
      const d = new Date(date);
      return `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}/${d.getFullYear()}`;
    }

    // Default configuration
    const defaultConfig = {
      school: {
        name: "RIVER TECH HIGH SCHOOL",
        website: "www.rivertechschool.com",
        addressLine: "1687 E Horsehaven Ave, Post Falls, ID 83854.",
        email: "learn@rivertech.me",
        phone: "425-444-2081"
      },
      quoteBlock: {
        principalName: "Dan Hegelund",
        quoteText: "Quarterly report cards at River Tech High School are essential tools for monitoring academic progress. They provide a snapshot of student achievement, allowing teachers, parents, and students to identify strengths and areas needing improvement. By reviewing grades regularly, we can collaboratively support each student's educational journey and ensure they stay on track for success.",
        explanationItems: [
          { label: "Y#", text: "Year number (Y1=Freshman, Y2=Sophomore, etc.)" },
          { label: "Q#", text: "Quarter number (Q1, Q2, Q3, Q4)" },
          { label: "Skill", text: "Skill level (written, verbal, etc.)." },
          { label: "Part.", text: "Participation: attitude, focus, timeliness." },
          { label: "Total", text: "Average of Skill and Participation." },
          { label: "Orange", text: "At risk of failing; pay close attention.", isOrange: true },
          { label: "Purple", text: "Grade shifted significantly since last quarter.", isPurple: true },
          { label: "H/C", text: "Honors (H), AP, College (C), or N/A." },
          { label: "Finals", text: "Weighted avg of Q1-Q4 (20%, 25%, 25%, 30%)." },
          { label: "Wt GP", text: "Weighted grade points (includes H/AP/C bonus)." }
        ],
        contactFooter: "For further clarifications email learn@rivertech.me"
      },
      gradeScale: [
        { range: "97-100", letter: "A+", gpa: 4.0 },
        { range: "93-96", letter: "A", gpa: 4.0 },
        { range: "90-92", letter: "A-", gpa: 3.7 },
        { range: "87-89", letter: "B+", gpa: 3.3 },
        { range: "83-86", letter: "B", gpa: 3.0 },
        { range: "80-82", letter: "B-", gpa: 2.7 },
        { range: "77-79", letter: "C+", gpa: 2.3 },
        { range: "73-76", letter: "C", gpa: 2.0 },
        { range: "70-72", letter: "C-", gpa: 1.7 },
        { range: "67-69", letter: "D+", gpa: 1.3 },
        { range: "60-66", letter: "D", gpa: 1.0 },
        { range: "0-59", letter: "F", gpa: 0.0 }
      ],
      // School founding year - used to calculate year number (Y1, Y2, etc.)
      schoolFoundingYear: 2021
    };

    function renderReportCard(studentData) {
      const config = { ...defaultConfig, ...studentData.config };
      const today = new Date();
      const printDate = formatDate(today);

      // Calculate year number based on school founding
      const currentSchoolYear = studentData.currentSchoolYear || '2024-2025';
      const [startYear] = currentSchoolYear.split('-').map(Number);
      const yearNumber = startYear - config.schoolFoundingYear + 1;

      // Get current quarter number
      const quarterNumber = studentData.currentQuarter?.name?.match(/Q?(\d)/i)?.[1] || '2';

      const yearLabel = `Y${yearNumber}Q${quarterNumber} ${startYear}`;
      const yearCode = `Y${yearNumber}`;
      const quarterCode = `Q${quarterNumber}`;

      // Page 1 - Header
      document.getElementById('school-name').textContent = config.school.name;
      document.getElementById('year-label').textContent = yearLabel;
      document.getElementById('school-website').textContent = config.school.website;
      document.getElementById('school-address').textContent = config.school.addressLine;
      document.getElementById('school-email').textContent = config.school.email;
      document.getElementById('school-phone').textContent = config.school.phone;

      // Student Info
      const student = studentData.student;
      document.getElementById('student-name').textContent = `${student.first_name} ${student.last_name}`;
      document.getElementById('student-dob').textContent = student.dob ? formatDate(student.dob) : '—';
      document.getElementById('student-grade').textContent = student.grade_level ? `Grade ${student.grade_level}` : '—';

      // GPA History rows (dynamically generate based on year number)
      const gpaHistoryContainer = document.getElementById('gpa-history-rows');
      gpaHistoryContainer.innerHTML = '';
      for (let y = 1; y < yearNumber; y++) {
        const gpaValue = studentData.gpaHistory?.[`Y${y}`];
        const row = document.createElement('div');
        row.className = 'info-row';
        row.innerHTML = `
          <span class="info-label">GPA Y${y} Finals:</span>
          <span class="info-value">${gpaValue != null ? gpaValue.toFixed(2) : '—'}</span>
        `;
        gpaHistoryContainer.appendChild(row);
      }

      // Current GPA
      document.getElementById('gpa-current').textContent = studentData.currentGPA != null ? studentData.currentGPA.toFixed(2) : '—';
      document.getElementById('approx-credits').textContent = studentData.approxCredits || '—';
      document.getElementById('print-date').textContent = printDate;

      // Quote Section
      document.getElementById('quote-text').textContent = config.quoteBlock.quoteText;
      document.getElementById('principal-name').textContent = config.quoteBlock.principalName;
      document.getElementById('contact-footer').textContent = config.quoteBlock.contactFooter;

      // Update explanation items with current year/quarter
      const explanationItems = config.quoteBlock.explanationItems.map(item => {
        if (item.label === 'Y#') return { ...item, label: yearCode, text: `Year ${yearNumber}` };
        if (item.label === 'Q#') return { ...item, label: quarterCode, text: `Quarter ${quarterNumber}` };
        return item;
      });

      // Explanation Grid
      const explanationGrid = document.getElementById('explanation-grid');
      explanationGrid.innerHTML = '';
      explanationItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'explanation-item';
        if (item.isOrange) div.classList.add('orange');
        if (item.isPurple) div.classList.add('purple');
        div.innerHTML = `<span class="label">${item.label}</span><span>${item.text}</span>`;
        explanationGrid.appendChild(div);
      });

      // Grade Scale Table (3 rows: Letter, Percent, Points across all grades)
      const gradeScaleBody = document.getElementById('grade-scale-body');
      gradeScaleBody.innerHTML = '';

      // Row 1: Labels header + Letter grades
      const letterRow = document.createElement('tr');
      letterRow.innerHTML = '<th>Letter</th>' + config.gradeScale.map(item => `<td>${item.letter}</td>`).join('');
      gradeScaleBody.appendChild(letterRow);

      // Row 2: Percent ranges
      const percentRow = document.createElement('tr');
      percentRow.innerHTML = '<th>Percent</th>' + config.gradeScale.map(item => `<td>${item.range}</td>`).join('');
      gradeScaleBody.appendChild(percentRow);

      // Row 3: GPA points
      const pointsRow = document.createElement('tr');
      pointsRow.innerHTML = '<th>Points</th>' + config.gradeScale.map(item => `<td>${item.gpa.toFixed(1)}</td>`).join('');
      gradeScaleBody.appendChild(pointsRow);

      // Page 2 - Course Table Header
      document.getElementById('report-date').textContent = printDate;
      document.getElementById('report-code').textContent = `${yearCode}${quarterCode}`;
      document.getElementById('school-year-range').textContent = currentSchoolYear.replace('-20', '-');
      const shortName = `${student.first_name} ${student.last_name.charAt(0)}.`;
      document.getElementById('student-short-name').textContent = shortName;
      document.getElementById('total-gpa').textContent = studentData.currentGPA != null ? studentData.currentGPA.toFixed(2) : '—';

      // Column visibility settings
      const colVis = studentData.columnVisibility || { credits: true, finals: true, hc: true, gp: true, wtgp: true };

      // Current quarter for highlighting
      const currentQuarterNum = parseInt(quarterNumber);

      // Determine which quarters to display (use activeQuarters from data, or default to all up to current)
      const quartersToDisplay = studentData.activeQuarters || ['Q1', 'Q2', 'Q3', 'Q4'].filter((q, i) => i + 1 <= currentQuarterNum);

      // Build dynamic table headers based on active quarters
      const courseTableHead = document.getElementById('course-table-head');
      courseTableHead.innerHTML = '';

      // First header row - quarter names
      const headerRow1 = document.createElement('tr');
      headerRow1.className = 'quarter-header';
      headerRow1.innerHTML = `
        <th rowspan="2" style="width: 140px;">Subject / Course</th>
        ${colVis.credits ? '<th rowspan="2" style="width: 30px;">Cr</th>' : ''}
        ${quartersToDisplay.map(q => `<th colspan="3">${q}</th>`).join('')}
        ${colVis.finals ? '<th rowspan="2" style="width: 35px;">Finals</th>' : ''}
        ${colVis.hc ? '<th rowspan="2" style="width: 30px;">H/C</th>' : ''}
        ${colVis.gp ? '<th rowspan="2" style="width: 35px;">GP</th>' : ''}
        ${colVis.wtgp ? '<th rowspan="2" class="weight-header" style="width: 40px;">Wt GP</th>' : ''}
      `;
      courseTableHead.appendChild(headerRow1);

      // Second header row - Sk/Pt/Tot for each quarter
      const headerRow2 = document.createElement('tr');
      headerRow2.className = 'sub-header';
      headerRow2.innerHTML = quartersToDisplay.map((q, idx) => {
        const isCurrentQ = (parseInt(q.replace('Q', '')) === currentQuarterNum);
        const highlightClass = isCurrentQ ? 'current-quarter-header' : '';
        return `
          <th style="width: 30px;" class="${highlightClass}">Sk</th>
          <th style="width: 30px;" class="${highlightClass}">Pt</th>
          <th style="width: 32px;" class="${highlightClass}">Tot</th>
        `;
      }).join('');
      courseTableHead.appendChild(headerRow2);

      // Course Table Body
      const courseTableBody = document.getElementById('course-table-body');
      courseTableBody.innerHTML = '';

      const subjectGroups = studentData.subjectGroups || [];
      let totalBaseGP = 0;
      let totalWeightedGP = 0;
      let totalCourses = 0;

      subjectGroups.forEach((group) => {
        const courseCount = group.courses.length;

        group.courses.forEach((course, courseIndex) => {
          const tr = document.createElement('tr');
          tr.className = 'course-row';

          // Subject/Course name cell
          const nameCell = document.createElement('td');
          nameCell.className = 'course-name';
          nameCell.textContent = course.courseName;
          nameCell.title = `${group.name}: ${course.courseName}`;
          tr.appendChild(nameCell);

          // Credits
          if (colVis.credits) {
            const creditsCell = document.createElement('td');
            creditsCell.className = 'credits-cell';
            creditsCell.textContent = course.credits || '';
            tr.appendChild(creditsCell);
          }

          // Quarter grades (only active quarters)
          quartersToDisplay.forEach((q) => {
            const qData = course.quarters?.[q] || {};
            const qNum = parseInt(q.replace('Q', ''));
            const isCurrentQ = (qNum === currentQuarterNum);

            ['skill', 'part', 'total'].forEach(field => {
              const cell = document.createElement('td');
              cell.textContent = qData[field] || '';

              if (isCurrentQ) {
                cell.classList.add('current-quarter');
              }
              if (qData.isAtRisk && field === 'total' && qData[field]) {
                cell.classList.add('flag-orange');
              } else if (qData.isSignificantChange && field === 'total' && qData[field]) {
                cell.classList.add('flag-purple');
              }

              tr.appendChild(cell);
            });
          });

          // Finals
          if (colVis.finals) {
            const finalsCell = document.createElement('td');
            finalsCell.className = 'finals-cell';
            finalsCell.textContent = course.finalGradeLetter || '';
            tr.appendChild(finalsCell);
          }

          // H/C
          if (colVis.hc) {
            const hcCell = document.createElement('td');
            hcCell.className = 'hc-cell';
            hcCell.textContent = course.honorsCollege || 'N/A';
            tr.appendChild(hcCell);
          }

          // Grade Points (base)
          if (colVis.gp) {
            const gpCell = document.createElement('td');
            gpCell.className = 'gp-cell';
            gpCell.textContent = course.gradePoints != null ? course.gradePoints.toFixed(1) : '';
            tr.appendChild(gpCell);
          }

          // Weighted GP
          if (colVis.wtgp) {
            const wtCell = document.createElement('td');
            wtCell.className = 'weight-cell';
            if (course.weightedGP != null) {
              wtCell.textContent = course.weightedGP.toFixed(2);
            }
            tr.appendChild(wtCell);
          }

          // Always accumulate for GPA calculation
          if (course.weightedGP != null) {
            totalBaseGP += course.gradePoints || 0;
            totalWeightedGP += course.weightedGP;
            totalCourses++;
          }

          courseTableBody.appendChild(tr);
        });
      });

      // Add GPA Summary row
      // Colspan spans from Subject/Course through Finals (only counting visible columns)
      let summaryColspan = 1 + (quartersToDisplay.length * 3); // Subject + quarter columns
      if (colVis.credits) summaryColspan++;
      if (colVis.finals) summaryColspan++;

      const summaryRow = document.createElement('tr');
      summaryRow.className = 'gpa-summary-row';
      const baseGpaValue = totalCourses > 0 ? (totalBaseGP / totalCourses).toFixed(2) : '—';
      const weightedGpaValue = totalCourses > 0 ? (totalWeightedGP / totalCourses).toFixed(2) : '—';

      let summaryHTML = `<td colspan="${summaryColspan}" style="text-align: right; padding-right: 10px;">CUMULATIVE GPA:</td>`;
      if (colVis.hc) summaryHTML += '<td></td>';
      if (colVis.gp) summaryHTML += `<td>${baseGpaValue}</td>`;
      if (colVis.wtgp) summaryHTML += `<td class="weight-cell">${weightedGpaValue}</td>`;

      summaryRow.innerHTML = summaryHTML;
      courseTableBody.appendChild(summaryRow);
    }

    // Export function - called from parent window or directly
    window.renderReportCard = renderReportCard;

    window.exportReportCard = function(studentData) {
      if (studentData) {
        renderReportCard(studentData);
      }
      setTimeout(() => window.print(), 100);
    };

    // Check if data was passed via URL or postMessage
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'RENDER_REPORT_CARD') {
        renderReportCard(event.data.studentData);
      }
    });

    // Check for data in sessionStorage (set by parent portal)
    document.addEventListener('DOMContentLoaded', function() {
      const storedData = sessionStorage.getItem('reportCardData');
      if (storedData) {
        try {
          const data = JSON.parse(storedData);
          renderReportCard(data);
          sessionStorage.removeItem('reportCardData');
        } catch (e) {
          console.error('Error parsing report card data:', e);
        }
      }
    });
  </script>
</body>
</html>
